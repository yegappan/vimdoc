<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>Vim: /home/travis/build/yegappan/vimdoc/src/memline.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Vim
   </div>
   <div id="projectbrief">Vim Editor Documentation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">memline.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="memline_8c.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/* vi:set ts=8 sts=4 sw=4 noet:</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"> * VIM - Vi IMproved    by Bram Moolenaar</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"> * Do &quot;:help uganda&quot;  in Vim to read copying and usage conditions.</span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment"> * Do &quot;:help credits&quot; in Vim to see a list of people who contributed.</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment"> * See README.txt for an overview of the Vim source code.</span></div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">/* for debugging */</span></div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">/* #define CHECK(c, s)  do { if (c) emsg((s)); } while (0) */</span></div><div class="line"><a name="l00012"></a><span class="lineno"><a class="line" href="memline_8c.html#a4c3f0432d972be512c1ff55974987c8c">   12</a></span>&#160;<span class="preprocessor">#define CHECK(c, s) do {  } while (0)</span></div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment"> * memline.c: Contains the functions for appending, deleting and changing the</span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment"> * text lines. The memfile functions are used to store the information in</span></div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment"> * blocks of memory, backed up by a file. The structure of the information is</span></div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment"> * a tree.  The root of the tree is a pointer block. The leaves of the tree</span></div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment"> * are data blocks. In between may be several layers of pointer blocks,</span></div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment"> * forming branches.</span></div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="comment"> * Three types of blocks are used:</span></div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="comment"> * - Block nr 0 contains information for recovery</span></div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="comment"> * - Pointer blocks contain list of pointers to other blocks.</span></div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="comment"> * - Data blocks contain the actual text.</span></div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment"> * Block nr 0 contains the block0 structure (see below).</span></div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="comment"> * Block nr 1 is the first pointer block. It is the root of the tree.</span></div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="comment"> * Other pointer blocks are branches.</span></div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="comment"> *  If a line is too big to fit in a single page, the block containing that</span></div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="comment"> *  line is made big enough to hold the line. It may span several pages.</span></div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="comment"> *  Otherwise all blocks are one page.</span></div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="comment"> *  A data block that was filled when starting to edit a file and was not</span></div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="comment"> *  changed since then, can have a negative block number. This means that it</span></div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="comment"> *  has not yet been assigned a place in the file. When recovering, the lines</span></div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="comment"> *  in this data block can be read from the original file. When the block is</span></div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="comment"> *  changed (lines appended/deleted/changed) or when it is flushed it gets a</span></div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="comment"> *  positive number. Use mf_trans_del() to get the new number, before calling</span></div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="comment"> *  mf_get().</span></div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="vim_8h.html">vim.h</a>&quot;</span></div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="preprocessor">#ifndef UNIX        </span><span class="comment">/* it&#39;s in os_unix.h for Unix */</span><span class="preprocessor"></span></div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="preprocessor"># include &lt;time.h&gt;</span></div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="preprocessor">#if defined(SASC) || defined(__amigaos4__)</span></div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="preprocessor"># include &lt;proto/dos.h&gt;</span>     <span class="comment">/* for Open() and Close() */</span></div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;</div><div class="line"><a name="l00055"></a><span class="lineno"><a class="line" href="memline_8c.html#aec4e566464ccfa4269696281e8fc119b">   55</a></span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structblock0.html">block0</a>       <a class="code" href="structblock0.html">ZERO_BL</a>;    <span class="comment">/* contents of the first block */</span></div><div class="line"><a name="l00056"></a><span class="lineno"><a class="line" href="memline_8c.html#a197c0236053238ac2e5d491ff3215105">   56</a></span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structpointer__block.html">pointer_block</a>    <a class="code" href="structpointer__block.html">PTR_BL</a>;     <span class="comment">/* contents of a pointer block */</span></div><div class="line"><a name="l00057"></a><span class="lineno"><a class="line" href="memline_8c.html#aa644b4da792aa82847aa9bfab40cafab">   57</a></span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structdata__block.html">data_block</a>   <a class="code" href="structdata__block.html">DATA_BL</a>;    <span class="comment">/* contents of a data block */</span></div><div class="line"><a name="l00058"></a><span class="lineno"><a class="line" href="memline_8c.html#abea961e8b37970cc3dbdde37660ab70b">   58</a></span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structpointer__entry.html">pointer_entry</a>    <a class="code" href="structpointer__entry.html">PTR_EN</a>;     <span class="comment">/* block/line-count pair */</span></div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;</div><div class="line"><a name="l00060"></a><span class="lineno"><a class="line" href="memline_8c.html#a55aa586df150c1192826a1c57dd87401">   60</a></span>&#160;<span class="preprocessor">#define DATA_ID        ((&#39;d&#39; &lt;&lt; 8) + &#39;a&#39;)   </span><span class="comment">/* data block id */</span><span class="preprocessor"></span></div><div class="line"><a name="l00061"></a><span class="lineno"><a class="line" href="memline_8c.html#a23d0125357ec4465a50f841f634c9214">   61</a></span>&#160;<span class="preprocessor">#define PTR_ID         ((&#39;p&#39; &lt;&lt; 8) + &#39;t&#39;)   </span><span class="comment">/* pointer block id */</span><span class="preprocessor"></span></div><div class="line"><a name="l00062"></a><span class="lineno"><a class="line" href="memline_8c.html#ace6f748ee345944bbe21944baea19883">   62</a></span>&#160;<span class="preprocessor">#define BLOCK0_ID0     &#39;b&#39;          </span><span class="comment">/* block 0 id 0 */</span><span class="preprocessor"></span></div><div class="line"><a name="l00063"></a><span class="lineno"><a class="line" href="memline_8c.html#a19b014ee9a087900435acfa5166c2bea">   63</a></span>&#160;<span class="preprocessor">#define BLOCK0_ID1     &#39;0&#39;          </span><span class="comment">/* block 0 id 1 */</span><span class="preprocessor"></span></div><div class="line"><a name="l00064"></a><span class="lineno"><a class="line" href="memline_8c.html#aca48449cf4d92cab475956ba7760efaa">   64</a></span>&#160;<span class="preprocessor">#define BLOCK0_ID1_C0  &#39;c&#39;          </span><span class="comment">/* block 0 id 1 &#39;cm&#39; 0 */</span><span class="preprocessor"></span></div><div class="line"><a name="l00065"></a><span class="lineno"><a class="line" href="memline_8c.html#a8dcf918c830f292339754bb9db126932">   65</a></span>&#160;<span class="preprocessor">#define BLOCK0_ID1_C1  &#39;C&#39;          </span><span class="comment">/* block 0 id 1 &#39;cm&#39; 1 */</span><span class="preprocessor"></span></div><div class="line"><a name="l00066"></a><span class="lineno"><a class="line" href="memline_8c.html#acc61471b08b25bb0399df73b144176c5">   66</a></span>&#160;<span class="preprocessor">#define BLOCK0_ID1_C2  &#39;d&#39;          </span><span class="comment">/* block 0 id 1 &#39;cm&#39; 2 */</span><span class="preprocessor"></span></div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;<span class="preprocessor">#if defined(FEAT_CRYPT)</span></div><div class="line"><a name="l00069"></a><span class="lineno"><a class="line" href="memline_8c.html#ac95d0fd4bafc7f2b52cd415aedcf0f05">   69</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="memline_8c.html#ac95d0fd4bafc7f2b52cd415aedcf0f05">id1_codes</a>[] = {</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;    <a class="code" href="memline_8c.html#aca48449cf4d92cab475956ba7760efaa">BLOCK0_ID1_C0</a>,  <span class="comment">/* CRYPT_M_ZIP */</span></div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;    <a class="code" href="memline_8c.html#a8dcf918c830f292339754bb9db126932">BLOCK0_ID1_C1</a>,  <span class="comment">/* CRYPT_M_BF */</span></div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;    <a class="code" href="memline_8c.html#acc61471b08b25bb0399df73b144176c5">BLOCK0_ID1_C2</a>,  <span class="comment">/* CRYPT_M_BF2 */</span></div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;};</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;<span class="comment"> * pointer to a block, used in a pointer block</span></div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00079"></a><span class="lineno"><a class="line" href="structpointer__entry.html">   79</a></span>&#160;<span class="keyword">struct </span><a class="code" href="structpointer__entry.html">pointer_entry</a></div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;{</div><div class="line"><a name="l00081"></a><span class="lineno"><a class="line" href="structpointer__entry.html#a0234165c0ca282f192e94957a87175f6">   81</a></span>&#160;    <a class="code" href="structs_8h.html#a012394c4a7db63f99f6f0cdacab79527">blocknr_T</a>   <a class="code" href="structpointer__entry.html#a0234165c0ca282f192e94957a87175f6">pe_bnum</a>;    <span class="comment">/* block number */</span></div><div class="line"><a name="l00082"></a><span class="lineno"><a class="line" href="structpointer__entry.html#a652fe117ed91b4ab3d84361e8aa751de">   82</a></span>&#160;    <a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>    <a class="code" href="structpointer__entry.html#a652fe117ed91b4ab3d84361e8aa751de">pe_line_count</a>;  <span class="comment">/* number of lines in this branch */</span></div><div class="line"><a name="l00083"></a><span class="lineno"><a class="line" href="structpointer__entry.html#a4ed8c85821e6c5ac44c2a77160d4b26d">   83</a></span>&#160;    <a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>    <a class="code" href="structpointer__entry.html#a4ed8c85821e6c5ac44c2a77160d4b26d">pe_old_lnum</a>;    <span class="comment">/* lnum for this block (for recovery) */</span></div><div class="line"><a name="l00084"></a><span class="lineno"><a class="line" href="structpointer__entry.html#aa5194eaf0768453f33b9d2ff66508040">   84</a></span>&#160;    <span class="keywordtype">int</span>     <a class="code" href="structpointer__entry.html#aa5194eaf0768453f33b9d2ff66508040">pe_page_count</a>;  <span class="comment">/* number of pages in block pe_bnum */</span></div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;};</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;<span class="comment"> * A pointer block contains a list of branches in the tree.</span></div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00090"></a><span class="lineno"><a class="line" href="structpointer__block.html">   90</a></span>&#160;<span class="keyword">struct </span><a class="code" href="structpointer__block.html">pointer_block</a></div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;{</div><div class="line"><a name="l00092"></a><span class="lineno"><a class="line" href="structpointer__block.html#ac2698ad2c9c4096299106a53ffbd667f">   92</a></span>&#160;    <a class="code" href="vim_8h.html#af188d12f92536bcde1def3ec5c00e020">short_u</a> <a class="code" href="structpointer__block.html#ac2698ad2c9c4096299106a53ffbd667f">pb_id</a>;      <span class="comment">/* ID for pointer block: PTR_ID */</span></div><div class="line"><a name="l00093"></a><span class="lineno"><a class="line" href="structpointer__block.html#ad3682038298e7850fb980815132f17f9">   93</a></span>&#160;    <a class="code" href="vim_8h.html#af188d12f92536bcde1def3ec5c00e020">short_u</a> <a class="code" href="structpointer__block.html#ad3682038298e7850fb980815132f17f9">pb_count</a>;   <span class="comment">/* number of pointers in this block */</span></div><div class="line"><a name="l00094"></a><span class="lineno"><a class="line" href="structpointer__block.html#ad9d615e7c53c2892e6d04a0d257df592">   94</a></span>&#160;    <a class="code" href="vim_8h.html#af188d12f92536bcde1def3ec5c00e020">short_u</a> <a class="code" href="structpointer__block.html#ad9d615e7c53c2892e6d04a0d257df592">pb_count_max</a>;   <span class="comment">/* maximum value for pb_count */</span></div><div class="line"><a name="l00095"></a><span class="lineno"><a class="line" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">   95</a></span>&#160;    <a class="code" href="structpointer__entry.html">PTR_EN</a>  pb_pointer[1];  <span class="comment">/* list of pointers to blocks (actually longer)</span></div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;<span class="comment">                 * followed by empty space until end of page */</span></div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;};</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;<span class="comment"> * A data block is a leaf in the tree.</span></div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;<span class="comment"> * The text of the lines is at the end of the block. The text of the first line</span></div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;<span class="comment"> * in the block is put at the end, the text of the second line in front of it,</span></div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;<span class="comment"> * etc. Thus the order of the lines is the opposite of the line number.</span></div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00106"></a><span class="lineno"><a class="line" href="structdata__block.html">  106</a></span>&#160;<span class="keyword">struct </span><a class="code" href="structdata__block.html">data_block</a></div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;{</div><div class="line"><a name="l00108"></a><span class="lineno"><a class="line" href="structdata__block.html#ac977617f5f8153eda5d902a73e0379e1">  108</a></span>&#160;    <a class="code" href="vim_8h.html#af188d12f92536bcde1def3ec5c00e020">short_u</a> <a class="code" href="structdata__block.html#ac977617f5f8153eda5d902a73e0379e1">db_id</a>;      <span class="comment">/* ID for data block: DATA_ID */</span></div><div class="line"><a name="l00109"></a><span class="lineno"><a class="line" href="structdata__block.html#a6cd7e5186f74ae199fe547bc905b2815">  109</a></span>&#160;    <span class="keywordtype">unsigned</span>    <a class="code" href="structdata__block.html#a6cd7e5186f74ae199fe547bc905b2815">db_free</a>;    <span class="comment">/* free space available */</span></div><div class="line"><a name="l00110"></a><span class="lineno"><a class="line" href="structdata__block.html#a3937f5841b2fed9a042872981b06a7b8">  110</a></span>&#160;    <span class="keywordtype">unsigned</span>    <a class="code" href="structdata__block.html#a3937f5841b2fed9a042872981b06a7b8">db_txt_start</a>;   <span class="comment">/* byte where text starts */</span></div><div class="line"><a name="l00111"></a><span class="lineno"><a class="line" href="structdata__block.html#ae079e3993bfc47bd86fd6e2fc3ab44ba">  111</a></span>&#160;    <span class="keywordtype">unsigned</span>    <a class="code" href="structdata__block.html#ae079e3993bfc47bd86fd6e2fc3ab44ba">db_txt_end</a>; <span class="comment">/* byte just after data block */</span></div><div class="line"><a name="l00112"></a><span class="lineno"><a class="line" href="structdata__block.html#a00084a39a3bdd9a03b9a055216aec5c5">  112</a></span>&#160;    <a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>    <a class="code" href="structdata__block.html#a00084a39a3bdd9a03b9a055216aec5c5">db_line_count</a>;  <span class="comment">/* number of lines in this block */</span></div><div class="line"><a name="l00113"></a><span class="lineno"><a class="line" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">  113</a></span>&#160;    <span class="keywordtype">unsigned</span>    db_index[1];    <span class="comment">/* index for start of line (actually bigger)</span></div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;<span class="comment">                 * followed by empty space upto db_txt_start</span></div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;<span class="comment">                 * followed by the text in the lines until</span></div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;<span class="comment">                 * end of page */</span></div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;};</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;<span class="comment"> * The low bits of db_index hold the actual index. The topmost bit is</span></div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;<span class="comment"> * used for the global command to be able to mark a line.</span></div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;<span class="comment"> * This method is not clean, but otherwise there would be at least one extra</span></div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;<span class="comment"> * byte used for each line.</span></div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;<span class="comment"> * The mark has to be in this place to keep it with the correct line when other</span></div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;<span class="comment"> * lines are inserted or deleted.</span></div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00127"></a><span class="lineno"><a class="line" href="memline_8c.html#ab994bfde1fec8c463065bbb9a402a35d">  127</a></span>&#160;<span class="preprocessor">#define DB_MARKED   ((unsigned)1 &lt;&lt; ((sizeof(unsigned) * 8) - 1))</span></div><div class="line"><a name="l00128"></a><span class="lineno"><a class="line" href="memline_8c.html#ab65775db0f7dbf161fce05ee7fb36573">  128</a></span>&#160;<span class="preprocessor">#define DB_INDEX_MASK   (~DB_MARKED)</span></div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;</div><div class="line"><a name="l00130"></a><span class="lineno"><a class="line" href="memline_8c.html#a33bdc994ac7c8cda7d0df1a3369ab965">  130</a></span>&#160;<span class="preprocessor">#define INDEX_SIZE  (sizeof(unsigned))      </span><span class="comment">/* size of one db_index entry */</span><span class="preprocessor"></span></div><div class="line"><a name="l00131"></a><span class="lineno"><a class="line" href="memline_8c.html#a49999be01380f41cc0d0f1f1406fb277">  131</a></span>&#160;<span class="preprocessor">#define HEADER_SIZE (sizeof(DATA_BL) - INDEX_SIZE)  </span><span class="comment">/* size of data block header */</span><span class="preprocessor"></span></div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;</div><div class="line"><a name="l00133"></a><span class="lineno"><a class="line" href="memline_8c.html#a3d4cf908356280e457ffbd11d449b11b">  133</a></span>&#160;<span class="preprocessor">#define B0_FNAME_SIZE_ORG   900 </span><span class="comment">/* what it was in older versions */</span><span class="preprocessor"></span></div><div class="line"><a name="l00134"></a><span class="lineno"><a class="line" href="memline_8c.html#a4e1fcc872c5dc5b8ec1d1bf7ac298bbe">  134</a></span>&#160;<span class="preprocessor">#define B0_FNAME_SIZE_NOCRYPT   898 </span><span class="comment">/* 2 bytes used for other things */</span><span class="preprocessor"></span></div><div class="line"><a name="l00135"></a><span class="lineno"><a class="line" href="memline_8c.html#a4ecf812828065a7ac0dccbe3e4661de9">  135</a></span>&#160;<span class="preprocessor">#define B0_FNAME_SIZE_CRYPT 890 </span><span class="comment">/* 10 bytes used for other things */</span><span class="preprocessor"></span></div><div class="line"><a name="l00136"></a><span class="lineno"><a class="line" href="memline_8c.html#a67d0b82009004217400bc8708acf4c06">  136</a></span>&#160;<span class="preprocessor">#define B0_UNAME_SIZE       40</span></div><div class="line"><a name="l00137"></a><span class="lineno"><a class="line" href="memline_8c.html#aab71d171eeeefa498adf1f5f725cd010">  137</a></span>&#160;<span class="preprocessor">#define B0_HNAME_SIZE       40</span></div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;<span class="comment"> * Restrict the numbers to 32 bits, otherwise most compilers will complain.</span></div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;<span class="comment"> * This won&#39;t detect a 64 bit machine that only swaps a byte in the top 32</span></div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;<span class="comment"> * bits, but that is crazy anyway.</span></div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00143"></a><span class="lineno"><a class="line" href="memline_8c.html#a2ac462e9a16bd27bb78d4e5e2cab8995">  143</a></span>&#160;<span class="preprocessor">#define B0_MAGIC_LONG   0x30313233L</span></div><div class="line"><a name="l00144"></a><span class="lineno"><a class="line" href="memline_8c.html#a2498547c6752de3ff3cb3a9526ef8050">  144</a></span>&#160;<span class="preprocessor">#define B0_MAGIC_INT    0x20212223L</span></div><div class="line"><a name="l00145"></a><span class="lineno"><a class="line" href="memline_8c.html#a136a6ccfa892765672abfc5e0dff1a2d">  145</a></span>&#160;<span class="preprocessor">#define B0_MAGIC_SHORT  0x10111213L</span></div><div class="line"><a name="l00146"></a><span class="lineno"><a class="line" href="memline_8c.html#a24846156f9cce98c4ab60f43e224065e">  146</a></span>&#160;<span class="preprocessor">#define B0_MAGIC_CHAR   0x55</span></div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;<span class="comment"> * Block zero holds all info about the swap file.</span></div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;<span class="comment"> * NOTE: DEFINITION OF BLOCK 0 SHOULD NOT CHANGE! It would make all existing</span></div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;<span class="comment"> * swap files unusable!</span></div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;<span class="comment"> * If size of block0 changes anyway, adjust MIN_SWAP_PAGE_SIZE in vim.h!!</span></div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;<span class="comment"> * This block is built up of single bytes, to make it portable across</span></div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;<span class="comment"> * different machines. b0_magic_* is used to check the byte order and size of</span></div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;<span class="comment"> * variables, because the rest of the swap file is not portable.</span></div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00160"></a><span class="lineno"><a class="line" href="structblock0.html">  160</a></span>&#160;<span class="keyword">struct </span><a class="code" href="structblock0.html">block0</a></div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;{</div><div class="line"><a name="l00162"></a><span class="lineno"><a class="line" href="structblock0.html#acaaa2249e372c7710c595b07cd3288ec">  162</a></span>&#160;    char_u  b0_id[2];   <span class="comment">/* id for block 0: BLOCK0_ID0 and BLOCK0_ID1,</span></div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;<span class="comment">                 * BLOCK0_ID1_C0, BLOCK0_ID1_C1, etc. */</span></div><div class="line"><a name="l00164"></a><span class="lineno"><a class="line" href="structblock0.html#a5f6ec025350776e0dbe8d0ab54daadc3">  164</a></span>&#160;    char_u  b0_version[10]; <span class="comment">/* Vim version string */</span></div><div class="line"><a name="l00165"></a><span class="lineno"><a class="line" href="structblock0.html#a5b992d5ca8d9cc3eb941debcdea6f180">  165</a></span>&#160;    char_u  b0_page_size[4];<span class="comment">/* number of bytes per page */</span></div><div class="line"><a name="l00166"></a><span class="lineno"><a class="line" href="structblock0.html#a9055bedd111a57a03cc1987905bb4ae0">  166</a></span>&#160;    char_u  b0_mtime[4];    <span class="comment">/* last modification time of file */</span></div><div class="line"><a name="l00167"></a><span class="lineno"><a class="line" href="structblock0.html#a3930b3adc922aba997caf28ad8d8e6a4">  167</a></span>&#160;    char_u  b0_ino[4];  <span class="comment">/* inode of b0_fname */</span></div><div class="line"><a name="l00168"></a><span class="lineno"><a class="line" href="structblock0.html#ab702799b723f108b57a8b73f83e70346">  168</a></span>&#160;    char_u  b0_pid[4];  <span class="comment">/* process id of creator (or 0) */</span></div><div class="line"><a name="l00169"></a><span class="lineno"><a class="line" href="structblock0.html#aab3e8eda9003c121be3914c9606854b6">  169</a></span>&#160;    char_u  b0_uname[<a class="code" href="memline_8c.html#a67d0b82009004217400bc8708acf4c06">B0_UNAME_SIZE</a>]; <span class="comment">/* name of user (uid if no name) */</span></div><div class="line"><a name="l00170"></a><span class="lineno"><a class="line" href="structblock0.html#a8b0cab71ba5453122bcd862fe3d368ca">  170</a></span>&#160;    char_u  b0_hname[<a class="code" href="memline_8c.html#aab71d171eeeefa498adf1f5f725cd010">B0_HNAME_SIZE</a>]; <span class="comment">/* host name (if it has a name) */</span></div><div class="line"><a name="l00171"></a><span class="lineno"><a class="line" href="structblock0.html#a619635d3effa9f2496dd6662e20b9037">  171</a></span>&#160;    char_u  b0_fname[<a class="code" href="memline_8c.html#a3d4cf908356280e457ffbd11d449b11b">B0_FNAME_SIZE_ORG</a>]; <span class="comment">/* name of file being edited */</span></div><div class="line"><a name="l00172"></a><span class="lineno"><a class="line" href="structblock0.html#a543e42c027a0f62c7843b3f44a8b999c">  172</a></span>&#160;    <span class="keywordtype">long</span>    <a class="code" href="structblock0.html#a543e42c027a0f62c7843b3f44a8b999c">b0_magic_long</a>;  <span class="comment">/* check for byte order of long */</span></div><div class="line"><a name="l00173"></a><span class="lineno"><a class="line" href="structblock0.html#af1c4459e8e835bc33daa0b6d4a4d57d1">  173</a></span>&#160;    <span class="keywordtype">int</span>     <a class="code" href="structblock0.html#af1c4459e8e835bc33daa0b6d4a4d57d1">b0_magic_int</a>;   <span class="comment">/* check for byte order of int */</span></div><div class="line"><a name="l00174"></a><span class="lineno"><a class="line" href="structblock0.html#a677366d05c5a282aa489272ca0fa0b1d">  174</a></span>&#160;    <span class="keywordtype">short</span>   <a class="code" href="structblock0.html#a677366d05c5a282aa489272ca0fa0b1d">b0_magic_short</a>; <span class="comment">/* check for byte order of short */</span></div><div class="line"><a name="l00175"></a><span class="lineno"><a class="line" href="structblock0.html#a821963e4a98dd9ec3d819afa9ccd660f">  175</a></span>&#160;    char_u  <a class="code" href="structblock0.html#a821963e4a98dd9ec3d819afa9ccd660f">b0_magic_char</a>;  <span class="comment">/* check for last char */</span></div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;};</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;<span class="comment"> * Note: b0_dirty and b0_flags are put at the end of the file name.  For very</span></div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;<span class="comment"> * long file names in older versions of Vim they are invalid.</span></div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;<span class="comment"> * The &#39;fileencoding&#39; comes before b0_flags, with a NUL in front.  But only</span></div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;<span class="comment"> * when there is room, for very long file names it&#39;s omitted.</span></div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00184"></a><span class="lineno"><a class="line" href="memline_8c.html#aef48b3fc0252f461c7bce9fb717fc542">  184</a></span>&#160;<span class="preprocessor">#define B0_DIRTY    0x55</span></div><div class="line"><a name="l00185"></a><span class="lineno"><a class="line" href="memline_8c.html#a31f731b7125114308c0b2e85b10e0bb0">  185</a></span>&#160;<span class="preprocessor">#define b0_dirty    b0_fname[B0_FNAME_SIZE_ORG - 1]</span></div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;<span class="comment"> * The b0_flags field is new in Vim 7.0.</span></div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00190"></a><span class="lineno"><a class="line" href="memline_8c.html#a035de78041927f925e59c97913c822bf">  190</a></span>&#160;<span class="preprocessor">#define b0_flags    b0_fname[B0_FNAME_SIZE_ORG - 2]</span></div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;<span class="comment"> * Crypt seed goes here, 8 bytes.  New in Vim 7.3.</span></div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;<span class="comment"> * Without encryption these bytes may be used for &#39;fenc&#39;.</span></div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00196"></a><span class="lineno"><a class="line" href="memline_8c.html#abb8f9f1175afebf5325be70fde1b1c89">  196</a></span>&#160;<span class="preprocessor">#define b0_seed     b0_fname[B0_FNAME_SIZE_ORG - 2 - MF_SEED_LEN]</span></div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;<span class="comment">/* The lowest two bits contain the fileformat.  Zero means it&#39;s not set</span></div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;<span class="comment"> * (compatible with Vim 6.x), otherwise it&#39;s EOL_UNIX + 1, EOL_DOS + 1 or</span></div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;<span class="comment"> * EOL_MAC + 1. */</span></div><div class="line"><a name="l00201"></a><span class="lineno"><a class="line" href="memline_8c.html#ab299d2ddb4d4be7565b25e8a197e63bb">  201</a></span>&#160;<span class="preprocessor">#define B0_FF_MASK  3</span></div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;<span class="comment">/* Swap file is in directory of edited file.  Used to find the file from</span></div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;<span class="comment"> * different mount points. */</span></div><div class="line"><a name="l00205"></a><span class="lineno"><a class="line" href="memline_8c.html#a47709ebb68758a4b1db1a5205761c146">  205</a></span>&#160;<span class="preprocessor">#define B0_SAME_DIR 4</span></div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;<span class="comment">/* The &#39;fileencoding&#39; is at the end of b0_fname[], with a NUL in front of it.</span></div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;<span class="comment"> * When empty there is only the NUL. */</span></div><div class="line"><a name="l00209"></a><span class="lineno"><a class="line" href="memline_8c.html#a7ad45b164548ce5af4a97bbc5c249410">  209</a></span>&#160;<span class="preprocessor">#define B0_HAS_FENC 8</span></div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;</div><div class="line"><a name="l00211"></a><span class="lineno"><a class="line" href="memline_8c.html#a0caed9f008450f4f072f64fa9023aa0a">  211</a></span>&#160;<span class="preprocessor">#define STACK_INCR  5   </span><span class="comment">/* nr of entries added to ml_stack at a time */</span><span class="preprocessor"></span></div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;<span class="comment"> * The line number where the first mark may be is remembered.</span></div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;<span class="comment"> * If it is 0 there are no marks at all.</span></div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;<span class="comment"> * (always used for the current buffer only, no buffer change possible while</span></div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;<span class="comment"> * executing a global command).</span></div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00219"></a><span class="lineno"><a class="line" href="memline_8c.html#a8837c8c8a497ab410a9e925581f966c3">  219</a></span>&#160;<span class="keyword">static</span> <a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a> <a class="code" href="memline_8c.html#a8837c8c8a497ab410a9e925581f966c3">lowest_marked</a> = 0;</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;<span class="comment"> * arguments for ml_find_line()</span></div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00224"></a><span class="lineno"><a class="line" href="memline_8c.html#ae92d6ba5b936547467fd45f1b6534778">  224</a></span>&#160;<span class="preprocessor">#define ML_DELETE   0x11        </span><span class="comment">/* delete line */</span><span class="preprocessor"></span></div><div class="line"><a name="l00225"></a><span class="lineno"><a class="line" href="memline_8c.html#a1fc0269a34abf68fee5e99b51879fa4b">  225</a></span>&#160;<span class="preprocessor">#define ML_INSERT   0x12        </span><span class="comment">/* insert line */</span><span class="preprocessor"></span></div><div class="line"><a name="l00226"></a><span class="lineno"><a class="line" href="memline_8c.html#a1de07181f87bda4348b87eb71e0ab526">  226</a></span>&#160;<span class="preprocessor">#define ML_FIND     0x13        </span><span class="comment">/* just find the line */</span><span class="preprocessor"></span></div><div class="line"><a name="l00227"></a><span class="lineno"><a class="line" href="memline_8c.html#a89ca94197abc00b6c372ff0a72b4a091">  227</a></span>&#160;<span class="preprocessor">#define ML_FLUSH    0x02        </span><span class="comment">/* flush locked block */</span><span class="preprocessor"></span></div><div class="line"><a name="l00228"></a><span class="lineno"><a class="line" href="memline_8c.html#aa48861b8abab2c6a9d9c002781df1cfd">  228</a></span>&#160;<span class="preprocessor">#define ML_SIMPLE(x)    (x &amp; 0x10)  </span><span class="comment">/* DEL, INS or FIND */</span><span class="preprocessor"></span></div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;<span class="comment">/* argument for ml_upd_block0() */</span></div><div class="line"><a name="l00231"></a><span class="lineno"><a class="line" href="memline_8c.html#aeb2a08db86a3f3c959cc50de278339ed">  231</a></span>&#160;<span class="keyword">typedef</span> <span class="keyword">enum</span> {</div><div class="line"><a name="l00232"></a><span class="lineno"><a class="line" href="memline_8c.html#aeb2a08db86a3f3c959cc50de278339edae07039e8880c427cedb331eac7444095">  232</a></span>&#160;      <a class="code" href="memline_8c.html#aeb2a08db86a3f3c959cc50de278339edae07039e8880c427cedb331eac7444095">UB_FNAME</a> = 0  <span class="comment">/* update timestamp and filename */</span></div><div class="line"><a name="l00233"></a><span class="lineno"><a class="line" href="memline_8c.html#aeb2a08db86a3f3c959cc50de278339eda3e3c35facf7ed67537393dd40196c797">  233</a></span>&#160;    , <a class="code" href="memline_8c.html#aeb2a08db86a3f3c959cc50de278339eda3e3c35facf7ed67537393dd40196c797">UB_SAME_DIR</a>       <span class="comment">/* update the B0_SAME_DIR flag */</span></div><div class="line"><a name="l00234"></a><span class="lineno"><a class="line" href="memline_8c.html#aeb2a08db86a3f3c959cc50de278339eda657b3ee32a0fea16c976931ef3bc9e27">  234</a></span>&#160;    , <a class="code" href="memline_8c.html#aeb2a08db86a3f3c959cc50de278339eda657b3ee32a0fea16c976931ef3bc9e27">UB_CRYPT</a>      <span class="comment">/* update crypt key */</span></div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;} <a class="code" href="memline_8c.html#aeb2a08db86a3f3c959cc50de278339ed">upd_block0_T</a>;</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;<span class="preprocessor">#ifdef FEAT_CRYPT</span></div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="memline_8c.html#af1fa068c71604df99341775f25824fdd">ml_set_b0_crypt</a>(<a class="code" href="structfile__buffer.html">buf_T</a> *buf, <a class="code" href="structblock0.html">ZERO_BL</a> *b0p);</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="memline_8c.html#aafe17e152f79b72e5e3e52013d5ba4dd">ml_upd_block0</a>(<a class="code" href="structfile__buffer.html">buf_T</a> *buf, <a class="code" href="memline_8c.html#aeb2a08db86a3f3c959cc50de278339ed">upd_block0_T</a> what);</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="memline_8c.html#af8faa362a3c30969254dac9539895774">set_b0_fname</a>(<a class="code" href="structblock0.html">ZERO_BL</a> *, <a class="code" href="structfile__buffer.html">buf_T</a> *buf);</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="memline_8c.html#ad89ac1988c4af53392f905876e770508">set_b0_dir_flag</a>(<a class="code" href="structblock0.html">ZERO_BL</a> *b0p, <a class="code" href="structfile__buffer.html">buf_T</a> *buf);</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="memline_8c.html#a623f9a9406aa91cbaca6461d1ccc6804">add_b0_fenc</a>(<a class="code" href="structblock0.html">ZERO_BL</a> *b0p, <a class="code" href="structfile__buffer.html">buf_T</a> *buf);</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;<span class="keyword">static</span> time_t <a class="code" href="memline_8c.html#aad2a8c25b4deee1b1fec00478af75568">swapfile_info</a>(char_u *);</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="memline_8c.html#a95c3497feee28077f095256e5584c0af">recov_file_names</a>(char_u **, char_u *, <span class="keywordtype">int</span> prepend_dot);</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="memline_8c.html#a5e7aeced6dc3b0cf2af0f92ff3b3a875">ml_delete_int</a>(<a class="code" href="structfile__buffer.html">buf_T</a> *, <a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>, <span class="keywordtype">int</span>);</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;<span class="keyword">static</span> char_u *<a class="code" href="memline_8c.html#af8d501a6ccea291cd77605d10240eeda">findswapname</a>(<a class="code" href="structfile__buffer.html">buf_T</a> *, char_u **, char_u *);</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="memline_8c.html#a20a3268681f79a76b9af2f2fc7b644b6">ml_flush_line</a>(<a class="code" href="structfile__buffer.html">buf_T</a> *);</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;<span class="keyword">static</span> <a class="code" href="structblock__hdr.html">bhdr_T</a> *<a class="code" href="memline_8c.html#a143a4d348c1d7c3e5ccc591f6653a984">ml_new_data</a>(<a class="code" href="structmemfile.html">memfile_T</a> *, <span class="keywordtype">int</span>, <span class="keywordtype">int</span>);</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;<span class="keyword">static</span> <a class="code" href="structblock__hdr.html">bhdr_T</a> *<a class="code" href="memline_8c.html#abdecfc521a3e8fe9fde7d0a7f0baa4fc">ml_new_ptr</a>(<a class="code" href="structmemfile.html">memfile_T</a> *);</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;<span class="keyword">static</span> <a class="code" href="structblock__hdr.html">bhdr_T</a> *<a class="code" href="memline_8c.html#ade8fe98188345bdd3c230545fc4a614f">ml_find_line</a>(<a class="code" href="structfile__buffer.html">buf_T</a> *, <a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>, <span class="keywordtype">int</span>);</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="memline_8c.html#aa6909d6a13a3189fdb549bea27afc662">ml_add_stack</a>(<a class="code" href="structfile__buffer.html">buf_T</a> *);</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="memline_8c.html#a661ea17a2f15417b31afca629fbef050">ml_lineadd</a>(<a class="code" href="structfile__buffer.html">buf_T</a> *, <span class="keywordtype">int</span>);</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="memline_8c.html#a28648170c5d102a305afeeecf23cc0ca">b0_magic_wrong</a>(<a class="code" href="structblock0.html">ZERO_BL</a> *);</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;<span class="preprocessor">#ifdef CHECK_INODE</span></div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> fnamecmp_ino(char_u *, char_u *, <span class="keywordtype">long</span>);</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="memline_8c.html#a231a2b743bdebbc1d61725a392830eff">long_to_char</a>(<span class="keywordtype">long</span>, char_u *);</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;<span class="keyword">static</span> <span class="keywordtype">long</span> <a class="code" href="memline_8c.html#a996b07c0a0e4f04f7b205f4c3ba2a797">char_to_long</a>(char_u *);</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;<span class="preprocessor">#ifdef FEAT_CRYPT</span></div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;<span class="keyword">static</span> cryptstate_T *<a class="code" href="memline_8c.html#a2249fb5b4839da11dd7db4635aaae6e3">ml_crypt_prepare</a>(<a class="code" href="structmemfile.html">memfile_T</a> *mfp, <a class="code" href="vim_8h.html#ac86c7b16baf3bc83bef23b7e5e103ca9">off_T</a> offset, <span class="keywordtype">int</span> reading);</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;<span class="preprocessor">#ifdef FEAT_BYTEOFF</span></div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="memline_8c.html#ae8486bd6f1922d43b60969e2be927915">ml_updatechunk</a>(<a class="code" href="structfile__buffer.html">buf_T</a> *buf, <span class="keywordtype">long</span> line, <span class="keywordtype">long</span> len, <span class="keywordtype">int</span> updtype);</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;<span class="comment"> * Open a new memline for &quot;buf&quot;.</span></div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;<span class="comment"> * Return FAIL for failure, OK otherwise.</span></div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;    <span class="keywordtype">int</span></div><div class="line"><a name="l00273"></a><span class="lineno"><a class="line" href="memline_8c.html#adcf872c959d4e670fd729383dec62a81">  273</a></span>&#160;<a class="code" href="memline_8c.html#adcf872c959d4e670fd729383dec62a81">ml_open</a>(<a class="code" href="structfile__buffer.html">buf_T</a> *buf)</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;{</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;    <a class="code" href="structmemfile.html">memfile_T</a>   *mfp;</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;    <a class="code" href="structblock__hdr.html">bhdr_T</a>  *hp = NULL;</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;    <a class="code" href="structblock0.html">ZERO_BL</a> *b0p;</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;    <a class="code" href="structpointer__block.html">PTR_BL</a>  *pp;</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;    <a class="code" href="structdata__block.html">DATA_BL</a> *dp;</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;<span class="comment">     * init fields in memline struct</span></div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#add4fba4ecd680fbf53ab842c85ccde21">ml_stack_size</a> = 0; <span class="comment">/* no stack yet */</span></div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a77e2179043ee3367af09fe186b2fa5a8">ml_stack</a> = NULL;  <span class="comment">/* no stack yet */</span></div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a17d957b4b662bf327749e1523ac4f5b5">ml_stack_top</a> = 0; <span class="comment">/* nothing in the stack */</span></div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#aa4c2830f305306d4f5f163b4522d0ba6">ml_locked</a> = NULL; <span class="comment">/* no cached block */</span></div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a62222eb79ef59eddaff71f0f8cdff764">ml_line_lnum</a> = 0; <span class="comment">/* no cached line */</span></div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;<span class="preprocessor">#ifdef FEAT_BYTEOFF</span></div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_chunksize = NULL;</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="structcmdmod.html">cmdmod</a>.noswapfile)</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#a0dbc556e96a2a6afd3284b5a3bae167a">b_p_swf</a> = <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;<span class="comment">     * When &#39;updatecount&#39; is non-zero swap file may be opened later.</span></div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="option_8h.html#ab9d1347f05d6fab96b4ebba410df10f6">p_uc</a> &amp;&amp; buf-&gt;<a class="code" href="structfile__buffer.html#a0dbc556e96a2a6afd3284b5a3bae167a">b_p_swf</a>)</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#a18b9a8836718e7f4f791c80a6d28bd9b">b_may_swap</a> = <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#a18b9a8836718e7f4f791c80a6d28bd9b">b_may_swap</a> = <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;<span class="comment">     * Open the memfile.  No swap file is created yet.</span></div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;    mfp = <a class="code" href="memfile_8c.html#a6e68cf5ad6fb3085488b37df8dc37058">mf_open</a>(NULL, 0);</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;    <span class="keywordflow">if</span> (mfp == NULL)</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;    <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a9adb5a08b3c01be69c98360a14937227">ml_mfp</a> = mfp;</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;<span class="preprocessor">#ifdef FEAT_CRYPT</span></div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;    mfp-&gt;mf_buffer = buf;</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a30f30ddb7264f667a92556f0568981e0">ml_flags</a> = <a class="code" href="structs_8h.html#a67ecfd4d644d8b33ba15512b7136602a">ML_EMPTY</a>;</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a708091d31fa9cf7718aca80d707b1b3d">ml_line_count</a> = 1;</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;<span class="preprocessor">#ifdef FEAT_LINEBREAK</span></div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;    <a class="code" href="globals_8h.html#a1440aee39ae90077fff5aeb23c8a3764">curwin</a>-&gt;w_nrwidth_line_count = 0;</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;<span class="comment"> * fill block0 struct and write page 0</span></div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;    <span class="keywordflow">if</span> ((hp = <a class="code" href="memfile_8c.html#aef96feb7c9e3f3ba1f4901933dcc7424">mf_new</a>(mfp, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, 1)) == NULL)</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;    <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;    <span class="keywordflow">if</span> (hp-&gt;bh_bnum != 0)</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;    {</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;    <a class="code" href="message_8c.html#a7926d7fa9a35dc0f5bac051dec01240a">iemsg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;E298: Didn&#39;t get block nr 0?&quot;</span>));</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;    <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;    }</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;    b0p = (<a class="code" href="structblock0.html">ZERO_BL</a> *)(hp-&gt;<a class="code" href="structblock__hdr.html#a7247cdc0977ab6fdc9cb6238cda67587">bh_data</a>);</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;    b0p-&gt;<a class="code" href="structblock0.html#acaaa2249e372c7710c595b07cd3288ec">b0_id</a>[0] = <a class="code" href="memline_8c.html#ace6f748ee345944bbe21944baea19883">BLOCK0_ID0</a>;</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;    b0p-&gt;<a class="code" href="structblock0.html#acaaa2249e372c7710c595b07cd3288ec">b0_id</a>[1] = <a class="code" href="memline_8c.html#a19b014ee9a087900435acfa5166c2bea">BLOCK0_ID1</a>;</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;    b0p-&gt;<a class="code" href="structblock0.html#a543e42c027a0f62c7843b3f44a8b999c">b0_magic_long</a> = (long)<a class="code" href="memline_8c.html#a2ac462e9a16bd27bb78d4e5e2cab8995">B0_MAGIC_LONG</a>;</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    b0p-&gt;<a class="code" href="structblock0.html#af1c4459e8e835bc33daa0b6d4a4d57d1">b0_magic_int</a> = (int)<a class="code" href="memline_8c.html#a2498547c6752de3ff3cb3a9526ef8050">B0_MAGIC_INT</a>;</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;    b0p-&gt;<a class="code" href="structblock0.html#a677366d05c5a282aa489272ca0fa0b1d">b0_magic_short</a> = (short)<a class="code" href="memline_8c.html#a136a6ccfa892765672abfc5e0dff1a2d">B0_MAGIC_SHORT</a>;</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;    b0p-&gt;<a class="code" href="structblock0.html#a821963e4a98dd9ec3d819afa9ccd660f">b0_magic_char</a> = <a class="code" href="memline_8c.html#a24846156f9cce98c4ab60f43e224065e">B0_MAGIC_CHAR</a>;</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;    <a class="code" href="os__unix_8h.html#ae70108db942e4f3eeb701ad8787b1835">mch_memmove</a>(b0p-&gt;<a class="code" href="structblock0.html#a5f6ec025350776e0dbe8d0ab54daadc3">b0_version</a>, <span class="stringliteral">&quot;VIM &quot;</span>, 4);</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;    <a class="code" href="vim_8h.html#a469cffaa64ff8028edfb64ba4cd7deae">STRNCPY</a>(b0p-&gt;<a class="code" href="structblock0.html#a5f6ec025350776e0dbe8d0ab54daadc3">b0_version</a> + 4, <a class="code" href="globals_8h.html#abc057f42fdaf5e63835a8272aefe278e">Version</a>, 6);</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;    <a class="code" href="memline_8c.html#a231a2b743bdebbc1d61725a392830eff">long_to_char</a>((<span class="keywordtype">long</span>)mfp-&gt;<a class="code" href="structmemfile.html#ab0c66141886a009d8132b8e1e2a00fc6">mf_page_size</a>, b0p-&gt;<a class="code" href="structblock0.html#a5b992d5ca8d9cc3eb941debcdea6f180">b0_page_size</a>);</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;<span class="preprocessor">#ifdef FEAT_SPELL</span></div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;    <span class="keywordflow">if</span> (!buf-&gt;b_spell)</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;    {</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;    b0p-&gt;b0_dirty = buf-&gt;<a class="code" href="structfile__buffer.html#aa4b0a02270ec71cb25dbcb319d5e97b9">b_changed</a> ? <a class="code" href="memline_8c.html#aef48b3fc0252f461c7bce9fb717fc542">B0_DIRTY</a> : 0;</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;    b0p-&gt;b0_flags = <a class="code" href="misc2_8c.html#a767812b118182564891e6c771b3a0da0">get_fileformat</a>(buf) + 1;</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;    <a class="code" href="memline_8c.html#af8faa362a3c30969254dac9539895774">set_b0_fname</a>(b0p, buf);</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;    (void)<a class="code" href="misc2_8c.html#abf709bd8a8505e69b7eb371517bcfebc">get_user_name</a>(b0p-&gt;<a class="code" href="structblock0.html#aab3e8eda9003c121be3914c9606854b6">b0_uname</a>, <a class="code" href="memline_8c.html#a67d0b82009004217400bc8708acf4c06">B0_UNAME_SIZE</a>);</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;    b0p-&gt;<a class="code" href="structblock0.html#aab3e8eda9003c121be3914c9606854b6">b0_uname</a>[<a class="code" href="memline_8c.html#a67d0b82009004217400bc8708acf4c06">B0_UNAME_SIZE</a> - 1] = <a class="code" href="ascii_8h.html#af19d48b9f61047a668649a2f9dc317ff">NUL</a>;</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;    <a class="code" href="os__amiga_8c.html#a6a38b6232ff7c7a63fb9e584947b369b">mch_get_host_name</a>(b0p-&gt;<a class="code" href="structblock0.html#a8b0cab71ba5453122bcd862fe3d368ca">b0_hname</a>, <a class="code" href="memline_8c.html#aab71d171eeeefa498adf1f5f725cd010">B0_HNAME_SIZE</a>);</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;    b0p-&gt;<a class="code" href="structblock0.html#a8b0cab71ba5453122bcd862fe3d368ca">b0_hname</a>[<a class="code" href="memline_8c.html#aab71d171eeeefa498adf1f5f725cd010">B0_HNAME_SIZE</a> - 1] = <a class="code" href="ascii_8h.html#af19d48b9f61047a668649a2f9dc317ff">NUL</a>;</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;    <a class="code" href="memline_8c.html#a231a2b743bdebbc1d61725a392830eff">long_to_char</a>(<a class="code" href="os__amiga_8c.html#adef812b3e5ac260085599678ec08eafa">mch_get_pid</a>(), b0p-&gt;<a class="code" href="structblock0.html#ab702799b723f108b57a8b73f83e70346">b0_pid</a>);</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;<span class="preprocessor">#ifdef FEAT_CRYPT</span></div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;    <a class="code" href="memline_8c.html#af1fa068c71604df99341775f25824fdd">ml_set_b0_crypt</a>(buf, b0p);</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;    }</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;<span class="comment">     * Always sync block number 0 to disk, so we can check the file name in</span></div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;<span class="comment">     * the swap file in findswapname(). Don&#39;t do this for a help files or</span></div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;<span class="comment">     * a spell buffer though.</span></div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;<span class="comment">     * Only works when there&#39;s a swapfile, otherwise it&#39;s done when the file</span></div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;<span class="comment">     * is created.</span></div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;    <a class="code" href="memfile_8c.html#abb7f268382703d32becc96f6d92fb855">mf_put</a>(mfp, hp, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;    <span class="keywordflow">if</span> (!buf-&gt;<a class="code" href="structfile__buffer.html#a0be7352b0a40127537e76ea4a8449c13">b_help</a> &amp;&amp; !<a class="code" href="structs_8h.html#a075028952f49cbfea4c573330b75139a">B_SPELL</a>(buf))</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;    (void)<a class="code" href="memfile_8c.html#a0a2aa007c9974950d936bcb9d739563a">mf_sync</a>(mfp, 0);</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;<span class="comment">     * Fill in root pointer block and write page 1.</span></div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;    <span class="keywordflow">if</span> ((hp = <a class="code" href="memline_8c.html#abdecfc521a3e8fe9fde7d0a7f0baa4fc">ml_new_ptr</a>(mfp)) == NULL)</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;    <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;    <span class="keywordflow">if</span> (hp-&gt;bh_bnum != 1)</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;    {</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;    <a class="code" href="message_8c.html#a7926d7fa9a35dc0f5bac051dec01240a">iemsg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;E298: Didn&#39;t get block nr 1?&quot;</span>));</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;    <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;    }</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;    pp = (<a class="code" href="structpointer__block.html">PTR_BL</a> *)(hp-&gt;<a class="code" href="structblock__hdr.html#a7247cdc0977ab6fdc9cb6238cda67587">bh_data</a>);</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;    pp-&gt;<a class="code" href="structpointer__block.html#ad3682038298e7850fb980815132f17f9">pb_count</a> = 1;</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;    pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[0].<a class="code" href="structpointer__entry.html#a0234165c0ca282f192e94957a87175f6">pe_bnum</a> = 2;</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;    pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[0].<a class="code" href="structpointer__entry.html#aa5194eaf0768453f33b9d2ff66508040">pe_page_count</a> = 1;</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;    pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[0].<a class="code" href="structpointer__entry.html#a4ed8c85821e6c5ac44c2a77160d4b26d">pe_old_lnum</a> = 1;</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;    pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[0].<a class="code" href="structpointer__entry.html#a652fe117ed91b4ab3d84361e8aa751de">pe_line_count</a> = 1;    <span class="comment">/* line count after insertion */</span></div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;    <a class="code" href="memfile_8c.html#abb7f268382703d32becc96f6d92fb855">mf_put</a>(mfp, hp, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;<span class="comment">     * Allocate first data block and create an empty line 1.</span></div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;    <span class="keywordflow">if</span> ((hp = <a class="code" href="memline_8c.html#a143a4d348c1d7c3e5ccc591f6653a984">ml_new_data</a>(mfp, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, 1)) == NULL)</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;    <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;    <span class="keywordflow">if</span> (hp-&gt;bh_bnum != 2)</div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;    {</div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;    <a class="code" href="message_8c.html#a7926d7fa9a35dc0f5bac051dec01240a">iemsg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;E298: Didn&#39;t get block nr 2?&quot;</span>));</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;    <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;    }</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;</div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;    dp = (<a class="code" href="structdata__block.html">DATA_BL</a> *)(hp-&gt;<a class="code" href="structblock__hdr.html#a7247cdc0977ab6fdc9cb6238cda67587">bh_data</a>);</div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;    dp-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[0] = --dp-&gt;<a class="code" href="structdata__block.html#a3937f5841b2fed9a042872981b06a7b8">db_txt_start</a>;   <span class="comment">/* at end of block */</span></div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;    dp-&gt;<a class="code" href="structdata__block.html#a6cd7e5186f74ae199fe547bc905b2815">db_free</a> -= 1 + <a class="code" href="memline_8c.html#a33bdc994ac7c8cda7d0df1a3369ab965">INDEX_SIZE</a>;</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;    dp-&gt;<a class="code" href="structdata__block.html#a00084a39a3bdd9a03b9a055216aec5c5">db_line_count</a> = 1;</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;    *((char_u *)dp + dp-&gt;<a class="code" href="structdata__block.html#a3937f5841b2fed9a042872981b06a7b8">db_txt_start</a>) = <a class="code" href="ascii_8h.html#af19d48b9f61047a668649a2f9dc317ff">NUL</a>;   <span class="comment">/* empty line */</span></div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="dosinst_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;error:</div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;    <span class="keywordflow">if</span> (mfp != NULL)</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;    {</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;    <span class="keywordflow">if</span> (hp)</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;        <a class="code" href="memfile_8c.html#abb7f268382703d32becc96f6d92fb855">mf_put</a>(mfp, hp, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;    <a class="code" href="memfile_8c.html#afacf63c365230cb65206d3e98823ec29">mf_close</a>(mfp, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);        <span class="comment">/* will also free(mfp-&gt;mf_fname) */</span></div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;    }</div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a9adb5a08b3c01be69c98360a14937227">ml_mfp</a> = NULL;</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="dosinst_8h.html#abb508ea8227673f419e9fe3a86c30d8e">FAIL</a>;</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;}</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;<span class="preprocessor">#if defined(FEAT_CRYPT) || defined(PROTO)</span></div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;<span class="comment"> * Prepare encryption for &quot;buf&quot; for the current key and method.</span></div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">void</span></div><div class="line"><a name="l00424"></a><span class="lineno"><a class="line" href="memline_8c.html#a72b0c5228c2ef9c96288ce4397f1b7a3">  424</a></span>&#160;<a class="code" href="memline_8c.html#a72b0c5228c2ef9c96288ce4397f1b7a3">ml_set_mfp_crypt</a>(<a class="code" href="structfile__buffer.html">buf_T</a> *buf)</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;{</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;    <span class="keywordflow">if</span> (*buf-&gt;b_p_key != <a class="code" href="ascii_8h.html#af19d48b9f61047a668649a2f9dc317ff">NUL</a>)</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;    {</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;    <span class="keywordtype">int</span> method_nr = <a class="code" href="crypt_8c.html#a2224d31da3a71d7ae8022b582508090c">crypt_get_method_nr</a>(buf);</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;</div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;    <span class="keywordflow">if</span> (method_nr &gt; CRYPT_M_ZIP)</div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;    {</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;        <span class="comment">/* Generate a seed and store it in the memfile. */</span></div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;        <a class="code" href="sha256_8c.html#a7e5749e8118113a34c7964e5d7634b8b">sha2_seed</a>(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a9adb5a08b3c01be69c98360a14937227">ml_mfp</a>-&gt;mf_seed, <a class="code" href="structs_8h.html#a7cf2da642c785ee805f57988d6dd4267">MF_SEED_LEN</a>, NULL, 0);</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;    }</div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;    }</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;}</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;</div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;<span class="comment"> * Prepare encryption for &quot;buf&quot; with block 0 &quot;b0p&quot;.</span></div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">void</span></div><div class="line"><a name="l00442"></a><span class="lineno"><a class="line" href="memline_8c.html#af1fa068c71604df99341775f25824fdd">  442</a></span>&#160;<a class="code" href="memline_8c.html#af1fa068c71604df99341775f25824fdd">ml_set_b0_crypt</a>(<a class="code" href="structfile__buffer.html">buf_T</a> *buf, <a class="code" href="structblock0.html">ZERO_BL</a> *b0p)</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;{</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;    <span class="keywordflow">if</span> (*buf-&gt;b_p_key == <a class="code" href="ascii_8h.html#af19d48b9f61047a668649a2f9dc317ff">NUL</a>)</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;    b0p-&gt;<a class="code" href="structblock0.html#acaaa2249e372c7710c595b07cd3288ec">b0_id</a>[1] = <a class="code" href="memline_8c.html#a19b014ee9a087900435acfa5166c2bea">BLOCK0_ID1</a>;</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;    {</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;    <span class="keywordtype">int</span> method_nr = <a class="code" href="crypt_8c.html#a2224d31da3a71d7ae8022b582508090c">crypt_get_method_nr</a>(buf);</div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;</div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;    b0p-&gt;<a class="code" href="structblock0.html#acaaa2249e372c7710c595b07cd3288ec">b0_id</a>[1] = <a class="code" href="memline_8c.html#ac95d0fd4bafc7f2b52cd415aedcf0f05">id1_codes</a>[method_nr];</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;    <span class="keywordflow">if</span> (method_nr &gt; CRYPT_M_ZIP)</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;    {</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;        <span class="comment">/* Generate a seed and store it in block 0 and in the memfile. */</span></div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;        <a class="code" href="sha256_8c.html#a7e5749e8118113a34c7964e5d7634b8b">sha2_seed</a>(&amp;b0p-&gt;b0_seed, <a class="code" href="structs_8h.html#a7cf2da642c785ee805f57988d6dd4267">MF_SEED_LEN</a>, NULL, 0);</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;        <a class="code" href="os__unix_8h.html#ae70108db942e4f3eeb701ad8787b1835">mch_memmove</a>(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a9adb5a08b3c01be69c98360a14937227">ml_mfp</a>-&gt;mf_seed, &amp;b0p-&gt;b0_seed, <a class="code" href="structs_8h.html#a7cf2da642c785ee805f57988d6dd4267">MF_SEED_LEN</a>);</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;    }</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;    }</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;}</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;<span class="comment"> * Called after the crypt key or &#39;cryptmethod&#39; was changed for &quot;buf&quot;.</span></div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;<span class="comment"> * Will apply this to the swapfile.</span></div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;<span class="comment"> * &quot;old_key&quot; is the previous key.  It is equal to buf-&gt;b_p_key when</span></div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;<span class="comment"> * &#39;cryptmethod&#39; is changed.</span></div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;<span class="comment"> * &quot;old_cm&quot; is the previous &#39;cryptmethod&#39;.  It is equal to the current</span></div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;<span class="comment"> * &#39;cryptmethod&#39; when &#39;key&#39; is changed.</span></div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;    <span class="keywordtype">void</span></div><div class="line"><a name="l00469"></a><span class="lineno"><a class="line" href="memline_8c.html#a3d99e7af7190b24b26e4eaa5f6096b94">  469</a></span>&#160;<a class="code" href="memline_8c.html#a3d99e7af7190b24b26e4eaa5f6096b94">ml_set_crypt_key</a>(</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;    <a class="code" href="structfile__buffer.html">buf_T</a>   *buf,</div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;    char_u  *old_key,</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;    char_u  *old_cm)</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;{</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;    <a class="code" href="structmemfile.html">memfile_T</a>   *mfp = buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a9adb5a08b3c01be69c98360a14937227">ml_mfp</a>;</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;    <a class="code" href="structblock__hdr.html">bhdr_T</a>  *hp;</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;    <span class="keywordtype">int</span>     <a class="code" href="hardcopy_8c.html#a8779304c095e1ed27c30d4b5b3f2437a">page_count</a>;</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;    <span class="keywordtype">int</span>     idx;</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;    <span class="keywordtype">long</span>    error;</div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;    <a class="code" href="structinfo__pointer.html">infoptr_T</a>   *<a class="code" href="namespacetest__channel.html#a6a2152bf75d93cd14fcffc99c3e76807">ip</a>;</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;    <a class="code" href="structpointer__block.html">PTR_BL</a>  *pp;</div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;    <a class="code" href="structdata__block.html">DATA_BL</a> *dp;</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;    <a class="code" href="structs_8h.html#a012394c4a7db63f99f6f0cdacab79527">blocknr_T</a>   bnum;</div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;    <span class="keywordtype">int</span>     top;</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;    <span class="keywordtype">int</span>     old_method;</div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;</div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;    <span class="keywordflow">if</span> (mfp == NULL)</div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;    <span class="keywordflow">return</span>;  <span class="comment">/* no memfile yet, nothing to do */</span></div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;    old_method = <a class="code" href="crypt_8c.html#a48a8e10523a0d4037893a3013af26eee">crypt_method_nr_from_name</a>(old_cm);</div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;    <span class="comment">/* First make sure the swapfile is in a consistent state, using the old</span></div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;<span class="comment">     * key and method. */</span></div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;    {</div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;    char_u *new_key = buf-&gt;b_p_key;</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;    char_u *new_buf_cm = buf-&gt;b_p_cm;</div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;</div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;    buf-&gt;b_p_key = old_key;</div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;    buf-&gt;b_p_cm = old_cm;</div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;    <a class="code" href="memline_8c.html#a6456f3ec13f95cc144e0904cf6845bdb">ml_preserve</a>(buf, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;    buf-&gt;b_p_key = new_key;</div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;    buf-&gt;b_p_cm = new_buf_cm;</div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;    }</div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;</div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;    <span class="comment">/* Set the key, method and seed to be used for reading, these must be the</span></div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;<span class="comment">     * old values. */</span></div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;    mfp-&gt;mf_old_key = old_key;</div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;    mfp-&gt;mf_old_cm = old_method;</div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;    <span class="keywordflow">if</span> (old_method &gt; 0 &amp;&amp; *old_key != <a class="code" href="ascii_8h.html#af19d48b9f61047a668649a2f9dc317ff">NUL</a>)</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;    <a class="code" href="os__unix_8h.html#ae70108db942e4f3eeb701ad8787b1835">mch_memmove</a>(mfp-&gt;mf_old_seed, mfp-&gt;mf_seed, <a class="code" href="structs_8h.html#a7cf2da642c785ee805f57988d6dd4267">MF_SEED_LEN</a>);</div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;</div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;    <span class="comment">/* Update block 0 with the crypt flag and may set a new seed. */</span></div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;    <a class="code" href="memline_8c.html#aafe17e152f79b72e5e3e52013d5ba4dd">ml_upd_block0</a>(buf, <a class="code" href="memline_8c.html#aeb2a08db86a3f3c959cc50de278339eda657b3ee32a0fea16c976931ef3bc9e27">UB_CRYPT</a>);</div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;</div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;    <span class="keywordflow">if</span> (mfp-&gt;<a class="code" href="structmemfile.html#afdcf6885ed563e5559f9d31f63c0635d">mf_infile_count</a> &gt; 2)</div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;    {</div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;<span class="comment">     * Need to read back all data blocks from disk, decrypt them with the</span></div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;<span class="comment">     * old key/method and mark them to be written. The algorithm is</span></div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;<span class="comment">     * similar to what happens in ml_recover(), but we skip negative block</span></div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;<span class="comment">     * numbers.</span></div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;    <a class="code" href="memline_8c.html#a20a3268681f79a76b9af2f2fc7b644b6">ml_flush_line</a>(buf);         <span class="comment">/* flush buffered line */</span></div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;    (void)<a class="code" href="memline_8c.html#ade8fe98188345bdd3c230545fc4a614f">ml_find_line</a>(buf, (<a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>)0, <a class="code" href="memline_8c.html#a89ca94197abc00b6c372ff0a72b4a091">ML_FLUSH</a>); <span class="comment">/* flush locked block */</span></div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;</div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;    hp = NULL;</div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;    bnum = 1;       <span class="comment">/* start with block 1 */</span></div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;    page_count = 1;     <span class="comment">/* which is 1 page */</span></div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;    idx = 0;        <span class="comment">/* start with first index in block 1 */</span></div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;    error = 0;</div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a17d957b4b662bf327749e1523ac4f5b5">ml_stack_top</a> = 0;</div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;    <a class="code" href="macros_8h.html#a74420d7769a3c31521652566a1cdb094">VIM_CLEAR</a>(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a77e2179043ee3367af09fe186b2fa5a8">ml_stack</a>);</div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#add4fba4ecd680fbf53ab842c85ccde21">ml_stack_size</a> = 0;    <span class="comment">/* no stack yet */</span></div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;</div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;    <span class="keywordflow">for</span> ( ; !got_int; <a class="code" href="misc1_8c.html#a8703516dc56663f759f265915d1acc2d">line_breakcheck</a>())</div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;    {</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;        <span class="keywordflow">if</span> (hp != NULL)</div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;        <a class="code" href="memfile_8c.html#abb7f268382703d32becc96f6d92fb855">mf_put</a>(mfp, hp, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);  <span class="comment">/* release previous block */</span></div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;</div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;        <span class="comment">/* get the block (pointer or data) */</span></div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;        <span class="keywordflow">if</span> ((hp = <a class="code" href="memfile_8c.html#af9d5ff9ad91a2d5150a675c9c0d77e10">mf_get</a>(mfp, (<a class="code" href="structs_8h.html#a012394c4a7db63f99f6f0cdacab79527">blocknr_T</a>)bnum, page_count)) == NULL)</div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;        {</div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;        <span class="keywordflow">if</span> (bnum == 1)</div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;        ++error;</div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;        }</div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;        {</div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;        pp = (<a class="code" href="structpointer__block.html">PTR_BL</a> *)(hp-&gt;<a class="code" href="structblock__hdr.html#a7247cdc0977ab6fdc9cb6238cda67587">bh_data</a>);</div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;        <span class="keywordflow">if</span> (pp-&gt;<a class="code" href="structpointer__block.html#ac2698ad2c9c4096299106a53ffbd667f">pb_id</a> == <a class="code" href="memline_8c.html#a23d0125357ec4465a50f841f634c9214">PTR_ID</a>)    <span class="comment">/* it is a pointer block */</span></div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;        {</div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;            <span class="keywordflow">if</span> (pp-&gt;<a class="code" href="structpointer__block.html#ad3682038298e7850fb980815132f17f9">pb_count</a> == 0)</div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;            {</div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;            <span class="comment">/* empty block? */</span></div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;            ++error;</div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;            }</div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (idx &lt; (<span class="keywordtype">int</span>)pp-&gt;<a class="code" href="structpointer__block.html#ad3682038298e7850fb980815132f17f9">pb_count</a>)   <span class="comment">/* go a block deeper */</span></div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;            {</div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;            <span class="keywordflow">if</span> (pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[idx].<a class="code" href="structpointer__entry.html#a0234165c0ca282f192e94957a87175f6">pe_bnum</a> &lt; 0)</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;            {</div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;                <span class="comment">/* Skip data block with negative block number.</span></div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;<span class="comment">                 * Should not happen, because of the ml_preserve()</span></div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;<span class="comment">                 * above. Get same block again for next index. */</span></div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;                ++idx;</div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;                <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;            }</div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;</div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;            <span class="comment">/* going one block deeper in the tree, new entry in</span></div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;<span class="comment">             * stack */</span></div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;            <span class="keywordflow">if</span> ((top = <a class="code" href="memline_8c.html#aa6909d6a13a3189fdb549bea27afc662">ml_add_stack</a>(buf)) &lt; 0)</div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;            {</div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;                ++error;</div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;                <span class="keywordflow">break</span>;          <span class="comment">/* out of memory */</span></div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;            }</div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;            ip = &amp;(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a77e2179043ee3367af09fe186b2fa5a8">ml_stack</a>[top]);</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;            ip-&gt;<a class="code" href="structinfo__pointer.html#a140d83e56091daa97560a9a4a82a8c1b">ip_bnum</a> = bnum;</div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;            ip-&gt;<a class="code" href="structinfo__pointer.html#acdf584cb720506bd2f40240dc71bab50">ip_index</a> = idx;</div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;</div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;            bnum = pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[idx].<a class="code" href="structpointer__entry.html#a0234165c0ca282f192e94957a87175f6">pe_bnum</a>;</div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;            page_count = pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[idx].<a class="code" href="structpointer__entry.html#aa5194eaf0768453f33b9d2ff66508040">pe_page_count</a>;</div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;            idx = 0;</div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;            <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;            }</div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;        }</div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;        <span class="keywordflow">else</span>        <span class="comment">/* not a pointer block */</span></div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;        {</div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;            dp = (<a class="code" href="structdata__block.html">DATA_BL</a> *)(hp-&gt;<a class="code" href="structblock__hdr.html#a7247cdc0977ab6fdc9cb6238cda67587">bh_data</a>);</div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;            <span class="keywordflow">if</span> (dp-&gt;<a class="code" href="structdata__block.html#ac977617f5f8153eda5d902a73e0379e1">db_id</a> != <a class="code" href="memline_8c.html#a55aa586df150c1192826a1c57dd87401">DATA_ID</a>)   <span class="comment">/* block id wrong */</span></div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;            ++error;</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;            {</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;            <span class="comment">/* It is a data block, need to write it back to disk. */</span></div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;            <a class="code" href="memfile_8c.html#abb7f268382703d32becc96f6d92fb855">mf_put</a>(mfp, hp, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;            hp = NULL;</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;            }</div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;        }</div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;        }</div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;</div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;        <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a17d957b4b662bf327749e1523ac4f5b5">ml_stack_top</a> == 0)    <span class="comment">/* finished */</span></div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;</div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;        <span class="comment">/* go one block up in the tree */</span></div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;        ip = &amp;(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a77e2179043ee3367af09fe186b2fa5a8">ml_stack</a>[--(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a17d957b4b662bf327749e1523ac4f5b5">ml_stack_top</a>)]);</div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;        bnum = ip-&gt;<a class="code" href="structinfo__pointer.html#a140d83e56091daa97560a9a4a82a8c1b">ip_bnum</a>;</div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;        idx = ip-&gt;<a class="code" href="structinfo__pointer.html#acdf584cb720506bd2f40240dc71bab50">ip_index</a> + 1;     <span class="comment">/* go to next index */</span></div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;        page_count = 1;</div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;    }</div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;    <span class="keywordflow">if</span> (hp != NULL)</div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;        <a class="code" href="memfile_8c.html#abb7f268382703d32becc96f6d92fb855">mf_put</a>(mfp, hp, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);  <span class="comment">/* release previous block */</span></div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;</div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;    <span class="keywordflow">if</span> (error &gt; 0)</div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;        <a class="code" href="message_8c.html#ae5991a4d11897dfaee9bfab8e5489d82">emsg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;E843: Error while updating swap file crypt&quot;</span>));</div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;    }</div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;</div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;    mfp-&gt;mf_old_key = NULL;</div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;}</div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;</div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;<span class="comment"> * ml_setname() is called when the file name of &quot;buf&quot; has been changed.</span></div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;<span class="comment"> * It may rename the swap file.</span></div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;    <span class="keywordtype">void</span></div><div class="line"><a name="l00622"></a><span class="lineno"><a class="line" href="memline_8c.html#ae411c532dd4d1d4af9a5dd6b91199086">  622</a></span>&#160;<a class="code" href="memline_8c.html#ae411c532dd4d1d4af9a5dd6b91199086">ml_setname</a>(<a class="code" href="structfile__buffer.html">buf_T</a> *buf)</div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;{</div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;    <span class="keywordtype">int</span>     success = <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;    <a class="code" href="structmemfile.html">memfile_T</a>   *mfp;</div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;    char_u  *fname;</div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;    char_u  *dirp;</div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;<span class="preprocessor">#if defined(MSWIN)</span></div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;    char_u  *p;</div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;</div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;    mfp = buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a9adb5a08b3c01be69c98360a14937227">ml_mfp</a>;</div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;    <span class="keywordflow">if</span> (mfp-&gt;<a class="code" href="structmemfile.html#a70c16d084045ec45dbe251430e7a81a5">mf_fd</a> &lt; 0)         <span class="comment">/* there is no swap file yet */</span></div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;    {</div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;<span class="comment">     * When &#39;updatecount&#39; is 0 and &#39;noswapfile&#39; there is no swap file.</span></div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;<span class="comment">     * For help files we will make a swap file now.</span></div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="option_8h.html#ab9d1347f05d6fab96b4ebba410df10f6">p_uc</a> != 0 &amp;&amp; !<a class="code" href="structcmdmod.html">cmdmod</a>.noswapfile)</div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;        <a class="code" href="memline_8c.html#af02ef149bb7430fbe0cd031bbab8b3c2">ml_open_file</a>(buf);      <span class="comment">/* create a swap file */</span></div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;    }</div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;</div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;<span class="comment">     * Try all directories in the &#39;directory&#39; option.</span></div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;    dirp = <a class="code" href="option_8h.html#a8668e2dd511003c9ad5a9032c1a17c3e">p_dir</a>;</div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;    <span class="keywordflow">for</span> (;;)</div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;    {</div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;    <span class="keywordflow">if</span> (*dirp == <a class="code" href="ascii_8h.html#af19d48b9f61047a668649a2f9dc317ff">NUL</a>)       <span class="comment">/* tried all directories, fail */</span></div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;    fname = <a class="code" href="memline_8c.html#af8d501a6ccea291cd77605d10240eeda">findswapname</a>(buf, &amp;dirp, mfp-&gt;<a class="code" href="structmemfile.html#acf87c004bb17883fecc56966daa0a7f3">mf_fname</a>);</div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;                            <span class="comment">/* alloc&#39;s fname */</span></div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;    <span class="keywordflow">if</span> (dirp == NULL)       <span class="comment">/* out of memory */</span></div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;    <span class="keywordflow">if</span> (fname == NULL)      <span class="comment">/* no file name found for this dir */</span></div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;        <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;</div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;<span class="preprocessor">#if defined(MSWIN)</span></div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;<span class="comment">     * Set full pathname for swap file now, because a &quot;:!cd dir&quot; may</span></div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;<span class="comment">     * change directory without us knowing it.</span></div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;    p = <a class="code" href="filepath_8c.html#a433b6128e0e476f8bf41348e0e27f2c7">FullName_save</a>(fname, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;    <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(fname);</div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;    fname = p;</div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;    <span class="keywordflow">if</span> (fname == NULL)</div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;        <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;    <span class="comment">/* if the file name is the same we don&#39;t have to do anything */</span></div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="vim_8h.html#a74e72b20fdc634f1981f0e0b503368e9">fnamecmp</a>(fname, mfp-&gt;<a class="code" href="structmemfile.html#acf87c004bb17883fecc56966daa0a7f3">mf_fname</a>) == 0)</div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;    {</div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;        <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(fname);</div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;        success = <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;    }</div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;    <span class="comment">/* need to close the swap file before renaming */</span></div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;    <span class="keywordflow">if</span> (mfp-&gt;<a class="code" href="structmemfile.html#a70c16d084045ec45dbe251430e7a81a5">mf_fd</a> &gt;= 0)</div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;    {</div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;        close(mfp-&gt;<a class="code" href="structmemfile.html#a70c16d084045ec45dbe251430e7a81a5">mf_fd</a>);</div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;        mfp-&gt;<a class="code" href="structmemfile.html#a70c16d084045ec45dbe251430e7a81a5">mf_fd</a> = -1;</div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;    }</div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;</div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;    <span class="comment">/* try to rename the swap file */</span></div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="fileio_8c.html#a0bc0ace50d9cb272c0ed6810a74b2d0d">vim_rename</a>(mfp-&gt;<a class="code" href="structmemfile.html#acf87c004bb17883fecc56966daa0a7f3">mf_fname</a>, fname) == 0)</div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;    {</div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;        success = <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;        <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(mfp-&gt;<a class="code" href="structmemfile.html#acf87c004bb17883fecc56966daa0a7f3">mf_fname</a>);</div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;        mfp-&gt;<a class="code" href="structmemfile.html#acf87c004bb17883fecc56966daa0a7f3">mf_fname</a> = fname;</div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;        <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(mfp-&gt;<a class="code" href="structmemfile.html#acf36a779315f1dea7b015e5a3c5e9785">mf_ffname</a>);</div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;<span class="preprocessor">#if defined(MSWIN)</span></div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;        mfp-&gt;<a class="code" href="structmemfile.html#acf36a779315f1dea7b015e5a3c5e9785">mf_ffname</a> = NULL;  <span class="comment">/* mf_fname is full pathname already */</span></div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;        <a class="code" href="memfile_8c.html#a0d08b5a784a38d87c1338f37ffee917a">mf_set_ffname</a>(mfp);</div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;        <a class="code" href="memline_8c.html#aafe17e152f79b72e5e3e52013d5ba4dd">ml_upd_block0</a>(buf, <a class="code" href="memline_8c.html#aeb2a08db86a3f3c959cc50de278339eda3e3c35facf7ed67537393dd40196c797">UB_SAME_DIR</a>);</div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;    }</div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;    <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(fname);        <span class="comment">/* this fname didn&#39;t work, try another */</span></div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;    }</div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;</div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;    <span class="keywordflow">if</span> (mfp-&gt;<a class="code" href="structmemfile.html#a70c16d084045ec45dbe251430e7a81a5">mf_fd</a> == -1)       <span class="comment">/* need to (re)open the swap file */</span></div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;    {</div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;    mfp-&gt;<a class="code" href="structmemfile.html#a70c16d084045ec45dbe251430e7a81a5">mf_fd</a> = <a class="code" href="os__win32_8c.html#a86a6c2e2a013622ad468bcdbc07bbfd6">mch_open</a>((<span class="keywordtype">char</span> *)mfp-&gt;<a class="code" href="structmemfile.html#acf87c004bb17883fecc56966daa0a7f3">mf_fname</a>, O_RDWR | <a class="code" href="vim_8h.html#a9f1019b10a1c51d588f4500cde3a6746">O_EXTRA</a>, 0);</div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;    <span class="keywordflow">if</span> (mfp-&gt;<a class="code" href="structmemfile.html#a70c16d084045ec45dbe251430e7a81a5">mf_fd</a> &lt; 0)</div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;    {</div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;        <span class="comment">/* could not (re)open the swap file, what can we do???? */</span></div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;        <a class="code" href="message_8c.html#ae5991a4d11897dfaee9bfab8e5489d82">emsg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;E301: Oops, lost the swap file!!!&quot;</span>));</div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;    }</div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;<span class="preprocessor">#ifdef HAVE_FD_CLOEXEC</span></div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;    {</div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;        <span class="keywordtype">int</span> fdflags = fcntl(mfp-&gt;<a class="code" href="structmemfile.html#a70c16d084045ec45dbe251430e7a81a5">mf_fd</a>, F_GETFD);</div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;        <span class="keywordflow">if</span> (fdflags &gt;= 0 &amp;&amp; (fdflags &amp; FD_CLOEXEC) == 0)</div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;        (void)fcntl(mfp-&gt;<a class="code" href="structmemfile.html#a70c16d084045ec45dbe251430e7a81a5">mf_fd</a>, F_SETFD, fdflags | FD_CLOEXEC);</div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;    }</div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;    }</div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;    <span class="keywordflow">if</span> (!success)</div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;    <a class="code" href="message_8c.html#ae5991a4d11897dfaee9bfab8e5489d82">emsg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;E302: Could not rename swap file&quot;</span>));</div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;}</div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;</div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;<span class="comment"> * Open a file for the memfile for all buffers that are not readonly or have</span></div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;<span class="comment"> * been modified.</span></div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;<span class="comment"> * Used when &#39;updatecount&#39; changes from zero to non-zero.</span></div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;    <span class="keywordtype">void</span></div><div class="line"><a name="l00729"></a><span class="lineno"><a class="line" href="memline_8c.html#a945648d1f1ffc6e2ef410316ecdec777">  729</a></span>&#160;<a class="code" href="memline_8c.html#a945648d1f1ffc6e2ef410316ecdec777">ml_open_files</a>(<span class="keywordtype">void</span>)</div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;{</div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;    <a class="code" href="structfile__buffer.html">buf_T</a>   *buf;</div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;</div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;    <a class="code" href="globals_8h.html#ab2dfc04411a40f8bcaf0f45b0d16f482">FOR_ALL_BUFFERS</a>(buf)</div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;    <span class="keywordflow">if</span> (!buf-&gt;<a class="code" href="structfile__buffer.html#a7ffb8516d12b390e45fc3af4d670d020">b_p_ro</a> || buf-&gt;<a class="code" href="structfile__buffer.html#aa4b0a02270ec71cb25dbcb319d5e97b9">b_changed</a>)</div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;        <a class="code" href="memline_8c.html#af02ef149bb7430fbe0cd031bbab8b3c2">ml_open_file</a>(buf);</div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;}</div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;</div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;<span class="comment"> * Open a swap file for an existing memfile, if there is no swap file yet.</span></div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;<span class="comment"> * If we are unable to find a file name, mf_fname will be NULL</span></div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;<span class="comment"> * and the memfile will be in memory only (no recovery possible).</span></div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;    <span class="keywordtype">void</span></div><div class="line"><a name="l00744"></a><span class="lineno"><a class="line" href="memline_8c.html#af02ef149bb7430fbe0cd031bbab8b3c2">  744</a></span>&#160;<a class="code" href="memline_8c.html#af02ef149bb7430fbe0cd031bbab8b3c2">ml_open_file</a>(<a class="code" href="structfile__buffer.html">buf_T</a> *buf)</div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;{</div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;    <a class="code" href="structmemfile.html">memfile_T</a>   *mfp;</div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;    char_u  *fname;</div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;    char_u  *dirp;</div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;</div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;    mfp = buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a9adb5a08b3c01be69c98360a14937227">ml_mfp</a>;</div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;    <span class="keywordflow">if</span> (mfp == NULL || mfp-&gt;<a class="code" href="structmemfile.html#a70c16d084045ec45dbe251430e7a81a5">mf_fd</a> &gt;= 0 || !buf-&gt;<a class="code" href="structfile__buffer.html#a0dbc556e96a2a6afd3284b5a3bae167a">b_p_swf</a> || <a class="code" href="structcmdmod.html">cmdmod</a>.noswapfile)</div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;    <span class="keywordflow">return</span>;     <span class="comment">/* nothing to do */</span></div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;</div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;<span class="preprocessor">#ifdef FEAT_SPELL</span></div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;    <span class="comment">/* For a spell buffer use a temp file name. */</span></div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;    <span class="keywordflow">if</span> (buf-&gt;b_spell)</div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;    {</div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;    fname = <a class="code" href="fileio_8c.html#a00ff91d733dfe503a764535bd6effbd2">vim_tempname</a>(<span class="charliteral">&#39;s&#39;</span>, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;    <span class="keywordflow">if</span> (fname != NULL)</div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;        (void)<a class="code" href="memfile_8c.html#a6f855db0909de20a82fcd3ed904cfe37">mf_open_file</a>(mfp, fname); <span class="comment">/* consumes fname! */</span></div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#a18b9a8836718e7f4f791c80a6d28bd9b">b_may_swap</a> = <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;    }</div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;</div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;<span class="comment">     * Try all directories in &#39;directory&#39; option.</span></div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;    dirp = <a class="code" href="option_8h.html#a8668e2dd511003c9ad5a9032c1a17c3e">p_dir</a>;</div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;    <span class="keywordflow">for</span> (;;)</div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;    {</div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;    <span class="keywordflow">if</span> (*dirp == <a class="code" href="ascii_8h.html#af19d48b9f61047a668649a2f9dc317ff">NUL</a>)</div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;    <span class="comment">/* There is a small chance that between choosing the swap file name</span></div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;<span class="comment">     * and creating it, another Vim creates the file.  In that case the</span></div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;<span class="comment">     * creation will fail and we will use another directory. */</span></div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;    fname = <a class="code" href="memline_8c.html#af8d501a6ccea291cd77605d10240eeda">findswapname</a>(buf, &amp;dirp, NULL); <span class="comment">/* allocates fname */</span></div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;    <span class="keywordflow">if</span> (dirp == NULL)</div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;        <span class="keywordflow">break</span>;  <span class="comment">/* out of memory */</span></div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;    <span class="keywordflow">if</span> (fname == NULL)</div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;        <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="memfile_8c.html#a6f855db0909de20a82fcd3ed904cfe37">mf_open_file</a>(mfp, fname) == <a class="code" href="dosinst_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>) <span class="comment">/* consumes fname! */</span></div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;    {</div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;<span class="preprocessor">#if defined(MSWIN)</span></div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;        <span class="comment">/*</span></div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;<span class="comment">         * set full pathname for swap file now, because a &quot;:!cd dir&quot; may</span></div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;<span class="comment">         * change directory without us knowing it.</span></div><div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;<span class="comment">         */</span></div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;        <a class="code" href="memfile_8c.html#ac165bbbf9ce06b4a7bb612d280de6c3a">mf_fullname</a>(mfp);</div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;        <a class="code" href="memline_8c.html#aafe17e152f79b72e5e3e52013d5ba4dd">ml_upd_block0</a>(buf, <a class="code" href="memline_8c.html#aeb2a08db86a3f3c959cc50de278339eda3e3c35facf7ed67537393dd40196c797">UB_SAME_DIR</a>);</div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;</div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;        <span class="comment">/* Flush block zero, so others can read it */</span></div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="memfile_8c.html#a0a2aa007c9974950d936bcb9d739563a">mf_sync</a>(mfp, <a class="code" href="vim_8h.html#a066f9420ac6e8bdb62ec8f50c8ad8d9e">MFS_ZERO</a>) == <a class="code" href="dosinst_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>)</div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;        {</div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;        <span class="comment">/* Mark all blocks that should be in the swapfile as dirty.</span></div><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;<span class="comment">         * Needed for when the &#39;swapfile&#39; option was reset, so that</span></div><div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;<span class="comment">         * the swap file was deleted, and then on again. */</span></div><div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;        <a class="code" href="memfile_8c.html#aabb7739af88ce85526b63f333e10bed6">mf_set_dirty</a>(mfp);</div><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;        }</div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;        <span class="comment">/* Writing block 0 failed: close the file and try another dir */</span></div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;        <a class="code" href="memfile_8c.html#a6383b438b81a79c3c4e3a8c57c6babbb">mf_close_file</a>(buf, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;    }</div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;    }</div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;</div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;    <span class="keywordflow">if</span> (mfp-&gt;<a class="code" href="structmemfile.html#acf87c004bb17883fecc56966daa0a7f3">mf_fname</a> == NULL)      <span class="comment">/* Failed! */</span></div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;    {</div><div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;    need_wait_return = <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;    <span class="comment">/* call wait_return later */</span></div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;    ++no_wait_return;</div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;    (void)<a class="code" href="message_8c.html#aeb2442b830699494f53059773212d850">semsg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;E303: Unable to open swap file for \&quot;%s\&quot;, recovery impossible&quot;</span>),</div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;            <a class="code" href="buffer_8c.html#ae729d3d218b6375165add7d4917b7a4f">buf_spname</a>(buf) != NULL ? <a class="code" href="buffer_8c.html#ae729d3d218b6375165add7d4917b7a4f">buf_spname</a>(buf) : buf-&gt;<a class="code" href="structfile__buffer.html#a34a7c5a6d702c7ce0181584242976f3e">b_fname</a>);</div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;    --no_wait_return;</div><div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;    }</div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;</div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;    <span class="comment">/* don&#39;t try to open a swap file again */</span></div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#a18b9a8836718e7f4f791c80a6d28bd9b">b_may_swap</a> = <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;}</div><div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;</div><div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;<span class="comment"> * If still need to create a swap file, and starting to edit a not-readonly</span></div><div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;<span class="comment"> * file, or reading into an existing buffer, create a swap file now.</span></div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;    <span class="keywordtype">void</span></div><div class="line"><a name="l00825"></a><span class="lineno"><a class="line" href="memline_8c.html#a6a6a68ff0366721a068693b1a8752a1c">  825</a></span>&#160;<a class="code" href="memline_8c.html#a6a6a68ff0366721a068693b1a8752a1c">check_need_swap</a>(</div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;    <span class="keywordtype">int</span>     newfile)        <span class="comment">// reading file into new buffer</span></div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;{</div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;    <span class="keywordtype">int</span> old_msg_silent = msg_silent; <span class="comment">// might be reset by an E325 message</span></div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;</div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;    <span class="keywordflow">if</span> (curbuf-&gt;b_may_swap &amp;&amp; (!curbuf-&gt;b_p_ro || !newfile))</div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;    <a class="code" href="memline_8c.html#af02ef149bb7430fbe0cd031bbab8b3c2">ml_open_file</a>(curbuf);</div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;    msg_silent = old_msg_silent;</div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;}</div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;</div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;<span class="comment"> * Close memline for buffer &#39;buf&#39;.</span></div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;<span class="comment"> * If &#39;del_file&#39; is TRUE, delete the swap file</span></div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;    <span class="keywordtype">void</span></div><div class="line"><a name="l00840"></a><span class="lineno"><a class="line" href="memline_8c.html#abe58d9866bc8d9d29c219f731bb85ceb">  840</a></span>&#160;<a class="code" href="memline_8c.html#abe58d9866bc8d9d29c219f731bb85ceb">ml_close</a>(<a class="code" href="structfile__buffer.html">buf_T</a> *buf, <span class="keywordtype">int</span> del_file)</div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;{</div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;    <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a9adb5a08b3c01be69c98360a14937227">ml_mfp</a> == NULL)       <span class="comment">/* not open */</span></div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;    <a class="code" href="memfile_8c.html#afacf63c365230cb65206d3e98823ec29">mf_close</a>(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a9adb5a08b3c01be69c98360a14937227">ml_mfp</a>, del_file);   <span class="comment">/* close the .swp file */</span></div><div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;    <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a62222eb79ef59eddaff71f0f8cdff764">ml_line_lnum</a> != 0 &amp;&amp; (buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a30f30ddb7264f667a92556f0568981e0">ml_flags</a> &amp; <a class="code" href="structs_8h.html#a8fac7ceea6e156c2915cdcf7e228a9f8">ML_LINE_DIRTY</a>))</div><div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;    <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#aada7438521544eec6c73e223b2811a69">ml_line_ptr</a>);</div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;    <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a77e2179043ee3367af09fe186b2fa5a8">ml_stack</a>);</div><div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;<span class="preprocessor">#ifdef FEAT_BYTEOFF</span></div><div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;    <a class="code" href="macros_8h.html#a74420d7769a3c31521652566a1cdb094">VIM_CLEAR</a>(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_chunksize);</div><div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a9adb5a08b3c01be69c98360a14937227">ml_mfp</a> = NULL;</div><div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;</div><div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;    <span class="comment">/* Reset the &quot;recovered&quot; flag, give the ATTENTION prompt the next time</span></div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;<span class="comment">     * this buffer is loaded. */</span></div><div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#a82e1f497c5a51eff88502f03dd1cd5c3">b_flags</a> &amp;= ~<a class="code" href="vim_8h.html#acc0703dad0b379b34be226e2402937db">BF_RECOVERED</a>;</div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;}</div><div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;</div><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;<span class="comment"> * Close all existing memlines and memfiles.</span></div><div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;<span class="comment"> * Only used when exiting.</span></div><div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;<span class="comment"> * When &#39;del_file&#39; is TRUE, delete the memfiles.</span></div><div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;<span class="comment"> * But don&#39;t delete files that were &quot;:preserve&quot;d when we are POSIX compatible.</span></div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;    <span class="keywordtype">void</span></div><div class="line"><a name="l00865"></a><span class="lineno"><a class="line" href="memline_8c.html#a03d439d0a90af7064a71e4103b0a5b9f">  865</a></span>&#160;<a class="code" href="memline_8c.html#a03d439d0a90af7064a71e4103b0a5b9f">ml_close_all</a>(<span class="keywordtype">int</span> del_file)</div><div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;{</div><div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;    <a class="code" href="structfile__buffer.html">buf_T</a>   *buf;</div><div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;</div><div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;    <a class="code" href="globals_8h.html#ab2dfc04411a40f8bcaf0f45b0d16f482">FOR_ALL_BUFFERS</a>(buf)</div><div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;    <a class="code" href="memline_8c.html#abe58d9866bc8d9d29c219f731bb85ceb">ml_close</a>(buf, del_file &amp;&amp; ((buf-&gt;<a class="code" href="structfile__buffer.html#a82e1f497c5a51eff88502f03dd1cd5c3">b_flags</a> &amp; <a class="code" href="vim_8h.html#a85e06d6b82dd2039305f00f975410d87">BF_PRESERVED</a>) == 0</div><div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;                 || <a class="code" href="misc2_8c.html#a8978cebac3b4ced66551e67c3a375842">vim_strchr</a>(<a class="code" href="option_8h.html#a441e114eba9a56d517bbe74d233ec3f9">p_cpo</a>, <a class="code" href="option_8h.html#aebddc6c785cabe7f58b1cfa664fe2c5b">CPO_PRESERVE</a>) == NULL));</div><div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;<span class="preprocessor">#ifdef FEAT_SPELL</span></div><div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;    <a class="code" href="spell_8c.html#a7ed01e093616f319cf06098f7796c35b">spell_delete_wordlist</a>();    <span class="comment">/* delete the internal wordlist */</span></div><div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;<span class="preprocessor">#ifdef TEMPDIRNAMES</span></div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;    vim_deltempdir();       <span class="comment">/* delete created temp directory */</span></div><div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;}</div><div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;</div><div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;<span class="comment"> * Close all memfiles for not modified buffers.</span></div><div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;<span class="comment"> * Only use just before exiting!</span></div><div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;    <span class="keywordtype">void</span></div><div class="line"><a name="l00885"></a><span class="lineno"><a class="line" href="memline_8c.html#a604565a0ff35e06e698b0b74abc87ec1">  885</a></span>&#160;<a class="code" href="memline_8c.html#a604565a0ff35e06e698b0b74abc87ec1">ml_close_notmod</a>(<span class="keywordtype">void</span>)</div><div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;{</div><div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;    <a class="code" href="structfile__buffer.html">buf_T</a>   *buf;</div><div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;</div><div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;    <a class="code" href="globals_8h.html#ab2dfc04411a40f8bcaf0f45b0d16f482">FOR_ALL_BUFFERS</a>(buf)</div><div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="undo_8c.html#a56fe60092b6057c7cc3a38c785048841">bufIsChanged</a>(buf))</div><div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;        <a class="code" href="memline_8c.html#abe58d9866bc8d9d29c219f731bb85ceb">ml_close</a>(buf, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);    <span class="comment">/* close all not-modified buffers */</span></div><div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;}</div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;</div><div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;<span class="comment"> * Update the timestamp in the .swp file.</span></div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;<span class="comment"> * Used when the file has been written.</span></div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;    <span class="keywordtype">void</span></div><div class="line"><a name="l00899"></a><span class="lineno"><a class="line" href="memline_8c.html#a9f6bf1b47e0e5c17ed49833bfffe8527">  899</a></span>&#160;<a class="code" href="memline_8c.html#a9f6bf1b47e0e5c17ed49833bfffe8527">ml_timestamp</a>(<a class="code" href="structfile__buffer.html">buf_T</a> *buf)</div><div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;{</div><div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;    <a class="code" href="memline_8c.html#aafe17e152f79b72e5e3e52013d5ba4dd">ml_upd_block0</a>(buf, <a class="code" href="memline_8c.html#aeb2a08db86a3f3c959cc50de278339edae07039e8880c427cedb331eac7444095">UB_FNAME</a>);</div><div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;}</div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;</div><div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;<span class="comment"> * Return FAIL when the ID of &quot;b0p&quot; is wrong.</span></div><div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">int</span></div><div class="line"><a name="l00908"></a><span class="lineno"><a class="line" href="memline_8c.html#a7c54be0e5b07e1fe53155d1174a746e8">  908</a></span>&#160;<a class="code" href="memline_8c.html#a7c54be0e5b07e1fe53155d1174a746e8">ml_check_b0_id</a>(<a class="code" href="structblock0.html">ZERO_BL</a> *b0p)</div><div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;{</div><div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;    <span class="keywordflow">if</span> (b0p-&gt;<a class="code" href="structblock0.html#acaaa2249e372c7710c595b07cd3288ec">b0_id</a>[0] != <a class="code" href="memline_8c.html#ace6f748ee345944bbe21944baea19883">BLOCK0_ID0</a></div><div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;        || (b0p-&gt;<a class="code" href="structblock0.html#acaaa2249e372c7710c595b07cd3288ec">b0_id</a>[1] != <a class="code" href="memline_8c.html#a19b014ee9a087900435acfa5166c2bea">BLOCK0_ID1</a></div><div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;        &amp;&amp; b0p-&gt;<a class="code" href="structblock0.html#acaaa2249e372c7710c595b07cd3288ec">b0_id</a>[1] != <a class="code" href="memline_8c.html#aca48449cf4d92cab475956ba7760efaa">BLOCK0_ID1_C0</a></div><div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;        &amp;&amp; b0p-&gt;<a class="code" href="structblock0.html#acaaa2249e372c7710c595b07cd3288ec">b0_id</a>[1] != <a class="code" href="memline_8c.html#a8dcf918c830f292339754bb9db126932">BLOCK0_ID1_C1</a></div><div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;        &amp;&amp; b0p-&gt;<a class="code" href="structblock0.html#acaaa2249e372c7710c595b07cd3288ec">b0_id</a>[1] != <a class="code" href="memline_8c.html#acc61471b08b25bb0399df73b144176c5">BLOCK0_ID1_C2</a>)</div><div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;        )</div><div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="dosinst_8h.html#abb508ea8227673f419e9fe3a86c30d8e">FAIL</a>;</div><div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="dosinst_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;</div><div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;}</div><div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;</div><div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;<span class="comment"> * Update the timestamp or the B0_SAME_DIR flag of the .swp file.</span></div><div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">void</span></div><div class="line"><a name="l00924"></a><span class="lineno"><a class="line" href="memline_8c.html#aafe17e152f79b72e5e3e52013d5ba4dd">  924</a></span>&#160;<a class="code" href="memline_8c.html#aafe17e152f79b72e5e3e52013d5ba4dd">ml_upd_block0</a>(<a class="code" href="structfile__buffer.html">buf_T</a> *buf, <a class="code" href="memline_8c.html#aeb2a08db86a3f3c959cc50de278339ed">upd_block0_T</a> what)</div><div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;{</div><div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;    <a class="code" href="structmemfile.html">memfile_T</a>   *mfp;</div><div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;    <a class="code" href="structblock__hdr.html">bhdr_T</a>  *hp;</div><div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;    <a class="code" href="structblock0.html">ZERO_BL</a> *b0p;</div><div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;</div><div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;    mfp = buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a9adb5a08b3c01be69c98360a14937227">ml_mfp</a>;</div><div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;    <span class="keywordflow">if</span> (mfp == NULL)</div><div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;    hp = <a class="code" href="memfile_8c.html#af9d5ff9ad91a2d5150a675c9c0d77e10">mf_get</a>(mfp, (<a class="code" href="structs_8h.html#a012394c4a7db63f99f6f0cdacab79527">blocknr_T</a>)0, 1);</div><div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;    <span class="keywordflow">if</span> (hp == NULL)</div><div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;    {</div><div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;<span class="preprocessor">#ifdef FEAT_CRYPT</span></div><div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;    <span class="comment">/* Possibly update the seed in the memfile before there is a block0. */</span></div><div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;    <span class="keywordflow">if</span> (what == <a class="code" href="memline_8c.html#aeb2a08db86a3f3c959cc50de278339eda657b3ee32a0fea16c976931ef3bc9e27">UB_CRYPT</a>)</div><div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;        <a class="code" href="memline_8c.html#a72b0c5228c2ef9c96288ce4397f1b7a3">ml_set_mfp_crypt</a>(buf);</div><div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;    }</div><div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;</div><div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;    b0p = (<a class="code" href="structblock0.html">ZERO_BL</a> *)(hp-&gt;<a class="code" href="structblock__hdr.html#a7247cdc0977ab6fdc9cb6238cda67587">bh_data</a>);</div><div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="memline_8c.html#a7c54be0e5b07e1fe53155d1174a746e8">ml_check_b0_id</a>(b0p) == <a class="code" href="dosinst_8h.html#abb508ea8227673f419e9fe3a86c30d8e">FAIL</a>)</div><div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;    <a class="code" href="message_8c.html#a7926d7fa9a35dc0f5bac051dec01240a">iemsg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;E304: ml_upd_block0(): Didn&#39;t get block 0??&quot;</span>));</div><div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;    {</div><div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;    <span class="keywordflow">if</span> (what == <a class="code" href="memline_8c.html#aeb2a08db86a3f3c959cc50de278339edae07039e8880c427cedb331eac7444095">UB_FNAME</a>)</div><div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;        <a class="code" href="memline_8c.html#af8faa362a3c30969254dac9539895774">set_b0_fname</a>(b0p, buf);</div><div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;<span class="preprocessor">#ifdef FEAT_CRYPT</span></div><div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (what == <a class="code" href="memline_8c.html#aeb2a08db86a3f3c959cc50de278339eda657b3ee32a0fea16c976931ef3bc9e27">UB_CRYPT</a>)</div><div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;        <a class="code" href="memline_8c.html#af1fa068c71604df99341775f25824fdd">ml_set_b0_crypt</a>(buf, b0p);</div><div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;    <span class="keywordflow">else</span> <span class="comment">/* what == UB_SAME_DIR */</span></div><div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;        <a class="code" href="memline_8c.html#ad89ac1988c4af53392f905876e770508">set_b0_dir_flag</a>(b0p, buf);</div><div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;    }</div><div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;    <a class="code" href="memfile_8c.html#abb7f268382703d32becc96f6d92fb855">mf_put</a>(mfp, hp, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;}</div><div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;</div><div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;<span class="comment"> * Write file name and timestamp into block 0 of a swap file.</span></div><div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;<span class="comment"> * Also set buf-&gt;b_mtime.</span></div><div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;<span class="comment"> * Don&#39;t use NameBuff[]!!!</span></div><div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">void</span></div><div class="line"><a name="l00967"></a><span class="lineno"><a class="line" href="memline_8c.html#af8faa362a3c30969254dac9539895774">  967</a></span>&#160;<a class="code" href="memline_8c.html#af8faa362a3c30969254dac9539895774">set_b0_fname</a>(<a class="code" href="structblock0.html">ZERO_BL</a> *b0p, <a class="code" href="structfile__buffer.html">buf_T</a> *buf)</div><div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;{</div><div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;    <a class="code" href="vim_8h.html#a3206c537c639e0f26013f6cf909bd0e0">stat_T</a>  st;</div><div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;</div><div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;    <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structfile__buffer.html#a26a473c691883e01ce4f747558b97a4d">b_ffname</a> == NULL)</div><div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;    b0p-&gt;<a class="code" href="structblock0.html#a619635d3effa9f2496dd6662e20b9037">b0_fname</a>[0] = <a class="code" href="ascii_8h.html#af19d48b9f61047a668649a2f9dc317ff">NUL</a>;</div><div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;    {</div><div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;<span class="preprocessor">#if defined(MSWIN) || defined(AMIGA)</span></div><div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;    <span class="comment">/* Systems that cannot translate &quot;~user&quot; back into a path: copy the</span></div><div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;<span class="comment">     * file name unmodified.  Do use slashes instead of backslashes for</span></div><div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;<span class="comment">     * portability. */</span></div><div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;    <a class="code" href="misc2_8c.html#ab25a3a48241497fdc7bec2c3dbe41467">vim_strncpy</a>(b0p-&gt;<a class="code" href="structblock0.html#a619635d3effa9f2496dd6662e20b9037">b0_fname</a>, buf-&gt;<a class="code" href="structfile__buffer.html#a26a473c691883e01ce4f747558b97a4d">b_ffname</a>, <a class="code" href="memline_8c.html#a4ecf812828065a7ac0dccbe3e4661de9">B0_FNAME_SIZE_CRYPT</a> - 1);</div><div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;<span class="preprocessor"># ifdef BACKSLASH_IN_FILENAME</span></div><div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;    forward_slash(b0p-&gt;<a class="code" href="structblock0.html#a619635d3effa9f2496dd6662e20b9037">b0_fname</a>);</div><div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;<span class="preprocessor"># endif</span></div><div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;    <span class="keywordtype">size_t</span>  flen, ulen;</div><div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;    char_u  uname[<a class="code" href="memline_8c.html#a67d0b82009004217400bc8708acf4c06">B0_UNAME_SIZE</a>];</div><div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;</div><div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;<span class="comment">     * For a file under the home directory of the current user, we try to</span></div><div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;<span class="comment">     * replace the home directory path with &quot;~user&quot;. This helps when</span></div><div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;<span class="comment">     * editing the same file on different machines over a network.</span></div><div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;<span class="comment">     * First replace home dir path with &quot;~/&quot; with home_replace().</span></div><div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;<span class="comment">     * Then insert the user name to get &quot;~user/&quot;.</span></div><div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;    <a class="code" href="filepath_8c.html#ab7f12f206c15cee62718c8ca7fa40695">home_replace</a>(NULL, buf-&gt;<a class="code" href="structfile__buffer.html#a26a473c691883e01ce4f747558b97a4d">b_ffname</a>, b0p-&gt;<a class="code" href="structblock0.html#a619635d3effa9f2496dd6662e20b9037">b0_fname</a>,</div><div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;                           <a class="code" href="memline_8c.html#a4ecf812828065a7ac0dccbe3e4661de9">B0_FNAME_SIZE_CRYPT</a>, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div><div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;    <span class="keywordflow">if</span> (b0p-&gt;<a class="code" href="structblock0.html#a619635d3effa9f2496dd6662e20b9037">b0_fname</a>[0] == <span class="charliteral">&#39;~&#39;</span>)</div><div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;    {</div><div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;        flen = <a class="code" href="vim_8h.html#a916ffefe1fc74532d08102cca55d8e34">STRLEN</a>(b0p-&gt;<a class="code" href="structblock0.html#a619635d3effa9f2496dd6662e20b9037">b0_fname</a>);</div><div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;        <span class="comment">/* If there is no user name or it is too long, don&#39;t use &quot;~/&quot; */</span></div><div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="misc2_8c.html#abf709bd8a8505e69b7eb371517bcfebc">get_user_name</a>(uname, <a class="code" href="memline_8c.html#a67d0b82009004217400bc8708acf4c06">B0_UNAME_SIZE</a>) == <a class="code" href="dosinst_8h.html#abb508ea8227673f419e9fe3a86c30d8e">FAIL</a></div><div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;           || (ulen = <a class="code" href="vim_8h.html#a916ffefe1fc74532d08102cca55d8e34">STRLEN</a>(uname)) + flen &gt; <a class="code" href="memline_8c.html#a4ecf812828065a7ac0dccbe3e4661de9">B0_FNAME_SIZE_CRYPT</a> - 1)</div><div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;        <a class="code" href="misc2_8c.html#ab25a3a48241497fdc7bec2c3dbe41467">vim_strncpy</a>(b0p-&gt;<a class="code" href="structblock0.html#a619635d3effa9f2496dd6662e20b9037">b0_fname</a>, buf-&gt;<a class="code" href="structfile__buffer.html#a26a473c691883e01ce4f747558b97a4d">b_ffname</a>,</div><div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;                             <a class="code" href="memline_8c.html#a4ecf812828065a7ac0dccbe3e4661de9">B0_FNAME_SIZE_CRYPT</a> - 1);</div><div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;        {</div><div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;        <a class="code" href="os__unix_8h.html#ae70108db942e4f3eeb701ad8787b1835">mch_memmove</a>(b0p-&gt;<a class="code" href="structblock0.html#a619635d3effa9f2496dd6662e20b9037">b0_fname</a> + ulen + 1, b0p-&gt;<a class="code" href="structblock0.html#a619635d3effa9f2496dd6662e20b9037">b0_fname</a> + 1, flen);</div><div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;        <a class="code" href="os__unix_8h.html#ae70108db942e4f3eeb701ad8787b1835">mch_memmove</a>(b0p-&gt;<a class="code" href="structblock0.html#a619635d3effa9f2496dd6662e20b9037">b0_fname</a> + 1, uname, ulen);</div><div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;        }</div><div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;    }</div><div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="macros_8h.html#af9221f9667cc05a05b4646b2aa31e233">mch_stat</a>((<span class="keywordtype">char</span> *)buf-&gt;<a class="code" href="structfile__buffer.html#a26a473c691883e01ce4f747558b97a4d">b_ffname</a>, &amp;st) &gt;= 0)</div><div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;    {</div><div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;        <a class="code" href="memline_8c.html#a231a2b743bdebbc1d61725a392830eff">long_to_char</a>((<span class="keywordtype">long</span>)st.st_mtime, b0p-&gt;<a class="code" href="structblock0.html#a9055bedd111a57a03cc1987905bb4ae0">b0_mtime</a>);</div><div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;<span class="preprocessor">#ifdef CHECK_INODE</span></div><div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;        <a class="code" href="memline_8c.html#a231a2b743bdebbc1d61725a392830eff">long_to_char</a>((<span class="keywordtype">long</span>)st.st_ino, b0p-&gt;<a class="code" href="structblock0.html#a3930b3adc922aba997caf28ad8d8e6a4">b0_ino</a>);</div><div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;        <a class="code" href="fileio_8c.html#a58a723d9fd552879f78c062190df4d1b">buf_store_time</a>(buf, &amp;st, buf-&gt;<a class="code" href="structfile__buffer.html#a26a473c691883e01ce4f747558b97a4d">b_ffname</a>);</div><div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;        buf-&gt;<a class="code" href="structfile__buffer.html#acbc008d53044334116941e49fe076450">b_mtime_read</a> = buf-&gt;<a class="code" href="structfile__buffer.html#aff82f135569f4a0edd666fe08d0ca970">b_mtime</a>;</div><div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;    }</div><div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;    {</div><div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;        <a class="code" href="memline_8c.html#a231a2b743bdebbc1d61725a392830eff">long_to_char</a>(0L, b0p-&gt;<a class="code" href="structblock0.html#a9055bedd111a57a03cc1987905bb4ae0">b0_mtime</a>);</div><div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;<span class="preprocessor">#ifdef CHECK_INODE</span></div><div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;        <a class="code" href="memline_8c.html#a231a2b743bdebbc1d61725a392830eff">long_to_char</a>(0L, b0p-&gt;<a class="code" href="structblock0.html#a3930b3adc922aba997caf28ad8d8e6a4">b0_ino</a>);</div><div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;        buf-&gt;<a class="code" href="structfile__buffer.html#aff82f135569f4a0edd666fe08d0ca970">b_mtime</a> = 0;</div><div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;        buf-&gt;<a class="code" href="structfile__buffer.html#acbc008d53044334116941e49fe076450">b_mtime_read</a> = 0;</div><div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;        buf-&gt;<a class="code" href="structfile__buffer.html#a6102c96ffb9b9df10456769e74f91e2a">b_orig_size</a> = 0;</div><div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;        buf-&gt;<a class="code" href="structfile__buffer.html#a44e966d8856ead5eae8184fc9fabceeb">b_orig_mode</a> = 0;</div><div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;    }</div><div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;    }</div><div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;</div><div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;    <span class="comment">/* Also add the &#39;fileencoding&#39; if there is room. */</span></div><div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;    <a class="code" href="memline_8c.html#a623f9a9406aa91cbaca6461d1ccc6804">add_b0_fenc</a>(b0p, curbuf);</div><div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;}</div><div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;</div><div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;<span class="comment"> * Update the B0_SAME_DIR flag of the swap file.  It&#39;s set if the file and the</span></div><div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;<span class="comment"> * swapfile for &quot;buf&quot; are in the same directory.</span></div><div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;<span class="comment"> * This is fail safe: if we are not sure the directories are equal the flag is</span></div><div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;<span class="comment"> * not set.</span></div><div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">void</span></div><div class="line"><a name="l01044"></a><span class="lineno"><a class="line" href="memline_8c.html#ad89ac1988c4af53392f905876e770508"> 1044</a></span>&#160;<a class="code" href="memline_8c.html#ad89ac1988c4af53392f905876e770508">set_b0_dir_flag</a>(<a class="code" href="structblock0.html">ZERO_BL</a> *b0p, <a class="code" href="structfile__buffer.html">buf_T</a> *buf)</div><div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;{</div><div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="misc2_8c.html#a7bbb60cf940e6fbc12e0ecd4e124c5c0">same_directory</a>(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a9adb5a08b3c01be69c98360a14937227">ml_mfp</a>-&gt;<a class="code" href="structmemfile.html#acf87c004bb17883fecc56966daa0a7f3">mf_fname</a>, buf-&gt;<a class="code" href="structfile__buffer.html#a26a473c691883e01ce4f747558b97a4d">b_ffname</a>))</div><div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;    b0p-&gt;b0_flags |= <a class="code" href="memline_8c.html#a47709ebb68758a4b1db1a5205761c146">B0_SAME_DIR</a>;</div><div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;    b0p-&gt;b0_flags &amp;= ~<a class="code" href="memline_8c.html#a47709ebb68758a4b1db1a5205761c146">B0_SAME_DIR</a>;</div><div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;}</div><div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;</div><div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;<span class="comment"> * When there is room, add the &#39;fileencoding&#39; to block zero.</span></div><div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">void</span></div><div class="line"><a name="l01056"></a><span class="lineno"><a class="line" href="memline_8c.html#a623f9a9406aa91cbaca6461d1ccc6804"> 1056</a></span>&#160;<a class="code" href="memline_8c.html#a623f9a9406aa91cbaca6461d1ccc6804">add_b0_fenc</a>(</div><div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;    <a class="code" href="structblock0.html">ZERO_BL</a> *b0p,</div><div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;    <a class="code" href="structfile__buffer.html">buf_T</a>   *buf)</div><div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;{</div><div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;    <span class="keywordtype">int</span>     n;</div><div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;    <span class="keywordtype">int</span>     <a class="code" href="gui__mac_8c.html#af0e67ea85e8470c85b7e79fd86b606cd">size</a> = <a class="code" href="memline_8c.html#a4e1fcc872c5dc5b8ec1d1bf7ac298bbe">B0_FNAME_SIZE_NOCRYPT</a>;</div><div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;</div><div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;<span class="preprocessor">#ifdef FEAT_CRYPT</span></div><div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;    <span class="comment">/* Without encryption use the same offset as in Vim 7.2 to be compatible.</span></div><div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;<span class="comment">     * With encryption it&#39;s OK to move elsewhere, the swap file is not</span></div><div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;<span class="comment">     * compatible anyway. */</span></div><div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;    <span class="keywordflow">if</span> (*buf-&gt;b_p_key != <a class="code" href="ascii_8h.html#af19d48b9f61047a668649a2f9dc317ff">NUL</a>)</div><div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;    size = <a class="code" href="memline_8c.html#a4ecf812828065a7ac0dccbe3e4661de9">B0_FNAME_SIZE_CRYPT</a>;</div><div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;</div><div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;    n = (int)<a class="code" href="vim_8h.html#a916ffefe1fc74532d08102cca55d8e34">STRLEN</a>(buf-&gt;<a class="code" href="structfile__buffer.html#af662d458d0ba84aaa073aab5d8354982">b_p_fenc</a>);</div><div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;    <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)<a class="code" href="vim_8h.html#a916ffefe1fc74532d08102cca55d8e34">STRLEN</a>(b0p-&gt;<a class="code" href="structblock0.html#a619635d3effa9f2496dd6662e20b9037">b0_fname</a>) + n + 1 &gt; <a class="code" href="gui__mac_8c.html#af0e67ea85e8470c85b7e79fd86b606cd">size</a>)</div><div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;    b0p-&gt;b0_flags &amp;= ~<a class="code" href="memline_8c.html#a7ad45b164548ce5af4a97bbc5c249410">B0_HAS_FENC</a>;</div><div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;    {</div><div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;    <a class="code" href="os__unix_8h.html#ae70108db942e4f3eeb701ad8787b1835">mch_memmove</a>((<span class="keywordtype">char</span> *)b0p-&gt;<a class="code" href="structblock0.html#a619635d3effa9f2496dd6662e20b9037">b0_fname</a> + size - n,</div><div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;                        (<span class="keywordtype">char</span> *)buf-&gt;<a class="code" href="structfile__buffer.html#af662d458d0ba84aaa073aab5d8354982">b_p_fenc</a>, (<span class="keywordtype">size_t</span>)n);</div><div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;    *(b0p-&gt;<a class="code" href="structblock0.html#a619635d3effa9f2496dd6662e20b9037">b0_fname</a> + size - n - 1) = <a class="code" href="ascii_8h.html#af19d48b9f61047a668649a2f9dc317ff">NUL</a>;</div><div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;    b0p-&gt;b0_flags |= <a class="code" href="memline_8c.html#a7ad45b164548ce5af4a97bbc5c249410">B0_HAS_FENC</a>;</div><div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;    }</div><div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;}</div><div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;</div><div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;</div><div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;<span class="comment"> * Try to recover curbuf from the .swp file.</span></div><div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;<span class="comment"> * If &quot;checkext&quot; is TRUE, check the extension and detect whether it is</span></div><div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;<span class="comment"> * a swap file.</span></div><div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;    <span class="keywordtype">void</span></div><div class="line"><a name="l01090"></a><span class="lineno"><a class="line" href="memline_8c.html#a94941a018b7ab9e5eebc4f80e957efdb"> 1090</a></span>&#160;<a class="code" href="memline_8c.html#a94941a018b7ab9e5eebc4f80e957efdb">ml_recover</a>(<span class="keywordtype">int</span> checkext)</div><div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;{</div><div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;    <a class="code" href="structfile__buffer.html">buf_T</a>   *buf = NULL;</div><div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;    <a class="code" href="structmemfile.html">memfile_T</a>   *mfp = NULL;</div><div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;    char_u  *fname;</div><div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;    char_u  *fname_used = NULL;</div><div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;    <a class="code" href="structblock__hdr.html">bhdr_T</a>  *hp = NULL;</div><div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;    <a class="code" href="structblock0.html">ZERO_BL</a> *b0p;</div><div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;    <span class="keywordtype">int</span>     b0_ff;</div><div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;    char_u  *b0_fenc = NULL;</div><div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;<span class="preprocessor">#ifdef FEAT_CRYPT</span></div><div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;    <span class="keywordtype">int</span>     b0_cm = -1;</div><div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;    <a class="code" href="structpointer__block.html">PTR_BL</a>  *pp;</div><div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;    <a class="code" href="structdata__block.html">DATA_BL</a> *dp;</div><div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;    <a class="code" href="structinfo__pointer.html">infoptr_T</a>   *<a class="code" href="namespacetest__channel.html#a6a2152bf75d93cd14fcffc99c3e76807">ip</a>;</div><div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;    <a class="code" href="structs_8h.html#a012394c4a7db63f99f6f0cdacab79527">blocknr_T</a>   bnum;</div><div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;    <span class="keywordtype">int</span>     <a class="code" href="hardcopy_8c.html#a8779304c095e1ed27c30d4b5b3f2437a">page_count</a>;</div><div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;    <a class="code" href="vim_8h.html#a3206c537c639e0f26013f6cf909bd0e0">stat_T</a>  org_stat, swp_stat;</div><div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;    <span class="keywordtype">int</span>     len;</div><div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;    <span class="keywordtype">int</span>     directly;</div><div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;    <a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>    lnum;</div><div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;    char_u  *p;</div><div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;    <span class="keywordtype">int</span>     i;</div><div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;    <span class="keywordtype">long</span>    error;</div><div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;    <span class="keywordtype">int</span>     cannot_open;</div><div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;    <a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>    line_count;</div><div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;    <span class="keywordtype">int</span>     has_error;</div><div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;    <span class="keywordtype">int</span>     idx;</div><div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;    <span class="keywordtype">int</span>     top;</div><div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;    <span class="keywordtype">int</span>     txt_start;</div><div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;    <a class="code" href="vim_8h.html#ac86c7b16baf3bc83bef23b7e5e103ca9">off_T</a>   <a class="code" href="gui__mac_8c.html#af0e67ea85e8470c85b7e79fd86b606cd">size</a>;</div><div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;    <span class="keywordtype">int</span>     called_from_main;</div><div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;    <span class="keywordtype">int</span>     serious_error = <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;    <span class="keywordtype">long</span>    mtime;</div><div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;    <span class="keywordtype">int</span>     attr;</div><div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;    <span class="keywordtype">int</span>     orig_file_status = <a class="code" href="vim_8h.html#a6af93ccdb5accc84d8a7f92255b90367">NOTDONE</a>;</div><div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;</div><div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;    recoverymode = <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;    called_from_main = (curbuf-&gt;b_ml.ml_mfp == NULL);</div><div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;    attr = <a class="code" href="vim_8h.html#a6997207b131d14a30429a3c80cd3db59">HL_ATTR</a>(<a class="code" href="vim_8h.html#af67ce53b835b6cd1005e9a7a0ffcfc60af020795535ec4b31fb1605eb8f457bbd">HLF_E</a>);</div><div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;</div><div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;<span class="comment">     * If the file name ends in &quot;.s[a-w][a-z]&quot; we assume this is the swap file.</span></div><div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;<span class="comment">     * Otherwise a search is done to find the swap file(s).</span></div><div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;    fname = curbuf-&gt;b_fname;</div><div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;    <span class="keywordflow">if</span> (fname == NULL)          <span class="comment">/* When there is no file name */</span></div><div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;    fname = (char_u *)<span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;    len = (int)<a class="code" href="vim_8h.html#a916ffefe1fc74532d08102cca55d8e34">STRLEN</a>(fname);</div><div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;    <span class="keywordflow">if</span> (checkext &amp;&amp; len &gt;= 4 &amp;&amp;</div><div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;#<span class="keywordflow">if</span> defined(VMS)</div><div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;        <a class="code" href="vim_8h.html#a30a049fe4d0d13f9c4c5296b8b0ecc34">STRNICMP</a>(fname + len - 4, <span class="stringliteral">&quot;_s&quot;</span>, 2)</div><div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;        <a class="code" href="vim_8h.html#a30a049fe4d0d13f9c4c5296b8b0ecc34">STRNICMP</a>(fname + len - 4, <span class="stringliteral">&quot;.s&quot;</span>, 2)</div><div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;                        == 0</div><div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;        &amp;&amp; <a class="code" href="misc2_8c.html#a8978cebac3b4ced66551e67c3a375842">vim_strchr</a>((char_u *)<span class="stringliteral">&quot;abcdefghijklmnopqrstuvw&quot;</span>,</div><div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;                       <a class="code" href="macros_8h.html#abedb28fafef6553a68ede9057216bfaa">TOLOWER_ASC</a>(fname[len - 2])) != NULL</div><div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;        &amp;&amp; <a class="code" href="macros_8h.html#a91d2733ae4d7b126d9d545ff5315b50e">ASCII_ISALPHA</a>(fname[len - 1]))</div><div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;    {</div><div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;    directly = <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;    fname_used = <a class="code" href="misc2_8c.html#acd554ee46804f666060916bf740b3c96">vim_strsave</a>(fname); <span class="comment">/* make a copy for mf_open() */</span></div><div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;    }</div><div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;    {</div><div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;    directly = <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;</div><div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;    <span class="comment">/* count the number of matching swap files */</span></div><div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;    len = <a class="code" href="memline_8c.html#aba940da76a214a22a875eab61ec804e9">recover_names</a>(fname, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, 0, NULL);</div><div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;    <span class="keywordflow">if</span> (len == 0)           <span class="comment">/* no swap files found */</span></div><div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;    {</div><div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;        <a class="code" href="message_8c.html#aeb2442b830699494f53059773212d850">semsg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;E305: No swap file found for %s&quot;</span>), fname);</div><div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;        <span class="keywordflow">goto</span> theend;</div><div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;    }</div><div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;    <span class="keywordflow">if</span> (len == 1)           <span class="comment">/* one swap file found, use it */</span></div><div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;        i = 1;</div><div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;    <span class="keywordflow">else</span>                <span class="comment">/* several swap files found, choose */</span></div><div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;    {</div><div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;        <span class="comment">/* list the names of the swap files */</span></div><div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;        (void)<a class="code" href="memline_8c.html#aba940da76a214a22a875eab61ec804e9">recover_names</a>(fname, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, 0, NULL);</div><div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;        <a class="code" href="message_8c.html#ae0edfa8d1999c41726a759fd06a1ab6e">msg_putchar</a>(<span class="charliteral">&#39;\n&#39;</span>);</div><div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;        <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;Enter number of swap file to use (0 to quit): &quot;</span>));</div><div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;        i = <a class="code" href="misc1_8c.html#aa43159dfdc77eb5fdba574297156b0f4">get_number</a>(<a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, NULL);</div><div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;        <span class="keywordflow">if</span> (i &lt; 1 || i &gt; len)</div><div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;        <span class="keywordflow">goto</span> theend;</div><div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;    }</div><div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;    <span class="comment">/* get the swap file name that will be used */</span></div><div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;    (void)<a class="code" href="memline_8c.html#aba940da76a214a22a875eab61ec804e9">recover_names</a>(fname, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, i, &amp;fname_used);</div><div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;    }</div><div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;    <span class="keywordflow">if</span> (fname_used == NULL)</div><div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;    <span class="keywordflow">goto</span> theend;            <span class="comment">/* out of memory */</span></div><div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;</div><div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;    <span class="comment">/* When called from main() still need to initialize storage structure */</span></div><div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;    <span class="keywordflow">if</span> (called_from_main &amp;&amp; <a class="code" href="memline_8c.html#adcf872c959d4e670fd729383dec62a81">ml_open</a>(curbuf) == <a class="code" href="dosinst_8h.html#abb508ea8227673f419e9fe3a86c30d8e">FAIL</a>)</div><div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;    <a class="code" href="main_8c.html#ac1f9aa0153be96581e7f01eddf1c32e0">getout</a>(1);</div><div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;</div><div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;<span class="comment">     * Allocate a buffer structure for the swap file that is used for recovery.</span></div><div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;<span class="comment">     * Only the memline and crypt information in it are really used.</span></div><div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;    buf = <a class="code" href="vim_8h.html#aa7847d468c459f481f1bfc3b82526b20">ALLOC_ONE</a>(<a class="code" href="structfile__buffer.html">buf_T</a>);</div><div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;    <span class="keywordflow">if</span> (buf == NULL)</div><div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;    <span class="keywordflow">goto</span> theend;</div><div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;</div><div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;<span class="comment">     * init fields in memline struct</span></div><div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#add4fba4ecd680fbf53ab842c85ccde21">ml_stack_size</a> = 0;    <span class="comment">/* no stack yet */</span></div><div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a77e2179043ee3367af09fe186b2fa5a8">ml_stack</a> = NULL;      <span class="comment">/* no stack yet */</span></div><div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a17d957b4b662bf327749e1523ac4f5b5">ml_stack_top</a> = 0;     <span class="comment">/* nothing in the stack */</span></div><div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a62222eb79ef59eddaff71f0f8cdff764">ml_line_lnum</a> = 0;     <span class="comment">/* no cached line */</span></div><div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#aa4c2830f305306d4f5f163b4522d0ba6">ml_locked</a> = NULL;     <span class="comment">/* no locked block */</span></div><div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a30f30ddb7264f667a92556f0568981e0">ml_flags</a> = 0;</div><div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;<span class="preprocessor">#ifdef FEAT_CRYPT</span></div><div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;    buf-&gt;b_p_key = empty_option;</div><div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;    buf-&gt;b_p_cm = empty_option;</div><div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;</div><div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;<span class="comment">     * open the memfile from the old swap file</span></div><div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;    p = <a class="code" href="misc2_8c.html#acd554ee46804f666060916bf740b3c96">vim_strsave</a>(fname_used); <span class="comment">/* save &quot;fname_used&quot; for the message:</span></div><div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;<span class="comment">                    mf_open() will consume &quot;fname_used&quot;! */</span></div><div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;    mfp = <a class="code" href="memfile_8c.html#a6e68cf5ad6fb3085488b37df8dc37058">mf_open</a>(fname_used, O_RDONLY);</div><div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;    fname_used = p;</div><div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;    <span class="keywordflow">if</span> (mfp == NULL || mfp-&gt;<a class="code" href="structmemfile.html#a70c16d084045ec45dbe251430e7a81a5">mf_fd</a> &lt; 0)</div><div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;    {</div><div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;    <span class="keywordflow">if</span> (fname_used != NULL)</div><div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;        <a class="code" href="message_8c.html#aeb2442b830699494f53059773212d850">semsg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;E306: Cannot open %s&quot;</span>), fname_used);</div><div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;    <span class="keywordflow">goto</span> theend;</div><div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;    }</div><div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a9adb5a08b3c01be69c98360a14937227">ml_mfp</a> = mfp;</div><div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;<span class="preprocessor">#ifdef FEAT_CRYPT</span></div><div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;    mfp-&gt;mf_buffer = buf;</div><div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;</div><div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;<span class="comment">     * The page size set in mf_open() might be different from the page size</span></div><div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;<span class="comment">     * used in the swap file, we must get it from block 0.  But to read block</span></div><div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;<span class="comment">     * 0 we need a page size.  Use the minimal size for block 0 here, it will</span></div><div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;<span class="comment">     * be set to the real value below.</span></div><div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;    mfp-&gt;<a class="code" href="structmemfile.html#ab0c66141886a009d8132b8e1e2a00fc6">mf_page_size</a> = <a class="code" href="vim_8h.html#a09d598baef43cbaa4d3c3221e7c26b32">MIN_SWAP_PAGE_SIZE</a>;</div><div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;</div><div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;<span class="comment">     * try to read block 0</span></div><div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;    <span class="keywordflow">if</span> ((hp = <a class="code" href="memfile_8c.html#af9d5ff9ad91a2d5150a675c9c0d77e10">mf_get</a>(mfp, (<a class="code" href="structs_8h.html#a012394c4a7db63f99f6f0cdacab79527">blocknr_T</a>)0, 1)) == NULL)</div><div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;    {</div><div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;    <a class="code" href="message_8c.html#a701ffeff793261a605a4090e7c085a2d">msg_start</a>();</div><div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;    <a class="code" href="message_8c.html#a0285a0bbcc662afa0db1573dfdde64f1">msg_puts_attr</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;Unable to read block 0 from &quot;</span>), attr | <a class="code" href="vim_8h.html#a1a8d0c2b62673b8dc085a5de49d19bd5">MSG_HIST</a>);</div><div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;    <a class="code" href="message_8c.html#afe8652ccadf4b8716f60ad84d9fb7ea2">msg_outtrans_attr</a>(mfp-&gt;<a class="code" href="structmemfile.html#acf87c004bb17883fecc56966daa0a7f3">mf_fname</a>, attr | <a class="code" href="vim_8h.html#a1a8d0c2b62673b8dc085a5de49d19bd5">MSG_HIST</a>);</div><div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;    <a class="code" href="message_8c.html#a0285a0bbcc662afa0db1573dfdde64f1">msg_puts_attr</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;\nMaybe no changes were made or Vim did not update the swap file.&quot;</span>),</div><div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;        attr | <a class="code" href="vim_8h.html#a1a8d0c2b62673b8dc085a5de49d19bd5">MSG_HIST</a>);</div><div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;    <a class="code" href="message_8c.html#ab18e462ca688b9c33d6207095681d288">msg_end</a>();</div><div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;    <span class="keywordflow">goto</span> theend;</div><div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;    }</div><div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;    b0p = (<a class="code" href="structblock0.html">ZERO_BL</a> *)(hp-&gt;<a class="code" href="structblock__hdr.html#a7247cdc0977ab6fdc9cb6238cda67587">bh_data</a>);</div><div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="vim_8h.html#a5f1ef744c34be69aec1531f1fe604a9b">STRNCMP</a>(b0p-&gt;<a class="code" href="structblock0.html#a5f6ec025350776e0dbe8d0ab54daadc3">b0_version</a>, <span class="stringliteral">&quot;VIM 3.0&quot;</span>, 7) == 0)</div><div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;    {</div><div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;    <a class="code" href="message_8c.html#a701ffeff793261a605a4090e7c085a2d">msg_start</a>();</div><div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;    <a class="code" href="message_8c.html#afe8652ccadf4b8716f60ad84d9fb7ea2">msg_outtrans_attr</a>(mfp-&gt;<a class="code" href="structmemfile.html#acf87c004bb17883fecc56966daa0a7f3">mf_fname</a>, <a class="code" href="vim_8h.html#a1a8d0c2b62673b8dc085a5de49d19bd5">MSG_HIST</a>);</div><div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;    <a class="code" href="message_8c.html#a0285a0bbcc662afa0db1573dfdde64f1">msg_puts_attr</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot; cannot be used with this version of Vim.\n&quot;</span>),</div><div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;                                    <a class="code" href="vim_8h.html#a1a8d0c2b62673b8dc085a5de49d19bd5">MSG_HIST</a>);</div><div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;    <a class="code" href="message_8c.html#a0285a0bbcc662afa0db1573dfdde64f1">msg_puts_attr</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;Use Vim version 3.0.\n&quot;</span>), <a class="code" href="vim_8h.html#a1a8d0c2b62673b8dc085a5de49d19bd5">MSG_HIST</a>);</div><div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;    <a class="code" href="message_8c.html#ab18e462ca688b9c33d6207095681d288">msg_end</a>();</div><div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;    <span class="keywordflow">goto</span> theend;</div><div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;    }</div><div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="memline_8c.html#a7c54be0e5b07e1fe53155d1174a746e8">ml_check_b0_id</a>(b0p) == <a class="code" href="dosinst_8h.html#abb508ea8227673f419e9fe3a86c30d8e">FAIL</a>)</div><div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;    {</div><div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;    <a class="code" href="message_8c.html#aeb2442b830699494f53059773212d850">semsg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;E307: %s does not look like a Vim swap file&quot;</span>), mfp-&gt;<a class="code" href="structmemfile.html#acf87c004bb17883fecc56966daa0a7f3">mf_fname</a>);</div><div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;    <span class="keywordflow">goto</span> theend;</div><div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;    }</div><div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="memline_8c.html#a28648170c5d102a305afeeecf23cc0ca">b0_magic_wrong</a>(b0p))</div><div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;    {</div><div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;    <a class="code" href="message_8c.html#a701ffeff793261a605a4090e7c085a2d">msg_start</a>();</div><div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;    <a class="code" href="message_8c.html#afe8652ccadf4b8716f60ad84d9fb7ea2">msg_outtrans_attr</a>(mfp-&gt;<a class="code" href="structmemfile.html#acf87c004bb17883fecc56966daa0a7f3">mf_fname</a>, attr | <a class="code" href="vim_8h.html#a1a8d0c2b62673b8dc085a5de49d19bd5">MSG_HIST</a>);</div><div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;<span class="preprocessor">#if defined(MSWIN)</span></div><div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="vim_8h.html#a5f1ef744c34be69aec1531f1fe604a9b">STRNCMP</a>(b0p-&gt;<a class="code" href="structblock0.html#a8b0cab71ba5453122bcd862fe3d368ca">b0_hname</a>, <span class="stringliteral">&quot;PC &quot;</span>, 3) == 0)</div><div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;        <a class="code" href="message_8c.html#a0285a0bbcc662afa0db1573dfdde64f1">msg_puts_attr</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot; cannot be used with this version of Vim.\n&quot;</span>),</div><div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;                                 attr | <a class="code" href="vim_8h.html#a1a8d0c2b62673b8dc085a5de49d19bd5">MSG_HIST</a>);</div><div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;        <a class="code" href="message_8c.html#a0285a0bbcc662afa0db1573dfdde64f1">msg_puts_attr</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot; cannot be used on this computer.\n&quot;</span>),</div><div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;                                 attr | <a class="code" href="vim_8h.html#a1a8d0c2b62673b8dc085a5de49d19bd5">MSG_HIST</a>);</div><div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;    <a class="code" href="message_8c.html#a0285a0bbcc662afa0db1573dfdde64f1">msg_puts_attr</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;The file was created on &quot;</span>), attr | <a class="code" href="vim_8h.html#a1a8d0c2b62673b8dc085a5de49d19bd5">MSG_HIST</a>);</div><div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;    <span class="comment">/* avoid going past the end of a corrupted hostname */</span></div><div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;    b0p-&gt;<a class="code" href="structblock0.html#a619635d3effa9f2496dd6662e20b9037">b0_fname</a>[0] = <a class="code" href="ascii_8h.html#af19d48b9f61047a668649a2f9dc317ff">NUL</a>;</div><div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;    <a class="code" href="message_8c.html#a0285a0bbcc662afa0db1573dfdde64f1">msg_puts_attr</a>((<span class="keywordtype">char</span> *)b0p-&gt;<a class="code" href="structblock0.html#a8b0cab71ba5453122bcd862fe3d368ca">b0_hname</a>, attr | <a class="code" href="vim_8h.html#a1a8d0c2b62673b8dc085a5de49d19bd5">MSG_HIST</a>);</div><div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;    <a class="code" href="message_8c.html#a0285a0bbcc662afa0db1573dfdde64f1">msg_puts_attr</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;,\nor the file has been damaged.&quot;</span>), attr | <a class="code" href="vim_8h.html#a1a8d0c2b62673b8dc085a5de49d19bd5">MSG_HIST</a>);</div><div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;    <a class="code" href="message_8c.html#ab18e462ca688b9c33d6207095681d288">msg_end</a>();</div><div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;    <span class="keywordflow">goto</span> theend;</div><div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;    }</div><div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;</div><div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;<span class="preprocessor">#ifdef FEAT_CRYPT</span></div><div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;    <span class="keywordflow">for</span> (i = 0; i &lt; (int)(<span class="keyword">sizeof</span>(<a class="code" href="memline_8c.html#ac95d0fd4bafc7f2b52cd415aedcf0f05">id1_codes</a>) / <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)); ++i)</div><div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="memline_8c.html#ac95d0fd4bafc7f2b52cd415aedcf0f05">id1_codes</a>[i] == b0p-&gt;<a class="code" href="structblock0.html#acaaa2249e372c7710c595b07cd3288ec">b0_id</a>[1])</div><div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;        b0_cm = i;</div><div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;    <span class="keywordflow">if</span> (b0_cm &gt; 0)</div><div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;    <a class="code" href="os__unix_8h.html#ae70108db942e4f3eeb701ad8787b1835">mch_memmove</a>(mfp-&gt;mf_seed, &amp;b0p-&gt;b0_seed, <a class="code" href="structs_8h.html#a7cf2da642c785ee805f57988d6dd4267">MF_SEED_LEN</a>);</div><div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;    <a class="code" href="crypt_8c.html#aa2bf8415cdc130f597de3e938d0a585d">crypt_set_cm_option</a>(buf, b0_cm &lt; 0 ? 0 : b0_cm);</div><div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;    <span class="keywordflow">if</span> (b0p-&gt;<a class="code" href="structblock0.html#acaaa2249e372c7710c595b07cd3288ec">b0_id</a>[1] != <a class="code" href="memline_8c.html#a19b014ee9a087900435acfa5166c2bea">BLOCK0_ID1</a>)</div><div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;    {</div><div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;    <a class="code" href="message_8c.html#aeb2442b830699494f53059773212d850">semsg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;E833: %s is encrypted and this version of Vim does not support encryption&quot;</span>), mfp-&gt;<a class="code" href="structmemfile.html#acf87c004bb17883fecc56966daa0a7f3">mf_fname</a>);</div><div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;    <span class="keywordflow">goto</span> theend;</div><div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;    }</div><div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;</div><div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;<span class="comment">     * If we guessed the wrong page size, we have to recalculate the</span></div><div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;<span class="comment">     * highest block number in the file.</span></div><div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;    <span class="keywordflow">if</span> (mfp-&gt;<a class="code" href="structmemfile.html#ab0c66141886a009d8132b8e1e2a00fc6">mf_page_size</a> != (<span class="keywordtype">unsigned</span>)<a class="code" href="memline_8c.html#a996b07c0a0e4f04f7b205f4c3ba2a797">char_to_long</a>(b0p-&gt;<a class="code" href="structblock0.html#a5b992d5ca8d9cc3eb941debcdea6f180">b0_page_size</a>))</div><div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;    {</div><div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;    <span class="keywordtype">unsigned</span> previous_page_size = mfp-&gt;<a class="code" href="structmemfile.html#ab0c66141886a009d8132b8e1e2a00fc6">mf_page_size</a>;</div><div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;</div><div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;    <a class="code" href="memfile_8c.html#a4b30ac8793ff0a0c43cc82527eb9d3c7">mf_new_page_size</a>(mfp, (<span class="keywordtype">unsigned</span>)<a class="code" href="memline_8c.html#a996b07c0a0e4f04f7b205f4c3ba2a797">char_to_long</a>(b0p-&gt;<a class="code" href="structblock0.html#a5b992d5ca8d9cc3eb941debcdea6f180">b0_page_size</a>));</div><div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;    <span class="keywordflow">if</span> (mfp-&gt;<a class="code" href="structmemfile.html#ab0c66141886a009d8132b8e1e2a00fc6">mf_page_size</a> &lt; previous_page_size)</div><div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;    {</div><div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;        <a class="code" href="message_8c.html#a701ffeff793261a605a4090e7c085a2d">msg_start</a>();</div><div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;        <a class="code" href="message_8c.html#afe8652ccadf4b8716f60ad84d9fb7ea2">msg_outtrans_attr</a>(mfp-&gt;<a class="code" href="structmemfile.html#acf87c004bb17883fecc56966daa0a7f3">mf_fname</a>, attr | <a class="code" href="vim_8h.html#a1a8d0c2b62673b8dc085a5de49d19bd5">MSG_HIST</a>);</div><div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;        <a class="code" href="message_8c.html#a0285a0bbcc662afa0db1573dfdde64f1">msg_puts_attr</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot; has been damaged (page size is smaller than minimum value).\n&quot;</span>),</div><div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;            attr | <a class="code" href="vim_8h.html#a1a8d0c2b62673b8dc085a5de49d19bd5">MSG_HIST</a>);</div><div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;        <a class="code" href="message_8c.html#ab18e462ca688b9c33d6207095681d288">msg_end</a>();</div><div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;        <span class="keywordflow">goto</span> theend;</div><div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;    }</div><div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;    <span class="keywordflow">if</span> ((size = <a class="code" href="vim_8h.html#a8933f1a0d85c4c550c808c2333e74085">vim_lseek</a>(mfp-&gt;<a class="code" href="structmemfile.html#a70c16d084045ec45dbe251430e7a81a5">mf_fd</a>, (<a class="code" href="vim_8h.html#ac86c7b16baf3bc83bef23b7e5e103ca9">off_T</a>)0L, <a class="code" href="misc1_8c.html#ad2a2e6c114780c3071efd24f16c7f7d8">SEEK_END</a>)) &lt;= 0)</div><div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;        mfp-&gt;<a class="code" href="structmemfile.html#aa0bbdc78a43847cb756129e7fa4d2abc">mf_blocknr_max</a> = 0;        <span class="comment">/* no file or empty file */</span></div><div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;        mfp-&gt;<a class="code" href="structmemfile.html#aa0bbdc78a43847cb756129e7fa4d2abc">mf_blocknr_max</a> = (<a class="code" href="structs_8h.html#a012394c4a7db63f99f6f0cdacab79527">blocknr_T</a>)(size / mfp-&gt;<a class="code" href="structmemfile.html#ab0c66141886a009d8132b8e1e2a00fc6">mf_page_size</a>);</div><div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;    mfp-&gt;<a class="code" href="structmemfile.html#afdcf6885ed563e5559f9d31f63c0635d">mf_infile_count</a> = mfp-&gt;<a class="code" href="structmemfile.html#aa0bbdc78a43847cb756129e7fa4d2abc">mf_blocknr_max</a>;</div><div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;</div><div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;    <span class="comment">/* need to reallocate the memory used to store the data */</span></div><div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;    p = <a class="code" href="misc2_8c.html#ad0b64e14955781629a3908e328f82665">alloc</a>(mfp-&gt;<a class="code" href="structmemfile.html#ab0c66141886a009d8132b8e1e2a00fc6">mf_page_size</a>);</div><div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;    <span class="keywordflow">if</span> (p == NULL)</div><div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;        <span class="keywordflow">goto</span> theend;</div><div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;    <a class="code" href="os__unix_8h.html#ae70108db942e4f3eeb701ad8787b1835">mch_memmove</a>(p, hp-&gt;<a class="code" href="structblock__hdr.html#a7247cdc0977ab6fdc9cb6238cda67587">bh_data</a>, previous_page_size);</div><div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;    <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(hp-&gt;<a class="code" href="structblock__hdr.html#a7247cdc0977ab6fdc9cb6238cda67587">bh_data</a>);</div><div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;    hp-&gt;<a class="code" href="structblock__hdr.html#a7247cdc0977ab6fdc9cb6238cda67587">bh_data</a> = p;</div><div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;    b0p = (<a class="code" href="structblock0.html">ZERO_BL</a> *)(hp-&gt;<a class="code" href="structblock__hdr.html#a7247cdc0977ab6fdc9cb6238cda67587">bh_data</a>);</div><div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;    }</div><div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;</div><div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;<span class="comment">     * If .swp file name given directly, use name from swap file for buffer.</span></div><div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;    <span class="keywordflow">if</span> (directly)</div><div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;    {</div><div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;    <a class="code" href="misc1_8c.html#aa192be148db96758033a23beacbd8ffe">expand_env</a>(b0p-&gt;<a class="code" href="structblock0.html#a619635d3effa9f2496dd6662e20b9037">b0_fname</a>, <a class="code" href="globals_8h.html#a337deb9cd3b0e40e369a0618282ed5a7">NameBuff</a>, <a class="code" href="os__unix_8h.html#a9b75f9db03a33bb3d2d613923647d0cf">MAXPATHL</a>);</div><div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="buffer_8c.html#af3a6f77e636ce62957db689adc66c680">setfname</a>(curbuf, <a class="code" href="globals_8h.html#a337deb9cd3b0e40e369a0618282ed5a7">NameBuff</a>, NULL, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>) == <a class="code" href="dosinst_8h.html#abb508ea8227673f419e9fe3a86c30d8e">FAIL</a>)</div><div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;        <span class="keywordflow">goto</span> theend;</div><div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;    }</div><div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;</div><div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;    <a class="code" href="filepath_8c.html#ab7f12f206c15cee62718c8ca7fa40695">home_replace</a>(NULL, mfp-&gt;<a class="code" href="structmemfile.html#acf87c004bb17883fecc56966daa0a7f3">mf_fname</a>, <a class="code" href="globals_8h.html#a337deb9cd3b0e40e369a0618282ed5a7">NameBuff</a>, <a class="code" href="os__unix_8h.html#a9b75f9db03a33bb3d2d613923647d0cf">MAXPATHL</a>, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div><div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;    <a class="code" href="message_8c.html#a9475d91e06c3a6d7d370ef54c0589f71">smsg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;Using swap file \&quot;%s\&quot;&quot;</span>), <a class="code" href="globals_8h.html#a337deb9cd3b0e40e369a0618282ed5a7">NameBuff</a>);</div><div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;</div><div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="buffer_8c.html#ae729d3d218b6375165add7d4917b7a4f">buf_spname</a>(curbuf) != NULL)</div><div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;    <a class="code" href="misc2_8c.html#ab25a3a48241497fdc7bec2c3dbe41467">vim_strncpy</a>(<a class="code" href="globals_8h.html#a337deb9cd3b0e40e369a0618282ed5a7">NameBuff</a>, <a class="code" href="buffer_8c.html#ae729d3d218b6375165add7d4917b7a4f">buf_spname</a>(curbuf), <a class="code" href="os__unix_8h.html#a9b75f9db03a33bb3d2d613923647d0cf">MAXPATHL</a> - 1);</div><div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;    <a class="code" href="filepath_8c.html#ab7f12f206c15cee62718c8ca7fa40695">home_replace</a>(NULL, curbuf-&gt;b_ffname, <a class="code" href="globals_8h.html#a337deb9cd3b0e40e369a0618282ed5a7">NameBuff</a>, <a class="code" href="os__unix_8h.html#a9b75f9db03a33bb3d2d613923647d0cf">MAXPATHL</a>, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div><div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;    <a class="code" href="message_8c.html#a9475d91e06c3a6d7d370ef54c0589f71">smsg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;Original file \&quot;%s\&quot;&quot;</span>), <a class="code" href="globals_8h.html#a337deb9cd3b0e40e369a0618282ed5a7">NameBuff</a>);</div><div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;    <a class="code" href="message_8c.html#ae0edfa8d1999c41726a759fd06a1ab6e">msg_putchar</a>(<span class="charliteral">&#39;\n&#39;</span>);</div><div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;</div><div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;<span class="comment">     * check date of swap file and original file</span></div><div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;    mtime = <a class="code" href="memline_8c.html#a996b07c0a0e4f04f7b205f4c3ba2a797">char_to_long</a>(b0p-&gt;<a class="code" href="structblock0.html#a9055bedd111a57a03cc1987905bb4ae0">b0_mtime</a>);</div><div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;    <span class="keywordflow">if</span> (curbuf-&gt;b_ffname != NULL</div><div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;        &amp;&amp; <a class="code" href="macros_8h.html#af9221f9667cc05a05b4646b2aa31e233">mch_stat</a>((<span class="keywordtype">char</span> *)curbuf-&gt;b_ffname, &amp;org_stat) != -1</div><div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;        &amp;&amp; ((<a class="code" href="macros_8h.html#af9221f9667cc05a05b4646b2aa31e233">mch_stat</a>((<span class="keywordtype">char</span> *)mfp-&gt;<a class="code" href="structmemfile.html#acf87c004bb17883fecc56966daa0a7f3">mf_fname</a>, &amp;swp_stat) != -1</div><div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;            &amp;&amp; org_stat.st_mtime &gt; swp_stat.st_mtime)</div><div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;        || org_stat.st_mtime != mtime))</div><div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;    <a class="code" href="message_8c.html#ae5991a4d11897dfaee9bfab8e5489d82">emsg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;E308: Warning: Original file may have been changed&quot;</span>));</div><div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;    <a class="code" href="term_8c.html#a696dc856975fd30035140f53329ba0ef">out_flush</a>();</div><div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;</div><div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;    <span class="comment">/* Get the &#39;fileformat&#39; and &#39;fileencoding&#39; from block zero. */</span></div><div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;    b0_ff = (b0p-&gt;b0_flags &amp; <a class="code" href="memline_8c.html#ab299d2ddb4d4be7565b25e8a197e63bb">B0_FF_MASK</a>);</div><div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;    <span class="keywordflow">if</span> (b0p-&gt;b0_flags &amp; <a class="code" href="memline_8c.html#a7ad45b164548ce5af4a97bbc5c249410">B0_HAS_FENC</a>)</div><div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;    {</div><div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;    <span class="keywordtype">int</span> fnsize = <a class="code" href="memline_8c.html#a4e1fcc872c5dc5b8ec1d1bf7ac298bbe">B0_FNAME_SIZE_NOCRYPT</a>;</div><div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;</div><div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;<span class="preprocessor">#ifdef FEAT_CRYPT</span></div><div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;    <span class="comment">/* Use the same size as in add_b0_fenc(). */</span></div><div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;    <span class="keywordflow">if</span> (b0p-&gt;<a class="code" href="structblock0.html#acaaa2249e372c7710c595b07cd3288ec">b0_id</a>[1] != <a class="code" href="memline_8c.html#a19b014ee9a087900435acfa5166c2bea">BLOCK0_ID1</a>)</div><div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;        fnsize = <a class="code" href="memline_8c.html#a4ecf812828065a7ac0dccbe3e4661de9">B0_FNAME_SIZE_CRYPT</a>;</div><div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;    <span class="keywordflow">for</span> (p = b0p-&gt;<a class="code" href="structblock0.html#a619635d3effa9f2496dd6662e20b9037">b0_fname</a> + fnsize; p &gt; b0p-&gt;<a class="code" href="structblock0.html#a619635d3effa9f2496dd6662e20b9037">b0_fname</a> &amp;&amp; p[-1] != <a class="code" href="ascii_8h.html#af19d48b9f61047a668649a2f9dc317ff">NUL</a>; --p)</div><div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;        ;</div><div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;    b0_fenc = <a class="code" href="misc2_8c.html#a871ddb65e41d8bed1c38754d59737a5b">vim_strnsave</a>(p, (<span class="keywordtype">int</span>)(b0p-&gt;<a class="code" href="structblock0.html#a619635d3effa9f2496dd6662e20b9037">b0_fname</a> + fnsize - p));</div><div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;    }</div><div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;</div><div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;    <a class="code" href="memfile_8c.html#abb7f268382703d32becc96f6d92fb855">mf_put</a>(mfp, hp, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);  <span class="comment">/* release block 0 */</span></div><div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;    hp = NULL;</div><div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;</div><div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;<span class="comment">     * Now that we are sure that the file is going to be recovered, clear the</span></div><div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;<span class="comment">     * contents of the current buffer.</span></div><div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;    <span class="keywordflow">while</span> (!(curbuf-&gt;b_ml.ml_flags &amp; <a class="code" href="structs_8h.html#a67ecfd4d644d8b33ba15512b7136602a">ML_EMPTY</a>))</div><div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;    <a class="code" href="memline_8c.html#acc7926ea1ef47502c4c44de231e2dbfc">ml_delete</a>((<a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>)1, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;</div><div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;<span class="comment">     * Try reading the original file to obtain the values of &#39;fileformat&#39;,</span></div><div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;<span class="comment">     * &#39;fileencoding&#39;, etc.  Ignore errors.  The text itself is not used.</span></div><div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;<span class="comment">     * When the file is encrypted the user is asked to enter the key.</span></div><div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;    <span class="keywordflow">if</span> (curbuf-&gt;b_ffname != NULL)</div><div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;    orig_file_status = <a class="code" href="fileio_8c.html#a73e5befa6abbf600f3d3f1aaf1c2ee85">readfile</a>(curbuf-&gt;b_ffname, NULL, (<a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>)0,</div><div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;                  (<a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>)0, (<a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>)<a class="code" href="vim_8h.html#ad31a3a5ea9363a1d0fd66864cfed4f8e">MAXLNUM</a>, NULL, <a class="code" href="vim_8h.html#a4da9786c337d9d735a7428591c751035">READ_NEW</a>);</div><div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;</div><div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;<span class="preprocessor">#ifdef FEAT_CRYPT</span></div><div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;    <span class="keywordflow">if</span> (b0_cm &gt;= 0)</div><div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;    {</div><div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;    <span class="comment">/* Need to ask the user for the crypt key.  If this fails we continue</span></div><div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;<span class="comment">     * without a key, will probably get garbage text. */</span></div><div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;    <span class="keywordflow">if</span> (*curbuf-&gt;b_p_key != <a class="code" href="ascii_8h.html#af19d48b9f61047a668649a2f9dc317ff">NUL</a>)</div><div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;    {</div><div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;        <a class="code" href="message_8c.html#a9475d91e06c3a6d7d370ef54c0589f71">smsg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;Swap file is encrypted: \&quot;%s\&quot;&quot;</span>), fname_used);</div><div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;        <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;\nIf you entered a new crypt key but did not write the text file,&quot;</span>));</div><div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;        <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;\nenter the new crypt key.&quot;</span>));</div><div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;        <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;\nIf you wrote the text file after changing the crypt key press enter&quot;</span>));</div><div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;        <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;\nto use the same key for text file and swap file&quot;</span>));</div><div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;    }</div><div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;        <a class="code" href="message_8c.html#a9475d91e06c3a6d7d370ef54c0589f71">smsg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(need_key_msg), fname_used);</div><div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;    buf-&gt;b_p_key = <a class="code" href="crypt_8c.html#a46d56559b44b02d2e5746b424b3220c2">crypt_get_key</a>(<a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;    <span class="keywordflow">if</span> (buf-&gt;b_p_key == NULL)</div><div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;        buf-&gt;b_p_key = curbuf-&gt;b_p_key;</div><div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*buf-&gt;b_p_key == <a class="code" href="ascii_8h.html#af19d48b9f61047a668649a2f9dc317ff">NUL</a>)</div><div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;    {</div><div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;        <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(buf-&gt;b_p_key);</div><div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;        buf-&gt;b_p_key = curbuf-&gt;b_p_key;</div><div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;    }</div><div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;    <span class="keywordflow">if</span> (buf-&gt;b_p_key == NULL)</div><div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;        buf-&gt;b_p_key = empty_option;</div><div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;    }</div><div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;</div><div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;    <span class="comment">/* Use the &#39;fileformat&#39; and &#39;fileencoding&#39; as stored in the swap file. */</span></div><div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;    <span class="keywordflow">if</span> (b0_ff != 0)</div><div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;    <a class="code" href="misc2_8c.html#a32cb7ab620bf087189a26e93f219d5e7">set_fileformat</a>(b0_ff - 1, <a class="code" href="vim_8h.html#af0d84616173bb5946784c0a50b4b01b3">OPT_LOCAL</a>);</div><div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;    <span class="keywordflow">if</span> (b0_fenc != NULL)</div><div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;    {</div><div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;    <a class="code" href="option_8c.html#a94ae863d1c8638bea649c9a093c2be06">set_option_value</a>((char_u *)<span class="stringliteral">&quot;fenc&quot;</span>, 0L, b0_fenc, <a class="code" href="vim_8h.html#af0d84616173bb5946784c0a50b4b01b3">OPT_LOCAL</a>);</div><div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;    <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(b0_fenc);</div><div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;    }</div><div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;    <a class="code" href="change_8c.html#aab9ddb1537af1a660acc9e409537938f">unchanged</a>(curbuf, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div><div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;</div><div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;    bnum = 1;       <span class="comment">/* start with block 1 */</span></div><div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;    page_count = 1; <span class="comment">/* which is 1 page */</span></div><div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;    lnum = 0;       <span class="comment">/* append after line 0 in curbuf */</span></div><div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;    line_count = 0;</div><div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;    idx = 0;        <span class="comment">/* start with first index in block 1 */</span></div><div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;    error = 0;</div><div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a17d957b4b662bf327749e1523ac4f5b5">ml_stack_top</a> = 0;</div><div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a77e2179043ee3367af09fe186b2fa5a8">ml_stack</a> = NULL;</div><div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#add4fba4ecd680fbf53ab842c85ccde21">ml_stack_size</a> = 0;    <span class="comment">/* no stack yet */</span></div><div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;</div><div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;    <span class="keywordflow">if</span> (curbuf-&gt;b_ffname == NULL)</div><div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;    cannot_open = <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;    cannot_open = <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;</div><div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;    serious_error = <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;    <span class="keywordflow">for</span> ( ; !got_int; <a class="code" href="misc1_8c.html#a8703516dc56663f759f265915d1acc2d">line_breakcheck</a>())</div><div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;    {</div><div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;    <span class="keywordflow">if</span> (hp != NULL)</div><div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;        <a class="code" href="memfile_8c.html#abb7f268382703d32becc96f6d92fb855">mf_put</a>(mfp, hp, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);  <span class="comment">/* release previous block */</span></div><div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;</div><div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;<span class="comment">     * get block</span></div><div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;    <span class="keywordflow">if</span> ((hp = <a class="code" href="memfile_8c.html#af9d5ff9ad91a2d5150a675c9c0d77e10">mf_get</a>(mfp, (<a class="code" href="structs_8h.html#a012394c4a7db63f99f6f0cdacab79527">blocknr_T</a>)bnum, page_count)) == NULL)</div><div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;    {</div><div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;        <span class="keywordflow">if</span> (bnum == 1)</div><div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;        {</div><div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;        <a class="code" href="message_8c.html#aeb2442b830699494f53059773212d850">semsg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;E309: Unable to read block 1 from %s&quot;</span>), mfp-&gt;<a class="code" href="structmemfile.html#acf87c004bb17883fecc56966daa0a7f3">mf_fname</a>);</div><div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;        <span class="keywordflow">goto</span> theend;</div><div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;        }</div><div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;        ++error;</div><div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;        <a class="code" href="memline_8c.html#a6dd3bce99cbc1af9f7cfd6c843c5b44d">ml_append</a>(lnum++, (char_u *)<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;???MANY LINES MISSING&quot;</span>),</div><div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;                                (<a class="code" href="vim_8h.html#ae79e04a416bd6ce8ffe80e241850c0d2">colnr_T</a>)0, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div><div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;    }</div><div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;    <span class="keywordflow">else</span>        <span class="comment">/* there is a block */</span></div><div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;    {</div><div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;        pp = (<a class="code" href="structpointer__block.html">PTR_BL</a> *)(hp-&gt;<a class="code" href="structblock__hdr.html#a7247cdc0977ab6fdc9cb6238cda67587">bh_data</a>);</div><div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;        <span class="keywordflow">if</span> (pp-&gt;<a class="code" href="structpointer__block.html#ac2698ad2c9c4096299106a53ffbd667f">pb_id</a> == <a class="code" href="memline_8c.html#a23d0125357ec4465a50f841f634c9214">PTR_ID</a>)        <span class="comment">/* it is a pointer block */</span></div><div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;        {</div><div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;        <span class="comment">/* check line count when using pointer block first time */</span></div><div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;        <span class="keywordflow">if</span> (idx == 0 &amp;&amp; line_count != 0)</div><div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;        {</div><div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;            <span class="keywordflow">for</span> (i = 0; i &lt; (int)pp-&gt;<a class="code" href="structpointer__block.html#ad3682038298e7850fb980815132f17f9">pb_count</a>; ++i)</div><div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;            line_count -= pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[i].<a class="code" href="structpointer__entry.html#a652fe117ed91b4ab3d84361e8aa751de">pe_line_count</a>;</div><div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;            <span class="keywordflow">if</span> (line_count != 0)</div><div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;            {</div><div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;            ++error;</div><div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;            <a class="code" href="memline_8c.html#a6dd3bce99cbc1af9f7cfd6c843c5b44d">ml_append</a>(lnum++, (char_u *)<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;???LINE COUNT WRONG&quot;</span>),</div><div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;                                (<a class="code" href="vim_8h.html#ae79e04a416bd6ce8ffe80e241850c0d2">colnr_T</a>)0, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div><div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;            }</div><div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;        }</div><div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;</div><div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;        <span class="keywordflow">if</span> (pp-&gt;<a class="code" href="structpointer__block.html#ad3682038298e7850fb980815132f17f9">pb_count</a> == 0)</div><div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;        {</div><div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;            <a class="code" href="memline_8c.html#a6dd3bce99cbc1af9f7cfd6c843c5b44d">ml_append</a>(lnum++, (char_u *)<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;???EMPTY BLOCK&quot;</span>),</div><div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;                                (<a class="code" href="vim_8h.html#ae79e04a416bd6ce8ffe80e241850c0d2">colnr_T</a>)0, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div><div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;            ++error;</div><div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;        }</div><div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (idx &lt; (<span class="keywordtype">int</span>)pp-&gt;<a class="code" href="structpointer__block.html#ad3682038298e7850fb980815132f17f9">pb_count</a>)   <span class="comment">/* go a block deeper */</span></div><div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;        {</div><div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;            <span class="keywordflow">if</span> (pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[idx].<a class="code" href="structpointer__entry.html#a0234165c0ca282f192e94957a87175f6">pe_bnum</a> &lt; 0)</div><div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;            {</div><div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;            <span class="comment">/*</span></div><div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;<span class="comment">             * Data block with negative block number.</span></div><div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;<span class="comment">             * Try to read lines from the original file.</span></div><div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;<span class="comment">             * This is slow, but it works.</span></div><div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;<span class="comment">             */</span></div><div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;            <span class="keywordflow">if</span> (!cannot_open)</div><div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;            {</div><div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;                line_count = pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[idx].<a class="code" href="structpointer__entry.html#a652fe117ed91b4ab3d84361e8aa751de">pe_line_count</a>;</div><div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;                <span class="keywordflow">if</span> (<a class="code" href="fileio_8c.html#a73e5befa6abbf600f3d3f1aaf1c2ee85">readfile</a>(curbuf-&gt;b_ffname, NULL, lnum,</div><div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;                    pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[idx].<a class="code" href="structpointer__entry.html#a4ed8c85821e6c5ac44c2a77160d4b26d">pe_old_lnum</a> - 1,</div><div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;                    line_count, NULL, 0) != <a class="code" href="dosinst_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>)</div><div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;                cannot_open = <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;                <span class="keywordflow">else</span></div><div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;                lnum += line_count;</div><div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;            }</div><div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;            <span class="keywordflow">if</span> (cannot_open)</div><div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;            {</div><div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;                ++error;</div><div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;                <a class="code" href="memline_8c.html#a6dd3bce99cbc1af9f7cfd6c843c5b44d">ml_append</a>(lnum++, (char_u *)<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;???LINES MISSING&quot;</span>),</div><div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;                                (<a class="code" href="vim_8h.html#ae79e04a416bd6ce8ffe80e241850c0d2">colnr_T</a>)0, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div><div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;            }</div><div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;            ++idx;      <span class="comment">/* get same block again for next index */</span></div><div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;            <span class="keywordflow">continue</span>;</div><div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;            }</div><div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;</div><div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;            <span class="comment">/*</span></div><div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;<span class="comment">             * going one block deeper in the tree</span></div><div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;<span class="comment">             */</span></div><div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;            <span class="keywordflow">if</span> ((top = <a class="code" href="memline_8c.html#aa6909d6a13a3189fdb549bea27afc662">ml_add_stack</a>(buf)) &lt; 0)  <span class="comment">/* new entry in stack */</span></div><div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;            {</div><div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;            ++error;</div><div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;            <span class="keywordflow">break</span>;          <span class="comment">/* out of memory */</span></div><div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;            }</div><div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;            ip = &amp;(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a77e2179043ee3367af09fe186b2fa5a8">ml_stack</a>[top]);</div><div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;            ip-&gt;<a class="code" href="structinfo__pointer.html#a140d83e56091daa97560a9a4a82a8c1b">ip_bnum</a> = bnum;</div><div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;            ip-&gt;<a class="code" href="structinfo__pointer.html#acdf584cb720506bd2f40240dc71bab50">ip_index</a> = idx;</div><div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;</div><div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;            bnum = pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[idx].<a class="code" href="structpointer__entry.html#a0234165c0ca282f192e94957a87175f6">pe_bnum</a>;</div><div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;            line_count = pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[idx].<a class="code" href="structpointer__entry.html#a652fe117ed91b4ab3d84361e8aa751de">pe_line_count</a>;</div><div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;            page_count = pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[idx].<a class="code" href="structpointer__entry.html#aa5194eaf0768453f33b9d2ff66508040">pe_page_count</a>;</div><div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;            idx = 0;</div><div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;            <span class="keywordflow">continue</span>;</div><div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;        }</div><div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;        }</div><div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;        <span class="keywordflow">else</span>        <span class="comment">/* not a pointer block */</span></div><div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;        {</div><div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;        dp = (<a class="code" href="structdata__block.html">DATA_BL</a> *)(hp-&gt;<a class="code" href="structblock__hdr.html#a7247cdc0977ab6fdc9cb6238cda67587">bh_data</a>);</div><div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;        <span class="keywordflow">if</span> (dp-&gt;<a class="code" href="structdata__block.html#ac977617f5f8153eda5d902a73e0379e1">db_id</a> != <a class="code" href="memline_8c.html#a55aa586df150c1192826a1c57dd87401">DATA_ID</a>)   <span class="comment">/* block id wrong */</span></div><div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;        {</div><div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;            <span class="keywordflow">if</span> (bnum == 1)</div><div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;            {</div><div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;            <a class="code" href="message_8c.html#aeb2442b830699494f53059773212d850">semsg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;E310: Block 1 ID wrong (%s not a .swp file?)&quot;</span>),</div><div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;                                   mfp-&gt;<a class="code" href="structmemfile.html#acf87c004bb17883fecc56966daa0a7f3">mf_fname</a>);</div><div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;            <span class="keywordflow">goto</span> theend;</div><div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;            }</div><div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;            ++error;</div><div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;            <a class="code" href="memline_8c.html#a6dd3bce99cbc1af9f7cfd6c843c5b44d">ml_append</a>(lnum++, (char_u *)<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;???BLOCK MISSING&quot;</span>),</div><div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;                                (<a class="code" href="vim_8h.html#ae79e04a416bd6ce8ffe80e241850c0d2">colnr_T</a>)0, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div><div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;        }</div><div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;        {</div><div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;            <span class="comment">/*</span></div><div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;<span class="comment">             * it is a data block</span></div><div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;<span class="comment">             * Append all the lines in this block</span></div><div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;<span class="comment">             */</span></div><div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;            has_error = <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;            <span class="comment">/*</span></div><div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;<span class="comment">             * check length of block</span></div><div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;<span class="comment">             * if wrong, use length in pointer block</span></div><div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;<span class="comment">             */</span></div><div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;            <span class="keywordflow">if</span> (page_count * mfp-&gt;<a class="code" href="structmemfile.html#ab0c66141886a009d8132b8e1e2a00fc6">mf_page_size</a> != dp-&gt;<a class="code" href="structdata__block.html#ae079e3993bfc47bd86fd6e2fc3ab44ba">db_txt_end</a>)</div><div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;            {</div><div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;            <a class="code" href="memline_8c.html#a6dd3bce99cbc1af9f7cfd6c843c5b44d">ml_append</a>(lnum++, (char_u *)<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;??? from here until ???END lines may be messed up&quot;</span>),</div><div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;                                (<a class="code" href="vim_8h.html#ae79e04a416bd6ce8ffe80e241850c0d2">colnr_T</a>)0, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div><div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;            ++error;</div><div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;            has_error = <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;            dp-&gt;<a class="code" href="structdata__block.html#ae079e3993bfc47bd86fd6e2fc3ab44ba">db_txt_end</a> = page_count * mfp-&gt;<a class="code" href="structmemfile.html#ab0c66141886a009d8132b8e1e2a00fc6">mf_page_size</a>;</div><div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;            }</div><div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;</div><div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;            <span class="comment">/* make sure there is a NUL at the end of the block */</span></div><div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;            *((char_u *)dp + dp-&gt;<a class="code" href="structdata__block.html#ae079e3993bfc47bd86fd6e2fc3ab44ba">db_txt_end</a> - 1) = <a class="code" href="ascii_8h.html#af19d48b9f61047a668649a2f9dc317ff">NUL</a>;</div><div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;</div><div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;            <span class="comment">/*</span></div><div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;<span class="comment">             * check number of lines in block</span></div><div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;<span class="comment">             * if wrong, use count in data block</span></div><div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;<span class="comment">             */</span></div><div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;            <span class="keywordflow">if</span> (line_count != dp-&gt;<a class="code" href="structdata__block.html#a00084a39a3bdd9a03b9a055216aec5c5">db_line_count</a>)</div><div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;            {</div><div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;            <a class="code" href="memline_8c.html#a6dd3bce99cbc1af9f7cfd6c843c5b44d">ml_append</a>(lnum++, (char_u *)<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;??? from here until ???END lines may have been inserted/deleted&quot;</span>),</div><div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;                                (<a class="code" href="vim_8h.html#ae79e04a416bd6ce8ffe80e241850c0d2">colnr_T</a>)0, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div><div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;            ++error;</div><div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;            has_error = <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;            }</div><div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;</div><div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;            <span class="keywordflow">for</span> (i = 0; i &lt; dp-&gt;<a class="code" href="structdata__block.html#a00084a39a3bdd9a03b9a055216aec5c5">db_line_count</a>; ++i)</div><div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;            {</div><div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;            txt_start = (dp-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[i] &amp; <a class="code" href="memline_8c.html#ab65775db0f7dbf161fce05ee7fb36573">DB_INDEX_MASK</a>);</div><div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;            <span class="keywordflow">if</span> (txt_start &lt;= (<span class="keywordtype">int</span>)<a class="code" href="memline_8c.html#a49999be01380f41cc0d0f1f1406fb277">HEADER_SIZE</a></div><div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;                      || txt_start &gt;= (int)dp-&gt;<a class="code" href="structdata__block.html#ae079e3993bfc47bd86fd6e2fc3ab44ba">db_txt_end</a>)</div><div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;            {</div><div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;                p = (char_u *)<span class="stringliteral">&quot;???&quot;</span>;</div><div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;                ++error;</div><div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;            }</div><div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;                p = (char_u *)dp + txt_start;</div><div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;            <a class="code" href="memline_8c.html#a6dd3bce99cbc1af9f7cfd6c843c5b44d">ml_append</a>(lnum++, p, (<a class="code" href="vim_8h.html#ae79e04a416bd6ce8ffe80e241850c0d2">colnr_T</a>)0, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div><div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;            }</div><div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;            <span class="keywordflow">if</span> (has_error)</div><div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;            <a class="code" href="memline_8c.html#a6dd3bce99cbc1af9f7cfd6c843c5b44d">ml_append</a>(lnum++, (char_u *)<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;???END&quot;</span>),</div><div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;                                (<a class="code" href="vim_8h.html#ae79e04a416bd6ce8ffe80e241850c0d2">colnr_T</a>)0, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div><div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;        }</div><div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;        }</div><div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;    }</div><div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;</div><div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160;    <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a17d957b4b662bf327749e1523ac4f5b5">ml_stack_top</a> == 0)    <span class="comment">/* finished */</span></div><div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160;</div><div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;<span class="comment">     * go one block up in the tree</span></div><div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;    ip = &amp;(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a77e2179043ee3367af09fe186b2fa5a8">ml_stack</a>[--(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a17d957b4b662bf327749e1523ac4f5b5">ml_stack_top</a>)]);</div><div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;    bnum = ip-&gt;<a class="code" href="structinfo__pointer.html#a140d83e56091daa97560a9a4a82a8c1b">ip_bnum</a>;</div><div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;    idx = ip-&gt;<a class="code" href="structinfo__pointer.html#acdf584cb720506bd2f40240dc71bab50">ip_index</a> + 1;     <span class="comment">/* go to next index */</span></div><div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;    page_count = 1;</div><div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;    }</div><div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;</div><div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;<span class="comment">     * Compare the buffer contents with the original file.  When they differ</span></div><div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;<span class="comment">     * set the &#39;modified&#39; flag.</span></div><div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;<span class="comment">     * Lines 1 - lnum are the new contents.</span></div><div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;<span class="comment">     * Lines lnum + 1 to ml_line_count are the original contents.</span></div><div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;<span class="comment">     * Line ml_line_count + 1 in the dummy empty line.</span></div><div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;    <span class="keywordflow">if</span> (orig_file_status != <a class="code" href="dosinst_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a> || curbuf-&gt;b_ml.ml_line_count != lnum * 2 + 1)</div><div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;    {</div><div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;    <span class="comment">/* Recovering an empty file results in two lines and the first line is</span></div><div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160;<span class="comment">     * empty.  Don&#39;t set the modified flag then. */</span></div><div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;    <span class="keywordflow">if</span> (!(curbuf-&gt;b_ml.ml_line_count == 2 &amp;&amp; *<a class="code" href="memline_8c.html#a109387062ce17fc808cae3971ce703ba">ml_get</a>(1) == <a class="code" href="ascii_8h.html#af19d48b9f61047a668649a2f9dc317ff">NUL</a>))</div><div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;    {</div><div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;        <a class="code" href="change_8c.html#a60e72aa7c3cf9c6df3c397c4a57191eb">changed_internal</a>();</div><div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;        ++<a class="code" href="structs_8h.html#adaffabd92745a7c8d9bf0e790cd35049">CHANGEDTICK</a>(curbuf);</div><div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;    }</div><div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;    }</div><div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;    {</div><div class="line"><a name="l01647"></a><span class="lineno"> 1647</span>&#160;    <span class="keywordflow">for</span> (idx = 1; idx &lt;= lnum; ++idx)</div><div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;    {</div><div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;        <span class="comment">/* Need to copy one line, fetching the other one may flush it. */</span></div><div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;        p = <a class="code" href="misc2_8c.html#acd554ee46804f666060916bf740b3c96">vim_strsave</a>(<a class="code" href="memline_8c.html#a109387062ce17fc808cae3971ce703ba">ml_get</a>(idx));</div><div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;        i = <a class="code" href="vim_8h.html#a75fb5fb9d785a71f9d82f4d008a48278">STRCMP</a>(p, <a class="code" href="memline_8c.html#a109387062ce17fc808cae3971ce703ba">ml_get</a>(idx + lnum));</div><div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;        <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(p);</div><div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;        <span class="keywordflow">if</span> (i != 0)</div><div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;        {</div><div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;        <a class="code" href="change_8c.html#a60e72aa7c3cf9c6df3c397c4a57191eb">changed_internal</a>();</div><div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160;        ++<a class="code" href="structs_8h.html#adaffabd92745a7c8d9bf0e790cd35049">CHANGEDTICK</a>(curbuf);</div><div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160;        }</div><div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;    }</div><div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;    }</div><div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;</div><div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;<span class="comment">     * Delete the lines from the original file and the dummy line from the</span></div><div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;<span class="comment">     * empty buffer.  These will now be after the last line in the buffer.</span></div><div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;    <span class="keywordflow">while</span> (curbuf-&gt;b_ml.ml_line_count &gt; lnum</div><div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160;                       &amp;&amp; !(curbuf-&gt;b_ml.ml_flags &amp; <a class="code" href="structs_8h.html#a67ecfd4d644d8b33ba15512b7136602a">ML_EMPTY</a>))</div><div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;    <a class="code" href="memline_8c.html#acc7926ea1ef47502c4c44de231e2dbfc">ml_delete</a>(curbuf-&gt;b_ml.ml_line_count, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;    curbuf-&gt;b_flags |= <a class="code" href="vim_8h.html#acc0703dad0b379b34be226e2402937db">BF_RECOVERED</a>;</div><div class="line"><a name="l01670"></a><span class="lineno"> 1670</span>&#160;</div><div class="line"><a name="l01671"></a><span class="lineno"> 1671</span>&#160;    recoverymode = <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line"><a name="l01672"></a><span class="lineno"> 1672</span>&#160;    <span class="keywordflow">if</span> (got_int)</div><div class="line"><a name="l01673"></a><span class="lineno"> 1673</span>&#160;    <a class="code" href="message_8c.html#ae5991a4d11897dfaee9bfab8e5489d82">emsg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;E311: Recovery Interrupted&quot;</span>));</div><div class="line"><a name="l01674"></a><span class="lineno"> 1674</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (error)</div><div class="line"><a name="l01675"></a><span class="lineno"> 1675</span>&#160;    {</div><div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;    ++no_wait_return;</div><div class="line"><a name="l01677"></a><span class="lineno"> 1677</span>&#160;    <a class="code" href="message_8c.html#a6a5cfaa40c91127e2434c14cddb955b6">msg</a>(<span class="stringliteral">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;</span>);</div><div class="line"><a name="l01678"></a><span class="lineno"> 1678</span>&#160;    <a class="code" href="message_8c.html#ae5991a4d11897dfaee9bfab8e5489d82">emsg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;E312: Errors detected while recovering; look for lines starting with ???&quot;</span>));</div><div class="line"><a name="l01679"></a><span class="lineno"> 1679</span>&#160;    --no_wait_return;</div><div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;    <a class="code" href="message_8c.html#a6a5cfaa40c91127e2434c14cddb955b6">msg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;See \&quot;:help E312\&quot; for more information.&quot;</span>));</div><div class="line"><a name="l01681"></a><span class="lineno"> 1681</span>&#160;    <a class="code" href="message_8c.html#a6a5cfaa40c91127e2434c14cddb955b6">msg</a>(<span class="stringliteral">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;</span>);</div><div class="line"><a name="l01682"></a><span class="lineno"> 1682</span>&#160;    }</div><div class="line"><a name="l01683"></a><span class="lineno"> 1683</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01684"></a><span class="lineno"> 1684</span>&#160;    {</div><div class="line"><a name="l01685"></a><span class="lineno"> 1685</span>&#160;    <span class="keywordflow">if</span> (curbuf-&gt;b_changed)</div><div class="line"><a name="l01686"></a><span class="lineno"> 1686</span>&#160;    {</div><div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;        <a class="code" href="message_8c.html#a6a5cfaa40c91127e2434c14cddb955b6">msg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;Recovery completed. You should check if everything is OK.&quot;</span>));</div><div class="line"><a name="l01688"></a><span class="lineno"> 1688</span>&#160;        <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;\n(You might want to write out this file under another name\n&quot;</span>));</div><div class="line"><a name="l01689"></a><span class="lineno"> 1689</span>&#160;        <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;and run diff with the original file to check for changes)&quot;</span>));</div><div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;    }</div><div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01692"></a><span class="lineno"> 1692</span>&#160;        <a class="code" href="message_8c.html#a6a5cfaa40c91127e2434c14cddb955b6">msg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;Recovery completed. Buffer contents equals file contents.&quot;</span>));</div><div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;    <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;\nYou may want to delete the .swp file now.\n\n&quot;</span>));</div><div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160;    <a class="code" href="globals_8h.html#ad239f2bb11982175ed2389134c8f3669">cmdline_row</a> = <a class="code" href="globals_8h.html#a376f82c59d5c5bf72c5bc753f7554128">msg_row</a>;</div><div class="line"><a name="l01695"></a><span class="lineno"> 1695</span>&#160;    }</div><div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160;<span class="preprocessor">#ifdef FEAT_CRYPT</span></div><div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160;    <span class="keywordflow">if</span> (*buf-&gt;b_p_key != <a class="code" href="ascii_8h.html#af19d48b9f61047a668649a2f9dc317ff">NUL</a> &amp;&amp; <a class="code" href="vim_8h.html#a75fb5fb9d785a71f9d82f4d008a48278">STRCMP</a>(curbuf-&gt;b_p_key, buf-&gt;b_p_key) != 0)</div><div class="line"><a name="l01698"></a><span class="lineno"> 1698</span>&#160;    {</div><div class="line"><a name="l01699"></a><span class="lineno"> 1699</span>&#160;    <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;Using crypt key from swap file for the text file.\n&quot;</span>));</div><div class="line"><a name="l01700"></a><span class="lineno"> 1700</span>&#160;    <a class="code" href="option_8c.html#a94ae863d1c8638bea649c9a093c2be06">set_option_value</a>((char_u *)<span class="stringliteral">&quot;key&quot;</span>, 0L, buf-&gt;b_p_key, <a class="code" href="vim_8h.html#af0d84616173bb5946784c0a50b4b01b3">OPT_LOCAL</a>);</div><div class="line"><a name="l01701"></a><span class="lineno"> 1701</span>&#160;    }</div><div class="line"><a name="l01702"></a><span class="lineno"> 1702</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01703"></a><span class="lineno"> 1703</span>&#160;    <a class="code" href="drawscreen_8c.html#a8430c433761f5a1693d346d2abf1e6bb">redraw_curbuf_later</a>(<a class="code" href="vim_8h.html#a72695d31382ba5334881ad3407393642">NOT_VALID</a>);</div><div class="line"><a name="l01704"></a><span class="lineno"> 1704</span>&#160;</div><div class="line"><a name="l01705"></a><span class="lineno"> 1705</span>&#160;theend:</div><div class="line"><a name="l01706"></a><span class="lineno"> 1706</span>&#160;    <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(fname_used);</div><div class="line"><a name="l01707"></a><span class="lineno"> 1707</span>&#160;    recoverymode = <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line"><a name="l01708"></a><span class="lineno"> 1708</span>&#160;    <span class="keywordflow">if</span> (mfp != NULL)</div><div class="line"><a name="l01709"></a><span class="lineno"> 1709</span>&#160;    {</div><div class="line"><a name="l01710"></a><span class="lineno"> 1710</span>&#160;    <span class="keywordflow">if</span> (hp != NULL)</div><div class="line"><a name="l01711"></a><span class="lineno"> 1711</span>&#160;        <a class="code" href="memfile_8c.html#abb7f268382703d32becc96f6d92fb855">mf_put</a>(mfp, hp, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l01712"></a><span class="lineno"> 1712</span>&#160;    <a class="code" href="memfile_8c.html#afacf63c365230cb65206d3e98823ec29">mf_close</a>(mfp, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);       <span class="comment">/* will also vim_free(mfp-&gt;mf_fname) */</span></div><div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160;    }</div><div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160;    <span class="keywordflow">if</span> (buf != NULL)</div><div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160;    {</div><div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160;<span class="preprocessor">#ifdef FEAT_CRYPT</span></div><div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160;    <span class="keywordflow">if</span> (buf-&gt;b_p_key != curbuf-&gt;b_p_key)</div><div class="line"><a name="l01718"></a><span class="lineno"> 1718</span>&#160;        <a class="code" href="optionstr_8c.html#aeb9d6480a68bfee6052f8e8afc8eda94">free_string_option</a>(buf-&gt;b_p_key);</div><div class="line"><a name="l01719"></a><span class="lineno"> 1719</span>&#160;    <a class="code" href="optionstr_8c.html#aeb9d6480a68bfee6052f8e8afc8eda94">free_string_option</a>(buf-&gt;b_p_cm);</div><div class="line"><a name="l01720"></a><span class="lineno"> 1720</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01721"></a><span class="lineno"> 1721</span>&#160;    <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a77e2179043ee3367af09fe186b2fa5a8">ml_stack</a>);</div><div class="line"><a name="l01722"></a><span class="lineno"> 1722</span>&#160;    <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(buf);</div><div class="line"><a name="l01723"></a><span class="lineno"> 1723</span>&#160;    }</div><div class="line"><a name="l01724"></a><span class="lineno"> 1724</span>&#160;    <span class="keywordflow">if</span> (serious_error &amp;&amp; called_from_main)</div><div class="line"><a name="l01725"></a><span class="lineno"> 1725</span>&#160;    <a class="code" href="memline_8c.html#abe58d9866bc8d9d29c219f731bb85ceb">ml_close</a>(curbuf, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div><div class="line"><a name="l01726"></a><span class="lineno"> 1726</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01727"></a><span class="lineno"> 1727</span>&#160;    {</div><div class="line"><a name="l01728"></a><span class="lineno"> 1728</span>&#160;    <a class="code" href="autocmd_8c.html#a0239c7fe680501d4396b532abf3bd768">apply_autocmds</a>(<a class="code" href="vim_8h.html#a2de49dcf3b3c1e1043a2373b0d69a58aa07e541cd9061f877f65e3534a984df29">EVENT_BUFREADPOST</a>, NULL, curbuf-&gt;b_fname, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, curbuf);</div><div class="line"><a name="l01729"></a><span class="lineno"> 1729</span>&#160;    <a class="code" href="autocmd_8c.html#a0239c7fe680501d4396b532abf3bd768">apply_autocmds</a>(<a class="code" href="vim_8h.html#a2de49dcf3b3c1e1043a2373b0d69a58aa5f8d815faf4ecd8104d4eb0f4d7daf85">EVENT_BUFWINENTER</a>, NULL, curbuf-&gt;b_fname, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, curbuf);</div><div class="line"><a name="l01730"></a><span class="lineno"> 1730</span>&#160;    }</div><div class="line"><a name="l01731"></a><span class="lineno"> 1731</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l01732"></a><span class="lineno"> 1732</span>&#160;}</div><div class="line"><a name="l01733"></a><span class="lineno"> 1733</span>&#160;</div><div class="line"><a name="l01734"></a><span class="lineno"> 1734</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l01735"></a><span class="lineno"> 1735</span>&#160;<span class="comment"> * Find the names of swap files in current directory and the directory given</span></div><div class="line"><a name="l01736"></a><span class="lineno"> 1736</span>&#160;<span class="comment"> * with the &#39;directory&#39; option.</span></div><div class="line"><a name="l01737"></a><span class="lineno"> 1737</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l01738"></a><span class="lineno"> 1738</span>&#160;<span class="comment"> * Used to:</span></div><div class="line"><a name="l01739"></a><span class="lineno"> 1739</span>&#160;<span class="comment"> * - list the swap files for &quot;vim -r&quot;</span></div><div class="line"><a name="l01740"></a><span class="lineno"> 1740</span>&#160;<span class="comment"> * - count the number of swap files when recovering</span></div><div class="line"><a name="l01741"></a><span class="lineno"> 1741</span>&#160;<span class="comment"> * - list the swap files when recovering</span></div><div class="line"><a name="l01742"></a><span class="lineno"> 1742</span>&#160;<span class="comment"> * - find the name of the n&#39;th swap file when recovering</span></div><div class="line"><a name="l01743"></a><span class="lineno"> 1743</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l01744"></a><span class="lineno"> 1744</span>&#160;    <span class="keywordtype">int</span></div><div class="line"><a name="l01745"></a><span class="lineno"><a class="line" href="memline_8c.html#aba940da76a214a22a875eab61ec804e9"> 1745</a></span>&#160;<a class="code" href="memline_8c.html#aba940da76a214a22a875eab61ec804e9">recover_names</a>(</div><div class="line"><a name="l01746"></a><span class="lineno"> 1746</span>&#160;    char_u  *fname,     <span class="comment">/* base for swap file name */</span></div><div class="line"><a name="l01747"></a><span class="lineno"> 1747</span>&#160;    <span class="keywordtype">int</span>     list,       <span class="comment">/* when TRUE, list the swap file names */</span></div><div class="line"><a name="l01748"></a><span class="lineno"> 1748</span>&#160;    <span class="keywordtype">int</span>     nr,     <span class="comment">/* when non-zero, return nr&#39;th swap file name */</span></div><div class="line"><a name="l01749"></a><span class="lineno"> 1749</span>&#160;    char_u  **fname_out)    <span class="comment">/* result when &quot;nr&quot; &gt; 0 */</span></div><div class="line"><a name="l01750"></a><span class="lineno"> 1750</span>&#160;{</div><div class="line"><a name="l01751"></a><span class="lineno"> 1751</span>&#160;    <span class="keywordtype">int</span>     num_names;</div><div class="line"><a name="l01752"></a><span class="lineno"> 1752</span>&#160;    char_u  *(names[6]);</div><div class="line"><a name="l01753"></a><span class="lineno"> 1753</span>&#160;    char_u  *tail;</div><div class="line"><a name="l01754"></a><span class="lineno"> 1754</span>&#160;    char_u  *p;</div><div class="line"><a name="l01755"></a><span class="lineno"> 1755</span>&#160;    <span class="keywordtype">int</span>     num_files;</div><div class="line"><a name="l01756"></a><span class="lineno"> 1756</span>&#160;    <span class="keywordtype">int</span>     file_count = 0;</div><div class="line"><a name="l01757"></a><span class="lineno"> 1757</span>&#160;    char_u  **files;</div><div class="line"><a name="l01758"></a><span class="lineno"> 1758</span>&#160;    <span class="keywordtype">int</span>     i;</div><div class="line"><a name="l01759"></a><span class="lineno"> 1759</span>&#160;    char_u  *dirp;</div><div class="line"><a name="l01760"></a><span class="lineno"> 1760</span>&#160;    char_u  *dir_name;</div><div class="line"><a name="l01761"></a><span class="lineno"> 1761</span>&#160;    char_u  *fname_res = NULL;</div><div class="line"><a name="l01762"></a><span class="lineno"> 1762</span>&#160;<span class="preprocessor">#ifdef HAVE_READLINK</span></div><div class="line"><a name="l01763"></a><span class="lineno"> 1763</span>&#160;    char_u  fname_buf[<a class="code" href="os__unix_8h.html#a9b75f9db03a33bb3d2d613923647d0cf">MAXPATHL</a>];</div><div class="line"><a name="l01764"></a><span class="lineno"> 1764</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01765"></a><span class="lineno"> 1765</span>&#160;</div><div class="line"><a name="l01766"></a><span class="lineno"> 1766</span>&#160;    <span class="keywordflow">if</span> (fname != NULL)</div><div class="line"><a name="l01767"></a><span class="lineno"> 1767</span>&#160;    {</div><div class="line"><a name="l01768"></a><span class="lineno"> 1768</span>&#160;<span class="preprocessor">#ifdef HAVE_READLINK</span></div><div class="line"><a name="l01769"></a><span class="lineno"> 1769</span>&#160;    <span class="comment">/* Expand symlink in the file name, because the swap file is created</span></div><div class="line"><a name="l01770"></a><span class="lineno"> 1770</span>&#160;<span class="comment">     * with the actual file instead of with the symlink. */</span></div><div class="line"><a name="l01771"></a><span class="lineno"> 1771</span>&#160;    <span class="keywordflow">if</span> (resolve_symlink(fname, fname_buf) == <a class="code" href="dosinst_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>)</div><div class="line"><a name="l01772"></a><span class="lineno"> 1772</span>&#160;        fname_res = fname_buf;</div><div class="line"><a name="l01773"></a><span class="lineno"> 1773</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01774"></a><span class="lineno"> 1774</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01775"></a><span class="lineno"> 1775</span>&#160;        fname_res = fname;</div><div class="line"><a name="l01776"></a><span class="lineno"> 1776</span>&#160;    }</div><div class="line"><a name="l01777"></a><span class="lineno"> 1777</span>&#160;</div><div class="line"><a name="l01778"></a><span class="lineno"> 1778</span>&#160;    <span class="keywordflow">if</span> (list)</div><div class="line"><a name="l01779"></a><span class="lineno"> 1779</span>&#160;    {</div><div class="line"><a name="l01780"></a><span class="lineno"> 1780</span>&#160;    <span class="comment">/* use msg() to start the scrolling properly */</span></div><div class="line"><a name="l01781"></a><span class="lineno"> 1781</span>&#160;    <a class="code" href="message_8c.html#a6a5cfaa40c91127e2434c14cddb955b6">msg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;Swap files found:&quot;</span>));</div><div class="line"><a name="l01782"></a><span class="lineno"> 1782</span>&#160;    <a class="code" href="message_8c.html#ae0edfa8d1999c41726a759fd06a1ab6e">msg_putchar</a>(<span class="charliteral">&#39;\n&#39;</span>);</div><div class="line"><a name="l01783"></a><span class="lineno"> 1783</span>&#160;    }</div><div class="line"><a name="l01784"></a><span class="lineno"> 1784</span>&#160;</div><div class="line"><a name="l01785"></a><span class="lineno"> 1785</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l01786"></a><span class="lineno"> 1786</span>&#160;<span class="comment">     * Do the loop for every directory in &#39;directory&#39;.</span></div><div class="line"><a name="l01787"></a><span class="lineno"> 1787</span>&#160;<span class="comment">     * First allocate some memory to put the directory name in.</span></div><div class="line"><a name="l01788"></a><span class="lineno"> 1788</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l01789"></a><span class="lineno"> 1789</span>&#160;    dir_name = <a class="code" href="misc2_8c.html#ad0b64e14955781629a3908e328f82665">alloc</a>(<a class="code" href="vim_8h.html#a916ffefe1fc74532d08102cca55d8e34">STRLEN</a>(<a class="code" href="option_8h.html#a8668e2dd511003c9ad5a9032c1a17c3e">p_dir</a>) + 1);</div><div class="line"><a name="l01790"></a><span class="lineno"> 1790</span>&#160;    dirp = <a class="code" href="option_8h.html#a8668e2dd511003c9ad5a9032c1a17c3e">p_dir</a>;</div><div class="line"><a name="l01791"></a><span class="lineno"> 1791</span>&#160;    <span class="keywordflow">while</span> (dir_name != NULL &amp;&amp; *dirp)</div><div class="line"><a name="l01792"></a><span class="lineno"> 1792</span>&#160;    {</div><div class="line"><a name="l01793"></a><span class="lineno"> 1793</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l01794"></a><span class="lineno"> 1794</span>&#160;<span class="comment">     * Isolate a directory name from *dirp and put it in dir_name (we know</span></div><div class="line"><a name="l01795"></a><span class="lineno"> 1795</span>&#160;<span class="comment">     * it is large enough, so use 31000 for length).</span></div><div class="line"><a name="l01796"></a><span class="lineno"> 1796</span>&#160;<span class="comment">     * Advance dirp to next directory name.</span></div><div class="line"><a name="l01797"></a><span class="lineno"> 1797</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l01798"></a><span class="lineno"> 1798</span>&#160;    (void)<a class="code" href="misc2_8c.html#a2c53531dd0451dcef1ae39403b49ee67">copy_option_part</a>(&amp;dirp, dir_name, 31000, <span class="stringliteral">&quot;,&quot;</span>);</div><div class="line"><a name="l01799"></a><span class="lineno"> 1799</span>&#160;</div><div class="line"><a name="l01800"></a><span class="lineno"> 1800</span>&#160;    <span class="keywordflow">if</span> (dir_name[0] == <span class="charliteral">&#39;.&#39;</span> &amp;&amp; dir_name[1] == <a class="code" href="ascii_8h.html#af19d48b9f61047a668649a2f9dc317ff">NUL</a>)   <span class="comment">/* check current dir */</span></div><div class="line"><a name="l01801"></a><span class="lineno"> 1801</span>&#160;    {</div><div class="line"><a name="l01802"></a><span class="lineno"> 1802</span>&#160;        <span class="keywordflow">if</span> (fname == NULL)</div><div class="line"><a name="l01803"></a><span class="lineno"> 1803</span>&#160;        {</div><div class="line"><a name="l01804"></a><span class="lineno"> 1804</span>&#160;<span class="preprocessor">#ifdef VMS</span></div><div class="line"><a name="l01805"></a><span class="lineno"> 1805</span>&#160;        names[0] = <a class="code" href="misc2_8c.html#acd554ee46804f666060916bf740b3c96">vim_strsave</a>((char_u *)<span class="stringliteral">&quot;*_sw%&quot;</span>);</div><div class="line"><a name="l01806"></a><span class="lineno"> 1806</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l01807"></a><span class="lineno"> 1807</span>&#160;        names[0] = <a class="code" href="misc2_8c.html#acd554ee46804f666060916bf740b3c96">vim_strsave</a>((char_u *)<span class="stringliteral">&quot;*.sw?&quot;</span>);</div><div class="line"><a name="l01808"></a><span class="lineno"> 1808</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01809"></a><span class="lineno"> 1809</span>&#160;<span class="preprocessor">#if defined(UNIX) || defined(MSWIN)</span></div><div class="line"><a name="l01810"></a><span class="lineno"> 1810</span>&#160;        <span class="comment">/* For Unix names starting with a dot are special.  MS-Windows</span></div><div class="line"><a name="l01811"></a><span class="lineno"> 1811</span>&#160;<span class="comment">         * supports this too, on some file systems. */</span></div><div class="line"><a name="l01812"></a><span class="lineno"> 1812</span>&#160;        names[1] = <a class="code" href="misc2_8c.html#acd554ee46804f666060916bf740b3c96">vim_strsave</a>((char_u *)<span class="stringliteral">&quot;.*.sw?&quot;</span>);</div><div class="line"><a name="l01813"></a><span class="lineno"> 1813</span>&#160;        names[2] = <a class="code" href="misc2_8c.html#acd554ee46804f666060916bf740b3c96">vim_strsave</a>((char_u *)<span class="stringliteral">&quot;.sw?&quot;</span>);</div><div class="line"><a name="l01814"></a><span class="lineno"> 1814</span>&#160;        num_names = 3;</div><div class="line"><a name="l01815"></a><span class="lineno"> 1815</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l01816"></a><span class="lineno"> 1816</span>&#160;<span class="preprocessor"># ifdef VMS</span></div><div class="line"><a name="l01817"></a><span class="lineno"> 1817</span>&#160;        names[1] = <a class="code" href="misc2_8c.html#acd554ee46804f666060916bf740b3c96">vim_strsave</a>((char_u *)<span class="stringliteral">&quot;.*_sw%&quot;</span>);</div><div class="line"><a name="l01818"></a><span class="lineno"> 1818</span>&#160;        num_names = 2;</div><div class="line"><a name="l01819"></a><span class="lineno"> 1819</span>&#160;<span class="preprocessor"># else</span></div><div class="line"><a name="l01820"></a><span class="lineno"> 1820</span>&#160;        num_names = 1;</div><div class="line"><a name="l01821"></a><span class="lineno"> 1821</span>&#160;<span class="preprocessor"># endif</span></div><div class="line"><a name="l01822"></a><span class="lineno"> 1822</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01823"></a><span class="lineno"> 1823</span>&#160;        }</div><div class="line"><a name="l01824"></a><span class="lineno"> 1824</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l01825"></a><span class="lineno"> 1825</span>&#160;        num_names = <a class="code" href="memline_8c.html#a95c3497feee28077f095256e5584c0af">recov_file_names</a>(names, fname_res, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div><div class="line"><a name="l01826"></a><span class="lineno"> 1826</span>&#160;    }</div><div class="line"><a name="l01827"></a><span class="lineno"> 1827</span>&#160;    <span class="keywordflow">else</span>                <span class="comment">/* check directory dir_name */</span></div><div class="line"><a name="l01828"></a><span class="lineno"> 1828</span>&#160;    {</div><div class="line"><a name="l01829"></a><span class="lineno"> 1829</span>&#160;        <span class="keywordflow">if</span> (fname == NULL)</div><div class="line"><a name="l01830"></a><span class="lineno"> 1830</span>&#160;        {</div><div class="line"><a name="l01831"></a><span class="lineno"> 1831</span>&#160;<span class="preprocessor">#ifdef VMS</span></div><div class="line"><a name="l01832"></a><span class="lineno"> 1832</span>&#160;        names[0] = <a class="code" href="filepath_8c.html#a8de478b7b0307fbc7b4aab47648ecb0c">concat_fnames</a>(dir_name, (char_u *)<span class="stringliteral">&quot;*_sw%&quot;</span>, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div><div class="line"><a name="l01833"></a><span class="lineno"> 1833</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l01834"></a><span class="lineno"> 1834</span>&#160;        names[0] = <a class="code" href="filepath_8c.html#a8de478b7b0307fbc7b4aab47648ecb0c">concat_fnames</a>(dir_name, (char_u *)<span class="stringliteral">&quot;*.sw?&quot;</span>, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div><div class="line"><a name="l01835"></a><span class="lineno"> 1835</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01836"></a><span class="lineno"> 1836</span>&#160;<span class="preprocessor">#if defined(UNIX) || defined(MSWIN)</span></div><div class="line"><a name="l01837"></a><span class="lineno"> 1837</span>&#160;        <span class="comment">/* For Unix names starting with a dot are special.  MS-Windows</span></div><div class="line"><a name="l01838"></a><span class="lineno"> 1838</span>&#160;<span class="comment">         * supports this too, on some file systems. */</span></div><div class="line"><a name="l01839"></a><span class="lineno"> 1839</span>&#160;        names[1] = <a class="code" href="filepath_8c.html#a8de478b7b0307fbc7b4aab47648ecb0c">concat_fnames</a>(dir_name, (char_u *)<span class="stringliteral">&quot;.*.sw?&quot;</span>, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div><div class="line"><a name="l01840"></a><span class="lineno"> 1840</span>&#160;        names[2] = <a class="code" href="filepath_8c.html#a8de478b7b0307fbc7b4aab47648ecb0c">concat_fnames</a>(dir_name, (char_u *)<span class="stringliteral">&quot;.sw?&quot;</span>, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div><div class="line"><a name="l01841"></a><span class="lineno"> 1841</span>&#160;        num_names = 3;</div><div class="line"><a name="l01842"></a><span class="lineno"> 1842</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l01843"></a><span class="lineno"> 1843</span>&#160;<span class="preprocessor"># ifdef VMS</span></div><div class="line"><a name="l01844"></a><span class="lineno"> 1844</span>&#160;        names[1] = <a class="code" href="filepath_8c.html#a8de478b7b0307fbc7b4aab47648ecb0c">concat_fnames</a>(dir_name, (char_u *)<span class="stringliteral">&quot;.*_sw%&quot;</span>, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div><div class="line"><a name="l01845"></a><span class="lineno"> 1845</span>&#160;        num_names = 2;</div><div class="line"><a name="l01846"></a><span class="lineno"> 1846</span>&#160;<span class="preprocessor"># else</span></div><div class="line"><a name="l01847"></a><span class="lineno"> 1847</span>&#160;        num_names = 1;</div><div class="line"><a name="l01848"></a><span class="lineno"> 1848</span>&#160;<span class="preprocessor"># endif</span></div><div class="line"><a name="l01849"></a><span class="lineno"> 1849</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01850"></a><span class="lineno"> 1850</span>&#160;        }</div><div class="line"><a name="l01851"></a><span class="lineno"> 1851</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l01852"></a><span class="lineno"> 1852</span>&#160;        {</div><div class="line"><a name="l01853"></a><span class="lineno"> 1853</span>&#160;<span class="preprocessor">#if defined(UNIX) || defined(MSWIN)</span></div><div class="line"><a name="l01854"></a><span class="lineno"> 1854</span>&#160;        <span class="keywordtype">int</span> len = (int)<a class="code" href="vim_8h.html#a916ffefe1fc74532d08102cca55d8e34">STRLEN</a>(dir_name);</div><div class="line"><a name="l01855"></a><span class="lineno"> 1855</span>&#160;</div><div class="line"><a name="l01856"></a><span class="lineno"> 1856</span>&#160;        p = dir_name + len;</div><div class="line"><a name="l01857"></a><span class="lineno"> 1857</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="misc2_8c.html#abdfcdf88256313698f6b7329ba22c5f3">after_pathsep</a>(dir_name, p) &amp;&amp; len &gt; 1 &amp;&amp; p[-1] == p[-2])</div><div class="line"><a name="l01858"></a><span class="lineno"> 1858</span>&#160;        {</div><div class="line"><a name="l01859"></a><span class="lineno"> 1859</span>&#160;            <span class="comment">/* Ends with &#39;//&#39;, Use Full path for swap name */</span></div><div class="line"><a name="l01860"></a><span class="lineno"> 1860</span>&#160;            tail = make_percent_swname(dir_name, fname_res);</div><div class="line"><a name="l01861"></a><span class="lineno"> 1861</span>&#160;        }</div><div class="line"><a name="l01862"></a><span class="lineno"> 1862</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l01863"></a><span class="lineno"> 1863</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01864"></a><span class="lineno"> 1864</span>&#160;        {</div><div class="line"><a name="l01865"></a><span class="lineno"> 1865</span>&#160;            tail = <a class="code" href="filepath_8c.html#a3a027a38b217222ac4d9ebe8ce5c1947">gettail</a>(fname_res);</div><div class="line"><a name="l01866"></a><span class="lineno"> 1866</span>&#160;            tail = <a class="code" href="filepath_8c.html#a8de478b7b0307fbc7b4aab47648ecb0c">concat_fnames</a>(dir_name, tail, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div><div class="line"><a name="l01867"></a><span class="lineno"> 1867</span>&#160;        }</div><div class="line"><a name="l01868"></a><span class="lineno"> 1868</span>&#160;        <span class="keywordflow">if</span> (tail == NULL)</div><div class="line"><a name="l01869"></a><span class="lineno"> 1869</span>&#160;            num_names = 0;</div><div class="line"><a name="l01870"></a><span class="lineno"> 1870</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l01871"></a><span class="lineno"> 1871</span>&#160;        {</div><div class="line"><a name="l01872"></a><span class="lineno"> 1872</span>&#160;            num_names = <a class="code" href="memline_8c.html#a95c3497feee28077f095256e5584c0af">recov_file_names</a>(names, tail, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l01873"></a><span class="lineno"> 1873</span>&#160;            <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(tail);</div><div class="line"><a name="l01874"></a><span class="lineno"> 1874</span>&#160;        }</div><div class="line"><a name="l01875"></a><span class="lineno"> 1875</span>&#160;        }</div><div class="line"><a name="l01876"></a><span class="lineno"> 1876</span>&#160;    }</div><div class="line"><a name="l01877"></a><span class="lineno"> 1877</span>&#160;</div><div class="line"><a name="l01878"></a><span class="lineno"> 1878</span>&#160;    <span class="comment">// check for out-of-memory</span></div><div class="line"><a name="l01879"></a><span class="lineno"> 1879</span>&#160;    <span class="keywordflow">for</span> (i = 0; i &lt; num_names; ++i)</div><div class="line"><a name="l01880"></a><span class="lineno"> 1880</span>&#160;    {</div><div class="line"><a name="l01881"></a><span class="lineno"> 1881</span>&#160;        <span class="keywordflow">if</span> (names[i] == NULL)</div><div class="line"><a name="l01882"></a><span class="lineno"> 1882</span>&#160;        {</div><div class="line"><a name="l01883"></a><span class="lineno"> 1883</span>&#160;        <span class="keywordflow">for</span> (i = 0; i &lt; num_names; ++i)</div><div class="line"><a name="l01884"></a><span class="lineno"> 1884</span>&#160;            <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(names[i]);</div><div class="line"><a name="l01885"></a><span class="lineno"> 1885</span>&#160;        num_names = 0;</div><div class="line"><a name="l01886"></a><span class="lineno"> 1886</span>&#160;        }</div><div class="line"><a name="l01887"></a><span class="lineno"> 1887</span>&#160;    }</div><div class="line"><a name="l01888"></a><span class="lineno"> 1888</span>&#160;    <span class="keywordflow">if</span> (num_names == 0)</div><div class="line"><a name="l01889"></a><span class="lineno"> 1889</span>&#160;        num_files = 0;</div><div class="line"><a name="l01890"></a><span class="lineno"> 1890</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="filepath_8c.html#a3b361a1f7b0ca7d64f669e56cf543782">expand_wildcards</a>(num_names, names, &amp;num_files, &amp;files,</div><div class="line"><a name="l01891"></a><span class="lineno"> 1891</span>&#160;                <a class="code" href="vim_8h.html#a6a0317d31611db43900c317059656a22">EW_NOTENV</a>|<a class="code" href="vim_8h.html#aa21e4fd8501798f13fdad0d16ed006f1">EW_KEEPALL</a>|<a class="code" href="vim_8h.html#aa97249d6f36568a65ef1b11aa3db1aa2">EW_FILE</a>|<a class="code" href="vim_8h.html#a70c2e1c93622f9cc806906ebe68fe5cf">EW_SILENT</a>) == <a class="code" href="dosinst_8h.html#abb508ea8227673f419e9fe3a86c30d8e">FAIL</a>)</div><div class="line"><a name="l01892"></a><span class="lineno"> 1892</span>&#160;        num_files = 0;</div><div class="line"><a name="l01893"></a><span class="lineno"> 1893</span>&#160;</div><div class="line"><a name="l01894"></a><span class="lineno"> 1894</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l01895"></a><span class="lineno"> 1895</span>&#160;<span class="comment">     * When no swap file found, wildcard expansion might have failed (e.g.</span></div><div class="line"><a name="l01896"></a><span class="lineno"> 1896</span>&#160;<span class="comment">     * not able to execute the shell).</span></div><div class="line"><a name="l01897"></a><span class="lineno"> 1897</span>&#160;<span class="comment">     * Try finding a swap file by simply adding &quot;.swp&quot; to the file name.</span></div><div class="line"><a name="l01898"></a><span class="lineno"> 1898</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l01899"></a><span class="lineno"> 1899</span>&#160;    <span class="keywordflow">if</span> (*dirp == <a class="code" href="ascii_8h.html#af19d48b9f61047a668649a2f9dc317ff">NUL</a> &amp;&amp; file_count + num_files == 0 &amp;&amp; fname != NULL)</div><div class="line"><a name="l01900"></a><span class="lineno"> 1900</span>&#160;    {</div><div class="line"><a name="l01901"></a><span class="lineno"> 1901</span>&#160;        <a class="code" href="vim_8h.html#a3206c537c639e0f26013f6cf909bd0e0">stat_T</a>      st;</div><div class="line"><a name="l01902"></a><span class="lineno"> 1902</span>&#160;        char_u      *swapname;</div><div class="line"><a name="l01903"></a><span class="lineno"> 1903</span>&#160;</div><div class="line"><a name="l01904"></a><span class="lineno"> 1904</span>&#160;        swapname = <a class="code" href="fileio_8c.html#aac79f705198b1f5212fd7f7bba16b852">modname</a>(fname_res,</div><div class="line"><a name="l01905"></a><span class="lineno"> 1905</span>&#160;#<span class="keywordflow">if</span> defined(VMS)</div><div class="line"><a name="l01906"></a><span class="lineno"> 1906</span>&#160;                   (char_u *)<span class="stringliteral">&quot;_swp&quot;</span>, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a></div><div class="line"><a name="l01907"></a><span class="lineno"> 1907</span>&#160;#<span class="keywordflow">else</span></div><div class="line"><a name="l01908"></a><span class="lineno"> 1908</span>&#160;                   (char_u *)<span class="stringliteral">&quot;.swp&quot;</span>, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a></div><div class="line"><a name="l01909"></a><span class="lineno"> 1909</span>&#160;#endif</div><div class="line"><a name="l01910"></a><span class="lineno"> 1910</span>&#160;                  );</div><div class="line"><a name="l01911"></a><span class="lineno"> 1911</span>&#160;        <span class="keywordflow">if</span> (swapname != NULL)</div><div class="line"><a name="l01912"></a><span class="lineno"> 1912</span>&#160;        {</div><div class="line"><a name="l01913"></a><span class="lineno"> 1913</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="macros_8h.html#af9221f9667cc05a05b4646b2aa31e233">mch_stat</a>((<span class="keywordtype">char</span> *)swapname, &amp;st) != -1)    <span class="comment">// It exists!</span></div><div class="line"><a name="l01914"></a><span class="lineno"> 1914</span>&#160;        {</div><div class="line"><a name="l01915"></a><span class="lineno"> 1915</span>&#160;            files = <a class="code" href="vim_8h.html#aa7847d468c459f481f1bfc3b82526b20">ALLOC_ONE</a>(char_u *);</div><div class="line"><a name="l01916"></a><span class="lineno"> 1916</span>&#160;            <span class="keywordflow">if</span> (files != NULL)</div><div class="line"><a name="l01917"></a><span class="lineno"> 1917</span>&#160;            {</div><div class="line"><a name="l01918"></a><span class="lineno"> 1918</span>&#160;            files[0] = swapname;</div><div class="line"><a name="l01919"></a><span class="lineno"> 1919</span>&#160;            swapname = NULL;</div><div class="line"><a name="l01920"></a><span class="lineno"> 1920</span>&#160;            num_files = 1;</div><div class="line"><a name="l01921"></a><span class="lineno"> 1921</span>&#160;            }</div><div class="line"><a name="l01922"></a><span class="lineno"> 1922</span>&#160;        }</div><div class="line"><a name="l01923"></a><span class="lineno"> 1923</span>&#160;        <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(swapname);</div><div class="line"><a name="l01924"></a><span class="lineno"> 1924</span>&#160;        }</div><div class="line"><a name="l01925"></a><span class="lineno"> 1925</span>&#160;    }</div><div class="line"><a name="l01926"></a><span class="lineno"> 1926</span>&#160;</div><div class="line"><a name="l01927"></a><span class="lineno"> 1927</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l01928"></a><span class="lineno"> 1928</span>&#160;<span class="comment">     * remove swapfile name of the current buffer, it must be ignored</span></div><div class="line"><a name="l01929"></a><span class="lineno"> 1929</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l01930"></a><span class="lineno"> 1930</span>&#160;    <span class="keywordflow">if</span> (curbuf-&gt;b_ml.ml_mfp != NULL</div><div class="line"><a name="l01931"></a><span class="lineno"> 1931</span>&#160;                   &amp;&amp; (p = curbuf-&gt;b_ml.ml_mfp-&gt;mf_fname) != NULL)</div><div class="line"><a name="l01932"></a><span class="lineno"> 1932</span>&#160;    {</div><div class="line"><a name="l01933"></a><span class="lineno"> 1933</span>&#160;        <span class="keywordflow">for</span> (i = 0; i &lt; num_files; ++i)</div><div class="line"><a name="l01934"></a><span class="lineno"> 1934</span>&#160;        <span class="comment">// Do not expand wildcards, on windows would try to expand</span></div><div class="line"><a name="l01935"></a><span class="lineno"> 1935</span>&#160;        <span class="comment">// &quot;%tmp%&quot; in &quot;%tmp%file&quot;.</span></div><div class="line"><a name="l01936"></a><span class="lineno"> 1936</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="filepath_8c.html#af742ef578f2b4a17bce91b6ca6a8a7c6">fullpathcmp</a>(p, files[i], <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) &amp; <a class="code" href="vim_8h.html#a54e78aad180f304a56df62e51adbeb39">FPC_SAME</a>)</div><div class="line"><a name="l01937"></a><span class="lineno"> 1937</span>&#160;        {</div><div class="line"><a name="l01938"></a><span class="lineno"> 1938</span>&#160;            <span class="comment">// Remove the name from files[i].  Move further entries</span></div><div class="line"><a name="l01939"></a><span class="lineno"> 1939</span>&#160;            <span class="comment">// down.  When the array becomes empty free it here, since</span></div><div class="line"><a name="l01940"></a><span class="lineno"> 1940</span>&#160;            <span class="comment">// FreeWild() won&#39;t be called below.</span></div><div class="line"><a name="l01941"></a><span class="lineno"> 1941</span>&#160;            <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(files[i]);</div><div class="line"><a name="l01942"></a><span class="lineno"> 1942</span>&#160;            <span class="keywordflow">if</span> (--num_files == 0)</div><div class="line"><a name="l01943"></a><span class="lineno"> 1943</span>&#160;            <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(files);</div><div class="line"><a name="l01944"></a><span class="lineno"> 1944</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l01945"></a><span class="lineno"> 1945</span>&#160;            <span class="keywordflow">for</span> ( ; i &lt; num_files; ++i)</div><div class="line"><a name="l01946"></a><span class="lineno"> 1946</span>&#160;                files[i] = files[i + 1];</div><div class="line"><a name="l01947"></a><span class="lineno"> 1947</span>&#160;        }</div><div class="line"><a name="l01948"></a><span class="lineno"> 1948</span>&#160;    }</div><div class="line"><a name="l01949"></a><span class="lineno"> 1949</span>&#160;    <span class="keywordflow">if</span> (nr &gt; 0)</div><div class="line"><a name="l01950"></a><span class="lineno"> 1950</span>&#160;    {</div><div class="line"><a name="l01951"></a><span class="lineno"> 1951</span>&#160;        file_count += num_files;</div><div class="line"><a name="l01952"></a><span class="lineno"> 1952</span>&#160;        <span class="keywordflow">if</span> (nr &lt;= file_count)</div><div class="line"><a name="l01953"></a><span class="lineno"> 1953</span>&#160;        {</div><div class="line"><a name="l01954"></a><span class="lineno"> 1954</span>&#160;        *fname_out = <a class="code" href="misc2_8c.html#acd554ee46804f666060916bf740b3c96">vim_strsave</a>(</div><div class="line"><a name="l01955"></a><span class="lineno"> 1955</span>&#160;                      files[nr - 1 + num_files - file_count]);</div><div class="line"><a name="l01956"></a><span class="lineno"> 1956</span>&#160;        dirp = (char_u *)<span class="stringliteral">&quot;&quot;</span>;            <span class="comment">/* stop searching */</span></div><div class="line"><a name="l01957"></a><span class="lineno"> 1957</span>&#160;        }</div><div class="line"><a name="l01958"></a><span class="lineno"> 1958</span>&#160;    }</div><div class="line"><a name="l01959"></a><span class="lineno"> 1959</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (list)</div><div class="line"><a name="l01960"></a><span class="lineno"> 1960</span>&#160;    {</div><div class="line"><a name="l01961"></a><span class="lineno"> 1961</span>&#160;        <span class="keywordflow">if</span> (dir_name[0] == <span class="charliteral">&#39;.&#39;</span> &amp;&amp; dir_name[1] == <a class="code" href="ascii_8h.html#af19d48b9f61047a668649a2f9dc317ff">NUL</a>)</div><div class="line"><a name="l01962"></a><span class="lineno"> 1962</span>&#160;        {</div><div class="line"><a name="l01963"></a><span class="lineno"> 1963</span>&#160;        <span class="keywordflow">if</span> (fname == NULL)</div><div class="line"><a name="l01964"></a><span class="lineno"> 1964</span>&#160;            <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;   In current directory:\n&quot;</span>));</div><div class="line"><a name="l01965"></a><span class="lineno"> 1965</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l01966"></a><span class="lineno"> 1966</span>&#160;            <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;   Using specified name:\n&quot;</span>));</div><div class="line"><a name="l01967"></a><span class="lineno"> 1967</span>&#160;        }</div><div class="line"><a name="l01968"></a><span class="lineno"> 1968</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l01969"></a><span class="lineno"> 1969</span>&#160;        {</div><div class="line"><a name="l01970"></a><span class="lineno"> 1970</span>&#160;        <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;   In directory &quot;</span>));</div><div class="line"><a name="l01971"></a><span class="lineno"> 1971</span>&#160;        <a class="code" href="message_8c.html#aa4a7a34db68561f1e14a20524dbbc4c1">msg_home_replace</a>(dir_name);</div><div class="line"><a name="l01972"></a><span class="lineno"> 1972</span>&#160;        <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<span class="stringliteral">&quot;:\n&quot;</span>);</div><div class="line"><a name="l01973"></a><span class="lineno"> 1973</span>&#160;        }</div><div class="line"><a name="l01974"></a><span class="lineno"> 1974</span>&#160;</div><div class="line"><a name="l01975"></a><span class="lineno"> 1975</span>&#160;        <span class="keywordflow">if</span> (num_files)</div><div class="line"><a name="l01976"></a><span class="lineno"> 1976</span>&#160;        {</div><div class="line"><a name="l01977"></a><span class="lineno"> 1977</span>&#160;        <span class="keywordflow">for</span> (i = 0; i &lt; num_files; ++i)</div><div class="line"><a name="l01978"></a><span class="lineno"> 1978</span>&#160;        {</div><div class="line"><a name="l01979"></a><span class="lineno"> 1979</span>&#160;            <span class="comment">/* print the swap file name */</span></div><div class="line"><a name="l01980"></a><span class="lineno"> 1980</span>&#160;            <a class="code" href="message_8c.html#a9495c4f4da600498d1482fb292c4c97b">msg_outnum</a>((<span class="keywordtype">long</span>)++file_count);</div><div class="line"><a name="l01981"></a><span class="lineno"> 1981</span>&#160;            <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<span class="stringliteral">&quot;.    &quot;</span>);</div><div class="line"><a name="l01982"></a><span class="lineno"> 1982</span>&#160;            <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>((<span class="keywordtype">char</span> *)<a class="code" href="filepath_8c.html#a3a027a38b217222ac4d9ebe8ce5c1947">gettail</a>(files[i]));</div><div class="line"><a name="l01983"></a><span class="lineno"> 1983</span>&#160;            <a class="code" href="message_8c.html#ae0edfa8d1999c41726a759fd06a1ab6e">msg_putchar</a>(<span class="charliteral">&#39;\n&#39;</span>);</div><div class="line"><a name="l01984"></a><span class="lineno"> 1984</span>&#160;            (void)<a class="code" href="memline_8c.html#aad2a8c25b4deee1b1fec00478af75568">swapfile_info</a>(files[i]);</div><div class="line"><a name="l01985"></a><span class="lineno"> 1985</span>&#160;        }</div><div class="line"><a name="l01986"></a><span class="lineno"> 1986</span>&#160;        }</div><div class="line"><a name="l01987"></a><span class="lineno"> 1987</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l01988"></a><span class="lineno"> 1988</span>&#160;        <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;      -- none --\n&quot;</span>));</div><div class="line"><a name="l01989"></a><span class="lineno"> 1989</span>&#160;        <a class="code" href="term_8c.html#a696dc856975fd30035140f53329ba0ef">out_flush</a>();</div><div class="line"><a name="l01990"></a><span class="lineno"> 1990</span>&#160;    }</div><div class="line"><a name="l01991"></a><span class="lineno"> 1991</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01992"></a><span class="lineno"> 1992</span>&#160;        file_count += num_files;</div><div class="line"><a name="l01993"></a><span class="lineno"> 1993</span>&#160;</div><div class="line"><a name="l01994"></a><span class="lineno"> 1994</span>&#160;    <span class="keywordflow">for</span> (i = 0; i &lt; num_names; ++i)</div><div class="line"><a name="l01995"></a><span class="lineno"> 1995</span>&#160;        <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(names[i]);</div><div class="line"><a name="l01996"></a><span class="lineno"> 1996</span>&#160;    <span class="keywordflow">if</span> (num_files &gt; 0)</div><div class="line"><a name="l01997"></a><span class="lineno"> 1997</span>&#160;        <a class="code" href="filepath_8c.html#a5086b658043e0a5bf23116fb75b8936e">FreeWild</a>(num_files, files);</div><div class="line"><a name="l01998"></a><span class="lineno"> 1998</span>&#160;    }</div><div class="line"><a name="l01999"></a><span class="lineno"> 1999</span>&#160;    <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(dir_name);</div><div class="line"><a name="l02000"></a><span class="lineno"> 2000</span>&#160;    <span class="keywordflow">return</span> file_count;</div><div class="line"><a name="l02001"></a><span class="lineno"> 2001</span>&#160;}</div><div class="line"><a name="l02002"></a><span class="lineno"> 2002</span>&#160;</div><div class="line"><a name="l02003"></a><span class="lineno"> 2003</span>&#160;<span class="preprocessor">#if defined(UNIX) || defined(MSWIN) || defined(PROTO)</span></div><div class="line"><a name="l02004"></a><span class="lineno"> 2004</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l02005"></a><span class="lineno"> 2005</span>&#160;<span class="comment"> * Need _very_ long file names.</span></div><div class="line"><a name="l02006"></a><span class="lineno"> 2006</span>&#160;<span class="comment"> * Append the full path to name with path separators made into percent</span></div><div class="line"><a name="l02007"></a><span class="lineno"> 2007</span>&#160;<span class="comment"> * signs, to dir. An unnamed buffer is handled as &quot;&quot; (&lt;currentdir&gt;/&quot;&quot;)</span></div><div class="line"><a name="l02008"></a><span class="lineno"> 2008</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l02009"></a><span class="lineno"> 2009</span>&#160;    char_u *</div><div class="line"><a name="l02010"></a><span class="lineno"> 2010</span>&#160;make_percent_swname(char_u *<a class="code" href="namespacemodule.html#a2bbb1992c2d099148f717cbd67c51561">dir</a>, char_u *<a class="code" href="dosinst_8h.html#a5ac083a645d964373f022d03df4849c8">name</a>)</div><div class="line"><a name="l02011"></a><span class="lineno"> 2011</span>&#160;{</div><div class="line"><a name="l02012"></a><span class="lineno"> 2012</span>&#160;    char_u *<a class="code" href="namespacedehqx.html#aa833403a763c179f4ce8087adc050961">d</a> = NULL, *s, *<a class="code" href="hangulin_8c.html#a362077c979b0bb65159c603270e40f70">f</a>;</div><div class="line"><a name="l02013"></a><span class="lineno"> 2013</span>&#160;</div><div class="line"><a name="l02014"></a><span class="lineno"> 2014</span>&#160;    f = <a class="code" href="buffer_8c.html#a078f5780434ad5529f1ff13d4b14dc20">fix_fname</a>(name != NULL ? name : (char_u *)<span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l02015"></a><span class="lineno"> 2015</span>&#160;    <span class="keywordflow">if</span> (f != NULL)</div><div class="line"><a name="l02016"></a><span class="lineno"> 2016</span>&#160;    {</div><div class="line"><a name="l02017"></a><span class="lineno"> 2017</span>&#160;    s = <a class="code" href="misc2_8c.html#ad0b64e14955781629a3908e328f82665">alloc</a>(<a class="code" href="vim_8h.html#a916ffefe1fc74532d08102cca55d8e34">STRLEN</a>(f) + 1);</div><div class="line"><a name="l02018"></a><span class="lineno"> 2018</span>&#160;    <span class="keywordflow">if</span> (s != NULL)</div><div class="line"><a name="l02019"></a><span class="lineno"> 2019</span>&#160;    {</div><div class="line"><a name="l02020"></a><span class="lineno"> 2020</span>&#160;        <a class="code" href="vim_8h.html#aa9cea5fcb1483307770f365fb24aa08d">STRCPY</a>(s, f);</div><div class="line"><a name="l02021"></a><span class="lineno"> 2021</span>&#160;        <span class="keywordflow">for</span> (d = s; *d != <a class="code" href="ascii_8h.html#af19d48b9f61047a668649a2f9dc317ff">NUL</a>; <a class="code" href="macros_8h.html#a8e76521a98776d2e3f9b33fcb331dcee">MB_PTR_ADV</a>(d))</div><div class="line"><a name="l02022"></a><span class="lineno"> 2022</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="filepath_8c.html#acb4aef03c801e568565f34c9e10d25cf">vim_ispathsep</a>(*d))</div><div class="line"><a name="l02023"></a><span class="lineno"> 2023</span>&#160;            *d = <span class="charliteral">&#39;%&#39;</span>;</div><div class="line"><a name="l02024"></a><span class="lineno"> 2024</span>&#160;        d = <a class="code" href="filepath_8c.html#a8de478b7b0307fbc7b4aab47648ecb0c">concat_fnames</a>(<a class="code" href="namespacemodule.html#a2bbb1992c2d099148f717cbd67c51561">dir</a>, s, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div><div class="line"><a name="l02025"></a><span class="lineno"> 2025</span>&#160;        <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(s);</div><div class="line"><a name="l02026"></a><span class="lineno"> 2026</span>&#160;    }</div><div class="line"><a name="l02027"></a><span class="lineno"> 2027</span>&#160;    <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(f);</div><div class="line"><a name="l02028"></a><span class="lineno"> 2028</span>&#160;    }</div><div class="line"><a name="l02029"></a><span class="lineno"> 2029</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="namespacedehqx.html#aa833403a763c179f4ce8087adc050961">d</a>;</div><div class="line"><a name="l02030"></a><span class="lineno"> 2030</span>&#160;}</div><div class="line"><a name="l02031"></a><span class="lineno"> 2031</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l02032"></a><span class="lineno"> 2032</span>&#160;</div><div class="line"><a name="l02033"></a><span class="lineno"> 2033</span>&#160;<span class="preprocessor">#if (defined(UNIX) || defined(VMS) || defined(MSWIN)) \</span></div><div class="line"><a name="l02034"></a><span class="lineno"> 2034</span>&#160;<span class="preprocessor">    &amp;&amp; (defined(FEAT_GUI_DIALOG) || defined(FEAT_CON_DIALOG))</span></div><div class="line"><a name="l02035"></a><span class="lineno"> 2035</span>&#160;<span class="preprocessor"># define HAVE_PROCESS_STILL_RUNNING</span></div><div class="line"><a name="l02036"></a><span class="lineno"> 2036</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> process_still_running;</div><div class="line"><a name="l02037"></a><span class="lineno"> 2037</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l02038"></a><span class="lineno"> 2038</span>&#160;</div><div class="line"><a name="l02039"></a><span class="lineno"> 2039</span>&#160;<span class="preprocessor">#if defined(FEAT_EVAL) || defined(PROTO)</span></div><div class="line"><a name="l02040"></a><span class="lineno"> 2040</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l02041"></a><span class="lineno"> 2041</span>&#160;<span class="comment"> * Return information found in swapfile &quot;fname&quot; in dictionary &quot;d&quot;.</span></div><div class="line"><a name="l02042"></a><span class="lineno"> 2042</span>&#160;<span class="comment"> * This is used by the swapinfo() function.</span></div><div class="line"><a name="l02043"></a><span class="lineno"> 2043</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l02044"></a><span class="lineno"> 2044</span>&#160;    <span class="keywordtype">void</span></div><div class="line"><a name="l02045"></a><span class="lineno"><a class="line" href="memline_8c.html#ab9c47f1eaa4e6331a8a3369fc5b84a6f"> 2045</a></span>&#160;<a class="code" href="memline_8c.html#ab9c47f1eaa4e6331a8a3369fc5b84a6f">get_b0_dict</a>(char_u *fname, <a class="code" href="structdictvar___s.html">dict_T</a> *<a class="code" href="namespacedehqx.html#aa833403a763c179f4ce8087adc050961">d</a>)</div><div class="line"><a name="l02046"></a><span class="lineno"> 2046</span>&#160;{</div><div class="line"><a name="l02047"></a><span class="lineno"> 2047</span>&#160;    <span class="keywordtype">int</span> fd;</div><div class="line"><a name="l02048"></a><span class="lineno"> 2048</span>&#160;    <span class="keyword">struct </span><a class="code" href="structblock0.html">block0</a> b0;</div><div class="line"><a name="l02049"></a><span class="lineno"> 2049</span>&#160;</div><div class="line"><a name="l02050"></a><span class="lineno"> 2050</span>&#160;    <span class="keywordflow">if</span> ((fd = <a class="code" href="os__win32_8c.html#a86a6c2e2a013622ad468bcdbc07bbfd6">mch_open</a>((<span class="keywordtype">char</span> *)fname, O_RDONLY | <a class="code" href="vim_8h.html#a9f1019b10a1c51d588f4500cde3a6746">O_EXTRA</a>, 0)) &gt;= 0)</div><div class="line"><a name="l02051"></a><span class="lineno"> 2051</span>&#160;    {</div><div class="line"><a name="l02052"></a><span class="lineno"> 2052</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="vim_8h.html#aad0d6768ce2f916f7c643be49f87a368">read_eintr</a>(fd, &amp;b0, <span class="keyword">sizeof</span>(b0)) == <span class="keyword">sizeof</span>(b0))</div><div class="line"><a name="l02053"></a><span class="lineno"> 2053</span>&#160;    {</div><div class="line"><a name="l02054"></a><span class="lineno"> 2054</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="memline_8c.html#a7c54be0e5b07e1fe53155d1174a746e8">ml_check_b0_id</a>(&amp;b0) == <a class="code" href="dosinst_8h.html#abb508ea8227673f419e9fe3a86c30d8e">FAIL</a>)</div><div class="line"><a name="l02055"></a><span class="lineno"> 2055</span>&#160;        <a class="code" href="dict_8c.html#a759ca75bf61d60f49e272e193842c455">dict_add_string</a>(d, <span class="stringliteral">&quot;error&quot;</span>, (char_u *)<span class="stringliteral">&quot;Not a swap file&quot;</span>);</div><div class="line"><a name="l02056"></a><span class="lineno"> 2056</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="memline_8c.html#a28648170c5d102a305afeeecf23cc0ca">b0_magic_wrong</a>(&amp;b0))</div><div class="line"><a name="l02057"></a><span class="lineno"> 2057</span>&#160;        <a class="code" href="dict_8c.html#a759ca75bf61d60f49e272e193842c455">dict_add_string</a>(d, <span class="stringliteral">&quot;error&quot;</span>, (char_u *)<span class="stringliteral">&quot;Magic number mismatch&quot;</span>);</div><div class="line"><a name="l02058"></a><span class="lineno"> 2058</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l02059"></a><span class="lineno"> 2059</span>&#160;        {</div><div class="line"><a name="l02060"></a><span class="lineno"> 2060</span>&#160;        <span class="comment">/* we have swap information */</span></div><div class="line"><a name="l02061"></a><span class="lineno"> 2061</span>&#160;        <a class="code" href="dict_8c.html#aa53a3b4e6d3d544d68f44dd1ea1928c0">dict_add_string_len</a>(d, <span class="stringliteral">&quot;version&quot;</span>, b0.<a class="code" href="structblock0.html#a5f6ec025350776e0dbe8d0ab54daadc3">b0_version</a>, 10);</div><div class="line"><a name="l02062"></a><span class="lineno"> 2062</span>&#160;        <a class="code" href="dict_8c.html#aa53a3b4e6d3d544d68f44dd1ea1928c0">dict_add_string_len</a>(d, <span class="stringliteral">&quot;user&quot;</span>, b0.<a class="code" href="structblock0.html#aab3e8eda9003c121be3914c9606854b6">b0_uname</a>, <a class="code" href="memline_8c.html#a67d0b82009004217400bc8708acf4c06">B0_UNAME_SIZE</a>);</div><div class="line"><a name="l02063"></a><span class="lineno"> 2063</span>&#160;        <a class="code" href="dict_8c.html#aa53a3b4e6d3d544d68f44dd1ea1928c0">dict_add_string_len</a>(d, <span class="stringliteral">&quot;host&quot;</span>, b0.<a class="code" href="structblock0.html#a8b0cab71ba5453122bcd862fe3d368ca">b0_hname</a>, <a class="code" href="memline_8c.html#aab71d171eeeefa498adf1f5f725cd010">B0_HNAME_SIZE</a>);</div><div class="line"><a name="l02064"></a><span class="lineno"> 2064</span>&#160;        <a class="code" href="dict_8c.html#aa53a3b4e6d3d544d68f44dd1ea1928c0">dict_add_string_len</a>(d, <span class="stringliteral">&quot;fname&quot;</span>, b0.<a class="code" href="structblock0.html#a619635d3effa9f2496dd6662e20b9037">b0_fname</a>, <a class="code" href="memline_8c.html#a3d4cf908356280e457ffbd11d449b11b">B0_FNAME_SIZE_ORG</a>);</div><div class="line"><a name="l02065"></a><span class="lineno"> 2065</span>&#160;</div><div class="line"><a name="l02066"></a><span class="lineno"> 2066</span>&#160;        <a class="code" href="dict_8c.html#a19be416abede1c238aca79a809ed7676">dict_add_number</a>(d, <span class="stringliteral">&quot;pid&quot;</span>, <a class="code" href="memline_8c.html#a996b07c0a0e4f04f7b205f4c3ba2a797">char_to_long</a>(b0.<a class="code" href="structblock0.html#ab702799b723f108b57a8b73f83e70346">b0_pid</a>));</div><div class="line"><a name="l02067"></a><span class="lineno"> 2067</span>&#160;        <a class="code" href="dict_8c.html#a19be416abede1c238aca79a809ed7676">dict_add_number</a>(d, <span class="stringliteral">&quot;mtime&quot;</span>, <a class="code" href="memline_8c.html#a996b07c0a0e4f04f7b205f4c3ba2a797">char_to_long</a>(b0.<a class="code" href="structblock0.html#a9055bedd111a57a03cc1987905bb4ae0">b0_mtime</a>));</div><div class="line"><a name="l02068"></a><span class="lineno"> 2068</span>&#160;        <a class="code" href="dict_8c.html#a19be416abede1c238aca79a809ed7676">dict_add_number</a>(d, <span class="stringliteral">&quot;dirty&quot;</span>, b0.b0_dirty ? 1 : 0);</div><div class="line"><a name="l02069"></a><span class="lineno"> 2069</span>&#160;<span class="preprocessor"># ifdef CHECK_INODE</span></div><div class="line"><a name="l02070"></a><span class="lineno"> 2070</span>&#160;        <a class="code" href="dict_8c.html#a19be416abede1c238aca79a809ed7676">dict_add_number</a>(d, <span class="stringliteral">&quot;inode&quot;</span>, <a class="code" href="memline_8c.html#a996b07c0a0e4f04f7b205f4c3ba2a797">char_to_long</a>(b0.<a class="code" href="structblock0.html#a3930b3adc922aba997caf28ad8d8e6a4">b0_ino</a>));</div><div class="line"><a name="l02071"></a><span class="lineno"> 2071</span>&#160;<span class="preprocessor"># endif</span></div><div class="line"><a name="l02072"></a><span class="lineno"> 2072</span>&#160;        }</div><div class="line"><a name="l02073"></a><span class="lineno"> 2073</span>&#160;    }</div><div class="line"><a name="l02074"></a><span class="lineno"> 2074</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l02075"></a><span class="lineno"> 2075</span>&#160;        <a class="code" href="dict_8c.html#a759ca75bf61d60f49e272e193842c455">dict_add_string</a>(d, <span class="stringliteral">&quot;error&quot;</span>, (char_u *)<span class="stringliteral">&quot;Cannot read file&quot;</span>);</div><div class="line"><a name="l02076"></a><span class="lineno"> 2076</span>&#160;    close(fd);</div><div class="line"><a name="l02077"></a><span class="lineno"> 2077</span>&#160;    }</div><div class="line"><a name="l02078"></a><span class="lineno"> 2078</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l02079"></a><span class="lineno"> 2079</span>&#160;    <a class="code" href="dict_8c.html#a759ca75bf61d60f49e272e193842c455">dict_add_string</a>(d, <span class="stringliteral">&quot;error&quot;</span>, (char_u *)<span class="stringliteral">&quot;Cannot open file&quot;</span>);</div><div class="line"><a name="l02080"></a><span class="lineno"> 2080</span>&#160;}</div><div class="line"><a name="l02081"></a><span class="lineno"> 2081</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l02082"></a><span class="lineno"> 2082</span>&#160;</div><div class="line"><a name="l02083"></a><span class="lineno"> 2083</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l02084"></a><span class="lineno"> 2084</span>&#160;<span class="comment"> * Cache of the current timezone name as retrieved from TZ, or an empty string</span></div><div class="line"><a name="l02085"></a><span class="lineno"> 2085</span>&#160;<span class="comment"> * where unset, up to 64 octets long including trailing null byte.</span></div><div class="line"><a name="l02086"></a><span class="lineno"> 2086</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l02087"></a><span class="lineno"> 2087</span>&#160;<span class="preprocessor">#if defined(HAVE_LOCALTIME_R) &amp;&amp; defined(HAVE_TZSET)</span></div><div class="line"><a name="l02088"></a><span class="lineno"> 2088</span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> tz_cache[64];</div><div class="line"><a name="l02089"></a><span class="lineno"> 2089</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l02090"></a><span class="lineno"> 2090</span>&#160;</div><div class="line"><a name="l02091"></a><span class="lineno"> 2091</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l02092"></a><span class="lineno"> 2092</span>&#160;<span class="comment"> * Call either localtime(3) or localtime_r(3) from POSIX libc time.h, with the</span></div><div class="line"><a name="l02093"></a><span class="lineno"> 2093</span>&#160;<span class="comment"> * latter version preferred for reentrancy.</span></div><div class="line"><a name="l02094"></a><span class="lineno"> 2094</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l02095"></a><span class="lineno"> 2095</span>&#160;<span class="comment"> * If we use localtime_r(3) and we have tzset(3) available, check to see if the</span></div><div class="line"><a name="l02096"></a><span class="lineno"> 2096</span>&#160;<span class="comment"> * environment variable TZ has changed since the last run, and call tzset(3) to</span></div><div class="line"><a name="l02097"></a><span class="lineno"> 2097</span>&#160;<span class="comment"> * update the global timezone variables if it has.  This is because the POSIX</span></div><div class="line"><a name="l02098"></a><span class="lineno"> 2098</span>&#160;<span class="comment"> * standard doesn&#39;t require localtime_r(3) implementations to do that as it</span></div><div class="line"><a name="l02099"></a><span class="lineno"> 2099</span>&#160;<span class="comment"> * does with localtime(3), and we don&#39;t want to call tzset(3) every time.</span></div><div class="line"><a name="l02100"></a><span class="lineno"> 2100</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l02101"></a><span class="lineno"> 2101</span>&#160;    <span class="keyword">struct </span>tm *</div><div class="line"><a name="l02102"></a><span class="lineno"><a class="line" href="memline_8c.html#af38a893593cb2264fbd2b47e7150db1a"> 2102</a></span>&#160;<a class="code" href="memline_8c.html#af38a893593cb2264fbd2b47e7150db1a">vim_localtime</a>(</div><div class="line"><a name="l02103"></a><span class="lineno"> 2103</span>&#160;    <span class="keyword">const</span> time_t    *timep,     <span class="comment">// timestamp for local representation</span></div><div class="line"><a name="l02104"></a><span class="lineno"> 2104</span>&#160;    <span class="keyword">struct</span> tm       *result <a class="code" href="vterm__internal_8h.html#addf5ec070e9499d36b7f2009ce736076">UNUSED</a>) <span class="comment">// pointer to caller return buffer</span></div><div class="line"><a name="l02105"></a><span class="lineno"> 2105</span>&#160;{</div><div class="line"><a name="l02106"></a><span class="lineno"> 2106</span>&#160;<span class="preprocessor">#ifdef HAVE_LOCALTIME_R</span></div><div class="line"><a name="l02107"></a><span class="lineno"> 2107</span>&#160;<span class="preprocessor"># ifdef HAVE_TZSET</span></div><div class="line"><a name="l02108"></a><span class="lineno"> 2108</span>&#160;    <span class="keywordtype">char</span>        *tz;        <span class="comment">// pointer for TZ environment var</span></div><div class="line"><a name="l02109"></a><span class="lineno"> 2109</span>&#160;</div><div class="line"><a name="l02110"></a><span class="lineno"> 2110</span>&#160;    tz = (<span class="keywordtype">char</span> *)<a class="code" href="os__mac_8h.html#a283d38eb9b5da9a7092ee0954d4e5a14">mch_getenv</a>((char_u *)<span class="stringliteral">&quot;TZ&quot;</span>);</div><div class="line"><a name="l02111"></a><span class="lineno"> 2111</span>&#160;    <span class="keywordflow">if</span> (tz == NULL)</div><div class="line"><a name="l02112"></a><span class="lineno"> 2112</span>&#160;    tz = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l02113"></a><span class="lineno"> 2113</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="vim_8h.html#a5f1ef744c34be69aec1531f1fe604a9b">STRNCMP</a>(tz_cache, tz, <span class="keyword">sizeof</span>(tz_cache) - 1) != 0)</div><div class="line"><a name="l02114"></a><span class="lineno"> 2114</span>&#160;    {</div><div class="line"><a name="l02115"></a><span class="lineno"> 2115</span>&#160;    tzset();</div><div class="line"><a name="l02116"></a><span class="lineno"> 2116</span>&#160;    <a class="code" href="misc2_8c.html#ab25a3a48241497fdc7bec2c3dbe41467">vim_strncpy</a>((char_u *)tz_cache, (char_u *)tz, <span class="keyword">sizeof</span>(tz_cache) - 1);</div><div class="line"><a name="l02117"></a><span class="lineno"> 2117</span>&#160;    }</div><div class="line"><a name="l02118"></a><span class="lineno"> 2118</span>&#160;<span class="preprocessor"># endif // HAVE_TZSET</span></div><div class="line"><a name="l02119"></a><span class="lineno"> 2119</span>&#160;    <span class="keywordflow">return</span> localtime_r(timep, result);</div><div class="line"><a name="l02120"></a><span class="lineno"> 2120</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l02121"></a><span class="lineno"> 2121</span>&#160;    <span class="keywordflow">return</span> localtime(timep);</div><div class="line"><a name="l02122"></a><span class="lineno"> 2122</span>&#160;<span class="preprocessor">#endif  // HAVE_LOCALTIME_R</span></div><div class="line"><a name="l02123"></a><span class="lineno"> 2123</span>&#160;}</div><div class="line"><a name="l02124"></a><span class="lineno"> 2124</span>&#160;</div><div class="line"><a name="l02125"></a><span class="lineno"> 2125</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l02126"></a><span class="lineno"> 2126</span>&#160;<span class="comment"> * Replacement for ctime(), which is not safe to use.</span></div><div class="line"><a name="l02127"></a><span class="lineno"> 2127</span>&#160;<span class="comment"> * Requires strftime(), otherwise returns &quot;(unknown)&quot;.</span></div><div class="line"><a name="l02128"></a><span class="lineno"> 2128</span>&#160;<span class="comment"> * If &quot;thetime&quot; is invalid returns &quot;(invalid)&quot;.  Never returns NULL.</span></div><div class="line"><a name="l02129"></a><span class="lineno"> 2129</span>&#160;<span class="comment"> * When &quot;add_newline&quot; is TRUE add a newline like ctime() does.</span></div><div class="line"><a name="l02130"></a><span class="lineno"> 2130</span>&#160;<span class="comment"> * Uses a static buffer.</span></div><div class="line"><a name="l02131"></a><span class="lineno"> 2131</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l02132"></a><span class="lineno"> 2132</span>&#160;    <span class="keywordtype">char</span> *</div><div class="line"><a name="l02133"></a><span class="lineno"><a class="line" href="memline_8c.html#a677f4728e1de4885d0d4fb8cb5774849"> 2133</a></span>&#160;<a class="code" href="memline_8c.html#a677f4728e1de4885d0d4fb8cb5774849">get_ctime</a>(time_t thetime, <span class="keywordtype">int</span> add_newline)</div><div class="line"><a name="l02134"></a><span class="lineno"> 2134</span>&#160;{</div><div class="line"><a name="l02135"></a><span class="lineno"> 2135</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">char</span> buf[50];</div><div class="line"><a name="l02136"></a><span class="lineno"> 2136</span>&#160;<span class="preprocessor">#ifdef HAVE_STRFTIME</span></div><div class="line"><a name="l02137"></a><span class="lineno"> 2137</span>&#160;    <span class="keyword">struct </span>tm   tmval;</div><div class="line"><a name="l02138"></a><span class="lineno"> 2138</span>&#160;    <span class="keyword">struct </span>tm   *curtime;</div><div class="line"><a name="l02139"></a><span class="lineno"> 2139</span>&#160;</div><div class="line"><a name="l02140"></a><span class="lineno"> 2140</span>&#160;    curtime = <a class="code" href="memline_8c.html#af38a893593cb2264fbd2b47e7150db1a">vim_localtime</a>(&amp;thetime, &amp;tmval);</div><div class="line"><a name="l02141"></a><span class="lineno"> 2141</span>&#160;    <span class="comment">/* MSVC returns NULL for an invalid value of seconds. */</span></div><div class="line"><a name="l02142"></a><span class="lineno"> 2142</span>&#160;    <span class="keywordflow">if</span> (curtime == NULL)</div><div class="line"><a name="l02143"></a><span class="lineno"> 2143</span>&#160;    <a class="code" href="misc2_8c.html#ab25a3a48241497fdc7bec2c3dbe41467">vim_strncpy</a>((char_u *)buf, (char_u *)<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;(Invalid)&quot;</span>), <span class="keyword">sizeof</span>(buf) - 1);</div><div class="line"><a name="l02144"></a><span class="lineno"> 2144</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l02145"></a><span class="lineno"> 2145</span>&#160;    {</div><div class="line"><a name="l02146"></a><span class="lineno"> 2146</span>&#160;    (void)strftime(buf, <span class="keyword">sizeof</span>(buf) - 1, <a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;%a %b %d %H:%M:%S %Y&quot;</span>),</div><div class="line"><a name="l02147"></a><span class="lineno"> 2147</span>&#160;                                    curtime);</div><div class="line"><a name="l02148"></a><span class="lineno"> 2148</span>&#160;<span class="preprocessor"># ifdef MSWIN</span></div><div class="line"><a name="l02149"></a><span class="lineno"> 2149</span>&#160;    <span class="keywordflow">if</span> (enc_codepage &gt;= 0 &amp;&amp; (<span class="keywordtype">int</span>)GetACP() != enc_codepage)</div><div class="line"><a name="l02150"></a><span class="lineno"> 2150</span>&#160;    {</div><div class="line"><a name="l02151"></a><span class="lineno"> 2151</span>&#160;        char_u  *to_free = NULL;</div><div class="line"><a name="l02152"></a><span class="lineno"> 2152</span>&#160;        <span class="keywordtype">int</span>     len;</div><div class="line"><a name="l02153"></a><span class="lineno"> 2153</span>&#160;</div><div class="line"><a name="l02154"></a><span class="lineno"> 2154</span>&#160;        <a class="code" href="winclip_8c.html#a559cf9d839c9be3c74d618cb6bf35c6c">acp_to_enc</a>((char_u *)buf, (<span class="keywordtype">int</span>)strlen(buf), &amp;to_free, &amp;len);</div><div class="line"><a name="l02155"></a><span class="lineno"> 2155</span>&#160;        <span class="keywordflow">if</span> (to_free != NULL)</div><div class="line"><a name="l02156"></a><span class="lineno"> 2156</span>&#160;        {</div><div class="line"><a name="l02157"></a><span class="lineno"> 2157</span>&#160;        <a class="code" href="vim_8h.html#aa9cea5fcb1483307770f365fb24aa08d">STRCPY</a>(buf, to_free);</div><div class="line"><a name="l02158"></a><span class="lineno"> 2158</span>&#160;        <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(to_free);</div><div class="line"><a name="l02159"></a><span class="lineno"> 2159</span>&#160;        }</div><div class="line"><a name="l02160"></a><span class="lineno"> 2160</span>&#160;    }</div><div class="line"><a name="l02161"></a><span class="lineno"> 2161</span>&#160;<span class="preprocessor"># endif</span></div><div class="line"><a name="l02162"></a><span class="lineno"> 2162</span>&#160;    }</div><div class="line"><a name="l02163"></a><span class="lineno"> 2163</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l02164"></a><span class="lineno"> 2164</span>&#160;    <a class="code" href="vim_8h.html#aa9cea5fcb1483307770f365fb24aa08d">STRCPY</a>(buf, <span class="stringliteral">&quot;(unknown)&quot;</span>);</div><div class="line"><a name="l02165"></a><span class="lineno"> 2165</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l02166"></a><span class="lineno"> 2166</span>&#160;    <span class="keywordflow">if</span> (add_newline)</div><div class="line"><a name="l02167"></a><span class="lineno"> 2167</span>&#160;    <a class="code" href="vim_8h.html#ada443375305fc60b73f44a59a2bf3f3b">STRCAT</a>(buf, <span class="stringliteral">&quot;\n&quot;</span>);</div><div class="line"><a name="l02168"></a><span class="lineno"> 2168</span>&#160;    <span class="keywordflow">return</span> buf;</div><div class="line"><a name="l02169"></a><span class="lineno"> 2169</span>&#160;}</div><div class="line"><a name="l02170"></a><span class="lineno"> 2170</span>&#160;</div><div class="line"><a name="l02171"></a><span class="lineno"> 2171</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l02172"></a><span class="lineno"> 2172</span>&#160;<span class="comment"> * Give information about an existing swap file.</span></div><div class="line"><a name="l02173"></a><span class="lineno"> 2173</span>&#160;<span class="comment"> * Returns timestamp (0 when unknown).</span></div><div class="line"><a name="l02174"></a><span class="lineno"> 2174</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l02175"></a><span class="lineno"> 2175</span>&#160;    <span class="keyword">static</span> time_t</div><div class="line"><a name="l02176"></a><span class="lineno"><a class="line" href="memline_8c.html#aad2a8c25b4deee1b1fec00478af75568"> 2176</a></span>&#160;<a class="code" href="memline_8c.html#aad2a8c25b4deee1b1fec00478af75568">swapfile_info</a>(char_u *fname)</div><div class="line"><a name="l02177"></a><span class="lineno"> 2177</span>&#160;{</div><div class="line"><a name="l02178"></a><span class="lineno"> 2178</span>&#160;    <a class="code" href="vim_8h.html#a3206c537c639e0f26013f6cf909bd0e0">stat_T</a>      st;</div><div class="line"><a name="l02179"></a><span class="lineno"> 2179</span>&#160;    <span class="keywordtype">int</span>         fd;</div><div class="line"><a name="l02180"></a><span class="lineno"> 2180</span>&#160;    <span class="keyword">struct </span><a class="code" href="structblock0.html">block0</a>   b0;</div><div class="line"><a name="l02181"></a><span class="lineno"> 2181</span>&#160;<span class="preprocessor">#ifdef UNIX</span></div><div class="line"><a name="l02182"></a><span class="lineno"> 2182</span>&#160;    char_u      uname[<a class="code" href="memline_8c.html#a67d0b82009004217400bc8708acf4c06">B0_UNAME_SIZE</a>];</div><div class="line"><a name="l02183"></a><span class="lineno"> 2183</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l02184"></a><span class="lineno"> 2184</span>&#160;</div><div class="line"><a name="l02185"></a><span class="lineno"> 2185</span>&#160;    <span class="comment">// print the swap file date</span></div><div class="line"><a name="l02186"></a><span class="lineno"> 2186</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="macros_8h.html#af9221f9667cc05a05b4646b2aa31e233">mch_stat</a>((<span class="keywordtype">char</span> *)fname, &amp;st) != -1)</div><div class="line"><a name="l02187"></a><span class="lineno"> 2187</span>&#160;    {</div><div class="line"><a name="l02188"></a><span class="lineno"> 2188</span>&#160;<span class="preprocessor">#ifdef UNIX</span></div><div class="line"><a name="l02189"></a><span class="lineno"> 2189</span>&#160;    <span class="comment">// print name of owner of the file</span></div><div class="line"><a name="l02190"></a><span class="lineno"> 2190</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="os__unix_8c.html#a64241cc23136bb6ab07b2d6b1fd826a0">mch_get_uname</a>(st.st_uid, uname, <a class="code" href="memline_8c.html#a67d0b82009004217400bc8708acf4c06">B0_UNAME_SIZE</a>) == <a class="code" href="dosinst_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>)</div><div class="line"><a name="l02191"></a><span class="lineno"> 2191</span>&#160;    {</div><div class="line"><a name="l02192"></a><span class="lineno"> 2192</span>&#160;        <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;          owned by: &quot;</span>));</div><div class="line"><a name="l02193"></a><span class="lineno"> 2193</span>&#160;        <a class="code" href="message_8c.html#a273e1e1a7e5b9b70db0a55edb73e303d">msg_outtrans</a>(uname);</div><div class="line"><a name="l02194"></a><span class="lineno"> 2194</span>&#160;        <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;   dated: &quot;</span>));</div><div class="line"><a name="l02195"></a><span class="lineno"> 2195</span>&#160;    }</div><div class="line"><a name="l02196"></a><span class="lineno"> 2196</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l02197"></a><span class="lineno"> 2197</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l02198"></a><span class="lineno"> 2198</span>&#160;        <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;             dated: &quot;</span>));</div><div class="line"><a name="l02199"></a><span class="lineno"> 2199</span>&#160;    <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="memline_8c.html#a677f4728e1de4885d0d4fb8cb5774849">get_ctime</a>(st.st_mtime, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>));</div><div class="line"><a name="l02200"></a><span class="lineno"> 2200</span>&#160;    }</div><div class="line"><a name="l02201"></a><span class="lineno"> 2201</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l02202"></a><span class="lineno"> 2202</span>&#160;    st.st_mtime = 0;</div><div class="line"><a name="l02203"></a><span class="lineno"> 2203</span>&#160;</div><div class="line"><a name="l02204"></a><span class="lineno"> 2204</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l02205"></a><span class="lineno"> 2205</span>&#160;<span class="comment">     * print the original file name</span></div><div class="line"><a name="l02206"></a><span class="lineno"> 2206</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l02207"></a><span class="lineno"> 2207</span>&#160;    fd = <a class="code" href="os__win32_8c.html#a86a6c2e2a013622ad468bcdbc07bbfd6">mch_open</a>((<span class="keywordtype">char</span> *)fname, O_RDONLY | <a class="code" href="vim_8h.html#a9f1019b10a1c51d588f4500cde3a6746">O_EXTRA</a>, 0);</div><div class="line"><a name="l02208"></a><span class="lineno"> 2208</span>&#160;    <span class="keywordflow">if</span> (fd &gt;= 0)</div><div class="line"><a name="l02209"></a><span class="lineno"> 2209</span>&#160;    {</div><div class="line"><a name="l02210"></a><span class="lineno"> 2210</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="vim_8h.html#aad0d6768ce2f916f7c643be49f87a368">read_eintr</a>(fd, &amp;b0, <span class="keyword">sizeof</span>(b0)) == <span class="keyword">sizeof</span>(b0))</div><div class="line"><a name="l02211"></a><span class="lineno"> 2211</span>&#160;    {</div><div class="line"><a name="l02212"></a><span class="lineno"> 2212</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="vim_8h.html#a5f1ef744c34be69aec1531f1fe604a9b">STRNCMP</a>(b0.<a class="code" href="structblock0.html#a5f6ec025350776e0dbe8d0ab54daadc3">b0_version</a>, <span class="stringliteral">&quot;VIM 3.0&quot;</span>, 7) == 0)</div><div class="line"><a name="l02213"></a><span class="lineno"> 2213</span>&#160;        {</div><div class="line"><a name="l02214"></a><span class="lineno"> 2214</span>&#160;        <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;         [from Vim version 3.0]&quot;</span>));</div><div class="line"><a name="l02215"></a><span class="lineno"> 2215</span>&#160;        }</div><div class="line"><a name="l02216"></a><span class="lineno"> 2216</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="memline_8c.html#a7c54be0e5b07e1fe53155d1174a746e8">ml_check_b0_id</a>(&amp;b0) == <a class="code" href="dosinst_8h.html#abb508ea8227673f419e9fe3a86c30d8e">FAIL</a>)</div><div class="line"><a name="l02217"></a><span class="lineno"> 2217</span>&#160;        {</div><div class="line"><a name="l02218"></a><span class="lineno"> 2218</span>&#160;        <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;         [does not look like a Vim swap file]&quot;</span>));</div><div class="line"><a name="l02219"></a><span class="lineno"> 2219</span>&#160;        }</div><div class="line"><a name="l02220"></a><span class="lineno"> 2220</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l02221"></a><span class="lineno"> 2221</span>&#160;        {</div><div class="line"><a name="l02222"></a><span class="lineno"> 2222</span>&#160;        <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;         file name: &quot;</span>));</div><div class="line"><a name="l02223"></a><span class="lineno"> 2223</span>&#160;        <span class="keywordflow">if</span> (b0.<a class="code" href="structblock0.html#a619635d3effa9f2496dd6662e20b9037">b0_fname</a>[0] == <a class="code" href="ascii_8h.html#af19d48b9f61047a668649a2f9dc317ff">NUL</a>)</div><div class="line"><a name="l02224"></a><span class="lineno"> 2224</span>&#160;            <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;[No Name]&quot;</span>));</div><div class="line"><a name="l02225"></a><span class="lineno"> 2225</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l02226"></a><span class="lineno"> 2226</span>&#160;            <a class="code" href="message_8c.html#a273e1e1a7e5b9b70db0a55edb73e303d">msg_outtrans</a>(b0.<a class="code" href="structblock0.html#a619635d3effa9f2496dd6662e20b9037">b0_fname</a>);</div><div class="line"><a name="l02227"></a><span class="lineno"> 2227</span>&#160;</div><div class="line"><a name="l02228"></a><span class="lineno"> 2228</span>&#160;        <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;\n          modified: &quot;</span>));</div><div class="line"><a name="l02229"></a><span class="lineno"> 2229</span>&#160;        <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(b0.b0_dirty ? <a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;YES&quot;</span>) : <a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;no&quot;</span>));</div><div class="line"><a name="l02230"></a><span class="lineno"> 2230</span>&#160;</div><div class="line"><a name="l02231"></a><span class="lineno"> 2231</span>&#160;        <span class="keywordflow">if</span> (*(b0.<a class="code" href="structblock0.html#aab3e8eda9003c121be3914c9606854b6">b0_uname</a>) != <a class="code" href="ascii_8h.html#af19d48b9f61047a668649a2f9dc317ff">NUL</a>)</div><div class="line"><a name="l02232"></a><span class="lineno"> 2232</span>&#160;        {</div><div class="line"><a name="l02233"></a><span class="lineno"> 2233</span>&#160;            <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;\n         user name: &quot;</span>));</div><div class="line"><a name="l02234"></a><span class="lineno"> 2234</span>&#160;            <a class="code" href="message_8c.html#a273e1e1a7e5b9b70db0a55edb73e303d">msg_outtrans</a>(b0.<a class="code" href="structblock0.html#aab3e8eda9003c121be3914c9606854b6">b0_uname</a>);</div><div class="line"><a name="l02235"></a><span class="lineno"> 2235</span>&#160;        }</div><div class="line"><a name="l02236"></a><span class="lineno"> 2236</span>&#160;</div><div class="line"><a name="l02237"></a><span class="lineno"> 2237</span>&#160;        <span class="keywordflow">if</span> (*(b0.<a class="code" href="structblock0.html#a8b0cab71ba5453122bcd862fe3d368ca">b0_hname</a>) != <a class="code" href="ascii_8h.html#af19d48b9f61047a668649a2f9dc317ff">NUL</a>)</div><div class="line"><a name="l02238"></a><span class="lineno"> 2238</span>&#160;        {</div><div class="line"><a name="l02239"></a><span class="lineno"> 2239</span>&#160;            <span class="keywordflow">if</span> (*(b0.<a class="code" href="structblock0.html#aab3e8eda9003c121be3914c9606854b6">b0_uname</a>) != <a class="code" href="ascii_8h.html#af19d48b9f61047a668649a2f9dc317ff">NUL</a>)</div><div class="line"><a name="l02240"></a><span class="lineno"> 2240</span>&#160;            <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;   host name: &quot;</span>));</div><div class="line"><a name="l02241"></a><span class="lineno"> 2241</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l02242"></a><span class="lineno"> 2242</span>&#160;            <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;\n         host name: &quot;</span>));</div><div class="line"><a name="l02243"></a><span class="lineno"> 2243</span>&#160;            <a class="code" href="message_8c.html#a273e1e1a7e5b9b70db0a55edb73e303d">msg_outtrans</a>(b0.<a class="code" href="structblock0.html#a8b0cab71ba5453122bcd862fe3d368ca">b0_hname</a>);</div><div class="line"><a name="l02244"></a><span class="lineno"> 2244</span>&#160;        }</div><div class="line"><a name="l02245"></a><span class="lineno"> 2245</span>&#160;</div><div class="line"><a name="l02246"></a><span class="lineno"> 2246</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="memline_8c.html#a996b07c0a0e4f04f7b205f4c3ba2a797">char_to_long</a>(b0.<a class="code" href="structblock0.html#ab702799b723f108b57a8b73f83e70346">b0_pid</a>) != 0L)</div><div class="line"><a name="l02247"></a><span class="lineno"> 2247</span>&#160;        {</div><div class="line"><a name="l02248"></a><span class="lineno"> 2248</span>&#160;            <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;\n        process ID: &quot;</span>));</div><div class="line"><a name="l02249"></a><span class="lineno"> 2249</span>&#160;            <a class="code" href="message_8c.html#a9495c4f4da600498d1482fb292c4c97b">msg_outnum</a>(<a class="code" href="memline_8c.html#a996b07c0a0e4f04f7b205f4c3ba2a797">char_to_long</a>(b0.<a class="code" href="structblock0.html#ab702799b723f108b57a8b73f83e70346">b0_pid</a>));</div><div class="line"><a name="l02250"></a><span class="lineno"> 2250</span>&#160;<span class="preprocessor">#if defined(UNIX) || defined(MSWIN)</span></div><div class="line"><a name="l02251"></a><span class="lineno"> 2251</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="os__unix_8c.html#a5ff2a30d1d4cb47d29819f18f843804a">mch_process_running</a>(<a class="code" href="memline_8c.html#a996b07c0a0e4f04f7b205f4c3ba2a797">char_to_long</a>(b0.<a class="code" href="structblock0.html#ab702799b723f108b57a8b73f83e70346">b0_pid</a>)))</div><div class="line"><a name="l02252"></a><span class="lineno"> 2252</span>&#160;            {</div><div class="line"><a name="l02253"></a><span class="lineno"> 2253</span>&#160;            <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot; (STILL RUNNING)&quot;</span>));</div><div class="line"><a name="l02254"></a><span class="lineno"> 2254</span>&#160;<span class="preprocessor"># ifdef HAVE_PROCESS_STILL_RUNNING</span></div><div class="line"><a name="l02255"></a><span class="lineno"> 2255</span>&#160;            process_still_running = <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"><a name="l02256"></a><span class="lineno"> 2256</span>&#160;<span class="preprocessor"># endif</span></div><div class="line"><a name="l02257"></a><span class="lineno"> 2257</span>&#160;            }</div><div class="line"><a name="l02258"></a><span class="lineno"> 2258</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l02259"></a><span class="lineno"> 2259</span>&#160;        }</div><div class="line"><a name="l02260"></a><span class="lineno"> 2260</span>&#160;</div><div class="line"><a name="l02261"></a><span class="lineno"> 2261</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="memline_8c.html#a28648170c5d102a305afeeecf23cc0ca">b0_magic_wrong</a>(&amp;b0))</div><div class="line"><a name="l02262"></a><span class="lineno"> 2262</span>&#160;        {</div><div class="line"><a name="l02263"></a><span class="lineno"> 2263</span>&#160;<span class="preprocessor">#if defined(MSWIN)</span></div><div class="line"><a name="l02264"></a><span class="lineno"> 2264</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="vim_8h.html#a5f1ef744c34be69aec1531f1fe604a9b">STRNCMP</a>(b0.<a class="code" href="structblock0.html#a8b0cab71ba5453122bcd862fe3d368ca">b0_hname</a>, <span class="stringliteral">&quot;PC &quot;</span>, 3) == 0)</div><div class="line"><a name="l02265"></a><span class="lineno"> 2265</span>&#160;            <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;\n         [not usable with this version of Vim]&quot;</span>));</div><div class="line"><a name="l02266"></a><span class="lineno"> 2266</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l02267"></a><span class="lineno"> 2267</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l02268"></a><span class="lineno"> 2268</span>&#160;            <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;\n         [not usable on this computer]&quot;</span>));</div><div class="line"><a name="l02269"></a><span class="lineno"> 2269</span>&#160;        }</div><div class="line"><a name="l02270"></a><span class="lineno"> 2270</span>&#160;        }</div><div class="line"><a name="l02271"></a><span class="lineno"> 2271</span>&#160;    }</div><div class="line"><a name="l02272"></a><span class="lineno"> 2272</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l02273"></a><span class="lineno"> 2273</span>&#160;        <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;         [cannot be read]&quot;</span>));</div><div class="line"><a name="l02274"></a><span class="lineno"> 2274</span>&#160;    close(fd);</div><div class="line"><a name="l02275"></a><span class="lineno"> 2275</span>&#160;    }</div><div class="line"><a name="l02276"></a><span class="lineno"> 2276</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l02277"></a><span class="lineno"> 2277</span>&#160;    <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;         [cannot be opened]&quot;</span>));</div><div class="line"><a name="l02278"></a><span class="lineno"> 2278</span>&#160;    <a class="code" href="message_8c.html#ae0edfa8d1999c41726a759fd06a1ab6e">msg_putchar</a>(<span class="charliteral">&#39;\n&#39;</span>);</div><div class="line"><a name="l02279"></a><span class="lineno"> 2279</span>&#160;</div><div class="line"><a name="l02280"></a><span class="lineno"> 2280</span>&#160;    <span class="keywordflow">return</span> st.st_mtime;</div><div class="line"><a name="l02281"></a><span class="lineno"> 2281</span>&#160;}</div><div class="line"><a name="l02282"></a><span class="lineno"> 2282</span>&#160;</div><div class="line"><a name="l02283"></a><span class="lineno"> 2283</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l02284"></a><span class="lineno"> 2284</span>&#160;<span class="comment"> * Return TRUE if the swap file looks OK and there are no changes, thus it can</span></div><div class="line"><a name="l02285"></a><span class="lineno"> 2285</span>&#160;<span class="comment"> * be safely deleted.</span></div><div class="line"><a name="l02286"></a><span class="lineno"> 2286</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l02287"></a><span class="lineno"> 2287</span>&#160;    <span class="keyword">static</span> time_t</div><div class="line"><a name="l02288"></a><span class="lineno"><a class="line" href="memline_8c.html#a6767d25cbd7796ae962252124f65a557"> 2288</a></span>&#160;<a class="code" href="memline_8c.html#a6767d25cbd7796ae962252124f65a557">swapfile_unchanged</a>(char_u *fname)</div><div class="line"><a name="l02289"></a><span class="lineno"> 2289</span>&#160;{</div><div class="line"><a name="l02290"></a><span class="lineno"> 2290</span>&#160;    <a class="code" href="vim_8h.html#a3206c537c639e0f26013f6cf909bd0e0">stat_T</a>      st;</div><div class="line"><a name="l02291"></a><span class="lineno"> 2291</span>&#160;    <span class="keywordtype">int</span>         fd;</div><div class="line"><a name="l02292"></a><span class="lineno"> 2292</span>&#160;    <span class="keyword">struct </span><a class="code" href="structblock0.html">block0</a>   b0;</div><div class="line"><a name="l02293"></a><span class="lineno"> 2293</span>&#160;    <span class="keywordtype">int</span>         ret = <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"><a name="l02294"></a><span class="lineno"> 2294</span>&#160;<span class="preprocessor">#if defined(UNIX) || defined(MSWIN)</span></div><div class="line"><a name="l02295"></a><span class="lineno"> 2295</span>&#160;    <span class="keywordtype">long</span>        pid;</div><div class="line"><a name="l02296"></a><span class="lineno"> 2296</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l02297"></a><span class="lineno"> 2297</span>&#160;</div><div class="line"><a name="l02298"></a><span class="lineno"> 2298</span>&#160;    <span class="comment">// must be able to stat the swap file</span></div><div class="line"><a name="l02299"></a><span class="lineno"> 2299</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="macros_8h.html#af9221f9667cc05a05b4646b2aa31e233">mch_stat</a>((<span class="keywordtype">char</span> *)fname, &amp;st) == -1)</div><div class="line"><a name="l02300"></a><span class="lineno"> 2300</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line"><a name="l02301"></a><span class="lineno"> 2301</span>&#160;</div><div class="line"><a name="l02302"></a><span class="lineno"> 2302</span>&#160;    <span class="comment">// must be able to read the first block</span></div><div class="line"><a name="l02303"></a><span class="lineno"> 2303</span>&#160;    fd = <a class="code" href="os__win32_8c.html#a86a6c2e2a013622ad468bcdbc07bbfd6">mch_open</a>((<span class="keywordtype">char</span> *)fname, O_RDONLY | <a class="code" href="vim_8h.html#a9f1019b10a1c51d588f4500cde3a6746">O_EXTRA</a>, 0);</div><div class="line"><a name="l02304"></a><span class="lineno"> 2304</span>&#160;    <span class="keywordflow">if</span> (fd &lt; 0)</div><div class="line"><a name="l02305"></a><span class="lineno"> 2305</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line"><a name="l02306"></a><span class="lineno"> 2306</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="vim_8h.html#aad0d6768ce2f916f7c643be49f87a368">read_eintr</a>(fd, &amp;b0, <span class="keyword">sizeof</span>(b0)) != <span class="keyword">sizeof</span>(b0))</div><div class="line"><a name="l02307"></a><span class="lineno"> 2307</span>&#160;    {</div><div class="line"><a name="l02308"></a><span class="lineno"> 2308</span>&#160;    close(fd);</div><div class="line"><a name="l02309"></a><span class="lineno"> 2309</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line"><a name="l02310"></a><span class="lineno"> 2310</span>&#160;    }</div><div class="line"><a name="l02311"></a><span class="lineno"> 2311</span>&#160;</div><div class="line"><a name="l02312"></a><span class="lineno"> 2312</span>&#160;    <span class="comment">// the ID and magic number must be correct</span></div><div class="line"><a name="l02313"></a><span class="lineno"> 2313</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="memline_8c.html#a7c54be0e5b07e1fe53155d1174a746e8">ml_check_b0_id</a>(&amp;b0) == <a class="code" href="dosinst_8h.html#abb508ea8227673f419e9fe3a86c30d8e">FAIL</a>|| <a class="code" href="memline_8c.html#a28648170c5d102a305afeeecf23cc0ca">b0_magic_wrong</a>(&amp;b0))</div><div class="line"><a name="l02314"></a><span class="lineno"> 2314</span>&#160;    ret = <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line"><a name="l02315"></a><span class="lineno"> 2315</span>&#160;</div><div class="line"><a name="l02316"></a><span class="lineno"> 2316</span>&#160;    <span class="comment">// must be unchanged</span></div><div class="line"><a name="l02317"></a><span class="lineno"> 2317</span>&#160;    <span class="keywordflow">if</span> (b0.b0_dirty)</div><div class="line"><a name="l02318"></a><span class="lineno"> 2318</span>&#160;    ret = <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line"><a name="l02319"></a><span class="lineno"> 2319</span>&#160;</div><div class="line"><a name="l02320"></a><span class="lineno"> 2320</span>&#160;<span class="preprocessor">#if defined(UNIX) || defined(MSWIN)</span></div><div class="line"><a name="l02321"></a><span class="lineno"> 2321</span>&#160;    <span class="comment">// process must known and not be running</span></div><div class="line"><a name="l02322"></a><span class="lineno"> 2322</span>&#160;    pid = <a class="code" href="memline_8c.html#a996b07c0a0e4f04f7b205f4c3ba2a797">char_to_long</a>(b0.<a class="code" href="structblock0.html#ab702799b723f108b57a8b73f83e70346">b0_pid</a>);</div><div class="line"><a name="l02323"></a><span class="lineno"> 2323</span>&#160;    <span class="keywordflow">if</span> (pid == 0L || <a class="code" href="os__unix_8c.html#a5ff2a30d1d4cb47d29819f18f843804a">mch_process_running</a>(pid))</div><div class="line"><a name="l02324"></a><span class="lineno"> 2324</span>&#160;    ret = <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line"><a name="l02325"></a><span class="lineno"> 2325</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l02326"></a><span class="lineno"> 2326</span>&#160;</div><div class="line"><a name="l02327"></a><span class="lineno"> 2327</span>&#160;    <span class="comment">// TODO: Should we check if the swap file was created on the current</span></div><div class="line"><a name="l02328"></a><span class="lineno"> 2328</span>&#160;    <span class="comment">// system?  And the current user?</span></div><div class="line"><a name="l02329"></a><span class="lineno"> 2329</span>&#160;</div><div class="line"><a name="l02330"></a><span class="lineno"> 2330</span>&#160;    close(fd);</div><div class="line"><a name="l02331"></a><span class="lineno"> 2331</span>&#160;    <span class="keywordflow">return</span> ret;</div><div class="line"><a name="l02332"></a><span class="lineno"> 2332</span>&#160;}</div><div class="line"><a name="l02333"></a><span class="lineno"> 2333</span>&#160;</div><div class="line"><a name="l02334"></a><span class="lineno"> 2334</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">int</span></div><div class="line"><a name="l02335"></a><span class="lineno"><a class="line" href="memline_8c.html#a95c3497feee28077f095256e5584c0af"> 2335</a></span>&#160;<a class="code" href="memline_8c.html#a95c3497feee28077f095256e5584c0af">recov_file_names</a>(char_u **names, char_u *path, <span class="keywordtype">int</span> prepend_dot)</div><div class="line"><a name="l02336"></a><span class="lineno"> 2336</span>&#160;{</div><div class="line"><a name="l02337"></a><span class="lineno"> 2337</span>&#160;    <span class="keywordtype">int</span>     num_names;</div><div class="line"><a name="l02338"></a><span class="lineno"> 2338</span>&#160;</div><div class="line"><a name="l02339"></a><span class="lineno"> 2339</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l02340"></a><span class="lineno"> 2340</span>&#160;<span class="comment">     * (Win32 and Win64) never short names, but do prepend a dot.</span></div><div class="line"><a name="l02341"></a><span class="lineno"> 2341</span>&#160;<span class="comment">     * (Not MS-DOS or Win32 or Win64) maybe short name, maybe not: Try both.</span></div><div class="line"><a name="l02342"></a><span class="lineno"> 2342</span>&#160;<span class="comment">     * Only use the short name if it is different.</span></div><div class="line"><a name="l02343"></a><span class="lineno"> 2343</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l02344"></a><span class="lineno"> 2344</span>&#160;    char_u  *p;</div><div class="line"><a name="l02345"></a><span class="lineno"> 2345</span>&#160;    <span class="keywordtype">int</span>     i;</div><div class="line"><a name="l02346"></a><span class="lineno"> 2346</span>&#160;<span class="preprocessor"># ifndef MSWIN</span></div><div class="line"><a name="l02347"></a><span class="lineno"> 2347</span>&#160;    <span class="keywordtype">int</span>     <a class="code" href="usercmd_8c.html#a3fb7e659ba694717955e996add022e94">shortname</a> = curbuf-&gt;b_shortname;</div><div class="line"><a name="l02348"></a><span class="lineno"> 2348</span>&#160;</div><div class="line"><a name="l02349"></a><span class="lineno"> 2349</span>&#160;    curbuf-&gt;b_shortname = <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line"><a name="l02350"></a><span class="lineno"> 2350</span>&#160;<span class="preprocessor"># endif</span></div><div class="line"><a name="l02351"></a><span class="lineno"> 2351</span>&#160;</div><div class="line"><a name="l02352"></a><span class="lineno"> 2352</span>&#160;    num_names = 0;</div><div class="line"><a name="l02353"></a><span class="lineno"> 2353</span>&#160;</div><div class="line"><a name="l02354"></a><span class="lineno"> 2354</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l02355"></a><span class="lineno"> 2355</span>&#160;<span class="comment">     * May also add the file name with a dot prepended, for swap file in same</span></div><div class="line"><a name="l02356"></a><span class="lineno"> 2356</span>&#160;<span class="comment">     * dir as original file.</span></div><div class="line"><a name="l02357"></a><span class="lineno"> 2357</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l02358"></a><span class="lineno"> 2358</span>&#160;    <span class="keywordflow">if</span> (prepend_dot)</div><div class="line"><a name="l02359"></a><span class="lineno"> 2359</span>&#160;    {</div><div class="line"><a name="l02360"></a><span class="lineno"> 2360</span>&#160;    names[num_names] = <a class="code" href="fileio_8c.html#aac79f705198b1f5212fd7f7bba16b852">modname</a>(path, (char_u *)<span class="stringliteral">&quot;.sw?&quot;</span>, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div><div class="line"><a name="l02361"></a><span class="lineno"> 2361</span>&#160;    <span class="keywordflow">if</span> (names[num_names] == NULL)</div><div class="line"><a name="l02362"></a><span class="lineno"> 2362</span>&#160;        <span class="keywordflow">goto</span> <a class="code" href="namespacetest__channel__pipe.html#a026d4aa94ac7d2d0cecce075c3648c14">end</a>;</div><div class="line"><a name="l02363"></a><span class="lineno"> 2363</span>&#160;    ++num_names;</div><div class="line"><a name="l02364"></a><span class="lineno"> 2364</span>&#160;    }</div><div class="line"><a name="l02365"></a><span class="lineno"> 2365</span>&#160;</div><div class="line"><a name="l02366"></a><span class="lineno"> 2366</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l02367"></a><span class="lineno"> 2367</span>&#160;<span class="comment">     * Form the normal swap file name pattern by appending &quot;.sw?&quot;.</span></div><div class="line"><a name="l02368"></a><span class="lineno"> 2368</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l02369"></a><span class="lineno"> 2369</span>&#160;<span class="preprocessor">#ifdef VMS</span></div><div class="line"><a name="l02370"></a><span class="lineno"> 2370</span>&#160;    names[num_names] = <a class="code" href="filepath_8c.html#a8de478b7b0307fbc7b4aab47648ecb0c">concat_fnames</a>(path, (char_u *)<span class="stringliteral">&quot;_sw%&quot;</span>, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l02371"></a><span class="lineno"> 2371</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l02372"></a><span class="lineno"> 2372</span>&#160;    names[num_names] = <a class="code" href="filepath_8c.html#a8de478b7b0307fbc7b4aab47648ecb0c">concat_fnames</a>(path, (char_u *)<span class="stringliteral">&quot;.sw?&quot;</span>, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l02373"></a><span class="lineno"> 2373</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l02374"></a><span class="lineno"> 2374</span>&#160;    <span class="keywordflow">if</span> (names[num_names] == NULL)</div><div class="line"><a name="l02375"></a><span class="lineno"> 2375</span>&#160;    <span class="keywordflow">goto</span> <a class="code" href="namespacetest__channel__pipe.html#a026d4aa94ac7d2d0cecce075c3648c14">end</a>;</div><div class="line"><a name="l02376"></a><span class="lineno"> 2376</span>&#160;    <span class="keywordflow">if</span> (num_names &gt;= 1)     <span class="comment">/* check if we have the same name twice */</span></div><div class="line"><a name="l02377"></a><span class="lineno"> 2377</span>&#160;    {</div><div class="line"><a name="l02378"></a><span class="lineno"> 2378</span>&#160;    p = names[num_names - 1];</div><div class="line"><a name="l02379"></a><span class="lineno"> 2379</span>&#160;    i = (int)<a class="code" href="vim_8h.html#a916ffefe1fc74532d08102cca55d8e34">STRLEN</a>(names[num_names - 1]) - (int)<a class="code" href="vim_8h.html#a916ffefe1fc74532d08102cca55d8e34">STRLEN</a>(names[num_names]);</div><div class="line"><a name="l02380"></a><span class="lineno"> 2380</span>&#160;    <span class="keywordflow">if</span> (i &gt; 0)</div><div class="line"><a name="l02381"></a><span class="lineno"> 2381</span>&#160;        p += i;     <span class="comment">/* file name has been expanded to full path */</span></div><div class="line"><a name="l02382"></a><span class="lineno"> 2382</span>&#160;</div><div class="line"><a name="l02383"></a><span class="lineno"> 2383</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="vim_8h.html#a75fb5fb9d785a71f9d82f4d008a48278">STRCMP</a>(p, names[num_names]) != 0)</div><div class="line"><a name="l02384"></a><span class="lineno"> 2384</span>&#160;        ++num_names;</div><div class="line"><a name="l02385"></a><span class="lineno"> 2385</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l02386"></a><span class="lineno"> 2386</span>&#160;        <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(names[num_names]);</div><div class="line"><a name="l02387"></a><span class="lineno"> 2387</span>&#160;    }</div><div class="line"><a name="l02388"></a><span class="lineno"> 2388</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l02389"></a><span class="lineno"> 2389</span>&#160;    ++num_names;</div><div class="line"><a name="l02390"></a><span class="lineno"> 2390</span>&#160;</div><div class="line"><a name="l02391"></a><span class="lineno"> 2391</span>&#160;<span class="preprocessor"># ifndef MSWIN</span></div><div class="line"><a name="l02392"></a><span class="lineno"> 2392</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l02393"></a><span class="lineno"> 2393</span>&#160;<span class="comment">     * Also try with &#39;shortname&#39; set, in case the file is on a DOS filesystem.</span></div><div class="line"><a name="l02394"></a><span class="lineno"> 2394</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l02395"></a><span class="lineno"> 2395</span>&#160;    curbuf-&gt;b_shortname = <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"><a name="l02396"></a><span class="lineno"> 2396</span>&#160;<span class="preprocessor">#ifdef VMS</span></div><div class="line"><a name="l02397"></a><span class="lineno"> 2397</span>&#160;    names[num_names] = <a class="code" href="fileio_8c.html#aac79f705198b1f5212fd7f7bba16b852">modname</a>(path, (char_u *)<span class="stringliteral">&quot;_sw%&quot;</span>, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l02398"></a><span class="lineno"> 2398</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l02399"></a><span class="lineno"> 2399</span>&#160;    names[num_names] = <a class="code" href="fileio_8c.html#aac79f705198b1f5212fd7f7bba16b852">modname</a>(path, (char_u *)<span class="stringliteral">&quot;.sw?&quot;</span>, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l02400"></a><span class="lineno"> 2400</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l02401"></a><span class="lineno"> 2401</span>&#160;    <span class="keywordflow">if</span> (names[num_names] == NULL)</div><div class="line"><a name="l02402"></a><span class="lineno"> 2402</span>&#160;    <span class="keywordflow">goto</span> <a class="code" href="namespacetest__channel__pipe.html#a026d4aa94ac7d2d0cecce075c3648c14">end</a>;</div><div class="line"><a name="l02403"></a><span class="lineno"> 2403</span>&#160;</div><div class="line"><a name="l02404"></a><span class="lineno"> 2404</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l02405"></a><span class="lineno"> 2405</span>&#160;<span class="comment">     * Remove the one from &#39;shortname&#39;, if it&#39;s the same as with &#39;noshortname&#39;.</span></div><div class="line"><a name="l02406"></a><span class="lineno"> 2406</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l02407"></a><span class="lineno"> 2407</span>&#160;    p = names[num_names];</div><div class="line"><a name="l02408"></a><span class="lineno"> 2408</span>&#160;    i = <a class="code" href="vim_8h.html#a916ffefe1fc74532d08102cca55d8e34">STRLEN</a>(names[num_names]) - <a class="code" href="vim_8h.html#a916ffefe1fc74532d08102cca55d8e34">STRLEN</a>(names[num_names - 1]);</div><div class="line"><a name="l02409"></a><span class="lineno"> 2409</span>&#160;    <span class="keywordflow">if</span> (i &gt; 0)</div><div class="line"><a name="l02410"></a><span class="lineno"> 2410</span>&#160;    p += i;     <span class="comment">/* file name has been expanded to full path */</span></div><div class="line"><a name="l02411"></a><span class="lineno"> 2411</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="vim_8h.html#a75fb5fb9d785a71f9d82f4d008a48278">STRCMP</a>(names[num_names - 1], p) == 0)</div><div class="line"><a name="l02412"></a><span class="lineno"> 2412</span>&#160;    <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(names[num_names]);</div><div class="line"><a name="l02413"></a><span class="lineno"> 2413</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l02414"></a><span class="lineno"> 2414</span>&#160;    ++num_names;</div><div class="line"><a name="l02415"></a><span class="lineno"> 2415</span>&#160;<span class="preprocessor"># endif</span></div><div class="line"><a name="l02416"></a><span class="lineno"> 2416</span>&#160;</div><div class="line"><a name="l02417"></a><span class="lineno"> 2417</span>&#160;<a class="code" href="namespacetest__channel__pipe.html#a026d4aa94ac7d2d0cecce075c3648c14">end</a>:</div><div class="line"><a name="l02418"></a><span class="lineno"> 2418</span>&#160;<span class="preprocessor"># ifndef MSWIN</span></div><div class="line"><a name="l02419"></a><span class="lineno"> 2419</span>&#160;    curbuf-&gt;b_shortname = <a class="code" href="usercmd_8c.html#a3fb7e659ba694717955e996add022e94">shortname</a>;</div><div class="line"><a name="l02420"></a><span class="lineno"> 2420</span>&#160;<span class="preprocessor"># endif</span></div><div class="line"><a name="l02421"></a><span class="lineno"> 2421</span>&#160;</div><div class="line"><a name="l02422"></a><span class="lineno"> 2422</span>&#160;    <span class="keywordflow">return</span> num_names;</div><div class="line"><a name="l02423"></a><span class="lineno"> 2423</span>&#160;}</div><div class="line"><a name="l02424"></a><span class="lineno"> 2424</span>&#160;</div><div class="line"><a name="l02425"></a><span class="lineno"> 2425</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l02426"></a><span class="lineno"> 2426</span>&#160;<span class="comment"> * sync all memlines</span></div><div class="line"><a name="l02427"></a><span class="lineno"> 2427</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l02428"></a><span class="lineno"> 2428</span>&#160;<span class="comment"> * If &#39;check_file&#39; is TRUE, check if original file exists and was not changed.</span></div><div class="line"><a name="l02429"></a><span class="lineno"> 2429</span>&#160;<span class="comment"> * If &#39;check_char&#39; is TRUE, stop syncing when character becomes available, but</span></div><div class="line"><a name="l02430"></a><span class="lineno"> 2430</span>&#160;<span class="comment"> * always sync at least one block.</span></div><div class="line"><a name="l02431"></a><span class="lineno"> 2431</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l02432"></a><span class="lineno"> 2432</span>&#160;    <span class="keywordtype">void</span></div><div class="line"><a name="l02433"></a><span class="lineno"><a class="line" href="memline_8c.html#a102390907b2af0b1cec3c50bf4308f81"> 2433</a></span>&#160;<a class="code" href="memline_8c.html#a102390907b2af0b1cec3c50bf4308f81">ml_sync_all</a>(<span class="keywordtype">int</span> check_file, <span class="keywordtype">int</span> check_char)</div><div class="line"><a name="l02434"></a><span class="lineno"> 2434</span>&#160;{</div><div class="line"><a name="l02435"></a><span class="lineno"> 2435</span>&#160;    <a class="code" href="structfile__buffer.html">buf_T</a>       *buf;</div><div class="line"><a name="l02436"></a><span class="lineno"> 2436</span>&#160;    <a class="code" href="vim_8h.html#a3206c537c639e0f26013f6cf909bd0e0">stat_T</a>      st;</div><div class="line"><a name="l02437"></a><span class="lineno"> 2437</span>&#160;</div><div class="line"><a name="l02438"></a><span class="lineno"> 2438</span>&#160;    <a class="code" href="globals_8h.html#ab2dfc04411a40f8bcaf0f45b0d16f482">FOR_ALL_BUFFERS</a>(buf)</div><div class="line"><a name="l02439"></a><span class="lineno"> 2439</span>&#160;    {</div><div class="line"><a name="l02440"></a><span class="lineno"> 2440</span>&#160;    <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a9adb5a08b3c01be69c98360a14937227">ml_mfp</a> == NULL || buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a9adb5a08b3c01be69c98360a14937227">ml_mfp</a>-&gt;<a class="code" href="structmemfile.html#acf87c004bb17883fecc56966daa0a7f3">mf_fname</a> == NULL)</div><div class="line"><a name="l02441"></a><span class="lineno"> 2441</span>&#160;        <span class="keywordflow">continue</span>;               <span class="comment">/* no file */</span></div><div class="line"><a name="l02442"></a><span class="lineno"> 2442</span>&#160;</div><div class="line"><a name="l02443"></a><span class="lineno"> 2443</span>&#160;    <a class="code" href="memline_8c.html#a20a3268681f79a76b9af2f2fc7b644b6">ml_flush_line</a>(buf);         <span class="comment">/* flush buffered line */</span></div><div class="line"><a name="l02444"></a><span class="lineno"> 2444</span>&#160;                        <span class="comment">/* flush locked block */</span></div><div class="line"><a name="l02445"></a><span class="lineno"> 2445</span>&#160;    (void)<a class="code" href="memline_8c.html#ade8fe98188345bdd3c230545fc4a614f">ml_find_line</a>(buf, (<a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>)0, <a class="code" href="memline_8c.html#a89ca94197abc00b6c372ff0a72b4a091">ML_FLUSH</a>);</div><div class="line"><a name="l02446"></a><span class="lineno"> 2446</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="undo_8c.html#a56fe60092b6057c7cc3a38c785048841">bufIsChanged</a>(buf) &amp;&amp; check_file &amp;&amp; <a class="code" href="memfile_8c.html#a5bfe0380a8116b9f0cc01eb761eccdb4">mf_need_trans</a>(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a9adb5a08b3c01be69c98360a14937227">ml_mfp</a>)</div><div class="line"><a name="l02447"></a><span class="lineno"> 2447</span>&#160;                             &amp;&amp; buf-&gt;<a class="code" href="structfile__buffer.html#a26a473c691883e01ce4f747558b97a4d">b_ffname</a> != NULL)</div><div class="line"><a name="l02448"></a><span class="lineno"> 2448</span>&#160;    {</div><div class="line"><a name="l02449"></a><span class="lineno"> 2449</span>&#160;        <span class="comment">/*</span></div><div class="line"><a name="l02450"></a><span class="lineno"> 2450</span>&#160;<span class="comment">         * If the original file does not exist anymore or has been changed</span></div><div class="line"><a name="l02451"></a><span class="lineno"> 2451</span>&#160;<span class="comment">         * call ml_preserve() to get rid of all negative numbered blocks.</span></div><div class="line"><a name="l02452"></a><span class="lineno"> 2452</span>&#160;<span class="comment">         */</span></div><div class="line"><a name="l02453"></a><span class="lineno"> 2453</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="macros_8h.html#af9221f9667cc05a05b4646b2aa31e233">mch_stat</a>((<span class="keywordtype">char</span> *)buf-&gt;<a class="code" href="structfile__buffer.html#a26a473c691883e01ce4f747558b97a4d">b_ffname</a>, &amp;st) == -1</div><div class="line"><a name="l02454"></a><span class="lineno"> 2454</span>&#160;            || st.st_mtime != buf-&gt;<a class="code" href="structfile__buffer.html#acbc008d53044334116941e49fe076450">b_mtime_read</a></div><div class="line"><a name="l02455"></a><span class="lineno"> 2455</span>&#160;            || st.st_size != buf-&gt;<a class="code" href="structfile__buffer.html#a6102c96ffb9b9df10456769e74f91e2a">b_orig_size</a>)</div><div class="line"><a name="l02456"></a><span class="lineno"> 2456</span>&#160;        {</div><div class="line"><a name="l02457"></a><span class="lineno"> 2457</span>&#160;        <a class="code" href="memline_8c.html#a6456f3ec13f95cc144e0904cf6845bdb">ml_preserve</a>(buf, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l02458"></a><span class="lineno"> 2458</span>&#160;        did_check_timestamps = <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line"><a name="l02459"></a><span class="lineno"> 2459</span>&#160;        need_check_timestamps = <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;   <span class="comment">/* give message later */</span></div><div class="line"><a name="l02460"></a><span class="lineno"> 2460</span>&#160;        }</div><div class="line"><a name="l02461"></a><span class="lineno"> 2461</span>&#160;    }</div><div class="line"><a name="l02462"></a><span class="lineno"> 2462</span>&#160;    <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a9adb5a08b3c01be69c98360a14937227">ml_mfp</a>-&gt;<a class="code" href="structmemfile.html#ae775b29d1b383ccb0bd8c71fc22f3771">mf_dirty</a>)</div><div class="line"><a name="l02463"></a><span class="lineno"> 2463</span>&#160;    {</div><div class="line"><a name="l02464"></a><span class="lineno"> 2464</span>&#160;        (void)<a class="code" href="memfile_8c.html#a0a2aa007c9974950d936bcb9d739563a">mf_sync</a>(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a9adb5a08b3c01be69c98360a14937227">ml_mfp</a>, (check_char ? <a class="code" href="vim_8h.html#a4c810fca3e2a9adfbd66cc5f0536d8f0">MFS_STOP</a> : 0)</div><div class="line"><a name="l02465"></a><span class="lineno"> 2465</span>&#160;                    | (<a class="code" href="undo_8c.html#a56fe60092b6057c7cc3a38c785048841">bufIsChanged</a>(buf) ? <a class="code" href="vim_8h.html#a4038c1cfed080291f89dccd5e10129bf">MFS_FLUSH</a> : 0));</div><div class="line"><a name="l02466"></a><span class="lineno"> 2466</span>&#160;        <span class="keywordflow">if</span> (check_char &amp;&amp; <a class="code" href="ui_8c.html#abc7b4e3a8391b6c9eb2e546a0bb69277">ui_char_avail</a>())  <span class="comment">/* character available now */</span></div><div class="line"><a name="l02467"></a><span class="lineno"> 2467</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l02468"></a><span class="lineno"> 2468</span>&#160;    }</div><div class="line"><a name="l02469"></a><span class="lineno"> 2469</span>&#160;    }</div><div class="line"><a name="l02470"></a><span class="lineno"> 2470</span>&#160;}</div><div class="line"><a name="l02471"></a><span class="lineno"> 2471</span>&#160;</div><div class="line"><a name="l02472"></a><span class="lineno"> 2472</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l02473"></a><span class="lineno"> 2473</span>&#160;<span class="comment"> * sync one buffer, including negative blocks</span></div><div class="line"><a name="l02474"></a><span class="lineno"> 2474</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l02475"></a><span class="lineno"> 2475</span>&#160;<span class="comment"> * after this all the blocks are in the swap file</span></div><div class="line"><a name="l02476"></a><span class="lineno"> 2476</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l02477"></a><span class="lineno"> 2477</span>&#160;<span class="comment"> * Used for the :preserve command and when the original file has been</span></div><div class="line"><a name="l02478"></a><span class="lineno"> 2478</span>&#160;<span class="comment"> * changed or deleted.</span></div><div class="line"><a name="l02479"></a><span class="lineno"> 2479</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l02480"></a><span class="lineno"> 2480</span>&#160;<span class="comment"> * when message is TRUE the success of preserving is reported</span></div><div class="line"><a name="l02481"></a><span class="lineno"> 2481</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l02482"></a><span class="lineno"> 2482</span>&#160;    <span class="keywordtype">void</span></div><div class="line"><a name="l02483"></a><span class="lineno"><a class="line" href="memline_8c.html#a6456f3ec13f95cc144e0904cf6845bdb"> 2483</a></span>&#160;<a class="code" href="memline_8c.html#a6456f3ec13f95cc144e0904cf6845bdb">ml_preserve</a>(<a class="code" href="structfile__buffer.html">buf_T</a> *buf, <span class="keywordtype">int</span> message)</div><div class="line"><a name="l02484"></a><span class="lineno"> 2484</span>&#160;{</div><div class="line"><a name="l02485"></a><span class="lineno"> 2485</span>&#160;    <a class="code" href="structblock__hdr.html">bhdr_T</a>  *hp;</div><div class="line"><a name="l02486"></a><span class="lineno"> 2486</span>&#160;    <a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>    lnum;</div><div class="line"><a name="l02487"></a><span class="lineno"> 2487</span>&#160;    <a class="code" href="structmemfile.html">memfile_T</a>   *mfp = buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a9adb5a08b3c01be69c98360a14937227">ml_mfp</a>;</div><div class="line"><a name="l02488"></a><span class="lineno"> 2488</span>&#160;    <span class="keywordtype">int</span>     status;</div><div class="line"><a name="l02489"></a><span class="lineno"> 2489</span>&#160;    <span class="keywordtype">int</span>     got_int_save = got_int;</div><div class="line"><a name="l02490"></a><span class="lineno"> 2490</span>&#160;</div><div class="line"><a name="l02491"></a><span class="lineno"> 2491</span>&#160;    <span class="keywordflow">if</span> (mfp == NULL || mfp-&gt;<a class="code" href="structmemfile.html#acf87c004bb17883fecc56966daa0a7f3">mf_fname</a> == NULL)</div><div class="line"><a name="l02492"></a><span class="lineno"> 2492</span>&#160;    {</div><div class="line"><a name="l02493"></a><span class="lineno"> 2493</span>&#160;    <span class="keywordflow">if</span> (message)</div><div class="line"><a name="l02494"></a><span class="lineno"> 2494</span>&#160;        <a class="code" href="message_8c.html#ae5991a4d11897dfaee9bfab8e5489d82">emsg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;E313: Cannot preserve, there is no swap file&quot;</span>));</div><div class="line"><a name="l02495"></a><span class="lineno"> 2495</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l02496"></a><span class="lineno"> 2496</span>&#160;    }</div><div class="line"><a name="l02497"></a><span class="lineno"> 2497</span>&#160;</div><div class="line"><a name="l02498"></a><span class="lineno"> 2498</span>&#160;    <span class="comment">/* We only want to stop when interrupted here, not when interrupted</span></div><div class="line"><a name="l02499"></a><span class="lineno"> 2499</span>&#160;<span class="comment">     * before. */</span></div><div class="line"><a name="l02500"></a><span class="lineno"> 2500</span>&#160;    got_int = <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line"><a name="l02501"></a><span class="lineno"> 2501</span>&#160;</div><div class="line"><a name="l02502"></a><span class="lineno"> 2502</span>&#160;    <a class="code" href="memline_8c.html#a20a3268681f79a76b9af2f2fc7b644b6">ml_flush_line</a>(buf);                 <span class="comment">/* flush buffered line */</span></div><div class="line"><a name="l02503"></a><span class="lineno"> 2503</span>&#160;    (void)<a class="code" href="memline_8c.html#ade8fe98188345bdd3c230545fc4a614f">ml_find_line</a>(buf, (<a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>)0, <a class="code" href="memline_8c.html#a89ca94197abc00b6c372ff0a72b4a091">ML_FLUSH</a>); <span class="comment">/* flush locked block */</span></div><div class="line"><a name="l02504"></a><span class="lineno"> 2504</span>&#160;    status = <a class="code" href="memfile_8c.html#a0a2aa007c9974950d936bcb9d739563a">mf_sync</a>(mfp, <a class="code" href="vim_8h.html#a7250711b9595001492c8b4742920acb6">MFS_ALL</a> | <a class="code" href="vim_8h.html#a4038c1cfed080291f89dccd5e10129bf">MFS_FLUSH</a>);</div><div class="line"><a name="l02505"></a><span class="lineno"> 2505</span>&#160;</div><div class="line"><a name="l02506"></a><span class="lineno"> 2506</span>&#160;    <span class="comment">/* stack is invalid after mf_sync(.., MFS_ALL) */</span></div><div class="line"><a name="l02507"></a><span class="lineno"> 2507</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a17d957b4b662bf327749e1523ac4f5b5">ml_stack_top</a> = 0;</div><div class="line"><a name="l02508"></a><span class="lineno"> 2508</span>&#160;</div><div class="line"><a name="l02509"></a><span class="lineno"> 2509</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l02510"></a><span class="lineno"> 2510</span>&#160;<span class="comment">     * Some of the data blocks may have been changed from negative to</span></div><div class="line"><a name="l02511"></a><span class="lineno"> 2511</span>&#160;<span class="comment">     * positive block number. In that case the pointer blocks need to be</span></div><div class="line"><a name="l02512"></a><span class="lineno"> 2512</span>&#160;<span class="comment">     * updated.</span></div><div class="line"><a name="l02513"></a><span class="lineno"> 2513</span>&#160;<span class="comment">     *</span></div><div class="line"><a name="l02514"></a><span class="lineno"> 2514</span>&#160;<span class="comment">     * We don&#39;t know in which pointer block the references are, so we visit</span></div><div class="line"><a name="l02515"></a><span class="lineno"> 2515</span>&#160;<span class="comment">     * all data blocks until there are no more translations to be done (or</span></div><div class="line"><a name="l02516"></a><span class="lineno"> 2516</span>&#160;<span class="comment">     * we hit the end of the file, which can only happen in case a write fails,</span></div><div class="line"><a name="l02517"></a><span class="lineno"> 2517</span>&#160;<span class="comment">     * e.g. when file system if full).</span></div><div class="line"><a name="l02518"></a><span class="lineno"> 2518</span>&#160;<span class="comment">     * ml_find_line() does the work by translating the negative block numbers</span></div><div class="line"><a name="l02519"></a><span class="lineno"> 2519</span>&#160;<span class="comment">     * when getting the first line of each data block.</span></div><div class="line"><a name="l02520"></a><span class="lineno"> 2520</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l02521"></a><span class="lineno"> 2521</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="memfile_8c.html#a5bfe0380a8116b9f0cc01eb761eccdb4">mf_need_trans</a>(mfp) &amp;&amp; !got_int)</div><div class="line"><a name="l02522"></a><span class="lineno"> 2522</span>&#160;    {</div><div class="line"><a name="l02523"></a><span class="lineno"> 2523</span>&#160;    lnum = 1;</div><div class="line"><a name="l02524"></a><span class="lineno"> 2524</span>&#160;    <span class="keywordflow">while</span> (<a class="code" href="memfile_8c.html#a5bfe0380a8116b9f0cc01eb761eccdb4">mf_need_trans</a>(mfp) &amp;&amp; lnum &lt;= buf-&gt;b_ml.ml_line_count)</div><div class="line"><a name="l02525"></a><span class="lineno"> 2525</span>&#160;    {</div><div class="line"><a name="l02526"></a><span class="lineno"> 2526</span>&#160;        hp = <a class="code" href="memline_8c.html#ade8fe98188345bdd3c230545fc4a614f">ml_find_line</a>(buf, lnum, <a class="code" href="memline_8c.html#a1de07181f87bda4348b87eb71e0ab526">ML_FIND</a>);</div><div class="line"><a name="l02527"></a><span class="lineno"> 2527</span>&#160;        <span class="keywordflow">if</span> (hp == NULL)</div><div class="line"><a name="l02528"></a><span class="lineno"> 2528</span>&#160;        {</div><div class="line"><a name="l02529"></a><span class="lineno"> 2529</span>&#160;        status = <a class="code" href="dosinst_8h.html#abb508ea8227673f419e9fe3a86c30d8e">FAIL</a>;</div><div class="line"><a name="l02530"></a><span class="lineno"> 2530</span>&#160;        <span class="keywordflow">goto</span> theend;</div><div class="line"><a name="l02531"></a><span class="lineno"> 2531</span>&#160;        }</div><div class="line"><a name="l02532"></a><span class="lineno"> 2532</span>&#160;        <a class="code" href="memline_8c.html#a4c3f0432d972be512c1ff55974987c8c">CHECK</a>(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a2b7c6e30401df9d0e8972cb639d1b895">ml_locked_low</a> != lnum, <span class="stringliteral">&quot;low != lnum&quot;</span>);</div><div class="line"><a name="l02533"></a><span class="lineno"> 2533</span>&#160;        lnum = buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a81788089e53748eb945a88d6e41647da">ml_locked_high</a> + 1;</div><div class="line"><a name="l02534"></a><span class="lineno"> 2534</span>&#160;    }</div><div class="line"><a name="l02535"></a><span class="lineno"> 2535</span>&#160;    (void)<a class="code" href="memline_8c.html#ade8fe98188345bdd3c230545fc4a614f">ml_find_line</a>(buf, (<a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>)0, <a class="code" href="memline_8c.html#a89ca94197abc00b6c372ff0a72b4a091">ML_FLUSH</a>); <span class="comment">/* flush locked block */</span></div><div class="line"><a name="l02536"></a><span class="lineno"> 2536</span>&#160;    <span class="comment">/* sync the updated pointer blocks */</span></div><div class="line"><a name="l02537"></a><span class="lineno"> 2537</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="memfile_8c.html#a0a2aa007c9974950d936bcb9d739563a">mf_sync</a>(mfp, <a class="code" href="vim_8h.html#a7250711b9595001492c8b4742920acb6">MFS_ALL</a> | <a class="code" href="vim_8h.html#a4038c1cfed080291f89dccd5e10129bf">MFS_FLUSH</a>) == <a class="code" href="dosinst_8h.html#abb508ea8227673f419e9fe3a86c30d8e">FAIL</a>)</div><div class="line"><a name="l02538"></a><span class="lineno"> 2538</span>&#160;        status = <a class="code" href="dosinst_8h.html#abb508ea8227673f419e9fe3a86c30d8e">FAIL</a>;</div><div class="line"><a name="l02539"></a><span class="lineno"> 2539</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a17d957b4b662bf327749e1523ac4f5b5">ml_stack_top</a> = 0;     <span class="comment">/* stack is invalid now */</span></div><div class="line"><a name="l02540"></a><span class="lineno"> 2540</span>&#160;    }</div><div class="line"><a name="l02541"></a><span class="lineno"> 2541</span>&#160;theend:</div><div class="line"><a name="l02542"></a><span class="lineno"> 2542</span>&#160;    got_int |= got_int_save;</div><div class="line"><a name="l02543"></a><span class="lineno"> 2543</span>&#160;</div><div class="line"><a name="l02544"></a><span class="lineno"> 2544</span>&#160;    <span class="keywordflow">if</span> (message)</div><div class="line"><a name="l02545"></a><span class="lineno"> 2545</span>&#160;    {</div><div class="line"><a name="l02546"></a><span class="lineno"> 2546</span>&#160;    <span class="keywordflow">if</span> (status == <a class="code" href="dosinst_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>)</div><div class="line"><a name="l02547"></a><span class="lineno"> 2547</span>&#160;        <a class="code" href="message_8c.html#a6a5cfaa40c91127e2434c14cddb955b6">msg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;File preserved&quot;</span>));</div><div class="line"><a name="l02548"></a><span class="lineno"> 2548</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l02549"></a><span class="lineno"> 2549</span>&#160;        <a class="code" href="message_8c.html#ae5991a4d11897dfaee9bfab8e5489d82">emsg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;E314: Preserve failed&quot;</span>));</div><div class="line"><a name="l02550"></a><span class="lineno"> 2550</span>&#160;    }</div><div class="line"><a name="l02551"></a><span class="lineno"> 2551</span>&#160;}</div><div class="line"><a name="l02552"></a><span class="lineno"> 2552</span>&#160;</div><div class="line"><a name="l02553"></a><span class="lineno"> 2553</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l02554"></a><span class="lineno"> 2554</span>&#160;<span class="comment"> * NOTE: The pointer returned by the ml_get_*() functions only remains valid</span></div><div class="line"><a name="l02555"></a><span class="lineno"> 2555</span>&#160;<span class="comment"> * until the next call!</span></div><div class="line"><a name="l02556"></a><span class="lineno"> 2556</span>&#160;<span class="comment"> *  line1 = ml_get(1);</span></div><div class="line"><a name="l02557"></a><span class="lineno"> 2557</span>&#160;<span class="comment"> *  line2 = ml_get(2);  // line1 is now invalid!</span></div><div class="line"><a name="l02558"></a><span class="lineno"> 2558</span>&#160;<span class="comment"> * Make a copy of the line if necessary.</span></div><div class="line"><a name="l02559"></a><span class="lineno"> 2559</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l02560"></a><span class="lineno"> 2560</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l02561"></a><span class="lineno"> 2561</span>&#160;<span class="comment"> * Return a pointer to a (read-only copy of a) line.</span></div><div class="line"><a name="l02562"></a><span class="lineno"> 2562</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l02563"></a><span class="lineno"> 2563</span>&#160;<span class="comment"> * On failure an error message is given and IObuff is returned (to avoid</span></div><div class="line"><a name="l02564"></a><span class="lineno"> 2564</span>&#160;<span class="comment"> * having to check for error everywhere).</span></div><div class="line"><a name="l02565"></a><span class="lineno"> 2565</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l02566"></a><span class="lineno"> 2566</span>&#160;    char_u  *</div><div class="line"><a name="l02567"></a><span class="lineno"><a class="line" href="memline_8c.html#a109387062ce17fc808cae3971ce703ba"> 2567</a></span>&#160;<a class="code" href="memline_8c.html#a109387062ce17fc808cae3971ce703ba">ml_get</a>(<a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a> lnum)</div><div class="line"><a name="l02568"></a><span class="lineno"> 2568</span>&#160;{</div><div class="line"><a name="l02569"></a><span class="lineno"> 2569</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="memline_8c.html#a5efa31d210327048f60b8b00586e2a8c">ml_get_buf</a>(curbuf, lnum, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l02570"></a><span class="lineno"> 2570</span>&#160;}</div><div class="line"><a name="l02571"></a><span class="lineno"> 2571</span>&#160;</div><div class="line"><a name="l02572"></a><span class="lineno"> 2572</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l02573"></a><span class="lineno"> 2573</span>&#160;<span class="comment"> * Return pointer to position &quot;pos&quot;.</span></div><div class="line"><a name="l02574"></a><span class="lineno"> 2574</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l02575"></a><span class="lineno"> 2575</span>&#160;    char_u *</div><div class="line"><a name="l02576"></a><span class="lineno"><a class="line" href="memline_8c.html#a3d4acdf95d4c64556e8eda8bd2ab6bac"> 2576</a></span>&#160;<a class="code" href="memline_8c.html#a3d4acdf95d4c64556e8eda8bd2ab6bac">ml_get_pos</a>(<a class="code" href="structpos___t.html">pos_T</a> *pos)</div><div class="line"><a name="l02577"></a><span class="lineno"> 2577</span>&#160;{</div><div class="line"><a name="l02578"></a><span class="lineno"> 2578</span>&#160;    <span class="keywordflow">return</span> (<a class="code" href="memline_8c.html#a5efa31d210327048f60b8b00586e2a8c">ml_get_buf</a>(curbuf, pos-&gt;<a class="code" href="structpos___t.html#abff612ea21a47084625b593756153b3e">lnum</a>, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) + pos-&gt;<a class="code" href="structpos___t.html#a08c5af56d347e155e2cd721d99616ab8">col</a>);</div><div class="line"><a name="l02579"></a><span class="lineno"> 2579</span>&#160;}</div><div class="line"><a name="l02580"></a><span class="lineno"> 2580</span>&#160;</div><div class="line"><a name="l02581"></a><span class="lineno"> 2581</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l02582"></a><span class="lineno"> 2582</span>&#160;<span class="comment"> * Return pointer to cursor line.</span></div><div class="line"><a name="l02583"></a><span class="lineno"> 2583</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l02584"></a><span class="lineno"> 2584</span>&#160;    char_u *</div><div class="line"><a name="l02585"></a><span class="lineno"><a class="line" href="memline_8c.html#a8942569e896707801271476ee05853f8"> 2585</a></span>&#160;<a class="code" href="memline_8c.html#a8942569e896707801271476ee05853f8">ml_get_curline</a>(<span class="keywordtype">void</span>)</div><div class="line"><a name="l02586"></a><span class="lineno"> 2586</span>&#160;{</div><div class="line"><a name="l02587"></a><span class="lineno"> 2587</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="memline_8c.html#a5efa31d210327048f60b8b00586e2a8c">ml_get_buf</a>(curbuf, <a class="code" href="globals_8h.html#a1440aee39ae90077fff5aeb23c8a3764">curwin</a>-&gt;<a class="code" href="structwindow___s.html#a397eb20adbcf2f8a50e1038886c1930c">w_cursor</a>.<a class="code" href="structpos___t.html#abff612ea21a47084625b593756153b3e">lnum</a>, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l02588"></a><span class="lineno"> 2588</span>&#160;}</div><div class="line"><a name="l02589"></a><span class="lineno"> 2589</span>&#160;</div><div class="line"><a name="l02590"></a><span class="lineno"> 2590</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l02591"></a><span class="lineno"> 2591</span>&#160;<span class="comment"> * Return pointer to cursor position.</span></div><div class="line"><a name="l02592"></a><span class="lineno"> 2592</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l02593"></a><span class="lineno"> 2593</span>&#160;    char_u *</div><div class="line"><a name="l02594"></a><span class="lineno"><a class="line" href="memline_8c.html#a797a630fa8ec06231624fccc08eb9243"> 2594</a></span>&#160;<a class="code" href="memline_8c.html#a797a630fa8ec06231624fccc08eb9243">ml_get_cursor</a>(<span class="keywordtype">void</span>)</div><div class="line"><a name="l02595"></a><span class="lineno"> 2595</span>&#160;{</div><div class="line"><a name="l02596"></a><span class="lineno"> 2596</span>&#160;    <span class="keywordflow">return</span> (<a class="code" href="memline_8c.html#a5efa31d210327048f60b8b00586e2a8c">ml_get_buf</a>(curbuf, <a class="code" href="globals_8h.html#a1440aee39ae90077fff5aeb23c8a3764">curwin</a>-&gt;<a class="code" href="structwindow___s.html#a397eb20adbcf2f8a50e1038886c1930c">w_cursor</a>.<a class="code" href="structpos___t.html#abff612ea21a47084625b593756153b3e">lnum</a>, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) +</div><div class="line"><a name="l02597"></a><span class="lineno"> 2597</span>&#160;                            <a class="code" href="globals_8h.html#a1440aee39ae90077fff5aeb23c8a3764">curwin</a>-&gt;<a class="code" href="structwindow___s.html#a397eb20adbcf2f8a50e1038886c1930c">w_cursor</a>.<a class="code" href="structpos___t.html#a08c5af56d347e155e2cd721d99616ab8">col</a>);</div><div class="line"><a name="l02598"></a><span class="lineno"> 2598</span>&#160;}</div><div class="line"><a name="l02599"></a><span class="lineno"> 2599</span>&#160;</div><div class="line"><a name="l02600"></a><span class="lineno"> 2600</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l02601"></a><span class="lineno"> 2601</span>&#160;<span class="comment"> * Return a pointer to a line in a specific buffer</span></div><div class="line"><a name="l02602"></a><span class="lineno"> 2602</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l02603"></a><span class="lineno"> 2603</span>&#160;<span class="comment"> * &quot;will_change&quot;: if TRUE mark the buffer dirty (chars in the line will be</span></div><div class="line"><a name="l02604"></a><span class="lineno"> 2604</span>&#160;<span class="comment"> * changed)</span></div><div class="line"><a name="l02605"></a><span class="lineno"> 2605</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l02606"></a><span class="lineno"> 2606</span>&#160;    char_u  *</div><div class="line"><a name="l02607"></a><span class="lineno"><a class="line" href="memline_8c.html#a5efa31d210327048f60b8b00586e2a8c"> 2607</a></span>&#160;<a class="code" href="memline_8c.html#a5efa31d210327048f60b8b00586e2a8c">ml_get_buf</a>(</div><div class="line"><a name="l02608"></a><span class="lineno"> 2608</span>&#160;    <a class="code" href="structfile__buffer.html">buf_T</a>   *buf,</div><div class="line"><a name="l02609"></a><span class="lineno"> 2609</span>&#160;    <a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>    lnum,</div><div class="line"><a name="l02610"></a><span class="lineno"> 2610</span>&#160;    <span class="keywordtype">int</span>     will_change)        <span class="comment">/* line will be changed */</span></div><div class="line"><a name="l02611"></a><span class="lineno"> 2611</span>&#160;{</div><div class="line"><a name="l02612"></a><span class="lineno"> 2612</span>&#160;    <a class="code" href="structblock__hdr.html">bhdr_T</a>  *hp;</div><div class="line"><a name="l02613"></a><span class="lineno"> 2613</span>&#160;    <a class="code" href="structdata__block.html">DATA_BL</a> *dp;</div><div class="line"><a name="l02614"></a><span class="lineno"> 2614</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">int</span>  recursive = 0;</div><div class="line"><a name="l02615"></a><span class="lineno"> 2615</span>&#160;</div><div class="line"><a name="l02616"></a><span class="lineno"> 2616</span>&#160;    <span class="keywordflow">if</span> (lnum &gt; buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a708091d31fa9cf7718aca80d707b1b3d">ml_line_count</a>) <span class="comment">/* invalid line number */</span></div><div class="line"><a name="l02617"></a><span class="lineno"> 2617</span>&#160;    {</div><div class="line"><a name="l02618"></a><span class="lineno"> 2618</span>&#160;    <span class="keywordflow">if</span> (recursive == 0)</div><div class="line"><a name="l02619"></a><span class="lineno"> 2619</span>&#160;    {</div><div class="line"><a name="l02620"></a><span class="lineno"> 2620</span>&#160;        <span class="comment">/* Avoid giving this message for a recursive call, may happen when</span></div><div class="line"><a name="l02621"></a><span class="lineno"> 2621</span>&#160;<span class="comment">         * the GUI redraws part of the text. */</span></div><div class="line"><a name="l02622"></a><span class="lineno"> 2622</span>&#160;        ++recursive;</div><div class="line"><a name="l02623"></a><span class="lineno"> 2623</span>&#160;        <a class="code" href="message_8c.html#a35f801e23d16b0e6a4d1cc61691ec03f">siemsg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;E315: ml_get: invalid lnum: %ld&quot;</span>), lnum);</div><div class="line"><a name="l02624"></a><span class="lineno"> 2624</span>&#160;        --recursive;</div><div class="line"><a name="l02625"></a><span class="lineno"> 2625</span>&#160;    }</div><div class="line"><a name="l02626"></a><span class="lineno"> 2626</span>&#160;errorret:</div><div class="line"><a name="l02627"></a><span class="lineno"> 2627</span>&#160;    <a class="code" href="vim_8h.html#aa9cea5fcb1483307770f365fb24aa08d">STRCPY</a>(<a class="code" href="globals_8h.html#a690495c80458a3a89c4bdcea2ec4258c">IObuff</a>, <span class="stringliteral">&quot;???&quot;</span>);</div><div class="line"><a name="l02628"></a><span class="lineno"> 2628</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#ae775dd7dfa8b3dcaa01a9b3fa030371a">ml_line_len</a> = 4;</div><div class="line"><a name="l02629"></a><span class="lineno"> 2629</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="globals_8h.html#a690495c80458a3a89c4bdcea2ec4258c">IObuff</a>;</div><div class="line"><a name="l02630"></a><span class="lineno"> 2630</span>&#160;    }</div><div class="line"><a name="l02631"></a><span class="lineno"> 2631</span>&#160;    <span class="keywordflow">if</span> (lnum &lt;= 0)          <span class="comment">// pretend line 0 is line 1</span></div><div class="line"><a name="l02632"></a><span class="lineno"> 2632</span>&#160;    lnum = 1;</div><div class="line"><a name="l02633"></a><span class="lineno"> 2633</span>&#160;</div><div class="line"><a name="l02634"></a><span class="lineno"> 2634</span>&#160;    <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a9adb5a08b3c01be69c98360a14937227">ml_mfp</a> == NULL)   <span class="comment">// there are no lines</span></div><div class="line"><a name="l02635"></a><span class="lineno"> 2635</span>&#160;    {</div><div class="line"><a name="l02636"></a><span class="lineno"> 2636</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#ae775dd7dfa8b3dcaa01a9b3fa030371a">ml_line_len</a> = 1;</div><div class="line"><a name="l02637"></a><span class="lineno"> 2637</span>&#160;    <span class="keywordflow">return</span> (char_u *)<span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l02638"></a><span class="lineno"> 2638</span>&#160;    }</div><div class="line"><a name="l02639"></a><span class="lineno"> 2639</span>&#160;</div><div class="line"><a name="l02640"></a><span class="lineno"> 2640</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l02641"></a><span class="lineno"> 2641</span>&#160;<span class="comment">     * See if it is the same line as requested last time.</span></div><div class="line"><a name="l02642"></a><span class="lineno"> 2642</span>&#160;<span class="comment">     * Otherwise may need to flush last used line.</span></div><div class="line"><a name="l02643"></a><span class="lineno"> 2643</span>&#160;<span class="comment">     * Don&#39;t use the last used line when &#39;swapfile&#39; is reset, need to load all</span></div><div class="line"><a name="l02644"></a><span class="lineno"> 2644</span>&#160;<span class="comment">     * blocks.</span></div><div class="line"><a name="l02645"></a><span class="lineno"> 2645</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l02646"></a><span class="lineno"> 2646</span>&#160;    <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a62222eb79ef59eddaff71f0f8cdff764">ml_line_lnum</a> != lnum || mf_dont_release)</div><div class="line"><a name="l02647"></a><span class="lineno"> 2647</span>&#160;    {</div><div class="line"><a name="l02648"></a><span class="lineno"> 2648</span>&#160;    <span class="keywordtype">unsigned</span>    start, <a class="code" href="namespacetest__channel__pipe.html#a026d4aa94ac7d2d0cecce075c3648c14">end</a>;</div><div class="line"><a name="l02649"></a><span class="lineno"> 2649</span>&#160;    <a class="code" href="vim_8h.html#ae79e04a416bd6ce8ffe80e241850c0d2">colnr_T</a>     len;</div><div class="line"><a name="l02650"></a><span class="lineno"> 2650</span>&#160;    <span class="keywordtype">int</span>     idx;</div><div class="line"><a name="l02651"></a><span class="lineno"> 2651</span>&#160;</div><div class="line"><a name="l02652"></a><span class="lineno"> 2652</span>&#160;    <a class="code" href="memline_8c.html#a20a3268681f79a76b9af2f2fc7b644b6">ml_flush_line</a>(buf);</div><div class="line"><a name="l02653"></a><span class="lineno"> 2653</span>&#160;</div><div class="line"><a name="l02654"></a><span class="lineno"> 2654</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l02655"></a><span class="lineno"> 2655</span>&#160;<span class="comment">     * Find the data block containing the line.</span></div><div class="line"><a name="l02656"></a><span class="lineno"> 2656</span>&#160;<span class="comment">     * This also fills the stack with the blocks from the root to the data</span></div><div class="line"><a name="l02657"></a><span class="lineno"> 2657</span>&#160;<span class="comment">     * block and releases any locked block.</span></div><div class="line"><a name="l02658"></a><span class="lineno"> 2658</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l02659"></a><span class="lineno"> 2659</span>&#160;    <span class="keywordflow">if</span> ((hp = <a class="code" href="memline_8c.html#ade8fe98188345bdd3c230545fc4a614f">ml_find_line</a>(buf, lnum, <a class="code" href="memline_8c.html#a1de07181f87bda4348b87eb71e0ab526">ML_FIND</a>)) == NULL)</div><div class="line"><a name="l02660"></a><span class="lineno"> 2660</span>&#160;    {</div><div class="line"><a name="l02661"></a><span class="lineno"> 2661</span>&#160;        <span class="keywordflow">if</span> (recursive == 0)</div><div class="line"><a name="l02662"></a><span class="lineno"> 2662</span>&#160;        {</div><div class="line"><a name="l02663"></a><span class="lineno"> 2663</span>&#160;        <span class="comment">/* Avoid giving this message for a recursive call, may happen</span></div><div class="line"><a name="l02664"></a><span class="lineno"> 2664</span>&#160;<span class="comment">         * when the GUI redraws part of the text. */</span></div><div class="line"><a name="l02665"></a><span class="lineno"> 2665</span>&#160;        ++recursive;</div><div class="line"><a name="l02666"></a><span class="lineno"> 2666</span>&#160;        <a class="code" href="message_8c.html#a35f801e23d16b0e6a4d1cc61691ec03f">siemsg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;E316: ml_get: cannot find line %ld&quot;</span>), lnum);</div><div class="line"><a name="l02667"></a><span class="lineno"> 2667</span>&#160;        --recursive;</div><div class="line"><a name="l02668"></a><span class="lineno"> 2668</span>&#160;        }</div><div class="line"><a name="l02669"></a><span class="lineno"> 2669</span>&#160;        <span class="keywordflow">goto</span> errorret;</div><div class="line"><a name="l02670"></a><span class="lineno"> 2670</span>&#160;    }</div><div class="line"><a name="l02671"></a><span class="lineno"> 2671</span>&#160;</div><div class="line"><a name="l02672"></a><span class="lineno"> 2672</span>&#160;    dp = (<a class="code" href="structdata__block.html">DATA_BL</a> *)(hp-&gt;<a class="code" href="structblock__hdr.html#a7247cdc0977ab6fdc9cb6238cda67587">bh_data</a>);</div><div class="line"><a name="l02673"></a><span class="lineno"> 2673</span>&#160;</div><div class="line"><a name="l02674"></a><span class="lineno"> 2674</span>&#160;    idx = lnum - buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a2b7c6e30401df9d0e8972cb639d1b895">ml_locked_low</a>;</div><div class="line"><a name="l02675"></a><span class="lineno"> 2675</span>&#160;    start = ((dp-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[idx]) &amp; <a class="code" href="memline_8c.html#ab65775db0f7dbf161fce05ee7fb36573">DB_INDEX_MASK</a>);</div><div class="line"><a name="l02676"></a><span class="lineno"> 2676</span>&#160;    <span class="comment">// The text ends where the previous line starts.  The first line ends</span></div><div class="line"><a name="l02677"></a><span class="lineno"> 2677</span>&#160;    <span class="comment">// at the end of the block.</span></div><div class="line"><a name="l02678"></a><span class="lineno"> 2678</span>&#160;    <span class="keywordflow">if</span> (idx == 0)</div><div class="line"><a name="l02679"></a><span class="lineno"> 2679</span>&#160;        end = dp-&gt;<a class="code" href="structdata__block.html#ae079e3993bfc47bd86fd6e2fc3ab44ba">db_txt_end</a>;</div><div class="line"><a name="l02680"></a><span class="lineno"> 2680</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l02681"></a><span class="lineno"> 2681</span>&#160;        end = ((dp-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[idx - 1]) &amp; <a class="code" href="memline_8c.html#ab65775db0f7dbf161fce05ee7fb36573">DB_INDEX_MASK</a>);</div><div class="line"><a name="l02682"></a><span class="lineno"> 2682</span>&#160;    len = end - start;</div><div class="line"><a name="l02683"></a><span class="lineno"> 2683</span>&#160;</div><div class="line"><a name="l02684"></a><span class="lineno"> 2684</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#aada7438521544eec6c73e223b2811a69">ml_line_ptr</a> = (char_u *)dp + start;</div><div class="line"><a name="l02685"></a><span class="lineno"> 2685</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#ae775dd7dfa8b3dcaa01a9b3fa030371a">ml_line_len</a> = len;</div><div class="line"><a name="l02686"></a><span class="lineno"> 2686</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a62222eb79ef59eddaff71f0f8cdff764">ml_line_lnum</a> = lnum;</div><div class="line"><a name="l02687"></a><span class="lineno"> 2687</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a30f30ddb7264f667a92556f0568981e0">ml_flags</a> &amp;= ~<a class="code" href="structs_8h.html#a8fac7ceea6e156c2915cdcf7e228a9f8">ML_LINE_DIRTY</a>;</div><div class="line"><a name="l02688"></a><span class="lineno"> 2688</span>&#160;    }</div><div class="line"><a name="l02689"></a><span class="lineno"> 2689</span>&#160;    <span class="keywordflow">if</span> (will_change)</div><div class="line"><a name="l02690"></a><span class="lineno"> 2690</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a30f30ddb7264f667a92556f0568981e0">ml_flags</a> |= (<a class="code" href="structs_8h.html#ad55a676a17d24163d3cdb2bf75a7fa66">ML_LOCKED_DIRTY</a> | <a class="code" href="structs_8h.html#a094e033c133f0276ed3c00f8053d0175">ML_LOCKED_POS</a>);</div><div class="line"><a name="l02691"></a><span class="lineno"> 2691</span>&#160;</div><div class="line"><a name="l02692"></a><span class="lineno"> 2692</span>&#160;    <span class="keywordflow">return</span> buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#aada7438521544eec6c73e223b2811a69">ml_line_ptr</a>;</div><div class="line"><a name="l02693"></a><span class="lineno"> 2693</span>&#160;}</div><div class="line"><a name="l02694"></a><span class="lineno"> 2694</span>&#160;</div><div class="line"><a name="l02695"></a><span class="lineno"> 2695</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l02696"></a><span class="lineno"> 2696</span>&#160;<span class="comment"> * Check if a line that was just obtained by a call to ml_get</span></div><div class="line"><a name="l02697"></a><span class="lineno"> 2697</span>&#160;<span class="comment"> * is in allocated memory.</span></div><div class="line"><a name="l02698"></a><span class="lineno"> 2698</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l02699"></a><span class="lineno"> 2699</span>&#160;    <span class="keywordtype">int</span></div><div class="line"><a name="l02700"></a><span class="lineno"><a class="line" href="memline_8c.html#ac1a4fef0800b7b4b84340a09cbaf7d1b"> 2700</a></span>&#160;<a class="code" href="memline_8c.html#ac1a4fef0800b7b4b84340a09cbaf7d1b">ml_line_alloced</a>(<span class="keywordtype">void</span>)</div><div class="line"><a name="l02701"></a><span class="lineno"> 2701</span>&#160;{</div><div class="line"><a name="l02702"></a><span class="lineno"> 2702</span>&#160;    <span class="keywordflow">return</span> (curbuf-&gt;b_ml.ml_flags &amp; <a class="code" href="structs_8h.html#a8fac7ceea6e156c2915cdcf7e228a9f8">ML_LINE_DIRTY</a>);</div><div class="line"><a name="l02703"></a><span class="lineno"> 2703</span>&#160;}</div><div class="line"><a name="l02704"></a><span class="lineno"> 2704</span>&#160;</div><div class="line"><a name="l02705"></a><span class="lineno"> 2705</span>&#160;<span class="preprocessor">#ifdef FEAT_TEXT_PROP</span></div><div class="line"><a name="l02706"></a><span class="lineno"> 2706</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">void</span></div><div class="line"><a name="l02707"></a><span class="lineno"><a class="line" href="memline_8c.html#aaabdfc4378cd70463534636d2d00c50d"> 2707</a></span>&#160;<a class="code" href="memline_8c.html#aaabdfc4378cd70463534636d2d00c50d">add_text_props_for_append</a>(</div><div class="line"><a name="l02708"></a><span class="lineno"> 2708</span>&#160;        <a class="code" href="structfile__buffer.html">buf_T</a>   *buf,</div><div class="line"><a name="l02709"></a><span class="lineno"> 2709</span>&#160;        <a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>    lnum,</div><div class="line"><a name="l02710"></a><span class="lineno"> 2710</span>&#160;        char_u  **line,</div><div class="line"><a name="l02711"></a><span class="lineno"> 2711</span>&#160;        <span class="keywordtype">int</span>     *len,</div><div class="line"><a name="l02712"></a><span class="lineno"> 2712</span>&#160;        char_u  **tofree)</div><div class="line"><a name="l02713"></a><span class="lineno"> 2713</span>&#160;{</div><div class="line"><a name="l02714"></a><span class="lineno"> 2714</span>&#160;    <span class="keywordtype">int</span>     round;</div><div class="line"><a name="l02715"></a><span class="lineno"> 2715</span>&#160;    <span class="keywordtype">int</span>     new_prop_count = 0;</div><div class="line"><a name="l02716"></a><span class="lineno"> 2716</span>&#160;    <span class="keywordtype">int</span>     count;</div><div class="line"><a name="l02717"></a><span class="lineno"> 2717</span>&#160;    <span class="keywordtype">int</span>     n;</div><div class="line"><a name="l02718"></a><span class="lineno"> 2718</span>&#160;    char_u  *props;</div><div class="line"><a name="l02719"></a><span class="lineno"> 2719</span>&#160;    <span class="keywordtype">int</span>     new_len = 0;  <span class="comment">// init for gcc</span></div><div class="line"><a name="l02720"></a><span class="lineno"> 2720</span>&#160;    char_u  *new_line;</div><div class="line"><a name="l02721"></a><span class="lineno"> 2721</span>&#160;    <a class="code" href="structtextprop___s.html">textprop_T</a>  <a class="code" href="mbyte_8c.html#a4a8f6c91eefb9c6bf448592aac44153d">prop</a>;</div><div class="line"><a name="l02722"></a><span class="lineno"> 2722</span>&#160;</div><div class="line"><a name="l02723"></a><span class="lineno"> 2723</span>&#160;    <span class="comment">// Make two rounds:</span></div><div class="line"><a name="l02724"></a><span class="lineno"> 2724</span>&#160;    <span class="comment">// 1. calculate the extra space needed</span></div><div class="line"><a name="l02725"></a><span class="lineno"> 2725</span>&#160;    <span class="comment">// 2. allocate the space and fill it</span></div><div class="line"><a name="l02726"></a><span class="lineno"> 2726</span>&#160;    <span class="keywordflow">for</span> (round = 1; round &lt;= 2; ++round)</div><div class="line"><a name="l02727"></a><span class="lineno"> 2727</span>&#160;    {</div><div class="line"><a name="l02728"></a><span class="lineno"> 2728</span>&#160;    <span class="keywordflow">if</span> (round == 2)</div><div class="line"><a name="l02729"></a><span class="lineno"> 2729</span>&#160;    {</div><div class="line"><a name="l02730"></a><span class="lineno"> 2730</span>&#160;        <span class="keywordflow">if</span> (new_prop_count == 0)</div><div class="line"><a name="l02731"></a><span class="lineno"> 2731</span>&#160;        <span class="keywordflow">return</span>;  <span class="comment">// nothing to do</span></div><div class="line"><a name="l02732"></a><span class="lineno"> 2732</span>&#160;        new_len = *len + new_prop_count * <span class="keyword">sizeof</span>(<a class="code" href="structs_8h.html#a5c7e944c137636434555c8a7f0cfcd77">textprop_T</a>);</div><div class="line"><a name="l02733"></a><span class="lineno"> 2733</span>&#160;        new_line = <a class="code" href="misc2_8c.html#ad0b64e14955781629a3908e328f82665">alloc</a>(new_len);</div><div class="line"><a name="l02734"></a><span class="lineno"> 2734</span>&#160;        <span class="keywordflow">if</span> (new_line == NULL)</div><div class="line"><a name="l02735"></a><span class="lineno"> 2735</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l02736"></a><span class="lineno"> 2736</span>&#160;        <a class="code" href="os__unix_8h.html#ae70108db942e4f3eeb701ad8787b1835">mch_memmove</a>(new_line, *line, *len);</div><div class="line"><a name="l02737"></a><span class="lineno"> 2737</span>&#160;        new_prop_count = 0;</div><div class="line"><a name="l02738"></a><span class="lineno"> 2738</span>&#160;    }</div><div class="line"><a name="l02739"></a><span class="lineno"> 2739</span>&#160;</div><div class="line"><a name="l02740"></a><span class="lineno"> 2740</span>&#160;    <span class="comment">// Get the line above to find any props that continue in the next</span></div><div class="line"><a name="l02741"></a><span class="lineno"> 2741</span>&#160;    <span class="comment">// line.</span></div><div class="line"><a name="l02742"></a><span class="lineno"> 2742</span>&#160;    count = <a class="code" href="textprop_8c.html#a2ff749473010c82045a3dde52a9206bc">get_text_props</a>(buf, lnum, &amp;props, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l02743"></a><span class="lineno"> 2743</span>&#160;    <span class="keywordflow">for</span> (n = 0; n &lt; count; ++n)</div><div class="line"><a name="l02744"></a><span class="lineno"> 2744</span>&#160;    {</div><div class="line"><a name="l02745"></a><span class="lineno"> 2745</span>&#160;        <a class="code" href="os__unix_8h.html#ae70108db942e4f3eeb701ad8787b1835">mch_memmove</a>(&amp;prop, props + n * <span class="keyword">sizeof</span>(<a class="code" href="structtextprop___s.html">textprop_T</a>), <span class="keyword">sizeof</span>(<a class="code" href="structtextprop___s.html">textprop_T</a>));</div><div class="line"><a name="l02746"></a><span class="lineno"> 2746</span>&#160;        <span class="keywordflow">if</span> (prop.<a class="code" href="structtextprop___s.html#a37661218d497b414d619683e1063e09b">tp_flags</a> &amp; <a class="code" href="structs_8h.html#a1728259701820b8a8745485b2537217d">TP_FLAG_CONT_NEXT</a>)</div><div class="line"><a name="l02747"></a><span class="lineno"> 2747</span>&#160;        {</div><div class="line"><a name="l02748"></a><span class="lineno"> 2748</span>&#160;        <span class="keywordflow">if</span> (round == 2)</div><div class="line"><a name="l02749"></a><span class="lineno"> 2749</span>&#160;        {</div><div class="line"><a name="l02750"></a><span class="lineno"> 2750</span>&#160;            prop.<a class="code" href="structtextprop___s.html#a37661218d497b414d619683e1063e09b">tp_flags</a> |= <a class="code" href="structs_8h.html#ad2df9991ef69c281e2c46a0b9473dc06">TP_FLAG_CONT_PREV</a>;</div><div class="line"><a name="l02751"></a><span class="lineno"> 2751</span>&#160;            prop.<a class="code" href="structtextprop___s.html#a4c52970bf78ad518de599790e4e9c500">tp_col</a> = 1;</div><div class="line"><a name="l02752"></a><span class="lineno"> 2752</span>&#160;            prop.<a class="code" href="structtextprop___s.html#a92930deb459cef0462e9e4ce332fc579">tp_len</a> = *len;</div><div class="line"><a name="l02753"></a><span class="lineno"> 2753</span>&#160;            <a class="code" href="os__unix_8h.html#ae70108db942e4f3eeb701ad8787b1835">mch_memmove</a>(new_line + *len + new_prop_count * <span class="keyword">sizeof</span>(<a class="code" href="structtextprop___s.html">textprop_T</a>), &amp;prop, <span class="keyword">sizeof</span>(<a class="code" href="structtextprop___s.html">textprop_T</a>));</div><div class="line"><a name="l02754"></a><span class="lineno"> 2754</span>&#160;        }</div><div class="line"><a name="l02755"></a><span class="lineno"> 2755</span>&#160;        ++new_prop_count;</div><div class="line"><a name="l02756"></a><span class="lineno"> 2756</span>&#160;        }</div><div class="line"><a name="l02757"></a><span class="lineno"> 2757</span>&#160;    }</div><div class="line"><a name="l02758"></a><span class="lineno"> 2758</span>&#160;    }</div><div class="line"><a name="l02759"></a><span class="lineno"> 2759</span>&#160;    *line = new_line;</div><div class="line"><a name="l02760"></a><span class="lineno"> 2760</span>&#160;    *tofree = new_line;</div><div class="line"><a name="l02761"></a><span class="lineno"> 2761</span>&#160;    *len = new_len;</div><div class="line"><a name="l02762"></a><span class="lineno"> 2762</span>&#160;}</div><div class="line"><a name="l02763"></a><span class="lineno"> 2763</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l02764"></a><span class="lineno"> 2764</span>&#160;</div><div class="line"><a name="l02765"></a><span class="lineno"> 2765</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">int</span></div><div class="line"><a name="l02766"></a><span class="lineno"><a class="line" href="memline_8c.html#abed76281f9b8f3fe0572784ba8aaa040"> 2766</a></span>&#160;<a class="code" href="memline_8c.html#abed76281f9b8f3fe0572784ba8aaa040">ml_append_int</a>(</div><div class="line"><a name="l02767"></a><span class="lineno"> 2767</span>&#160;    <a class="code" href="structfile__buffer.html">buf_T</a>   *buf,</div><div class="line"><a name="l02768"></a><span class="lineno"> 2768</span>&#160;    <a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>    lnum,       <span class="comment">// append after this line (can be 0)</span></div><div class="line"><a name="l02769"></a><span class="lineno"> 2769</span>&#160;    char_u  *line_arg,  <span class="comment">// text of the new line</span></div><div class="line"><a name="l02770"></a><span class="lineno"> 2770</span>&#160;    <a class="code" href="vim_8h.html#ae79e04a416bd6ce8ffe80e241850c0d2">colnr_T</a> len_arg,    <span class="comment">// length of line, including NUL, or 0</span></div><div class="line"><a name="l02771"></a><span class="lineno"> 2771</span>&#160;    <span class="keywordtype">int</span>     newfile,    <span class="comment">// flag, see above</span></div><div class="line"><a name="l02772"></a><span class="lineno"> 2772</span>&#160;    <span class="keywordtype">int</span>     mark)       <span class="comment">// mark the new line</span></div><div class="line"><a name="l02773"></a><span class="lineno"> 2773</span>&#160;{</div><div class="line"><a name="l02774"></a><span class="lineno"> 2774</span>&#160;    char_u  *line = line_arg;</div><div class="line"><a name="l02775"></a><span class="lineno"> 2775</span>&#160;    <a class="code" href="vim_8h.html#ae79e04a416bd6ce8ffe80e241850c0d2">colnr_T</a> len = len_arg;</div><div class="line"><a name="l02776"></a><span class="lineno"> 2776</span>&#160;    <span class="keywordtype">int</span>     i;</div><div class="line"><a name="l02777"></a><span class="lineno"> 2777</span>&#160;    <span class="keywordtype">int</span>     line_count; <span class="comment">// number of indexes in current block</span></div><div class="line"><a name="l02778"></a><span class="lineno"> 2778</span>&#160;    <span class="keywordtype">int</span>     offset;</div><div class="line"><a name="l02779"></a><span class="lineno"> 2779</span>&#160;    <span class="keywordtype">int</span>     from, to;</div><div class="line"><a name="l02780"></a><span class="lineno"> 2780</span>&#160;    <span class="keywordtype">int</span>     space_needed;   <span class="comment">// space needed for new line</span></div><div class="line"><a name="l02781"></a><span class="lineno"> 2781</span>&#160;    <span class="keywordtype">int</span>     page_size;</div><div class="line"><a name="l02782"></a><span class="lineno"> 2782</span>&#160;    <span class="keywordtype">int</span>     <a class="code" href="hardcopy_8c.html#a8779304c095e1ed27c30d4b5b3f2437a">page_count</a>;</div><div class="line"><a name="l02783"></a><span class="lineno"> 2783</span>&#160;    <span class="keywordtype">int</span>     db_idx;     <span class="comment">// index for lnum in data block</span></div><div class="line"><a name="l02784"></a><span class="lineno"> 2784</span>&#160;    <a class="code" href="structblock__hdr.html">bhdr_T</a>  *hp;</div><div class="line"><a name="l02785"></a><span class="lineno"> 2785</span>&#160;    <a class="code" href="structmemfile.html">memfile_T</a>   *mfp;</div><div class="line"><a name="l02786"></a><span class="lineno"> 2786</span>&#160;    <a class="code" href="structdata__block.html">DATA_BL</a> *dp;</div><div class="line"><a name="l02787"></a><span class="lineno"> 2787</span>&#160;    <a class="code" href="structpointer__block.html">PTR_BL</a>  *pp;</div><div class="line"><a name="l02788"></a><span class="lineno"> 2788</span>&#160;    <a class="code" href="structinfo__pointer.html">infoptr_T</a>   *<a class="code" href="namespacetest__channel.html#a6a2152bf75d93cd14fcffc99c3e76807">ip</a>;</div><div class="line"><a name="l02789"></a><span class="lineno"> 2789</span>&#160;<span class="preprocessor">#ifdef FEAT_TEXT_PROP</span></div><div class="line"><a name="l02790"></a><span class="lineno"> 2790</span>&#160;    char_u  *tofree = NULL;</div><div class="line"><a name="l02791"></a><span class="lineno"> 2791</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l02792"></a><span class="lineno"> 2792</span>&#160;    <span class="keywordtype">int</span>     ret = <a class="code" href="dosinst_8h.html#abb508ea8227673f419e9fe3a86c30d8e">FAIL</a>;</div><div class="line"><a name="l02793"></a><span class="lineno"> 2793</span>&#160;</div><div class="line"><a name="l02794"></a><span class="lineno"> 2794</span>&#160;    <span class="keywordflow">if</span> (lnum &gt; buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a708091d31fa9cf7718aca80d707b1b3d">ml_line_count</a> || buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a9adb5a08b3c01be69c98360a14937227">ml_mfp</a> == NULL)</div><div class="line"><a name="l02795"></a><span class="lineno"> 2795</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="dosinst_8h.html#abb508ea8227673f419e9fe3a86c30d8e">FAIL</a>;  <span class="comment">// lnum out of range</span></div><div class="line"><a name="l02796"></a><span class="lineno"> 2796</span>&#160;</div><div class="line"><a name="l02797"></a><span class="lineno"> 2797</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="memline_8c.html#a8837c8c8a497ab410a9e925581f966c3">lowest_marked</a> &amp;&amp; <a class="code" href="memline_8c.html#a8837c8c8a497ab410a9e925581f966c3">lowest_marked</a> &gt; lnum)</div><div class="line"><a name="l02798"></a><span class="lineno"> 2798</span>&#160;    <a class="code" href="memline_8c.html#a8837c8c8a497ab410a9e925581f966c3">lowest_marked</a> = lnum + 1;</div><div class="line"><a name="l02799"></a><span class="lineno"> 2799</span>&#160;</div><div class="line"><a name="l02800"></a><span class="lineno"> 2800</span>&#160;    <span class="keywordflow">if</span> (len == 0)</div><div class="line"><a name="l02801"></a><span class="lineno"> 2801</span>&#160;    len = (<a class="code" href="vim_8h.html#ae79e04a416bd6ce8ffe80e241850c0d2">colnr_T</a>)<a class="code" href="vim_8h.html#a916ffefe1fc74532d08102cca55d8e34">STRLEN</a>(line) + 1;    <span class="comment">// space needed for the text</span></div><div class="line"><a name="l02802"></a><span class="lineno"> 2802</span>&#160;</div><div class="line"><a name="l02803"></a><span class="lineno"> 2803</span>&#160;<span class="preprocessor">#ifdef FEAT_TEXT_PROP</span></div><div class="line"><a name="l02804"></a><span class="lineno"> 2804</span>&#160;    <span class="keywordflow">if</span> (curbuf-&gt;b_has_textprop &amp;&amp; lnum &gt; 0)</div><div class="line"><a name="l02805"></a><span class="lineno"> 2805</span>&#160;    <span class="comment">// Add text properties that continue from the previous line.</span></div><div class="line"><a name="l02806"></a><span class="lineno"> 2806</span>&#160;    <a class="code" href="memline_8c.html#aaabdfc4378cd70463534636d2d00c50d">add_text_props_for_append</a>(buf, lnum, &amp;line, &amp;len, &amp;tofree);</div><div class="line"><a name="l02807"></a><span class="lineno"> 2807</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l02808"></a><span class="lineno"> 2808</span>&#160;</div><div class="line"><a name="l02809"></a><span class="lineno"> 2809</span>&#160;    space_needed = len + <a class="code" href="memline_8c.html#a33bdc994ac7c8cda7d0df1a3369ab965">INDEX_SIZE</a>;    <span class="comment">// space needed for text + index</span></div><div class="line"><a name="l02810"></a><span class="lineno"> 2810</span>&#160;</div><div class="line"><a name="l02811"></a><span class="lineno"> 2811</span>&#160;    mfp = buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a9adb5a08b3c01be69c98360a14937227">ml_mfp</a>;</div><div class="line"><a name="l02812"></a><span class="lineno"> 2812</span>&#160;    page_size = mfp-&gt;<a class="code" href="structmemfile.html#ab0c66141886a009d8132b8e1e2a00fc6">mf_page_size</a>;</div><div class="line"><a name="l02813"></a><span class="lineno"> 2813</span>&#160;</div><div class="line"><a name="l02814"></a><span class="lineno"> 2814</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l02815"></a><span class="lineno"> 2815</span>&#160;<span class="comment"> * find the data block containing the previous line</span></div><div class="line"><a name="l02816"></a><span class="lineno"> 2816</span>&#160;<span class="comment"> * This also fills the stack with the blocks from the root to the data block</span></div><div class="line"><a name="l02817"></a><span class="lineno"> 2817</span>&#160;<span class="comment"> * This also releases any locked block.</span></div><div class="line"><a name="l02818"></a><span class="lineno"> 2818</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l02819"></a><span class="lineno"> 2819</span>&#160;    <span class="keywordflow">if</span> ((hp = <a class="code" href="memline_8c.html#ade8fe98188345bdd3c230545fc4a614f">ml_find_line</a>(buf, lnum == 0 ? (<a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>)1 : lnum,</div><div class="line"><a name="l02820"></a><span class="lineno"> 2820</span>&#160;                              <a class="code" href="memline_8c.html#a1fc0269a34abf68fee5e99b51879fa4b">ML_INSERT</a>)) == NULL)</div><div class="line"><a name="l02821"></a><span class="lineno"> 2821</span>&#160;    <span class="keywordflow">goto</span> theend;</div><div class="line"><a name="l02822"></a><span class="lineno"> 2822</span>&#160;</div><div class="line"><a name="l02823"></a><span class="lineno"> 2823</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a30f30ddb7264f667a92556f0568981e0">ml_flags</a> &amp;= ~<a class="code" href="structs_8h.html#a67ecfd4d644d8b33ba15512b7136602a">ML_EMPTY</a>;</div><div class="line"><a name="l02824"></a><span class="lineno"> 2824</span>&#160;</div><div class="line"><a name="l02825"></a><span class="lineno"> 2825</span>&#160;    <span class="keywordflow">if</span> (lnum == 0)      <span class="comment">/* got line one instead, correct db_idx */</span></div><div class="line"><a name="l02826"></a><span class="lineno"> 2826</span>&#160;    db_idx = -1;        <span class="comment">/* careful, it is negative! */</span></div><div class="line"><a name="l02827"></a><span class="lineno"> 2827</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l02828"></a><span class="lineno"> 2828</span>&#160;    db_idx = lnum - buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a2b7c6e30401df9d0e8972cb639d1b895">ml_locked_low</a>;</div><div class="line"><a name="l02829"></a><span class="lineno"> 2829</span>&#160;        <span class="comment">/* get line count before the insertion */</span></div><div class="line"><a name="l02830"></a><span class="lineno"> 2830</span>&#160;    line_count = buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a81788089e53748eb945a88d6e41647da">ml_locked_high</a> - buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a2b7c6e30401df9d0e8972cb639d1b895">ml_locked_low</a>;</div><div class="line"><a name="l02831"></a><span class="lineno"> 2831</span>&#160;</div><div class="line"><a name="l02832"></a><span class="lineno"> 2832</span>&#160;    dp = (<a class="code" href="structdata__block.html">DATA_BL</a> *)(hp-&gt;<a class="code" href="structblock__hdr.html#a7247cdc0977ab6fdc9cb6238cda67587">bh_data</a>);</div><div class="line"><a name="l02833"></a><span class="lineno"> 2833</span>&#160;</div><div class="line"><a name="l02834"></a><span class="lineno"> 2834</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l02835"></a><span class="lineno"> 2835</span>&#160;<span class="comment"> * If</span></div><div class="line"><a name="l02836"></a><span class="lineno"> 2836</span>&#160;<span class="comment"> * - there is not enough room in the current block</span></div><div class="line"><a name="l02837"></a><span class="lineno"> 2837</span>&#160;<span class="comment"> * - appending to the last line in the block</span></div><div class="line"><a name="l02838"></a><span class="lineno"> 2838</span>&#160;<span class="comment"> * - not appending to the last line in the file</span></div><div class="line"><a name="l02839"></a><span class="lineno"> 2839</span>&#160;<span class="comment"> * insert in front of the next block.</span></div><div class="line"><a name="l02840"></a><span class="lineno"> 2840</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l02841"></a><span class="lineno"> 2841</span>&#160;    <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)dp-&gt;<a class="code" href="structdata__block.html#a6cd7e5186f74ae199fe547bc905b2815">db_free</a> &lt; space_needed &amp;&amp; db_idx == line_count - 1</div><div class="line"><a name="l02842"></a><span class="lineno"> 2842</span>&#160;                        &amp;&amp; lnum &lt; buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a708091d31fa9cf7718aca80d707b1b3d">ml_line_count</a>)</div><div class="line"><a name="l02843"></a><span class="lineno"> 2843</span>&#160;    {</div><div class="line"><a name="l02844"></a><span class="lineno"> 2844</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l02845"></a><span class="lineno"> 2845</span>&#160;<span class="comment">     * Now that the line is not going to be inserted in the block that we</span></div><div class="line"><a name="l02846"></a><span class="lineno"> 2846</span>&#160;<span class="comment">     * expected, the line count has to be adjusted in the pointer blocks</span></div><div class="line"><a name="l02847"></a><span class="lineno"> 2847</span>&#160;<span class="comment">     * by using ml_locked_lineadd.</span></div><div class="line"><a name="l02848"></a><span class="lineno"> 2848</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l02849"></a><span class="lineno"> 2849</span>&#160;    --(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a97f953057f1eaa0360502866f1e54964">ml_locked_lineadd</a>);</div><div class="line"><a name="l02850"></a><span class="lineno"> 2850</span>&#160;    --(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a81788089e53748eb945a88d6e41647da">ml_locked_high</a>);</div><div class="line"><a name="l02851"></a><span class="lineno"> 2851</span>&#160;    <span class="keywordflow">if</span> ((hp = <a class="code" href="memline_8c.html#ade8fe98188345bdd3c230545fc4a614f">ml_find_line</a>(buf, lnum + 1, <a class="code" href="memline_8c.html#a1fc0269a34abf68fee5e99b51879fa4b">ML_INSERT</a>)) == NULL)</div><div class="line"><a name="l02852"></a><span class="lineno"> 2852</span>&#160;        <span class="keywordflow">goto</span> theend;</div><div class="line"><a name="l02853"></a><span class="lineno"> 2853</span>&#160;</div><div class="line"><a name="l02854"></a><span class="lineno"> 2854</span>&#160;    db_idx = -1;            <span class="comment">/* careful, it is negative! */</span></div><div class="line"><a name="l02855"></a><span class="lineno"> 2855</span>&#160;            <span class="comment">/* get line count before the insertion */</span></div><div class="line"><a name="l02856"></a><span class="lineno"> 2856</span>&#160;    line_count = buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a81788089e53748eb945a88d6e41647da">ml_locked_high</a> - buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a2b7c6e30401df9d0e8972cb639d1b895">ml_locked_low</a>;</div><div class="line"><a name="l02857"></a><span class="lineno"> 2857</span>&#160;    <a class="code" href="memline_8c.html#a4c3f0432d972be512c1ff55974987c8c">CHECK</a>(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a2b7c6e30401df9d0e8972cb639d1b895">ml_locked_low</a> != lnum + 1, <span class="stringliteral">&quot;locked_low != lnum + 1&quot;</span>);</div><div class="line"><a name="l02858"></a><span class="lineno"> 2858</span>&#160;</div><div class="line"><a name="l02859"></a><span class="lineno"> 2859</span>&#160;    dp = (<a class="code" href="structdata__block.html">DATA_BL</a> *)(hp-&gt;<a class="code" href="structblock__hdr.html#a7247cdc0977ab6fdc9cb6238cda67587">bh_data</a>);</div><div class="line"><a name="l02860"></a><span class="lineno"> 2860</span>&#160;    }</div><div class="line"><a name="l02861"></a><span class="lineno"> 2861</span>&#160;</div><div class="line"><a name="l02862"></a><span class="lineno"> 2862</span>&#160;    ++buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a708091d31fa9cf7718aca80d707b1b3d">ml_line_count</a>;</div><div class="line"><a name="l02863"></a><span class="lineno"> 2863</span>&#160;</div><div class="line"><a name="l02864"></a><span class="lineno"> 2864</span>&#160;    <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)dp-&gt;<a class="code" href="structdata__block.html#a6cd7e5186f74ae199fe547bc905b2815">db_free</a> &gt;= space_needed)   <span class="comment">/* enough room in data block */</span></div><div class="line"><a name="l02865"></a><span class="lineno"> 2865</span>&#160;    {</div><div class="line"><a name="l02866"></a><span class="lineno"> 2866</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l02867"></a><span class="lineno"> 2867</span>&#160;<span class="comment">     * Insert the new line in an existing data block, or in the data block</span></div><div class="line"><a name="l02868"></a><span class="lineno"> 2868</span>&#160;<span class="comment">     * allocated above.</span></div><div class="line"><a name="l02869"></a><span class="lineno"> 2869</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l02870"></a><span class="lineno"> 2870</span>&#160;    dp-&gt;<a class="code" href="structdata__block.html#a3937f5841b2fed9a042872981b06a7b8">db_txt_start</a> -= len;</div><div class="line"><a name="l02871"></a><span class="lineno"> 2871</span>&#160;    dp-&gt;<a class="code" href="structdata__block.html#a6cd7e5186f74ae199fe547bc905b2815">db_free</a> -= space_needed;</div><div class="line"><a name="l02872"></a><span class="lineno"> 2872</span>&#160;    ++(dp-&gt;<a class="code" href="structdata__block.html#a00084a39a3bdd9a03b9a055216aec5c5">db_line_count</a>);</div><div class="line"><a name="l02873"></a><span class="lineno"> 2873</span>&#160;</div><div class="line"><a name="l02874"></a><span class="lineno"> 2874</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l02875"></a><span class="lineno"> 2875</span>&#160;<span class="comment">     * move the text of the lines that follow to the front</span></div><div class="line"><a name="l02876"></a><span class="lineno"> 2876</span>&#160;<span class="comment">     * adjust the indexes of the lines that follow</span></div><div class="line"><a name="l02877"></a><span class="lineno"> 2877</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l02878"></a><span class="lineno"> 2878</span>&#160;    <span class="keywordflow">if</span> (line_count &gt; db_idx + 1)        <span class="comment">/* if there are following lines */</span></div><div class="line"><a name="l02879"></a><span class="lineno"> 2879</span>&#160;    {</div><div class="line"><a name="l02880"></a><span class="lineno"> 2880</span>&#160;        <span class="comment">/*</span></div><div class="line"><a name="l02881"></a><span class="lineno"> 2881</span>&#160;<span class="comment">         * Offset is the start of the previous line.</span></div><div class="line"><a name="l02882"></a><span class="lineno"> 2882</span>&#160;<span class="comment">         * This will become the character just after the new line.</span></div><div class="line"><a name="l02883"></a><span class="lineno"> 2883</span>&#160;<span class="comment">         */</span></div><div class="line"><a name="l02884"></a><span class="lineno"> 2884</span>&#160;        <span class="keywordflow">if</span> (db_idx &lt; 0)</div><div class="line"><a name="l02885"></a><span class="lineno"> 2885</span>&#160;        offset = dp-&gt;<a class="code" href="structdata__block.html#ae079e3993bfc47bd86fd6e2fc3ab44ba">db_txt_end</a>;</div><div class="line"><a name="l02886"></a><span class="lineno"> 2886</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l02887"></a><span class="lineno"> 2887</span>&#160;        offset = ((dp-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[db_idx]) &amp; <a class="code" href="memline_8c.html#ab65775db0f7dbf161fce05ee7fb36573">DB_INDEX_MASK</a>);</div><div class="line"><a name="l02888"></a><span class="lineno"> 2888</span>&#160;        <a class="code" href="os__unix_8h.html#ae70108db942e4f3eeb701ad8787b1835">mch_memmove</a>((<span class="keywordtype">char</span> *)dp + dp-&gt;<a class="code" href="structdata__block.html#a3937f5841b2fed9a042872981b06a7b8">db_txt_start</a>,</div><div class="line"><a name="l02889"></a><span class="lineno"> 2889</span>&#160;                      (<span class="keywordtype">char</span> *)dp + dp-&gt;<a class="code" href="structdata__block.html#a3937f5841b2fed9a042872981b06a7b8">db_txt_start</a> + len,</div><div class="line"><a name="l02890"></a><span class="lineno"> 2890</span>&#160;                 (<span class="keywordtype">size_t</span>)(offset - (dp-&gt;<a class="code" href="structdata__block.html#a3937f5841b2fed9a042872981b06a7b8">db_txt_start</a> + len)));</div><div class="line"><a name="l02891"></a><span class="lineno"> 2891</span>&#160;        <span class="keywordflow">for</span> (i = line_count - 1; i &gt; db_idx; --i)</div><div class="line"><a name="l02892"></a><span class="lineno"> 2892</span>&#160;        dp-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[i + 1] = dp-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[i] - len;</div><div class="line"><a name="l02893"></a><span class="lineno"> 2893</span>&#160;        dp-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[db_idx + 1] = offset - len;</div><div class="line"><a name="l02894"></a><span class="lineno"> 2894</span>&#160;    }</div><div class="line"><a name="l02895"></a><span class="lineno"> 2895</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l02896"></a><span class="lineno"> 2896</span>&#160;        <span class="comment">// add line at the end (which is the start of the text)</span></div><div class="line"><a name="l02897"></a><span class="lineno"> 2897</span>&#160;        dp-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[db_idx + 1] = dp-&gt;<a class="code" href="structdata__block.html#a3937f5841b2fed9a042872981b06a7b8">db_txt_start</a>;</div><div class="line"><a name="l02898"></a><span class="lineno"> 2898</span>&#160;</div><div class="line"><a name="l02899"></a><span class="lineno"> 2899</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l02900"></a><span class="lineno"> 2900</span>&#160;<span class="comment">     * copy the text into the block</span></div><div class="line"><a name="l02901"></a><span class="lineno"> 2901</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l02902"></a><span class="lineno"> 2902</span>&#160;    <a class="code" href="os__unix_8h.html#ae70108db942e4f3eeb701ad8787b1835">mch_memmove</a>((<span class="keywordtype">char</span> *)dp + dp-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[db_idx + 1], line, (<span class="keywordtype">size_t</span>)len);</div><div class="line"><a name="l02903"></a><span class="lineno"> 2903</span>&#160;    <span class="keywordflow">if</span> (mark)</div><div class="line"><a name="l02904"></a><span class="lineno"> 2904</span>&#160;        dp-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[db_idx + 1] |= <a class="code" href="memline_8c.html#ab994bfde1fec8c463065bbb9a402a35d">DB_MARKED</a>;</div><div class="line"><a name="l02905"></a><span class="lineno"> 2905</span>&#160;</div><div class="line"><a name="l02906"></a><span class="lineno"> 2906</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l02907"></a><span class="lineno"> 2907</span>&#160;<span class="comment">     * Mark the block dirty.</span></div><div class="line"><a name="l02908"></a><span class="lineno"> 2908</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l02909"></a><span class="lineno"> 2909</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a30f30ddb7264f667a92556f0568981e0">ml_flags</a> |= <a class="code" href="structs_8h.html#ad55a676a17d24163d3cdb2bf75a7fa66">ML_LOCKED_DIRTY</a>;</div><div class="line"><a name="l02910"></a><span class="lineno"> 2910</span>&#160;    <span class="keywordflow">if</span> (!newfile)</div><div class="line"><a name="l02911"></a><span class="lineno"> 2911</span>&#160;        buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a30f30ddb7264f667a92556f0568981e0">ml_flags</a> |= <a class="code" href="structs_8h.html#a094e033c133f0276ed3c00f8053d0175">ML_LOCKED_POS</a>;</div><div class="line"><a name="l02912"></a><span class="lineno"> 2912</span>&#160;    }</div><div class="line"><a name="l02913"></a><span class="lineno"> 2913</span>&#160;    <span class="keywordflow">else</span>        <span class="comment">/* not enough space in data block */</span></div><div class="line"><a name="l02914"></a><span class="lineno"> 2914</span>&#160;    {</div><div class="line"><a name="l02915"></a><span class="lineno"> 2915</span>&#160;    <span class="keywordtype">long</span>        line_count_left, line_count_right;</div><div class="line"><a name="l02916"></a><span class="lineno"> 2916</span>&#160;    <span class="keywordtype">int</span>     page_count_left, page_count_right;</div><div class="line"><a name="l02917"></a><span class="lineno"> 2917</span>&#160;    <a class="code" href="structblock__hdr.html">bhdr_T</a>      *hp_left;</div><div class="line"><a name="l02918"></a><span class="lineno"> 2918</span>&#160;    <a class="code" href="structblock__hdr.html">bhdr_T</a>      *hp_right;</div><div class="line"><a name="l02919"></a><span class="lineno"> 2919</span>&#160;    <a class="code" href="structblock__hdr.html">bhdr_T</a>      *hp_new;</div><div class="line"><a name="l02920"></a><span class="lineno"> 2920</span>&#160;    <span class="keywordtype">int</span>     lines_moved;</div><div class="line"><a name="l02921"></a><span class="lineno"> 2921</span>&#160;    <span class="keywordtype">int</span>     data_moved = 0;     <span class="comment">/* init to shut up gcc */</span></div><div class="line"><a name="l02922"></a><span class="lineno"> 2922</span>&#160;    <span class="keywordtype">int</span>     total_moved = 0;        <span class="comment">/* init to shut up gcc */</span></div><div class="line"><a name="l02923"></a><span class="lineno"> 2923</span>&#160;    <a class="code" href="structdata__block.html">DATA_BL</a>     *dp_right, *dp_left;</div><div class="line"><a name="l02924"></a><span class="lineno"> 2924</span>&#160;    <span class="keywordtype">int</span>     stack_idx;</div><div class="line"><a name="l02925"></a><span class="lineno"> 2925</span>&#160;    <span class="keywordtype">int</span>     in_left;</div><div class="line"><a name="l02926"></a><span class="lineno"> 2926</span>&#160;    <span class="keywordtype">int</span>     lineadd;</div><div class="line"><a name="l02927"></a><span class="lineno"> 2927</span>&#160;    <a class="code" href="structs_8h.html#a012394c4a7db63f99f6f0cdacab79527">blocknr_T</a>   bnum_left, bnum_right;</div><div class="line"><a name="l02928"></a><span class="lineno"> 2928</span>&#160;    <a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>    lnum_left, lnum_right;</div><div class="line"><a name="l02929"></a><span class="lineno"> 2929</span>&#160;    <span class="keywordtype">int</span>     pb_idx;</div><div class="line"><a name="l02930"></a><span class="lineno"> 2930</span>&#160;    <a class="code" href="structpointer__block.html">PTR_BL</a>      *pp_new;</div><div class="line"><a name="l02931"></a><span class="lineno"> 2931</span>&#160;</div><div class="line"><a name="l02932"></a><span class="lineno"> 2932</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l02933"></a><span class="lineno"> 2933</span>&#160;<span class="comment">     * There is not enough room, we have to create a new data block and</span></div><div class="line"><a name="l02934"></a><span class="lineno"> 2934</span>&#160;<span class="comment">     * copy some lines into it.</span></div><div class="line"><a name="l02935"></a><span class="lineno"> 2935</span>&#160;<span class="comment">     * Then we have to insert an entry in the pointer block.</span></div><div class="line"><a name="l02936"></a><span class="lineno"> 2936</span>&#160;<span class="comment">     * If this pointer block also is full, we go up another block, and so</span></div><div class="line"><a name="l02937"></a><span class="lineno"> 2937</span>&#160;<span class="comment">     * on, up to the root if necessary.</span></div><div class="line"><a name="l02938"></a><span class="lineno"> 2938</span>&#160;<span class="comment">     * The line counts in the pointer blocks have already been adjusted by</span></div><div class="line"><a name="l02939"></a><span class="lineno"> 2939</span>&#160;<span class="comment">     * ml_find_line().</span></div><div class="line"><a name="l02940"></a><span class="lineno"> 2940</span>&#160;<span class="comment">     *</span></div><div class="line"><a name="l02941"></a><span class="lineno"> 2941</span>&#160;<span class="comment">     * We are going to allocate a new data block. Depending on the</span></div><div class="line"><a name="l02942"></a><span class="lineno"> 2942</span>&#160;<span class="comment">     * situation it will be put to the left or right of the existing</span></div><div class="line"><a name="l02943"></a><span class="lineno"> 2943</span>&#160;<span class="comment">     * block.  If possible we put the new line in the left block and move</span></div><div class="line"><a name="l02944"></a><span class="lineno"> 2944</span>&#160;<span class="comment">     * the lines after it to the right block. Otherwise the new line is</span></div><div class="line"><a name="l02945"></a><span class="lineno"> 2945</span>&#160;<span class="comment">     * also put in the right block. This method is more efficient when</span></div><div class="line"><a name="l02946"></a><span class="lineno"> 2946</span>&#160;<span class="comment">     * inserting a lot of lines at one place.</span></div><div class="line"><a name="l02947"></a><span class="lineno"> 2947</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l02948"></a><span class="lineno"> 2948</span>&#160;    <span class="keywordflow">if</span> (db_idx &lt; 0)     <span class="comment">/* left block is new, right block is existing */</span></div><div class="line"><a name="l02949"></a><span class="lineno"> 2949</span>&#160;    {</div><div class="line"><a name="l02950"></a><span class="lineno"> 2950</span>&#160;        lines_moved = 0;</div><div class="line"><a name="l02951"></a><span class="lineno"> 2951</span>&#160;        in_left = <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"><a name="l02952"></a><span class="lineno"> 2952</span>&#160;        <span class="comment">/* space_needed does not change */</span></div><div class="line"><a name="l02953"></a><span class="lineno"> 2953</span>&#160;    }</div><div class="line"><a name="l02954"></a><span class="lineno"> 2954</span>&#160;    <span class="keywordflow">else</span>            <span class="comment">/* left block is existing, right block is new */</span></div><div class="line"><a name="l02955"></a><span class="lineno"> 2955</span>&#160;    {</div><div class="line"><a name="l02956"></a><span class="lineno"> 2956</span>&#160;        lines_moved = line_count - db_idx - 1;</div><div class="line"><a name="l02957"></a><span class="lineno"> 2957</span>&#160;        <span class="keywordflow">if</span> (lines_moved == 0)</div><div class="line"><a name="l02958"></a><span class="lineno"> 2958</span>&#160;        in_left = <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;    <span class="comment">/* put new line in right block */</span></div><div class="line"><a name="l02959"></a><span class="lineno"> 2959</span>&#160;                    <span class="comment">/* space_needed does not change */</span></div><div class="line"><a name="l02960"></a><span class="lineno"> 2960</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l02961"></a><span class="lineno"> 2961</span>&#160;        {</div><div class="line"><a name="l02962"></a><span class="lineno"> 2962</span>&#160;        data_moved = ((dp-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[db_idx]) &amp; <a class="code" href="memline_8c.html#ab65775db0f7dbf161fce05ee7fb36573">DB_INDEX_MASK</a>) -</div><div class="line"><a name="l02963"></a><span class="lineno"> 2963</span>&#160;                                dp-&gt;<a class="code" href="structdata__block.html#a3937f5841b2fed9a042872981b06a7b8">db_txt_start</a>;</div><div class="line"><a name="l02964"></a><span class="lineno"> 2964</span>&#160;        total_moved = data_moved + lines_moved * <a class="code" href="memline_8c.html#a33bdc994ac7c8cda7d0df1a3369ab965">INDEX_SIZE</a>;</div><div class="line"><a name="l02965"></a><span class="lineno"> 2965</span>&#160;        <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)dp-&gt;<a class="code" href="structdata__block.html#a6cd7e5186f74ae199fe547bc905b2815">db_free</a> + total_moved &gt;= space_needed)</div><div class="line"><a name="l02966"></a><span class="lineno"> 2966</span>&#160;        {</div><div class="line"><a name="l02967"></a><span class="lineno"> 2967</span>&#160;            in_left = <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>; <span class="comment">/* put new line in left block */</span></div><div class="line"><a name="l02968"></a><span class="lineno"> 2968</span>&#160;            space_needed = total_moved;</div><div class="line"><a name="l02969"></a><span class="lineno"> 2969</span>&#160;        }</div><div class="line"><a name="l02970"></a><span class="lineno"> 2970</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l02971"></a><span class="lineno"> 2971</span>&#160;        {</div><div class="line"><a name="l02972"></a><span class="lineno"> 2972</span>&#160;            in_left = <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;        <span class="comment">/* put new line in right block */</span></div><div class="line"><a name="l02973"></a><span class="lineno"> 2973</span>&#160;            space_needed += total_moved;</div><div class="line"><a name="l02974"></a><span class="lineno"> 2974</span>&#160;        }</div><div class="line"><a name="l02975"></a><span class="lineno"> 2975</span>&#160;        }</div><div class="line"><a name="l02976"></a><span class="lineno"> 2976</span>&#160;    }</div><div class="line"><a name="l02977"></a><span class="lineno"> 2977</span>&#160;</div><div class="line"><a name="l02978"></a><span class="lineno"> 2978</span>&#160;    page_count = ((space_needed + <a class="code" href="memline_8c.html#a49999be01380f41cc0d0f1f1406fb277">HEADER_SIZE</a>) + page_size - 1) / page_size;</div><div class="line"><a name="l02979"></a><span class="lineno"> 2979</span>&#160;    <span class="keywordflow">if</span> ((hp_new = <a class="code" href="memline_8c.html#a143a4d348c1d7c3e5ccc591f6653a984">ml_new_data</a>(mfp, newfile, page_count)) == NULL)</div><div class="line"><a name="l02980"></a><span class="lineno"> 2980</span>&#160;    {</div><div class="line"><a name="l02981"></a><span class="lineno"> 2981</span>&#160;            <span class="comment">/* correct line counts in pointer blocks */</span></div><div class="line"><a name="l02982"></a><span class="lineno"> 2982</span>&#160;        --(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a97f953057f1eaa0360502866f1e54964">ml_locked_lineadd</a>);</div><div class="line"><a name="l02983"></a><span class="lineno"> 2983</span>&#160;        --(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a81788089e53748eb945a88d6e41647da">ml_locked_high</a>);</div><div class="line"><a name="l02984"></a><span class="lineno"> 2984</span>&#160;        <span class="keywordflow">goto</span> theend;</div><div class="line"><a name="l02985"></a><span class="lineno"> 2985</span>&#160;    }</div><div class="line"><a name="l02986"></a><span class="lineno"> 2986</span>&#160;    <span class="keywordflow">if</span> (db_idx &lt; 0)     <span class="comment">/* left block is new */</span></div><div class="line"><a name="l02987"></a><span class="lineno"> 2987</span>&#160;    {</div><div class="line"><a name="l02988"></a><span class="lineno"> 2988</span>&#160;        hp_left = hp_new;</div><div class="line"><a name="l02989"></a><span class="lineno"> 2989</span>&#160;        hp_right = hp;</div><div class="line"><a name="l02990"></a><span class="lineno"> 2990</span>&#160;        line_count_left = 0;</div><div class="line"><a name="l02991"></a><span class="lineno"> 2991</span>&#160;        line_count_right = line_count;</div><div class="line"><a name="l02992"></a><span class="lineno"> 2992</span>&#160;    }</div><div class="line"><a name="l02993"></a><span class="lineno"> 2993</span>&#160;    <span class="keywordflow">else</span>            <span class="comment">/* right block is new */</span></div><div class="line"><a name="l02994"></a><span class="lineno"> 2994</span>&#160;    {</div><div class="line"><a name="l02995"></a><span class="lineno"> 2995</span>&#160;        hp_left = hp;</div><div class="line"><a name="l02996"></a><span class="lineno"> 2996</span>&#160;        hp_right = hp_new;</div><div class="line"><a name="l02997"></a><span class="lineno"> 2997</span>&#160;        line_count_left = line_count;</div><div class="line"><a name="l02998"></a><span class="lineno"> 2998</span>&#160;        line_count_right = 0;</div><div class="line"><a name="l02999"></a><span class="lineno"> 2999</span>&#160;    }</div><div class="line"><a name="l03000"></a><span class="lineno"> 3000</span>&#160;    dp_right = (<a class="code" href="structdata__block.html">DATA_BL</a> *)(hp_right-&gt;<a class="code" href="structblock__hdr.html#a7247cdc0977ab6fdc9cb6238cda67587">bh_data</a>);</div><div class="line"><a name="l03001"></a><span class="lineno"> 3001</span>&#160;    dp_left = (<a class="code" href="structdata__block.html">DATA_BL</a> *)(hp_left-&gt;<a class="code" href="structblock__hdr.html#a7247cdc0977ab6fdc9cb6238cda67587">bh_data</a>);</div><div class="line"><a name="l03002"></a><span class="lineno"> 3002</span>&#160;    bnum_left = hp_left-&gt;bh_bnum;</div><div class="line"><a name="l03003"></a><span class="lineno"> 3003</span>&#160;    bnum_right = hp_right-&gt;bh_bnum;</div><div class="line"><a name="l03004"></a><span class="lineno"> 3004</span>&#160;    page_count_left = hp_left-&gt;<a class="code" href="structblock__hdr.html#aa3f0f7b98a68382a3ec20db1e9e65d8b">bh_page_count</a>;</div><div class="line"><a name="l03005"></a><span class="lineno"> 3005</span>&#160;    page_count_right = hp_right-&gt;<a class="code" href="structblock__hdr.html#aa3f0f7b98a68382a3ec20db1e9e65d8b">bh_page_count</a>;</div><div class="line"><a name="l03006"></a><span class="lineno"> 3006</span>&#160;</div><div class="line"><a name="l03007"></a><span class="lineno"> 3007</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l03008"></a><span class="lineno"> 3008</span>&#160;<span class="comment">     * May move the new line into the right/new block.</span></div><div class="line"><a name="l03009"></a><span class="lineno"> 3009</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l03010"></a><span class="lineno"> 3010</span>&#160;    <span class="keywordflow">if</span> (!in_left)</div><div class="line"><a name="l03011"></a><span class="lineno"> 3011</span>&#160;    {</div><div class="line"><a name="l03012"></a><span class="lineno"> 3012</span>&#160;        dp_right-&gt;<a class="code" href="structdata__block.html#a3937f5841b2fed9a042872981b06a7b8">db_txt_start</a> -= len;</div><div class="line"><a name="l03013"></a><span class="lineno"> 3013</span>&#160;        dp_right-&gt;<a class="code" href="structdata__block.html#a6cd7e5186f74ae199fe547bc905b2815">db_free</a> -= len + <a class="code" href="memline_8c.html#a33bdc994ac7c8cda7d0df1a3369ab965">INDEX_SIZE</a>;</div><div class="line"><a name="l03014"></a><span class="lineno"> 3014</span>&#160;        dp_right-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[0] = dp_right-&gt;<a class="code" href="structdata__block.html#a3937f5841b2fed9a042872981b06a7b8">db_txt_start</a>;</div><div class="line"><a name="l03015"></a><span class="lineno"> 3015</span>&#160;        <span class="keywordflow">if</span> (mark)</div><div class="line"><a name="l03016"></a><span class="lineno"> 3016</span>&#160;        dp_right-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[0] |= <a class="code" href="memline_8c.html#ab994bfde1fec8c463065bbb9a402a35d">DB_MARKED</a>;</div><div class="line"><a name="l03017"></a><span class="lineno"> 3017</span>&#160;</div><div class="line"><a name="l03018"></a><span class="lineno"> 3018</span>&#160;        <a class="code" href="os__unix_8h.html#ae70108db942e4f3eeb701ad8787b1835">mch_memmove</a>((<span class="keywordtype">char</span> *)dp_right + dp_right-&gt;<a class="code" href="structdata__block.html#a3937f5841b2fed9a042872981b06a7b8">db_txt_start</a>,</div><div class="line"><a name="l03019"></a><span class="lineno"> 3019</span>&#160;                               line, (<span class="keywordtype">size_t</span>)len);</div><div class="line"><a name="l03020"></a><span class="lineno"> 3020</span>&#160;        ++line_count_right;</div><div class="line"><a name="l03021"></a><span class="lineno"> 3021</span>&#160;    }</div><div class="line"><a name="l03022"></a><span class="lineno"> 3022</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l03023"></a><span class="lineno"> 3023</span>&#160;<span class="comment">     * may move lines from the left/old block to the right/new one.</span></div><div class="line"><a name="l03024"></a><span class="lineno"> 3024</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l03025"></a><span class="lineno"> 3025</span>&#160;    <span class="keywordflow">if</span> (lines_moved)</div><div class="line"><a name="l03026"></a><span class="lineno"> 3026</span>&#160;    {</div><div class="line"><a name="l03027"></a><span class="lineno"> 3027</span>&#160;        <span class="comment">/*</span></div><div class="line"><a name="l03028"></a><span class="lineno"> 3028</span>&#160;<span class="comment">         */</span></div><div class="line"><a name="l03029"></a><span class="lineno"> 3029</span>&#160;        dp_right-&gt;<a class="code" href="structdata__block.html#a3937f5841b2fed9a042872981b06a7b8">db_txt_start</a> -= data_moved;</div><div class="line"><a name="l03030"></a><span class="lineno"> 3030</span>&#160;        dp_right-&gt;<a class="code" href="structdata__block.html#a6cd7e5186f74ae199fe547bc905b2815">db_free</a> -= total_moved;</div><div class="line"><a name="l03031"></a><span class="lineno"> 3031</span>&#160;        <a class="code" href="os__unix_8h.html#ae70108db942e4f3eeb701ad8787b1835">mch_memmove</a>((<span class="keywordtype">char</span> *)dp_right + dp_right-&gt;<a class="code" href="structdata__block.html#a3937f5841b2fed9a042872981b06a7b8">db_txt_start</a>,</div><div class="line"><a name="l03032"></a><span class="lineno"> 3032</span>&#160;            (<span class="keywordtype">char</span> *)dp_left + dp_left-&gt;<a class="code" href="structdata__block.html#a3937f5841b2fed9a042872981b06a7b8">db_txt_start</a>,</div><div class="line"><a name="l03033"></a><span class="lineno"> 3033</span>&#160;            (<span class="keywordtype">size_t</span>)data_moved);</div><div class="line"><a name="l03034"></a><span class="lineno"> 3034</span>&#160;        offset = dp_right-&gt;<a class="code" href="structdata__block.html#a3937f5841b2fed9a042872981b06a7b8">db_txt_start</a> - dp_left-&gt;<a class="code" href="structdata__block.html#a3937f5841b2fed9a042872981b06a7b8">db_txt_start</a>;</div><div class="line"><a name="l03035"></a><span class="lineno"> 3035</span>&#160;        dp_left-&gt;<a class="code" href="structdata__block.html#a3937f5841b2fed9a042872981b06a7b8">db_txt_start</a> += data_moved;</div><div class="line"><a name="l03036"></a><span class="lineno"> 3036</span>&#160;        dp_left-&gt;<a class="code" href="structdata__block.html#a6cd7e5186f74ae199fe547bc905b2815">db_free</a> += total_moved;</div><div class="line"><a name="l03037"></a><span class="lineno"> 3037</span>&#160;</div><div class="line"><a name="l03038"></a><span class="lineno"> 3038</span>&#160;        <span class="comment">/*</span></div><div class="line"><a name="l03039"></a><span class="lineno"> 3039</span>&#160;<span class="comment">         * update indexes in the new block</span></div><div class="line"><a name="l03040"></a><span class="lineno"> 3040</span>&#160;<span class="comment">         */</span></div><div class="line"><a name="l03041"></a><span class="lineno"> 3041</span>&#160;        <span class="keywordflow">for</span> (to = line_count_right, from = db_idx + 1;</div><div class="line"><a name="l03042"></a><span class="lineno"> 3042</span>&#160;                     from &lt; line_count_left; ++from, ++to)</div><div class="line"><a name="l03043"></a><span class="lineno"> 3043</span>&#160;        dp_right-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[to] = dp-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[from] + offset;</div><div class="line"><a name="l03044"></a><span class="lineno"> 3044</span>&#160;        line_count_right += lines_moved;</div><div class="line"><a name="l03045"></a><span class="lineno"> 3045</span>&#160;        line_count_left -= lines_moved;</div><div class="line"><a name="l03046"></a><span class="lineno"> 3046</span>&#160;    }</div><div class="line"><a name="l03047"></a><span class="lineno"> 3047</span>&#160;</div><div class="line"><a name="l03048"></a><span class="lineno"> 3048</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l03049"></a><span class="lineno"> 3049</span>&#160;<span class="comment">     * May move the new line into the left (old or new) block.</span></div><div class="line"><a name="l03050"></a><span class="lineno"> 3050</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l03051"></a><span class="lineno"> 3051</span>&#160;    <span class="keywordflow">if</span> (in_left)</div><div class="line"><a name="l03052"></a><span class="lineno"> 3052</span>&#160;    {</div><div class="line"><a name="l03053"></a><span class="lineno"> 3053</span>&#160;        dp_left-&gt;<a class="code" href="structdata__block.html#a3937f5841b2fed9a042872981b06a7b8">db_txt_start</a> -= len;</div><div class="line"><a name="l03054"></a><span class="lineno"> 3054</span>&#160;        dp_left-&gt;<a class="code" href="structdata__block.html#a6cd7e5186f74ae199fe547bc905b2815">db_free</a> -= len + <a class="code" href="memline_8c.html#a33bdc994ac7c8cda7d0df1a3369ab965">INDEX_SIZE</a>;</div><div class="line"><a name="l03055"></a><span class="lineno"> 3055</span>&#160;        dp_left-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[line_count_left] = dp_left-&gt;<a class="code" href="structdata__block.html#a3937f5841b2fed9a042872981b06a7b8">db_txt_start</a>;</div><div class="line"><a name="l03056"></a><span class="lineno"> 3056</span>&#160;        <span class="keywordflow">if</span> (mark)</div><div class="line"><a name="l03057"></a><span class="lineno"> 3057</span>&#160;        dp_left-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[line_count_left] |= <a class="code" href="memline_8c.html#ab994bfde1fec8c463065bbb9a402a35d">DB_MARKED</a>;</div><div class="line"><a name="l03058"></a><span class="lineno"> 3058</span>&#160;        <a class="code" href="os__unix_8h.html#ae70108db942e4f3eeb701ad8787b1835">mch_memmove</a>((<span class="keywordtype">char</span> *)dp_left + dp_left-&gt;<a class="code" href="structdata__block.html#a3937f5841b2fed9a042872981b06a7b8">db_txt_start</a>,</div><div class="line"><a name="l03059"></a><span class="lineno"> 3059</span>&#160;                               line, (<span class="keywordtype">size_t</span>)len);</div><div class="line"><a name="l03060"></a><span class="lineno"> 3060</span>&#160;        ++line_count_left;</div><div class="line"><a name="l03061"></a><span class="lineno"> 3061</span>&#160;    }</div><div class="line"><a name="l03062"></a><span class="lineno"> 3062</span>&#160;</div><div class="line"><a name="l03063"></a><span class="lineno"> 3063</span>&#160;    <span class="keywordflow">if</span> (db_idx &lt; 0)     <span class="comment">/* left block is new */</span></div><div class="line"><a name="l03064"></a><span class="lineno"> 3064</span>&#160;    {</div><div class="line"><a name="l03065"></a><span class="lineno"> 3065</span>&#160;        lnum_left = lnum + 1;</div><div class="line"><a name="l03066"></a><span class="lineno"> 3066</span>&#160;        lnum_right = 0;</div><div class="line"><a name="l03067"></a><span class="lineno"> 3067</span>&#160;    }</div><div class="line"><a name="l03068"></a><span class="lineno"> 3068</span>&#160;    <span class="keywordflow">else</span>            <span class="comment">/* right block is new */</span></div><div class="line"><a name="l03069"></a><span class="lineno"> 3069</span>&#160;    {</div><div class="line"><a name="l03070"></a><span class="lineno"> 3070</span>&#160;        lnum_left = 0;</div><div class="line"><a name="l03071"></a><span class="lineno"> 3071</span>&#160;        <span class="keywordflow">if</span> (in_left)</div><div class="line"><a name="l03072"></a><span class="lineno"> 3072</span>&#160;        lnum_right = lnum + 2;</div><div class="line"><a name="l03073"></a><span class="lineno"> 3073</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l03074"></a><span class="lineno"> 3074</span>&#160;        lnum_right = lnum + 1;</div><div class="line"><a name="l03075"></a><span class="lineno"> 3075</span>&#160;    }</div><div class="line"><a name="l03076"></a><span class="lineno"> 3076</span>&#160;    dp_left-&gt;<a class="code" href="structdata__block.html#a00084a39a3bdd9a03b9a055216aec5c5">db_line_count</a> = line_count_left;</div><div class="line"><a name="l03077"></a><span class="lineno"> 3077</span>&#160;    dp_right-&gt;<a class="code" href="structdata__block.html#a00084a39a3bdd9a03b9a055216aec5c5">db_line_count</a> = line_count_right;</div><div class="line"><a name="l03078"></a><span class="lineno"> 3078</span>&#160;</div><div class="line"><a name="l03079"></a><span class="lineno"> 3079</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l03080"></a><span class="lineno"> 3080</span>&#160;<span class="comment">     * release the two data blocks</span></div><div class="line"><a name="l03081"></a><span class="lineno"> 3081</span>&#160;<span class="comment">     * The new one (hp_new) already has a correct blocknumber.</span></div><div class="line"><a name="l03082"></a><span class="lineno"> 3082</span>&#160;<span class="comment">     * The old one (hp, in ml_locked) gets a positive blocknumber if</span></div><div class="line"><a name="l03083"></a><span class="lineno"> 3083</span>&#160;<span class="comment">     * we changed it and we are not editing a new file.</span></div><div class="line"><a name="l03084"></a><span class="lineno"> 3084</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l03085"></a><span class="lineno"> 3085</span>&#160;    <span class="keywordflow">if</span> (lines_moved || in_left)</div><div class="line"><a name="l03086"></a><span class="lineno"> 3086</span>&#160;        buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a30f30ddb7264f667a92556f0568981e0">ml_flags</a> |= <a class="code" href="structs_8h.html#ad55a676a17d24163d3cdb2bf75a7fa66">ML_LOCKED_DIRTY</a>;</div><div class="line"><a name="l03087"></a><span class="lineno"> 3087</span>&#160;    <span class="keywordflow">if</span> (!newfile &amp;&amp; db_idx &gt;= 0 &amp;&amp; in_left)</div><div class="line"><a name="l03088"></a><span class="lineno"> 3088</span>&#160;        buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a30f30ddb7264f667a92556f0568981e0">ml_flags</a> |= <a class="code" href="structs_8h.html#a094e033c133f0276ed3c00f8053d0175">ML_LOCKED_POS</a>;</div><div class="line"><a name="l03089"></a><span class="lineno"> 3089</span>&#160;    <a class="code" href="memfile_8c.html#abb7f268382703d32becc96f6d92fb855">mf_put</a>(mfp, hp_new, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l03090"></a><span class="lineno"> 3090</span>&#160;</div><div class="line"><a name="l03091"></a><span class="lineno"> 3091</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l03092"></a><span class="lineno"> 3092</span>&#160;<span class="comment">     * flush the old data block</span></div><div class="line"><a name="l03093"></a><span class="lineno"> 3093</span>&#160;<span class="comment">     * set ml_locked_lineadd to 0, because the updating of the</span></div><div class="line"><a name="l03094"></a><span class="lineno"> 3094</span>&#160;<span class="comment">     * pointer blocks is done below</span></div><div class="line"><a name="l03095"></a><span class="lineno"> 3095</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l03096"></a><span class="lineno"> 3096</span>&#160;    lineadd = buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a97f953057f1eaa0360502866f1e54964">ml_locked_lineadd</a>;</div><div class="line"><a name="l03097"></a><span class="lineno"> 3097</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a97f953057f1eaa0360502866f1e54964">ml_locked_lineadd</a> = 0;</div><div class="line"><a name="l03098"></a><span class="lineno"> 3098</span>&#160;    <a class="code" href="memline_8c.html#ade8fe98188345bdd3c230545fc4a614f">ml_find_line</a>(buf, (<a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>)0, <a class="code" href="memline_8c.html#a89ca94197abc00b6c372ff0a72b4a091">ML_FLUSH</a>);   <span class="comment">/* flush data block */</span></div><div class="line"><a name="l03099"></a><span class="lineno"> 3099</span>&#160;</div><div class="line"><a name="l03100"></a><span class="lineno"> 3100</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l03101"></a><span class="lineno"> 3101</span>&#160;<span class="comment">     * update pointer blocks for the new data block</span></div><div class="line"><a name="l03102"></a><span class="lineno"> 3102</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l03103"></a><span class="lineno"> 3103</span>&#160;    <span class="keywordflow">for</span> (stack_idx = buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a17d957b4b662bf327749e1523ac4f5b5">ml_stack_top</a> - 1; stack_idx &gt;= 0;</div><div class="line"><a name="l03104"></a><span class="lineno"> 3104</span>&#160;                                  --stack_idx)</div><div class="line"><a name="l03105"></a><span class="lineno"> 3105</span>&#160;    {</div><div class="line"><a name="l03106"></a><span class="lineno"> 3106</span>&#160;        ip = &amp;(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a77e2179043ee3367af09fe186b2fa5a8">ml_stack</a>[stack_idx]);</div><div class="line"><a name="l03107"></a><span class="lineno"> 3107</span>&#160;        pb_idx = ip-&gt;<a class="code" href="structinfo__pointer.html#acdf584cb720506bd2f40240dc71bab50">ip_index</a>;</div><div class="line"><a name="l03108"></a><span class="lineno"> 3108</span>&#160;        <span class="keywordflow">if</span> ((hp = <a class="code" href="memfile_8c.html#af9d5ff9ad91a2d5150a675c9c0d77e10">mf_get</a>(mfp, ip-&gt;<a class="code" href="structinfo__pointer.html#a140d83e56091daa97560a9a4a82a8c1b">ip_bnum</a>, 1)) == NULL)</div><div class="line"><a name="l03109"></a><span class="lineno"> 3109</span>&#160;        <span class="keywordflow">goto</span> theend;</div><div class="line"><a name="l03110"></a><span class="lineno"> 3110</span>&#160;        pp = (<a class="code" href="structpointer__block.html">PTR_BL</a> *)(hp-&gt;<a class="code" href="structblock__hdr.html#a7247cdc0977ab6fdc9cb6238cda67587">bh_data</a>);   <span class="comment">/* must be pointer block */</span></div><div class="line"><a name="l03111"></a><span class="lineno"> 3111</span>&#160;        <span class="keywordflow">if</span> (pp-&gt;<a class="code" href="structpointer__block.html#ac2698ad2c9c4096299106a53ffbd667f">pb_id</a> != <a class="code" href="memline_8c.html#a23d0125357ec4465a50f841f634c9214">PTR_ID</a>)</div><div class="line"><a name="l03112"></a><span class="lineno"> 3112</span>&#160;        {</div><div class="line"><a name="l03113"></a><span class="lineno"> 3113</span>&#160;        <a class="code" href="message_8c.html#a7926d7fa9a35dc0f5bac051dec01240a">iemsg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;E317: pointer block id wrong 3&quot;</span>));</div><div class="line"><a name="l03114"></a><span class="lineno"> 3114</span>&#160;        <a class="code" href="memfile_8c.html#abb7f268382703d32becc96f6d92fb855">mf_put</a>(mfp, hp, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l03115"></a><span class="lineno"> 3115</span>&#160;        <span class="keywordflow">goto</span> theend;</div><div class="line"><a name="l03116"></a><span class="lineno"> 3116</span>&#160;        }</div><div class="line"><a name="l03117"></a><span class="lineno"> 3117</span>&#160;        <span class="comment">/*</span></div><div class="line"><a name="l03118"></a><span class="lineno"> 3118</span>&#160;<span class="comment">         * TODO: If the pointer block is full and we are adding at the end</span></div><div class="line"><a name="l03119"></a><span class="lineno"> 3119</span>&#160;<span class="comment">         * try to insert in front of the next block</span></div><div class="line"><a name="l03120"></a><span class="lineno"> 3120</span>&#160;<span class="comment">         */</span></div><div class="line"><a name="l03121"></a><span class="lineno"> 3121</span>&#160;        <span class="comment">/* block not full, add one entry */</span></div><div class="line"><a name="l03122"></a><span class="lineno"> 3122</span>&#160;        <span class="keywordflow">if</span> (pp-&gt;<a class="code" href="structpointer__block.html#ad3682038298e7850fb980815132f17f9">pb_count</a> &lt; pp-&gt;<a class="code" href="structpointer__block.html#ad9d615e7c53c2892e6d04a0d257df592">pb_count_max</a>)</div><div class="line"><a name="l03123"></a><span class="lineno"> 3123</span>&#160;        {</div><div class="line"><a name="l03124"></a><span class="lineno"> 3124</span>&#160;        <span class="keywordflow">if</span> (pb_idx + 1 &lt; (<span class="keywordtype">int</span>)pp-&gt;<a class="code" href="structpointer__block.html#ad3682038298e7850fb980815132f17f9">pb_count</a>)</div><div class="line"><a name="l03125"></a><span class="lineno"> 3125</span>&#160;            <a class="code" href="os__unix_8h.html#ae70108db942e4f3eeb701ad8787b1835">mch_memmove</a>(&amp;pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[pb_idx + 2],</div><div class="line"><a name="l03126"></a><span class="lineno"> 3126</span>&#160;                &amp;pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[pb_idx + 1],</div><div class="line"><a name="l03127"></a><span class="lineno"> 3127</span>&#160;            (<span class="keywordtype">size_t</span>)(pp-&gt;<a class="code" href="structpointer__block.html#ad3682038298e7850fb980815132f17f9">pb_count</a> - pb_idx - 1) * <span class="keyword">sizeof</span>(<a class="code" href="structpointer__entry.html">PTR_EN</a>));</div><div class="line"><a name="l03128"></a><span class="lineno"> 3128</span>&#160;        ++pp-&gt;<a class="code" href="structpointer__block.html#ad3682038298e7850fb980815132f17f9">pb_count</a>;</div><div class="line"><a name="l03129"></a><span class="lineno"> 3129</span>&#160;        pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[pb_idx].<a class="code" href="structpointer__entry.html#a652fe117ed91b4ab3d84361e8aa751de">pe_line_count</a> = line_count_left;</div><div class="line"><a name="l03130"></a><span class="lineno"> 3130</span>&#160;        pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[pb_idx].<a class="code" href="structpointer__entry.html#a0234165c0ca282f192e94957a87175f6">pe_bnum</a> = bnum_left;</div><div class="line"><a name="l03131"></a><span class="lineno"> 3131</span>&#160;        pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[pb_idx].<a class="code" href="structpointer__entry.html#aa5194eaf0768453f33b9d2ff66508040">pe_page_count</a> = page_count_left;</div><div class="line"><a name="l03132"></a><span class="lineno"> 3132</span>&#160;        pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[pb_idx + 1].<a class="code" href="structpointer__entry.html#a652fe117ed91b4ab3d84361e8aa751de">pe_line_count</a> = line_count_right;</div><div class="line"><a name="l03133"></a><span class="lineno"> 3133</span>&#160;        pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[pb_idx + 1].<a class="code" href="structpointer__entry.html#a0234165c0ca282f192e94957a87175f6">pe_bnum</a> = bnum_right;</div><div class="line"><a name="l03134"></a><span class="lineno"> 3134</span>&#160;        pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[pb_idx + 1].<a class="code" href="structpointer__entry.html#aa5194eaf0768453f33b9d2ff66508040">pe_page_count</a> = page_count_right;</div><div class="line"><a name="l03135"></a><span class="lineno"> 3135</span>&#160;</div><div class="line"><a name="l03136"></a><span class="lineno"> 3136</span>&#160;        <span class="keywordflow">if</span> (lnum_left != 0)</div><div class="line"><a name="l03137"></a><span class="lineno"> 3137</span>&#160;            pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[pb_idx].<a class="code" href="structpointer__entry.html#a4ed8c85821e6c5ac44c2a77160d4b26d">pe_old_lnum</a> = lnum_left;</div><div class="line"><a name="l03138"></a><span class="lineno"> 3138</span>&#160;        <span class="keywordflow">if</span> (lnum_right != 0)</div><div class="line"><a name="l03139"></a><span class="lineno"> 3139</span>&#160;            pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[pb_idx + 1].<a class="code" href="structpointer__entry.html#a4ed8c85821e6c5ac44c2a77160d4b26d">pe_old_lnum</a> = lnum_right;</div><div class="line"><a name="l03140"></a><span class="lineno"> 3140</span>&#160;</div><div class="line"><a name="l03141"></a><span class="lineno"> 3141</span>&#160;        <a class="code" href="memfile_8c.html#abb7f268382703d32becc96f6d92fb855">mf_put</a>(mfp, hp, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l03142"></a><span class="lineno"> 3142</span>&#160;        buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a17d957b4b662bf327749e1523ac4f5b5">ml_stack_top</a> = stack_idx + 1;     <span class="comment">/* truncate stack */</span></div><div class="line"><a name="l03143"></a><span class="lineno"> 3143</span>&#160;</div><div class="line"><a name="l03144"></a><span class="lineno"> 3144</span>&#160;        <span class="keywordflow">if</span> (lineadd)</div><div class="line"><a name="l03145"></a><span class="lineno"> 3145</span>&#160;        {</div><div class="line"><a name="l03146"></a><span class="lineno"> 3146</span>&#160;            --(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a17d957b4b662bf327749e1523ac4f5b5">ml_stack_top</a>);</div><div class="line"><a name="l03147"></a><span class="lineno"> 3147</span>&#160;            <span class="comment">/* fix line count for rest of blocks in the stack */</span></div><div class="line"><a name="l03148"></a><span class="lineno"> 3148</span>&#160;            <a class="code" href="memline_8c.html#a661ea17a2f15417b31afca629fbef050">ml_lineadd</a>(buf, lineadd);</div><div class="line"><a name="l03149"></a><span class="lineno"> 3149</span>&#160;                            <span class="comment">/* fix stack itself */</span></div><div class="line"><a name="l03150"></a><span class="lineno"> 3150</span>&#160;            buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a77e2179043ee3367af09fe186b2fa5a8">ml_stack</a>[buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a17d957b4b662bf327749e1523ac4f5b5">ml_stack_top</a>].<a class="code" href="structinfo__pointer.html#ac473382eb6323825263f4e65ddbb68de">ip_high</a> +=</div><div class="line"><a name="l03151"></a><span class="lineno"> 3151</span>&#160;                                      lineadd;</div><div class="line"><a name="l03152"></a><span class="lineno"> 3152</span>&#160;            ++(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a17d957b4b662bf327749e1523ac4f5b5">ml_stack_top</a>);</div><div class="line"><a name="l03153"></a><span class="lineno"> 3153</span>&#160;        }</div><div class="line"><a name="l03154"></a><span class="lineno"> 3154</span>&#160;</div><div class="line"><a name="l03155"></a><span class="lineno"> 3155</span>&#160;        <span class="comment">/*</span></div><div class="line"><a name="l03156"></a><span class="lineno"> 3156</span>&#160;<span class="comment">         * We are finished, break the loop here.</span></div><div class="line"><a name="l03157"></a><span class="lineno"> 3157</span>&#160;<span class="comment">         */</span></div><div class="line"><a name="l03158"></a><span class="lineno"> 3158</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l03159"></a><span class="lineno"> 3159</span>&#160;        }</div><div class="line"><a name="l03160"></a><span class="lineno"> 3160</span>&#160;        <span class="keywordflow">else</span>            <span class="comment">/* pointer block full */</span></div><div class="line"><a name="l03161"></a><span class="lineno"> 3161</span>&#160;        {</div><div class="line"><a name="l03162"></a><span class="lineno"> 3162</span>&#160;        <span class="comment">/*</span></div><div class="line"><a name="l03163"></a><span class="lineno"> 3163</span>&#160;<span class="comment">         * split the pointer block</span></div><div class="line"><a name="l03164"></a><span class="lineno"> 3164</span>&#160;<span class="comment">         * allocate a new pointer block</span></div><div class="line"><a name="l03165"></a><span class="lineno"> 3165</span>&#160;<span class="comment">         * move some of the pointer into the new block</span></div><div class="line"><a name="l03166"></a><span class="lineno"> 3166</span>&#160;<span class="comment">         * prepare for updating the parent block</span></div><div class="line"><a name="l03167"></a><span class="lineno"> 3167</span>&#160;<span class="comment">         */</span></div><div class="line"><a name="l03168"></a><span class="lineno"> 3168</span>&#160;        <span class="keywordflow">for</span> (;;)    <span class="comment">/* do this twice when splitting block 1 */</span></div><div class="line"><a name="l03169"></a><span class="lineno"> 3169</span>&#160;        {</div><div class="line"><a name="l03170"></a><span class="lineno"> 3170</span>&#160;            hp_new = <a class="code" href="memline_8c.html#abdecfc521a3e8fe9fde7d0a7f0baa4fc">ml_new_ptr</a>(mfp);</div><div class="line"><a name="l03171"></a><span class="lineno"> 3171</span>&#160;            <span class="keywordflow">if</span> (hp_new == NULL)     <span class="comment">/* TODO: try to fix tree */</span></div><div class="line"><a name="l03172"></a><span class="lineno"> 3172</span>&#160;            <span class="keywordflow">goto</span> theend;</div><div class="line"><a name="l03173"></a><span class="lineno"> 3173</span>&#160;            pp_new = (<a class="code" href="structpointer__block.html">PTR_BL</a> *)(hp_new-&gt;<a class="code" href="structblock__hdr.html#a7247cdc0977ab6fdc9cb6238cda67587">bh_data</a>);</div><div class="line"><a name="l03174"></a><span class="lineno"> 3174</span>&#160;</div><div class="line"><a name="l03175"></a><span class="lineno"> 3175</span>&#160;            <span class="keywordflow">if</span> (hp-&gt;bh_bnum != 1)</div><div class="line"><a name="l03176"></a><span class="lineno"> 3176</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l03177"></a><span class="lineno"> 3177</span>&#160;</div><div class="line"><a name="l03178"></a><span class="lineno"> 3178</span>&#160;            <span class="comment">/*</span></div><div class="line"><a name="l03179"></a><span class="lineno"> 3179</span>&#160;<span class="comment">             * if block 1 becomes full the tree is given an extra level</span></div><div class="line"><a name="l03180"></a><span class="lineno"> 3180</span>&#160;<span class="comment">             * The pointers from block 1 are moved into the new block.</span></div><div class="line"><a name="l03181"></a><span class="lineno"> 3181</span>&#160;<span class="comment">             * block 1 is updated to point to the new block</span></div><div class="line"><a name="l03182"></a><span class="lineno"> 3182</span>&#160;<span class="comment">             * then continue to split the new block</span></div><div class="line"><a name="l03183"></a><span class="lineno"> 3183</span>&#160;<span class="comment">             */</span></div><div class="line"><a name="l03184"></a><span class="lineno"> 3184</span>&#160;            <a class="code" href="os__unix_8h.html#ae70108db942e4f3eeb701ad8787b1835">mch_memmove</a>(pp_new, pp, (<span class="keywordtype">size_t</span>)page_size);</div><div class="line"><a name="l03185"></a><span class="lineno"> 3185</span>&#160;            pp-&gt;<a class="code" href="structpointer__block.html#ad3682038298e7850fb980815132f17f9">pb_count</a> = 1;</div><div class="line"><a name="l03186"></a><span class="lineno"> 3186</span>&#160;            pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[0].<a class="code" href="structpointer__entry.html#a0234165c0ca282f192e94957a87175f6">pe_bnum</a> = hp_new-&gt;bh_bnum;</div><div class="line"><a name="l03187"></a><span class="lineno"> 3187</span>&#160;            pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[0].<a class="code" href="structpointer__entry.html#a652fe117ed91b4ab3d84361e8aa751de">pe_line_count</a> = buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a708091d31fa9cf7718aca80d707b1b3d">ml_line_count</a>;</div><div class="line"><a name="l03188"></a><span class="lineno"> 3188</span>&#160;            pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[0].<a class="code" href="structpointer__entry.html#a4ed8c85821e6c5ac44c2a77160d4b26d">pe_old_lnum</a> = 1;</div><div class="line"><a name="l03189"></a><span class="lineno"> 3189</span>&#160;            pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[0].<a class="code" href="structpointer__entry.html#aa5194eaf0768453f33b9d2ff66508040">pe_page_count</a> = 1;</div><div class="line"><a name="l03190"></a><span class="lineno"> 3190</span>&#160;            <a class="code" href="memfile_8c.html#abb7f268382703d32becc96f6d92fb855">mf_put</a>(mfp, hp, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);   <span class="comment">/* release block 1 */</span></div><div class="line"><a name="l03191"></a><span class="lineno"> 3191</span>&#160;            hp = hp_new;        <span class="comment">/* new block is to be split */</span></div><div class="line"><a name="l03192"></a><span class="lineno"> 3192</span>&#160;            pp = pp_new;</div><div class="line"><a name="l03193"></a><span class="lineno"> 3193</span>&#160;            <a class="code" href="memline_8c.html#a4c3f0432d972be512c1ff55974987c8c">CHECK</a>(stack_idx != 0, <a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;stack_idx should be 0&quot;</span>));</div><div class="line"><a name="l03194"></a><span class="lineno"> 3194</span>&#160;            ip-&gt;<a class="code" href="structinfo__pointer.html#acdf584cb720506bd2f40240dc71bab50">ip_index</a> = 0;</div><div class="line"><a name="l03195"></a><span class="lineno"> 3195</span>&#160;            ++stack_idx;    <span class="comment">/* do block 1 again later */</span></div><div class="line"><a name="l03196"></a><span class="lineno"> 3196</span>&#160;        }</div><div class="line"><a name="l03197"></a><span class="lineno"> 3197</span>&#160;        <span class="comment">/*</span></div><div class="line"><a name="l03198"></a><span class="lineno"> 3198</span>&#160;<span class="comment">         * move the pointers after the current one to the new block</span></div><div class="line"><a name="l03199"></a><span class="lineno"> 3199</span>&#160;<span class="comment">         * If there are none, the new entry will be in the new block.</span></div><div class="line"><a name="l03200"></a><span class="lineno"> 3200</span>&#160;<span class="comment">         */</span></div><div class="line"><a name="l03201"></a><span class="lineno"> 3201</span>&#160;        total_moved = pp-&gt;<a class="code" href="structpointer__block.html#ad3682038298e7850fb980815132f17f9">pb_count</a> - pb_idx - 1;</div><div class="line"><a name="l03202"></a><span class="lineno"> 3202</span>&#160;        <span class="keywordflow">if</span> (total_moved)</div><div class="line"><a name="l03203"></a><span class="lineno"> 3203</span>&#160;        {</div><div class="line"><a name="l03204"></a><span class="lineno"> 3204</span>&#160;            <a class="code" href="os__unix_8h.html#ae70108db942e4f3eeb701ad8787b1835">mch_memmove</a>(&amp;pp_new-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[0],</div><div class="line"><a name="l03205"></a><span class="lineno"> 3205</span>&#160;                &amp;pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[pb_idx + 1],</div><div class="line"><a name="l03206"></a><span class="lineno"> 3206</span>&#160;                (<span class="keywordtype">size_t</span>)(total_moved) * <span class="keyword">sizeof</span>(<a class="code" href="structpointer__entry.html">PTR_EN</a>));</div><div class="line"><a name="l03207"></a><span class="lineno"> 3207</span>&#160;            pp_new-&gt;<a class="code" href="structpointer__block.html#ad3682038298e7850fb980815132f17f9">pb_count</a> = total_moved;</div><div class="line"><a name="l03208"></a><span class="lineno"> 3208</span>&#160;            pp-&gt;<a class="code" href="structpointer__block.html#ad3682038298e7850fb980815132f17f9">pb_count</a> -= total_moved - 1;</div><div class="line"><a name="l03209"></a><span class="lineno"> 3209</span>&#160;            pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[pb_idx + 1].<a class="code" href="structpointer__entry.html#a0234165c0ca282f192e94957a87175f6">pe_bnum</a> = bnum_right;</div><div class="line"><a name="l03210"></a><span class="lineno"> 3210</span>&#160;            pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[pb_idx + 1].<a class="code" href="structpointer__entry.html#a652fe117ed91b4ab3d84361e8aa751de">pe_line_count</a> = line_count_right;</div><div class="line"><a name="l03211"></a><span class="lineno"> 3211</span>&#160;            pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[pb_idx + 1].<a class="code" href="structpointer__entry.html#aa5194eaf0768453f33b9d2ff66508040">pe_page_count</a> = page_count_right;</div><div class="line"><a name="l03212"></a><span class="lineno"> 3212</span>&#160;            <span class="keywordflow">if</span> (lnum_right)</div><div class="line"><a name="l03213"></a><span class="lineno"> 3213</span>&#160;            pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[pb_idx + 1].<a class="code" href="structpointer__entry.html#a4ed8c85821e6c5ac44c2a77160d4b26d">pe_old_lnum</a> = lnum_right;</div><div class="line"><a name="l03214"></a><span class="lineno"> 3214</span>&#160;        }</div><div class="line"><a name="l03215"></a><span class="lineno"> 3215</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l03216"></a><span class="lineno"> 3216</span>&#160;        {</div><div class="line"><a name="l03217"></a><span class="lineno"> 3217</span>&#160;            pp_new-&gt;<a class="code" href="structpointer__block.html#ad3682038298e7850fb980815132f17f9">pb_count</a> = 1;</div><div class="line"><a name="l03218"></a><span class="lineno"> 3218</span>&#160;            pp_new-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[0].<a class="code" href="structpointer__entry.html#a0234165c0ca282f192e94957a87175f6">pe_bnum</a> = bnum_right;</div><div class="line"><a name="l03219"></a><span class="lineno"> 3219</span>&#160;            pp_new-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[0].<a class="code" href="structpointer__entry.html#a652fe117ed91b4ab3d84361e8aa751de">pe_line_count</a> = line_count_right;</div><div class="line"><a name="l03220"></a><span class="lineno"> 3220</span>&#160;            pp_new-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[0].<a class="code" href="structpointer__entry.html#aa5194eaf0768453f33b9d2ff66508040">pe_page_count</a> = page_count_right;</div><div class="line"><a name="l03221"></a><span class="lineno"> 3221</span>&#160;            pp_new-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[0].<a class="code" href="structpointer__entry.html#a4ed8c85821e6c5ac44c2a77160d4b26d">pe_old_lnum</a> = lnum_right;</div><div class="line"><a name="l03222"></a><span class="lineno"> 3222</span>&#160;        }</div><div class="line"><a name="l03223"></a><span class="lineno"> 3223</span>&#160;        pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[pb_idx].<a class="code" href="structpointer__entry.html#a0234165c0ca282f192e94957a87175f6">pe_bnum</a> = bnum_left;</div><div class="line"><a name="l03224"></a><span class="lineno"> 3224</span>&#160;        pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[pb_idx].<a class="code" href="structpointer__entry.html#a652fe117ed91b4ab3d84361e8aa751de">pe_line_count</a> = line_count_left;</div><div class="line"><a name="l03225"></a><span class="lineno"> 3225</span>&#160;        pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[pb_idx].<a class="code" href="structpointer__entry.html#aa5194eaf0768453f33b9d2ff66508040">pe_page_count</a> = page_count_left;</div><div class="line"><a name="l03226"></a><span class="lineno"> 3226</span>&#160;        <span class="keywordflow">if</span> (lnum_left)</div><div class="line"><a name="l03227"></a><span class="lineno"> 3227</span>&#160;            pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[pb_idx].<a class="code" href="structpointer__entry.html#a4ed8c85821e6c5ac44c2a77160d4b26d">pe_old_lnum</a> = lnum_left;</div><div class="line"><a name="l03228"></a><span class="lineno"> 3228</span>&#160;        lnum_left = 0;</div><div class="line"><a name="l03229"></a><span class="lineno"> 3229</span>&#160;        lnum_right = 0;</div><div class="line"><a name="l03230"></a><span class="lineno"> 3230</span>&#160;</div><div class="line"><a name="l03231"></a><span class="lineno"> 3231</span>&#160;        <span class="comment">/*</span></div><div class="line"><a name="l03232"></a><span class="lineno"> 3232</span>&#160;<span class="comment">         * recompute line counts</span></div><div class="line"><a name="l03233"></a><span class="lineno"> 3233</span>&#160;<span class="comment">         */</span></div><div class="line"><a name="l03234"></a><span class="lineno"> 3234</span>&#160;        line_count_right = 0;</div><div class="line"><a name="l03235"></a><span class="lineno"> 3235</span>&#160;        <span class="keywordflow">for</span> (i = 0; i &lt; (int)pp_new-&gt;<a class="code" href="structpointer__block.html#ad3682038298e7850fb980815132f17f9">pb_count</a>; ++i)</div><div class="line"><a name="l03236"></a><span class="lineno"> 3236</span>&#160;            line_count_right += pp_new-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[i].<a class="code" href="structpointer__entry.html#a652fe117ed91b4ab3d84361e8aa751de">pe_line_count</a>;</div><div class="line"><a name="l03237"></a><span class="lineno"> 3237</span>&#160;        line_count_left = 0;</div><div class="line"><a name="l03238"></a><span class="lineno"> 3238</span>&#160;        <span class="keywordflow">for</span> (i = 0; i &lt; (int)pp-&gt;<a class="code" href="structpointer__block.html#ad3682038298e7850fb980815132f17f9">pb_count</a>; ++i)</div><div class="line"><a name="l03239"></a><span class="lineno"> 3239</span>&#160;            line_count_left += pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[i].<a class="code" href="structpointer__entry.html#a652fe117ed91b4ab3d84361e8aa751de">pe_line_count</a>;</div><div class="line"><a name="l03240"></a><span class="lineno"> 3240</span>&#160;</div><div class="line"><a name="l03241"></a><span class="lineno"> 3241</span>&#160;        bnum_left = hp-&gt;bh_bnum;</div><div class="line"><a name="l03242"></a><span class="lineno"> 3242</span>&#160;        bnum_right = hp_new-&gt;bh_bnum;</div><div class="line"><a name="l03243"></a><span class="lineno"> 3243</span>&#160;        page_count_left = 1;</div><div class="line"><a name="l03244"></a><span class="lineno"> 3244</span>&#160;        page_count_right = 1;</div><div class="line"><a name="l03245"></a><span class="lineno"> 3245</span>&#160;        <a class="code" href="memfile_8c.html#abb7f268382703d32becc96f6d92fb855">mf_put</a>(mfp, hp, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l03246"></a><span class="lineno"> 3246</span>&#160;        <a class="code" href="memfile_8c.html#abb7f268382703d32becc96f6d92fb855">mf_put</a>(mfp, hp_new, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l03247"></a><span class="lineno"> 3247</span>&#160;        }</div><div class="line"><a name="l03248"></a><span class="lineno"> 3248</span>&#160;    }</div><div class="line"><a name="l03249"></a><span class="lineno"> 3249</span>&#160;</div><div class="line"><a name="l03250"></a><span class="lineno"> 3250</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l03251"></a><span class="lineno"> 3251</span>&#160;<span class="comment">     * Safety check: fallen out of for loop?</span></div><div class="line"><a name="l03252"></a><span class="lineno"> 3252</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l03253"></a><span class="lineno"> 3253</span>&#160;    <span class="keywordflow">if</span> (stack_idx &lt; 0)</div><div class="line"><a name="l03254"></a><span class="lineno"> 3254</span>&#160;    {</div><div class="line"><a name="l03255"></a><span class="lineno"> 3255</span>&#160;        <a class="code" href="message_8c.html#a7926d7fa9a35dc0f5bac051dec01240a">iemsg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;E318: Updated too many blocks?&quot;</span>));</div><div class="line"><a name="l03256"></a><span class="lineno"> 3256</span>&#160;        buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a17d957b4b662bf327749e1523ac4f5b5">ml_stack_top</a> = 0; <span class="comment">/* invalidate stack */</span></div><div class="line"><a name="l03257"></a><span class="lineno"> 3257</span>&#160;    }</div><div class="line"><a name="l03258"></a><span class="lineno"> 3258</span>&#160;    }</div><div class="line"><a name="l03259"></a><span class="lineno"> 3259</span>&#160;</div><div class="line"><a name="l03260"></a><span class="lineno"> 3260</span>&#160;<span class="preprocessor">#ifdef FEAT_BYTEOFF</span></div><div class="line"><a name="l03261"></a><span class="lineno"> 3261</span>&#160;    <span class="comment">/* The line was inserted below &#39;lnum&#39; */</span></div><div class="line"><a name="l03262"></a><span class="lineno"> 3262</span>&#160;    <a class="code" href="memline_8c.html#ae8486bd6f1922d43b60969e2be927915">ml_updatechunk</a>(buf, lnum + 1, (<span class="keywordtype">long</span>)len, ML_CHNK_ADDLINE);</div><div class="line"><a name="l03263"></a><span class="lineno"> 3263</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l03264"></a><span class="lineno"> 3264</span>&#160;<span class="preprocessor">#ifdef FEAT_NETBEANS_INTG</span></div><div class="line"><a name="l03265"></a><span class="lineno"> 3265</span>&#160;    <span class="keywordflow">if</span> (netbeans_active())</div><div class="line"><a name="l03266"></a><span class="lineno"> 3266</span>&#160;    {</div><div class="line"><a name="l03267"></a><span class="lineno"> 3267</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="vim_8h.html#a916ffefe1fc74532d08102cca55d8e34">STRLEN</a>(line) &gt; 0)</div><div class="line"><a name="l03268"></a><span class="lineno"> 3268</span>&#160;        netbeans_inserted(buf, lnum+1, (<a class="code" href="vim_8h.html#ae79e04a416bd6ce8ffe80e241850c0d2">colnr_T</a>)0, line, (<span class="keywordtype">int</span>)<a class="code" href="vim_8h.html#a916ffefe1fc74532d08102cca55d8e34">STRLEN</a>(line));</div><div class="line"><a name="l03269"></a><span class="lineno"> 3269</span>&#160;    netbeans_inserted(buf, lnum+1, (<a class="code" href="vim_8h.html#ae79e04a416bd6ce8ffe80e241850c0d2">colnr_T</a>)<a class="code" href="vim_8h.html#a916ffefe1fc74532d08102cca55d8e34">STRLEN</a>(line),</div><div class="line"><a name="l03270"></a><span class="lineno"> 3270</span>&#160;                               (char_u *)<span class="stringliteral">&quot;\n&quot;</span>, 1);</div><div class="line"><a name="l03271"></a><span class="lineno"> 3271</span>&#160;    }</div><div class="line"><a name="l03272"></a><span class="lineno"> 3272</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l03273"></a><span class="lineno"> 3273</span>&#160;<span class="preprocessor">#ifdef FEAT_JOB_CHANNEL</span></div><div class="line"><a name="l03274"></a><span class="lineno"> 3274</span>&#160;    <span class="keywordflow">if</span> (buf-&gt;b_write_to_channel)</div><div class="line"><a name="l03275"></a><span class="lineno"> 3275</span>&#160;    channel_write_new_lines(buf);</div><div class="line"><a name="l03276"></a><span class="lineno"> 3276</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l03277"></a><span class="lineno"> 3277</span>&#160;    ret = <a class="code" href="dosinst_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;</div><div class="line"><a name="l03278"></a><span class="lineno"> 3278</span>&#160;</div><div class="line"><a name="l03279"></a><span class="lineno"> 3279</span>&#160;theend:</div><div class="line"><a name="l03280"></a><span class="lineno"> 3280</span>&#160;<span class="preprocessor">#ifdef FEAT_TEXT_PROP</span></div><div class="line"><a name="l03281"></a><span class="lineno"> 3281</span>&#160;    <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(tofree);</div><div class="line"><a name="l03282"></a><span class="lineno"> 3282</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l03283"></a><span class="lineno"> 3283</span>&#160;    <span class="keywordflow">return</span> ret;</div><div class="line"><a name="l03284"></a><span class="lineno"> 3284</span>&#160;}</div><div class="line"><a name="l03285"></a><span class="lineno"> 3285</span>&#160;</div><div class="line"><a name="l03286"></a><span class="lineno"> 3286</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l03287"></a><span class="lineno"> 3287</span>&#160;<span class="comment"> * Flush any pending change and call ml_append_int()</span></div><div class="line"><a name="l03288"></a><span class="lineno"> 3288</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l03289"></a><span class="lineno"> 3289</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">int</span></div><div class="line"><a name="l03290"></a><span class="lineno"><a class="line" href="memline_8c.html#a7bbeb7c2510db6fc4366434b1b1996cf"> 3290</a></span>&#160;<a class="code" href="memline_8c.html#a7bbeb7c2510db6fc4366434b1b1996cf">ml_append_flush</a>(</div><div class="line"><a name="l03291"></a><span class="lineno"> 3291</span>&#160;    <a class="code" href="structfile__buffer.html">buf_T</a>   *buf,</div><div class="line"><a name="l03292"></a><span class="lineno"> 3292</span>&#160;    <a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>    lnum,       <span class="comment">// append after this line (can be 0)</span></div><div class="line"><a name="l03293"></a><span class="lineno"> 3293</span>&#160;    char_u  *line,      <span class="comment">// text of the new line</span></div><div class="line"><a name="l03294"></a><span class="lineno"> 3294</span>&#160;    <a class="code" href="vim_8h.html#ae79e04a416bd6ce8ffe80e241850c0d2">colnr_T</a> len,        <span class="comment">// length of line, including NUL, or 0</span></div><div class="line"><a name="l03295"></a><span class="lineno"> 3295</span>&#160;    <span class="keywordtype">int</span>     newfile)    <span class="comment">// flag, see above</span></div><div class="line"><a name="l03296"></a><span class="lineno"> 3296</span>&#160;{</div><div class="line"><a name="l03297"></a><span class="lineno"> 3297</span>&#160;    <span class="keywordflow">if</span> (lnum &gt; buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a708091d31fa9cf7718aca80d707b1b3d">ml_line_count</a>)</div><div class="line"><a name="l03298"></a><span class="lineno"> 3298</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="dosinst_8h.html#abb508ea8227673f419e9fe3a86c30d8e">FAIL</a>;  <span class="comment">// lnum out of range</span></div><div class="line"><a name="l03299"></a><span class="lineno"> 3299</span>&#160;</div><div class="line"><a name="l03300"></a><span class="lineno"> 3300</span>&#160;    <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a62222eb79ef59eddaff71f0f8cdff764">ml_line_lnum</a> != 0)</div><div class="line"><a name="l03301"></a><span class="lineno"> 3301</span>&#160;    <span class="comment">// This may also invoke ml_append_int().</span></div><div class="line"><a name="l03302"></a><span class="lineno"> 3302</span>&#160;    <a class="code" href="memline_8c.html#a20a3268681f79a76b9af2f2fc7b644b6">ml_flush_line</a>(buf);</div><div class="line"><a name="l03303"></a><span class="lineno"> 3303</span>&#160;</div><div class="line"><a name="l03304"></a><span class="lineno"> 3304</span>&#160;<span class="preprocessor">#ifdef FEAT_EVAL</span></div><div class="line"><a name="l03305"></a><span class="lineno"> 3305</span>&#160;    <span class="comment">// When inserting above recorded changes: flush the changes before changing</span></div><div class="line"><a name="l03306"></a><span class="lineno"> 3306</span>&#160;    <span class="comment">// the text.  Then flush the cached line, it may become invalid.</span></div><div class="line"><a name="l03307"></a><span class="lineno"> 3307</span>&#160;    <a class="code" href="change_8c.html#a4cc8db1b395d092bd0a984f7abd5f1d1">may_invoke_listeners</a>(buf, lnum + 1, lnum + 1, 1);</div><div class="line"><a name="l03308"></a><span class="lineno"> 3308</span>&#160;    <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a62222eb79ef59eddaff71f0f8cdff764">ml_line_lnum</a> != 0)</div><div class="line"><a name="l03309"></a><span class="lineno"> 3309</span>&#160;    <a class="code" href="memline_8c.html#a20a3268681f79a76b9af2f2fc7b644b6">ml_flush_line</a>(buf);</div><div class="line"><a name="l03310"></a><span class="lineno"> 3310</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l03311"></a><span class="lineno"> 3311</span>&#160;</div><div class="line"><a name="l03312"></a><span class="lineno"> 3312</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="memline_8c.html#abed76281f9b8f3fe0572784ba8aaa040">ml_append_int</a>(buf, lnum, line, len, newfile, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l03313"></a><span class="lineno"> 3313</span>&#160;}</div><div class="line"><a name="l03314"></a><span class="lineno"> 3314</span>&#160;</div><div class="line"><a name="l03315"></a><span class="lineno"> 3315</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l03316"></a><span class="lineno"> 3316</span>&#160;<span class="comment"> * Append a line after lnum (may be 0 to insert a line in front of the file).</span></div><div class="line"><a name="l03317"></a><span class="lineno"> 3317</span>&#160;<span class="comment"> * &quot;line&quot; does not need to be allocated, but can&#39;t be another line in a</span></div><div class="line"><a name="l03318"></a><span class="lineno"> 3318</span>&#160;<span class="comment"> * buffer, unlocking may make it invalid.</span></div><div class="line"><a name="l03319"></a><span class="lineno"> 3319</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l03320"></a><span class="lineno"> 3320</span>&#160;<span class="comment"> *   newfile: TRUE when starting to edit a new file, meaning that pe_old_lnum</span></div><div class="line"><a name="l03321"></a><span class="lineno"> 3321</span>&#160;<span class="comment"> *      will be set for recovery</span></div><div class="line"><a name="l03322"></a><span class="lineno"> 3322</span>&#160;<span class="comment"> * Check: The caller of this function should probably also call</span></div><div class="line"><a name="l03323"></a><span class="lineno"> 3323</span>&#160;<span class="comment"> * appended_lines().</span></div><div class="line"><a name="l03324"></a><span class="lineno"> 3324</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l03325"></a><span class="lineno"> 3325</span>&#160;<span class="comment"> * return FAIL for failure, OK otherwise</span></div><div class="line"><a name="l03326"></a><span class="lineno"> 3326</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l03327"></a><span class="lineno"> 3327</span>&#160;    <span class="keywordtype">int</span></div><div class="line"><a name="l03328"></a><span class="lineno"><a class="line" href="memline_8c.html#a6dd3bce99cbc1af9f7cfd6c843c5b44d"> 3328</a></span>&#160;<a class="code" href="memline_8c.html#a6dd3bce99cbc1af9f7cfd6c843c5b44d">ml_append</a>(</div><div class="line"><a name="l03329"></a><span class="lineno"> 3329</span>&#160;    <a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>    lnum,       <span class="comment">/* append after this line (can be 0) */</span></div><div class="line"><a name="l03330"></a><span class="lineno"> 3330</span>&#160;    char_u  *line,      <span class="comment">/* text of the new line */</span></div><div class="line"><a name="l03331"></a><span class="lineno"> 3331</span>&#160;    <a class="code" href="vim_8h.html#ae79e04a416bd6ce8ffe80e241850c0d2">colnr_T</a> len,        <span class="comment">/* length of new line, including NUL, or 0 */</span></div><div class="line"><a name="l03332"></a><span class="lineno"> 3332</span>&#160;    <span class="keywordtype">int</span>     newfile)    <span class="comment">/* flag, see above */</span></div><div class="line"><a name="l03333"></a><span class="lineno"> 3333</span>&#160;{</div><div class="line"><a name="l03334"></a><span class="lineno"> 3334</span>&#160;    <span class="comment">/* When starting up, we might still need to create the memfile */</span></div><div class="line"><a name="l03335"></a><span class="lineno"> 3335</span>&#160;    <span class="keywordflow">if</span> (curbuf-&gt;b_ml.ml_mfp == NULL &amp;&amp; <a class="code" href="buffer_8c.html#a1fcbd564641925e50627240e85a1d80a">open_buffer</a>(<a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, NULL, 0) == <a class="code" href="dosinst_8h.html#abb508ea8227673f419e9fe3a86c30d8e">FAIL</a>)</div><div class="line"><a name="l03336"></a><span class="lineno"> 3336</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="dosinst_8h.html#abb508ea8227673f419e9fe3a86c30d8e">FAIL</a>;</div><div class="line"><a name="l03337"></a><span class="lineno"> 3337</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="memline_8c.html#a7bbeb7c2510db6fc4366434b1b1996cf">ml_append_flush</a>(curbuf, lnum, line, len, newfile);</div><div class="line"><a name="l03338"></a><span class="lineno"> 3338</span>&#160;}</div><div class="line"><a name="l03339"></a><span class="lineno"> 3339</span>&#160;</div><div class="line"><a name="l03340"></a><span class="lineno"> 3340</span>&#160;<span class="preprocessor">#if defined(FEAT_SPELL) || defined(FEAT_QUICKFIX) || defined(PROTO)</span></div><div class="line"><a name="l03341"></a><span class="lineno"> 3341</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l03342"></a><span class="lineno"> 3342</span>&#160;<span class="comment"> * Like ml_append() but for an arbitrary buffer.  The buffer must already have</span></div><div class="line"><a name="l03343"></a><span class="lineno"> 3343</span>&#160;<span class="comment"> * a memline.</span></div><div class="line"><a name="l03344"></a><span class="lineno"> 3344</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l03345"></a><span class="lineno"> 3345</span>&#160;    <span class="keywordtype">int</span></div><div class="line"><a name="l03346"></a><span class="lineno"><a class="line" href="memline_8c.html#a50f229cf0f22b1940ea90f5c643a20b0"> 3346</a></span>&#160;<a class="code" href="memline_8c.html#a50f229cf0f22b1940ea90f5c643a20b0">ml_append_buf</a>(</div><div class="line"><a name="l03347"></a><span class="lineno"> 3347</span>&#160;    <a class="code" href="structfile__buffer.html">buf_T</a>   *buf,</div><div class="line"><a name="l03348"></a><span class="lineno"> 3348</span>&#160;    <a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>    lnum,       <span class="comment">/* append after this line (can be 0) */</span></div><div class="line"><a name="l03349"></a><span class="lineno"> 3349</span>&#160;    char_u  *line,      <span class="comment">/* text of the new line */</span></div><div class="line"><a name="l03350"></a><span class="lineno"> 3350</span>&#160;    <a class="code" href="vim_8h.html#ae79e04a416bd6ce8ffe80e241850c0d2">colnr_T</a> len,        <span class="comment">/* length of new line, including NUL, or 0 */</span></div><div class="line"><a name="l03351"></a><span class="lineno"> 3351</span>&#160;    <span class="keywordtype">int</span>     newfile)    <span class="comment">/* flag, see above */</span></div><div class="line"><a name="l03352"></a><span class="lineno"> 3352</span>&#160;{</div><div class="line"><a name="l03353"></a><span class="lineno"> 3353</span>&#160;    <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a9adb5a08b3c01be69c98360a14937227">ml_mfp</a> == NULL)</div><div class="line"><a name="l03354"></a><span class="lineno"> 3354</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="dosinst_8h.html#abb508ea8227673f419e9fe3a86c30d8e">FAIL</a>;</div><div class="line"><a name="l03355"></a><span class="lineno"> 3355</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="memline_8c.html#a7bbeb7c2510db6fc4366434b1b1996cf">ml_append_flush</a>(buf, lnum, line, len, newfile);</div><div class="line"><a name="l03356"></a><span class="lineno"> 3356</span>&#160;}</div><div class="line"><a name="l03357"></a><span class="lineno"> 3357</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l03358"></a><span class="lineno"> 3358</span>&#160;</div><div class="line"><a name="l03359"></a><span class="lineno"> 3359</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l03360"></a><span class="lineno"> 3360</span>&#160;<span class="comment"> * Replace line lnum, with buffering, in current buffer.</span></div><div class="line"><a name="l03361"></a><span class="lineno"> 3361</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l03362"></a><span class="lineno"> 3362</span>&#160;<span class="comment"> * If &quot;copy&quot; is TRUE, make a copy of the line, otherwise the line has been</span></div><div class="line"><a name="l03363"></a><span class="lineno"> 3363</span>&#160;<span class="comment"> * copied to allocated memory already.</span></div><div class="line"><a name="l03364"></a><span class="lineno"> 3364</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l03365"></a><span class="lineno"> 3365</span>&#160;<span class="comment"> * Check: The caller of this function should probably also call</span></div><div class="line"><a name="l03366"></a><span class="lineno"> 3366</span>&#160;<span class="comment"> * changed_lines(), unless update_screen(NOT_VALID) is used.</span></div><div class="line"><a name="l03367"></a><span class="lineno"> 3367</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l03368"></a><span class="lineno"> 3368</span>&#160;<span class="comment"> * return FAIL for failure, OK otherwise</span></div><div class="line"><a name="l03369"></a><span class="lineno"> 3369</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l03370"></a><span class="lineno"> 3370</span>&#160;    <span class="keywordtype">int</span></div><div class="line"><a name="l03371"></a><span class="lineno"><a class="line" href="memline_8c.html#a20133d6ad47e916b5e0512833896d5fe"> 3371</a></span>&#160;<a class="code" href="memline_8c.html#a20133d6ad47e916b5e0512833896d5fe">ml_replace</a>(<a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a> lnum, char_u *line, <span class="keywordtype">int</span> copy)</div><div class="line"><a name="l03372"></a><span class="lineno"> 3372</span>&#160;{</div><div class="line"><a name="l03373"></a><span class="lineno"> 3373</span>&#160;    <a class="code" href="vim_8h.html#ae79e04a416bd6ce8ffe80e241850c0d2">colnr_T</a> len = -1;</div><div class="line"><a name="l03374"></a><span class="lineno"> 3374</span>&#160;</div><div class="line"><a name="l03375"></a><span class="lineno"> 3375</span>&#160;    <span class="keywordflow">if</span> (line != NULL)</div><div class="line"><a name="l03376"></a><span class="lineno"> 3376</span>&#160;    len = (<a class="code" href="vim_8h.html#ae79e04a416bd6ce8ffe80e241850c0d2">colnr_T</a>)<a class="code" href="vim_8h.html#a916ffefe1fc74532d08102cca55d8e34">STRLEN</a>(line);</div><div class="line"><a name="l03377"></a><span class="lineno"> 3377</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="memline_8c.html#ab34eb7413d943026a67ef3580359d115">ml_replace_len</a>(lnum, line, len, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, copy);</div><div class="line"><a name="l03378"></a><span class="lineno"> 3378</span>&#160;}</div><div class="line"><a name="l03379"></a><span class="lineno"> 3379</span>&#160;</div><div class="line"><a name="l03380"></a><span class="lineno"> 3380</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l03381"></a><span class="lineno"> 3381</span>&#160;<span class="comment"> * Replace a line for the current buffer.  Like ml_replace() with:</span></div><div class="line"><a name="l03382"></a><span class="lineno"> 3382</span>&#160;<span class="comment"> * &quot;len_arg&quot; is the length of the text, excluding NUL.</span></div><div class="line"><a name="l03383"></a><span class="lineno"> 3383</span>&#160;<span class="comment"> * If &quot;has_props&quot; is TRUE then &quot;line_arg&quot; includes the text properties and</span></div><div class="line"><a name="l03384"></a><span class="lineno"> 3384</span>&#160;<span class="comment"> * &quot;len_arg&quot; includes the NUL of the text.</span></div><div class="line"><a name="l03385"></a><span class="lineno"> 3385</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l03386"></a><span class="lineno"> 3386</span>&#160;    <span class="keywordtype">int</span></div><div class="line"><a name="l03387"></a><span class="lineno"><a class="line" href="memline_8c.html#ab34eb7413d943026a67ef3580359d115"> 3387</a></span>&#160;<a class="code" href="memline_8c.html#ab34eb7413d943026a67ef3580359d115">ml_replace_len</a>(</div><div class="line"><a name="l03388"></a><span class="lineno"> 3388</span>&#160;    <a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>    lnum,</div><div class="line"><a name="l03389"></a><span class="lineno"> 3389</span>&#160;    char_u      *line_arg,</div><div class="line"><a name="l03390"></a><span class="lineno"> 3390</span>&#160;    <a class="code" href="vim_8h.html#ae79e04a416bd6ce8ffe80e241850c0d2">colnr_T</a>     len_arg,</div><div class="line"><a name="l03391"></a><span class="lineno"> 3391</span>&#160;    <span class="keywordtype">int</span>     has_props,</div><div class="line"><a name="l03392"></a><span class="lineno"> 3392</span>&#160;    <span class="keywordtype">int</span>     copy)</div><div class="line"><a name="l03393"></a><span class="lineno"> 3393</span>&#160;{</div><div class="line"><a name="l03394"></a><span class="lineno"> 3394</span>&#160;    char_u *line = line_arg;</div><div class="line"><a name="l03395"></a><span class="lineno"> 3395</span>&#160;    <a class="code" href="vim_8h.html#ae79e04a416bd6ce8ffe80e241850c0d2">colnr_T</a> len = len_arg;</div><div class="line"><a name="l03396"></a><span class="lineno"> 3396</span>&#160;</div><div class="line"><a name="l03397"></a><span class="lineno"> 3397</span>&#160;    <span class="keywordflow">if</span> (line == NULL)       <span class="comment">/* just checking... */</span></div><div class="line"><a name="l03398"></a><span class="lineno"> 3398</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="dosinst_8h.html#abb508ea8227673f419e9fe3a86c30d8e">FAIL</a>;</div><div class="line"><a name="l03399"></a><span class="lineno"> 3399</span>&#160;</div><div class="line"><a name="l03400"></a><span class="lineno"> 3400</span>&#160;    <span class="comment">/* When starting up, we might still need to create the memfile */</span></div><div class="line"><a name="l03401"></a><span class="lineno"> 3401</span>&#160;    <span class="keywordflow">if</span> (curbuf-&gt;b_ml.ml_mfp == NULL &amp;&amp; <a class="code" href="buffer_8c.html#a1fcbd564641925e50627240e85a1d80a">open_buffer</a>(<a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, NULL, 0) == <a class="code" href="dosinst_8h.html#abb508ea8227673f419e9fe3a86c30d8e">FAIL</a>)</div><div class="line"><a name="l03402"></a><span class="lineno"> 3402</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="dosinst_8h.html#abb508ea8227673f419e9fe3a86c30d8e">FAIL</a>;</div><div class="line"><a name="l03403"></a><span class="lineno"> 3403</span>&#160;</div><div class="line"><a name="l03404"></a><span class="lineno"> 3404</span>&#160;    <span class="keywordflow">if</span> (!has_props)</div><div class="line"><a name="l03405"></a><span class="lineno"> 3405</span>&#160;    ++len;  <span class="comment">// include the NUL after the text</span></div><div class="line"><a name="l03406"></a><span class="lineno"> 3406</span>&#160;    <span class="keywordflow">if</span> (copy)</div><div class="line"><a name="l03407"></a><span class="lineno"> 3407</span>&#160;    {</div><div class="line"><a name="l03408"></a><span class="lineno"> 3408</span>&#160;    <span class="comment">// copy the line to allocated memory</span></div><div class="line"><a name="l03409"></a><span class="lineno"> 3409</span>&#160;<span class="preprocessor">#ifdef FEAT_TEXT_PROP</span></div><div class="line"><a name="l03410"></a><span class="lineno"> 3410</span>&#160;    <span class="keywordflow">if</span> (has_props)</div><div class="line"><a name="l03411"></a><span class="lineno"> 3411</span>&#160;        line = <a class="code" href="misc2_8c.html#a4bcab42fe15a545fd147a9c3d03e4354">vim_memsave</a>(line, len);</div><div class="line"><a name="l03412"></a><span class="lineno"> 3412</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l03413"></a><span class="lineno"> 3413</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l03414"></a><span class="lineno"> 3414</span>&#160;        line = <a class="code" href="misc2_8c.html#a871ddb65e41d8bed1c38754d59737a5b">vim_strnsave</a>(line, len - 1);</div><div class="line"><a name="l03415"></a><span class="lineno"> 3415</span>&#160;    <span class="keywordflow">if</span> (line == NULL)</div><div class="line"><a name="l03416"></a><span class="lineno"> 3416</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="dosinst_8h.html#abb508ea8227673f419e9fe3a86c30d8e">FAIL</a>;</div><div class="line"><a name="l03417"></a><span class="lineno"> 3417</span>&#160;    }</div><div class="line"><a name="l03418"></a><span class="lineno"> 3418</span>&#160;</div><div class="line"><a name="l03419"></a><span class="lineno"> 3419</span>&#160;<span class="preprocessor">#ifdef FEAT_NETBEANS_INTG</span></div><div class="line"><a name="l03420"></a><span class="lineno"> 3420</span>&#160;    <span class="keywordflow">if</span> (netbeans_active())</div><div class="line"><a name="l03421"></a><span class="lineno"> 3421</span>&#160;    {</div><div class="line"><a name="l03422"></a><span class="lineno"> 3422</span>&#160;    netbeans_removed(curbuf, lnum, 0, (<span class="keywordtype">long</span>)<a class="code" href="vim_8h.html#a916ffefe1fc74532d08102cca55d8e34">STRLEN</a>(<a class="code" href="memline_8c.html#a109387062ce17fc808cae3971ce703ba">ml_get</a>(lnum)));</div><div class="line"><a name="l03423"></a><span class="lineno"> 3423</span>&#160;    netbeans_inserted(curbuf, lnum, 0, line, (<span class="keywordtype">int</span>)<a class="code" href="vim_8h.html#a916ffefe1fc74532d08102cca55d8e34">STRLEN</a>(line));</div><div class="line"><a name="l03424"></a><span class="lineno"> 3424</span>&#160;    }</div><div class="line"><a name="l03425"></a><span class="lineno"> 3425</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l03426"></a><span class="lineno"> 3426</span>&#160;    <span class="keywordflow">if</span> (curbuf-&gt;b_ml.ml_line_lnum != lnum)</div><div class="line"><a name="l03427"></a><span class="lineno"> 3427</span>&#160;    {</div><div class="line"><a name="l03428"></a><span class="lineno"> 3428</span>&#160;    <span class="comment">// another line is buffered, flush it</span></div><div class="line"><a name="l03429"></a><span class="lineno"> 3429</span>&#160;    <a class="code" href="memline_8c.html#a20a3268681f79a76b9af2f2fc7b644b6">ml_flush_line</a>(curbuf);</div><div class="line"><a name="l03430"></a><span class="lineno"> 3430</span>&#160;    curbuf-&gt;b_ml.ml_flags &amp;= ~<a class="code" href="structs_8h.html#a8fac7ceea6e156c2915cdcf7e228a9f8">ML_LINE_DIRTY</a>;</div><div class="line"><a name="l03431"></a><span class="lineno"> 3431</span>&#160;</div><div class="line"><a name="l03432"></a><span class="lineno"> 3432</span>&#160;<span class="preprocessor">#ifdef FEAT_TEXT_PROP</span></div><div class="line"><a name="l03433"></a><span class="lineno"> 3433</span>&#160;    <span class="keywordflow">if</span> (curbuf-&gt;b_has_textprop &amp;&amp; !has_props)</div><div class="line"><a name="l03434"></a><span class="lineno"> 3434</span>&#160;        <span class="comment">// Need to fetch the old line to copy over any text properties.</span></div><div class="line"><a name="l03435"></a><span class="lineno"> 3435</span>&#160;        <a class="code" href="memline_8c.html#a5efa31d210327048f60b8b00586e2a8c">ml_get_buf</a>(curbuf, lnum, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div><div class="line"><a name="l03436"></a><span class="lineno"> 3436</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l03437"></a><span class="lineno"> 3437</span>&#160;    }</div><div class="line"><a name="l03438"></a><span class="lineno"> 3438</span>&#160;</div><div class="line"><a name="l03439"></a><span class="lineno"> 3439</span>&#160;<span class="preprocessor">#ifdef FEAT_TEXT_PROP</span></div><div class="line"><a name="l03440"></a><span class="lineno"> 3440</span>&#160;    <span class="keywordflow">if</span> (curbuf-&gt;b_has_textprop &amp;&amp; !has_props)</div><div class="line"><a name="l03441"></a><span class="lineno"> 3441</span>&#160;    {</div><div class="line"><a name="l03442"></a><span class="lineno"> 3442</span>&#160;    <span class="keywordtype">size_t</span>  oldtextlen = <a class="code" href="vim_8h.html#a916ffefe1fc74532d08102cca55d8e34">STRLEN</a>(curbuf-&gt;b_ml.ml_line_ptr) + 1;</div><div class="line"><a name="l03443"></a><span class="lineno"> 3443</span>&#160;</div><div class="line"><a name="l03444"></a><span class="lineno"> 3444</span>&#160;    <span class="keywordflow">if</span> (oldtextlen &lt; (<span class="keywordtype">size_t</span>)curbuf-&gt;b_ml.ml_line_len)</div><div class="line"><a name="l03445"></a><span class="lineno"> 3445</span>&#160;    {</div><div class="line"><a name="l03446"></a><span class="lineno"> 3446</span>&#160;        char_u *newline;</div><div class="line"><a name="l03447"></a><span class="lineno"> 3447</span>&#160;        <span class="keywordtype">size_t</span> textproplen = curbuf-&gt;b_ml.ml_line_len - oldtextlen;</div><div class="line"><a name="l03448"></a><span class="lineno"> 3448</span>&#160;</div><div class="line"><a name="l03449"></a><span class="lineno"> 3449</span>&#160;        <span class="comment">// Need to copy over text properties, stored after the text.</span></div><div class="line"><a name="l03450"></a><span class="lineno"> 3450</span>&#160;        newline = <a class="code" href="misc2_8c.html#ad0b64e14955781629a3908e328f82665">alloc</a>(len + (<span class="keywordtype">int</span>)textproplen);</div><div class="line"><a name="l03451"></a><span class="lineno"> 3451</span>&#160;        <span class="keywordflow">if</span> (newline != NULL)</div><div class="line"><a name="l03452"></a><span class="lineno"> 3452</span>&#160;        {</div><div class="line"><a name="l03453"></a><span class="lineno"> 3453</span>&#160;        <a class="code" href="os__unix_8h.html#ae70108db942e4f3eeb701ad8787b1835">mch_memmove</a>(newline, line, len);</div><div class="line"><a name="l03454"></a><span class="lineno"> 3454</span>&#160;        <a class="code" href="os__unix_8h.html#ae70108db942e4f3eeb701ad8787b1835">mch_memmove</a>(newline + len, curbuf-&gt;b_ml.ml_line_ptr</div><div class="line"><a name="l03455"></a><span class="lineno"> 3455</span>&#160;                            + oldtextlen, textproplen);</div><div class="line"><a name="l03456"></a><span class="lineno"> 3456</span>&#160;        <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(line);</div><div class="line"><a name="l03457"></a><span class="lineno"> 3457</span>&#160;        line = newline;</div><div class="line"><a name="l03458"></a><span class="lineno"> 3458</span>&#160;        len += (<a class="code" href="vim_8h.html#ae79e04a416bd6ce8ffe80e241850c0d2">colnr_T</a>)textproplen;</div><div class="line"><a name="l03459"></a><span class="lineno"> 3459</span>&#160;        }</div><div class="line"><a name="l03460"></a><span class="lineno"> 3460</span>&#160;    }</div><div class="line"><a name="l03461"></a><span class="lineno"> 3461</span>&#160;    }</div><div class="line"><a name="l03462"></a><span class="lineno"> 3462</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l03463"></a><span class="lineno"> 3463</span>&#160;</div><div class="line"><a name="l03464"></a><span class="lineno"> 3464</span>&#160;    <span class="keywordflow">if</span> (curbuf-&gt;b_ml.ml_flags &amp; <a class="code" href="structs_8h.html#a8fac7ceea6e156c2915cdcf7e228a9f8">ML_LINE_DIRTY</a>)  <span class="comment">// same line allocated</span></div><div class="line"><a name="l03465"></a><span class="lineno"> 3465</span>&#160;    <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(curbuf-&gt;b_ml.ml_line_ptr); <span class="comment">// free it</span></div><div class="line"><a name="l03466"></a><span class="lineno"> 3466</span>&#160;</div><div class="line"><a name="l03467"></a><span class="lineno"> 3467</span>&#160;    curbuf-&gt;b_ml.ml_line_ptr = line;</div><div class="line"><a name="l03468"></a><span class="lineno"> 3468</span>&#160;    curbuf-&gt;b_ml.ml_line_len = len;</div><div class="line"><a name="l03469"></a><span class="lineno"> 3469</span>&#160;    curbuf-&gt;b_ml.ml_line_lnum = lnum;</div><div class="line"><a name="l03470"></a><span class="lineno"> 3470</span>&#160;    curbuf-&gt;b_ml.ml_flags = (curbuf-&gt;b_ml.ml_flags | <a class="code" href="structs_8h.html#a8fac7ceea6e156c2915cdcf7e228a9f8">ML_LINE_DIRTY</a>) &amp; ~<a class="code" href="structs_8h.html#a67ecfd4d644d8b33ba15512b7136602a">ML_EMPTY</a>;</div><div class="line"><a name="l03471"></a><span class="lineno"> 3471</span>&#160;</div><div class="line"><a name="l03472"></a><span class="lineno"> 3472</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="dosinst_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;</div><div class="line"><a name="l03473"></a><span class="lineno"> 3473</span>&#160;}</div><div class="line"><a name="l03474"></a><span class="lineno"> 3474</span>&#160;</div><div class="line"><a name="l03475"></a><span class="lineno"> 3475</span>&#160;<span class="preprocessor">#ifdef FEAT_TEXT_PROP</span></div><div class="line"><a name="l03476"></a><span class="lineno"> 3476</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l03477"></a><span class="lineno"> 3477</span>&#160;<span class="comment"> * Adjust text properties in line &quot;lnum&quot; for a deleted line.</span></div><div class="line"><a name="l03478"></a><span class="lineno"> 3478</span>&#160;<span class="comment"> * When &quot;above&quot; is true this is the line above the deleted line.</span></div><div class="line"><a name="l03479"></a><span class="lineno"> 3479</span>&#160;<span class="comment"> * &quot;del_props&quot; are the properties of the deleted line.</span></div><div class="line"><a name="l03480"></a><span class="lineno"> 3480</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l03481"></a><span class="lineno"> 3481</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">void</span></div><div class="line"><a name="l03482"></a><span class="lineno"><a class="line" href="memline_8c.html#a1c4075db28b41512824b19edc9e4e6c9"> 3482</a></span>&#160;<a class="code" href="memline_8c.html#a1c4075db28b41512824b19edc9e4e6c9">adjust_text_props_for_delete</a>(</div><div class="line"><a name="l03483"></a><span class="lineno"> 3483</span>&#160;    <a class="code" href="structfile__buffer.html">buf_T</a>       *buf,</div><div class="line"><a name="l03484"></a><span class="lineno"> 3484</span>&#160;    <a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>    lnum,</div><div class="line"><a name="l03485"></a><span class="lineno"> 3485</span>&#160;    char_u      *del_props,</div><div class="line"><a name="l03486"></a><span class="lineno"> 3486</span>&#160;    <span class="keywordtype">int</span>     del_props_len,</div><div class="line"><a name="l03487"></a><span class="lineno"> 3487</span>&#160;    <span class="keywordtype">int</span>     above)</div><div class="line"><a name="l03488"></a><span class="lineno"> 3488</span>&#160;{</div><div class="line"><a name="l03489"></a><span class="lineno"> 3489</span>&#160;    <span class="keywordtype">int</span>     did_get_line = <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line"><a name="l03490"></a><span class="lineno"> 3490</span>&#160;    <span class="keywordtype">int</span>     done_del;</div><div class="line"><a name="l03491"></a><span class="lineno"> 3491</span>&#160;    <span class="keywordtype">int</span>     done_this;</div><div class="line"><a name="l03492"></a><span class="lineno"> 3492</span>&#160;    <a class="code" href="structtextprop___s.html">textprop_T</a>  prop_del;</div><div class="line"><a name="l03493"></a><span class="lineno"> 3493</span>&#160;    <a class="code" href="structtextprop___s.html">textprop_T</a>  prop_this;</div><div class="line"><a name="l03494"></a><span class="lineno"> 3494</span>&#160;    <a class="code" href="structblock__hdr.html">bhdr_T</a>  *hp;</div><div class="line"><a name="l03495"></a><span class="lineno"> 3495</span>&#160;    <a class="code" href="structdata__block.html">DATA_BL</a> *dp;</div><div class="line"><a name="l03496"></a><span class="lineno"> 3496</span>&#160;    <span class="keywordtype">int</span>     idx;</div><div class="line"><a name="l03497"></a><span class="lineno"> 3497</span>&#160;    <span class="keywordtype">int</span>     line_start;</div><div class="line"><a name="l03498"></a><span class="lineno"> 3498</span>&#160;    <span class="keywordtype">long</span>    line_size;</div><div class="line"><a name="l03499"></a><span class="lineno"> 3499</span>&#160;    <span class="keywordtype">int</span>     this_props_len;</div><div class="line"><a name="l03500"></a><span class="lineno"> 3500</span>&#160;    char_u  *text;</div><div class="line"><a name="l03501"></a><span class="lineno"> 3501</span>&#160;    <span class="keywordtype">size_t</span>  textlen;</div><div class="line"><a name="l03502"></a><span class="lineno"> 3502</span>&#160;    <span class="keywordtype">int</span>     found;</div><div class="line"><a name="l03503"></a><span class="lineno"> 3503</span>&#160;</div><div class="line"><a name="l03504"></a><span class="lineno"> 3504</span>&#160;    <span class="keywordflow">for</span> (done_del = 0; done_del &lt; del_props_len; done_del += <span class="keyword">sizeof</span>(<a class="code" href="structs_8h.html#a5c7e944c137636434555c8a7f0cfcd77">textprop_T</a>))</div><div class="line"><a name="l03505"></a><span class="lineno"> 3505</span>&#160;    {</div><div class="line"><a name="l03506"></a><span class="lineno"> 3506</span>&#160;    <a class="code" href="os__unix_8h.html#ae70108db942e4f3eeb701ad8787b1835">mch_memmove</a>(&amp;prop_del, del_props + done_del, <span class="keyword">sizeof</span>(<a class="code" href="structtextprop___s.html">textprop_T</a>));</div><div class="line"><a name="l03507"></a><span class="lineno"> 3507</span>&#160;    <span class="keywordflow">if</span> ((above &amp;&amp; (prop_del.<a class="code" href="structtextprop___s.html#a37661218d497b414d619683e1063e09b">tp_flags</a> &amp; <a class="code" href="structs_8h.html#ad2df9991ef69c281e2c46a0b9473dc06">TP_FLAG_CONT_PREV</a>)</div><div class="line"><a name="l03508"></a><span class="lineno"> 3508</span>&#160;            &amp;&amp; !(prop_del.<a class="code" href="structtextprop___s.html#a37661218d497b414d619683e1063e09b">tp_flags</a> &amp; <a class="code" href="structs_8h.html#a1728259701820b8a8745485b2537217d">TP_FLAG_CONT_NEXT</a>))</div><div class="line"><a name="l03509"></a><span class="lineno"> 3509</span>&#160;        || (!above &amp;&amp; (prop_del.<a class="code" href="structtextprop___s.html#a37661218d497b414d619683e1063e09b">tp_flags</a> &amp; <a class="code" href="structs_8h.html#a1728259701820b8a8745485b2537217d">TP_FLAG_CONT_NEXT</a>)</div><div class="line"><a name="l03510"></a><span class="lineno"> 3510</span>&#160;            &amp;&amp; !(prop_del.<a class="code" href="structtextprop___s.html#a37661218d497b414d619683e1063e09b">tp_flags</a> &amp; <a class="code" href="structs_8h.html#ad2df9991ef69c281e2c46a0b9473dc06">TP_FLAG_CONT_PREV</a>)))</div><div class="line"><a name="l03511"></a><span class="lineno"> 3511</span>&#160;    {</div><div class="line"><a name="l03512"></a><span class="lineno"> 3512</span>&#160;        <span class="keywordflow">if</span> (!did_get_line)</div><div class="line"><a name="l03513"></a><span class="lineno"> 3513</span>&#160;        {</div><div class="line"><a name="l03514"></a><span class="lineno"> 3514</span>&#160;        did_get_line = <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"><a name="l03515"></a><span class="lineno"> 3515</span>&#160;        <span class="keywordflow">if</span> ((hp = <a class="code" href="memline_8c.html#ade8fe98188345bdd3c230545fc4a614f">ml_find_line</a>(buf, lnum, <a class="code" href="memline_8c.html#a1de07181f87bda4348b87eb71e0ab526">ML_FIND</a>)) == NULL)</div><div class="line"><a name="l03516"></a><span class="lineno"> 3516</span>&#160;            <span class="keywordflow">return</span>;</div><div class="line"><a name="l03517"></a><span class="lineno"> 3517</span>&#160;</div><div class="line"><a name="l03518"></a><span class="lineno"> 3518</span>&#160;        dp = (<a class="code" href="structdata__block.html">DATA_BL</a> *)(hp-&gt;<a class="code" href="structblock__hdr.html#a7247cdc0977ab6fdc9cb6238cda67587">bh_data</a>);</div><div class="line"><a name="l03519"></a><span class="lineno"> 3519</span>&#160;        idx = lnum - buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a2b7c6e30401df9d0e8972cb639d1b895">ml_locked_low</a>;</div><div class="line"><a name="l03520"></a><span class="lineno"> 3520</span>&#160;        line_start = ((dp-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[idx]) &amp; <a class="code" href="memline_8c.html#ab65775db0f7dbf161fce05ee7fb36573">DB_INDEX_MASK</a>);</div><div class="line"><a name="l03521"></a><span class="lineno"> 3521</span>&#160;        <span class="keywordflow">if</span> (idx == 0)       <span class="comment">// first line in block, text at the end</span></div><div class="line"><a name="l03522"></a><span class="lineno"> 3522</span>&#160;            line_size = dp-&gt;<a class="code" href="structdata__block.html#ae079e3993bfc47bd86fd6e2fc3ab44ba">db_txt_end</a> - line_start;</div><div class="line"><a name="l03523"></a><span class="lineno"> 3523</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l03524"></a><span class="lineno"> 3524</span>&#160;            line_size = ((dp-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[idx - 1]) &amp; <a class="code" href="memline_8c.html#ab65775db0f7dbf161fce05ee7fb36573">DB_INDEX_MASK</a>) - line_start;</div><div class="line"><a name="l03525"></a><span class="lineno"> 3525</span>&#160;        text = (char_u *)dp + line_start;</div><div class="line"><a name="l03526"></a><span class="lineno"> 3526</span>&#160;        textlen = <a class="code" href="vim_8h.html#a916ffefe1fc74532d08102cca55d8e34">STRLEN</a>(text) + 1;</div><div class="line"><a name="l03527"></a><span class="lineno"> 3527</span>&#160;        <span class="keywordflow">if</span> ((<span class="keywordtype">long</span>)textlen &gt;= line_size)</div><div class="line"><a name="l03528"></a><span class="lineno"> 3528</span>&#160;        {</div><div class="line"><a name="l03529"></a><span class="lineno"> 3529</span>&#160;            <span class="keywordflow">if</span> (above)</div><div class="line"><a name="l03530"></a><span class="lineno"> 3530</span>&#160;            <a class="code" href="message_8c.html#acf47f2acaa03395461e2b233638e69d0">internal_error</a>(<span class="stringliteral">&quot;no text property above deleted line&quot;</span>);</div><div class="line"><a name="l03531"></a><span class="lineno"> 3531</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l03532"></a><span class="lineno"> 3532</span>&#160;            <a class="code" href="message_8c.html#acf47f2acaa03395461e2b233638e69d0">internal_error</a>(<span class="stringliteral">&quot;no text property below deleted line&quot;</span>);</div><div class="line"><a name="l03533"></a><span class="lineno"> 3533</span>&#160;            <span class="keywordflow">return</span>;</div><div class="line"><a name="l03534"></a><span class="lineno"> 3534</span>&#160;        }</div><div class="line"><a name="l03535"></a><span class="lineno"> 3535</span>&#160;        this_props_len = line_size - (int)textlen;</div><div class="line"><a name="l03536"></a><span class="lineno"> 3536</span>&#160;        }</div><div class="line"><a name="l03537"></a><span class="lineno"> 3537</span>&#160;</div><div class="line"><a name="l03538"></a><span class="lineno"> 3538</span>&#160;        found = <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line"><a name="l03539"></a><span class="lineno"> 3539</span>&#160;        <span class="keywordflow">for</span> (done_this = 0; done_this &lt; this_props_len; done_this += <span class="keyword">sizeof</span>(<a class="code" href="structs_8h.html#a5c7e944c137636434555c8a7f0cfcd77">textprop_T</a>))</div><div class="line"><a name="l03540"></a><span class="lineno"> 3540</span>&#160;        {</div><div class="line"><a name="l03541"></a><span class="lineno"> 3541</span>&#160;        <a class="code" href="os__unix_8h.html#ae70108db942e4f3eeb701ad8787b1835">mch_memmove</a>(&amp;prop_this, text + textlen + done_del, <span class="keyword">sizeof</span>(<a class="code" href="structtextprop___s.html">textprop_T</a>));</div><div class="line"><a name="l03542"></a><span class="lineno"> 3542</span>&#160;        <span class="keywordflow">if</span> (prop_del.<a class="code" href="structtextprop___s.html#add824afd44cdd8e8a34e008fa91fb708">tp_id</a> == prop_this.<a class="code" href="structtextprop___s.html#add824afd44cdd8e8a34e008fa91fb708">tp_id</a></div><div class="line"><a name="l03543"></a><span class="lineno"> 3543</span>&#160;            &amp;&amp; prop_del.<a class="code" href="structtextprop___s.html#a01dfe881b1438f9c53dcdd63e76f3fbd">tp_type</a> == prop_this.<a class="code" href="structtextprop___s.html#a01dfe881b1438f9c53dcdd63e76f3fbd">tp_type</a>)</div><div class="line"><a name="l03544"></a><span class="lineno"> 3544</span>&#160;        {</div><div class="line"><a name="l03545"></a><span class="lineno"> 3545</span>&#160;            <span class="keywordtype">int</span> flag = above ? <a class="code" href="structs_8h.html#a1728259701820b8a8745485b2537217d">TP_FLAG_CONT_NEXT</a> : <a class="code" href="structs_8h.html#ad2df9991ef69c281e2c46a0b9473dc06">TP_FLAG_CONT_PREV</a>;</div><div class="line"><a name="l03546"></a><span class="lineno"> 3546</span>&#160;</div><div class="line"><a name="l03547"></a><span class="lineno"> 3547</span>&#160;            found = <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"><a name="l03548"></a><span class="lineno"> 3548</span>&#160;            <span class="keywordflow">if</span> (prop_this.<a class="code" href="structtextprop___s.html#a37661218d497b414d619683e1063e09b">tp_flags</a> &amp; flag)</div><div class="line"><a name="l03549"></a><span class="lineno"> 3549</span>&#160;            {</div><div class="line"><a name="l03550"></a><span class="lineno"> 3550</span>&#160;            prop_this.<a class="code" href="structtextprop___s.html#a37661218d497b414d619683e1063e09b">tp_flags</a> &amp;= ~flag;</div><div class="line"><a name="l03551"></a><span class="lineno"> 3551</span>&#160;            <a class="code" href="os__unix_8h.html#ae70108db942e4f3eeb701ad8787b1835">mch_memmove</a>(text + textlen + done_del, &amp;prop_this, <span class="keyword">sizeof</span>(<a class="code" href="structtextprop___s.html">textprop_T</a>));</div><div class="line"><a name="l03552"></a><span class="lineno"> 3552</span>&#160;            }</div><div class="line"><a name="l03553"></a><span class="lineno"> 3553</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (above)</div><div class="line"><a name="l03554"></a><span class="lineno"> 3554</span>&#160;            <a class="code" href="message_8c.html#acf47f2acaa03395461e2b233638e69d0">internal_error</a>(<span class="stringliteral">&quot;text property above deleted line does not continue&quot;</span>);</div><div class="line"><a name="l03555"></a><span class="lineno"> 3555</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l03556"></a><span class="lineno"> 3556</span>&#160;            <a class="code" href="message_8c.html#acf47f2acaa03395461e2b233638e69d0">internal_error</a>(<span class="stringliteral">&quot;text property below deleted line does not continue&quot;</span>);</div><div class="line"><a name="l03557"></a><span class="lineno"> 3557</span>&#160;        }</div><div class="line"><a name="l03558"></a><span class="lineno"> 3558</span>&#160;        }</div><div class="line"><a name="l03559"></a><span class="lineno"> 3559</span>&#160;        <span class="keywordflow">if</span> (!found)</div><div class="line"><a name="l03560"></a><span class="lineno"> 3560</span>&#160;        {</div><div class="line"><a name="l03561"></a><span class="lineno"> 3561</span>&#160;        <span class="keywordflow">if</span> (above)</div><div class="line"><a name="l03562"></a><span class="lineno"> 3562</span>&#160;            <a class="code" href="message_8c.html#acf47f2acaa03395461e2b233638e69d0">internal_error</a>(<span class="stringliteral">&quot;text property above deleted line not found&quot;</span>);</div><div class="line"><a name="l03563"></a><span class="lineno"> 3563</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l03564"></a><span class="lineno"> 3564</span>&#160;            <a class="code" href="message_8c.html#acf47f2acaa03395461e2b233638e69d0">internal_error</a>(<span class="stringliteral">&quot;text property below deleted line not found&quot;</span>);</div><div class="line"><a name="l03565"></a><span class="lineno"> 3565</span>&#160;        }</div><div class="line"><a name="l03566"></a><span class="lineno"> 3566</span>&#160;</div><div class="line"><a name="l03567"></a><span class="lineno"> 3567</span>&#160;        buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a30f30ddb7264f667a92556f0568981e0">ml_flags</a> |= (<a class="code" href="structs_8h.html#ad55a676a17d24163d3cdb2bf75a7fa66">ML_LOCKED_DIRTY</a> | <a class="code" href="structs_8h.html#a094e033c133f0276ed3c00f8053d0175">ML_LOCKED_POS</a>);</div><div class="line"><a name="l03568"></a><span class="lineno"> 3568</span>&#160;    }</div><div class="line"><a name="l03569"></a><span class="lineno"> 3569</span>&#160;    }</div><div class="line"><a name="l03570"></a><span class="lineno"> 3570</span>&#160;}</div><div class="line"><a name="l03571"></a><span class="lineno"> 3571</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l03572"></a><span class="lineno"> 3572</span>&#160;</div><div class="line"><a name="l03573"></a><span class="lineno"> 3573</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l03574"></a><span class="lineno"> 3574</span>&#160;<span class="comment"> * Delete line &quot;lnum&quot; in the current buffer.</span></div><div class="line"><a name="l03575"></a><span class="lineno"> 3575</span>&#160;<span class="comment"> * When &quot;message&quot; is TRUE may give a &quot;No lines in buffer&quot; message.</span></div><div class="line"><a name="l03576"></a><span class="lineno"> 3576</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l03577"></a><span class="lineno"> 3577</span>&#160;<span class="comment"> * Check: The caller of this function should probably also call</span></div><div class="line"><a name="l03578"></a><span class="lineno"> 3578</span>&#160;<span class="comment"> * deleted_lines() after this.</span></div><div class="line"><a name="l03579"></a><span class="lineno"> 3579</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l03580"></a><span class="lineno"> 3580</span>&#160;<span class="comment"> * return FAIL for failure, OK otherwise</span></div><div class="line"><a name="l03581"></a><span class="lineno"> 3581</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l03582"></a><span class="lineno"> 3582</span>&#160;    <span class="keywordtype">int</span></div><div class="line"><a name="l03583"></a><span class="lineno"><a class="line" href="memline_8c.html#acc7926ea1ef47502c4c44de231e2dbfc"> 3583</a></span>&#160;<a class="code" href="memline_8c.html#acc7926ea1ef47502c4c44de231e2dbfc">ml_delete</a>(<a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a> lnum, <span class="keywordtype">int</span> message)</div><div class="line"><a name="l03584"></a><span class="lineno"> 3584</span>&#160;{</div><div class="line"><a name="l03585"></a><span class="lineno"> 3585</span>&#160;    <a class="code" href="memline_8c.html#a20a3268681f79a76b9af2f2fc7b644b6">ml_flush_line</a>(curbuf);</div><div class="line"><a name="l03586"></a><span class="lineno"> 3586</span>&#160;    <span class="keywordflow">if</span> (lnum &lt; 1 || lnum &gt; curbuf-&gt;b_ml.ml_line_count)</div><div class="line"><a name="l03587"></a><span class="lineno"> 3587</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="dosinst_8h.html#abb508ea8227673f419e9fe3a86c30d8e">FAIL</a>;</div><div class="line"><a name="l03588"></a><span class="lineno"> 3588</span>&#160;</div><div class="line"><a name="l03589"></a><span class="lineno"> 3589</span>&#160;<span class="preprocessor">#ifdef FEAT_EVAL</span></div><div class="line"><a name="l03590"></a><span class="lineno"> 3590</span>&#160;    <span class="comment">// When inserting above recorded changes: flush the changes before changing</span></div><div class="line"><a name="l03591"></a><span class="lineno"> 3591</span>&#160;    <span class="comment">// the text.</span></div><div class="line"><a name="l03592"></a><span class="lineno"> 3592</span>&#160;    <a class="code" href="change_8c.html#a4cc8db1b395d092bd0a984f7abd5f1d1">may_invoke_listeners</a>(curbuf, lnum, lnum + 1, -1);</div><div class="line"><a name="l03593"></a><span class="lineno"> 3593</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l03594"></a><span class="lineno"> 3594</span>&#160;</div><div class="line"><a name="l03595"></a><span class="lineno"> 3595</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="memline_8c.html#a5e7aeced6dc3b0cf2af0f92ff3b3a875">ml_delete_int</a>(curbuf, lnum, message);</div><div class="line"><a name="l03596"></a><span class="lineno"> 3596</span>&#160;}</div><div class="line"><a name="l03597"></a><span class="lineno"> 3597</span>&#160;</div><div class="line"><a name="l03598"></a><span class="lineno"> 3598</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">int</span></div><div class="line"><a name="l03599"></a><span class="lineno"><a class="line" href="memline_8c.html#a5e7aeced6dc3b0cf2af0f92ff3b3a875"> 3599</a></span>&#160;<a class="code" href="memline_8c.html#a5e7aeced6dc3b0cf2af0f92ff3b3a875">ml_delete_int</a>(<a class="code" href="structfile__buffer.html">buf_T</a> *buf, <a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a> lnum, <span class="keywordtype">int</span> message)</div><div class="line"><a name="l03600"></a><span class="lineno"> 3600</span>&#160;{</div><div class="line"><a name="l03601"></a><span class="lineno"> 3601</span>&#160;    <a class="code" href="structblock__hdr.html">bhdr_T</a>  *hp;</div><div class="line"><a name="l03602"></a><span class="lineno"> 3602</span>&#160;    <a class="code" href="structmemfile.html">memfile_T</a>   *mfp;</div><div class="line"><a name="l03603"></a><span class="lineno"> 3603</span>&#160;    <a class="code" href="structdata__block.html">DATA_BL</a> *dp;</div><div class="line"><a name="l03604"></a><span class="lineno"> 3604</span>&#160;    <a class="code" href="structpointer__block.html">PTR_BL</a>  *pp;</div><div class="line"><a name="l03605"></a><span class="lineno"> 3605</span>&#160;    <a class="code" href="structinfo__pointer.html">infoptr_T</a>   *<a class="code" href="namespacetest__channel.html#a6a2152bf75d93cd14fcffc99c3e76807">ip</a>;</div><div class="line"><a name="l03606"></a><span class="lineno"> 3606</span>&#160;    <span class="keywordtype">int</span>     count;      <span class="comment">/* number of entries in block */</span></div><div class="line"><a name="l03607"></a><span class="lineno"> 3607</span>&#160;    <span class="keywordtype">int</span>     idx;</div><div class="line"><a name="l03608"></a><span class="lineno"> 3608</span>&#160;    <span class="keywordtype">int</span>     stack_idx;</div><div class="line"><a name="l03609"></a><span class="lineno"> 3609</span>&#160;    <span class="keywordtype">int</span>     text_start;</div><div class="line"><a name="l03610"></a><span class="lineno"> 3610</span>&#160;    <span class="keywordtype">int</span>     line_start;</div><div class="line"><a name="l03611"></a><span class="lineno"> 3611</span>&#160;    <span class="keywordtype">long</span>    line_size;</div><div class="line"><a name="l03612"></a><span class="lineno"> 3612</span>&#160;    <span class="keywordtype">int</span>     i;</div><div class="line"><a name="l03613"></a><span class="lineno"> 3613</span>&#160;    <span class="keywordtype">int</span>     ret = <a class="code" href="dosinst_8h.html#abb508ea8227673f419e9fe3a86c30d8e">FAIL</a>;</div><div class="line"><a name="l03614"></a><span class="lineno"> 3614</span>&#160;<span class="preprocessor">#ifdef FEAT_TEXT_PROP</span></div><div class="line"><a name="l03615"></a><span class="lineno"> 3615</span>&#160;    char_u  *textprop_save = NULL;</div><div class="line"><a name="l03616"></a><span class="lineno"> 3616</span>&#160;    <span class="keywordtype">int</span>     textprop_save_len;</div><div class="line"><a name="l03617"></a><span class="lineno"> 3617</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l03618"></a><span class="lineno"> 3618</span>&#160;</div><div class="line"><a name="l03619"></a><span class="lineno"> 3619</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="memline_8c.html#a8837c8c8a497ab410a9e925581f966c3">lowest_marked</a> &amp;&amp; <a class="code" href="memline_8c.html#a8837c8c8a497ab410a9e925581f966c3">lowest_marked</a> &gt; lnum)</div><div class="line"><a name="l03620"></a><span class="lineno"> 3620</span>&#160;    <a class="code" href="memline_8c.html#a8837c8c8a497ab410a9e925581f966c3">lowest_marked</a>--;</div><div class="line"><a name="l03621"></a><span class="lineno"> 3621</span>&#160;</div><div class="line"><a name="l03622"></a><span class="lineno"> 3622</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l03623"></a><span class="lineno"> 3623</span>&#160;<span class="comment"> * If the file becomes empty the last line is replaced by an empty line.</span></div><div class="line"><a name="l03624"></a><span class="lineno"> 3624</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l03625"></a><span class="lineno"> 3625</span>&#160;    <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a708091d31fa9cf7718aca80d707b1b3d">ml_line_count</a> == 1)       <span class="comment">/* file becomes empty */</span></div><div class="line"><a name="l03626"></a><span class="lineno"> 3626</span>&#160;    {</div><div class="line"><a name="l03627"></a><span class="lineno"> 3627</span>&#160;    <span class="keywordflow">if</span> (message</div><div class="line"><a name="l03628"></a><span class="lineno"> 3628</span>&#160;#ifdef FEAT_NETBEANS_INTG</div><div class="line"><a name="l03629"></a><span class="lineno"> 3629</span>&#160;        &amp;&amp; !netbeansSuppressNoLines</div><div class="line"><a name="l03630"></a><span class="lineno"> 3630</span>&#160;#endif</div><div class="line"><a name="l03631"></a><span class="lineno"> 3631</span>&#160;       )</div><div class="line"><a name="l03632"></a><span class="lineno"> 3632</span>&#160;        <a class="code" href="message_8c.html#a1adc86bbd012d6e33d3fddf074a31491">set_keep_msg</a>((char_u *)<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(no_lines_msg), 0);</div><div class="line"><a name="l03633"></a><span class="lineno"> 3633</span>&#160;</div><div class="line"><a name="l03634"></a><span class="lineno"> 3634</span>&#160;    <span class="comment">/* FEAT_BYTEOFF already handled in there, don&#39;t worry &#39;bout it below */</span></div><div class="line"><a name="l03635"></a><span class="lineno"> 3635</span>&#160;    i = <a class="code" href="memline_8c.html#a20133d6ad47e916b5e0512833896d5fe">ml_replace</a>((<a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>)1, (char_u *)<span class="stringliteral">&quot;&quot;</span>, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div><div class="line"><a name="l03636"></a><span class="lineno"> 3636</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a30f30ddb7264f667a92556f0568981e0">ml_flags</a> |= <a class="code" href="structs_8h.html#a67ecfd4d644d8b33ba15512b7136602a">ML_EMPTY</a>;</div><div class="line"><a name="l03637"></a><span class="lineno"> 3637</span>&#160;</div><div class="line"><a name="l03638"></a><span class="lineno"> 3638</span>&#160;    <span class="keywordflow">return</span> i;</div><div class="line"><a name="l03639"></a><span class="lineno"> 3639</span>&#160;    }</div><div class="line"><a name="l03640"></a><span class="lineno"> 3640</span>&#160;</div><div class="line"><a name="l03641"></a><span class="lineno"> 3641</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l03642"></a><span class="lineno"> 3642</span>&#160;<span class="comment"> * Find the data block containing the line.</span></div><div class="line"><a name="l03643"></a><span class="lineno"> 3643</span>&#160;<span class="comment"> * This also fills the stack with the blocks from the root to the data block.</span></div><div class="line"><a name="l03644"></a><span class="lineno"> 3644</span>&#160;<span class="comment"> * This also releases any locked block..</span></div><div class="line"><a name="l03645"></a><span class="lineno"> 3645</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l03646"></a><span class="lineno"> 3646</span>&#160;    mfp = buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a9adb5a08b3c01be69c98360a14937227">ml_mfp</a>;</div><div class="line"><a name="l03647"></a><span class="lineno"> 3647</span>&#160;    <span class="keywordflow">if</span> (mfp == NULL)</div><div class="line"><a name="l03648"></a><span class="lineno"> 3648</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="dosinst_8h.html#abb508ea8227673f419e9fe3a86c30d8e">FAIL</a>;</div><div class="line"><a name="l03649"></a><span class="lineno"> 3649</span>&#160;</div><div class="line"><a name="l03650"></a><span class="lineno"> 3650</span>&#160;    <span class="keywordflow">if</span> ((hp = <a class="code" href="memline_8c.html#ade8fe98188345bdd3c230545fc4a614f">ml_find_line</a>(buf, lnum, <a class="code" href="memline_8c.html#ae92d6ba5b936547467fd45f1b6534778">ML_DELETE</a>)) == NULL)</div><div class="line"><a name="l03651"></a><span class="lineno"> 3651</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="dosinst_8h.html#abb508ea8227673f419e9fe3a86c30d8e">FAIL</a>;</div><div class="line"><a name="l03652"></a><span class="lineno"> 3652</span>&#160;</div><div class="line"><a name="l03653"></a><span class="lineno"> 3653</span>&#160;    dp = (<a class="code" href="structdata__block.html">DATA_BL</a> *)(hp-&gt;<a class="code" href="structblock__hdr.html#a7247cdc0977ab6fdc9cb6238cda67587">bh_data</a>);</div><div class="line"><a name="l03654"></a><span class="lineno"> 3654</span>&#160;    <span class="comment">/* compute line count before the delete */</span></div><div class="line"><a name="l03655"></a><span class="lineno"> 3655</span>&#160;    count = (long)(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a81788089e53748eb945a88d6e41647da">ml_locked_high</a>)</div><div class="line"><a name="l03656"></a><span class="lineno"> 3656</span>&#160;                    - (long)(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a2b7c6e30401df9d0e8972cb639d1b895">ml_locked_low</a>) + 2;</div><div class="line"><a name="l03657"></a><span class="lineno"> 3657</span>&#160;    idx = lnum - buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a2b7c6e30401df9d0e8972cb639d1b895">ml_locked_low</a>;</div><div class="line"><a name="l03658"></a><span class="lineno"> 3658</span>&#160;</div><div class="line"><a name="l03659"></a><span class="lineno"> 3659</span>&#160;    --buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a708091d31fa9cf7718aca80d707b1b3d">ml_line_count</a>;</div><div class="line"><a name="l03660"></a><span class="lineno"> 3660</span>&#160;</div><div class="line"><a name="l03661"></a><span class="lineno"> 3661</span>&#160;    line_start = ((dp-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[idx]) &amp; <a class="code" href="memline_8c.html#ab65775db0f7dbf161fce05ee7fb36573">DB_INDEX_MASK</a>);</div><div class="line"><a name="l03662"></a><span class="lineno"> 3662</span>&#160;    <span class="keywordflow">if</span> (idx == 0)       <span class="comment">/* first line in block, text at the end */</span></div><div class="line"><a name="l03663"></a><span class="lineno"> 3663</span>&#160;    line_size = dp-&gt;<a class="code" href="structdata__block.html#ae079e3993bfc47bd86fd6e2fc3ab44ba">db_txt_end</a> - line_start;</div><div class="line"><a name="l03664"></a><span class="lineno"> 3664</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l03665"></a><span class="lineno"> 3665</span>&#160;    line_size = ((dp-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[idx - 1]) &amp; <a class="code" href="memline_8c.html#ab65775db0f7dbf161fce05ee7fb36573">DB_INDEX_MASK</a>) - line_start;</div><div class="line"><a name="l03666"></a><span class="lineno"> 3666</span>&#160;</div><div class="line"><a name="l03667"></a><span class="lineno"> 3667</span>&#160;<span class="preprocessor">#ifdef FEAT_NETBEANS_INTG</span></div><div class="line"><a name="l03668"></a><span class="lineno"> 3668</span>&#160;    <span class="keywordflow">if</span> (netbeans_active())</div><div class="line"><a name="l03669"></a><span class="lineno"> 3669</span>&#160;    netbeans_removed(buf, lnum, 0, (<span class="keywordtype">long</span>)line_size);</div><div class="line"><a name="l03670"></a><span class="lineno"> 3670</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l03671"></a><span class="lineno"> 3671</span>&#160;<span class="preprocessor">#ifdef FEAT_TEXT_PROP</span></div><div class="line"><a name="l03672"></a><span class="lineno"> 3672</span>&#160;    <span class="comment">// If there are text properties, make a copy, so that we can update</span></div><div class="line"><a name="l03673"></a><span class="lineno"> 3673</span>&#160;    <span class="comment">// properties in preceding and following lines.</span></div><div class="line"><a name="l03674"></a><span class="lineno"> 3674</span>&#160;    <span class="keywordflow">if</span> (buf-&gt;b_has_textprop)</div><div class="line"><a name="l03675"></a><span class="lineno"> 3675</span>&#160;    {</div><div class="line"><a name="l03676"></a><span class="lineno"> 3676</span>&#160;    <span class="keywordtype">size_t</span>  textlen = <a class="code" href="vim_8h.html#a916ffefe1fc74532d08102cca55d8e34">STRLEN</a>((char_u *)dp + line_start) + 1;</div><div class="line"><a name="l03677"></a><span class="lineno"> 3677</span>&#160;</div><div class="line"><a name="l03678"></a><span class="lineno"> 3678</span>&#160;    <span class="keywordflow">if</span> ((<span class="keywordtype">long</span>)textlen &lt; line_size)</div><div class="line"><a name="l03679"></a><span class="lineno"> 3679</span>&#160;    {</div><div class="line"><a name="l03680"></a><span class="lineno"> 3680</span>&#160;        textprop_save_len = line_size - (int)textlen;</div><div class="line"><a name="l03681"></a><span class="lineno"> 3681</span>&#160;        textprop_save = <a class="code" href="misc2_8c.html#a4bcab42fe15a545fd147a9c3d03e4354">vim_memsave</a>((char_u *)dp + line_start + textlen,</div><div class="line"><a name="l03682"></a><span class="lineno"> 3682</span>&#160;                              textprop_save_len);</div><div class="line"><a name="l03683"></a><span class="lineno"> 3683</span>&#160;    }</div><div class="line"><a name="l03684"></a><span class="lineno"> 3684</span>&#160;    }</div><div class="line"><a name="l03685"></a><span class="lineno"> 3685</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l03686"></a><span class="lineno"> 3686</span>&#160;</div><div class="line"><a name="l03687"></a><span class="lineno"> 3687</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l03688"></a><span class="lineno"> 3688</span>&#160;<span class="comment"> * special case: If there is only one line in the data block it becomes empty.</span></div><div class="line"><a name="l03689"></a><span class="lineno"> 3689</span>&#160;<span class="comment"> * Then we have to remove the entry, pointing to this data block, from the</span></div><div class="line"><a name="l03690"></a><span class="lineno"> 3690</span>&#160;<span class="comment"> * pointer block. If this pointer block also becomes empty, we go up another</span></div><div class="line"><a name="l03691"></a><span class="lineno"> 3691</span>&#160;<span class="comment"> * block, and so on, up to the root if necessary.</span></div><div class="line"><a name="l03692"></a><span class="lineno"> 3692</span>&#160;<span class="comment"> * The line counts in the pointer blocks have already been adjusted by</span></div><div class="line"><a name="l03693"></a><span class="lineno"> 3693</span>&#160;<span class="comment"> * ml_find_line().</span></div><div class="line"><a name="l03694"></a><span class="lineno"> 3694</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l03695"></a><span class="lineno"> 3695</span>&#160;    <span class="keywordflow">if</span> (count == 1)</div><div class="line"><a name="l03696"></a><span class="lineno"> 3696</span>&#160;    {</div><div class="line"><a name="l03697"></a><span class="lineno"> 3697</span>&#160;    <a class="code" href="memfile_8c.html#a69265c5b601f69e279b2bad593613e18">mf_free</a>(mfp, hp);   <span class="comment">/* free the data block */</span></div><div class="line"><a name="l03698"></a><span class="lineno"> 3698</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#aa4c2830f305306d4f5f163b4522d0ba6">ml_locked</a> = NULL;</div><div class="line"><a name="l03699"></a><span class="lineno"> 3699</span>&#160;</div><div class="line"><a name="l03700"></a><span class="lineno"> 3700</span>&#160;    <span class="keywordflow">for</span> (stack_idx = buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a17d957b4b662bf327749e1523ac4f5b5">ml_stack_top</a> - 1; stack_idx &gt;= 0;</div><div class="line"><a name="l03701"></a><span class="lineno"> 3701</span>&#160;                                  --stack_idx)</div><div class="line"><a name="l03702"></a><span class="lineno"> 3702</span>&#160;    {</div><div class="line"><a name="l03703"></a><span class="lineno"> 3703</span>&#160;        buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a17d957b4b662bf327749e1523ac4f5b5">ml_stack_top</a> = 0;     <span class="comment">/* stack is invalid when failing */</span></div><div class="line"><a name="l03704"></a><span class="lineno"> 3704</span>&#160;        ip = &amp;(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a77e2179043ee3367af09fe186b2fa5a8">ml_stack</a>[stack_idx]);</div><div class="line"><a name="l03705"></a><span class="lineno"> 3705</span>&#160;        idx = ip-&gt;<a class="code" href="structinfo__pointer.html#acdf584cb720506bd2f40240dc71bab50">ip_index</a>;</div><div class="line"><a name="l03706"></a><span class="lineno"> 3706</span>&#160;        <span class="keywordflow">if</span> ((hp = <a class="code" href="memfile_8c.html#af9d5ff9ad91a2d5150a675c9c0d77e10">mf_get</a>(mfp, ip-&gt;<a class="code" href="structinfo__pointer.html#a140d83e56091daa97560a9a4a82a8c1b">ip_bnum</a>, 1)) == NULL)</div><div class="line"><a name="l03707"></a><span class="lineno"> 3707</span>&#160;        <span class="keywordflow">goto</span> theend;</div><div class="line"><a name="l03708"></a><span class="lineno"> 3708</span>&#160;        pp = (<a class="code" href="structpointer__block.html">PTR_BL</a> *)(hp-&gt;<a class="code" href="structblock__hdr.html#a7247cdc0977ab6fdc9cb6238cda67587">bh_data</a>);   <span class="comment">/* must be pointer block */</span></div><div class="line"><a name="l03709"></a><span class="lineno"> 3709</span>&#160;        <span class="keywordflow">if</span> (pp-&gt;<a class="code" href="structpointer__block.html#ac2698ad2c9c4096299106a53ffbd667f">pb_id</a> != <a class="code" href="memline_8c.html#a23d0125357ec4465a50f841f634c9214">PTR_ID</a>)</div><div class="line"><a name="l03710"></a><span class="lineno"> 3710</span>&#160;        {</div><div class="line"><a name="l03711"></a><span class="lineno"> 3711</span>&#160;        <a class="code" href="message_8c.html#a7926d7fa9a35dc0f5bac051dec01240a">iemsg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;E317: pointer block id wrong 4&quot;</span>));</div><div class="line"><a name="l03712"></a><span class="lineno"> 3712</span>&#160;        <a class="code" href="memfile_8c.html#abb7f268382703d32becc96f6d92fb855">mf_put</a>(mfp, hp, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l03713"></a><span class="lineno"> 3713</span>&#160;        <span class="keywordflow">goto</span> theend;</div><div class="line"><a name="l03714"></a><span class="lineno"> 3714</span>&#160;        }</div><div class="line"><a name="l03715"></a><span class="lineno"> 3715</span>&#160;        count = --(pp-&gt;<a class="code" href="structpointer__block.html#ad3682038298e7850fb980815132f17f9">pb_count</a>);</div><div class="line"><a name="l03716"></a><span class="lineno"> 3716</span>&#160;        <span class="keywordflow">if</span> (count == 0)     <span class="comment">/* the pointer block becomes empty! */</span></div><div class="line"><a name="l03717"></a><span class="lineno"> 3717</span>&#160;        <a class="code" href="memfile_8c.html#a69265c5b601f69e279b2bad593613e18">mf_free</a>(mfp, hp);</div><div class="line"><a name="l03718"></a><span class="lineno"> 3718</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l03719"></a><span class="lineno"> 3719</span>&#160;        {</div><div class="line"><a name="l03720"></a><span class="lineno"> 3720</span>&#160;        <span class="keywordflow">if</span> (count != idx)   <span class="comment">/* move entries after the deleted one */</span></div><div class="line"><a name="l03721"></a><span class="lineno"> 3721</span>&#160;            <a class="code" href="os__unix_8h.html#ae70108db942e4f3eeb701ad8787b1835">mch_memmove</a>(&amp;pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[idx], &amp;pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[idx + 1],</div><div class="line"><a name="l03722"></a><span class="lineno"> 3722</span>&#160;                      (<span class="keywordtype">size_t</span>)(count - idx) * <span class="keyword">sizeof</span>(<a class="code" href="structpointer__entry.html">PTR_EN</a>));</div><div class="line"><a name="l03723"></a><span class="lineno"> 3723</span>&#160;        <a class="code" href="memfile_8c.html#abb7f268382703d32becc96f6d92fb855">mf_put</a>(mfp, hp, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l03724"></a><span class="lineno"> 3724</span>&#160;</div><div class="line"><a name="l03725"></a><span class="lineno"> 3725</span>&#160;        buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a17d957b4b662bf327749e1523ac4f5b5">ml_stack_top</a> = stack_idx; <span class="comment">/* truncate stack */</span></div><div class="line"><a name="l03726"></a><span class="lineno"> 3726</span>&#160;        <span class="comment">/* fix line count for rest of blocks in the stack */</span></div><div class="line"><a name="l03727"></a><span class="lineno"> 3727</span>&#160;        <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a97f953057f1eaa0360502866f1e54964">ml_locked_lineadd</a> != 0)</div><div class="line"><a name="l03728"></a><span class="lineno"> 3728</span>&#160;        {</div><div class="line"><a name="l03729"></a><span class="lineno"> 3729</span>&#160;            <a class="code" href="memline_8c.html#a661ea17a2f15417b31afca629fbef050">ml_lineadd</a>(buf, buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a97f953057f1eaa0360502866f1e54964">ml_locked_lineadd</a>);</div><div class="line"><a name="l03730"></a><span class="lineno"> 3730</span>&#160;            buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a77e2179043ee3367af09fe186b2fa5a8">ml_stack</a>[buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a17d957b4b662bf327749e1523ac4f5b5">ml_stack_top</a>].<a class="code" href="structinfo__pointer.html#ac473382eb6323825263f4e65ddbb68de">ip_high</a> +=</div><div class="line"><a name="l03731"></a><span class="lineno"> 3731</span>&#160;                          buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a97f953057f1eaa0360502866f1e54964">ml_locked_lineadd</a>;</div><div class="line"><a name="l03732"></a><span class="lineno"> 3732</span>&#160;        }</div><div class="line"><a name="l03733"></a><span class="lineno"> 3733</span>&#160;        ++(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a17d957b4b662bf327749e1523ac4f5b5">ml_stack_top</a>);</div><div class="line"><a name="l03734"></a><span class="lineno"> 3734</span>&#160;</div><div class="line"><a name="l03735"></a><span class="lineno"> 3735</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l03736"></a><span class="lineno"> 3736</span>&#160;        }</div><div class="line"><a name="l03737"></a><span class="lineno"> 3737</span>&#160;    }</div><div class="line"><a name="l03738"></a><span class="lineno"> 3738</span>&#160;    <a class="code" href="memline_8c.html#a4c3f0432d972be512c1ff55974987c8c">CHECK</a>(stack_idx &lt; 0, <a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;deleted block 1?&quot;</span>));</div><div class="line"><a name="l03739"></a><span class="lineno"> 3739</span>&#160;    }</div><div class="line"><a name="l03740"></a><span class="lineno"> 3740</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l03741"></a><span class="lineno"> 3741</span>&#160;    {</div><div class="line"><a name="l03742"></a><span class="lineno"> 3742</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l03743"></a><span class="lineno"> 3743</span>&#160;<span class="comment">     * delete the text by moving the next lines forwards</span></div><div class="line"><a name="l03744"></a><span class="lineno"> 3744</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l03745"></a><span class="lineno"> 3745</span>&#160;    text_start = dp-&gt;<a class="code" href="structdata__block.html#a3937f5841b2fed9a042872981b06a7b8">db_txt_start</a>;</div><div class="line"><a name="l03746"></a><span class="lineno"> 3746</span>&#160;    <a class="code" href="os__unix_8h.html#ae70108db942e4f3eeb701ad8787b1835">mch_memmove</a>((<span class="keywordtype">char</span> *)dp + text_start + line_size,</div><div class="line"><a name="l03747"></a><span class="lineno"> 3747</span>&#160;          (<span class="keywordtype">char</span> *)dp + text_start, (<span class="keywordtype">size_t</span>)(line_start - text_start));</div><div class="line"><a name="l03748"></a><span class="lineno"> 3748</span>&#160;</div><div class="line"><a name="l03749"></a><span class="lineno"> 3749</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l03750"></a><span class="lineno"> 3750</span>&#160;<span class="comment">     * delete the index by moving the next indexes backwards</span></div><div class="line"><a name="l03751"></a><span class="lineno"> 3751</span>&#160;<span class="comment">     * Adjust the indexes for the text movement.</span></div><div class="line"><a name="l03752"></a><span class="lineno"> 3752</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l03753"></a><span class="lineno"> 3753</span>&#160;    <span class="keywordflow">for</span> (i = idx; i &lt; count - 1; ++i)</div><div class="line"><a name="l03754"></a><span class="lineno"> 3754</span>&#160;        dp-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[i] = dp-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[i + 1] + line_size;</div><div class="line"><a name="l03755"></a><span class="lineno"> 3755</span>&#160;</div><div class="line"><a name="l03756"></a><span class="lineno"> 3756</span>&#160;    dp-&gt;<a class="code" href="structdata__block.html#a6cd7e5186f74ae199fe547bc905b2815">db_free</a> += line_size + <a class="code" href="memline_8c.html#a33bdc994ac7c8cda7d0df1a3369ab965">INDEX_SIZE</a>;</div><div class="line"><a name="l03757"></a><span class="lineno"> 3757</span>&#160;    dp-&gt;<a class="code" href="structdata__block.html#a3937f5841b2fed9a042872981b06a7b8">db_txt_start</a> += line_size;</div><div class="line"><a name="l03758"></a><span class="lineno"> 3758</span>&#160;    --(dp-&gt;<a class="code" href="structdata__block.html#a00084a39a3bdd9a03b9a055216aec5c5">db_line_count</a>);</div><div class="line"><a name="l03759"></a><span class="lineno"> 3759</span>&#160;</div><div class="line"><a name="l03760"></a><span class="lineno"> 3760</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l03761"></a><span class="lineno"> 3761</span>&#160;<span class="comment">     * mark the block dirty and make sure it is in the file (for recovery)</span></div><div class="line"><a name="l03762"></a><span class="lineno"> 3762</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l03763"></a><span class="lineno"> 3763</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a30f30ddb7264f667a92556f0568981e0">ml_flags</a> |= (<a class="code" href="structs_8h.html#ad55a676a17d24163d3cdb2bf75a7fa66">ML_LOCKED_DIRTY</a> | <a class="code" href="structs_8h.html#a094e033c133f0276ed3c00f8053d0175">ML_LOCKED_POS</a>);</div><div class="line"><a name="l03764"></a><span class="lineno"> 3764</span>&#160;    }</div><div class="line"><a name="l03765"></a><span class="lineno"> 3765</span>&#160;</div><div class="line"><a name="l03766"></a><span class="lineno"> 3766</span>&#160;<span class="preprocessor">#ifdef FEAT_BYTEOFF</span></div><div class="line"><a name="l03767"></a><span class="lineno"> 3767</span>&#160;    <a class="code" href="memline_8c.html#ae8486bd6f1922d43b60969e2be927915">ml_updatechunk</a>(buf, lnum, line_size, ML_CHNK_DELLINE);</div><div class="line"><a name="l03768"></a><span class="lineno"> 3768</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l03769"></a><span class="lineno"> 3769</span>&#160;    ret = <a class="code" href="dosinst_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>;</div><div class="line"><a name="l03770"></a><span class="lineno"> 3770</span>&#160;</div><div class="line"><a name="l03771"></a><span class="lineno"> 3771</span>&#160;theend:</div><div class="line"><a name="l03772"></a><span class="lineno"> 3772</span>&#160;<span class="preprocessor">#ifdef FEAT_TEXT_PROP</span></div><div class="line"><a name="l03773"></a><span class="lineno"> 3773</span>&#160;    <span class="keywordflow">if</span> (textprop_save != NULL)</div><div class="line"><a name="l03774"></a><span class="lineno"> 3774</span>&#160;    {</div><div class="line"><a name="l03775"></a><span class="lineno"> 3775</span>&#160;    <span class="comment">// Adjust text properties in the line above and below.</span></div><div class="line"><a name="l03776"></a><span class="lineno"> 3776</span>&#160;    <span class="keywordflow">if</span> (lnum &gt; 1)</div><div class="line"><a name="l03777"></a><span class="lineno"> 3777</span>&#160;        <a class="code" href="memline_8c.html#a1c4075db28b41512824b19edc9e4e6c9">adjust_text_props_for_delete</a>(buf, lnum - 1, textprop_save, textprop_save_len, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div><div class="line"><a name="l03778"></a><span class="lineno"> 3778</span>&#160;    <span class="keywordflow">if</span> (lnum &lt;= buf-&gt;b_ml.ml_line_count)</div><div class="line"><a name="l03779"></a><span class="lineno"> 3779</span>&#160;        <a class="code" href="memline_8c.html#a1c4075db28b41512824b19edc9e4e6c9">adjust_text_props_for_delete</a>(buf, lnum, textprop_save, textprop_save_len, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l03780"></a><span class="lineno"> 3780</span>&#160;    }</div><div class="line"><a name="l03781"></a><span class="lineno"> 3781</span>&#160;    <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(textprop_save);</div><div class="line"><a name="l03782"></a><span class="lineno"> 3782</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l03783"></a><span class="lineno"> 3783</span>&#160;    <span class="keywordflow">return</span> ret;</div><div class="line"><a name="l03784"></a><span class="lineno"> 3784</span>&#160;}</div><div class="line"><a name="l03785"></a><span class="lineno"> 3785</span>&#160;</div><div class="line"><a name="l03786"></a><span class="lineno"> 3786</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l03787"></a><span class="lineno"> 3787</span>&#160;<span class="comment"> * set the DB_MARKED flag for line &#39;lnum&#39;</span></div><div class="line"><a name="l03788"></a><span class="lineno"> 3788</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l03789"></a><span class="lineno"> 3789</span>&#160;    <span class="keywordtype">void</span></div><div class="line"><a name="l03790"></a><span class="lineno"><a class="line" href="memline_8c.html#a02af71b1ca7aa25fc3eb3050d30ce453"> 3790</a></span>&#160;<a class="code" href="memline_8c.html#a02af71b1ca7aa25fc3eb3050d30ce453">ml_setmarked</a>(<a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a> lnum)</div><div class="line"><a name="l03791"></a><span class="lineno"> 3791</span>&#160;{</div><div class="line"><a name="l03792"></a><span class="lineno"> 3792</span>&#160;    <a class="code" href="structblock__hdr.html">bhdr_T</a>    *hp;</div><div class="line"><a name="l03793"></a><span class="lineno"> 3793</span>&#160;    <a class="code" href="structdata__block.html">DATA_BL</a> *dp;</div><div class="line"><a name="l03794"></a><span class="lineno"> 3794</span>&#160;                    <span class="comment">/* invalid line number */</span></div><div class="line"><a name="l03795"></a><span class="lineno"> 3795</span>&#160;    <span class="keywordflow">if</span> (lnum &lt; 1 || lnum &gt; curbuf-&gt;b_ml.ml_line_count</div><div class="line"><a name="l03796"></a><span class="lineno"> 3796</span>&#160;                           || curbuf-&gt;b_ml.ml_mfp == NULL)</div><div class="line"><a name="l03797"></a><span class="lineno"> 3797</span>&#160;    <span class="keywordflow">return</span>;             <span class="comment">/* give error message? */</span></div><div class="line"><a name="l03798"></a><span class="lineno"> 3798</span>&#160;</div><div class="line"><a name="l03799"></a><span class="lineno"> 3799</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="memline_8c.html#a8837c8c8a497ab410a9e925581f966c3">lowest_marked</a> == 0 || <a class="code" href="memline_8c.html#a8837c8c8a497ab410a9e925581f966c3">lowest_marked</a> &gt; lnum)</div><div class="line"><a name="l03800"></a><span class="lineno"> 3800</span>&#160;    <a class="code" href="memline_8c.html#a8837c8c8a497ab410a9e925581f966c3">lowest_marked</a> = lnum;</div><div class="line"><a name="l03801"></a><span class="lineno"> 3801</span>&#160;</div><div class="line"><a name="l03802"></a><span class="lineno"> 3802</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l03803"></a><span class="lineno"> 3803</span>&#160;<span class="comment">     * find the data block containing the line</span></div><div class="line"><a name="l03804"></a><span class="lineno"> 3804</span>&#160;<span class="comment">     * This also fills the stack with the blocks from the root to the data block</span></div><div class="line"><a name="l03805"></a><span class="lineno"> 3805</span>&#160;<span class="comment">     * This also releases any locked block.</span></div><div class="line"><a name="l03806"></a><span class="lineno"> 3806</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l03807"></a><span class="lineno"> 3807</span>&#160;    <span class="keywordflow">if</span> ((hp = <a class="code" href="memline_8c.html#ade8fe98188345bdd3c230545fc4a614f">ml_find_line</a>(curbuf, lnum, <a class="code" href="memline_8c.html#a1de07181f87bda4348b87eb71e0ab526">ML_FIND</a>)) == NULL)</div><div class="line"><a name="l03808"></a><span class="lineno"> 3808</span>&#160;    <span class="keywordflow">return</span>;         <span class="comment">/* give error message? */</span></div><div class="line"><a name="l03809"></a><span class="lineno"> 3809</span>&#160;</div><div class="line"><a name="l03810"></a><span class="lineno"> 3810</span>&#160;    dp = (<a class="code" href="structdata__block.html">DATA_BL</a> *)(hp-&gt;<a class="code" href="structblock__hdr.html#a7247cdc0977ab6fdc9cb6238cda67587">bh_data</a>);</div><div class="line"><a name="l03811"></a><span class="lineno"> 3811</span>&#160;    dp-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[lnum - curbuf-&gt;b_ml.ml_locked_low] |= <a class="code" href="memline_8c.html#ab994bfde1fec8c463065bbb9a402a35d">DB_MARKED</a>;</div><div class="line"><a name="l03812"></a><span class="lineno"> 3812</span>&#160;    curbuf-&gt;b_ml.ml_flags |= <a class="code" href="structs_8h.html#ad55a676a17d24163d3cdb2bf75a7fa66">ML_LOCKED_DIRTY</a>;</div><div class="line"><a name="l03813"></a><span class="lineno"> 3813</span>&#160;}</div><div class="line"><a name="l03814"></a><span class="lineno"> 3814</span>&#160;</div><div class="line"><a name="l03815"></a><span class="lineno"> 3815</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l03816"></a><span class="lineno"> 3816</span>&#160;<span class="comment"> * find the first line with its DB_MARKED flag set</span></div><div class="line"><a name="l03817"></a><span class="lineno"> 3817</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l03818"></a><span class="lineno"> 3818</span>&#160;    <a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a></div><div class="line"><a name="l03819"></a><span class="lineno"><a class="line" href="memline_8c.html#af7b21ec1ab530c05f8d8b95c576c9aaa"> 3819</a></span>&#160;<a class="code" href="memline_8c.html#af7b21ec1ab530c05f8d8b95c576c9aaa">ml_firstmarked</a>(<span class="keywordtype">void</span>)</div><div class="line"><a name="l03820"></a><span class="lineno"> 3820</span>&#160;{</div><div class="line"><a name="l03821"></a><span class="lineno"> 3821</span>&#160;    <a class="code" href="structblock__hdr.html">bhdr_T</a>  *hp;</div><div class="line"><a name="l03822"></a><span class="lineno"> 3822</span>&#160;    <a class="code" href="structdata__block.html">DATA_BL</a> *dp;</div><div class="line"><a name="l03823"></a><span class="lineno"> 3823</span>&#160;    <a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>    lnum;</div><div class="line"><a name="l03824"></a><span class="lineno"> 3824</span>&#160;    <span class="keywordtype">int</span>     i;</div><div class="line"><a name="l03825"></a><span class="lineno"> 3825</span>&#160;</div><div class="line"><a name="l03826"></a><span class="lineno"> 3826</span>&#160;    <span class="keywordflow">if</span> (curbuf-&gt;b_ml.ml_mfp == NULL)</div><div class="line"><a name="l03827"></a><span class="lineno"> 3827</span>&#160;    <span class="keywordflow">return</span> (<a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>) 0;</div><div class="line"><a name="l03828"></a><span class="lineno"> 3828</span>&#160;</div><div class="line"><a name="l03829"></a><span class="lineno"> 3829</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l03830"></a><span class="lineno"> 3830</span>&#160;<span class="comment">     * The search starts with lowest_marked line. This is the last line where</span></div><div class="line"><a name="l03831"></a><span class="lineno"> 3831</span>&#160;<span class="comment">     * a mark was found, adjusted by inserting/deleting lines.</span></div><div class="line"><a name="l03832"></a><span class="lineno"> 3832</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l03833"></a><span class="lineno"> 3833</span>&#160;    <span class="keywordflow">for</span> (lnum = <a class="code" href="memline_8c.html#a8837c8c8a497ab410a9e925581f966c3">lowest_marked</a>; lnum &lt;= curbuf-&gt;b_ml.ml_line_count; )</div><div class="line"><a name="l03834"></a><span class="lineno"> 3834</span>&#160;    {</div><div class="line"><a name="l03835"></a><span class="lineno"> 3835</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l03836"></a><span class="lineno"> 3836</span>&#160;<span class="comment">     * Find the data block containing the line.</span></div><div class="line"><a name="l03837"></a><span class="lineno"> 3837</span>&#160;<span class="comment">     * This also fills the stack with the blocks from the root to the data</span></div><div class="line"><a name="l03838"></a><span class="lineno"> 3838</span>&#160;<span class="comment">     * block This also releases any locked block.</span></div><div class="line"><a name="l03839"></a><span class="lineno"> 3839</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l03840"></a><span class="lineno"> 3840</span>&#160;    <span class="keywordflow">if</span> ((hp = <a class="code" href="memline_8c.html#ade8fe98188345bdd3c230545fc4a614f">ml_find_line</a>(curbuf, lnum, <a class="code" href="memline_8c.html#a1de07181f87bda4348b87eb71e0ab526">ML_FIND</a>)) == NULL)</div><div class="line"><a name="l03841"></a><span class="lineno"> 3841</span>&#160;        <span class="keywordflow">return</span> (<a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>)0;         <span class="comment">/* give error message? */</span></div><div class="line"><a name="l03842"></a><span class="lineno"> 3842</span>&#160;</div><div class="line"><a name="l03843"></a><span class="lineno"> 3843</span>&#160;    dp = (<a class="code" href="structdata__block.html">DATA_BL</a> *)(hp-&gt;<a class="code" href="structblock__hdr.html#a7247cdc0977ab6fdc9cb6238cda67587">bh_data</a>);</div><div class="line"><a name="l03844"></a><span class="lineno"> 3844</span>&#160;</div><div class="line"><a name="l03845"></a><span class="lineno"> 3845</span>&#160;    <span class="keywordflow">for</span> (i = lnum - curbuf-&gt;b_ml.ml_locked_low;</div><div class="line"><a name="l03846"></a><span class="lineno"> 3846</span>&#160;                lnum &lt;= curbuf-&gt;b_ml.ml_locked_high; ++i, ++lnum)</div><div class="line"><a name="l03847"></a><span class="lineno"> 3847</span>&#160;        <span class="keywordflow">if</span> ((dp-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[i]) &amp; <a class="code" href="memline_8c.html#ab994bfde1fec8c463065bbb9a402a35d">DB_MARKED</a>)</div><div class="line"><a name="l03848"></a><span class="lineno"> 3848</span>&#160;        {</div><div class="line"><a name="l03849"></a><span class="lineno"> 3849</span>&#160;        (dp-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[i]) &amp;= <a class="code" href="memline_8c.html#ab65775db0f7dbf161fce05ee7fb36573">DB_INDEX_MASK</a>;</div><div class="line"><a name="l03850"></a><span class="lineno"> 3850</span>&#160;        curbuf-&gt;b_ml.ml_flags |= <a class="code" href="structs_8h.html#ad55a676a17d24163d3cdb2bf75a7fa66">ML_LOCKED_DIRTY</a>;</div><div class="line"><a name="l03851"></a><span class="lineno"> 3851</span>&#160;        <a class="code" href="memline_8c.html#a8837c8c8a497ab410a9e925581f966c3">lowest_marked</a> = lnum + 1;</div><div class="line"><a name="l03852"></a><span class="lineno"> 3852</span>&#160;        <span class="keywordflow">return</span> lnum;</div><div class="line"><a name="l03853"></a><span class="lineno"> 3853</span>&#160;        }</div><div class="line"><a name="l03854"></a><span class="lineno"> 3854</span>&#160;    }</div><div class="line"><a name="l03855"></a><span class="lineno"> 3855</span>&#160;</div><div class="line"><a name="l03856"></a><span class="lineno"> 3856</span>&#160;    <span class="keywordflow">return</span> (<a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>) 0;</div><div class="line"><a name="l03857"></a><span class="lineno"> 3857</span>&#160;}</div><div class="line"><a name="l03858"></a><span class="lineno"> 3858</span>&#160;</div><div class="line"><a name="l03859"></a><span class="lineno"> 3859</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l03860"></a><span class="lineno"> 3860</span>&#160;<span class="comment"> * clear all DB_MARKED flags</span></div><div class="line"><a name="l03861"></a><span class="lineno"> 3861</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l03862"></a><span class="lineno"> 3862</span>&#160;    <span class="keywordtype">void</span></div><div class="line"><a name="l03863"></a><span class="lineno"><a class="line" href="memline_8c.html#a06f0b07737db79d2af91c2501ba32c6d"> 3863</a></span>&#160;<a class="code" href="memline_8c.html#a06f0b07737db79d2af91c2501ba32c6d">ml_clearmarked</a>(<span class="keywordtype">void</span>)</div><div class="line"><a name="l03864"></a><span class="lineno"> 3864</span>&#160;{</div><div class="line"><a name="l03865"></a><span class="lineno"> 3865</span>&#160;    <a class="code" href="structblock__hdr.html">bhdr_T</a>  *hp;</div><div class="line"><a name="l03866"></a><span class="lineno"> 3866</span>&#160;    <a class="code" href="structdata__block.html">DATA_BL</a> *dp;</div><div class="line"><a name="l03867"></a><span class="lineno"> 3867</span>&#160;    <a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>    lnum;</div><div class="line"><a name="l03868"></a><span class="lineno"> 3868</span>&#160;    <span class="keywordtype">int</span>     i;</div><div class="line"><a name="l03869"></a><span class="lineno"> 3869</span>&#160;</div><div class="line"><a name="l03870"></a><span class="lineno"> 3870</span>&#160;    <span class="keywordflow">if</span> (curbuf-&gt;b_ml.ml_mfp == NULL)        <span class="comment">/* nothing to do */</span></div><div class="line"><a name="l03871"></a><span class="lineno"> 3871</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l03872"></a><span class="lineno"> 3872</span>&#160;</div><div class="line"><a name="l03873"></a><span class="lineno"> 3873</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l03874"></a><span class="lineno"> 3874</span>&#160;<span class="comment">     * The search starts with line lowest_marked.</span></div><div class="line"><a name="l03875"></a><span class="lineno"> 3875</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l03876"></a><span class="lineno"> 3876</span>&#160;    <span class="keywordflow">for</span> (lnum = <a class="code" href="memline_8c.html#a8837c8c8a497ab410a9e925581f966c3">lowest_marked</a>; lnum &lt;= curbuf-&gt;b_ml.ml_line_count; )</div><div class="line"><a name="l03877"></a><span class="lineno"> 3877</span>&#160;    {</div><div class="line"><a name="l03878"></a><span class="lineno"> 3878</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l03879"></a><span class="lineno"> 3879</span>&#160;<span class="comment">     * Find the data block containing the line.</span></div><div class="line"><a name="l03880"></a><span class="lineno"> 3880</span>&#160;<span class="comment">     * This also fills the stack with the blocks from the root to the data</span></div><div class="line"><a name="l03881"></a><span class="lineno"> 3881</span>&#160;<span class="comment">     * block and releases any locked block.</span></div><div class="line"><a name="l03882"></a><span class="lineno"> 3882</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l03883"></a><span class="lineno"> 3883</span>&#160;    <span class="keywordflow">if</span> ((hp = <a class="code" href="memline_8c.html#ade8fe98188345bdd3c230545fc4a614f">ml_find_line</a>(curbuf, lnum, <a class="code" href="memline_8c.html#a1de07181f87bda4348b87eb71e0ab526">ML_FIND</a>)) == NULL)</div><div class="line"><a name="l03884"></a><span class="lineno"> 3884</span>&#160;        <span class="keywordflow">return</span>;     <span class="comment">/* give error message? */</span></div><div class="line"><a name="l03885"></a><span class="lineno"> 3885</span>&#160;</div><div class="line"><a name="l03886"></a><span class="lineno"> 3886</span>&#160;    dp = (<a class="code" href="structdata__block.html">DATA_BL</a> *)(hp-&gt;<a class="code" href="structblock__hdr.html#a7247cdc0977ab6fdc9cb6238cda67587">bh_data</a>);</div><div class="line"><a name="l03887"></a><span class="lineno"> 3887</span>&#160;</div><div class="line"><a name="l03888"></a><span class="lineno"> 3888</span>&#160;    <span class="keywordflow">for</span> (i = lnum - curbuf-&gt;b_ml.ml_locked_low;</div><div class="line"><a name="l03889"></a><span class="lineno"> 3889</span>&#160;                lnum &lt;= curbuf-&gt;b_ml.ml_locked_high; ++i, ++lnum)</div><div class="line"><a name="l03890"></a><span class="lineno"> 3890</span>&#160;        <span class="keywordflow">if</span> ((dp-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[i]) &amp; <a class="code" href="memline_8c.html#ab994bfde1fec8c463065bbb9a402a35d">DB_MARKED</a>)</div><div class="line"><a name="l03891"></a><span class="lineno"> 3891</span>&#160;        {</div><div class="line"><a name="l03892"></a><span class="lineno"> 3892</span>&#160;        (dp-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[i]) &amp;= <a class="code" href="memline_8c.html#ab65775db0f7dbf161fce05ee7fb36573">DB_INDEX_MASK</a>;</div><div class="line"><a name="l03893"></a><span class="lineno"> 3893</span>&#160;        curbuf-&gt;b_ml.ml_flags |= <a class="code" href="structs_8h.html#ad55a676a17d24163d3cdb2bf75a7fa66">ML_LOCKED_DIRTY</a>;</div><div class="line"><a name="l03894"></a><span class="lineno"> 3894</span>&#160;        }</div><div class="line"><a name="l03895"></a><span class="lineno"> 3895</span>&#160;    }</div><div class="line"><a name="l03896"></a><span class="lineno"> 3896</span>&#160;</div><div class="line"><a name="l03897"></a><span class="lineno"> 3897</span>&#160;    <a class="code" href="memline_8c.html#a8837c8c8a497ab410a9e925581f966c3">lowest_marked</a> = 0;</div><div class="line"><a name="l03898"></a><span class="lineno"> 3898</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l03899"></a><span class="lineno"> 3899</span>&#160;}</div><div class="line"><a name="l03900"></a><span class="lineno"> 3900</span>&#160;</div><div class="line"><a name="l03901"></a><span class="lineno"> 3901</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l03902"></a><span class="lineno"> 3902</span>&#160;<span class="comment"> * flush ml_line if necessary</span></div><div class="line"><a name="l03903"></a><span class="lineno"> 3903</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l03904"></a><span class="lineno"> 3904</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">void</span></div><div class="line"><a name="l03905"></a><span class="lineno"><a class="line" href="memline_8c.html#a20a3268681f79a76b9af2f2fc7b644b6"> 3905</a></span>&#160;<a class="code" href="memline_8c.html#a20a3268681f79a76b9af2f2fc7b644b6">ml_flush_line</a>(<a class="code" href="structfile__buffer.html">buf_T</a> *buf)</div><div class="line"><a name="l03906"></a><span class="lineno"> 3906</span>&#160;{</div><div class="line"><a name="l03907"></a><span class="lineno"> 3907</span>&#160;    <a class="code" href="structblock__hdr.html">bhdr_T</a>  *hp;</div><div class="line"><a name="l03908"></a><span class="lineno"> 3908</span>&#160;    <a class="code" href="structdata__block.html">DATA_BL</a> *dp;</div><div class="line"><a name="l03909"></a><span class="lineno"> 3909</span>&#160;    <a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>    lnum;</div><div class="line"><a name="l03910"></a><span class="lineno"> 3910</span>&#160;    char_u  *new_line;</div><div class="line"><a name="l03911"></a><span class="lineno"> 3911</span>&#160;    char_u  *old_line;</div><div class="line"><a name="l03912"></a><span class="lineno"> 3912</span>&#160;    <a class="code" href="vim_8h.html#ae79e04a416bd6ce8ffe80e241850c0d2">colnr_T</a> new_len;</div><div class="line"><a name="l03913"></a><span class="lineno"> 3913</span>&#160;    <span class="keywordtype">int</span>     old_len;</div><div class="line"><a name="l03914"></a><span class="lineno"> 3914</span>&#160;    <span class="keywordtype">int</span>     extra;</div><div class="line"><a name="l03915"></a><span class="lineno"> 3915</span>&#160;    <span class="keywordtype">int</span>     idx;</div><div class="line"><a name="l03916"></a><span class="lineno"> 3916</span>&#160;    <span class="keywordtype">int</span>     start;</div><div class="line"><a name="l03917"></a><span class="lineno"> 3917</span>&#160;    <span class="keywordtype">int</span>     count;</div><div class="line"><a name="l03918"></a><span class="lineno"> 3918</span>&#160;    <span class="keywordtype">int</span>     i;</div><div class="line"><a name="l03919"></a><span class="lineno"> 3919</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">int</span>  entered = <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line"><a name="l03920"></a><span class="lineno"> 3920</span>&#160;</div><div class="line"><a name="l03921"></a><span class="lineno"> 3921</span>&#160;    <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a62222eb79ef59eddaff71f0f8cdff764">ml_line_lnum</a> == 0 || buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a9adb5a08b3c01be69c98360a14937227">ml_mfp</a> == NULL)</div><div class="line"><a name="l03922"></a><span class="lineno"> 3922</span>&#160;    <span class="keywordflow">return</span>;     <span class="comment">/* nothing to do */</span></div><div class="line"><a name="l03923"></a><span class="lineno"> 3923</span>&#160;</div><div class="line"><a name="l03924"></a><span class="lineno"> 3924</span>&#160;    <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a30f30ddb7264f667a92556f0568981e0">ml_flags</a> &amp; <a class="code" href="structs_8h.html#a8fac7ceea6e156c2915cdcf7e228a9f8">ML_LINE_DIRTY</a>)</div><div class="line"><a name="l03925"></a><span class="lineno"> 3925</span>&#160;    {</div><div class="line"><a name="l03926"></a><span class="lineno"> 3926</span>&#160;    <span class="comment">/* This code doesn&#39;t work recursively, but Netbeans may call back here</span></div><div class="line"><a name="l03927"></a><span class="lineno"> 3927</span>&#160;<span class="comment">     * when obtaining the cursor position. */</span></div><div class="line"><a name="l03928"></a><span class="lineno"> 3928</span>&#160;    <span class="keywordflow">if</span> (entered)</div><div class="line"><a name="l03929"></a><span class="lineno"> 3929</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l03930"></a><span class="lineno"> 3930</span>&#160;    entered = <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"><a name="l03931"></a><span class="lineno"> 3931</span>&#160;</div><div class="line"><a name="l03932"></a><span class="lineno"> 3932</span>&#160;    lnum = buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a62222eb79ef59eddaff71f0f8cdff764">ml_line_lnum</a>;</div><div class="line"><a name="l03933"></a><span class="lineno"> 3933</span>&#160;    new_line = buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#aada7438521544eec6c73e223b2811a69">ml_line_ptr</a>;</div><div class="line"><a name="l03934"></a><span class="lineno"> 3934</span>&#160;</div><div class="line"><a name="l03935"></a><span class="lineno"> 3935</span>&#160;    hp = <a class="code" href="memline_8c.html#ade8fe98188345bdd3c230545fc4a614f">ml_find_line</a>(buf, lnum, <a class="code" href="memline_8c.html#a1de07181f87bda4348b87eb71e0ab526">ML_FIND</a>);</div><div class="line"><a name="l03936"></a><span class="lineno"> 3936</span>&#160;    <span class="keywordflow">if</span> (hp == NULL)</div><div class="line"><a name="l03937"></a><span class="lineno"> 3937</span>&#160;        <a class="code" href="message_8c.html#a35f801e23d16b0e6a4d1cc61691ec03f">siemsg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;E320: Cannot find line %ld&quot;</span>), lnum);</div><div class="line"><a name="l03938"></a><span class="lineno"> 3938</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l03939"></a><span class="lineno"> 3939</span>&#160;    {</div><div class="line"><a name="l03940"></a><span class="lineno"> 3940</span>&#160;        dp = (<a class="code" href="structdata__block.html">DATA_BL</a> *)(hp-&gt;<a class="code" href="structblock__hdr.html#a7247cdc0977ab6fdc9cb6238cda67587">bh_data</a>);</div><div class="line"><a name="l03941"></a><span class="lineno"> 3941</span>&#160;        idx = lnum - buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a2b7c6e30401df9d0e8972cb639d1b895">ml_locked_low</a>;</div><div class="line"><a name="l03942"></a><span class="lineno"> 3942</span>&#160;        start = ((dp-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[idx]) &amp; <a class="code" href="memline_8c.html#ab65775db0f7dbf161fce05ee7fb36573">DB_INDEX_MASK</a>);</div><div class="line"><a name="l03943"></a><span class="lineno"> 3943</span>&#160;        old_line = (char_u *)dp + start;</div><div class="line"><a name="l03944"></a><span class="lineno"> 3944</span>&#160;        <span class="keywordflow">if</span> (idx == 0)   <span class="comment">/* line is last in block */</span></div><div class="line"><a name="l03945"></a><span class="lineno"> 3945</span>&#160;        old_len = dp-&gt;<a class="code" href="structdata__block.html#ae079e3993bfc47bd86fd6e2fc3ab44ba">db_txt_end</a> - start;</div><div class="line"><a name="l03946"></a><span class="lineno"> 3946</span>&#160;        <span class="keywordflow">else</span>        <span class="comment">/* text of previous line follows */</span></div><div class="line"><a name="l03947"></a><span class="lineno"> 3947</span>&#160;        old_len = (dp-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[idx - 1] &amp; <a class="code" href="memline_8c.html#ab65775db0f7dbf161fce05ee7fb36573">DB_INDEX_MASK</a>) - start;</div><div class="line"><a name="l03948"></a><span class="lineno"> 3948</span>&#160;        new_len = buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#ae775dd7dfa8b3dcaa01a9b3fa030371a">ml_line_len</a>;</div><div class="line"><a name="l03949"></a><span class="lineno"> 3949</span>&#160;        extra = new_len - old_len;      <span class="comment">/* negative if lines gets smaller */</span></div><div class="line"><a name="l03950"></a><span class="lineno"> 3950</span>&#160;</div><div class="line"><a name="l03951"></a><span class="lineno"> 3951</span>&#160;        <span class="comment">/*</span></div><div class="line"><a name="l03952"></a><span class="lineno"> 3952</span>&#160;<span class="comment">         * if new line fits in data block, replace directly</span></div><div class="line"><a name="l03953"></a><span class="lineno"> 3953</span>&#160;<span class="comment">         */</span></div><div class="line"><a name="l03954"></a><span class="lineno"> 3954</span>&#160;        <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)dp-&gt;<a class="code" href="structdata__block.html#a6cd7e5186f74ae199fe547bc905b2815">db_free</a> &gt;= extra)</div><div class="line"><a name="l03955"></a><span class="lineno"> 3955</span>&#160;        {</div><div class="line"><a name="l03956"></a><span class="lineno"> 3956</span>&#160;        <span class="comment">/* if the length changes and there are following lines */</span></div><div class="line"><a name="l03957"></a><span class="lineno"> 3957</span>&#160;        count = buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a81788089e53748eb945a88d6e41647da">ml_locked_high</a> - buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a2b7c6e30401df9d0e8972cb639d1b895">ml_locked_low</a> + 1;</div><div class="line"><a name="l03958"></a><span class="lineno"> 3958</span>&#160;        <span class="keywordflow">if</span> (extra != 0 &amp;&amp; idx &lt; count - 1)</div><div class="line"><a name="l03959"></a><span class="lineno"> 3959</span>&#160;        {</div><div class="line"><a name="l03960"></a><span class="lineno"> 3960</span>&#160;            <span class="comment">/* move text of following lines */</span></div><div class="line"><a name="l03961"></a><span class="lineno"> 3961</span>&#160;            <a class="code" href="os__unix_8h.html#ae70108db942e4f3eeb701ad8787b1835">mch_memmove</a>((<span class="keywordtype">char</span> *)dp + dp-&gt;<a class="code" href="structdata__block.html#a3937f5841b2fed9a042872981b06a7b8">db_txt_start</a> - extra,</div><div class="line"><a name="l03962"></a><span class="lineno"> 3962</span>&#160;                (<span class="keywordtype">char</span> *)dp + dp-&gt;<a class="code" href="structdata__block.html#a3937f5841b2fed9a042872981b06a7b8">db_txt_start</a>,</div><div class="line"><a name="l03963"></a><span class="lineno"> 3963</span>&#160;                (<span class="keywordtype">size_t</span>)(start - dp-&gt;<a class="code" href="structdata__block.html#a3937f5841b2fed9a042872981b06a7b8">db_txt_start</a>));</div><div class="line"><a name="l03964"></a><span class="lineno"> 3964</span>&#160;</div><div class="line"><a name="l03965"></a><span class="lineno"> 3965</span>&#160;            <span class="comment">/* adjust pointers of this and following lines */</span></div><div class="line"><a name="l03966"></a><span class="lineno"> 3966</span>&#160;            <span class="keywordflow">for</span> (i = idx + 1; i &lt; count; ++i)</div><div class="line"><a name="l03967"></a><span class="lineno"> 3967</span>&#160;            dp-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[i] -= extra;</div><div class="line"><a name="l03968"></a><span class="lineno"> 3968</span>&#160;        }</div><div class="line"><a name="l03969"></a><span class="lineno"> 3969</span>&#160;        dp-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[idx] -= extra;</div><div class="line"><a name="l03970"></a><span class="lineno"> 3970</span>&#160;</div><div class="line"><a name="l03971"></a><span class="lineno"> 3971</span>&#160;        <span class="comment">/* adjust free space */</span></div><div class="line"><a name="l03972"></a><span class="lineno"> 3972</span>&#160;        dp-&gt;<a class="code" href="structdata__block.html#a6cd7e5186f74ae199fe547bc905b2815">db_free</a> -= extra;</div><div class="line"><a name="l03973"></a><span class="lineno"> 3973</span>&#160;        dp-&gt;<a class="code" href="structdata__block.html#a3937f5841b2fed9a042872981b06a7b8">db_txt_start</a> -= extra;</div><div class="line"><a name="l03974"></a><span class="lineno"> 3974</span>&#160;</div><div class="line"><a name="l03975"></a><span class="lineno"> 3975</span>&#160;        <span class="comment">/* copy new line into the data block */</span></div><div class="line"><a name="l03976"></a><span class="lineno"> 3976</span>&#160;        <a class="code" href="os__unix_8h.html#ae70108db942e4f3eeb701ad8787b1835">mch_memmove</a>(old_line - extra, new_line, (<span class="keywordtype">size_t</span>)new_len);</div><div class="line"><a name="l03977"></a><span class="lineno"> 3977</span>&#160;        buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a30f30ddb7264f667a92556f0568981e0">ml_flags</a> |= (<a class="code" href="structs_8h.html#ad55a676a17d24163d3cdb2bf75a7fa66">ML_LOCKED_DIRTY</a> | <a class="code" href="structs_8h.html#a094e033c133f0276ed3c00f8053d0175">ML_LOCKED_POS</a>);</div><div class="line"><a name="l03978"></a><span class="lineno"> 3978</span>&#160;<span class="preprocessor">#ifdef FEAT_BYTEOFF</span></div><div class="line"><a name="l03979"></a><span class="lineno"> 3979</span>&#160;        <span class="comment">/* The else case is already covered by the insert and delete */</span></div><div class="line"><a name="l03980"></a><span class="lineno"> 3980</span>&#160;        <a class="code" href="memline_8c.html#ae8486bd6f1922d43b60969e2be927915">ml_updatechunk</a>(buf, lnum, (<span class="keywordtype">long</span>)extra, ML_CHNK_UPDLINE);</div><div class="line"><a name="l03981"></a><span class="lineno"> 3981</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l03982"></a><span class="lineno"> 3982</span>&#160;        }</div><div class="line"><a name="l03983"></a><span class="lineno"> 3983</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l03984"></a><span class="lineno"> 3984</span>&#160;        {</div><div class="line"><a name="l03985"></a><span class="lineno"> 3985</span>&#160;        <span class="comment">/*</span></div><div class="line"><a name="l03986"></a><span class="lineno"> 3986</span>&#160;<span class="comment">         * Cannot do it in one data block: Delete and append.</span></div><div class="line"><a name="l03987"></a><span class="lineno"> 3987</span>&#160;<span class="comment">         * Append first, because ml_delete_int() cannot delete the</span></div><div class="line"><a name="l03988"></a><span class="lineno"> 3988</span>&#160;<span class="comment">         * last line in a buffer, which causes trouble for a buffer</span></div><div class="line"><a name="l03989"></a><span class="lineno"> 3989</span>&#160;<span class="comment">         * that has only one line.</span></div><div class="line"><a name="l03990"></a><span class="lineno"> 3990</span>&#160;<span class="comment">         * Don&#39;t forget to copy the mark!</span></div><div class="line"><a name="l03991"></a><span class="lineno"> 3991</span>&#160;<span class="comment">         */</span></div><div class="line"><a name="l03992"></a><span class="lineno"> 3992</span>&#160;        <span class="comment">/* How about handling errors??? */</span></div><div class="line"><a name="l03993"></a><span class="lineno"> 3993</span>&#160;        (void)<a class="code" href="memline_8c.html#abed76281f9b8f3fe0572784ba8aaa040">ml_append_int</a>(buf, lnum, new_line, new_len, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,</div><div class="line"><a name="l03994"></a><span class="lineno"> 3994</span>&#160;                         (dp-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[idx] &amp; <a class="code" href="memline_8c.html#ab994bfde1fec8c463065bbb9a402a35d">DB_MARKED</a>));</div><div class="line"><a name="l03995"></a><span class="lineno"> 3995</span>&#160;        (void)<a class="code" href="memline_8c.html#a5e7aeced6dc3b0cf2af0f92ff3b3a875">ml_delete_int</a>(buf, lnum, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l03996"></a><span class="lineno"> 3996</span>&#160;        }</div><div class="line"><a name="l03997"></a><span class="lineno"> 3997</span>&#160;    }</div><div class="line"><a name="l03998"></a><span class="lineno"> 3998</span>&#160;    <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(new_line);</div><div class="line"><a name="l03999"></a><span class="lineno"> 3999</span>&#160;</div><div class="line"><a name="l04000"></a><span class="lineno"> 4000</span>&#160;    entered = <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line"><a name="l04001"></a><span class="lineno"> 4001</span>&#160;    }</div><div class="line"><a name="l04002"></a><span class="lineno"> 4002</span>&#160;</div><div class="line"><a name="l04003"></a><span class="lineno"> 4003</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a62222eb79ef59eddaff71f0f8cdff764">ml_line_lnum</a> = 0;</div><div class="line"><a name="l04004"></a><span class="lineno"> 4004</span>&#160;}</div><div class="line"><a name="l04005"></a><span class="lineno"> 4005</span>&#160;</div><div class="line"><a name="l04006"></a><span class="lineno"> 4006</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l04007"></a><span class="lineno"> 4007</span>&#160;<span class="comment"> * create a new, empty, data block</span></div><div class="line"><a name="l04008"></a><span class="lineno"> 4008</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l04009"></a><span class="lineno"> 4009</span>&#160;    <span class="keyword">static</span> <a class="code" href="structblock__hdr.html">bhdr_T</a> *</div><div class="line"><a name="l04010"></a><span class="lineno"><a class="line" href="memline_8c.html#a143a4d348c1d7c3e5ccc591f6653a984"> 4010</a></span>&#160;<a class="code" href="memline_8c.html#a143a4d348c1d7c3e5ccc591f6653a984">ml_new_data</a>(<a class="code" href="structmemfile.html">memfile_T</a> *mfp, <span class="keywordtype">int</span> negative, <span class="keywordtype">int</span> <a class="code" href="hardcopy_8c.html#a8779304c095e1ed27c30d4b5b3f2437a">page_count</a>)</div><div class="line"><a name="l04011"></a><span class="lineno"> 4011</span>&#160;{</div><div class="line"><a name="l04012"></a><span class="lineno"> 4012</span>&#160;    <a class="code" href="structblock__hdr.html">bhdr_T</a>  *hp;</div><div class="line"><a name="l04013"></a><span class="lineno"> 4013</span>&#160;    <a class="code" href="structdata__block.html">DATA_BL</a> *dp;</div><div class="line"><a name="l04014"></a><span class="lineno"> 4014</span>&#160;</div><div class="line"><a name="l04015"></a><span class="lineno"> 4015</span>&#160;    <span class="keywordflow">if</span> ((hp = <a class="code" href="memfile_8c.html#aef96feb7c9e3f3ba1f4901933dcc7424">mf_new</a>(mfp, negative, page_count)) == NULL)</div><div class="line"><a name="l04016"></a><span class="lineno"> 4016</span>&#160;    <span class="keywordflow">return</span> NULL;</div><div class="line"><a name="l04017"></a><span class="lineno"> 4017</span>&#160;</div><div class="line"><a name="l04018"></a><span class="lineno"> 4018</span>&#160;    dp = (<a class="code" href="structdata__block.html">DATA_BL</a> *)(hp-&gt;<a class="code" href="structblock__hdr.html#a7247cdc0977ab6fdc9cb6238cda67587">bh_data</a>);</div><div class="line"><a name="l04019"></a><span class="lineno"> 4019</span>&#160;    dp-&gt;<a class="code" href="structdata__block.html#ac977617f5f8153eda5d902a73e0379e1">db_id</a> = <a class="code" href="memline_8c.html#a55aa586df150c1192826a1c57dd87401">DATA_ID</a>;</div><div class="line"><a name="l04020"></a><span class="lineno"> 4020</span>&#160;    dp-&gt;<a class="code" href="structdata__block.html#a3937f5841b2fed9a042872981b06a7b8">db_txt_start</a> = dp-&gt;<a class="code" href="structdata__block.html#ae079e3993bfc47bd86fd6e2fc3ab44ba">db_txt_end</a> = page_count * mfp-&gt;<a class="code" href="structmemfile.html#ab0c66141886a009d8132b8e1e2a00fc6">mf_page_size</a>;</div><div class="line"><a name="l04021"></a><span class="lineno"> 4021</span>&#160;    dp-&gt;<a class="code" href="structdata__block.html#a6cd7e5186f74ae199fe547bc905b2815">db_free</a> = dp-&gt;<a class="code" href="structdata__block.html#a3937f5841b2fed9a042872981b06a7b8">db_txt_start</a> - <a class="code" href="memline_8c.html#a49999be01380f41cc0d0f1f1406fb277">HEADER_SIZE</a>;</div><div class="line"><a name="l04022"></a><span class="lineno"> 4022</span>&#160;    dp-&gt;<a class="code" href="structdata__block.html#a00084a39a3bdd9a03b9a055216aec5c5">db_line_count</a> = 0;</div><div class="line"><a name="l04023"></a><span class="lineno"> 4023</span>&#160;</div><div class="line"><a name="l04024"></a><span class="lineno"> 4024</span>&#160;    <span class="keywordflow">return</span> hp;</div><div class="line"><a name="l04025"></a><span class="lineno"> 4025</span>&#160;}</div><div class="line"><a name="l04026"></a><span class="lineno"> 4026</span>&#160;</div><div class="line"><a name="l04027"></a><span class="lineno"> 4027</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l04028"></a><span class="lineno"> 4028</span>&#160;<span class="comment"> * create a new, empty, pointer block</span></div><div class="line"><a name="l04029"></a><span class="lineno"> 4029</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l04030"></a><span class="lineno"> 4030</span>&#160;    <span class="keyword">static</span> <a class="code" href="structblock__hdr.html">bhdr_T</a> *</div><div class="line"><a name="l04031"></a><span class="lineno"><a class="line" href="memline_8c.html#abdecfc521a3e8fe9fde7d0a7f0baa4fc"> 4031</a></span>&#160;<a class="code" href="memline_8c.html#abdecfc521a3e8fe9fde7d0a7f0baa4fc">ml_new_ptr</a>(<a class="code" href="structmemfile.html">memfile_T</a> *mfp)</div><div class="line"><a name="l04032"></a><span class="lineno"> 4032</span>&#160;{</div><div class="line"><a name="l04033"></a><span class="lineno"> 4033</span>&#160;    <a class="code" href="structblock__hdr.html">bhdr_T</a>  *hp;</div><div class="line"><a name="l04034"></a><span class="lineno"> 4034</span>&#160;    <a class="code" href="structpointer__block.html">PTR_BL</a>  *pp;</div><div class="line"><a name="l04035"></a><span class="lineno"> 4035</span>&#160;</div><div class="line"><a name="l04036"></a><span class="lineno"> 4036</span>&#160;    <span class="keywordflow">if</span> ((hp = <a class="code" href="memfile_8c.html#aef96feb7c9e3f3ba1f4901933dcc7424">mf_new</a>(mfp, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, 1)) == NULL)</div><div class="line"><a name="l04037"></a><span class="lineno"> 4037</span>&#160;    <span class="keywordflow">return</span> NULL;</div><div class="line"><a name="l04038"></a><span class="lineno"> 4038</span>&#160;</div><div class="line"><a name="l04039"></a><span class="lineno"> 4039</span>&#160;    pp = (<a class="code" href="structpointer__block.html">PTR_BL</a> *)(hp-&gt;<a class="code" href="structblock__hdr.html#a7247cdc0977ab6fdc9cb6238cda67587">bh_data</a>);</div><div class="line"><a name="l04040"></a><span class="lineno"> 4040</span>&#160;    pp-&gt;<a class="code" href="structpointer__block.html#ac2698ad2c9c4096299106a53ffbd667f">pb_id</a> = <a class="code" href="memline_8c.html#a23d0125357ec4465a50f841f634c9214">PTR_ID</a>;</div><div class="line"><a name="l04041"></a><span class="lineno"> 4041</span>&#160;    pp-&gt;<a class="code" href="structpointer__block.html#ad3682038298e7850fb980815132f17f9">pb_count</a> = 0;</div><div class="line"><a name="l04042"></a><span class="lineno"> 4042</span>&#160;    pp-&gt;<a class="code" href="structpointer__block.html#ad9d615e7c53c2892e6d04a0d257df592">pb_count_max</a> = (<a class="code" href="vim_8h.html#af188d12f92536bcde1def3ec5c00e020">short_u</a>)((mfp-&gt;<a class="code" href="structmemfile.html#ab0c66141886a009d8132b8e1e2a00fc6">mf_page_size</a> - <span class="keyword">sizeof</span>(<a class="code" href="structpointer__block.html">PTR_BL</a>))</div><div class="line"><a name="l04043"></a><span class="lineno"> 4043</span>&#160;                            / <span class="keyword">sizeof</span>(<a class="code" href="structpointer__entry.html">PTR_EN</a>) + 1);</div><div class="line"><a name="l04044"></a><span class="lineno"> 4044</span>&#160;</div><div class="line"><a name="l04045"></a><span class="lineno"> 4045</span>&#160;    <span class="keywordflow">return</span> hp;</div><div class="line"><a name="l04046"></a><span class="lineno"> 4046</span>&#160;}</div><div class="line"><a name="l04047"></a><span class="lineno"> 4047</span>&#160;</div><div class="line"><a name="l04048"></a><span class="lineno"> 4048</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l04049"></a><span class="lineno"> 4049</span>&#160;<span class="comment"> * Lookup line &#39;lnum&#39; in a memline.</span></div><div class="line"><a name="l04050"></a><span class="lineno"> 4050</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l04051"></a><span class="lineno"> 4051</span>&#160;<span class="comment"> *   action: if ML_DELETE or ML_INSERT the line count is updated while searching</span></div><div class="line"><a name="l04052"></a><span class="lineno"> 4052</span>&#160;<span class="comment"> *       if ML_FLUSH only flush a locked block</span></div><div class="line"><a name="l04053"></a><span class="lineno"> 4053</span>&#160;<span class="comment"> *       if ML_FIND just find the line</span></div><div class="line"><a name="l04054"></a><span class="lineno"> 4054</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l04055"></a><span class="lineno"> 4055</span>&#160;<span class="comment"> * If the block was found it is locked and put in ml_locked.</span></div><div class="line"><a name="l04056"></a><span class="lineno"> 4056</span>&#160;<span class="comment"> * The stack is updated to lead to the locked block. The ip_high field in</span></div><div class="line"><a name="l04057"></a><span class="lineno"> 4057</span>&#160;<span class="comment"> * the stack is updated to reflect the last line in the block AFTER the</span></div><div class="line"><a name="l04058"></a><span class="lineno"> 4058</span>&#160;<span class="comment"> * insert or delete, also if the pointer block has not been updated yet. But</span></div><div class="line"><a name="l04059"></a><span class="lineno"> 4059</span>&#160;<span class="comment"> * if ml_locked != NULL ml_locked_lineadd must be added to ip_high.</span></div><div class="line"><a name="l04060"></a><span class="lineno"> 4060</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l04061"></a><span class="lineno"> 4061</span>&#160;<span class="comment"> * return: NULL for failure, pointer to block header otherwise</span></div><div class="line"><a name="l04062"></a><span class="lineno"> 4062</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l04063"></a><span class="lineno"> 4063</span>&#160;    <span class="keyword">static</span> <a class="code" href="structblock__hdr.html">bhdr_T</a> *</div><div class="line"><a name="l04064"></a><span class="lineno"><a class="line" href="memline_8c.html#ade8fe98188345bdd3c230545fc4a614f"> 4064</a></span>&#160;<a class="code" href="memline_8c.html#ade8fe98188345bdd3c230545fc4a614f">ml_find_line</a>(<a class="code" href="structfile__buffer.html">buf_T</a> *buf, <a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a> lnum, <span class="keywordtype">int</span> action)</div><div class="line"><a name="l04065"></a><span class="lineno"> 4065</span>&#160;{</div><div class="line"><a name="l04066"></a><span class="lineno"> 4066</span>&#160;    <a class="code" href="structdata__block.html">DATA_BL</a> *dp;</div><div class="line"><a name="l04067"></a><span class="lineno"> 4067</span>&#160;    <a class="code" href="structpointer__block.html">PTR_BL</a>  *pp;</div><div class="line"><a name="l04068"></a><span class="lineno"> 4068</span>&#160;    <a class="code" href="structinfo__pointer.html">infoptr_T</a>   *<a class="code" href="namespacetest__channel.html#a6a2152bf75d93cd14fcffc99c3e76807">ip</a>;</div><div class="line"><a name="l04069"></a><span class="lineno"> 4069</span>&#160;    <a class="code" href="structblock__hdr.html">bhdr_T</a>  *hp;</div><div class="line"><a name="l04070"></a><span class="lineno"> 4070</span>&#160;    <a class="code" href="structmemfile.html">memfile_T</a>   *mfp;</div><div class="line"><a name="l04071"></a><span class="lineno"> 4071</span>&#160;    <a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>    t;</div><div class="line"><a name="l04072"></a><span class="lineno"> 4072</span>&#160;    <a class="code" href="structs_8h.html#a012394c4a7db63f99f6f0cdacab79527">blocknr_T</a>   bnum, bnum2;</div><div class="line"><a name="l04073"></a><span class="lineno"> 4073</span>&#160;    <span class="keywordtype">int</span>     dirty;</div><div class="line"><a name="l04074"></a><span class="lineno"> 4074</span>&#160;    <a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>    low, high;</div><div class="line"><a name="l04075"></a><span class="lineno"> 4075</span>&#160;    <span class="keywordtype">int</span>     top;</div><div class="line"><a name="l04076"></a><span class="lineno"> 4076</span>&#160;    <span class="keywordtype">int</span>     <a class="code" href="hardcopy_8c.html#a8779304c095e1ed27c30d4b5b3f2437a">page_count</a>;</div><div class="line"><a name="l04077"></a><span class="lineno"> 4077</span>&#160;    <span class="keywordtype">int</span>     idx;</div><div class="line"><a name="l04078"></a><span class="lineno"> 4078</span>&#160;</div><div class="line"><a name="l04079"></a><span class="lineno"> 4079</span>&#160;    mfp = buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a9adb5a08b3c01be69c98360a14937227">ml_mfp</a>;</div><div class="line"><a name="l04080"></a><span class="lineno"> 4080</span>&#160;</div><div class="line"><a name="l04081"></a><span class="lineno"> 4081</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l04082"></a><span class="lineno"> 4082</span>&#160;<span class="comment">     * If there is a locked block check if the wanted line is in it.</span></div><div class="line"><a name="l04083"></a><span class="lineno"> 4083</span>&#160;<span class="comment">     * If not, flush and release the locked block.</span></div><div class="line"><a name="l04084"></a><span class="lineno"> 4084</span>&#160;<span class="comment">     * Don&#39;t do this for ML_INSERT_SAME, because the stack need to be updated.</span></div><div class="line"><a name="l04085"></a><span class="lineno"> 4085</span>&#160;<span class="comment">     * Don&#39;t do this for ML_FLUSH, because we want to flush the locked block.</span></div><div class="line"><a name="l04086"></a><span class="lineno"> 4086</span>&#160;<span class="comment">     * Don&#39;t do this when &#39;swapfile&#39; is reset, we want to load all the blocks.</span></div><div class="line"><a name="l04087"></a><span class="lineno"> 4087</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l04088"></a><span class="lineno"> 4088</span>&#160;    <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#aa4c2830f305306d4f5f163b4522d0ba6">ml_locked</a>)</div><div class="line"><a name="l04089"></a><span class="lineno"> 4089</span>&#160;    {</div><div class="line"><a name="l04090"></a><span class="lineno"> 4090</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="memline_8c.html#aa48861b8abab2c6a9d9c002781df1cfd">ML_SIMPLE</a>(action)</div><div class="line"><a name="l04091"></a><span class="lineno"> 4091</span>&#160;        &amp;&amp; buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a2b7c6e30401df9d0e8972cb639d1b895">ml_locked_low</a> &lt;= lnum</div><div class="line"><a name="l04092"></a><span class="lineno"> 4092</span>&#160;        &amp;&amp; buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a81788089e53748eb945a88d6e41647da">ml_locked_high</a> &gt;= lnum</div><div class="line"><a name="l04093"></a><span class="lineno"> 4093</span>&#160;        &amp;&amp; !mf_dont_release)</div><div class="line"><a name="l04094"></a><span class="lineno"> 4094</span>&#160;    {</div><div class="line"><a name="l04095"></a><span class="lineno"> 4095</span>&#160;        <span class="comment">/* remember to update pointer blocks and stack later */</span></div><div class="line"><a name="l04096"></a><span class="lineno"> 4096</span>&#160;        <span class="keywordflow">if</span> (action == <a class="code" href="memline_8c.html#a1fc0269a34abf68fee5e99b51879fa4b">ML_INSERT</a>)</div><div class="line"><a name="l04097"></a><span class="lineno"> 4097</span>&#160;        {</div><div class="line"><a name="l04098"></a><span class="lineno"> 4098</span>&#160;        ++(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a97f953057f1eaa0360502866f1e54964">ml_locked_lineadd</a>);</div><div class="line"><a name="l04099"></a><span class="lineno"> 4099</span>&#160;        ++(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a81788089e53748eb945a88d6e41647da">ml_locked_high</a>);</div><div class="line"><a name="l04100"></a><span class="lineno"> 4100</span>&#160;        }</div><div class="line"><a name="l04101"></a><span class="lineno"> 4101</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (action == <a class="code" href="memline_8c.html#ae92d6ba5b936547467fd45f1b6534778">ML_DELETE</a>)</div><div class="line"><a name="l04102"></a><span class="lineno"> 4102</span>&#160;        {</div><div class="line"><a name="l04103"></a><span class="lineno"> 4103</span>&#160;        --(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a97f953057f1eaa0360502866f1e54964">ml_locked_lineadd</a>);</div><div class="line"><a name="l04104"></a><span class="lineno"> 4104</span>&#160;        --(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a81788089e53748eb945a88d6e41647da">ml_locked_high</a>);</div><div class="line"><a name="l04105"></a><span class="lineno"> 4105</span>&#160;        }</div><div class="line"><a name="l04106"></a><span class="lineno"> 4106</span>&#160;        <span class="keywordflow">return</span> (buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#aa4c2830f305306d4f5f163b4522d0ba6">ml_locked</a>);</div><div class="line"><a name="l04107"></a><span class="lineno"> 4107</span>&#160;    }</div><div class="line"><a name="l04108"></a><span class="lineno"> 4108</span>&#160;</div><div class="line"><a name="l04109"></a><span class="lineno"> 4109</span>&#160;    <a class="code" href="memfile_8c.html#abb7f268382703d32becc96f6d92fb855">mf_put</a>(mfp, buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#aa4c2830f305306d4f5f163b4522d0ba6">ml_locked</a>, buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a30f30ddb7264f667a92556f0568981e0">ml_flags</a> &amp; <a class="code" href="structs_8h.html#ad55a676a17d24163d3cdb2bf75a7fa66">ML_LOCKED_DIRTY</a>,</div><div class="line"><a name="l04110"></a><span class="lineno"> 4110</span>&#160;                        buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a30f30ddb7264f667a92556f0568981e0">ml_flags</a> &amp; <a class="code" href="structs_8h.html#a094e033c133f0276ed3c00f8053d0175">ML_LOCKED_POS</a>);</div><div class="line"><a name="l04111"></a><span class="lineno"> 4111</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#aa4c2830f305306d4f5f163b4522d0ba6">ml_locked</a> = NULL;</div><div class="line"><a name="l04112"></a><span class="lineno"> 4112</span>&#160;</div><div class="line"><a name="l04113"></a><span class="lineno"> 4113</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l04114"></a><span class="lineno"> 4114</span>&#160;<span class="comment">     * If lines have been added or deleted in the locked block, need to</span></div><div class="line"><a name="l04115"></a><span class="lineno"> 4115</span>&#160;<span class="comment">     * update the line count in pointer blocks.</span></div><div class="line"><a name="l04116"></a><span class="lineno"> 4116</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l04117"></a><span class="lineno"> 4117</span>&#160;    <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a97f953057f1eaa0360502866f1e54964">ml_locked_lineadd</a> != 0)</div><div class="line"><a name="l04118"></a><span class="lineno"> 4118</span>&#160;        <a class="code" href="memline_8c.html#a661ea17a2f15417b31afca629fbef050">ml_lineadd</a>(buf, buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a97f953057f1eaa0360502866f1e54964">ml_locked_lineadd</a>);</div><div class="line"><a name="l04119"></a><span class="lineno"> 4119</span>&#160;    }</div><div class="line"><a name="l04120"></a><span class="lineno"> 4120</span>&#160;</div><div class="line"><a name="l04121"></a><span class="lineno"> 4121</span>&#160;    <span class="keywordflow">if</span> (action == <a class="code" href="memline_8c.html#a89ca94197abc00b6c372ff0a72b4a091">ML_FLUSH</a>)     <span class="comment">/* nothing else to do */</span></div><div class="line"><a name="l04122"></a><span class="lineno"> 4122</span>&#160;    <span class="keywordflow">return</span> NULL;</div><div class="line"><a name="l04123"></a><span class="lineno"> 4123</span>&#160;</div><div class="line"><a name="l04124"></a><span class="lineno"> 4124</span>&#160;    bnum = 1;               <span class="comment">/* start at the root of the tree */</span></div><div class="line"><a name="l04125"></a><span class="lineno"> 4125</span>&#160;    page_count = 1;</div><div class="line"><a name="l04126"></a><span class="lineno"> 4126</span>&#160;    low = 1;</div><div class="line"><a name="l04127"></a><span class="lineno"> 4127</span>&#160;    high = buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a708091d31fa9cf7718aca80d707b1b3d">ml_line_count</a>;</div><div class="line"><a name="l04128"></a><span class="lineno"> 4128</span>&#160;</div><div class="line"><a name="l04129"></a><span class="lineno"> 4129</span>&#160;    <span class="keywordflow">if</span> (action == <a class="code" href="memline_8c.html#a1de07181f87bda4348b87eb71e0ab526">ML_FIND</a>)  <span class="comment">/* first try stack entries */</span></div><div class="line"><a name="l04130"></a><span class="lineno"> 4130</span>&#160;    {</div><div class="line"><a name="l04131"></a><span class="lineno"> 4131</span>&#160;    <span class="keywordflow">for</span> (top = buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a17d957b4b662bf327749e1523ac4f5b5">ml_stack_top</a> - 1; top &gt;= 0; --top)</div><div class="line"><a name="l04132"></a><span class="lineno"> 4132</span>&#160;    {</div><div class="line"><a name="l04133"></a><span class="lineno"> 4133</span>&#160;        ip = &amp;(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a77e2179043ee3367af09fe186b2fa5a8">ml_stack</a>[top]);</div><div class="line"><a name="l04134"></a><span class="lineno"> 4134</span>&#160;        <span class="keywordflow">if</span> (ip-&gt;<a class="code" href="structinfo__pointer.html#a4a99e7d504486b928d73e306227af4a4">ip_low</a> &lt;= lnum &amp;&amp; ip-&gt;<a class="code" href="structinfo__pointer.html#ac473382eb6323825263f4e65ddbb68de">ip_high</a> &gt;= lnum)</div><div class="line"><a name="l04135"></a><span class="lineno"> 4135</span>&#160;        {</div><div class="line"><a name="l04136"></a><span class="lineno"> 4136</span>&#160;        bnum = ip-&gt;<a class="code" href="structinfo__pointer.html#a140d83e56091daa97560a9a4a82a8c1b">ip_bnum</a>;</div><div class="line"><a name="l04137"></a><span class="lineno"> 4137</span>&#160;        low = ip-&gt;<a class="code" href="structinfo__pointer.html#a4a99e7d504486b928d73e306227af4a4">ip_low</a>;</div><div class="line"><a name="l04138"></a><span class="lineno"> 4138</span>&#160;        high = ip-&gt;<a class="code" href="structinfo__pointer.html#ac473382eb6323825263f4e65ddbb68de">ip_high</a>;</div><div class="line"><a name="l04139"></a><span class="lineno"> 4139</span>&#160;        buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a17d957b4b662bf327749e1523ac4f5b5">ml_stack_top</a> = top;   <span class="comment">/* truncate stack at prev entry */</span></div><div class="line"><a name="l04140"></a><span class="lineno"> 4140</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l04141"></a><span class="lineno"> 4141</span>&#160;        }</div><div class="line"><a name="l04142"></a><span class="lineno"> 4142</span>&#160;    }</div><div class="line"><a name="l04143"></a><span class="lineno"> 4143</span>&#160;    <span class="keywordflow">if</span> (top &lt; 0)</div><div class="line"><a name="l04144"></a><span class="lineno"> 4144</span>&#160;        buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a17d957b4b662bf327749e1523ac4f5b5">ml_stack_top</a> = 0;     <span class="comment">/* not found, start at the root */</span></div><div class="line"><a name="l04145"></a><span class="lineno"> 4145</span>&#160;    }</div><div class="line"><a name="l04146"></a><span class="lineno"> 4146</span>&#160;    <span class="keywordflow">else</span>    <span class="comment">/* ML_DELETE or ML_INSERT */</span></div><div class="line"><a name="l04147"></a><span class="lineno"> 4147</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a17d957b4b662bf327749e1523ac4f5b5">ml_stack_top</a> = 0; <span class="comment">/* start at the root */</span></div><div class="line"><a name="l04148"></a><span class="lineno"> 4148</span>&#160;</div><div class="line"><a name="l04149"></a><span class="lineno"> 4149</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l04150"></a><span class="lineno"> 4150</span>&#160;<span class="comment"> * search downwards in the tree until a data block is found</span></div><div class="line"><a name="l04151"></a><span class="lineno"> 4151</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l04152"></a><span class="lineno"> 4152</span>&#160;    <span class="keywordflow">for</span> (;;)</div><div class="line"><a name="l04153"></a><span class="lineno"> 4153</span>&#160;    {</div><div class="line"><a name="l04154"></a><span class="lineno"> 4154</span>&#160;    <span class="keywordflow">if</span> ((hp = <a class="code" href="memfile_8c.html#af9d5ff9ad91a2d5150a675c9c0d77e10">mf_get</a>(mfp, bnum, page_count)) == NULL)</div><div class="line"><a name="l04155"></a><span class="lineno"> 4155</span>&#160;        <span class="keywordflow">goto</span> error_noblock;</div><div class="line"><a name="l04156"></a><span class="lineno"> 4156</span>&#160;</div><div class="line"><a name="l04157"></a><span class="lineno"> 4157</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l04158"></a><span class="lineno"> 4158</span>&#160;<span class="comment">     * update high for insert/delete</span></div><div class="line"><a name="l04159"></a><span class="lineno"> 4159</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l04160"></a><span class="lineno"> 4160</span>&#160;    <span class="keywordflow">if</span> (action == <a class="code" href="memline_8c.html#a1fc0269a34abf68fee5e99b51879fa4b">ML_INSERT</a>)</div><div class="line"><a name="l04161"></a><span class="lineno"> 4161</span>&#160;        ++high;</div><div class="line"><a name="l04162"></a><span class="lineno"> 4162</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (action == <a class="code" href="memline_8c.html#ae92d6ba5b936547467fd45f1b6534778">ML_DELETE</a>)</div><div class="line"><a name="l04163"></a><span class="lineno"> 4163</span>&#160;        --high;</div><div class="line"><a name="l04164"></a><span class="lineno"> 4164</span>&#160;</div><div class="line"><a name="l04165"></a><span class="lineno"> 4165</span>&#160;    dp = (<a class="code" href="structdata__block.html">DATA_BL</a> *)(hp-&gt;<a class="code" href="structblock__hdr.html#a7247cdc0977ab6fdc9cb6238cda67587">bh_data</a>);</div><div class="line"><a name="l04166"></a><span class="lineno"> 4166</span>&#160;    <span class="keywordflow">if</span> (dp-&gt;<a class="code" href="structdata__block.html#ac977617f5f8153eda5d902a73e0379e1">db_id</a> == <a class="code" href="memline_8c.html#a55aa586df150c1192826a1c57dd87401">DATA_ID</a>)   <span class="comment">/* data block */</span></div><div class="line"><a name="l04167"></a><span class="lineno"> 4167</span>&#160;    {</div><div class="line"><a name="l04168"></a><span class="lineno"> 4168</span>&#160;        buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#aa4c2830f305306d4f5f163b4522d0ba6">ml_locked</a> = hp;</div><div class="line"><a name="l04169"></a><span class="lineno"> 4169</span>&#160;        buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a2b7c6e30401df9d0e8972cb639d1b895">ml_locked_low</a> = low;</div><div class="line"><a name="l04170"></a><span class="lineno"> 4170</span>&#160;        buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a81788089e53748eb945a88d6e41647da">ml_locked_high</a> = high;</div><div class="line"><a name="l04171"></a><span class="lineno"> 4171</span>&#160;        buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a97f953057f1eaa0360502866f1e54964">ml_locked_lineadd</a> = 0;</div><div class="line"><a name="l04172"></a><span class="lineno"> 4172</span>&#160;        buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a30f30ddb7264f667a92556f0568981e0">ml_flags</a> &amp;= ~(<a class="code" href="structs_8h.html#ad55a676a17d24163d3cdb2bf75a7fa66">ML_LOCKED_DIRTY</a> | <a class="code" href="structs_8h.html#a094e033c133f0276ed3c00f8053d0175">ML_LOCKED_POS</a>);</div><div class="line"><a name="l04173"></a><span class="lineno"> 4173</span>&#160;        <span class="keywordflow">return</span> hp;</div><div class="line"><a name="l04174"></a><span class="lineno"> 4174</span>&#160;    }</div><div class="line"><a name="l04175"></a><span class="lineno"> 4175</span>&#160;</div><div class="line"><a name="l04176"></a><span class="lineno"> 4176</span>&#160;    pp = (<a class="code" href="structpointer__block.html">PTR_BL</a> *)(dp);        <span class="comment">/* must be pointer block */</span></div><div class="line"><a name="l04177"></a><span class="lineno"> 4177</span>&#160;    <span class="keywordflow">if</span> (pp-&gt;<a class="code" href="structpointer__block.html#ac2698ad2c9c4096299106a53ffbd667f">pb_id</a> != <a class="code" href="memline_8c.html#a23d0125357ec4465a50f841f634c9214">PTR_ID</a>)</div><div class="line"><a name="l04178"></a><span class="lineno"> 4178</span>&#160;    {</div><div class="line"><a name="l04179"></a><span class="lineno"> 4179</span>&#160;        <a class="code" href="message_8c.html#a7926d7fa9a35dc0f5bac051dec01240a">iemsg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;E317: pointer block id wrong&quot;</span>));</div><div class="line"><a name="l04180"></a><span class="lineno"> 4180</span>&#160;        <span class="keywordflow">goto</span> error_block;</div><div class="line"><a name="l04181"></a><span class="lineno"> 4181</span>&#160;    }</div><div class="line"><a name="l04182"></a><span class="lineno"> 4182</span>&#160;</div><div class="line"><a name="l04183"></a><span class="lineno"> 4183</span>&#160;    <span class="keywordflow">if</span> ((top = <a class="code" href="memline_8c.html#aa6909d6a13a3189fdb549bea27afc662">ml_add_stack</a>(buf)) &lt; 0)  <span class="comment">/* add new entry to stack */</span></div><div class="line"><a name="l04184"></a><span class="lineno"> 4184</span>&#160;        <span class="keywordflow">goto</span> error_block;</div><div class="line"><a name="l04185"></a><span class="lineno"> 4185</span>&#160;    ip = &amp;(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a77e2179043ee3367af09fe186b2fa5a8">ml_stack</a>[top]);</div><div class="line"><a name="l04186"></a><span class="lineno"> 4186</span>&#160;    ip-&gt;<a class="code" href="structinfo__pointer.html#a140d83e56091daa97560a9a4a82a8c1b">ip_bnum</a> = bnum;</div><div class="line"><a name="l04187"></a><span class="lineno"> 4187</span>&#160;    ip-&gt;<a class="code" href="structinfo__pointer.html#a4a99e7d504486b928d73e306227af4a4">ip_low</a> = low;</div><div class="line"><a name="l04188"></a><span class="lineno"> 4188</span>&#160;    ip-&gt;<a class="code" href="structinfo__pointer.html#ac473382eb6323825263f4e65ddbb68de">ip_high</a> = high;</div><div class="line"><a name="l04189"></a><span class="lineno"> 4189</span>&#160;    ip-&gt;<a class="code" href="structinfo__pointer.html#acdf584cb720506bd2f40240dc71bab50">ip_index</a> = -1;      <span class="comment">/* index not known yet */</span></div><div class="line"><a name="l04190"></a><span class="lineno"> 4190</span>&#160;</div><div class="line"><a name="l04191"></a><span class="lineno"> 4191</span>&#160;    dirty = <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line"><a name="l04192"></a><span class="lineno"> 4192</span>&#160;    <span class="keywordflow">for</span> (idx = 0; idx &lt; (int)pp-&gt;<a class="code" href="structpointer__block.html#ad3682038298e7850fb980815132f17f9">pb_count</a>; ++idx)</div><div class="line"><a name="l04193"></a><span class="lineno"> 4193</span>&#160;    {</div><div class="line"><a name="l04194"></a><span class="lineno"> 4194</span>&#160;        t = pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[idx].<a class="code" href="structpointer__entry.html#a652fe117ed91b4ab3d84361e8aa751de">pe_line_count</a>;</div><div class="line"><a name="l04195"></a><span class="lineno"> 4195</span>&#160;        <a class="code" href="memline_8c.html#a4c3f0432d972be512c1ff55974987c8c">CHECK</a>(t == 0, <a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;pe_line_count is zero&quot;</span>));</div><div class="line"><a name="l04196"></a><span class="lineno"> 4196</span>&#160;        <span class="keywordflow">if</span> ((low += t) &gt; lnum)</div><div class="line"><a name="l04197"></a><span class="lineno"> 4197</span>&#160;        {</div><div class="line"><a name="l04198"></a><span class="lineno"> 4198</span>&#160;        ip-&gt;<a class="code" href="structinfo__pointer.html#acdf584cb720506bd2f40240dc71bab50">ip_index</a> = idx;</div><div class="line"><a name="l04199"></a><span class="lineno"> 4199</span>&#160;        bnum = pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[idx].<a class="code" href="structpointer__entry.html#a0234165c0ca282f192e94957a87175f6">pe_bnum</a>;</div><div class="line"><a name="l04200"></a><span class="lineno"> 4200</span>&#160;        page_count = pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[idx].<a class="code" href="structpointer__entry.html#aa5194eaf0768453f33b9d2ff66508040">pe_page_count</a>;</div><div class="line"><a name="l04201"></a><span class="lineno"> 4201</span>&#160;        high = low - 1;</div><div class="line"><a name="l04202"></a><span class="lineno"> 4202</span>&#160;        low -= t;</div><div class="line"><a name="l04203"></a><span class="lineno"> 4203</span>&#160;</div><div class="line"><a name="l04204"></a><span class="lineno"> 4204</span>&#160;        <span class="comment">/*</span></div><div class="line"><a name="l04205"></a><span class="lineno"> 4205</span>&#160;<span class="comment">         * a negative block number may have been changed</span></div><div class="line"><a name="l04206"></a><span class="lineno"> 4206</span>&#160;<span class="comment">         */</span></div><div class="line"><a name="l04207"></a><span class="lineno"> 4207</span>&#160;        <span class="keywordflow">if</span> (bnum &lt; 0)</div><div class="line"><a name="l04208"></a><span class="lineno"> 4208</span>&#160;        {</div><div class="line"><a name="l04209"></a><span class="lineno"> 4209</span>&#160;            bnum2 = <a class="code" href="memfile_8c.html#ac224c12ac428b0a19a3b38ecd98310a3">mf_trans_del</a>(mfp, bnum);</div><div class="line"><a name="l04210"></a><span class="lineno"> 4210</span>&#160;            <span class="keywordflow">if</span> (bnum != bnum2)</div><div class="line"><a name="l04211"></a><span class="lineno"> 4211</span>&#160;            {</div><div class="line"><a name="l04212"></a><span class="lineno"> 4212</span>&#160;            bnum = bnum2;</div><div class="line"><a name="l04213"></a><span class="lineno"> 4213</span>&#160;            pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[idx].<a class="code" href="structpointer__entry.html#a0234165c0ca282f192e94957a87175f6">pe_bnum</a> = bnum;</div><div class="line"><a name="l04214"></a><span class="lineno"> 4214</span>&#160;            dirty = <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"><a name="l04215"></a><span class="lineno"> 4215</span>&#160;            }</div><div class="line"><a name="l04216"></a><span class="lineno"> 4216</span>&#160;        }</div><div class="line"><a name="l04217"></a><span class="lineno"> 4217</span>&#160;</div><div class="line"><a name="l04218"></a><span class="lineno"> 4218</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l04219"></a><span class="lineno"> 4219</span>&#160;        }</div><div class="line"><a name="l04220"></a><span class="lineno"> 4220</span>&#160;    }</div><div class="line"><a name="l04221"></a><span class="lineno"> 4221</span>&#160;    <span class="keywordflow">if</span> (idx &gt;= (<span class="keywordtype">int</span>)pp-&gt;<a class="code" href="structpointer__block.html#ad3682038298e7850fb980815132f17f9">pb_count</a>)       <span class="comment">/* past the end: something wrong! */</span></div><div class="line"><a name="l04222"></a><span class="lineno"> 4222</span>&#160;    {</div><div class="line"><a name="l04223"></a><span class="lineno"> 4223</span>&#160;        <span class="keywordflow">if</span> (lnum &gt; buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a708091d31fa9cf7718aca80d707b1b3d">ml_line_count</a>)</div><div class="line"><a name="l04224"></a><span class="lineno"> 4224</span>&#160;        <a class="code" href="message_8c.html#a35f801e23d16b0e6a4d1cc61691ec03f">siemsg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;E322: line number out of range: %ld past the end&quot;</span>),</div><div class="line"><a name="l04225"></a><span class="lineno"> 4225</span>&#160;                          lnum - buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a708091d31fa9cf7718aca80d707b1b3d">ml_line_count</a>);</div><div class="line"><a name="l04226"></a><span class="lineno"> 4226</span>&#160;</div><div class="line"><a name="l04227"></a><span class="lineno"> 4227</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l04228"></a><span class="lineno"> 4228</span>&#160;        <a class="code" href="message_8c.html#a35f801e23d16b0e6a4d1cc61691ec03f">siemsg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;E323: line count wrong in block %ld&quot;</span>), bnum);</div><div class="line"><a name="l04229"></a><span class="lineno"> 4229</span>&#160;        <span class="keywordflow">goto</span> error_block;</div><div class="line"><a name="l04230"></a><span class="lineno"> 4230</span>&#160;    }</div><div class="line"><a name="l04231"></a><span class="lineno"> 4231</span>&#160;    <span class="keywordflow">if</span> (action == <a class="code" href="memline_8c.html#ae92d6ba5b936547467fd45f1b6534778">ML_DELETE</a>)</div><div class="line"><a name="l04232"></a><span class="lineno"> 4232</span>&#160;    {</div><div class="line"><a name="l04233"></a><span class="lineno"> 4233</span>&#160;        pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[idx].<a class="code" href="structpointer__entry.html#a652fe117ed91b4ab3d84361e8aa751de">pe_line_count</a>--;</div><div class="line"><a name="l04234"></a><span class="lineno"> 4234</span>&#160;        dirty = <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"><a name="l04235"></a><span class="lineno"> 4235</span>&#160;    }</div><div class="line"><a name="l04236"></a><span class="lineno"> 4236</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (action == <a class="code" href="memline_8c.html#a1fc0269a34abf68fee5e99b51879fa4b">ML_INSERT</a>)</div><div class="line"><a name="l04237"></a><span class="lineno"> 4237</span>&#160;    {</div><div class="line"><a name="l04238"></a><span class="lineno"> 4238</span>&#160;        pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[idx].<a class="code" href="structpointer__entry.html#a652fe117ed91b4ab3d84361e8aa751de">pe_line_count</a>++;</div><div class="line"><a name="l04239"></a><span class="lineno"> 4239</span>&#160;        dirty = <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"><a name="l04240"></a><span class="lineno"> 4240</span>&#160;    }</div><div class="line"><a name="l04241"></a><span class="lineno"> 4241</span>&#160;    <a class="code" href="memfile_8c.html#abb7f268382703d32becc96f6d92fb855">mf_put</a>(mfp, hp, dirty, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l04242"></a><span class="lineno"> 4242</span>&#160;    }</div><div class="line"><a name="l04243"></a><span class="lineno"> 4243</span>&#160;</div><div class="line"><a name="l04244"></a><span class="lineno"> 4244</span>&#160;error_block:</div><div class="line"><a name="l04245"></a><span class="lineno"> 4245</span>&#160;    <a class="code" href="memfile_8c.html#abb7f268382703d32becc96f6d92fb855">mf_put</a>(mfp, hp, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l04246"></a><span class="lineno"> 4246</span>&#160;error_noblock:</div><div class="line"><a name="l04247"></a><span class="lineno"> 4247</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l04248"></a><span class="lineno"> 4248</span>&#160;<span class="comment">     * If action is ML_DELETE or ML_INSERT we have to correct the tree for</span></div><div class="line"><a name="l04249"></a><span class="lineno"> 4249</span>&#160;<span class="comment">     * the incremented/decremented line counts, because there won&#39;t be a line</span></div><div class="line"><a name="l04250"></a><span class="lineno"> 4250</span>&#160;<span class="comment">     * inserted/deleted after all.</span></div><div class="line"><a name="l04251"></a><span class="lineno"> 4251</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l04252"></a><span class="lineno"> 4252</span>&#160;    <span class="keywordflow">if</span> (action == <a class="code" href="memline_8c.html#ae92d6ba5b936547467fd45f1b6534778">ML_DELETE</a>)</div><div class="line"><a name="l04253"></a><span class="lineno"> 4253</span>&#160;    <a class="code" href="memline_8c.html#a661ea17a2f15417b31afca629fbef050">ml_lineadd</a>(buf, 1);</div><div class="line"><a name="l04254"></a><span class="lineno"> 4254</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (action == <a class="code" href="memline_8c.html#a1fc0269a34abf68fee5e99b51879fa4b">ML_INSERT</a>)</div><div class="line"><a name="l04255"></a><span class="lineno"> 4255</span>&#160;    <a class="code" href="memline_8c.html#a661ea17a2f15417b31afca629fbef050">ml_lineadd</a>(buf, -1);</div><div class="line"><a name="l04256"></a><span class="lineno"> 4256</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a17d957b4b662bf327749e1523ac4f5b5">ml_stack_top</a> = 0;</div><div class="line"><a name="l04257"></a><span class="lineno"> 4257</span>&#160;    <span class="keywordflow">return</span> NULL;</div><div class="line"><a name="l04258"></a><span class="lineno"> 4258</span>&#160;}</div><div class="line"><a name="l04259"></a><span class="lineno"> 4259</span>&#160;</div><div class="line"><a name="l04260"></a><span class="lineno"> 4260</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l04261"></a><span class="lineno"> 4261</span>&#160;<span class="comment"> * add an entry to the info pointer stack</span></div><div class="line"><a name="l04262"></a><span class="lineno"> 4262</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l04263"></a><span class="lineno"> 4263</span>&#160;<span class="comment"> * return -1 for failure, number of the new entry otherwise</span></div><div class="line"><a name="l04264"></a><span class="lineno"> 4264</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l04265"></a><span class="lineno"> 4265</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">int</span></div><div class="line"><a name="l04266"></a><span class="lineno"><a class="line" href="memline_8c.html#aa6909d6a13a3189fdb549bea27afc662"> 4266</a></span>&#160;<a class="code" href="memline_8c.html#aa6909d6a13a3189fdb549bea27afc662">ml_add_stack</a>(<a class="code" href="structfile__buffer.html">buf_T</a> *buf)</div><div class="line"><a name="l04267"></a><span class="lineno"> 4267</span>&#160;{</div><div class="line"><a name="l04268"></a><span class="lineno"> 4268</span>&#160;    <span class="keywordtype">int</span>     top;</div><div class="line"><a name="l04269"></a><span class="lineno"> 4269</span>&#160;    <a class="code" href="structinfo__pointer.html">infoptr_T</a>   *newstack;</div><div class="line"><a name="l04270"></a><span class="lineno"> 4270</span>&#160;</div><div class="line"><a name="l04271"></a><span class="lineno"> 4271</span>&#160;    top = buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a17d957b4b662bf327749e1523ac4f5b5">ml_stack_top</a>;</div><div class="line"><a name="l04272"></a><span class="lineno"> 4272</span>&#160;</div><div class="line"><a name="l04273"></a><span class="lineno"> 4273</span>&#160;    <span class="comment">/* may have to increase the stack size */</span></div><div class="line"><a name="l04274"></a><span class="lineno"> 4274</span>&#160;    <span class="keywordflow">if</span> (top == buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#add4fba4ecd680fbf53ab842c85ccde21">ml_stack_size</a>)</div><div class="line"><a name="l04275"></a><span class="lineno"> 4275</span>&#160;    {</div><div class="line"><a name="l04276"></a><span class="lineno"> 4276</span>&#160;    <a class="code" href="memline_8c.html#a4c3f0432d972be512c1ff55974987c8c">CHECK</a>(top &gt; 0, <a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;Stack size increases&quot;</span>)); <span class="comment">/* more than 5 levels??? */</span></div><div class="line"><a name="l04277"></a><span class="lineno"> 4277</span>&#160;</div><div class="line"><a name="l04278"></a><span class="lineno"> 4278</span>&#160;    newstack = <a class="code" href="vim_8h.html#a22743f1c6b7f2b83c4a99f8ac1a5d454">ALLOC_MULT</a>(<a class="code" href="structinfo__pointer.html">infoptr_T</a>, buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#add4fba4ecd680fbf53ab842c85ccde21">ml_stack_size</a> + <a class="code" href="memline_8c.html#a0caed9f008450f4f072f64fa9023aa0a">STACK_INCR</a>);</div><div class="line"><a name="l04279"></a><span class="lineno"> 4279</span>&#160;    <span class="keywordflow">if</span> (newstack == NULL)</div><div class="line"><a name="l04280"></a><span class="lineno"> 4280</span>&#160;        <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l04281"></a><span class="lineno"> 4281</span>&#160;    <span class="keywordflow">if</span> (top &gt; 0)</div><div class="line"><a name="l04282"></a><span class="lineno"> 4282</span>&#160;        <a class="code" href="os__unix_8h.html#ae70108db942e4f3eeb701ad8787b1835">mch_memmove</a>(newstack, buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a77e2179043ee3367af09fe186b2fa5a8">ml_stack</a>,</div><div class="line"><a name="l04283"></a><span class="lineno"> 4283</span>&#160;                         (<span class="keywordtype">size_t</span>)top * <span class="keyword">sizeof</span>(<a class="code" href="structinfo__pointer.html">infoptr_T</a>));</div><div class="line"><a name="l04284"></a><span class="lineno"> 4284</span>&#160;    <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a77e2179043ee3367af09fe186b2fa5a8">ml_stack</a>);</div><div class="line"><a name="l04285"></a><span class="lineno"> 4285</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a77e2179043ee3367af09fe186b2fa5a8">ml_stack</a> = newstack;</div><div class="line"><a name="l04286"></a><span class="lineno"> 4286</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#add4fba4ecd680fbf53ab842c85ccde21">ml_stack_size</a> += <a class="code" href="memline_8c.html#a0caed9f008450f4f072f64fa9023aa0a">STACK_INCR</a>;</div><div class="line"><a name="l04287"></a><span class="lineno"> 4287</span>&#160;    }</div><div class="line"><a name="l04288"></a><span class="lineno"> 4288</span>&#160;</div><div class="line"><a name="l04289"></a><span class="lineno"> 4289</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a17d957b4b662bf327749e1523ac4f5b5">ml_stack_top</a>++;</div><div class="line"><a name="l04290"></a><span class="lineno"> 4290</span>&#160;    <span class="keywordflow">return</span> top;</div><div class="line"><a name="l04291"></a><span class="lineno"> 4291</span>&#160;}</div><div class="line"><a name="l04292"></a><span class="lineno"> 4292</span>&#160;</div><div class="line"><a name="l04293"></a><span class="lineno"> 4293</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l04294"></a><span class="lineno"> 4294</span>&#160;<span class="comment"> * Update the pointer blocks on the stack for inserted/deleted lines.</span></div><div class="line"><a name="l04295"></a><span class="lineno"> 4295</span>&#160;<span class="comment"> * The stack itself is also updated.</span></div><div class="line"><a name="l04296"></a><span class="lineno"> 4296</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l04297"></a><span class="lineno"> 4297</span>&#160;<span class="comment"> * When a insert/delete line action fails, the line is not inserted/deleted,</span></div><div class="line"><a name="l04298"></a><span class="lineno"> 4298</span>&#160;<span class="comment"> * but the pointer blocks have already been updated. That is fixed here by</span></div><div class="line"><a name="l04299"></a><span class="lineno"> 4299</span>&#160;<span class="comment"> * walking through the stack.</span></div><div class="line"><a name="l04300"></a><span class="lineno"> 4300</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l04301"></a><span class="lineno"> 4301</span>&#160;<span class="comment"> * Count is the number of lines added, negative if lines have been deleted.</span></div><div class="line"><a name="l04302"></a><span class="lineno"> 4302</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l04303"></a><span class="lineno"> 4303</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">void</span></div><div class="line"><a name="l04304"></a><span class="lineno"><a class="line" href="memline_8c.html#a661ea17a2f15417b31afca629fbef050"> 4304</a></span>&#160;<a class="code" href="memline_8c.html#a661ea17a2f15417b31afca629fbef050">ml_lineadd</a>(<a class="code" href="structfile__buffer.html">buf_T</a> *buf, <span class="keywordtype">int</span> count)</div><div class="line"><a name="l04305"></a><span class="lineno"> 4305</span>&#160;{</div><div class="line"><a name="l04306"></a><span class="lineno"> 4306</span>&#160;    <span class="keywordtype">int</span>     idx;</div><div class="line"><a name="l04307"></a><span class="lineno"> 4307</span>&#160;    <a class="code" href="structinfo__pointer.html">infoptr_T</a>   *<a class="code" href="namespacetest__channel.html#a6a2152bf75d93cd14fcffc99c3e76807">ip</a>;</div><div class="line"><a name="l04308"></a><span class="lineno"> 4308</span>&#160;    <a class="code" href="structpointer__block.html">PTR_BL</a>  *pp;</div><div class="line"><a name="l04309"></a><span class="lineno"> 4309</span>&#160;    <a class="code" href="structmemfile.html">memfile_T</a>   *mfp = buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a9adb5a08b3c01be69c98360a14937227">ml_mfp</a>;</div><div class="line"><a name="l04310"></a><span class="lineno"> 4310</span>&#160;    <a class="code" href="structblock__hdr.html">bhdr_T</a>  *hp;</div><div class="line"><a name="l04311"></a><span class="lineno"> 4311</span>&#160;</div><div class="line"><a name="l04312"></a><span class="lineno"> 4312</span>&#160;    <span class="keywordflow">for</span> (idx = buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a17d957b4b662bf327749e1523ac4f5b5">ml_stack_top</a> - 1; idx &gt;= 0; --idx)</div><div class="line"><a name="l04313"></a><span class="lineno"> 4313</span>&#160;    {</div><div class="line"><a name="l04314"></a><span class="lineno"> 4314</span>&#160;    ip = &amp;(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a77e2179043ee3367af09fe186b2fa5a8">ml_stack</a>[idx]);</div><div class="line"><a name="l04315"></a><span class="lineno"> 4315</span>&#160;    <span class="keywordflow">if</span> ((hp = <a class="code" href="memfile_8c.html#af9d5ff9ad91a2d5150a675c9c0d77e10">mf_get</a>(mfp, ip-&gt;<a class="code" href="structinfo__pointer.html#a140d83e56091daa97560a9a4a82a8c1b">ip_bnum</a>, 1)) == NULL)</div><div class="line"><a name="l04316"></a><span class="lineno"> 4316</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l04317"></a><span class="lineno"> 4317</span>&#160;    pp = (<a class="code" href="structpointer__block.html">PTR_BL</a> *)(hp-&gt;<a class="code" href="structblock__hdr.html#a7247cdc0977ab6fdc9cb6238cda67587">bh_data</a>);   <span class="comment">/* must be pointer block */</span></div><div class="line"><a name="l04318"></a><span class="lineno"> 4318</span>&#160;    <span class="keywordflow">if</span> (pp-&gt;<a class="code" href="structpointer__block.html#ac2698ad2c9c4096299106a53ffbd667f">pb_id</a> != <a class="code" href="memline_8c.html#a23d0125357ec4465a50f841f634c9214">PTR_ID</a>)</div><div class="line"><a name="l04319"></a><span class="lineno"> 4319</span>&#160;    {</div><div class="line"><a name="l04320"></a><span class="lineno"> 4320</span>&#160;        <a class="code" href="memfile_8c.html#abb7f268382703d32becc96f6d92fb855">mf_put</a>(mfp, hp, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l04321"></a><span class="lineno"> 4321</span>&#160;        <a class="code" href="message_8c.html#a7926d7fa9a35dc0f5bac051dec01240a">iemsg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;E317: pointer block id wrong 2&quot;</span>));</div><div class="line"><a name="l04322"></a><span class="lineno"> 4322</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l04323"></a><span class="lineno"> 4323</span>&#160;    }</div><div class="line"><a name="l04324"></a><span class="lineno"> 4324</span>&#160;    pp-&gt;<a class="code" href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pb_pointer</a>[ip-&gt;<a class="code" href="structinfo__pointer.html#acdf584cb720506bd2f40240dc71bab50">ip_index</a>].<a class="code" href="structpointer__entry.html#a652fe117ed91b4ab3d84361e8aa751de">pe_line_count</a> += count;</div><div class="line"><a name="l04325"></a><span class="lineno"> 4325</span>&#160;    ip-&gt;<a class="code" href="structinfo__pointer.html#ac473382eb6323825263f4e65ddbb68de">ip_high</a> += count;</div><div class="line"><a name="l04326"></a><span class="lineno"> 4326</span>&#160;    <a class="code" href="memfile_8c.html#abb7f268382703d32becc96f6d92fb855">mf_put</a>(mfp, hp, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l04327"></a><span class="lineno"> 4327</span>&#160;    }</div><div class="line"><a name="l04328"></a><span class="lineno"> 4328</span>&#160;}</div><div class="line"><a name="l04329"></a><span class="lineno"> 4329</span>&#160;</div><div class="line"><a name="l04330"></a><span class="lineno"> 4330</span>&#160;<span class="preprocessor">#if defined(HAVE_READLINK) || defined(PROTO)</span></div><div class="line"><a name="l04331"></a><span class="lineno"> 4331</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l04332"></a><span class="lineno"> 4332</span>&#160;<span class="comment"> * Resolve a symlink in the last component of a file name.</span></div><div class="line"><a name="l04333"></a><span class="lineno"> 4333</span>&#160;<span class="comment"> * Note that f_resolve() does it for every part of the path, we don&#39;t do that</span></div><div class="line"><a name="l04334"></a><span class="lineno"> 4334</span>&#160;<span class="comment"> * here.</span></div><div class="line"><a name="l04335"></a><span class="lineno"> 4335</span>&#160;<span class="comment"> * If it worked returns OK and the resolved link in &quot;buf[MAXPATHL]&quot;.</span></div><div class="line"><a name="l04336"></a><span class="lineno"> 4336</span>&#160;<span class="comment"> * Otherwise returns FAIL.</span></div><div class="line"><a name="l04337"></a><span class="lineno"> 4337</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l04338"></a><span class="lineno"> 4338</span>&#160;    <span class="keywordtype">int</span></div><div class="line"><a name="l04339"></a><span class="lineno"> 4339</span>&#160;resolve_symlink(char_u *fname, char_u *buf)</div><div class="line"><a name="l04340"></a><span class="lineno"> 4340</span>&#160;{</div><div class="line"><a name="l04341"></a><span class="lineno"> 4341</span>&#160;    char_u  tmp[<a class="code" href="os__unix_8h.html#a9b75f9db03a33bb3d2d613923647d0cf">MAXPATHL</a>];</div><div class="line"><a name="l04342"></a><span class="lineno"> 4342</span>&#160;    <span class="keywordtype">int</span>     ret;</div><div class="line"><a name="l04343"></a><span class="lineno"> 4343</span>&#160;    <span class="keywordtype">int</span>     depth = 0;</div><div class="line"><a name="l04344"></a><span class="lineno"> 4344</span>&#160;</div><div class="line"><a name="l04345"></a><span class="lineno"> 4345</span>&#160;    <span class="keywordflow">if</span> (fname == NULL)</div><div class="line"><a name="l04346"></a><span class="lineno"> 4346</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="dosinst_8h.html#abb508ea8227673f419e9fe3a86c30d8e">FAIL</a>;</div><div class="line"><a name="l04347"></a><span class="lineno"> 4347</span>&#160;</div><div class="line"><a name="l04348"></a><span class="lineno"> 4348</span>&#160;    <span class="comment">/* Put the result so far in tmp[], starting with the original name. */</span></div><div class="line"><a name="l04349"></a><span class="lineno"> 4349</span>&#160;    <a class="code" href="misc2_8c.html#ab25a3a48241497fdc7bec2c3dbe41467">vim_strncpy</a>(tmp, fname, <a class="code" href="os__unix_8h.html#a9b75f9db03a33bb3d2d613923647d0cf">MAXPATHL</a> - 1);</div><div class="line"><a name="l04350"></a><span class="lineno"> 4350</span>&#160;</div><div class="line"><a name="l04351"></a><span class="lineno"> 4351</span>&#160;    <span class="keywordflow">for</span> (;;)</div><div class="line"><a name="l04352"></a><span class="lineno"> 4352</span>&#160;    {</div><div class="line"><a name="l04353"></a><span class="lineno"> 4353</span>&#160;    <span class="comment">/* Limit symlink depth to 100, catch recursive loops. */</span></div><div class="line"><a name="l04354"></a><span class="lineno"> 4354</span>&#160;    <span class="keywordflow">if</span> (++depth == 100)</div><div class="line"><a name="l04355"></a><span class="lineno"> 4355</span>&#160;    {</div><div class="line"><a name="l04356"></a><span class="lineno"> 4356</span>&#160;        <a class="code" href="message_8c.html#aeb2442b830699494f53059773212d850">semsg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;E773: Symlink loop for \&quot;%s\&quot;&quot;</span>), fname);</div><div class="line"><a name="l04357"></a><span class="lineno"> 4357</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="dosinst_8h.html#abb508ea8227673f419e9fe3a86c30d8e">FAIL</a>;</div><div class="line"><a name="l04358"></a><span class="lineno"> 4358</span>&#160;    }</div><div class="line"><a name="l04359"></a><span class="lineno"> 4359</span>&#160;</div><div class="line"><a name="l04360"></a><span class="lineno"> 4360</span>&#160;    ret = readlink((<span class="keywordtype">char</span> *)tmp, (<span class="keywordtype">char</span> *)buf, <a class="code" href="os__unix_8h.html#a9b75f9db03a33bb3d2d613923647d0cf">MAXPATHL</a> - 1);</div><div class="line"><a name="l04361"></a><span class="lineno"> 4361</span>&#160;    <span class="keywordflow">if</span> (ret &lt;= 0)</div><div class="line"><a name="l04362"></a><span class="lineno"> 4362</span>&#160;    {</div><div class="line"><a name="l04363"></a><span class="lineno"> 4363</span>&#160;        <span class="keywordflow">if</span> (errno == EINVAL || errno == ENOENT)</div><div class="line"><a name="l04364"></a><span class="lineno"> 4364</span>&#160;        {</div><div class="line"><a name="l04365"></a><span class="lineno"> 4365</span>&#160;        <span class="comment">/* Found non-symlink or not existing file, stop here.</span></div><div class="line"><a name="l04366"></a><span class="lineno"> 4366</span>&#160;<span class="comment">         * When at the first level use the unmodified name, skip the</span></div><div class="line"><a name="l04367"></a><span class="lineno"> 4367</span>&#160;<span class="comment">         * call to vim_FullName(). */</span></div><div class="line"><a name="l04368"></a><span class="lineno"> 4368</span>&#160;        <span class="keywordflow">if</span> (depth == 1)</div><div class="line"><a name="l04369"></a><span class="lineno"> 4369</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="dosinst_8h.html#abb508ea8227673f419e9fe3a86c30d8e">FAIL</a>;</div><div class="line"><a name="l04370"></a><span class="lineno"> 4370</span>&#160;</div><div class="line"><a name="l04371"></a><span class="lineno"> 4371</span>&#160;        <span class="comment">/* Use the resolved name in tmp[]. */</span></div><div class="line"><a name="l04372"></a><span class="lineno"> 4372</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l04373"></a><span class="lineno"> 4373</span>&#160;        }</div><div class="line"><a name="l04374"></a><span class="lineno"> 4374</span>&#160;</div><div class="line"><a name="l04375"></a><span class="lineno"> 4375</span>&#160;        <span class="comment">/* There must be some error reading links, use original name. */</span></div><div class="line"><a name="l04376"></a><span class="lineno"> 4376</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="dosinst_8h.html#abb508ea8227673f419e9fe3a86c30d8e">FAIL</a>;</div><div class="line"><a name="l04377"></a><span class="lineno"> 4377</span>&#160;    }</div><div class="line"><a name="l04378"></a><span class="lineno"> 4378</span>&#160;    buf[ret] = <a class="code" href="ascii_8h.html#af19d48b9f61047a668649a2f9dc317ff">NUL</a>;</div><div class="line"><a name="l04379"></a><span class="lineno"> 4379</span>&#160;</div><div class="line"><a name="l04380"></a><span class="lineno"> 4380</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l04381"></a><span class="lineno"> 4381</span>&#160;<span class="comment">     * Check whether the symlink is relative or absolute.</span></div><div class="line"><a name="l04382"></a><span class="lineno"> 4382</span>&#160;<span class="comment">     * If it&#39;s relative, build a new path based on the directory</span></div><div class="line"><a name="l04383"></a><span class="lineno"> 4383</span>&#160;<span class="comment">     * portion of the filename (if any) and the path the symlink</span></div><div class="line"><a name="l04384"></a><span class="lineno"> 4384</span>&#160;<span class="comment">     * points to.</span></div><div class="line"><a name="l04385"></a><span class="lineno"> 4385</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l04386"></a><span class="lineno"> 4386</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="os__amiga_8c.html#a3ba7ec8a49f3d6aaaa6e426d6fdeabc6">mch_isFullName</a>(buf))</div><div class="line"><a name="l04387"></a><span class="lineno"> 4387</span>&#160;        <a class="code" href="vim_8h.html#aa9cea5fcb1483307770f365fb24aa08d">STRCPY</a>(tmp, buf);</div><div class="line"><a name="l04388"></a><span class="lineno"> 4388</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l04389"></a><span class="lineno"> 4389</span>&#160;    {</div><div class="line"><a name="l04390"></a><span class="lineno"> 4390</span>&#160;        char_u *tail;</div><div class="line"><a name="l04391"></a><span class="lineno"> 4391</span>&#160;</div><div class="line"><a name="l04392"></a><span class="lineno"> 4392</span>&#160;        tail = <a class="code" href="filepath_8c.html#a3a027a38b217222ac4d9ebe8ce5c1947">gettail</a>(tmp);</div><div class="line"><a name="l04393"></a><span class="lineno"> 4393</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="vim_8h.html#a916ffefe1fc74532d08102cca55d8e34">STRLEN</a>(tail) + <a class="code" href="vim_8h.html#a916ffefe1fc74532d08102cca55d8e34">STRLEN</a>(buf) &gt;= <a class="code" href="os__unix_8h.html#a9b75f9db03a33bb3d2d613923647d0cf">MAXPATHL</a>)</div><div class="line"><a name="l04394"></a><span class="lineno"> 4394</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="dosinst_8h.html#abb508ea8227673f419e9fe3a86c30d8e">FAIL</a>;</div><div class="line"><a name="l04395"></a><span class="lineno"> 4395</span>&#160;        <a class="code" href="vim_8h.html#aa9cea5fcb1483307770f365fb24aa08d">STRCPY</a>(tail, buf);</div><div class="line"><a name="l04396"></a><span class="lineno"> 4396</span>&#160;    }</div><div class="line"><a name="l04397"></a><span class="lineno"> 4397</span>&#160;    }</div><div class="line"><a name="l04398"></a><span class="lineno"> 4398</span>&#160;</div><div class="line"><a name="l04399"></a><span class="lineno"> 4399</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l04400"></a><span class="lineno"> 4400</span>&#160;<span class="comment">     * Try to resolve the full name of the file so that the swapfile name will</span></div><div class="line"><a name="l04401"></a><span class="lineno"> 4401</span>&#160;<span class="comment">     * be consistent even when opening a relative symlink from different</span></div><div class="line"><a name="l04402"></a><span class="lineno"> 4402</span>&#160;<span class="comment">     * working directories.</span></div><div class="line"><a name="l04403"></a><span class="lineno"> 4403</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l04404"></a><span class="lineno"> 4404</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="filepath_8c.html#a52fbff29815a2232d884304f4dce5fef">vim_FullName</a>(tmp, buf, <a class="code" href="os__unix_8h.html#a9b75f9db03a33bb3d2d613923647d0cf">MAXPATHL</a>, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div><div class="line"><a name="l04405"></a><span class="lineno"> 4405</span>&#160;}</div><div class="line"><a name="l04406"></a><span class="lineno"> 4406</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l04407"></a><span class="lineno"> 4407</span>&#160;</div><div class="line"><a name="l04408"></a><span class="lineno"> 4408</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l04409"></a><span class="lineno"> 4409</span>&#160;<span class="comment"> * Make swap file name out of the file name and a directory name.</span></div><div class="line"><a name="l04410"></a><span class="lineno"> 4410</span>&#160;<span class="comment"> * Returns pointer to allocated memory or NULL.</span></div><div class="line"><a name="l04411"></a><span class="lineno"> 4411</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l04412"></a><span class="lineno"> 4412</span>&#160;    char_u *</div><div class="line"><a name="l04413"></a><span class="lineno"><a class="line" href="memline_8c.html#acf7020b3158145c4a34278f766dbb08e"> 4413</a></span>&#160;<a class="code" href="memline_8c.html#acf7020b3158145c4a34278f766dbb08e">makeswapname</a>(</div><div class="line"><a name="l04414"></a><span class="lineno"> 4414</span>&#160;    char_u  *fname,</div><div class="line"><a name="l04415"></a><span class="lineno"> 4415</span>&#160;    char_u  *ffname <a class="code" href="vterm__internal_8h.html#addf5ec070e9499d36b7f2009ce736076">UNUSED</a>,</div><div class="line"><a name="l04416"></a><span class="lineno"> 4416</span>&#160;    <a class="code" href="structfile__buffer.html">buf_T</a>   *buf,</div><div class="line"><a name="l04417"></a><span class="lineno"> 4417</span>&#160;    char_u  *dir_name)</div><div class="line"><a name="l04418"></a><span class="lineno"> 4418</span>&#160;{</div><div class="line"><a name="l04419"></a><span class="lineno"> 4419</span>&#160;    char_u  *r, *s;</div><div class="line"><a name="l04420"></a><span class="lineno"> 4420</span>&#160;    char_u  *fname_res = fname;</div><div class="line"><a name="l04421"></a><span class="lineno"> 4421</span>&#160;<span class="preprocessor">#ifdef HAVE_READLINK</span></div><div class="line"><a name="l04422"></a><span class="lineno"> 4422</span>&#160;    char_u  fname_buf[<a class="code" href="os__unix_8h.html#a9b75f9db03a33bb3d2d613923647d0cf">MAXPATHL</a>];</div><div class="line"><a name="l04423"></a><span class="lineno"> 4423</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l04424"></a><span class="lineno"> 4424</span>&#160;</div><div class="line"><a name="l04425"></a><span class="lineno"> 4425</span>&#160;<span class="preprocessor">#if defined(UNIX) || defined(MSWIN)  // Need _very_ long file names</span></div><div class="line"><a name="l04426"></a><span class="lineno"> 4426</span>&#160;    <span class="keywordtype">int</span>     len = (int)<a class="code" href="vim_8h.html#a916ffefe1fc74532d08102cca55d8e34">STRLEN</a>(dir_name);</div><div class="line"><a name="l04427"></a><span class="lineno"> 4427</span>&#160;</div><div class="line"><a name="l04428"></a><span class="lineno"> 4428</span>&#160;    s = dir_name + len;</div><div class="line"><a name="l04429"></a><span class="lineno"> 4429</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="misc2_8c.html#abdfcdf88256313698f6b7329ba22c5f3">after_pathsep</a>(dir_name, s) &amp;&amp; len &gt; 1 &amp;&amp; s[-1] == s[-2])</div><div class="line"><a name="l04430"></a><span class="lineno"> 4430</span>&#160;    {                  <span class="comment">/* Ends with &#39;//&#39;, Use Full path */</span></div><div class="line"><a name="l04431"></a><span class="lineno"> 4431</span>&#160;    r = NULL;</div><div class="line"><a name="l04432"></a><span class="lineno"> 4432</span>&#160;    <span class="keywordflow">if</span> ((s = make_percent_swname(dir_name, fname)) != NULL)</div><div class="line"><a name="l04433"></a><span class="lineno"> 4433</span>&#160;    {</div><div class="line"><a name="l04434"></a><span class="lineno"> 4434</span>&#160;        r = <a class="code" href="fileio_8c.html#aac79f705198b1f5212fd7f7bba16b852">modname</a>(s, (char_u *)<span class="stringliteral">&quot;.swp&quot;</span>, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l04435"></a><span class="lineno"> 4435</span>&#160;        <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(s);</div><div class="line"><a name="l04436"></a><span class="lineno"> 4436</span>&#160;    }</div><div class="line"><a name="l04437"></a><span class="lineno"> 4437</span>&#160;    <span class="keywordflow">return</span> r;</div><div class="line"><a name="l04438"></a><span class="lineno"> 4438</span>&#160;    }</div><div class="line"><a name="l04439"></a><span class="lineno"> 4439</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l04440"></a><span class="lineno"> 4440</span>&#160;</div><div class="line"><a name="l04441"></a><span class="lineno"> 4441</span>&#160;<span class="preprocessor">#ifdef HAVE_READLINK</span></div><div class="line"><a name="l04442"></a><span class="lineno"> 4442</span>&#160;    <span class="comment">/* Expand symlink in the file name, so that we put the swap file with the</span></div><div class="line"><a name="l04443"></a><span class="lineno"> 4443</span>&#160;<span class="comment">     * actual file instead of with the symlink. */</span></div><div class="line"><a name="l04444"></a><span class="lineno"> 4444</span>&#160;    <span class="keywordflow">if</span> (resolve_symlink(fname, fname_buf) == <a class="code" href="dosinst_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>)</div><div class="line"><a name="l04445"></a><span class="lineno"> 4445</span>&#160;    fname_res = fname_buf;</div><div class="line"><a name="l04446"></a><span class="lineno"> 4446</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l04447"></a><span class="lineno"> 4447</span>&#160;</div><div class="line"><a name="l04448"></a><span class="lineno"> 4448</span>&#160;    r = <a class="code" href="fileio_8c.html#a4b05aacc60d92626ca3d0ecb658e3c96">buf_modname</a>(</div><div class="line"><a name="l04449"></a><span class="lineno"> 4449</span>&#160;        (buf-&gt;<a class="code" href="structfile__buffer.html#aec6a0756665954537e932c6d1b8378a8">b_p_sn</a> || buf-&gt;<a class="code" href="structfile__buffer.html#abc07833d399f70595fd5e62404b876ad">b_shortname</a>),</div><div class="line"><a name="l04450"></a><span class="lineno"> 4450</span>&#160;        fname_res,</div><div class="line"><a name="l04451"></a><span class="lineno"> 4451</span>&#160;        (char_u *)</div><div class="line"><a name="l04452"></a><span class="lineno"> 4452</span>&#160;#<span class="keywordflow">if</span> defined(VMS)</div><div class="line"><a name="l04453"></a><span class="lineno"> 4453</span>&#160;        <span class="stringliteral">&quot;_swp&quot;</span>,</div><div class="line"><a name="l04454"></a><span class="lineno"> 4454</span>&#160;#<span class="keywordflow">else</span></div><div class="line"><a name="l04455"></a><span class="lineno"> 4455</span>&#160;        <span class="stringliteral">&quot;.swp&quot;</span>,</div><div class="line"><a name="l04456"></a><span class="lineno"> 4456</span>&#160;#endif</div><div class="line"><a name="l04457"></a><span class="lineno"> 4457</span>&#160;        <span class="comment">/* Prepend a &#39;.&#39; to the swap file name for the current directory. */</span></div><div class="line"><a name="l04458"></a><span class="lineno"> 4458</span>&#160;        dir_name[0] == <span class="charliteral">&#39;.&#39;</span> &amp;&amp; dir_name[1] == <a class="code" href="ascii_8h.html#af19d48b9f61047a668649a2f9dc317ff">NUL</a>);</div><div class="line"><a name="l04459"></a><span class="lineno"> 4459</span>&#160;    <span class="keywordflow">if</span> (r == NULL)      <span class="comment">/* out of memory */</span></div><div class="line"><a name="l04460"></a><span class="lineno"> 4460</span>&#160;    <span class="keywordflow">return</span> NULL;</div><div class="line"><a name="l04461"></a><span class="lineno"> 4461</span>&#160;</div><div class="line"><a name="l04462"></a><span class="lineno"> 4462</span>&#160;    s = <a class="code" href="memline_8c.html#a9c2c56f6c2568183afa203bc1654502e">get_file_in_dir</a>(r, dir_name);</div><div class="line"><a name="l04463"></a><span class="lineno"> 4463</span>&#160;    <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(r);</div><div class="line"><a name="l04464"></a><span class="lineno"> 4464</span>&#160;    <span class="keywordflow">return</span> s;</div><div class="line"><a name="l04465"></a><span class="lineno"> 4465</span>&#160;}</div><div class="line"><a name="l04466"></a><span class="lineno"> 4466</span>&#160;</div><div class="line"><a name="l04467"></a><span class="lineno"> 4467</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l04468"></a><span class="lineno"> 4468</span>&#160;<span class="comment"> * Get file name to use for swap file or backup file.</span></div><div class="line"><a name="l04469"></a><span class="lineno"> 4469</span>&#160;<span class="comment"> * Use the name of the edited file &quot;fname&quot; and an entry in the &#39;dir&#39; or &#39;bdir&#39;</span></div><div class="line"><a name="l04470"></a><span class="lineno"> 4470</span>&#160;<span class="comment"> * option &quot;dname&quot;.</span></div><div class="line"><a name="l04471"></a><span class="lineno"> 4471</span>&#160;<span class="comment"> * - If &quot;dname&quot; is &quot;.&quot;, return &quot;fname&quot; (swap file in dir of file).</span></div><div class="line"><a name="l04472"></a><span class="lineno"> 4472</span>&#160;<span class="comment"> * - If &quot;dname&quot; starts with &quot;./&quot;, insert &quot;dname&quot; in &quot;fname&quot; (swap file</span></div><div class="line"><a name="l04473"></a><span class="lineno"> 4473</span>&#160;<span class="comment"> *   relative to dir of file).</span></div><div class="line"><a name="l04474"></a><span class="lineno"> 4474</span>&#160;<span class="comment"> * - Otherwise, prepend &quot;dname&quot; to the tail of &quot;fname&quot; (swap file in specific</span></div><div class="line"><a name="l04475"></a><span class="lineno"> 4475</span>&#160;<span class="comment"> *   dir).</span></div><div class="line"><a name="l04476"></a><span class="lineno"> 4476</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l04477"></a><span class="lineno"> 4477</span>&#160;<span class="comment"> * The return value is an allocated string and can be NULL.</span></div><div class="line"><a name="l04478"></a><span class="lineno"> 4478</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l04479"></a><span class="lineno"> 4479</span>&#160;    char_u *</div><div class="line"><a name="l04480"></a><span class="lineno"><a class="line" href="memline_8c.html#a9c2c56f6c2568183afa203bc1654502e"> 4480</a></span>&#160;<a class="code" href="memline_8c.html#a9c2c56f6c2568183afa203bc1654502e">get_file_in_dir</a>(</div><div class="line"><a name="l04481"></a><span class="lineno"> 4481</span>&#160;    char_u  *fname,</div><div class="line"><a name="l04482"></a><span class="lineno"> 4482</span>&#160;    char_u  *dname) <span class="comment">/* don&#39;t use &quot;dirname&quot;, it is a global for Alpha */</span></div><div class="line"><a name="l04483"></a><span class="lineno"> 4483</span>&#160;{</div><div class="line"><a name="l04484"></a><span class="lineno"> 4484</span>&#160;    char_u  *t;</div><div class="line"><a name="l04485"></a><span class="lineno"> 4485</span>&#160;    char_u  *tail;</div><div class="line"><a name="l04486"></a><span class="lineno"> 4486</span>&#160;    char_u  *retval;</div><div class="line"><a name="l04487"></a><span class="lineno"> 4487</span>&#160;    <span class="keywordtype">int</span>     save_char;</div><div class="line"><a name="l04488"></a><span class="lineno"> 4488</span>&#160;</div><div class="line"><a name="l04489"></a><span class="lineno"> 4489</span>&#160;    tail = <a class="code" href="filepath_8c.html#a3a027a38b217222ac4d9ebe8ce5c1947">gettail</a>(fname);</div><div class="line"><a name="l04490"></a><span class="lineno"> 4490</span>&#160;</div><div class="line"><a name="l04491"></a><span class="lineno"> 4491</span>&#160;    <span class="keywordflow">if</span> (dname[0] == <span class="charliteral">&#39;.&#39;</span> &amp;&amp; dname[1] == <a class="code" href="ascii_8h.html#af19d48b9f61047a668649a2f9dc317ff">NUL</a>)</div><div class="line"><a name="l04492"></a><span class="lineno"> 4492</span>&#160;    retval = <a class="code" href="misc2_8c.html#acd554ee46804f666060916bf740b3c96">vim_strsave</a>(fname);</div><div class="line"><a name="l04493"></a><span class="lineno"> 4493</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dname[0] == <span class="charliteral">&#39;.&#39;</span> &amp;&amp; <a class="code" href="filepath_8c.html#acb4aef03c801e568565f34c9e10d25cf">vim_ispathsep</a>(dname[1]))</div><div class="line"><a name="l04494"></a><span class="lineno"> 4494</span>&#160;    {</div><div class="line"><a name="l04495"></a><span class="lineno"> 4495</span>&#160;    <span class="keywordflow">if</span> (tail == fname)      <span class="comment">/* no path before file name */</span></div><div class="line"><a name="l04496"></a><span class="lineno"> 4496</span>&#160;        retval = <a class="code" href="filepath_8c.html#a8de478b7b0307fbc7b4aab47648ecb0c">concat_fnames</a>(dname + 2, tail, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div><div class="line"><a name="l04497"></a><span class="lineno"> 4497</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l04498"></a><span class="lineno"> 4498</span>&#160;    {</div><div class="line"><a name="l04499"></a><span class="lineno"> 4499</span>&#160;        save_char = *tail;</div><div class="line"><a name="l04500"></a><span class="lineno"> 4500</span>&#160;        *tail = <a class="code" href="ascii_8h.html#af19d48b9f61047a668649a2f9dc317ff">NUL</a>;</div><div class="line"><a name="l04501"></a><span class="lineno"> 4501</span>&#160;        t = <a class="code" href="filepath_8c.html#a8de478b7b0307fbc7b4aab47648ecb0c">concat_fnames</a>(fname, dname + 2, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div><div class="line"><a name="l04502"></a><span class="lineno"> 4502</span>&#160;        *tail = save_char;</div><div class="line"><a name="l04503"></a><span class="lineno"> 4503</span>&#160;        <span class="keywordflow">if</span> (t == NULL)      <span class="comment">/* out of memory */</span></div><div class="line"><a name="l04504"></a><span class="lineno"> 4504</span>&#160;        retval = NULL;</div><div class="line"><a name="l04505"></a><span class="lineno"> 4505</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l04506"></a><span class="lineno"> 4506</span>&#160;        {</div><div class="line"><a name="l04507"></a><span class="lineno"> 4507</span>&#160;        retval = <a class="code" href="filepath_8c.html#a8de478b7b0307fbc7b4aab47648ecb0c">concat_fnames</a>(t, tail, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div><div class="line"><a name="l04508"></a><span class="lineno"> 4508</span>&#160;        <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(t);</div><div class="line"><a name="l04509"></a><span class="lineno"> 4509</span>&#160;        }</div><div class="line"><a name="l04510"></a><span class="lineno"> 4510</span>&#160;    }</div><div class="line"><a name="l04511"></a><span class="lineno"> 4511</span>&#160;    }</div><div class="line"><a name="l04512"></a><span class="lineno"> 4512</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l04513"></a><span class="lineno"> 4513</span>&#160;    retval = <a class="code" href="filepath_8c.html#a8de478b7b0307fbc7b4aab47648ecb0c">concat_fnames</a>(dname, tail, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div><div class="line"><a name="l04514"></a><span class="lineno"> 4514</span>&#160;</div><div class="line"><a name="l04515"></a><span class="lineno"> 4515</span>&#160;<span class="preprocessor">#ifdef MSWIN</span></div><div class="line"><a name="l04516"></a><span class="lineno"> 4516</span>&#160;    <span class="keywordflow">if</span> (retval != NULL)</div><div class="line"><a name="l04517"></a><span class="lineno"> 4517</span>&#160;    <span class="keywordflow">for</span> (t = <a class="code" href="filepath_8c.html#a3a027a38b217222ac4d9ebe8ce5c1947">gettail</a>(retval); *t != <a class="code" href="ascii_8h.html#af19d48b9f61047a668649a2f9dc317ff">NUL</a>; <a class="code" href="macros_8h.html#a8e76521a98776d2e3f9b33fcb331dcee">MB_PTR_ADV</a>(t))</div><div class="line"><a name="l04518"></a><span class="lineno"> 4518</span>&#160;        <span class="keywordflow">if</span> (*t == <span class="charliteral">&#39;:&#39;</span>)</div><div class="line"><a name="l04519"></a><span class="lineno"> 4519</span>&#160;        *t = <span class="charliteral">&#39;%&#39;</span>;</div><div class="line"><a name="l04520"></a><span class="lineno"> 4520</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l04521"></a><span class="lineno"> 4521</span>&#160;</div><div class="line"><a name="l04522"></a><span class="lineno"> 4522</span>&#160;    <span class="keywordflow">return</span> retval;</div><div class="line"><a name="l04523"></a><span class="lineno"> 4523</span>&#160;}</div><div class="line"><a name="l04524"></a><span class="lineno"> 4524</span>&#160;</div><div class="line"><a name="l04525"></a><span class="lineno"> 4525</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l04526"></a><span class="lineno"> 4526</span>&#160;<span class="comment"> * Print the ATTENTION message: info about an existing swap file.</span></div><div class="line"><a name="l04527"></a><span class="lineno"> 4527</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l04528"></a><span class="lineno"> 4528</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">void</span></div><div class="line"><a name="l04529"></a><span class="lineno"><a class="line" href="memline_8c.html#a8a397be254bc1ea753c218ceb79b7812"> 4529</a></span>&#160;<a class="code" href="memline_8c.html#a8a397be254bc1ea753c218ceb79b7812">attention_message</a>(</div><div class="line"><a name="l04530"></a><span class="lineno"> 4530</span>&#160;    <a class="code" href="structfile__buffer.html">buf_T</a>   *buf,   <span class="comment">/* buffer being edited */</span></div><div class="line"><a name="l04531"></a><span class="lineno"> 4531</span>&#160;    char_u  *fname) <span class="comment">/* swap file name */</span></div><div class="line"><a name="l04532"></a><span class="lineno"> 4532</span>&#160;{</div><div class="line"><a name="l04533"></a><span class="lineno"> 4533</span>&#160;    <a class="code" href="vim_8h.html#a3206c537c639e0f26013f6cf909bd0e0">stat_T</a>  st;</div><div class="line"><a name="l04534"></a><span class="lineno"> 4534</span>&#160;    time_t  swap_mtime;</div><div class="line"><a name="l04535"></a><span class="lineno"> 4535</span>&#160;</div><div class="line"><a name="l04536"></a><span class="lineno"> 4536</span>&#160;    ++no_wait_return;</div><div class="line"><a name="l04537"></a><span class="lineno"> 4537</span>&#160;    (void)<a class="code" href="message_8c.html#ae5991a4d11897dfaee9bfab8e5489d82">emsg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;E325: ATTENTION&quot;</span>));</div><div class="line"><a name="l04538"></a><span class="lineno"> 4538</span>&#160;    <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;\nFound a swap file by the name \&quot;&quot;</span>));</div><div class="line"><a name="l04539"></a><span class="lineno"> 4539</span>&#160;    <a class="code" href="message_8c.html#aa4a7a34db68561f1e14a20524dbbc4c1">msg_home_replace</a>(fname);</div><div class="line"><a name="l04540"></a><span class="lineno"> 4540</span>&#160;    <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<span class="stringliteral">&quot;\&quot;\n&quot;</span>);</div><div class="line"><a name="l04541"></a><span class="lineno"> 4541</span>&#160;    swap_mtime = <a class="code" href="memline_8c.html#aad2a8c25b4deee1b1fec00478af75568">swapfile_info</a>(fname);</div><div class="line"><a name="l04542"></a><span class="lineno"> 4542</span>&#160;    <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;While opening file \&quot;&quot;</span>));</div><div class="line"><a name="l04543"></a><span class="lineno"> 4543</span>&#160;    <a class="code" href="message_8c.html#a273e1e1a7e5b9b70db0a55edb73e303d">msg_outtrans</a>(buf-&gt;<a class="code" href="structfile__buffer.html#a34a7c5a6d702c7ce0181584242976f3e">b_fname</a>);</div><div class="line"><a name="l04544"></a><span class="lineno"> 4544</span>&#160;    <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<span class="stringliteral">&quot;\&quot;\n&quot;</span>);</div><div class="line"><a name="l04545"></a><span class="lineno"> 4545</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="macros_8h.html#af9221f9667cc05a05b4646b2aa31e233">mch_stat</a>((<span class="keywordtype">char</span> *)buf-&gt;<a class="code" href="structfile__buffer.html#a34a7c5a6d702c7ce0181584242976f3e">b_fname</a>, &amp;st) == -1)</div><div class="line"><a name="l04546"></a><span class="lineno"> 4546</span>&#160;    {</div><div class="line"><a name="l04547"></a><span class="lineno"> 4547</span>&#160;    <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;      CANNOT BE FOUND&quot;</span>));</div><div class="line"><a name="l04548"></a><span class="lineno"> 4548</span>&#160;    }</div><div class="line"><a name="l04549"></a><span class="lineno"> 4549</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l04550"></a><span class="lineno"> 4550</span>&#160;    {</div><div class="line"><a name="l04551"></a><span class="lineno"> 4551</span>&#160;    <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;             dated: &quot;</span>));</div><div class="line"><a name="l04552"></a><span class="lineno"> 4552</span>&#160;    <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="memline_8c.html#a677f4728e1de4885d0d4fb8cb5774849">get_ctime</a>(st.st_mtime, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>));</div><div class="line"><a name="l04553"></a><span class="lineno"> 4553</span>&#160;    <span class="keywordflow">if</span> (swap_mtime != 0 &amp;&amp; st.st_mtime &gt; swap_mtime)</div><div class="line"><a name="l04554"></a><span class="lineno"> 4554</span>&#160;        <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;      NEWER than swap file!\n&quot;</span>));</div><div class="line"><a name="l04555"></a><span class="lineno"> 4555</span>&#160;    }</div><div class="line"><a name="l04556"></a><span class="lineno"> 4556</span>&#160;    <span class="comment">/* Some of these messages are long to allow translation to</span></div><div class="line"><a name="l04557"></a><span class="lineno"> 4557</span>&#160;<span class="comment">     * other languages. */</span></div><div class="line"><a name="l04558"></a><span class="lineno"> 4558</span>&#160;    <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;\n(1) Another program may be editing the same file.  If this is the case,\n    be careful not to end up with two different instances of the same\n    file when making changes.  Quit, or continue with caution.\n&quot;</span>));</div><div class="line"><a name="l04559"></a><span class="lineno"> 4559</span>&#160;    <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;(2) An edit session for this file crashed.\n&quot;</span>));</div><div class="line"><a name="l04560"></a><span class="lineno"> 4560</span>&#160;    <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;    If this is the case, use \&quot;:recover\&quot; or \&quot;vim -r &quot;</span>));</div><div class="line"><a name="l04561"></a><span class="lineno"> 4561</span>&#160;    <a class="code" href="message_8c.html#a273e1e1a7e5b9b70db0a55edb73e303d">msg_outtrans</a>(buf-&gt;<a class="code" href="structfile__buffer.html#a34a7c5a6d702c7ce0181584242976f3e">b_fname</a>);</div><div class="line"><a name="l04562"></a><span class="lineno"> 4562</span>&#160;    <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;\&quot;\n    to recover the changes (see \&quot;:help recovery\&quot;).\n&quot;</span>));</div><div class="line"><a name="l04563"></a><span class="lineno"> 4563</span>&#160;    <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;    If you did this already, delete the swap file \&quot;&quot;</span>));</div><div class="line"><a name="l04564"></a><span class="lineno"> 4564</span>&#160;    <a class="code" href="message_8c.html#a273e1e1a7e5b9b70db0a55edb73e303d">msg_outtrans</a>(fname);</div><div class="line"><a name="l04565"></a><span class="lineno"> 4565</span>&#160;    <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;\&quot;\n    to avoid this message.\n&quot;</span>));</div><div class="line"><a name="l04566"></a><span class="lineno"> 4566</span>&#160;    <a class="code" href="globals_8h.html#ad239f2bb11982175ed2389134c8f3669">cmdline_row</a> = <a class="code" href="globals_8h.html#a376f82c59d5c5bf72c5bc753f7554128">msg_row</a>;</div><div class="line"><a name="l04567"></a><span class="lineno"> 4567</span>&#160;    --no_wait_return;</div><div class="line"><a name="l04568"></a><span class="lineno"> 4568</span>&#160;}</div><div class="line"><a name="l04569"></a><span class="lineno"> 4569</span>&#160;</div><div class="line"><a name="l04570"></a><span class="lineno"> 4570</span>&#160;<span class="preprocessor">#if defined(FEAT_EVAL)</span></div><div class="line"><a name="l04571"></a><span class="lineno"> 4571</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l04572"></a><span class="lineno"> 4572</span>&#160;<span class="comment"> * Trigger the SwapExists autocommands.</span></div><div class="line"><a name="l04573"></a><span class="lineno"> 4573</span>&#160;<span class="comment"> * Returns a value for equivalent to do_dialog() (see below):</span></div><div class="line"><a name="l04574"></a><span class="lineno"> 4574</span>&#160;<span class="comment"> * 0: still need to ask for a choice</span></div><div class="line"><a name="l04575"></a><span class="lineno"> 4575</span>&#160;<span class="comment"> * 1: open read-only</span></div><div class="line"><a name="l04576"></a><span class="lineno"> 4576</span>&#160;<span class="comment"> * 2: edit anyway</span></div><div class="line"><a name="l04577"></a><span class="lineno"> 4577</span>&#160;<span class="comment"> * 3: recover</span></div><div class="line"><a name="l04578"></a><span class="lineno"> 4578</span>&#160;<span class="comment"> * 4: delete it</span></div><div class="line"><a name="l04579"></a><span class="lineno"> 4579</span>&#160;<span class="comment"> * 5: quit</span></div><div class="line"><a name="l04580"></a><span class="lineno"> 4580</span>&#160;<span class="comment"> * 6: abort</span></div><div class="line"><a name="l04581"></a><span class="lineno"> 4581</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l04582"></a><span class="lineno"> 4582</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">int</span></div><div class="line"><a name="l04583"></a><span class="lineno"><a class="line" href="memline_8c.html#ae7de358039e15f47f17c3e66d31a2370"> 4583</a></span>&#160;<a class="code" href="memline_8c.html#ae7de358039e15f47f17c3e66d31a2370">do_swapexists</a>(<a class="code" href="structfile__buffer.html">buf_T</a> *buf, char_u *fname)</div><div class="line"><a name="l04584"></a><span class="lineno"> 4584</span>&#160;{</div><div class="line"><a name="l04585"></a><span class="lineno"> 4585</span>&#160;    <a class="code" href="evalvars_8c.html#ad24dc360910df498ab3f75c5957e55b6">set_vim_var_string</a>(<a class="code" href="vim_8h.html#a4e860a79cf758ccaf39278ec2b05b6f6">VV_SWAPNAME</a>, fname, -1);</div><div class="line"><a name="l04586"></a><span class="lineno"> 4586</span>&#160;    <a class="code" href="evalvars_8c.html#ad24dc360910df498ab3f75c5957e55b6">set_vim_var_string</a>(<a class="code" href="vim_8h.html#ae8a70272e3860382f6585ba9c49c1c0d">VV_SWAPCHOICE</a>, NULL, -1);</div><div class="line"><a name="l04587"></a><span class="lineno"> 4587</span>&#160;</div><div class="line"><a name="l04588"></a><span class="lineno"> 4588</span>&#160;    <span class="comment">/* Trigger SwapExists autocommands with &lt;afile&gt; set to the file being</span></div><div class="line"><a name="l04589"></a><span class="lineno"> 4589</span>&#160;<span class="comment">     * edited.  Disallow changing directory here. */</span></div><div class="line"><a name="l04590"></a><span class="lineno"> 4590</span>&#160;    ++allbuf_lock;</div><div class="line"><a name="l04591"></a><span class="lineno"> 4591</span>&#160;    <a class="code" href="autocmd_8c.html#a0239c7fe680501d4396b532abf3bd768">apply_autocmds</a>(<a class="code" href="vim_8h.html#a2de49dcf3b3c1e1043a2373b0d69a58aa37aec197ae0d6840760454b3ce99c9b2">EVENT_SWAPEXISTS</a>, buf-&gt;<a class="code" href="structfile__buffer.html#a34a7c5a6d702c7ce0181584242976f3e">b_fname</a>, NULL, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, NULL);</div><div class="line"><a name="l04592"></a><span class="lineno"> 4592</span>&#160;    --allbuf_lock;</div><div class="line"><a name="l04593"></a><span class="lineno"> 4593</span>&#160;</div><div class="line"><a name="l04594"></a><span class="lineno"> 4594</span>&#160;    <a class="code" href="evalvars_8c.html#ad24dc360910df498ab3f75c5957e55b6">set_vim_var_string</a>(<a class="code" href="vim_8h.html#a4e860a79cf758ccaf39278ec2b05b6f6">VV_SWAPNAME</a>, NULL, -1);</div><div class="line"><a name="l04595"></a><span class="lineno"> 4595</span>&#160;</div><div class="line"><a name="l04596"></a><span class="lineno"> 4596</span>&#160;    <span class="keywordflow">switch</span> (*<a class="code" href="evalvars_8c.html#a5c7a8c84b65dc8166f8bb9c1db583d54">get_vim_var_str</a>(<a class="code" href="vim_8h.html#ae8a70272e3860382f6585ba9c49c1c0d">VV_SWAPCHOICE</a>))</div><div class="line"><a name="l04597"></a><span class="lineno"> 4597</span>&#160;    {</div><div class="line"><a name="l04598"></a><span class="lineno"> 4598</span>&#160;    <span class="keywordflow">case</span> <span class="charliteral">&#39;o&#39;</span>: <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l04599"></a><span class="lineno"> 4599</span>&#160;    <span class="keywordflow">case</span> <span class="charliteral">&#39;e&#39;</span>: <span class="keywordflow">return</span> 2;</div><div class="line"><a name="l04600"></a><span class="lineno"> 4600</span>&#160;    <span class="keywordflow">case</span> <span class="charliteral">&#39;r&#39;</span>: <span class="keywordflow">return</span> 3;</div><div class="line"><a name="l04601"></a><span class="lineno"> 4601</span>&#160;    <span class="keywordflow">case</span> <span class="charliteral">&#39;d&#39;</span>: <span class="keywordflow">return</span> 4;</div><div class="line"><a name="l04602"></a><span class="lineno"> 4602</span>&#160;    <span class="keywordflow">case</span> <span class="charliteral">&#39;q&#39;</span>: <span class="keywordflow">return</span> 5;</div><div class="line"><a name="l04603"></a><span class="lineno"> 4603</span>&#160;    <span class="keywordflow">case</span> <span class="charliteral">&#39;a&#39;</span>: <span class="keywordflow">return</span> 6;</div><div class="line"><a name="l04604"></a><span class="lineno"> 4604</span>&#160;    }</div><div class="line"><a name="l04605"></a><span class="lineno"> 4605</span>&#160;</div><div class="line"><a name="l04606"></a><span class="lineno"> 4606</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l04607"></a><span class="lineno"> 4607</span>&#160;}</div><div class="line"><a name="l04608"></a><span class="lineno"> 4608</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l04609"></a><span class="lineno"> 4609</span>&#160;</div><div class="line"><a name="l04610"></a><span class="lineno"> 4610</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l04611"></a><span class="lineno"> 4611</span>&#160;<span class="comment"> * Find out what name to use for the swap file for buffer &#39;buf&#39;.</span></div><div class="line"><a name="l04612"></a><span class="lineno"> 4612</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l04613"></a><span class="lineno"> 4613</span>&#160;<span class="comment"> * Several names are tried to find one that does not exist</span></div><div class="line"><a name="l04614"></a><span class="lineno"> 4614</span>&#160;<span class="comment"> * Returns the name in allocated memory or NULL.</span></div><div class="line"><a name="l04615"></a><span class="lineno"> 4615</span>&#160;<span class="comment"> * When out of memory &quot;dirp&quot; is set to NULL.</span></div><div class="line"><a name="l04616"></a><span class="lineno"> 4616</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l04617"></a><span class="lineno"> 4617</span>&#160;<span class="comment"> * Note: If BASENAMELEN is not correct, you will get error messages for</span></div><div class="line"><a name="l04618"></a><span class="lineno"> 4618</span>&#160;<span class="comment"> *   not being able to open the swap or undo file</span></div><div class="line"><a name="l04619"></a><span class="lineno"> 4619</span>&#160;<span class="comment"> * Note: May trigger SwapExists autocmd, pointers may change!</span></div><div class="line"><a name="l04620"></a><span class="lineno"> 4620</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l04621"></a><span class="lineno"> 4621</span>&#160;    <span class="keyword">static</span> char_u *</div><div class="line"><a name="l04622"></a><span class="lineno"><a class="line" href="memline_8c.html#af8d501a6ccea291cd77605d10240eeda"> 4622</a></span>&#160;<a class="code" href="memline_8c.html#af8d501a6ccea291cd77605d10240eeda">findswapname</a>(</div><div class="line"><a name="l04623"></a><span class="lineno"> 4623</span>&#160;    <a class="code" href="structfile__buffer.html">buf_T</a>   *buf,</div><div class="line"><a name="l04624"></a><span class="lineno"> 4624</span>&#160;    char_u  **dirp,     <span class="comment">/* pointer to list of directories */</span></div><div class="line"><a name="l04625"></a><span class="lineno"> 4625</span>&#160;    char_u  *old_fname) <span class="comment">/* don&#39;t give warning for this file name */</span></div><div class="line"><a name="l04626"></a><span class="lineno"> 4626</span>&#160;{</div><div class="line"><a name="l04627"></a><span class="lineno"> 4627</span>&#160;    char_u  *fname;</div><div class="line"><a name="l04628"></a><span class="lineno"> 4628</span>&#160;    <span class="keywordtype">int</span>     n;</div><div class="line"><a name="l04629"></a><span class="lineno"> 4629</span>&#160;    char_u  *dir_name;</div><div class="line"><a name="l04630"></a><span class="lineno"> 4630</span>&#160;<span class="preprocessor">#ifdef AMIGA</span></div><div class="line"><a name="l04631"></a><span class="lineno"> 4631</span>&#160;    BPTR    fh;</div><div class="line"><a name="l04632"></a><span class="lineno"> 4632</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l04633"></a><span class="lineno"> 4633</span>&#160;    <span class="keywordtype">int</span>     r;</div><div class="line"><a name="l04634"></a><span class="lineno"> 4634</span>&#160;    char_u  *buf_fname = buf-&gt;<a class="code" href="structfile__buffer.html#a34a7c5a6d702c7ce0181584242976f3e">b_fname</a>;</div><div class="line"><a name="l04635"></a><span class="lineno"> 4635</span>&#160;</div><div class="line"><a name="l04636"></a><span class="lineno"> 4636</span>&#160;<span class="preprocessor">#if !defined(UNIX)</span></div><div class="line"><a name="l04637"></a><span class="lineno"> 4637</span>&#160;<span class="preprocessor"># define CREATE_DUMMY_FILE</span></div><div class="line"><a name="l04638"></a><span class="lineno"> 4638</span>&#160;    FILE    *dummyfd = NULL;</div><div class="line"><a name="l04639"></a><span class="lineno"> 4639</span>&#160;</div><div class="line"><a name="l04640"></a><span class="lineno"> 4640</span>&#160;<span class="preprocessor"># ifdef MSWIN</span></div><div class="line"><a name="l04641"></a><span class="lineno"> 4641</span>&#160;    <span class="keywordflow">if</span> (buf_fname != NULL &amp;&amp; !<a class="code" href="os__amiga_8c.html#a3ba7ec8a49f3d6aaaa6e426d6fdeabc6">mch_isFullName</a>(buf_fname)</div><div class="line"><a name="l04642"></a><span class="lineno"> 4642</span>&#160;                       &amp;&amp; <a class="code" href="misc2_8c.html#a8978cebac3b4ced66551e67c3a375842">vim_strchr</a>(<a class="code" href="filepath_8c.html#a3a027a38b217222ac4d9ebe8ce5c1947">gettail</a>(buf_fname), <span class="charliteral">&#39;:&#39;</span>))</div><div class="line"><a name="l04643"></a><span class="lineno"> 4643</span>&#160;    {</div><div class="line"><a name="l04644"></a><span class="lineno"> 4644</span>&#160;    char_u *t;</div><div class="line"><a name="l04645"></a><span class="lineno"> 4645</span>&#160;</div><div class="line"><a name="l04646"></a><span class="lineno"> 4646</span>&#160;    buf_fname = <a class="code" href="misc2_8c.html#acd554ee46804f666060916bf740b3c96">vim_strsave</a>(buf_fname);</div><div class="line"><a name="l04647"></a><span class="lineno"> 4647</span>&#160;    <span class="keywordflow">if</span> (buf_fname == NULL)</div><div class="line"><a name="l04648"></a><span class="lineno"> 4648</span>&#160;        buf_fname = buf-&gt;<a class="code" href="structfile__buffer.html#a34a7c5a6d702c7ce0181584242976f3e">b_fname</a>;</div><div class="line"><a name="l04649"></a><span class="lineno"> 4649</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l04650"></a><span class="lineno"> 4650</span>&#160;        <span class="keywordflow">for</span> (t = <a class="code" href="filepath_8c.html#a3a027a38b217222ac4d9ebe8ce5c1947">gettail</a>(buf_fname); *t != <a class="code" href="ascii_8h.html#af19d48b9f61047a668649a2f9dc317ff">NUL</a>; <a class="code" href="macros_8h.html#a8e76521a98776d2e3f9b33fcb331dcee">MB_PTR_ADV</a>(t))</div><div class="line"><a name="l04651"></a><span class="lineno"> 4651</span>&#160;        <span class="keywordflow">if</span> (*t == <span class="charliteral">&#39;:&#39;</span>)</div><div class="line"><a name="l04652"></a><span class="lineno"> 4652</span>&#160;            *t = <span class="charliteral">&#39;%&#39;</span>;</div><div class="line"><a name="l04653"></a><span class="lineno"> 4653</span>&#160;    }</div><div class="line"><a name="l04654"></a><span class="lineno"> 4654</span>&#160;<span class="preprocessor"># endif</span></div><div class="line"><a name="l04655"></a><span class="lineno"> 4655</span>&#160;</div><div class="line"><a name="l04656"></a><span class="lineno"> 4656</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l04657"></a><span class="lineno"> 4657</span>&#160;<span class="comment">     * If we start editing a new file, e.g. &quot;test.doc&quot;, which resides on an</span></div><div class="line"><a name="l04658"></a><span class="lineno"> 4658</span>&#160;<span class="comment">     * MSDOS compatible filesystem, it is possible that the file</span></div><div class="line"><a name="l04659"></a><span class="lineno"> 4659</span>&#160;<span class="comment">     * &quot;test.doc.swp&quot; which we create will be exactly the same file. To avoid</span></div><div class="line"><a name="l04660"></a><span class="lineno"> 4660</span>&#160;<span class="comment">     * this problem we temporarily create &quot;test.doc&quot;.  Don&#39;t do this when the</span></div><div class="line"><a name="l04661"></a><span class="lineno"> 4661</span>&#160;<span class="comment">     * check below for a 8.3 file name is used.</span></div><div class="line"><a name="l04662"></a><span class="lineno"> 4662</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l04663"></a><span class="lineno"> 4663</span>&#160;    <span class="keywordflow">if</span> (!(buf-&gt;<a class="code" href="structfile__buffer.html#aec6a0756665954537e932c6d1b8378a8">b_p_sn</a> || buf-&gt;<a class="code" href="structfile__buffer.html#abc07833d399f70595fd5e62404b876ad">b_shortname</a>) &amp;&amp; buf_fname != NULL</div><div class="line"><a name="l04664"></a><span class="lineno"> 4664</span>&#160;                         &amp;&amp; <a class="code" href="os__amiga_8c.html#a7e689f4e37bb4db880dae0d37452f7de">mch_getperm</a>(buf_fname) &lt; 0)</div><div class="line"><a name="l04665"></a><span class="lineno"> 4665</span>&#160;    dummyfd = <a class="code" href="os__win32_8c.html#af1ef6cc4b2e3b02554529c108268ff5d">mch_fopen</a>((<span class="keywordtype">char</span> *)buf_fname, <span class="stringliteral">&quot;w&quot;</span>);</div><div class="line"><a name="l04666"></a><span class="lineno"> 4666</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l04667"></a><span class="lineno"> 4667</span>&#160;</div><div class="line"><a name="l04668"></a><span class="lineno"> 4668</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l04669"></a><span class="lineno"> 4669</span>&#160;<span class="comment">     * Isolate a directory name from *dirp and put it in dir_name.</span></div><div class="line"><a name="l04670"></a><span class="lineno"> 4670</span>&#160;<span class="comment">     * First allocate some memory to put the directory name in.</span></div><div class="line"><a name="l04671"></a><span class="lineno"> 4671</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l04672"></a><span class="lineno"> 4672</span>&#160;    dir_name = <a class="code" href="misc2_8c.html#ad0b64e14955781629a3908e328f82665">alloc</a>(<a class="code" href="vim_8h.html#a916ffefe1fc74532d08102cca55d8e34">STRLEN</a>(*dirp) + 1);</div><div class="line"><a name="l04673"></a><span class="lineno"> 4673</span>&#160;    <span class="keywordflow">if</span> (dir_name == NULL)</div><div class="line"><a name="l04674"></a><span class="lineno"> 4674</span>&#160;    *dirp = NULL;</div><div class="line"><a name="l04675"></a><span class="lineno"> 4675</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l04676"></a><span class="lineno"> 4676</span>&#160;    (<span class="keywordtype">void</span>)<a class="code" href="misc2_8c.html#a2c53531dd0451dcef1ae39403b49ee67">copy_option_part</a>(dirp, dir_name, 31000, <span class="stringliteral">&quot;,&quot;</span>);</div><div class="line"><a name="l04677"></a><span class="lineno"> 4677</span>&#160;</div><div class="line"><a name="l04678"></a><span class="lineno"> 4678</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l04679"></a><span class="lineno"> 4679</span>&#160;<span class="comment">     * we try different names until we find one that does not exist yet</span></div><div class="line"><a name="l04680"></a><span class="lineno"> 4680</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l04681"></a><span class="lineno"> 4681</span>&#160;    <span class="keywordflow">if</span> (dir_name == NULL)       <span class="comment">/* out of memory */</span></div><div class="line"><a name="l04682"></a><span class="lineno"> 4682</span>&#160;    fname = NULL;</div><div class="line"><a name="l04683"></a><span class="lineno"> 4683</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l04684"></a><span class="lineno"> 4684</span>&#160;    fname = <a class="code" href="memline_8c.html#acf7020b3158145c4a34278f766dbb08e">makeswapname</a>(buf_fname, buf-&gt;<a class="code" href="structfile__buffer.html#a26a473c691883e01ce4f747558b97a4d">b_ffname</a>, buf, dir_name);</div><div class="line"><a name="l04685"></a><span class="lineno"> 4685</span>&#160;</div><div class="line"><a name="l04686"></a><span class="lineno"> 4686</span>&#160;    <span class="keywordflow">for</span> (;;)</div><div class="line"><a name="l04687"></a><span class="lineno"> 4687</span>&#160;    {</div><div class="line"><a name="l04688"></a><span class="lineno"> 4688</span>&#160;    <span class="keywordflow">if</span> (fname == NULL)  <span class="comment">/* must be out of memory */</span></div><div class="line"><a name="l04689"></a><span class="lineno"> 4689</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l04690"></a><span class="lineno"> 4690</span>&#160;    <span class="keywordflow">if</span> ((n = (<span class="keywordtype">int</span>)<a class="code" href="vim_8h.html#a916ffefe1fc74532d08102cca55d8e34">STRLEN</a>(fname)) == 0)  <span class="comment">/* safety check */</span></div><div class="line"><a name="l04691"></a><span class="lineno"> 4691</span>&#160;    {</div><div class="line"><a name="l04692"></a><span class="lineno"> 4692</span>&#160;        <a class="code" href="macros_8h.html#a74420d7769a3c31521652566a1cdb094">VIM_CLEAR</a>(fname);</div><div class="line"><a name="l04693"></a><span class="lineno"> 4693</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l04694"></a><span class="lineno"> 4694</span>&#160;    }</div><div class="line"><a name="l04695"></a><span class="lineno"> 4695</span>&#160;<span class="preprocessor">#if defined(UNIX)</span></div><div class="line"><a name="l04696"></a><span class="lineno"> 4696</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l04697"></a><span class="lineno"> 4697</span>&#160;<span class="comment"> * Some systems have a MS-DOS compatible filesystem that use 8.3 character</span></div><div class="line"><a name="l04698"></a><span class="lineno"> 4698</span>&#160;<span class="comment"> * file names. If this is the first try and the swap file name does not fit in</span></div><div class="line"><a name="l04699"></a><span class="lineno"> 4699</span>&#160;<span class="comment"> * 8.3, detect if this is the case, set shortname and try again.</span></div><div class="line"><a name="l04700"></a><span class="lineno"> 4700</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l04701"></a><span class="lineno"> 4701</span>&#160;    <span class="keywordflow">if</span> (fname[n - 2] == <span class="charliteral">&#39;w&#39;</span> &amp;&amp; fname[n - 1] == <span class="charliteral">&#39;p&#39;</span></div><div class="line"><a name="l04702"></a><span class="lineno"> 4702</span>&#160;                    &amp;&amp; !(buf-&gt;<a class="code" href="structfile__buffer.html#aec6a0756665954537e932c6d1b8378a8">b_p_sn</a> || buf-&gt;<a class="code" href="structfile__buffer.html#abc07833d399f70595fd5e62404b876ad">b_shortname</a>))</div><div class="line"><a name="l04703"></a><span class="lineno"> 4703</span>&#160;    {</div><div class="line"><a name="l04704"></a><span class="lineno"> 4704</span>&#160;        char_u      *tail;</div><div class="line"><a name="l04705"></a><span class="lineno"> 4705</span>&#160;        char_u      *fname2;</div><div class="line"><a name="l04706"></a><span class="lineno"> 4706</span>&#160;        <a class="code" href="vim_8h.html#a3206c537c639e0f26013f6cf909bd0e0">stat_T</a>      s1, s2;</div><div class="line"><a name="l04707"></a><span class="lineno"> 4707</span>&#160;        <span class="keywordtype">int</span>         f1, f2;</div><div class="line"><a name="l04708"></a><span class="lineno"> 4708</span>&#160;        <span class="keywordtype">int</span>         created1 = <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, created2 = <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line"><a name="l04709"></a><span class="lineno"> 4709</span>&#160;        <span class="keywordtype">int</span>         same = <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line"><a name="l04710"></a><span class="lineno"> 4710</span>&#160;</div><div class="line"><a name="l04711"></a><span class="lineno"> 4711</span>&#160;        <span class="comment">/*</span></div><div class="line"><a name="l04712"></a><span class="lineno"> 4712</span>&#160;<span class="comment">         * Check if swapfile name does not fit in 8.3:</span></div><div class="line"><a name="l04713"></a><span class="lineno"> 4713</span>&#160;<span class="comment">         * It either contains two dots, is longer than 8 chars, or starts</span></div><div class="line"><a name="l04714"></a><span class="lineno"> 4714</span>&#160;<span class="comment">         * with a dot.</span></div><div class="line"><a name="l04715"></a><span class="lineno"> 4715</span>&#160;<span class="comment">         */</span></div><div class="line"><a name="l04716"></a><span class="lineno"> 4716</span>&#160;        tail = <a class="code" href="filepath_8c.html#a3a027a38b217222ac4d9ebe8ce5c1947">gettail</a>(buf_fname);</div><div class="line"><a name="l04717"></a><span class="lineno"> 4717</span>&#160;        <span class="keywordflow">if</span> (       <a class="code" href="misc2_8c.html#a8978cebac3b4ced66551e67c3a375842">vim_strchr</a>(tail, <span class="charliteral">&#39;.&#39;</span>) != NULL</div><div class="line"><a name="l04718"></a><span class="lineno"> 4718</span>&#160;            || <a class="code" href="vim_8h.html#a916ffefe1fc74532d08102cca55d8e34">STRLEN</a>(tail) &gt; (<span class="keywordtype">size_t</span>)8</div><div class="line"><a name="l04719"></a><span class="lineno"> 4719</span>&#160;            || *<a class="code" href="filepath_8c.html#a3a027a38b217222ac4d9ebe8ce5c1947">gettail</a>(fname) == <span class="charliteral">&#39;.&#39;</span>)</div><div class="line"><a name="l04720"></a><span class="lineno"> 4720</span>&#160;        {</div><div class="line"><a name="l04721"></a><span class="lineno"> 4721</span>&#160;        fname2 = <a class="code" href="misc2_8c.html#ad0b64e14955781629a3908e328f82665">alloc</a>(n + 2);</div><div class="line"><a name="l04722"></a><span class="lineno"> 4722</span>&#160;        <span class="keywordflow">if</span> (fname2 != NULL)</div><div class="line"><a name="l04723"></a><span class="lineno"> 4723</span>&#160;        {</div><div class="line"><a name="l04724"></a><span class="lineno"> 4724</span>&#160;            <a class="code" href="vim_8h.html#aa9cea5fcb1483307770f365fb24aa08d">STRCPY</a>(fname2, fname);</div><div class="line"><a name="l04725"></a><span class="lineno"> 4725</span>&#160;            <span class="comment">/* if fname == &quot;xx.xx.swp&quot;,     fname2 = &quot;xx.xx.swx&quot;</span></div><div class="line"><a name="l04726"></a><span class="lineno"> 4726</span>&#160;<span class="comment">             * if fname == &quot;.xx.swp&quot;,       fname2 = &quot;.xx.swpx&quot;</span></div><div class="line"><a name="l04727"></a><span class="lineno"> 4727</span>&#160;<span class="comment">             * if fname == &quot;123456789.swp&quot;, fname2 = &quot;12345678x.swp&quot;</span></div><div class="line"><a name="l04728"></a><span class="lineno"> 4728</span>&#160;<span class="comment">             */</span></div><div class="line"><a name="l04729"></a><span class="lineno"> 4729</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="misc2_8c.html#a8978cebac3b4ced66551e67c3a375842">vim_strchr</a>(tail, <span class="charliteral">&#39;.&#39;</span>) != NULL)</div><div class="line"><a name="l04730"></a><span class="lineno"> 4730</span>&#160;            fname2[n - 1] = <span class="charliteral">&#39;x&#39;</span>;</div><div class="line"><a name="l04731"></a><span class="lineno"> 4731</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*<a class="code" href="filepath_8c.html#a3a027a38b217222ac4d9ebe8ce5c1947">gettail</a>(fname) == <span class="charliteral">&#39;.&#39;</span>)</div><div class="line"><a name="l04732"></a><span class="lineno"> 4732</span>&#160;            {</div><div class="line"><a name="l04733"></a><span class="lineno"> 4733</span>&#160;            fname2[n] = <span class="charliteral">&#39;x&#39;</span>;</div><div class="line"><a name="l04734"></a><span class="lineno"> 4734</span>&#160;            fname2[n + 1] = <a class="code" href="ascii_8h.html#af19d48b9f61047a668649a2f9dc317ff">NUL</a>;</div><div class="line"><a name="l04735"></a><span class="lineno"> 4735</span>&#160;            }</div><div class="line"><a name="l04736"></a><span class="lineno"> 4736</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l04737"></a><span class="lineno"> 4737</span>&#160;            fname2[n - 5] += 1;</div><div class="line"><a name="l04738"></a><span class="lineno"> 4738</span>&#160;            <span class="comment">/*</span></div><div class="line"><a name="l04739"></a><span class="lineno"> 4739</span>&#160;<span class="comment">             * may need to create the files to be able to use mch_stat()</span></div><div class="line"><a name="l04740"></a><span class="lineno"> 4740</span>&#160;<span class="comment">             */</span></div><div class="line"><a name="l04741"></a><span class="lineno"> 4741</span>&#160;            f1 = <a class="code" href="os__win32_8c.html#a86a6c2e2a013622ad468bcdbc07bbfd6">mch_open</a>((<span class="keywordtype">char</span> *)fname, O_RDONLY | <a class="code" href="vim_8h.html#a9f1019b10a1c51d588f4500cde3a6746">O_EXTRA</a>, 0);</div><div class="line"><a name="l04742"></a><span class="lineno"> 4742</span>&#160;            <span class="keywordflow">if</span> (f1 &lt; 0)</div><div class="line"><a name="l04743"></a><span class="lineno"> 4743</span>&#160;            {</div><div class="line"><a name="l04744"></a><span class="lineno"> 4744</span>&#160;            f1 = <a class="code" href="macros_8h.html#a06cefeb085cb44bd960567445ae3766a">mch_open_rw</a>((<span class="keywordtype">char</span> *)fname,</div><div class="line"><a name="l04745"></a><span class="lineno"> 4745</span>&#160;                           O_RDWR|O_CREAT|O_EXCL|<a class="code" href="vim_8h.html#a9f1019b10a1c51d588f4500cde3a6746">O_EXTRA</a>);</div><div class="line"><a name="l04746"></a><span class="lineno"> 4746</span>&#160;            created1 = <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"><a name="l04747"></a><span class="lineno"> 4747</span>&#160;            }</div><div class="line"><a name="l04748"></a><span class="lineno"> 4748</span>&#160;            <span class="keywordflow">if</span> (f1 &gt;= 0)</div><div class="line"><a name="l04749"></a><span class="lineno"> 4749</span>&#160;            {</div><div class="line"><a name="l04750"></a><span class="lineno"> 4750</span>&#160;            f2 = <a class="code" href="os__win32_8c.html#a86a6c2e2a013622ad468bcdbc07bbfd6">mch_open</a>((<span class="keywordtype">char</span> *)fname2, O_RDONLY | <a class="code" href="vim_8h.html#a9f1019b10a1c51d588f4500cde3a6746">O_EXTRA</a>, 0);</div><div class="line"><a name="l04751"></a><span class="lineno"> 4751</span>&#160;            <span class="keywordflow">if</span> (f2 &lt; 0)</div><div class="line"><a name="l04752"></a><span class="lineno"> 4752</span>&#160;            {</div><div class="line"><a name="l04753"></a><span class="lineno"> 4753</span>&#160;                f2 = <a class="code" href="macros_8h.html#a06cefeb085cb44bd960567445ae3766a">mch_open_rw</a>((<span class="keywordtype">char</span> *)fname2,</div><div class="line"><a name="l04754"></a><span class="lineno"> 4754</span>&#160;                           O_RDWR|O_CREAT|O_EXCL|<a class="code" href="vim_8h.html#a9f1019b10a1c51d588f4500cde3a6746">O_EXTRA</a>);</div><div class="line"><a name="l04755"></a><span class="lineno"> 4755</span>&#160;                created2 = <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"><a name="l04756"></a><span class="lineno"> 4756</span>&#160;            }</div><div class="line"><a name="l04757"></a><span class="lineno"> 4757</span>&#160;            <span class="keywordflow">if</span> (f2 &gt;= 0)</div><div class="line"><a name="l04758"></a><span class="lineno"> 4758</span>&#160;            {</div><div class="line"><a name="l04759"></a><span class="lineno"> 4759</span>&#160;                <span class="comment">/*</span></div><div class="line"><a name="l04760"></a><span class="lineno"> 4760</span>&#160;<span class="comment">                 * Both files exist now. If mch_stat() returns the</span></div><div class="line"><a name="l04761"></a><span class="lineno"> 4761</span>&#160;<span class="comment">                 * same device and inode they are the same file.</span></div><div class="line"><a name="l04762"></a><span class="lineno"> 4762</span>&#160;<span class="comment">                 */</span></div><div class="line"><a name="l04763"></a><span class="lineno"> 4763</span>&#160;                <span class="keywordflow">if</span> (<a class="code" href="macros_8h.html#a4e3dc19b42c157041ac2194f58111c3c">mch_fstat</a>(f1, &amp;s1) != -1</div><div class="line"><a name="l04764"></a><span class="lineno"> 4764</span>&#160;                    &amp;&amp; <a class="code" href="macros_8h.html#a4e3dc19b42c157041ac2194f58111c3c">mch_fstat</a>(f2, &amp;s2) != -1</div><div class="line"><a name="l04765"></a><span class="lineno"> 4765</span>&#160;                    &amp;&amp; s1.st_dev == s2.st_dev</div><div class="line"><a name="l04766"></a><span class="lineno"> 4766</span>&#160;                    &amp;&amp; s1.st_ino == s2.st_ino)</div><div class="line"><a name="l04767"></a><span class="lineno"> 4767</span>&#160;                same = <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"><a name="l04768"></a><span class="lineno"> 4768</span>&#160;                close(f2);</div><div class="line"><a name="l04769"></a><span class="lineno"> 4769</span>&#160;                <span class="keywordflow">if</span> (created2)</div><div class="line"><a name="l04770"></a><span class="lineno"> 4770</span>&#160;                <a class="code" href="os__win32_8c.html#a288b0d3b5efd2d0257cfe8e9e4f647a1">mch_remove</a>(fname2);</div><div class="line"><a name="l04771"></a><span class="lineno"> 4771</span>&#160;            }</div><div class="line"><a name="l04772"></a><span class="lineno"> 4772</span>&#160;            close(f1);</div><div class="line"><a name="l04773"></a><span class="lineno"> 4773</span>&#160;            <span class="keywordflow">if</span> (created1)</div><div class="line"><a name="l04774"></a><span class="lineno"> 4774</span>&#160;                <a class="code" href="os__win32_8c.html#a288b0d3b5efd2d0257cfe8e9e4f647a1">mch_remove</a>(fname);</div><div class="line"><a name="l04775"></a><span class="lineno"> 4775</span>&#160;            }</div><div class="line"><a name="l04776"></a><span class="lineno"> 4776</span>&#160;            <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(fname2);</div><div class="line"><a name="l04777"></a><span class="lineno"> 4777</span>&#160;            <span class="keywordflow">if</span> (same)</div><div class="line"><a name="l04778"></a><span class="lineno"> 4778</span>&#160;            {</div><div class="line"><a name="l04779"></a><span class="lineno"> 4779</span>&#160;            buf-&gt;<a class="code" href="structfile__buffer.html#abc07833d399f70595fd5e62404b876ad">b_shortname</a> = <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"><a name="l04780"></a><span class="lineno"> 4780</span>&#160;            <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(fname);</div><div class="line"><a name="l04781"></a><span class="lineno"> 4781</span>&#160;            fname = <a class="code" href="memline_8c.html#acf7020b3158145c4a34278f766dbb08e">makeswapname</a>(buf_fname, buf-&gt;<a class="code" href="structfile__buffer.html#a26a473c691883e01ce4f747558b97a4d">b_ffname</a>,</div><div class="line"><a name="l04782"></a><span class="lineno"> 4782</span>&#160;                                   buf, dir_name);</div><div class="line"><a name="l04783"></a><span class="lineno"> 4783</span>&#160;            <span class="keywordflow">continue</span>;   <span class="comment">/* try again with b_shortname set */</span></div><div class="line"><a name="l04784"></a><span class="lineno"> 4784</span>&#160;            }</div><div class="line"><a name="l04785"></a><span class="lineno"> 4785</span>&#160;        }</div><div class="line"><a name="l04786"></a><span class="lineno"> 4786</span>&#160;        }</div><div class="line"><a name="l04787"></a><span class="lineno"> 4787</span>&#160;    }</div><div class="line"><a name="l04788"></a><span class="lineno"> 4788</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l04789"></a><span class="lineno"> 4789</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l04790"></a><span class="lineno"> 4790</span>&#160;<span class="comment">     * check if the swapfile already exists</span></div><div class="line"><a name="l04791"></a><span class="lineno"> 4791</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l04792"></a><span class="lineno"> 4792</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="os__amiga_8c.html#a7e689f4e37bb4db880dae0d37452f7de">mch_getperm</a>(fname) &lt; 0) <span class="comment">/* it does not exist */</span></div><div class="line"><a name="l04793"></a><span class="lineno"> 4793</span>&#160;    {</div><div class="line"><a name="l04794"></a><span class="lineno"> 4794</span>&#160;<span class="preprocessor">#ifdef HAVE_LSTAT</span></div><div class="line"><a name="l04795"></a><span class="lineno"> 4795</span>&#160;        <a class="code" href="vim_8h.html#a3206c537c639e0f26013f6cf909bd0e0">stat_T</a>  sb;</div><div class="line"><a name="l04796"></a><span class="lineno"> 4796</span>&#160;</div><div class="line"><a name="l04797"></a><span class="lineno"> 4797</span>&#160;        <span class="comment">/*</span></div><div class="line"><a name="l04798"></a><span class="lineno"> 4798</span>&#160;<span class="comment">         * Extra security check: When a swap file is a symbolic link, this</span></div><div class="line"><a name="l04799"></a><span class="lineno"> 4799</span>&#160;<span class="comment">         * is most likely a symlink attack.</span></div><div class="line"><a name="l04800"></a><span class="lineno"> 4800</span>&#160;<span class="comment">         */</span></div><div class="line"><a name="l04801"></a><span class="lineno"> 4801</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="macros_8h.html#ac6bdfcb1fe7df56a18ffc5cf62ca1168">mch_lstat</a>((<span class="keywordtype">char</span> *)fname, &amp;sb) &lt; 0)</div><div class="line"><a name="l04802"></a><span class="lineno"> 4802</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l04803"></a><span class="lineno"> 4803</span>&#160;<span class="preprocessor"># ifdef AMIGA</span></div><div class="line"><a name="l04804"></a><span class="lineno"> 4804</span>&#160;        fh = Open((UBYTE *)fname, (<span class="keywordtype">long</span>)MODE_NEWFILE);</div><div class="line"><a name="l04805"></a><span class="lineno"> 4805</span>&#160;        <span class="comment">/*</span></div><div class="line"><a name="l04806"></a><span class="lineno"> 4806</span>&#160;<span class="comment">         * on the Amiga mch_getperm() will return -1 when the file exists</span></div><div class="line"><a name="l04807"></a><span class="lineno"> 4807</span>&#160;<span class="comment">         * but is being used by another program. This happens if you edit</span></div><div class="line"><a name="l04808"></a><span class="lineno"> 4808</span>&#160;<span class="comment">         * a file twice.</span></div><div class="line"><a name="l04809"></a><span class="lineno"> 4809</span>&#160;<span class="comment">         */</span></div><div class="line"><a name="l04810"></a><span class="lineno"> 4810</span>&#160;        <span class="keywordflow">if</span> (fh != (BPTR)NULL)   <span class="comment">/* can open file, OK */</span></div><div class="line"><a name="l04811"></a><span class="lineno"> 4811</span>&#160;        {</div><div class="line"><a name="l04812"></a><span class="lineno"> 4812</span>&#160;        Close(fh);</div><div class="line"><a name="l04813"></a><span class="lineno"> 4813</span>&#160;        <a class="code" href="os__win32_8c.html#a288b0d3b5efd2d0257cfe8e9e4f647a1">mch_remove</a>(fname);</div><div class="line"><a name="l04814"></a><span class="lineno"> 4814</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l04815"></a><span class="lineno"> 4815</span>&#160;        }</div><div class="line"><a name="l04816"></a><span class="lineno"> 4816</span>&#160;        <span class="keywordflow">if</span> (IoErr() != ERROR_OBJECT_IN_USE</div><div class="line"><a name="l04817"></a><span class="lineno"> 4817</span>&#160;                        &amp;&amp; IoErr() != ERROR_OBJECT_EXISTS)</div><div class="line"><a name="l04818"></a><span class="lineno"> 4818</span>&#160;<span class="preprocessor"># endif</span></div><div class="line"><a name="l04819"></a><span class="lineno"> 4819</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l04820"></a><span class="lineno"> 4820</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l04821"></a><span class="lineno"> 4821</span>&#160;    }</div><div class="line"><a name="l04822"></a><span class="lineno"> 4822</span>&#160;</div><div class="line"><a name="l04823"></a><span class="lineno"> 4823</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l04824"></a><span class="lineno"> 4824</span>&#160;<span class="comment">     * A file name equal to old_fname is OK to use.</span></div><div class="line"><a name="l04825"></a><span class="lineno"> 4825</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l04826"></a><span class="lineno"> 4826</span>&#160;    <span class="keywordflow">if</span> (old_fname != NULL &amp;&amp; <a class="code" href="vim_8h.html#a74e72b20fdc634f1981f0e0b503368e9">fnamecmp</a>(fname, old_fname) == 0)</div><div class="line"><a name="l04827"></a><span class="lineno"> 4827</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l04828"></a><span class="lineno"> 4828</span>&#160;</div><div class="line"><a name="l04829"></a><span class="lineno"> 4829</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l04830"></a><span class="lineno"> 4830</span>&#160;<span class="comment">     * get here when file already exists</span></div><div class="line"><a name="l04831"></a><span class="lineno"> 4831</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l04832"></a><span class="lineno"> 4832</span>&#160;    <span class="keywordflow">if</span> (fname[n - 2] == <span class="charliteral">&#39;w&#39;</span> &amp;&amp; fname[n - 1] == <span class="charliteral">&#39;p&#39;</span>) <span class="comment">/* first try */</span></div><div class="line"><a name="l04833"></a><span class="lineno"> 4833</span>&#160;    {</div><div class="line"><a name="l04834"></a><span class="lineno"> 4834</span>&#160;        <span class="comment">/*</span></div><div class="line"><a name="l04835"></a><span class="lineno"> 4835</span>&#160;<span class="comment">         * on MS-DOS compatible filesystems (e.g. messydos) file.doc.swp</span></div><div class="line"><a name="l04836"></a><span class="lineno"> 4836</span>&#160;<span class="comment">         * and file.doc are the same file. To guess if this problem is</span></div><div class="line"><a name="l04837"></a><span class="lineno"> 4837</span>&#160;<span class="comment">         * present try if file.doc.swx exists. If it does, we set</span></div><div class="line"><a name="l04838"></a><span class="lineno"> 4838</span>&#160;<span class="comment">         * buf-&gt;b_shortname and try file_doc.swp (dots replaced by</span></div><div class="line"><a name="l04839"></a><span class="lineno"> 4839</span>&#160;<span class="comment">         * underscores for this file), and try again. If it doesn&#39;t we</span></div><div class="line"><a name="l04840"></a><span class="lineno"> 4840</span>&#160;<span class="comment">         * assume that &quot;file.doc.swp&quot; already exists.</span></div><div class="line"><a name="l04841"></a><span class="lineno"> 4841</span>&#160;<span class="comment">         */</span></div><div class="line"><a name="l04842"></a><span class="lineno"> 4842</span>&#160;        <span class="keywordflow">if</span> (!(buf-&gt;<a class="code" href="structfile__buffer.html#aec6a0756665954537e932c6d1b8378a8">b_p_sn</a> || buf-&gt;<a class="code" href="structfile__buffer.html#abc07833d399f70595fd5e62404b876ad">b_shortname</a>)) <span class="comment">/* not tried yet */</span></div><div class="line"><a name="l04843"></a><span class="lineno"> 4843</span>&#160;        {</div><div class="line"><a name="l04844"></a><span class="lineno"> 4844</span>&#160;        fname[n - 1] = <span class="charliteral">&#39;x&#39;</span>;</div><div class="line"><a name="l04845"></a><span class="lineno"> 4845</span>&#160;        r = <a class="code" href="os__amiga_8c.html#a7e689f4e37bb4db880dae0d37452f7de">mch_getperm</a>(fname);     <span class="comment">/* try &quot;file.swx&quot; */</span></div><div class="line"><a name="l04846"></a><span class="lineno"> 4846</span>&#160;        fname[n - 1] = <span class="charliteral">&#39;p&#39;</span>;</div><div class="line"><a name="l04847"></a><span class="lineno"> 4847</span>&#160;        <span class="keywordflow">if</span> (r &gt;= 0)         <span class="comment">/* &quot;file.swx&quot; seems to exist */</span></div><div class="line"><a name="l04848"></a><span class="lineno"> 4848</span>&#160;        {</div><div class="line"><a name="l04849"></a><span class="lineno"> 4849</span>&#160;            buf-&gt;<a class="code" href="structfile__buffer.html#abc07833d399f70595fd5e62404b876ad">b_shortname</a> = <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"><a name="l04850"></a><span class="lineno"> 4850</span>&#160;            <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(fname);</div><div class="line"><a name="l04851"></a><span class="lineno"> 4851</span>&#160;            fname = <a class="code" href="memline_8c.html#acf7020b3158145c4a34278f766dbb08e">makeswapname</a>(buf_fname, buf-&gt;<a class="code" href="structfile__buffer.html#a26a473c691883e01ce4f747558b97a4d">b_ffname</a>,</div><div class="line"><a name="l04852"></a><span class="lineno"> 4852</span>&#160;                                   buf, dir_name);</div><div class="line"><a name="l04853"></a><span class="lineno"> 4853</span>&#160;            <span class="keywordflow">continue</span>;       <span class="comment">/* try again with &#39;.&#39; replaced with &#39;_&#39; */</span></div><div class="line"><a name="l04854"></a><span class="lineno"> 4854</span>&#160;        }</div><div class="line"><a name="l04855"></a><span class="lineno"> 4855</span>&#160;        }</div><div class="line"><a name="l04856"></a><span class="lineno"> 4856</span>&#160;        <span class="comment">/*</span></div><div class="line"><a name="l04857"></a><span class="lineno"> 4857</span>&#160;<span class="comment">         * If we get here the &quot;.swp&quot; file really exists.</span></div><div class="line"><a name="l04858"></a><span class="lineno"> 4858</span>&#160;<span class="comment">         * Give an error message, unless recovering, no file name, we are</span></div><div class="line"><a name="l04859"></a><span class="lineno"> 4859</span>&#160;<span class="comment">         * viewing a help file or when the path of the file is different</span></div><div class="line"><a name="l04860"></a><span class="lineno"> 4860</span>&#160;<span class="comment">         * (happens when all .swp files are in one directory).</span></div><div class="line"><a name="l04861"></a><span class="lineno"> 4861</span>&#160;<span class="comment">         */</span></div><div class="line"><a name="l04862"></a><span class="lineno"> 4862</span>&#160;        <span class="keywordflow">if</span> (!recoverymode &amp;&amp; buf_fname != NULL</div><div class="line"><a name="l04863"></a><span class="lineno"> 4863</span>&#160;                &amp;&amp; !buf-&gt;<a class="code" href="structfile__buffer.html#a0be7352b0a40127537e76ea4a8449c13">b_help</a></div><div class="line"><a name="l04864"></a><span class="lineno"> 4864</span>&#160;                &amp;&amp; !(buf-&gt;<a class="code" href="structfile__buffer.html#a82e1f497c5a51eff88502f03dd1cd5c3">b_flags</a> &amp; (<a class="code" href="vim_8h.html#a42c849fb8f0be76ced2823ef6cff5174">BF_DUMMY</a> | <a class="code" href="vim_8h.html#a8041520d32390bb51c3e955506efd206">BF_NO_SEA</a>)))</div><div class="line"><a name="l04865"></a><span class="lineno"> 4865</span>&#160;        {</div><div class="line"><a name="l04866"></a><span class="lineno"> 4866</span>&#160;        <span class="keywordtype">int</span>     fd;</div><div class="line"><a name="l04867"></a><span class="lineno"> 4867</span>&#160;        <span class="keyword">struct </span><a class="code" href="structblock0.html">block0</a>   b0;</div><div class="line"><a name="l04868"></a><span class="lineno"> 4868</span>&#160;        <span class="keywordtype">int</span>     differ = <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line"><a name="l04869"></a><span class="lineno"> 4869</span>&#160;</div><div class="line"><a name="l04870"></a><span class="lineno"> 4870</span>&#160;        <span class="comment">/*</span></div><div class="line"><a name="l04871"></a><span class="lineno"> 4871</span>&#160;<span class="comment">         * Try to read block 0 from the swap file to get the original</span></div><div class="line"><a name="l04872"></a><span class="lineno"> 4872</span>&#160;<span class="comment">         * file name (and inode number).</span></div><div class="line"><a name="l04873"></a><span class="lineno"> 4873</span>&#160;<span class="comment">         */</span></div><div class="line"><a name="l04874"></a><span class="lineno"> 4874</span>&#160;        fd = <a class="code" href="os__win32_8c.html#a86a6c2e2a013622ad468bcdbc07bbfd6">mch_open</a>((<span class="keywordtype">char</span> *)fname, O_RDONLY | <a class="code" href="vim_8h.html#a9f1019b10a1c51d588f4500cde3a6746">O_EXTRA</a>, 0);</div><div class="line"><a name="l04875"></a><span class="lineno"> 4875</span>&#160;        <span class="keywordflow">if</span> (fd &gt;= 0)</div><div class="line"><a name="l04876"></a><span class="lineno"> 4876</span>&#160;        {</div><div class="line"><a name="l04877"></a><span class="lineno"> 4877</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="vim_8h.html#aad0d6768ce2f916f7c643be49f87a368">read_eintr</a>(fd, &amp;b0, <span class="keyword">sizeof</span>(b0)) == <span class="keyword">sizeof</span>(b0))</div><div class="line"><a name="l04878"></a><span class="lineno"> 4878</span>&#160;            {</div><div class="line"><a name="l04879"></a><span class="lineno"> 4879</span>&#160;            <span class="comment">/*</span></div><div class="line"><a name="l04880"></a><span class="lineno"> 4880</span>&#160;<span class="comment">             * If the swapfile has the same directory as the</span></div><div class="line"><a name="l04881"></a><span class="lineno"> 4881</span>&#160;<span class="comment">             * buffer don&#39;t compare the directory names, they can</span></div><div class="line"><a name="l04882"></a><span class="lineno"> 4882</span>&#160;<span class="comment">             * have a different mountpoint.</span></div><div class="line"><a name="l04883"></a><span class="lineno"> 4883</span>&#160;<span class="comment">             */</span></div><div class="line"><a name="l04884"></a><span class="lineno"> 4884</span>&#160;            <span class="keywordflow">if</span> (b0.b0_flags &amp; <a class="code" href="memline_8c.html#a47709ebb68758a4b1db1a5205761c146">B0_SAME_DIR</a>)</div><div class="line"><a name="l04885"></a><span class="lineno"> 4885</span>&#160;            {</div><div class="line"><a name="l04886"></a><span class="lineno"> 4886</span>&#160;                <span class="keywordflow">if</span> (<a class="code" href="vim_8h.html#a74e72b20fdc634f1981f0e0b503368e9">fnamecmp</a>(<a class="code" href="filepath_8c.html#a3a027a38b217222ac4d9ebe8ce5c1947">gettail</a>(buf-&gt;<a class="code" href="structfile__buffer.html#a26a473c691883e01ce4f747558b97a4d">b_ffname</a>),</div><div class="line"><a name="l04887"></a><span class="lineno"> 4887</span>&#160;                           <a class="code" href="filepath_8c.html#a3a027a38b217222ac4d9ebe8ce5c1947">gettail</a>(b0.<a class="code" href="structblock0.html#a619635d3effa9f2496dd6662e20b9037">b0_fname</a>)) != 0</div><div class="line"><a name="l04888"></a><span class="lineno"> 4888</span>&#160;                    || !<a class="code" href="misc2_8c.html#a7bbb60cf940e6fbc12e0ecd4e124c5c0">same_directory</a>(fname, buf-&gt;<a class="code" href="structfile__buffer.html#a26a473c691883e01ce4f747558b97a4d">b_ffname</a>))</div><div class="line"><a name="l04889"></a><span class="lineno"> 4889</span>&#160;                {</div><div class="line"><a name="l04890"></a><span class="lineno"> 4890</span>&#160;<span class="preprocessor">#ifdef CHECK_INODE</span></div><div class="line"><a name="l04891"></a><span class="lineno"> 4891</span>&#160;                <span class="comment">/* Symlinks may point to the same file even</span></div><div class="line"><a name="l04892"></a><span class="lineno"> 4892</span>&#160;<span class="comment">                 * when the name differs, need to check the</span></div><div class="line"><a name="l04893"></a><span class="lineno"> 4893</span>&#160;<span class="comment">                 * inode too. */</span></div><div class="line"><a name="l04894"></a><span class="lineno"> 4894</span>&#160;                <a class="code" href="misc1_8c.html#aa192be148db96758033a23beacbd8ffe">expand_env</a>(b0.<a class="code" href="structblock0.html#a619635d3effa9f2496dd6662e20b9037">b0_fname</a>, <a class="code" href="globals_8h.html#a337deb9cd3b0e40e369a0618282ed5a7">NameBuff</a>, <a class="code" href="os__unix_8h.html#a9b75f9db03a33bb3d2d613923647d0cf">MAXPATHL</a>);</div><div class="line"><a name="l04895"></a><span class="lineno"> 4895</span>&#160;                <span class="keywordflow">if</span> (fnamecmp_ino(buf-&gt;<a class="code" href="structfile__buffer.html#a26a473c691883e01ce4f747558b97a4d">b_ffname</a>, <a class="code" href="globals_8h.html#a337deb9cd3b0e40e369a0618282ed5a7">NameBuff</a>,</div><div class="line"><a name="l04896"></a><span class="lineno"> 4896</span>&#160;                             <a class="code" href="memline_8c.html#a996b07c0a0e4f04f7b205f4c3ba2a797">char_to_long</a>(b0.<a class="code" href="structblock0.html#a3930b3adc922aba997caf28ad8d8e6a4">b0_ino</a>)))</div><div class="line"><a name="l04897"></a><span class="lineno"> 4897</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l04898"></a><span class="lineno"> 4898</span>&#160;                    differ = <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"><a name="l04899"></a><span class="lineno"> 4899</span>&#160;                }</div><div class="line"><a name="l04900"></a><span class="lineno"> 4900</span>&#160;            }</div><div class="line"><a name="l04901"></a><span class="lineno"> 4901</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l04902"></a><span class="lineno"> 4902</span>&#160;            {</div><div class="line"><a name="l04903"></a><span class="lineno"> 4903</span>&#160;                <span class="comment">/*</span></div><div class="line"><a name="l04904"></a><span class="lineno"> 4904</span>&#160;<span class="comment">                 * The name in the swap file may be</span></div><div class="line"><a name="l04905"></a><span class="lineno"> 4905</span>&#160;<span class="comment">                 * &quot;~user/path/file&quot;.  Expand it first.</span></div><div class="line"><a name="l04906"></a><span class="lineno"> 4906</span>&#160;<span class="comment">                 */</span></div><div class="line"><a name="l04907"></a><span class="lineno"> 4907</span>&#160;                <a class="code" href="misc1_8c.html#aa192be148db96758033a23beacbd8ffe">expand_env</a>(b0.<a class="code" href="structblock0.html#a619635d3effa9f2496dd6662e20b9037">b0_fname</a>, <a class="code" href="globals_8h.html#a337deb9cd3b0e40e369a0618282ed5a7">NameBuff</a>, <a class="code" href="os__unix_8h.html#a9b75f9db03a33bb3d2d613923647d0cf">MAXPATHL</a>);</div><div class="line"><a name="l04908"></a><span class="lineno"> 4908</span>&#160;<span class="preprocessor">#ifdef CHECK_INODE</span></div><div class="line"><a name="l04909"></a><span class="lineno"> 4909</span>&#160;                <span class="keywordflow">if</span> (fnamecmp_ino(buf-&gt;<a class="code" href="structfile__buffer.html#a26a473c691883e01ce4f747558b97a4d">b_ffname</a>, <a class="code" href="globals_8h.html#a337deb9cd3b0e40e369a0618282ed5a7">NameBuff</a>,</div><div class="line"><a name="l04910"></a><span class="lineno"> 4910</span>&#160;                             <a class="code" href="memline_8c.html#a996b07c0a0e4f04f7b205f4c3ba2a797">char_to_long</a>(b0.<a class="code" href="structblock0.html#a3930b3adc922aba997caf28ad8d8e6a4">b0_ino</a>)))</div><div class="line"><a name="l04911"></a><span class="lineno"> 4911</span>&#160;                differ = <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"><a name="l04912"></a><span class="lineno"> 4912</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l04913"></a><span class="lineno"> 4913</span>&#160;                <span class="keywordflow">if</span> (<a class="code" href="vim_8h.html#a74e72b20fdc634f1981f0e0b503368e9">fnamecmp</a>(<a class="code" href="globals_8h.html#a337deb9cd3b0e40e369a0618282ed5a7">NameBuff</a>, buf-&gt;<a class="code" href="structfile__buffer.html#a26a473c691883e01ce4f747558b97a4d">b_ffname</a>) != 0)</div><div class="line"><a name="l04914"></a><span class="lineno"> 4914</span>&#160;                differ = <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"><a name="l04915"></a><span class="lineno"> 4915</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l04916"></a><span class="lineno"> 4916</span>&#160;            }</div><div class="line"><a name="l04917"></a><span class="lineno"> 4917</span>&#160;            }</div><div class="line"><a name="l04918"></a><span class="lineno"> 4918</span>&#160;            close(fd);</div><div class="line"><a name="l04919"></a><span class="lineno"> 4919</span>&#160;        }</div><div class="line"><a name="l04920"></a><span class="lineno"> 4920</span>&#160;</div><div class="line"><a name="l04921"></a><span class="lineno"> 4921</span>&#160;        <span class="comment">/* give the ATTENTION message when there is an old swap file</span></div><div class="line"><a name="l04922"></a><span class="lineno"> 4922</span>&#160;<span class="comment">         * for the current file, and the buffer was not recovered. */</span></div><div class="line"><a name="l04923"></a><span class="lineno"> 4923</span>&#160;        <span class="keywordflow">if</span> (differ == <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a> &amp;&amp; !(curbuf-&gt;b_flags &amp; <a class="code" href="vim_8h.html#acc0703dad0b379b34be226e2402937db">BF_RECOVERED</a>)</div><div class="line"><a name="l04924"></a><span class="lineno"> 4924</span>&#160;            &amp;&amp; <a class="code" href="misc2_8c.html#a8978cebac3b4ced66551e67c3a375842">vim_strchr</a>(<a class="code" href="option_8h.html#a648216422e032905dfd91f01195ab459">p_shm</a>, <a class="code" href="option_8h.html#a4067a59443206ab22efad3fc618a8f4e">SHM_ATTENTION</a>) == NULL)</div><div class="line"><a name="l04925"></a><span class="lineno"> 4925</span>&#160;        {</div><div class="line"><a name="l04926"></a><span class="lineno"> 4926</span>&#160;            <span class="keywordtype">int</span>     <a class="code" href="structchoice.html">choice</a> = 0;</div><div class="line"><a name="l04927"></a><span class="lineno"> 4927</span>&#160;            <a class="code" href="vim_8h.html#a3206c537c639e0f26013f6cf909bd0e0">stat_T</a>  st;</div><div class="line"><a name="l04928"></a><span class="lineno"> 4928</span>&#160;<span class="preprocessor">#ifdef CREATE_DUMMY_FILE</span></div><div class="line"><a name="l04929"></a><span class="lineno"> 4929</span>&#160;            <span class="keywordtype">int</span>     did_use_dummy = <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line"><a name="l04930"></a><span class="lineno"> 4930</span>&#160;</div><div class="line"><a name="l04931"></a><span class="lineno"> 4931</span>&#160;            <span class="comment">/* Avoid getting a warning for the file being created</span></div><div class="line"><a name="l04932"></a><span class="lineno"> 4932</span>&#160;<span class="comment">             * outside of Vim, it was created at the start of this</span></div><div class="line"><a name="l04933"></a><span class="lineno"> 4933</span>&#160;<span class="comment">             * function.  Delete the file now, because Vim might exit</span></div><div class="line"><a name="l04934"></a><span class="lineno"> 4934</span>&#160;<span class="comment">             * here if the window is closed. */</span></div><div class="line"><a name="l04935"></a><span class="lineno"> 4935</span>&#160;            <span class="keywordflow">if</span> (dummyfd != NULL)</div><div class="line"><a name="l04936"></a><span class="lineno"> 4936</span>&#160;            {</div><div class="line"><a name="l04937"></a><span class="lineno"> 4937</span>&#160;            fclose(dummyfd);</div><div class="line"><a name="l04938"></a><span class="lineno"> 4938</span>&#160;            dummyfd = NULL;</div><div class="line"><a name="l04939"></a><span class="lineno"> 4939</span>&#160;            <a class="code" href="os__win32_8c.html#a288b0d3b5efd2d0257cfe8e9e4f647a1">mch_remove</a>(buf_fname);</div><div class="line"><a name="l04940"></a><span class="lineno"> 4940</span>&#160;            did_use_dummy = <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"><a name="l04941"></a><span class="lineno"> 4941</span>&#160;            }</div><div class="line"><a name="l04942"></a><span class="lineno"> 4942</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l04943"></a><span class="lineno"> 4943</span>&#160;</div><div class="line"><a name="l04944"></a><span class="lineno"> 4944</span>&#160;<span class="preprocessor">#ifdef HAVE_PROCESS_STILL_RUNNING</span></div><div class="line"><a name="l04945"></a><span class="lineno"> 4945</span>&#160;            process_still_running = <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line"><a name="l04946"></a><span class="lineno"> 4946</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l04947"></a><span class="lineno"> 4947</span>&#160;            <span class="comment">// It&#39;s safe to delete the swap file if all these are true:</span></div><div class="line"><a name="l04948"></a><span class="lineno"> 4948</span>&#160;            <span class="comment">// - the edited file exists</span></div><div class="line"><a name="l04949"></a><span class="lineno"> 4949</span>&#160;            <span class="comment">// - the swap file has no changes and looks OK</span></div><div class="line"><a name="l04950"></a><span class="lineno"> 4950</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="macros_8h.html#af9221f9667cc05a05b4646b2aa31e233">mch_stat</a>((<span class="keywordtype">char</span> *)buf-&gt;<a class="code" href="structfile__buffer.html#a34a7c5a6d702c7ce0181584242976f3e">b_fname</a>, &amp;st) == 0</div><div class="line"><a name="l04951"></a><span class="lineno"> 4951</span>&#160;                          &amp;&amp; <a class="code" href="memline_8c.html#a6767d25cbd7796ae962252124f65a557">swapfile_unchanged</a>(fname))</div><div class="line"><a name="l04952"></a><span class="lineno"> 4952</span>&#160;            {</div><div class="line"><a name="l04953"></a><span class="lineno"> 4953</span>&#160;            choice = 4;</div><div class="line"><a name="l04954"></a><span class="lineno"> 4954</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="option_8h.html#abb5561ad122dac5df6b719a1243b3445">p_verbose</a> &gt; 0)</div><div class="line"><a name="l04955"></a><span class="lineno"> 4955</span>&#160;                <a class="code" href="message_8c.html#a85d7463b25301d19e26b68b46f2a5ff9">verb_msg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;Found a swap file that is not useful, deleting it&quot;</span>));</div><div class="line"><a name="l04956"></a><span class="lineno"> 4956</span>&#160;            }</div><div class="line"><a name="l04957"></a><span class="lineno"> 4957</span>&#160;</div><div class="line"><a name="l04958"></a><span class="lineno"> 4958</span>&#160;<span class="preprocessor">#if defined(FEAT_EVAL)</span></div><div class="line"><a name="l04959"></a><span class="lineno"> 4959</span>&#160;            <span class="comment">/*</span></div><div class="line"><a name="l04960"></a><span class="lineno"> 4960</span>&#160;<span class="comment">             * If there is an SwapExists autocommand and we can handle</span></div><div class="line"><a name="l04961"></a><span class="lineno"> 4961</span>&#160;<span class="comment">             * the response, trigger it.  It may return 0 to ask the</span></div><div class="line"><a name="l04962"></a><span class="lineno"> 4962</span>&#160;<span class="comment">             * user anyway.</span></div><div class="line"><a name="l04963"></a><span class="lineno"> 4963</span>&#160;<span class="comment">             */</span></div><div class="line"><a name="l04964"></a><span class="lineno"> 4964</span>&#160;            <span class="keywordflow">if</span> (choice == 0</div><div class="line"><a name="l04965"></a><span class="lineno"> 4965</span>&#160;                &amp;&amp; swap_exists_action != <a class="code" href="vim_8h.html#ab9c14f3e74c2ae526ac73d0ac7be68e2">SEA_NONE</a></div><div class="line"><a name="l04966"></a><span class="lineno"> 4966</span>&#160;                &amp;&amp; <a class="code" href="autocmd_8c.html#a5e63d49ba2cbcbf49dd45ec521733ad7">has_autocmd</a>(<a class="code" href="vim_8h.html#a2de49dcf3b3c1e1043a2373b0d69a58aa37aec197ae0d6840760454b3ce99c9b2">EVENT_SWAPEXISTS</a>, buf_fname, buf))</div><div class="line"><a name="l04967"></a><span class="lineno"> 4967</span>&#160;            choice = <a class="code" href="memline_8c.html#ae7de358039e15f47f17c3e66d31a2370">do_swapexists</a>(buf, fname);</div><div class="line"><a name="l04968"></a><span class="lineno"> 4968</span>&#160;</div><div class="line"><a name="l04969"></a><span class="lineno"> 4969</span>&#160;            <span class="keywordflow">if</span> (choice == 0)</div><div class="line"><a name="l04970"></a><span class="lineno"> 4970</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l04971"></a><span class="lineno"> 4971</span>&#160;            {</div><div class="line"><a name="l04972"></a><span class="lineno"> 4972</span>&#160;<span class="preprocessor">#ifdef FEAT_GUI</span></div><div class="line"><a name="l04973"></a><span class="lineno"> 4973</span>&#160;            <span class="comment">// If we are supposed to start the GUI but it wasn&#39;t</span></div><div class="line"><a name="l04974"></a><span class="lineno"> 4974</span>&#160;            <span class="comment">// completely started yet, start it now.  This makes</span></div><div class="line"><a name="l04975"></a><span class="lineno"> 4975</span>&#160;            <span class="comment">// the messages displayed in the Vim window when</span></div><div class="line"><a name="l04976"></a><span class="lineno"> 4976</span>&#160;            <span class="comment">// loading a session from the .gvimrc file.</span></div><div class="line"><a name="l04977"></a><span class="lineno"> 4977</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="gui_8c.html#a6a991660e919b41ce2f02f6792ce75dc">gui</a>.<a class="code" href="struct_gui.html#a59ca384de082a710160aec5058e41001">starting</a> &amp;&amp; !<a class="code" href="gui_8c.html#a6a991660e919b41ce2f02f6792ce75dc">gui</a>.<a class="code" href="struct_gui.html#acc254db2a26171f77d6af6260a39c45d">in_use</a>)</div><div class="line"><a name="l04978"></a><span class="lineno"> 4978</span>&#160;                <a class="code" href="gui_8c.html#a46ef8b173034527e996282a23f148dd9">gui_start</a>(NULL);</div><div class="line"><a name="l04979"></a><span class="lineno"> 4979</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l04980"></a><span class="lineno"> 4980</span>&#160;            <span class="comment">// Show info about the existing swap file.</span></div><div class="line"><a name="l04981"></a><span class="lineno"> 4981</span>&#160;            <a class="code" href="memline_8c.html#a8a397be254bc1ea753c218ceb79b7812">attention_message</a>(buf, fname);</div><div class="line"><a name="l04982"></a><span class="lineno"> 4982</span>&#160;</div><div class="line"><a name="l04983"></a><span class="lineno"> 4983</span>&#160;            <span class="comment">// We don&#39;t want a &#39;q&#39; typed at the more-prompt</span></div><div class="line"><a name="l04984"></a><span class="lineno"> 4984</span>&#160;            <span class="comment">// interrupt loading a file.</span></div><div class="line"><a name="l04985"></a><span class="lineno"> 4985</span>&#160;            got_int = <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line"><a name="l04986"></a><span class="lineno"> 4986</span>&#160;</div><div class="line"><a name="l04987"></a><span class="lineno"> 4987</span>&#160;            <span class="comment">// If vimrc has &quot;simalt ~x&quot; we don&#39;t want it to</span></div><div class="line"><a name="l04988"></a><span class="lineno"> 4988</span>&#160;            <span class="comment">// interfere with the prompt here.</span></div><div class="line"><a name="l04989"></a><span class="lineno"> 4989</span>&#160;            <a class="code" href="getchar_8c.html#a08218e75f65cf78c2b75f702de094f74">flush_buffers</a>(<a class="code" href="vim_8h.html#a0fc829eaf562a22fd32c5a90c5a942f8aeb83a62b63c4f728519e7c95da168080">FLUSH_TYPEAHEAD</a>);</div><div class="line"><a name="l04990"></a><span class="lineno"> 4990</span>&#160;            }</div><div class="line"><a name="l04991"></a><span class="lineno"> 4991</span>&#160;</div><div class="line"><a name="l04992"></a><span class="lineno"> 4992</span>&#160;<span class="preprocessor">#if defined(FEAT_GUI_DIALOG) || defined(FEAT_CON_DIALOG)</span></div><div class="line"><a name="l04993"></a><span class="lineno"> 4993</span>&#160;            <span class="keywordflow">if</span> (swap_exists_action != <a class="code" href="vim_8h.html#ab9c14f3e74c2ae526ac73d0ac7be68e2">SEA_NONE</a> &amp;&amp; choice == 0)</div><div class="line"><a name="l04994"></a><span class="lineno"> 4994</span>&#160;            {</div><div class="line"><a name="l04995"></a><span class="lineno"> 4995</span>&#160;            char_u  *<a class="code" href="dosinst_8h.html#a5ac083a645d964373f022d03df4849c8">name</a>;</div><div class="line"><a name="l04996"></a><span class="lineno"> 4996</span>&#160;</div><div class="line"><a name="l04997"></a><span class="lineno"> 4997</span>&#160;            name = <a class="code" href="misc2_8c.html#ad0b64e14955781629a3908e328f82665">alloc</a>(<a class="code" href="vim_8h.html#a916ffefe1fc74532d08102cca55d8e34">STRLEN</a>(fname)</div><div class="line"><a name="l04998"></a><span class="lineno"> 4998</span>&#160;                + <a class="code" href="vim_8h.html#a916ffefe1fc74532d08102cca55d8e34">STRLEN</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;Swap file \&quot;&quot;</span>))</div><div class="line"><a name="l04999"></a><span class="lineno"> 4999</span>&#160;                + <a class="code" href="vim_8h.html#a916ffefe1fc74532d08102cca55d8e34">STRLEN</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;\&quot; already exists!&quot;</span>)) + 5);</div><div class="line"><a name="l05000"></a><span class="lineno"> 5000</span>&#160;            <span class="keywordflow">if</span> (name != NULL)</div><div class="line"><a name="l05001"></a><span class="lineno"> 5001</span>&#160;            {</div><div class="line"><a name="l05002"></a><span class="lineno"> 5002</span>&#160;                <a class="code" href="vim_8h.html#aa9cea5fcb1483307770f365fb24aa08d">STRCPY</a>(name, <a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;Swap file \&quot;&quot;</span>));</div><div class="line"><a name="l05003"></a><span class="lineno"> 5003</span>&#160;                <a class="code" href="filepath_8c.html#ab7f12f206c15cee62718c8ca7fa40695">home_replace</a>(NULL, fname, name + <a class="code" href="vim_8h.html#a916ffefe1fc74532d08102cca55d8e34">STRLEN</a>(name),</div><div class="line"><a name="l05004"></a><span class="lineno"> 5004</span>&#160;                                  1000, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div><div class="line"><a name="l05005"></a><span class="lineno"> 5005</span>&#160;                <a class="code" href="vim_8h.html#ada443375305fc60b73f44a59a2bf3f3b">STRCAT</a>(name, <a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;\&quot; already exists!&quot;</span>));</div><div class="line"><a name="l05006"></a><span class="lineno"> 5006</span>&#160;            }</div><div class="line"><a name="l05007"></a><span class="lineno"> 5007</span>&#160;            choice = <a class="code" href="message_8c.html#a2c7987897b6324574dba24fdfa9cc940">do_dialog</a>(<a class="code" href="vim_8h.html#a816f77cc520622266f75542017a6f828">VIM_WARNING</a>,</div><div class="line"><a name="l05008"></a><span class="lineno"> 5008</span>&#160;                    (char_u *)<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;VIM - ATTENTION&quot;</span>),</div><div class="line"><a name="l05009"></a><span class="lineno"> 5009</span>&#160;                    name == NULL</div><div class="line"><a name="l05010"></a><span class="lineno"> 5010</span>&#160;                    ?  (char_u *)<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;Swap file already exists!&quot;</span>)</div><div class="line"><a name="l05011"></a><span class="lineno"> 5011</span>&#160;                    : name,</div><div class="line"><a name="l05012"></a><span class="lineno"> 5012</span>&#160;# ifdef HAVE_PROCESS_STILL_RUNNING</div><div class="line"><a name="l05013"></a><span class="lineno"> 5013</span>&#160;                    process_still_running</div><div class="line"><a name="l05014"></a><span class="lineno"> 5014</span>&#160;                    ? (char_u *)<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;&amp;Open Read-Only\n&amp;Edit anyway\n&amp;Recover\n&amp;Quit\n&amp;Abort&quot;</span>) :</div><div class="line"><a name="l05015"></a><span class="lineno"> 5015</span>&#160;# endif</div><div class="line"><a name="l05016"></a><span class="lineno"> 5016</span>&#160;                    (char_u *)<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;&amp;Open Read-Only\n&amp;Edit anyway\n&amp;Recover\n&amp;Delete it\n&amp;Quit\n&amp;Abort&quot;</span>), 1, NULL, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l05017"></a><span class="lineno"> 5017</span>&#160;</div><div class="line"><a name="l05018"></a><span class="lineno"> 5018</span>&#160;<span class="preprocessor"># ifdef HAVE_PROCESS_STILL_RUNNING</span></div><div class="line"><a name="l05019"></a><span class="lineno"> 5019</span>&#160;            <span class="keywordflow">if</span> (process_still_running &amp;&amp; choice &gt;= 4)</div><div class="line"><a name="l05020"></a><span class="lineno"> 5020</span>&#160;                choice++;   <span class="comment">/* Skip missing &quot;Delete it&quot; button */</span></div><div class="line"><a name="l05021"></a><span class="lineno"> 5021</span>&#160;<span class="preprocessor"># endif</span></div><div class="line"><a name="l05022"></a><span class="lineno"> 5022</span>&#160;            <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(name);</div><div class="line"><a name="l05023"></a><span class="lineno"> 5023</span>&#160;</div><div class="line"><a name="l05024"></a><span class="lineno"> 5024</span>&#160;            <span class="comment">/* pretend screen didn&#39;t scroll, need redraw anyway */</span></div><div class="line"><a name="l05025"></a><span class="lineno"> 5025</span>&#160;            <a class="code" href="globals_8h.html#a0b03bc5fdd1ab38b00bf9264b8c7275b">msg_scrolled</a> = 0;</div><div class="line"><a name="l05026"></a><span class="lineno"> 5026</span>&#160;            <a class="code" href="drawscreen_8c.html#a6cfdbac5c3017ed3f6f8c70035ea3e5d">redraw_all_later</a>(<a class="code" href="vim_8h.html#a72695d31382ba5334881ad3407393642">NOT_VALID</a>);</div><div class="line"><a name="l05027"></a><span class="lineno"> 5027</span>&#160;            }</div><div class="line"><a name="l05028"></a><span class="lineno"> 5028</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l05029"></a><span class="lineno"> 5029</span>&#160;</div><div class="line"><a name="l05030"></a><span class="lineno"> 5030</span>&#160;            <span class="keywordflow">if</span> (choice &gt; 0)</div><div class="line"><a name="l05031"></a><span class="lineno"> 5031</span>&#160;            {</div><div class="line"><a name="l05032"></a><span class="lineno"> 5032</span>&#160;            <span class="keywordflow">switch</span> (choice)</div><div class="line"><a name="l05033"></a><span class="lineno"> 5033</span>&#160;            {</div><div class="line"><a name="l05034"></a><span class="lineno"> 5034</span>&#160;                <span class="keywordflow">case</span> 1:</div><div class="line"><a name="l05035"></a><span class="lineno"> 5035</span>&#160;                buf-&gt;<a class="code" href="structfile__buffer.html#a7ffb8516d12b390e45fc3af4d670d020">b_p_ro</a> = <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"><a name="l05036"></a><span class="lineno"> 5036</span>&#160;                <span class="keywordflow">break</span>;</div><div class="line"><a name="l05037"></a><span class="lineno"> 5037</span>&#160;                <span class="keywordflow">case</span> 2:</div><div class="line"><a name="l05038"></a><span class="lineno"> 5038</span>&#160;                <span class="keywordflow">break</span>;</div><div class="line"><a name="l05039"></a><span class="lineno"> 5039</span>&#160;                <span class="keywordflow">case</span> 3:</div><div class="line"><a name="l05040"></a><span class="lineno"> 5040</span>&#160;                swap_exists_action = <a class="code" href="vim_8h.html#aa0c7b8582b88ec89a7b4a058f63d68ac">SEA_RECOVER</a>;</div><div class="line"><a name="l05041"></a><span class="lineno"> 5041</span>&#160;                <span class="keywordflow">break</span>;</div><div class="line"><a name="l05042"></a><span class="lineno"> 5042</span>&#160;                <span class="keywordflow">case</span> 4:</div><div class="line"><a name="l05043"></a><span class="lineno"> 5043</span>&#160;                <a class="code" href="os__win32_8c.html#a288b0d3b5efd2d0257cfe8e9e4f647a1">mch_remove</a>(fname);</div><div class="line"><a name="l05044"></a><span class="lineno"> 5044</span>&#160;                <span class="keywordflow">break</span>;</div><div class="line"><a name="l05045"></a><span class="lineno"> 5045</span>&#160;                <span class="keywordflow">case</span> 5:</div><div class="line"><a name="l05046"></a><span class="lineno"> 5046</span>&#160;                swap_exists_action = <a class="code" href="vim_8h.html#ac3285f1441f208573c7f11b460ef2a79">SEA_QUIT</a>;</div><div class="line"><a name="l05047"></a><span class="lineno"> 5047</span>&#160;                <span class="keywordflow">break</span>;</div><div class="line"><a name="l05048"></a><span class="lineno"> 5048</span>&#160;                <span class="keywordflow">case</span> 6:</div><div class="line"><a name="l05049"></a><span class="lineno"> 5049</span>&#160;                swap_exists_action = <a class="code" href="vim_8h.html#ac3285f1441f208573c7f11b460ef2a79">SEA_QUIT</a>;</div><div class="line"><a name="l05050"></a><span class="lineno"> 5050</span>&#160;                got_int = <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"><a name="l05051"></a><span class="lineno"> 5051</span>&#160;                <span class="keywordflow">break</span>;</div><div class="line"><a name="l05052"></a><span class="lineno"> 5052</span>&#160;            }</div><div class="line"><a name="l05053"></a><span class="lineno"> 5053</span>&#160;</div><div class="line"><a name="l05054"></a><span class="lineno"> 5054</span>&#160;            <span class="comment">/* If the file was deleted this fname can be used. */</span></div><div class="line"><a name="l05055"></a><span class="lineno"> 5055</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="os__amiga_8c.html#a7e689f4e37bb4db880dae0d37452f7de">mch_getperm</a>(fname) &lt; 0)</div><div class="line"><a name="l05056"></a><span class="lineno"> 5056</span>&#160;                <span class="keywordflow">break</span>;</div><div class="line"><a name="l05057"></a><span class="lineno"> 5057</span>&#160;            }</div><div class="line"><a name="l05058"></a><span class="lineno"> 5058</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l05059"></a><span class="lineno"> 5059</span>&#160;            {</div><div class="line"><a name="l05060"></a><span class="lineno"> 5060</span>&#160;            <a class="code" href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a>(<span class="stringliteral">&quot;\n&quot;</span>);</div><div class="line"><a name="l05061"></a><span class="lineno"> 5061</span>&#160;            <span class="keywordflow">if</span> (msg_silent == 0)</div><div class="line"><a name="l05062"></a><span class="lineno"> 5062</span>&#160;                <span class="comment">/* call wait_return() later */</span></div><div class="line"><a name="l05063"></a><span class="lineno"> 5063</span>&#160;                need_wait_return = <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"><a name="l05064"></a><span class="lineno"> 5064</span>&#160;            }</div><div class="line"><a name="l05065"></a><span class="lineno"> 5065</span>&#160;</div><div class="line"><a name="l05066"></a><span class="lineno"> 5066</span>&#160;<span class="preprocessor">#ifdef CREATE_DUMMY_FILE</span></div><div class="line"><a name="l05067"></a><span class="lineno"> 5067</span>&#160;            <span class="comment">/* Going to try another name, need the dummy file again. */</span></div><div class="line"><a name="l05068"></a><span class="lineno"> 5068</span>&#160;            <span class="keywordflow">if</span> (did_use_dummy)</div><div class="line"><a name="l05069"></a><span class="lineno"> 5069</span>&#160;            dummyfd = <a class="code" href="os__win32_8c.html#af1ef6cc4b2e3b02554529c108268ff5d">mch_fopen</a>((<span class="keywordtype">char</span> *)buf_fname, <span class="stringliteral">&quot;w&quot;</span>);</div><div class="line"><a name="l05070"></a><span class="lineno"> 5070</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l05071"></a><span class="lineno"> 5071</span>&#160;        }</div><div class="line"><a name="l05072"></a><span class="lineno"> 5072</span>&#160;        }</div><div class="line"><a name="l05073"></a><span class="lineno"> 5073</span>&#160;    }</div><div class="line"><a name="l05074"></a><span class="lineno"> 5074</span>&#160;</div><div class="line"><a name="l05075"></a><span class="lineno"> 5075</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l05076"></a><span class="lineno"> 5076</span>&#160;<span class="comment">     * Change the &quot;.swp&quot; extension to find another file that can be used.</span></div><div class="line"><a name="l05077"></a><span class="lineno"> 5077</span>&#160;<span class="comment">     * First decrement the last char: &quot;.swo&quot;, &quot;.swn&quot;, etc.</span></div><div class="line"><a name="l05078"></a><span class="lineno"> 5078</span>&#160;<span class="comment">     * If that still isn&#39;t enough decrement the last but one char: &quot;.svz&quot;</span></div><div class="line"><a name="l05079"></a><span class="lineno"> 5079</span>&#160;<span class="comment">     * Can happen when editing many &quot;No Name&quot; buffers.</span></div><div class="line"><a name="l05080"></a><span class="lineno"> 5080</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l05081"></a><span class="lineno"> 5081</span>&#160;    <span class="keywordflow">if</span> (fname[n - 1] == <span class="charliteral">&#39;a&#39;</span>)    <span class="comment">/* &quot;.s?a&quot; */</span></div><div class="line"><a name="l05082"></a><span class="lineno"> 5082</span>&#160;    {</div><div class="line"><a name="l05083"></a><span class="lineno"> 5083</span>&#160;        <span class="keywordflow">if</span> (fname[n - 2] == <span class="charliteral">&#39;a&#39;</span>)    <span class="comment">/* &quot;.saa&quot;: tried enough, give up */</span></div><div class="line"><a name="l05084"></a><span class="lineno"> 5084</span>&#160;        {</div><div class="line"><a name="l05085"></a><span class="lineno"> 5085</span>&#160;        <a class="code" href="message_8c.html#ae5991a4d11897dfaee9bfab8e5489d82">emsg</a>(<a class="code" href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a>(<span class="stringliteral">&quot;E326: Too many swap files found&quot;</span>));</div><div class="line"><a name="l05086"></a><span class="lineno"> 5086</span>&#160;        <a class="code" href="macros_8h.html#a74420d7769a3c31521652566a1cdb094">VIM_CLEAR</a>(fname);</div><div class="line"><a name="l05087"></a><span class="lineno"> 5087</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l05088"></a><span class="lineno"> 5088</span>&#160;        }</div><div class="line"><a name="l05089"></a><span class="lineno"> 5089</span>&#160;        --fname[n - 2];     <span class="comment">/* &quot;.svz&quot;, &quot;.suz&quot;, etc. */</span></div><div class="line"><a name="l05090"></a><span class="lineno"> 5090</span>&#160;        fname[n - 1] = <span class="charliteral">&#39;z&#39;</span> + 1;</div><div class="line"><a name="l05091"></a><span class="lineno"> 5091</span>&#160;    }</div><div class="line"><a name="l05092"></a><span class="lineno"> 5092</span>&#160;    --fname[n - 1];         <span class="comment">/* &quot;.swo&quot;, &quot;.swn&quot;, etc. */</span></div><div class="line"><a name="l05093"></a><span class="lineno"> 5093</span>&#160;    }</div><div class="line"><a name="l05094"></a><span class="lineno"> 5094</span>&#160;</div><div class="line"><a name="l05095"></a><span class="lineno"> 5095</span>&#160;    <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(dir_name);</div><div class="line"><a name="l05096"></a><span class="lineno"> 5096</span>&#160;<span class="preprocessor">#ifdef CREATE_DUMMY_FILE</span></div><div class="line"><a name="l05097"></a><span class="lineno"> 5097</span>&#160;    <span class="keywordflow">if</span> (dummyfd != NULL)    <span class="comment">/* file has been created temporarily */</span></div><div class="line"><a name="l05098"></a><span class="lineno"> 5098</span>&#160;    {</div><div class="line"><a name="l05099"></a><span class="lineno"> 5099</span>&#160;    fclose(dummyfd);</div><div class="line"><a name="l05100"></a><span class="lineno"> 5100</span>&#160;    <a class="code" href="os__win32_8c.html#a288b0d3b5efd2d0257cfe8e9e4f647a1">mch_remove</a>(buf_fname);</div><div class="line"><a name="l05101"></a><span class="lineno"> 5101</span>&#160;    }</div><div class="line"><a name="l05102"></a><span class="lineno"> 5102</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l05103"></a><span class="lineno"> 5103</span>&#160;<span class="preprocessor">#ifdef MSWIN</span></div><div class="line"><a name="l05104"></a><span class="lineno"> 5104</span>&#160;    <span class="keywordflow">if</span> (buf_fname != buf-&gt;<a class="code" href="structfile__buffer.html#a34a7c5a6d702c7ce0181584242976f3e">b_fname</a>)</div><div class="line"><a name="l05105"></a><span class="lineno"> 5105</span>&#160;    <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(buf_fname);</div><div class="line"><a name="l05106"></a><span class="lineno"> 5106</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l05107"></a><span class="lineno"> 5107</span>&#160;    <span class="keywordflow">return</span> fname;</div><div class="line"><a name="l05108"></a><span class="lineno"> 5108</span>&#160;}</div><div class="line"><a name="l05109"></a><span class="lineno"> 5109</span>&#160;</div><div class="line"><a name="l05110"></a><span class="lineno"> 5110</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">int</span></div><div class="line"><a name="l05111"></a><span class="lineno"><a class="line" href="memline_8c.html#a28648170c5d102a305afeeecf23cc0ca"> 5111</a></span>&#160;<a class="code" href="memline_8c.html#a28648170c5d102a305afeeecf23cc0ca">b0_magic_wrong</a>(<a class="code" href="structblock0.html">ZERO_BL</a> *b0p)</div><div class="line"><a name="l05112"></a><span class="lineno"> 5112</span>&#160;{</div><div class="line"><a name="l05113"></a><span class="lineno"> 5113</span>&#160;    <span class="keywordflow">return</span> (b0p-&gt;<a class="code" href="structblock0.html#a543e42c027a0f62c7843b3f44a8b999c">b0_magic_long</a> != (<span class="keywordtype">long</span>)<a class="code" href="memline_8c.html#a2ac462e9a16bd27bb78d4e5e2cab8995">B0_MAGIC_LONG</a></div><div class="line"><a name="l05114"></a><span class="lineno"> 5114</span>&#160;        || b0p-&gt;<a class="code" href="structblock0.html#af1c4459e8e835bc33daa0b6d4a4d57d1">b0_magic_int</a> != (<span class="keywordtype">int</span>)<a class="code" href="memline_8c.html#a2498547c6752de3ff3cb3a9526ef8050">B0_MAGIC_INT</a></div><div class="line"><a name="l05115"></a><span class="lineno"> 5115</span>&#160;        || b0p-&gt;<a class="code" href="structblock0.html#a677366d05c5a282aa489272ca0fa0b1d">b0_magic_short</a> != (<span class="keywordtype">short</span>)<a class="code" href="memline_8c.html#a136a6ccfa892765672abfc5e0dff1a2d">B0_MAGIC_SHORT</a></div><div class="line"><a name="l05116"></a><span class="lineno"> 5116</span>&#160;        || b0p-&gt;<a class="code" href="structblock0.html#a821963e4a98dd9ec3d819afa9ccd660f">b0_magic_char</a> != <a class="code" href="memline_8c.html#a24846156f9cce98c4ab60f43e224065e">B0_MAGIC_CHAR</a>);</div><div class="line"><a name="l05117"></a><span class="lineno"> 5117</span>&#160;}</div><div class="line"><a name="l05118"></a><span class="lineno"> 5118</span>&#160;</div><div class="line"><a name="l05119"></a><span class="lineno"> 5119</span>&#160;<span class="preprocessor">#ifdef CHECK_INODE</span></div><div class="line"><a name="l05120"></a><span class="lineno"> 5120</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l05121"></a><span class="lineno"> 5121</span>&#160;<span class="comment"> * Compare current file name with file name from swap file.</span></div><div class="line"><a name="l05122"></a><span class="lineno"> 5122</span>&#160;<span class="comment"> * Try to use inode numbers when possible.</span></div><div class="line"><a name="l05123"></a><span class="lineno"> 5123</span>&#160;<span class="comment"> * Return non-zero when files are different.</span></div><div class="line"><a name="l05124"></a><span class="lineno"> 5124</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l05125"></a><span class="lineno"> 5125</span>&#160;<span class="comment"> * When comparing file names a few things have to be taken into consideration:</span></div><div class="line"><a name="l05126"></a><span class="lineno"> 5126</span>&#160;<span class="comment"> * - When working over a network the full path of a file depends on the host.</span></div><div class="line"><a name="l05127"></a><span class="lineno"> 5127</span>&#160;<span class="comment"> *   We check the inode number if possible.  It is not 100% reliable though,</span></div><div class="line"><a name="l05128"></a><span class="lineno"> 5128</span>&#160;<span class="comment"> *   because the device number cannot be used over a network.</span></div><div class="line"><a name="l05129"></a><span class="lineno"> 5129</span>&#160;<span class="comment"> * - When a file does not exist yet (editing a new file) there is no inode</span></div><div class="line"><a name="l05130"></a><span class="lineno"> 5130</span>&#160;<span class="comment"> *   number.</span></div><div class="line"><a name="l05131"></a><span class="lineno"> 5131</span>&#160;<span class="comment"> * - The file name in a swap file may not be valid on the current host.  The</span></div><div class="line"><a name="l05132"></a><span class="lineno"> 5132</span>&#160;<span class="comment"> *   &quot;~user&quot; form is used whenever possible to avoid this.</span></div><div class="line"><a name="l05133"></a><span class="lineno"> 5133</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l05134"></a><span class="lineno"> 5134</span>&#160;<span class="comment"> * This is getting complicated, let&#39;s make a table:</span></div><div class="line"><a name="l05135"></a><span class="lineno"> 5135</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l05136"></a><span class="lineno"> 5136</span>&#160;<span class="comment"> *      ino_c  ino_s  fname_c  fname_s  differ =</span></div><div class="line"><a name="l05137"></a><span class="lineno"> 5137</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l05138"></a><span class="lineno"> 5138</span>&#160;<span class="comment"> * both files exist -&gt; compare inode numbers:</span></div><div class="line"><a name="l05139"></a><span class="lineno"> 5139</span>&#160;<span class="comment"> *      != 0   != 0 X    X  ino_c != ino_s</span></div><div class="line"><a name="l05140"></a><span class="lineno"> 5140</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l05141"></a><span class="lineno"> 5141</span>&#160;<span class="comment"> * inode number(s) unknown, file names available -&gt; compare file names</span></div><div class="line"><a name="l05142"></a><span class="lineno"> 5142</span>&#160;<span class="comment"> *      == 0    X   OK   OK fname_c != fname_s</span></div><div class="line"><a name="l05143"></a><span class="lineno"> 5143</span>&#160;<span class="comment"> *       X     == 0 OK   OK fname_c != fname_s</span></div><div class="line"><a name="l05144"></a><span class="lineno"> 5144</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l05145"></a><span class="lineno"> 5145</span>&#160;<span class="comment"> * current file doesn&#39;t exist, file for swap file exist, file name(s) not</span></div><div class="line"><a name="l05146"></a><span class="lineno"> 5146</span>&#160;<span class="comment"> * available -&gt; probably different</span></div><div class="line"><a name="l05147"></a><span class="lineno"> 5147</span>&#160;<span class="comment"> *      == 0   != 0    FAIL  X  TRUE</span></div><div class="line"><a name="l05148"></a><span class="lineno"> 5148</span>&#160;<span class="comment"> *      == 0   != 0 X   FAIL    TRUE</span></div><div class="line"><a name="l05149"></a><span class="lineno"> 5149</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l05150"></a><span class="lineno"> 5150</span>&#160;<span class="comment"> * current file exists, inode for swap unknown, file name(s) not</span></div><div class="line"><a name="l05151"></a><span class="lineno"> 5151</span>&#160;<span class="comment"> * available -&gt; probably different</span></div><div class="line"><a name="l05152"></a><span class="lineno"> 5152</span>&#160;<span class="comment"> *      != 0   == 0    FAIL  X  TRUE</span></div><div class="line"><a name="l05153"></a><span class="lineno"> 5153</span>&#160;<span class="comment"> *      != 0   == 0 X   FAIL    TRUE</span></div><div class="line"><a name="l05154"></a><span class="lineno"> 5154</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l05155"></a><span class="lineno"> 5155</span>&#160;<span class="comment"> * current file doesn&#39;t exist, inode for swap unknown, one file name not</span></div><div class="line"><a name="l05156"></a><span class="lineno"> 5156</span>&#160;<span class="comment"> * available -&gt; probably different</span></div><div class="line"><a name="l05157"></a><span class="lineno"> 5157</span>&#160;<span class="comment"> *      == 0   == 0    FAIL  OK TRUE</span></div><div class="line"><a name="l05158"></a><span class="lineno"> 5158</span>&#160;<span class="comment"> *      == 0   == 0 OK  FAIL    TRUE</span></div><div class="line"><a name="l05159"></a><span class="lineno"> 5159</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l05160"></a><span class="lineno"> 5160</span>&#160;<span class="comment"> * current file doesn&#39;t exist, inode for swap unknown, both file names not</span></div><div class="line"><a name="l05161"></a><span class="lineno"> 5161</span>&#160;<span class="comment"> * available -&gt; compare file names</span></div><div class="line"><a name="l05162"></a><span class="lineno"> 5162</span>&#160;<span class="comment"> *      == 0   == 0    FAIL FAIL    fname_c != fname_s</span></div><div class="line"><a name="l05163"></a><span class="lineno"> 5163</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l05164"></a><span class="lineno"> 5164</span>&#160;<span class="comment"> * Note that when the ino_t is 64 bits, only the last 32 will be used.  This</span></div><div class="line"><a name="l05165"></a><span class="lineno"> 5165</span>&#160;<span class="comment"> * can&#39;t be changed without making the block 0 incompatible with 32 bit</span></div><div class="line"><a name="l05166"></a><span class="lineno"> 5166</span>&#160;<span class="comment"> * versions.</span></div><div class="line"><a name="l05167"></a><span class="lineno"> 5167</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l05168"></a><span class="lineno"> 5168</span>&#160;</div><div class="line"><a name="l05169"></a><span class="lineno"> 5169</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">int</span></div><div class="line"><a name="l05170"></a><span class="lineno"> 5170</span>&#160;fnamecmp_ino(</div><div class="line"><a name="l05171"></a><span class="lineno"> 5171</span>&#160;    char_u  *fname_c,       <span class="comment">/* current file name */</span></div><div class="line"><a name="l05172"></a><span class="lineno"> 5172</span>&#160;    char_u  *fname_s,       <span class="comment">/* file name from swap file */</span></div><div class="line"><a name="l05173"></a><span class="lineno"> 5173</span>&#160;    <span class="keywordtype">long</span>    ino_block0)</div><div class="line"><a name="l05174"></a><span class="lineno"> 5174</span>&#160;{</div><div class="line"><a name="l05175"></a><span class="lineno"> 5175</span>&#160;    <a class="code" href="vim_8h.html#a3206c537c639e0f26013f6cf909bd0e0">stat_T</a>  st;</div><div class="line"><a name="l05176"></a><span class="lineno"> 5176</span>&#160;    ino_t   ino_c = 0;      <span class="comment">/* ino of current file */</span></div><div class="line"><a name="l05177"></a><span class="lineno"> 5177</span>&#160;    ino_t   ino_s;          <span class="comment">/* ino of file from swap file */</span></div><div class="line"><a name="l05178"></a><span class="lineno"> 5178</span>&#160;    char_u  buf_c[<a class="code" href="os__unix_8h.html#a9b75f9db03a33bb3d2d613923647d0cf">MAXPATHL</a>];    <span class="comment">/* full path of fname_c */</span></div><div class="line"><a name="l05179"></a><span class="lineno"> 5179</span>&#160;    char_u  buf_s[<a class="code" href="os__unix_8h.html#a9b75f9db03a33bb3d2d613923647d0cf">MAXPATHL</a>];    <span class="comment">/* full path of fname_s */</span></div><div class="line"><a name="l05180"></a><span class="lineno"> 5180</span>&#160;    <span class="keywordtype">int</span>     retval_c;       <span class="comment">/* flag: buf_c valid */</span></div><div class="line"><a name="l05181"></a><span class="lineno"> 5181</span>&#160;    <span class="keywordtype">int</span>     retval_s;       <span class="comment">/* flag: buf_s valid */</span></div><div class="line"><a name="l05182"></a><span class="lineno"> 5182</span>&#160;</div><div class="line"><a name="l05183"></a><span class="lineno"> 5183</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="macros_8h.html#af9221f9667cc05a05b4646b2aa31e233">mch_stat</a>((<span class="keywordtype">char</span> *)fname_c, &amp;st) == 0)</div><div class="line"><a name="l05184"></a><span class="lineno"> 5184</span>&#160;    ino_c = (ino_t)st.st_ino;</div><div class="line"><a name="l05185"></a><span class="lineno"> 5185</span>&#160;</div><div class="line"><a name="l05186"></a><span class="lineno"> 5186</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l05187"></a><span class="lineno"> 5187</span>&#160;<span class="comment">     * First we try to get the inode from the file name, because the inode in</span></div><div class="line"><a name="l05188"></a><span class="lineno"> 5188</span>&#160;<span class="comment">     * the swap file may be outdated.  If that fails (e.g. this path is not</span></div><div class="line"><a name="l05189"></a><span class="lineno"> 5189</span>&#160;<span class="comment">     * valid on this machine), use the inode from block 0.</span></div><div class="line"><a name="l05190"></a><span class="lineno"> 5190</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l05191"></a><span class="lineno"> 5191</span>&#160;    if (<a class="code" href="macros_8h.html#af9221f9667cc05a05b4646b2aa31e233">mch_stat</a>((<span class="keywordtype">char</span> *)fname_s, &amp;st) == 0)</div><div class="line"><a name="l05192"></a><span class="lineno"> 5192</span>&#160;    ino_s = (ino_t)st.st_ino;</div><div class="line"><a name="l05193"></a><span class="lineno"> 5193</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l05194"></a><span class="lineno"> 5194</span>&#160;    ino_s = (ino_t)ino_block0;</div><div class="line"><a name="l05195"></a><span class="lineno"> 5195</span>&#160;</div><div class="line"><a name="l05196"></a><span class="lineno"> 5196</span>&#160;    <span class="keywordflow">if</span> (ino_c &amp;&amp; ino_s)</div><div class="line"><a name="l05197"></a><span class="lineno"> 5197</span>&#160;    <span class="keywordflow">return</span> (ino_c != ino_s);</div><div class="line"><a name="l05198"></a><span class="lineno"> 5198</span>&#160;</div><div class="line"><a name="l05199"></a><span class="lineno"> 5199</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l05200"></a><span class="lineno"> 5200</span>&#160;<span class="comment">     * One of the inode numbers is unknown, try a forced vim_FullName() and</span></div><div class="line"><a name="l05201"></a><span class="lineno"> 5201</span>&#160;<span class="comment">     * compare the file names.</span></div><div class="line"><a name="l05202"></a><span class="lineno"> 5202</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l05203"></a><span class="lineno"> 5203</span>&#160;    retval_c = <a class="code" href="filepath_8c.html#a52fbff29815a2232d884304f4dce5fef">vim_FullName</a>(fname_c, buf_c, <a class="code" href="os__unix_8h.html#a9b75f9db03a33bb3d2d613923647d0cf">MAXPATHL</a>, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div><div class="line"><a name="l05204"></a><span class="lineno"> 5204</span>&#160;    retval_s = <a class="code" href="filepath_8c.html#a52fbff29815a2232d884304f4dce5fef">vim_FullName</a>(fname_s, buf_s, <a class="code" href="os__unix_8h.html#a9b75f9db03a33bb3d2d613923647d0cf">MAXPATHL</a>, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div><div class="line"><a name="l05205"></a><span class="lineno"> 5205</span>&#160;    <span class="keywordflow">if</span> (retval_c == <a class="code" href="dosinst_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a> &amp;&amp; retval_s == <a class="code" href="dosinst_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a>)</div><div class="line"><a name="l05206"></a><span class="lineno"> 5206</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="vim_8h.html#a75fb5fb9d785a71f9d82f4d008a48278">STRCMP</a>(buf_c, buf_s) != 0;</div><div class="line"><a name="l05207"></a><span class="lineno"> 5207</span>&#160;</div><div class="line"><a name="l05208"></a><span class="lineno"> 5208</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l05209"></a><span class="lineno"> 5209</span>&#160;<span class="comment">     * Can&#39;t compare inodes or file names, guess that the files are different,</span></div><div class="line"><a name="l05210"></a><span class="lineno"> 5210</span>&#160;<span class="comment">     * unless both appear not to exist at all, then compare with the file name</span></div><div class="line"><a name="l05211"></a><span class="lineno"> 5211</span>&#160;<span class="comment">     * in the swap file.</span></div><div class="line"><a name="l05212"></a><span class="lineno"> 5212</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l05213"></a><span class="lineno"> 5213</span>&#160;    <span class="keywordflow">if</span> (ino_s == 0 &amp;&amp; ino_c == 0 &amp;&amp; retval_c == <a class="code" href="dosinst_8h.html#abb508ea8227673f419e9fe3a86c30d8e">FAIL</a> &amp;&amp; retval_s == <a class="code" href="dosinst_8h.html#abb508ea8227673f419e9fe3a86c30d8e">FAIL</a>)</div><div class="line"><a name="l05214"></a><span class="lineno"> 5214</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="vim_8h.html#a75fb5fb9d785a71f9d82f4d008a48278">STRCMP</a>(fname_c, fname_s) != 0;</div><div class="line"><a name="l05215"></a><span class="lineno"> 5215</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"><a name="l05216"></a><span class="lineno"> 5216</span>&#160;}</div><div class="line"><a name="l05217"></a><span class="lineno"> 5217</span>&#160;<span class="preprocessor">#endif </span><span class="comment">/* CHECK_INODE */</span><span class="preprocessor"></span></div><div class="line"><a name="l05218"></a><span class="lineno"> 5218</span>&#160;</div><div class="line"><a name="l05219"></a><span class="lineno"> 5219</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l05220"></a><span class="lineno"> 5220</span>&#160;<span class="comment"> * Move a long integer into a four byte character array.</span></div><div class="line"><a name="l05221"></a><span class="lineno"> 5221</span>&#160;<span class="comment"> * Used for machine independency in block zero.</span></div><div class="line"><a name="l05222"></a><span class="lineno"> 5222</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l05223"></a><span class="lineno"> 5223</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">void</span></div><div class="line"><a name="l05224"></a><span class="lineno"><a class="line" href="memline_8c.html#a231a2b743bdebbc1d61725a392830eff"> 5224</a></span>&#160;<a class="code" href="memline_8c.html#a231a2b743bdebbc1d61725a392830eff">long_to_char</a>(<span class="keywordtype">long</span> n, char_u *s)</div><div class="line"><a name="l05225"></a><span class="lineno"> 5225</span>&#160;{</div><div class="line"><a name="l05226"></a><span class="lineno"> 5226</span>&#160;    s[0] = (char_u)(n &amp; 0xff);</div><div class="line"><a name="l05227"></a><span class="lineno"> 5227</span>&#160;    n = (unsigned)n &gt;&gt; 8;</div><div class="line"><a name="l05228"></a><span class="lineno"> 5228</span>&#160;    s[1] = (char_u)(n &amp; 0xff);</div><div class="line"><a name="l05229"></a><span class="lineno"> 5229</span>&#160;    n = (unsigned)n &gt;&gt; 8;</div><div class="line"><a name="l05230"></a><span class="lineno"> 5230</span>&#160;    s[2] = (char_u)(n &amp; 0xff);</div><div class="line"><a name="l05231"></a><span class="lineno"> 5231</span>&#160;    n = (unsigned)n &gt;&gt; 8;</div><div class="line"><a name="l05232"></a><span class="lineno"> 5232</span>&#160;    s[3] = (char_u)(n &amp; 0xff);</div><div class="line"><a name="l05233"></a><span class="lineno"> 5233</span>&#160;}</div><div class="line"><a name="l05234"></a><span class="lineno"> 5234</span>&#160;</div><div class="line"><a name="l05235"></a><span class="lineno"> 5235</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">long</span></div><div class="line"><a name="l05236"></a><span class="lineno"><a class="line" href="memline_8c.html#a996b07c0a0e4f04f7b205f4c3ba2a797"> 5236</a></span>&#160;<a class="code" href="memline_8c.html#a996b07c0a0e4f04f7b205f4c3ba2a797">char_to_long</a>(char_u *s)</div><div class="line"><a name="l05237"></a><span class="lineno"> 5237</span>&#160;{</div><div class="line"><a name="l05238"></a><span class="lineno"> 5238</span>&#160;    <span class="keywordtype">long</span>    retval;</div><div class="line"><a name="l05239"></a><span class="lineno"> 5239</span>&#160;</div><div class="line"><a name="l05240"></a><span class="lineno"> 5240</span>&#160;    retval = s[3];</div><div class="line"><a name="l05241"></a><span class="lineno"> 5241</span>&#160;    retval &lt;&lt;= 8;</div><div class="line"><a name="l05242"></a><span class="lineno"> 5242</span>&#160;    retval |= s[2];</div><div class="line"><a name="l05243"></a><span class="lineno"> 5243</span>&#160;    retval &lt;&lt;= 8;</div><div class="line"><a name="l05244"></a><span class="lineno"> 5244</span>&#160;    retval |= s[1];</div><div class="line"><a name="l05245"></a><span class="lineno"> 5245</span>&#160;    retval &lt;&lt;= 8;</div><div class="line"><a name="l05246"></a><span class="lineno"> 5246</span>&#160;    retval |= s[0];</div><div class="line"><a name="l05247"></a><span class="lineno"> 5247</span>&#160;</div><div class="line"><a name="l05248"></a><span class="lineno"> 5248</span>&#160;    <span class="keywordflow">return</span> retval;</div><div class="line"><a name="l05249"></a><span class="lineno"> 5249</span>&#160;}</div><div class="line"><a name="l05250"></a><span class="lineno"> 5250</span>&#160;</div><div class="line"><a name="l05251"></a><span class="lineno"> 5251</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l05252"></a><span class="lineno"> 5252</span>&#160;<span class="comment"> * Set the flags in the first block of the swap file:</span></div><div class="line"><a name="l05253"></a><span class="lineno"> 5253</span>&#160;<span class="comment"> * - file is modified or not: buf-&gt;b_changed</span></div><div class="line"><a name="l05254"></a><span class="lineno"> 5254</span>&#160;<span class="comment"> * - &#39;fileformat&#39;</span></div><div class="line"><a name="l05255"></a><span class="lineno"> 5255</span>&#160;<span class="comment"> * - &#39;fileencoding&#39;</span></div><div class="line"><a name="l05256"></a><span class="lineno"> 5256</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l05257"></a><span class="lineno"> 5257</span>&#160;    <span class="keywordtype">void</span></div><div class="line"><a name="l05258"></a><span class="lineno"><a class="line" href="memline_8c.html#a463912a75dba711ec41090526dcd8fe6"> 5258</a></span>&#160;<a class="code" href="memline_8c.html#a463912a75dba711ec41090526dcd8fe6">ml_setflags</a>(<a class="code" href="structfile__buffer.html">buf_T</a> *buf)</div><div class="line"><a name="l05259"></a><span class="lineno"> 5259</span>&#160;{</div><div class="line"><a name="l05260"></a><span class="lineno"> 5260</span>&#160;    <a class="code" href="structblock__hdr.html">bhdr_T</a>  *hp;</div><div class="line"><a name="l05261"></a><span class="lineno"> 5261</span>&#160;    <a class="code" href="structblock0.html">ZERO_BL</a> *b0p;</div><div class="line"><a name="l05262"></a><span class="lineno"> 5262</span>&#160;</div><div class="line"><a name="l05263"></a><span class="lineno"> 5263</span>&#160;    <span class="keywordflow">if</span> (!buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a9adb5a08b3c01be69c98360a14937227">ml_mfp</a>)</div><div class="line"><a name="l05264"></a><span class="lineno"> 5264</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l05265"></a><span class="lineno"> 5265</span>&#160;    <span class="keywordflow">for</span> (hp = buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a9adb5a08b3c01be69c98360a14937227">ml_mfp</a>-&gt;<a class="code" href="structmemfile.html#afad738129359e4b7fb943e3eedc2cdbd">mf_used_last</a>; hp != NULL; hp = hp-&gt;<a class="code" href="structblock__hdr.html#a43dfab09857d99015a29c95afa5097c8">bh_prev</a>)</div><div class="line"><a name="l05266"></a><span class="lineno"> 5266</span>&#160;    {</div><div class="line"><a name="l05267"></a><span class="lineno"> 5267</span>&#160;    <span class="keywordflow">if</span> (hp-&gt;bh_bnum == 0)</div><div class="line"><a name="l05268"></a><span class="lineno"> 5268</span>&#160;    {</div><div class="line"><a name="l05269"></a><span class="lineno"> 5269</span>&#160;        b0p = (<a class="code" href="structblock0.html">ZERO_BL</a> *)(hp-&gt;<a class="code" href="structblock__hdr.html#a7247cdc0977ab6fdc9cb6238cda67587">bh_data</a>);</div><div class="line"><a name="l05270"></a><span class="lineno"> 5270</span>&#160;        b0p-&gt;b0_dirty = buf-&gt;<a class="code" href="structfile__buffer.html#aa4b0a02270ec71cb25dbcb319d5e97b9">b_changed</a> ? <a class="code" href="memline_8c.html#aef48b3fc0252f461c7bce9fb717fc542">B0_DIRTY</a> : 0;</div><div class="line"><a name="l05271"></a><span class="lineno"> 5271</span>&#160;        b0p-&gt;b0_flags = (b0p-&gt;b0_flags &amp; ~<a class="code" href="memline_8c.html#ab299d2ddb4d4be7565b25e8a197e63bb">B0_FF_MASK</a>)</div><div class="line"><a name="l05272"></a><span class="lineno"> 5272</span>&#160;                          | (<a class="code" href="misc2_8c.html#a767812b118182564891e6c771b3a0da0">get_fileformat</a>(buf) + 1);</div><div class="line"><a name="l05273"></a><span class="lineno"> 5273</span>&#160;        <a class="code" href="memline_8c.html#a623f9a9406aa91cbaca6461d1ccc6804">add_b0_fenc</a>(b0p, buf);</div><div class="line"><a name="l05274"></a><span class="lineno"> 5274</span>&#160;        hp-&gt;<a class="code" href="structblock__hdr.html#a6b3dc819ce42874b30868feb20432954">bh_flags</a> |= <a class="code" href="structs_8h.html#a8f04cc51224fb39997cd1bd5658c9592">BH_DIRTY</a>;</div><div class="line"><a name="l05275"></a><span class="lineno"> 5275</span>&#160;        <a class="code" href="memfile_8c.html#a0a2aa007c9974950d936bcb9d739563a">mf_sync</a>(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a9adb5a08b3c01be69c98360a14937227">ml_mfp</a>, <a class="code" href="vim_8h.html#a066f9420ac6e8bdb62ec8f50c8ad8d9e">MFS_ZERO</a>);</div><div class="line"><a name="l05276"></a><span class="lineno"> 5276</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l05277"></a><span class="lineno"> 5277</span>&#160;    }</div><div class="line"><a name="l05278"></a><span class="lineno"> 5278</span>&#160;    }</div><div class="line"><a name="l05279"></a><span class="lineno"> 5279</span>&#160;}</div><div class="line"><a name="l05280"></a><span class="lineno"> 5280</span>&#160;</div><div class="line"><a name="l05281"></a><span class="lineno"> 5281</span>&#160;<span class="preprocessor">#if defined(FEAT_CRYPT) || defined(PROTO)</span></div><div class="line"><a name="l05282"></a><span class="lineno"> 5282</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l05283"></a><span class="lineno"> 5283</span>&#160;<span class="comment"> * If &quot;data&quot; points to a data block encrypt the text in it and return a copy</span></div><div class="line"><a name="l05284"></a><span class="lineno"> 5284</span>&#160;<span class="comment"> * in allocated memory.  Return NULL when out of memory.</span></div><div class="line"><a name="l05285"></a><span class="lineno"> 5285</span>&#160;<span class="comment"> * Otherwise return &quot;data&quot;.</span></div><div class="line"><a name="l05286"></a><span class="lineno"> 5286</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l05287"></a><span class="lineno"> 5287</span>&#160;    char_u *</div><div class="line"><a name="l05288"></a><span class="lineno"><a class="line" href="memline_8c.html#aecc37d45b88243de16ab309ec9a82f90"> 5288</a></span>&#160;<a class="code" href="memline_8c.html#aecc37d45b88243de16ab309ec9a82f90">ml_encrypt_data</a>(</div><div class="line"><a name="l05289"></a><span class="lineno"> 5289</span>&#160;    <a class="code" href="structmemfile.html">memfile_T</a>   *mfp,</div><div class="line"><a name="l05290"></a><span class="lineno"> 5290</span>&#160;    char_u  *data,</div><div class="line"><a name="l05291"></a><span class="lineno"> 5291</span>&#160;    <a class="code" href="vim_8h.html#ac86c7b16baf3bc83bef23b7e5e103ca9">off_T</a>   offset,</div><div class="line"><a name="l05292"></a><span class="lineno"> 5292</span>&#160;    <span class="keywordtype">unsigned</span>    <a class="code" href="gui__mac_8c.html#af0e67ea85e8470c85b7e79fd86b606cd">size</a>)</div><div class="line"><a name="l05293"></a><span class="lineno"> 5293</span>&#160;{</div><div class="line"><a name="l05294"></a><span class="lineno"> 5294</span>&#160;    <a class="code" href="structdata__block.html">DATA_BL</a> *dp = (<a class="code" href="structdata__block.html">DATA_BL</a> *)data;</div><div class="line"><a name="l05295"></a><span class="lineno"> 5295</span>&#160;    char_u  *head_end;</div><div class="line"><a name="l05296"></a><span class="lineno"> 5296</span>&#160;    char_u  *text_start;</div><div class="line"><a name="l05297"></a><span class="lineno"> 5297</span>&#160;    char_u  *new_data;</div><div class="line"><a name="l05298"></a><span class="lineno"> 5298</span>&#160;    <span class="keywordtype">int</span>     text_len;</div><div class="line"><a name="l05299"></a><span class="lineno"> 5299</span>&#160;    cryptstate_T *<a class="code" href="harness_8c.html#a3dca7dbebd89d0468bf40da6281614c8">state</a>;</div><div class="line"><a name="l05300"></a><span class="lineno"> 5300</span>&#160;</div><div class="line"><a name="l05301"></a><span class="lineno"> 5301</span>&#160;    <span class="keywordflow">if</span> (dp-&gt;<a class="code" href="structdata__block.html#ac977617f5f8153eda5d902a73e0379e1">db_id</a> != <a class="code" href="memline_8c.html#a55aa586df150c1192826a1c57dd87401">DATA_ID</a>)</div><div class="line"><a name="l05302"></a><span class="lineno"> 5302</span>&#160;    <span class="keywordflow">return</span> data;</div><div class="line"><a name="l05303"></a><span class="lineno"> 5303</span>&#160;</div><div class="line"><a name="l05304"></a><span class="lineno"> 5304</span>&#160;    state = <a class="code" href="memline_8c.html#a2249fb5b4839da11dd7db4635aaae6e3">ml_crypt_prepare</a>(mfp, offset, <a class="code" href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l05305"></a><span class="lineno"> 5305</span>&#160;    <span class="keywordflow">if</span> (state == NULL)</div><div class="line"><a name="l05306"></a><span class="lineno"> 5306</span>&#160;    <span class="keywordflow">return</span> data;</div><div class="line"><a name="l05307"></a><span class="lineno"> 5307</span>&#160;</div><div class="line"><a name="l05308"></a><span class="lineno"> 5308</span>&#160;    new_data = <a class="code" href="misc2_8c.html#ad0b64e14955781629a3908e328f82665">alloc</a>(size);</div><div class="line"><a name="l05309"></a><span class="lineno"> 5309</span>&#160;    <span class="keywordflow">if</span> (new_data == NULL)</div><div class="line"><a name="l05310"></a><span class="lineno"> 5310</span>&#160;    <span class="keywordflow">return</span> NULL;</div><div class="line"><a name="l05311"></a><span class="lineno"> 5311</span>&#160;    head_end = (char_u *)(&amp;dp-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[dp-&gt;<a class="code" href="structdata__block.html#a00084a39a3bdd9a03b9a055216aec5c5">db_line_count</a>]);</div><div class="line"><a name="l05312"></a><span class="lineno"> 5312</span>&#160;    text_start = (char_u *)dp + dp-&gt;<a class="code" href="structdata__block.html#a3937f5841b2fed9a042872981b06a7b8">db_txt_start</a>;</div><div class="line"><a name="l05313"></a><span class="lineno"> 5313</span>&#160;    text_len = size - dp-&gt;<a class="code" href="structdata__block.html#a3937f5841b2fed9a042872981b06a7b8">db_txt_start</a>;</div><div class="line"><a name="l05314"></a><span class="lineno"> 5314</span>&#160;</div><div class="line"><a name="l05315"></a><span class="lineno"> 5315</span>&#160;    <span class="comment">/* Copy the header and the text. */</span></div><div class="line"><a name="l05316"></a><span class="lineno"> 5316</span>&#160;    <a class="code" href="os__unix_8h.html#ae70108db942e4f3eeb701ad8787b1835">mch_memmove</a>(new_data, dp, head_end - (char_u *)dp);</div><div class="line"><a name="l05317"></a><span class="lineno"> 5317</span>&#160;</div><div class="line"><a name="l05318"></a><span class="lineno"> 5318</span>&#160;    <span class="comment">/* Encrypt the text. */</span></div><div class="line"><a name="l05319"></a><span class="lineno"> 5319</span>&#160;    <a class="code" href="crypt_8c.html#ab273525722dbaa361c3808437676c1cb">crypt_encode</a>(state, text_start, text_len, new_data + dp-&gt;<a class="code" href="structdata__block.html#a3937f5841b2fed9a042872981b06a7b8">db_txt_start</a>);</div><div class="line"><a name="l05320"></a><span class="lineno"> 5320</span>&#160;    <a class="code" href="crypt_8c.html#a5e97df05d361b7aa3a0cd069228dbc28">crypt_free_state</a>(state);</div><div class="line"><a name="l05321"></a><span class="lineno"> 5321</span>&#160;</div><div class="line"><a name="l05322"></a><span class="lineno"> 5322</span>&#160;    <span class="comment">/* Clear the gap. */</span></div><div class="line"><a name="l05323"></a><span class="lineno"> 5323</span>&#160;    <span class="keywordflow">if</span> (head_end &lt; text_start)</div><div class="line"><a name="l05324"></a><span class="lineno"> 5324</span>&#160;    <a class="code" href="misc2_8c.html#ae98dff29b2b09696996ab4ead873a667">vim_memset</a>(new_data + (head_end - data), 0, text_start - head_end);</div><div class="line"><a name="l05325"></a><span class="lineno"> 5325</span>&#160;</div><div class="line"><a name="l05326"></a><span class="lineno"> 5326</span>&#160;    <span class="keywordflow">return</span> new_data;</div><div class="line"><a name="l05327"></a><span class="lineno"> 5327</span>&#160;}</div><div class="line"><a name="l05328"></a><span class="lineno"> 5328</span>&#160;</div><div class="line"><a name="l05329"></a><span class="lineno"> 5329</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l05330"></a><span class="lineno"> 5330</span>&#160;<span class="comment"> * Decrypt the text in &quot;data&quot; if it points to an encrypted data block.</span></div><div class="line"><a name="l05331"></a><span class="lineno"> 5331</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l05332"></a><span class="lineno"> 5332</span>&#160;    <span class="keywordtype">void</span></div><div class="line"><a name="l05333"></a><span class="lineno"><a class="line" href="memline_8c.html#a194d4d2869af81a9b1007ec53994e435"> 5333</a></span>&#160;<a class="code" href="memline_8c.html#a194d4d2869af81a9b1007ec53994e435">ml_decrypt_data</a>(</div><div class="line"><a name="l05334"></a><span class="lineno"> 5334</span>&#160;    <a class="code" href="structmemfile.html">memfile_T</a>   *mfp,</div><div class="line"><a name="l05335"></a><span class="lineno"> 5335</span>&#160;    char_u  *data,</div><div class="line"><a name="l05336"></a><span class="lineno"> 5336</span>&#160;    <a class="code" href="vim_8h.html#ac86c7b16baf3bc83bef23b7e5e103ca9">off_T</a>   offset,</div><div class="line"><a name="l05337"></a><span class="lineno"> 5337</span>&#160;    <span class="keywordtype">unsigned</span>    <a class="code" href="gui__mac_8c.html#af0e67ea85e8470c85b7e79fd86b606cd">size</a>)</div><div class="line"><a name="l05338"></a><span class="lineno"> 5338</span>&#160;{</div><div class="line"><a name="l05339"></a><span class="lineno"> 5339</span>&#160;    <a class="code" href="structdata__block.html">DATA_BL</a> *dp = (<a class="code" href="structdata__block.html">DATA_BL</a> *)data;</div><div class="line"><a name="l05340"></a><span class="lineno"> 5340</span>&#160;    char_u  *head_end;</div><div class="line"><a name="l05341"></a><span class="lineno"> 5341</span>&#160;    char_u  *text_start;</div><div class="line"><a name="l05342"></a><span class="lineno"> 5342</span>&#160;    <span class="keywordtype">int</span>     text_len;</div><div class="line"><a name="l05343"></a><span class="lineno"> 5343</span>&#160;    cryptstate_T *<a class="code" href="harness_8c.html#a3dca7dbebd89d0468bf40da6281614c8">state</a>;</div><div class="line"><a name="l05344"></a><span class="lineno"> 5344</span>&#160;</div><div class="line"><a name="l05345"></a><span class="lineno"> 5345</span>&#160;    <span class="keywordflow">if</span> (dp-&gt;<a class="code" href="structdata__block.html#ac977617f5f8153eda5d902a73e0379e1">db_id</a> == <a class="code" href="memline_8c.html#a55aa586df150c1192826a1c57dd87401">DATA_ID</a>)</div><div class="line"><a name="l05346"></a><span class="lineno"> 5346</span>&#160;    {</div><div class="line"><a name="l05347"></a><span class="lineno"> 5347</span>&#160;    head_end = (char_u *)(&amp;dp-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[dp-&gt;<a class="code" href="structdata__block.html#a00084a39a3bdd9a03b9a055216aec5c5">db_line_count</a>]);</div><div class="line"><a name="l05348"></a><span class="lineno"> 5348</span>&#160;    text_start = (char_u *)dp + dp-&gt;<a class="code" href="structdata__block.html#a3937f5841b2fed9a042872981b06a7b8">db_txt_start</a>;</div><div class="line"><a name="l05349"></a><span class="lineno"> 5349</span>&#160;    text_len = dp-&gt;<a class="code" href="structdata__block.html#ae079e3993bfc47bd86fd6e2fc3ab44ba">db_txt_end</a> - dp-&gt;<a class="code" href="structdata__block.html#a3937f5841b2fed9a042872981b06a7b8">db_txt_start</a>;</div><div class="line"><a name="l05350"></a><span class="lineno"> 5350</span>&#160;</div><div class="line"><a name="l05351"></a><span class="lineno"> 5351</span>&#160;    if (head_end &gt; text_start || dp-&gt;<a class="code" href="structdata__block.html#a3937f5841b2fed9a042872981b06a7b8">db_txt_start</a> &gt; size</div><div class="line"><a name="l05352"></a><span class="lineno"> 5352</span>&#160;                             || dp-&gt;<a class="code" href="structdata__block.html#ae079e3993bfc47bd86fd6e2fc3ab44ba">db_txt_end</a> &gt; size)</div><div class="line"><a name="l05353"></a><span class="lineno"> 5353</span>&#160;        <span class="keywordflow">return</span>;  <span class="comment">/* data was messed up */</span></div><div class="line"><a name="l05354"></a><span class="lineno"> 5354</span>&#160;</div><div class="line"><a name="l05355"></a><span class="lineno"> 5355</span>&#160;    state = <a class="code" href="memline_8c.html#a2249fb5b4839da11dd7db4635aaae6e3">ml_crypt_prepare</a>(mfp, offset, <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div><div class="line"><a name="l05356"></a><span class="lineno"> 5356</span>&#160;    <span class="keywordflow">if</span> (state != NULL)</div><div class="line"><a name="l05357"></a><span class="lineno"> 5357</span>&#160;    {</div><div class="line"><a name="l05358"></a><span class="lineno"> 5358</span>&#160;        <span class="comment">/* Decrypt the text in place. */</span></div><div class="line"><a name="l05359"></a><span class="lineno"> 5359</span>&#160;        <a class="code" href="crypt_8c.html#a030bf2af55ba450f83a172aa68f9434c">crypt_decode_inplace</a>(state, text_start, text_len);</div><div class="line"><a name="l05360"></a><span class="lineno"> 5360</span>&#160;        <a class="code" href="crypt_8c.html#a5e97df05d361b7aa3a0cd069228dbc28">crypt_free_state</a>(state);</div><div class="line"><a name="l05361"></a><span class="lineno"> 5361</span>&#160;    }</div><div class="line"><a name="l05362"></a><span class="lineno"> 5362</span>&#160;    }</div><div class="line"><a name="l05363"></a><span class="lineno"> 5363</span>&#160;}</div><div class="line"><a name="l05364"></a><span class="lineno"> 5364</span>&#160;</div><div class="line"><a name="l05365"></a><span class="lineno"> 5365</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l05366"></a><span class="lineno"> 5366</span>&#160;<span class="comment"> * Prepare for encryption/decryption, using the key, seed and offset.</span></div><div class="line"><a name="l05367"></a><span class="lineno"> 5367</span>&#160;<span class="comment"> * Return an allocated cryptstate_T *.</span></div><div class="line"><a name="l05368"></a><span class="lineno"> 5368</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l05369"></a><span class="lineno"> 5369</span>&#160;    <span class="keyword">static</span> cryptstate_T *</div><div class="line"><a name="l05370"></a><span class="lineno"><a class="line" href="memline_8c.html#a2249fb5b4839da11dd7db4635aaae6e3"> 5370</a></span>&#160;<a class="code" href="memline_8c.html#a2249fb5b4839da11dd7db4635aaae6e3">ml_crypt_prepare</a>(<a class="code" href="structmemfile.html">memfile_T</a> *mfp, <a class="code" href="vim_8h.html#ac86c7b16baf3bc83bef23b7e5e103ca9">off_T</a> offset, <span class="keywordtype">int</span> reading)</div><div class="line"><a name="l05371"></a><span class="lineno"> 5371</span>&#160;{</div><div class="line"><a name="l05372"></a><span class="lineno"> 5372</span>&#160;    <a class="code" href="structfile__buffer.html">buf_T</a>   *buf = mfp-&gt;mf_buffer;</div><div class="line"><a name="l05373"></a><span class="lineno"> 5373</span>&#160;    char_u  salt[50];</div><div class="line"><a name="l05374"></a><span class="lineno"> 5374</span>&#160;    <span class="keywordtype">int</span>     method_nr;</div><div class="line"><a name="l05375"></a><span class="lineno"> 5375</span>&#160;    char_u  *key;</div><div class="line"><a name="l05376"></a><span class="lineno"> 5376</span>&#160;    char_u  *seed;</div><div class="line"><a name="l05377"></a><span class="lineno"> 5377</span>&#160;</div><div class="line"><a name="l05378"></a><span class="lineno"> 5378</span>&#160;    <span class="keywordflow">if</span> (reading &amp;&amp; mfp-&gt;mf_old_key != NULL)</div><div class="line"><a name="l05379"></a><span class="lineno"> 5379</span>&#160;    {</div><div class="line"><a name="l05380"></a><span class="lineno"> 5380</span>&#160;    <span class="comment">/* Reading back blocks with the previous key/method/seed. */</span></div><div class="line"><a name="l05381"></a><span class="lineno"> 5381</span>&#160;    method_nr = mfp-&gt;mf_old_cm;</div><div class="line"><a name="l05382"></a><span class="lineno"> 5382</span>&#160;    key = mfp-&gt;mf_old_key;</div><div class="line"><a name="l05383"></a><span class="lineno"> 5383</span>&#160;    seed = mfp-&gt;mf_old_seed;</div><div class="line"><a name="l05384"></a><span class="lineno"> 5384</span>&#160;    }</div><div class="line"><a name="l05385"></a><span class="lineno"> 5385</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l05386"></a><span class="lineno"> 5386</span>&#160;    {</div><div class="line"><a name="l05387"></a><span class="lineno"> 5387</span>&#160;    method_nr = <a class="code" href="crypt_8c.html#a2224d31da3a71d7ae8022b582508090c">crypt_get_method_nr</a>(buf);</div><div class="line"><a name="l05388"></a><span class="lineno"> 5388</span>&#160;    key = buf-&gt;b_p_key;</div><div class="line"><a name="l05389"></a><span class="lineno"> 5389</span>&#160;    seed = mfp-&gt;mf_seed;</div><div class="line"><a name="l05390"></a><span class="lineno"> 5390</span>&#160;    }</div><div class="line"><a name="l05391"></a><span class="lineno"> 5391</span>&#160;    <span class="keywordflow">if</span> (*key == <a class="code" href="ascii_8h.html#af19d48b9f61047a668649a2f9dc317ff">NUL</a>)</div><div class="line"><a name="l05392"></a><span class="lineno"> 5392</span>&#160;    <span class="keywordflow">return</span> NULL;</div><div class="line"><a name="l05393"></a><span class="lineno"> 5393</span>&#160;</div><div class="line"><a name="l05394"></a><span class="lineno"> 5394</span>&#160;    <span class="keywordflow">if</span> (method_nr == CRYPT_M_ZIP)</div><div class="line"><a name="l05395"></a><span class="lineno"> 5395</span>&#160;    {</div><div class="line"><a name="l05396"></a><span class="lineno"> 5396</span>&#160;    <span class="comment">/* For PKzip: Append the offset to the key, so that we use a different</span></div><div class="line"><a name="l05397"></a><span class="lineno"> 5397</span>&#160;<span class="comment">     * key for every block. */</span></div><div class="line"><a name="l05398"></a><span class="lineno"> 5398</span>&#160;    <a class="code" href="message_8c.html#a3fb83ee5435e868683ecb3e44020f3b2">vim_snprintf</a>((<span class="keywordtype">char</span> *)salt, <span class="keyword">sizeof</span>(salt), <span class="stringliteral">&quot;%s%ld&quot;</span>, key, (<span class="keywordtype">long</span>)offset);</div><div class="line"><a name="l05399"></a><span class="lineno"> 5399</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="crypt_8c.html#a7246e308e1dcfe42d01aae41dfcb1841">crypt_create</a>(method_nr, salt, NULL, 0, NULL, 0);</div><div class="line"><a name="l05400"></a><span class="lineno"> 5400</span>&#160;    }</div><div class="line"><a name="l05401"></a><span class="lineno"> 5401</span>&#160;</div><div class="line"><a name="l05402"></a><span class="lineno"> 5402</span>&#160;    <span class="comment">/* Using blowfish or better: add salt and seed. We use the byte offset</span></div><div class="line"><a name="l05403"></a><span class="lineno"> 5403</span>&#160;<span class="comment">     * of the block for the salt. */</span></div><div class="line"><a name="l05404"></a><span class="lineno"> 5404</span>&#160;    <a class="code" href="message_8c.html#a3fb83ee5435e868683ecb3e44020f3b2">vim_snprintf</a>((<span class="keywordtype">char</span> *)salt, <span class="keyword">sizeof</span>(salt), <span class="stringliteral">&quot;%ld&quot;</span>, (<span class="keywordtype">long</span>)offset);</div><div class="line"><a name="l05405"></a><span class="lineno"> 5405</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="crypt_8c.html#a7246e308e1dcfe42d01aae41dfcb1841">crypt_create</a>(method_nr, key, salt, (<span class="keywordtype">int</span>)<a class="code" href="vim_8h.html#a916ffefe1fc74532d08102cca55d8e34">STRLEN</a>(salt),</div><div class="line"><a name="l05406"></a><span class="lineno"> 5406</span>&#160;                               seed, <a class="code" href="structs_8h.html#a7cf2da642c785ee805f57988d6dd4267">MF_SEED_LEN</a>);</div><div class="line"><a name="l05407"></a><span class="lineno"> 5407</span>&#160;}</div><div class="line"><a name="l05408"></a><span class="lineno"> 5408</span>&#160;</div><div class="line"><a name="l05409"></a><span class="lineno"> 5409</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l05410"></a><span class="lineno"> 5410</span>&#160;</div><div class="line"><a name="l05411"></a><span class="lineno"> 5411</span>&#160;</div><div class="line"><a name="l05412"></a><span class="lineno"> 5412</span>&#160;<span class="preprocessor">#if defined(FEAT_BYTEOFF) || defined(PROTO)</span></div><div class="line"><a name="l05413"></a><span class="lineno"> 5413</span>&#160;</div><div class="line"><a name="l05414"></a><span class="lineno"><a class="line" href="memline_8c.html#a56fd6f4544b4cd78e033dc86549c4d42"> 5414</a></span>&#160;<span class="preprocessor">#define MLCS_MAXL 800   </span><span class="comment">/* max no of lines in chunk */</span><span class="preprocessor"></span></div><div class="line"><a name="l05415"></a><span class="lineno"><a class="line" href="memline_8c.html#ab87e6b87865bb131c623e02c394ab683"> 5415</a></span>&#160;<span class="preprocessor">#define MLCS_MINL 400   </span><span class="comment">/* should be half of MLCS_MAXL */</span><span class="preprocessor"></span></div><div class="line"><a name="l05416"></a><span class="lineno"> 5416</span>&#160;</div><div class="line"><a name="l05417"></a><span class="lineno"> 5417</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l05418"></a><span class="lineno"> 5418</span>&#160;<span class="comment"> * Keep information for finding byte offset of a line, updtype may be one of:</span></div><div class="line"><a name="l05419"></a><span class="lineno"> 5419</span>&#160;<span class="comment"> * ML_CHNK_ADDLINE: Add len to parent chunk, possibly splitting it</span></div><div class="line"><a name="l05420"></a><span class="lineno"> 5420</span>&#160;<span class="comment"> *     Careful: ML_CHNK_ADDLINE may cause ml_find_line() to be called.</span></div><div class="line"><a name="l05421"></a><span class="lineno"> 5421</span>&#160;<span class="comment"> * ML_CHNK_DELLINE: Subtract len from parent chunk, possibly deleting it</span></div><div class="line"><a name="l05422"></a><span class="lineno"> 5422</span>&#160;<span class="comment"> * ML_CHNK_UPDLINE: Add len to parent chunk, as a signed entity.</span></div><div class="line"><a name="l05423"></a><span class="lineno"> 5423</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l05424"></a><span class="lineno"> 5424</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">void</span></div><div class="line"><a name="l05425"></a><span class="lineno"><a class="line" href="memline_8c.html#ae8486bd6f1922d43b60969e2be927915"> 5425</a></span>&#160;<a class="code" href="memline_8c.html#ae8486bd6f1922d43b60969e2be927915">ml_updatechunk</a>(</div><div class="line"><a name="l05426"></a><span class="lineno"> 5426</span>&#160;    <a class="code" href="structfile__buffer.html">buf_T</a>   *buf,</div><div class="line"><a name="l05427"></a><span class="lineno"> 5427</span>&#160;    <a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>    line,</div><div class="line"><a name="l05428"></a><span class="lineno"> 5428</span>&#160;    <span class="keywordtype">long</span>    len,</div><div class="line"><a name="l05429"></a><span class="lineno"> 5429</span>&#160;    <span class="keywordtype">int</span>     updtype)</div><div class="line"><a name="l05430"></a><span class="lineno"> 5430</span>&#160;{</div><div class="line"><a name="l05431"></a><span class="lineno"> 5431</span>&#160;    <span class="keyword">static</span> <a class="code" href="structfile__buffer.html">buf_T</a>    *ml_upd_lastbuf = NULL;</div><div class="line"><a name="l05432"></a><span class="lineno"> 5432</span>&#160;    <span class="keyword">static</span> <a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a> ml_upd_lastline;</div><div class="line"><a name="l05433"></a><span class="lineno"> 5433</span>&#160;    <span class="keyword">static</span> <a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a> ml_upd_lastcurline;</div><div class="line"><a name="l05434"></a><span class="lineno"> 5434</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">int</span>      ml_upd_lastcurix;</div><div class="line"><a name="l05435"></a><span class="lineno"> 5435</span>&#160;</div><div class="line"><a name="l05436"></a><span class="lineno"> 5436</span>&#160;    <a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>        curline = ml_upd_lastcurline;</div><div class="line"><a name="l05437"></a><span class="lineno"> 5437</span>&#160;    <span class="keywordtype">int</span>         curix = ml_upd_lastcurix;</div><div class="line"><a name="l05438"></a><span class="lineno"> 5438</span>&#160;    <span class="keywordtype">long</span>        <a class="code" href="gui__mac_8c.html#af0e67ea85e8470c85b7e79fd86b606cd">size</a>;</div><div class="line"><a name="l05439"></a><span class="lineno"> 5439</span>&#160;    chunksize_T     *curchnk;</div><div class="line"><a name="l05440"></a><span class="lineno"> 5440</span>&#160;    <span class="keywordtype">int</span>         rest;</div><div class="line"><a name="l05441"></a><span class="lineno"> 5441</span>&#160;    <a class="code" href="structblock__hdr.html">bhdr_T</a>      *hp;</div><div class="line"><a name="l05442"></a><span class="lineno"> 5442</span>&#160;    <a class="code" href="structdata__block.html">DATA_BL</a>     *dp;</div><div class="line"><a name="l05443"></a><span class="lineno"> 5443</span>&#160;</div><div class="line"><a name="l05444"></a><span class="lineno"> 5444</span>&#160;    <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_usedchunks == -1 || len == 0)</div><div class="line"><a name="l05445"></a><span class="lineno"> 5445</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l05446"></a><span class="lineno"> 5446</span>&#160;    <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_chunksize == NULL)</div><div class="line"><a name="l05447"></a><span class="lineno"> 5447</span>&#160;    {</div><div class="line"><a name="l05448"></a><span class="lineno"> 5448</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_chunksize = <a class="code" href="vim_8h.html#a22743f1c6b7f2b83c4a99f8ac1a5d454">ALLOC_MULT</a>(chunksize_T, 100);</div><div class="line"><a name="l05449"></a><span class="lineno"> 5449</span>&#160;    <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_chunksize == NULL)</div><div class="line"><a name="l05450"></a><span class="lineno"> 5450</span>&#160;    {</div><div class="line"><a name="l05451"></a><span class="lineno"> 5451</span>&#160;        buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_usedchunks = -1;</div><div class="line"><a name="l05452"></a><span class="lineno"> 5452</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l05453"></a><span class="lineno"> 5453</span>&#160;    }</div><div class="line"><a name="l05454"></a><span class="lineno"> 5454</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_numchunks = 100;</div><div class="line"><a name="l05455"></a><span class="lineno"> 5455</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_usedchunks = 1;</div><div class="line"><a name="l05456"></a><span class="lineno"> 5456</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_chunksize[0].mlcs_numlines = 1;</div><div class="line"><a name="l05457"></a><span class="lineno"> 5457</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_chunksize[0].mlcs_totalsize = 1;</div><div class="line"><a name="l05458"></a><span class="lineno"> 5458</span>&#160;    }</div><div class="line"><a name="l05459"></a><span class="lineno"> 5459</span>&#160;</div><div class="line"><a name="l05460"></a><span class="lineno"> 5460</span>&#160;    <span class="keywordflow">if</span> (updtype == ML_CHNK_UPDLINE &amp;&amp; buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a708091d31fa9cf7718aca80d707b1b3d">ml_line_count</a> == 1)</div><div class="line"><a name="l05461"></a><span class="lineno"> 5461</span>&#160;    {</div><div class="line"><a name="l05462"></a><span class="lineno"> 5462</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l05463"></a><span class="lineno"> 5463</span>&#160;<span class="comment">     * First line in empty buffer from ml_flush_line() -- reset</span></div><div class="line"><a name="l05464"></a><span class="lineno"> 5464</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l05465"></a><span class="lineno"> 5465</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_usedchunks = 1;</div><div class="line"><a name="l05466"></a><span class="lineno"> 5466</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_chunksize[0].mlcs_numlines = 1;</div><div class="line"><a name="l05467"></a><span class="lineno"> 5467</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_chunksize[0].mlcs_totalsize = (long)buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#ae775dd7dfa8b3dcaa01a9b3fa030371a">ml_line_len</a>;</div><div class="line"><a name="l05468"></a><span class="lineno"> 5468</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l05469"></a><span class="lineno"> 5469</span>&#160;    }</div><div class="line"><a name="l05470"></a><span class="lineno"> 5470</span>&#160;</div><div class="line"><a name="l05471"></a><span class="lineno"> 5471</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l05472"></a><span class="lineno"> 5472</span>&#160;<span class="comment">     * Find chunk that our line belongs to, curline will be at start of the</span></div><div class="line"><a name="l05473"></a><span class="lineno"> 5473</span>&#160;<span class="comment">     * chunk.</span></div><div class="line"><a name="l05474"></a><span class="lineno"> 5474</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l05475"></a><span class="lineno"> 5475</span>&#160;    <span class="keywordflow">if</span> (buf != ml_upd_lastbuf || line != ml_upd_lastline + 1</div><div class="line"><a name="l05476"></a><span class="lineno"> 5476</span>&#160;        || updtype != ML_CHNK_ADDLINE)</div><div class="line"><a name="l05477"></a><span class="lineno"> 5477</span>&#160;    {</div><div class="line"><a name="l05478"></a><span class="lineno"> 5478</span>&#160;    <span class="keywordflow">for</span> (curline = 1, curix = 0;</div><div class="line"><a name="l05479"></a><span class="lineno"> 5479</span>&#160;         curix &lt; buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_usedchunks - 1</div><div class="line"><a name="l05480"></a><span class="lineno"> 5480</span>&#160;         &amp;&amp; line &gt;= curline + buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_chunksize[curix].mlcs_numlines;</div><div class="line"><a name="l05481"></a><span class="lineno"> 5481</span>&#160;         curix++)</div><div class="line"><a name="l05482"></a><span class="lineno"> 5482</span>&#160;        curline += buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_chunksize[curix].mlcs_numlines;</div><div class="line"><a name="l05483"></a><span class="lineno"> 5483</span>&#160;    }</div><div class="line"><a name="l05484"></a><span class="lineno"> 5484</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (curix &lt; buf-&gt;b_ml.ml_usedchunks - 1</div><div class="line"><a name="l05485"></a><span class="lineno"> 5485</span>&#160;          &amp;&amp; line &gt;= curline + buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_chunksize[curix].mlcs_numlines)</div><div class="line"><a name="l05486"></a><span class="lineno"> 5486</span>&#160;    {</div><div class="line"><a name="l05487"></a><span class="lineno"> 5487</span>&#160;    <span class="comment">/* Adjust cached curix &amp; curline */</span></div><div class="line"><a name="l05488"></a><span class="lineno"> 5488</span>&#160;    curline += buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_chunksize[curix].mlcs_numlines;</div><div class="line"><a name="l05489"></a><span class="lineno"> 5489</span>&#160;    curix++;</div><div class="line"><a name="l05490"></a><span class="lineno"> 5490</span>&#160;    }</div><div class="line"><a name="l05491"></a><span class="lineno"> 5491</span>&#160;    curchnk = buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_chunksize + curix;</div><div class="line"><a name="l05492"></a><span class="lineno"> 5492</span>&#160;</div><div class="line"><a name="l05493"></a><span class="lineno"> 5493</span>&#160;    <span class="keywordflow">if</span> (updtype == ML_CHNK_DELLINE)</div><div class="line"><a name="l05494"></a><span class="lineno"> 5494</span>&#160;    len = -len;</div><div class="line"><a name="l05495"></a><span class="lineno"> 5495</span>&#160;    curchnk-&gt;mlcs_totalsize += len;</div><div class="line"><a name="l05496"></a><span class="lineno"> 5496</span>&#160;    <span class="keywordflow">if</span> (updtype == ML_CHNK_ADDLINE)</div><div class="line"><a name="l05497"></a><span class="lineno"> 5497</span>&#160;    {</div><div class="line"><a name="l05498"></a><span class="lineno"> 5498</span>&#160;    curchnk-&gt;mlcs_numlines++;</div><div class="line"><a name="l05499"></a><span class="lineno"> 5499</span>&#160;</div><div class="line"><a name="l05500"></a><span class="lineno"> 5500</span>&#160;    <span class="comment">/* May resize here so we don&#39;t have to do it in both cases below */</span></div><div class="line"><a name="l05501"></a><span class="lineno"> 5501</span>&#160;    <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_usedchunks + 1 &gt;= buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_numchunks)</div><div class="line"><a name="l05502"></a><span class="lineno"> 5502</span>&#160;    {</div><div class="line"><a name="l05503"></a><span class="lineno"> 5503</span>&#160;        chunksize_T *t_chunksize = buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_chunksize;</div><div class="line"><a name="l05504"></a><span class="lineno"> 5504</span>&#160;</div><div class="line"><a name="l05505"></a><span class="lineno"> 5505</span>&#160;        buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_numchunks = buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_numchunks * 3 / 2;</div><div class="line"><a name="l05506"></a><span class="lineno"> 5506</span>&#160;        buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_chunksize = (chunksize_T *)</div><div class="line"><a name="l05507"></a><span class="lineno"> 5507</span>&#160;        <a class="code" href="vim_8h.html#a161e00310e38bdf5ad08c3f7b0130069">vim_realloc</a>(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_chunksize,</div><div class="line"><a name="l05508"></a><span class="lineno"> 5508</span>&#160;                <span class="keyword">sizeof</span>(chunksize_T) * buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_numchunks);</div><div class="line"><a name="l05509"></a><span class="lineno"> 5509</span>&#160;        <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_chunksize == NULL)</div><div class="line"><a name="l05510"></a><span class="lineno"> 5510</span>&#160;        {</div><div class="line"><a name="l05511"></a><span class="lineno"> 5511</span>&#160;        <span class="comment">/* Hmmmm, Give up on offset for this buffer */</span></div><div class="line"><a name="l05512"></a><span class="lineno"> 5512</span>&#160;        <a class="code" href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a>(t_chunksize);</div><div class="line"><a name="l05513"></a><span class="lineno"> 5513</span>&#160;        buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_usedchunks = -1;</div><div class="line"><a name="l05514"></a><span class="lineno"> 5514</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l05515"></a><span class="lineno"> 5515</span>&#160;        }</div><div class="line"><a name="l05516"></a><span class="lineno"> 5516</span>&#160;    }</div><div class="line"><a name="l05517"></a><span class="lineno"> 5517</span>&#160;</div><div class="line"><a name="l05518"></a><span class="lineno"> 5518</span>&#160;    <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_chunksize[curix].mlcs_numlines &gt;= <a class="code" href="memline_8c.html#a56fd6f4544b4cd78e033dc86549c4d42">MLCS_MAXL</a>)</div><div class="line"><a name="l05519"></a><span class="lineno"> 5519</span>&#160;    {</div><div class="line"><a name="l05520"></a><span class="lineno"> 5520</span>&#160;        <span class="keywordtype">int</span>     count;      <span class="comment">/* number of entries in block */</span></div><div class="line"><a name="l05521"></a><span class="lineno"> 5521</span>&#160;        <span class="keywordtype">int</span>     idx;</div><div class="line"><a name="l05522"></a><span class="lineno"> 5522</span>&#160;        <span class="keywordtype">int</span>     end_idx;</div><div class="line"><a name="l05523"></a><span class="lineno"> 5523</span>&#160;        <span class="keywordtype">int</span>     text_end;</div><div class="line"><a name="l05524"></a><span class="lineno"> 5524</span>&#160;        <span class="keywordtype">int</span>     linecnt;</div><div class="line"><a name="l05525"></a><span class="lineno"> 5525</span>&#160;</div><div class="line"><a name="l05526"></a><span class="lineno"> 5526</span>&#160;        <a class="code" href="os__unix_8h.html#ae70108db942e4f3eeb701ad8787b1835">mch_memmove</a>(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_chunksize + curix + 1,</div><div class="line"><a name="l05527"></a><span class="lineno"> 5527</span>&#160;            buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_chunksize + curix,</div><div class="line"><a name="l05528"></a><span class="lineno"> 5528</span>&#160;            (buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_usedchunks - curix) *</div><div class="line"><a name="l05529"></a><span class="lineno"> 5529</span>&#160;            <span class="keyword">sizeof</span>(chunksize_T));</div><div class="line"><a name="l05530"></a><span class="lineno"> 5530</span>&#160;        <span class="comment">/* Compute length of first half of lines in the split chunk */</span></div><div class="line"><a name="l05531"></a><span class="lineno"> 5531</span>&#160;        size = 0;</div><div class="line"><a name="l05532"></a><span class="lineno"> 5532</span>&#160;        linecnt = 0;</div><div class="line"><a name="l05533"></a><span class="lineno"> 5533</span>&#160;        <span class="keywordflow">while</span> (curline &lt; buf-&gt;b_ml.ml_line_count</div><div class="line"><a name="l05534"></a><span class="lineno"> 5534</span>&#160;            &amp;&amp; linecnt &lt; <a class="code" href="memline_8c.html#ab87e6b87865bb131c623e02c394ab683">MLCS_MINL</a>)</div><div class="line"><a name="l05535"></a><span class="lineno"> 5535</span>&#160;        {</div><div class="line"><a name="l05536"></a><span class="lineno"> 5536</span>&#160;        <span class="keywordflow">if</span> ((hp = <a class="code" href="memline_8c.html#ade8fe98188345bdd3c230545fc4a614f">ml_find_line</a>(buf, curline, <a class="code" href="memline_8c.html#a1de07181f87bda4348b87eb71e0ab526">ML_FIND</a>)) == NULL)</div><div class="line"><a name="l05537"></a><span class="lineno"> 5537</span>&#160;        {</div><div class="line"><a name="l05538"></a><span class="lineno"> 5538</span>&#160;            buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_usedchunks = -1;</div><div class="line"><a name="l05539"></a><span class="lineno"> 5539</span>&#160;            <span class="keywordflow">return</span>;</div><div class="line"><a name="l05540"></a><span class="lineno"> 5540</span>&#160;        }</div><div class="line"><a name="l05541"></a><span class="lineno"> 5541</span>&#160;        dp = (<a class="code" href="structdata__block.html">DATA_BL</a> *)(hp-&gt;<a class="code" href="structblock__hdr.html#a7247cdc0977ab6fdc9cb6238cda67587">bh_data</a>);</div><div class="line"><a name="l05542"></a><span class="lineno"> 5542</span>&#160;        count = (long)(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a81788089e53748eb945a88d6e41647da">ml_locked_high</a>) -</div><div class="line"><a name="l05543"></a><span class="lineno"> 5543</span>&#160;            (long)(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a2b7c6e30401df9d0e8972cb639d1b895">ml_locked_low</a>) + 1;</div><div class="line"><a name="l05544"></a><span class="lineno"> 5544</span>&#160;        idx = curline - buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a2b7c6e30401df9d0e8972cb639d1b895">ml_locked_low</a>;</div><div class="line"><a name="l05545"></a><span class="lineno"> 5545</span>&#160;        curline = buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a81788089e53748eb945a88d6e41647da">ml_locked_high</a> + 1;</div><div class="line"><a name="l05546"></a><span class="lineno"> 5546</span>&#160;</div><div class="line"><a name="l05547"></a><span class="lineno"> 5547</span>&#160;        <span class="comment">// compute index of last line to use in this MEMLINE</span></div><div class="line"><a name="l05548"></a><span class="lineno"> 5548</span>&#160;        rest = count - idx;</div><div class="line"><a name="l05549"></a><span class="lineno"> 5549</span>&#160;        <span class="keywordflow">if</span> (linecnt + rest &gt; <a class="code" href="memline_8c.html#ab87e6b87865bb131c623e02c394ab683">MLCS_MINL</a>)</div><div class="line"><a name="l05550"></a><span class="lineno"> 5550</span>&#160;        {</div><div class="line"><a name="l05551"></a><span class="lineno"> 5551</span>&#160;            end_idx = idx + <a class="code" href="memline_8c.html#ab87e6b87865bb131c623e02c394ab683">MLCS_MINL</a> - linecnt - 1;</div><div class="line"><a name="l05552"></a><span class="lineno"> 5552</span>&#160;            linecnt = <a class="code" href="memline_8c.html#ab87e6b87865bb131c623e02c394ab683">MLCS_MINL</a>;</div><div class="line"><a name="l05553"></a><span class="lineno"> 5553</span>&#160;        }</div><div class="line"><a name="l05554"></a><span class="lineno"> 5554</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l05555"></a><span class="lineno"> 5555</span>&#160;        {</div><div class="line"><a name="l05556"></a><span class="lineno"> 5556</span>&#160;            end_idx = count - 1;</div><div class="line"><a name="l05557"></a><span class="lineno"> 5557</span>&#160;            linecnt += rest;</div><div class="line"><a name="l05558"></a><span class="lineno"> 5558</span>&#160;        }</div><div class="line"><a name="l05559"></a><span class="lineno"> 5559</span>&#160;<span class="preprocessor">#ifdef FEAT_TEXT_PROP</span></div><div class="line"><a name="l05560"></a><span class="lineno"> 5560</span>&#160;        <span class="keywordflow">if</span> (buf-&gt;b_has_textprop)</div><div class="line"><a name="l05561"></a><span class="lineno"> 5561</span>&#160;        {</div><div class="line"><a name="l05562"></a><span class="lineno"> 5562</span>&#160;            <span class="keywordtype">int</span> i;</div><div class="line"><a name="l05563"></a><span class="lineno"> 5563</span>&#160;</div><div class="line"><a name="l05564"></a><span class="lineno"> 5564</span>&#160;            <span class="comment">// We cannot use the text pointers to get the text length,</span></div><div class="line"><a name="l05565"></a><span class="lineno"> 5565</span>&#160;            <span class="comment">// the text prop info would also be counted.  Go over the</span></div><div class="line"><a name="l05566"></a><span class="lineno"> 5566</span>&#160;            <span class="comment">// lines.</span></div><div class="line"><a name="l05567"></a><span class="lineno"> 5567</span>&#160;            <span class="keywordflow">for</span> (i = end_idx; i &lt; idx; ++i)</div><div class="line"><a name="l05568"></a><span class="lineno"> 5568</span>&#160;            size += (<span class="keywordtype">int</span>)<a class="code" href="vim_8h.html#a916ffefe1fc74532d08102cca55d8e34">STRLEN</a>((char_u *)dp + (dp-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[i] &amp; <a class="code" href="memline_8c.html#ab65775db0f7dbf161fce05ee7fb36573">DB_INDEX_MASK</a>)) + 1;</div><div class="line"><a name="l05569"></a><span class="lineno"> 5569</span>&#160;        }</div><div class="line"><a name="l05570"></a><span class="lineno"> 5570</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l05571"></a><span class="lineno"> 5571</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l05572"></a><span class="lineno"> 5572</span>&#160;        {</div><div class="line"><a name="l05573"></a><span class="lineno"> 5573</span>&#160;            <span class="keywordflow">if</span> (idx == 0)<span class="comment">/* first line in block, text at the end */</span></div><div class="line"><a name="l05574"></a><span class="lineno"> 5574</span>&#160;            text_end = dp-&gt;<a class="code" href="structdata__block.html#ae079e3993bfc47bd86fd6e2fc3ab44ba">db_txt_end</a>;</div><div class="line"><a name="l05575"></a><span class="lineno"> 5575</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l05576"></a><span class="lineno"> 5576</span>&#160;            text_end = ((dp-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[idx - 1]) &amp; <a class="code" href="memline_8c.html#ab65775db0f7dbf161fce05ee7fb36573">DB_INDEX_MASK</a>);</div><div class="line"><a name="l05577"></a><span class="lineno"> 5577</span>&#160;            size += text_end - ((dp-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[end_idx]) &amp; <a class="code" href="memline_8c.html#ab65775db0f7dbf161fce05ee7fb36573">DB_INDEX_MASK</a>);</div><div class="line"><a name="l05578"></a><span class="lineno"> 5578</span>&#160;        }</div><div class="line"><a name="l05579"></a><span class="lineno"> 5579</span>&#160;        }</div><div class="line"><a name="l05580"></a><span class="lineno"> 5580</span>&#160;        buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_chunksize[curix].mlcs_numlines = linecnt;</div><div class="line"><a name="l05581"></a><span class="lineno"> 5581</span>&#160;        buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_chunksize[curix + 1].mlcs_numlines -= linecnt;</div><div class="line"><a name="l05582"></a><span class="lineno"> 5582</span>&#160;        buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_chunksize[curix].mlcs_totalsize = <a class="code" href="gui__mac_8c.html#af0e67ea85e8470c85b7e79fd86b606cd">size</a>;</div><div class="line"><a name="l05583"></a><span class="lineno"> 5583</span>&#160;        buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_chunksize[curix + 1].mlcs_totalsize -= <a class="code" href="gui__mac_8c.html#af0e67ea85e8470c85b7e79fd86b606cd">size</a>;</div><div class="line"><a name="l05584"></a><span class="lineno"> 5584</span>&#160;        buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_usedchunks++;</div><div class="line"><a name="l05585"></a><span class="lineno"> 5585</span>&#160;        ml_upd_lastbuf = NULL;   <span class="comment">/* Force recalc of curix &amp; curline */</span></div><div class="line"><a name="l05586"></a><span class="lineno"> 5586</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l05587"></a><span class="lineno"> 5587</span>&#160;    }</div><div class="line"><a name="l05588"></a><span class="lineno"> 5588</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_chunksize[curix].mlcs_numlines &gt;= <a class="code" href="memline_8c.html#ab87e6b87865bb131c623e02c394ab683">MLCS_MINL</a></div><div class="line"><a name="l05589"></a><span class="lineno"> 5589</span>&#160;             &amp;&amp; curix == buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_usedchunks - 1</div><div class="line"><a name="l05590"></a><span class="lineno"> 5590</span>&#160;             &amp;&amp; buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a708091d31fa9cf7718aca80d707b1b3d">ml_line_count</a> - line &lt;= 1)</div><div class="line"><a name="l05591"></a><span class="lineno"> 5591</span>&#160;    {</div><div class="line"><a name="l05592"></a><span class="lineno"> 5592</span>&#160;        <span class="comment">/*</span></div><div class="line"><a name="l05593"></a><span class="lineno"> 5593</span>&#160;<span class="comment">         * We are in the last chunk and it is cheap to crate a new one</span></div><div class="line"><a name="l05594"></a><span class="lineno"> 5594</span>&#160;<span class="comment">         * after this. Do it now to avoid the loop above later on</span></div><div class="line"><a name="l05595"></a><span class="lineno"> 5595</span>&#160;<span class="comment">         */</span></div><div class="line"><a name="l05596"></a><span class="lineno"> 5596</span>&#160;        curchnk = buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_chunksize + curix + 1;</div><div class="line"><a name="l05597"></a><span class="lineno"> 5597</span>&#160;        buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_usedchunks++;</div><div class="line"><a name="l05598"></a><span class="lineno"> 5598</span>&#160;        <span class="keywordflow">if</span> (line == buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a708091d31fa9cf7718aca80d707b1b3d">ml_line_count</a>)</div><div class="line"><a name="l05599"></a><span class="lineno"> 5599</span>&#160;        {</div><div class="line"><a name="l05600"></a><span class="lineno"> 5600</span>&#160;        curchnk-&gt;mlcs_numlines = 0;</div><div class="line"><a name="l05601"></a><span class="lineno"> 5601</span>&#160;        curchnk-&gt;mlcs_totalsize = 0;</div><div class="line"><a name="l05602"></a><span class="lineno"> 5602</span>&#160;        }</div><div class="line"><a name="l05603"></a><span class="lineno"> 5603</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l05604"></a><span class="lineno"> 5604</span>&#160;        {</div><div class="line"><a name="l05605"></a><span class="lineno"> 5605</span>&#160;        <span class="comment">/*</span></div><div class="line"><a name="l05606"></a><span class="lineno"> 5606</span>&#160;<span class="comment">         * Line is just prior to last, move count for last</span></div><div class="line"><a name="l05607"></a><span class="lineno"> 5607</span>&#160;<span class="comment">         * This is the common case  when loading a new file</span></div><div class="line"><a name="l05608"></a><span class="lineno"> 5608</span>&#160;<span class="comment">         */</span></div><div class="line"><a name="l05609"></a><span class="lineno"> 5609</span>&#160;        hp = <a class="code" href="memline_8c.html#ade8fe98188345bdd3c230545fc4a614f">ml_find_line</a>(buf, buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a708091d31fa9cf7718aca80d707b1b3d">ml_line_count</a>, <a class="code" href="memline_8c.html#a1de07181f87bda4348b87eb71e0ab526">ML_FIND</a>);</div><div class="line"><a name="l05610"></a><span class="lineno"> 5610</span>&#160;        <span class="keywordflow">if</span> (hp == NULL)</div><div class="line"><a name="l05611"></a><span class="lineno"> 5611</span>&#160;        {</div><div class="line"><a name="l05612"></a><span class="lineno"> 5612</span>&#160;            buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_usedchunks = -1;</div><div class="line"><a name="l05613"></a><span class="lineno"> 5613</span>&#160;            <span class="keywordflow">return</span>;</div><div class="line"><a name="l05614"></a><span class="lineno"> 5614</span>&#160;        }</div><div class="line"><a name="l05615"></a><span class="lineno"> 5615</span>&#160;        dp = (<a class="code" href="structdata__block.html">DATA_BL</a> *)(hp-&gt;<a class="code" href="structblock__hdr.html#a7247cdc0977ab6fdc9cb6238cda67587">bh_data</a>);</div><div class="line"><a name="l05616"></a><span class="lineno"> 5616</span>&#160;        <span class="keywordflow">if</span> (dp-&gt;<a class="code" href="structdata__block.html#a00084a39a3bdd9a03b9a055216aec5c5">db_line_count</a> == 1)</div><div class="line"><a name="l05617"></a><span class="lineno"> 5617</span>&#160;            rest = dp-&gt;<a class="code" href="structdata__block.html#ae079e3993bfc47bd86fd6e2fc3ab44ba">db_txt_end</a> - dp-&gt;<a class="code" href="structdata__block.html#a3937f5841b2fed9a042872981b06a7b8">db_txt_start</a>;</div><div class="line"><a name="l05618"></a><span class="lineno"> 5618</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l05619"></a><span class="lineno"> 5619</span>&#160;            rest =</div><div class="line"><a name="l05620"></a><span class="lineno"> 5620</span>&#160;            ((dp-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[dp-&gt;<a class="code" href="structdata__block.html#a00084a39a3bdd9a03b9a055216aec5c5">db_line_count</a> - 2]) &amp; <a class="code" href="memline_8c.html#ab65775db0f7dbf161fce05ee7fb36573">DB_INDEX_MASK</a>)</div><div class="line"><a name="l05621"></a><span class="lineno"> 5621</span>&#160;            - dp-&gt;<a class="code" href="structdata__block.html#a3937f5841b2fed9a042872981b06a7b8">db_txt_start</a>;</div><div class="line"><a name="l05622"></a><span class="lineno"> 5622</span>&#160;        curchnk-&gt;mlcs_totalsize = rest;</div><div class="line"><a name="l05623"></a><span class="lineno"> 5623</span>&#160;        curchnk-&gt;mlcs_numlines = 1;</div><div class="line"><a name="l05624"></a><span class="lineno"> 5624</span>&#160;        curchnk[-1].mlcs_totalsize -= rest;</div><div class="line"><a name="l05625"></a><span class="lineno"> 5625</span>&#160;        curchnk[-1].mlcs_numlines -= 1;</div><div class="line"><a name="l05626"></a><span class="lineno"> 5626</span>&#160;        }</div><div class="line"><a name="l05627"></a><span class="lineno"> 5627</span>&#160;    }</div><div class="line"><a name="l05628"></a><span class="lineno"> 5628</span>&#160;    }</div><div class="line"><a name="l05629"></a><span class="lineno"> 5629</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (updtype == ML_CHNK_DELLINE)</div><div class="line"><a name="l05630"></a><span class="lineno"> 5630</span>&#160;    {</div><div class="line"><a name="l05631"></a><span class="lineno"> 5631</span>&#160;    curchnk-&gt;mlcs_numlines--;</div><div class="line"><a name="l05632"></a><span class="lineno"> 5632</span>&#160;    ml_upd_lastbuf = NULL;   <span class="comment">/* Force recalc of curix &amp; curline */</span></div><div class="line"><a name="l05633"></a><span class="lineno"> 5633</span>&#160;    <span class="keywordflow">if</span> (curix &lt; (buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_usedchunks - 1)</div><div class="line"><a name="l05634"></a><span class="lineno"> 5634</span>&#160;        &amp;&amp; (curchnk-&gt;mlcs_numlines + curchnk[1].mlcs_numlines)</div><div class="line"><a name="l05635"></a><span class="lineno"> 5635</span>&#160;           &lt;= <a class="code" href="memline_8c.html#ab87e6b87865bb131c623e02c394ab683">MLCS_MINL</a>)</div><div class="line"><a name="l05636"></a><span class="lineno"> 5636</span>&#160;    {</div><div class="line"><a name="l05637"></a><span class="lineno"> 5637</span>&#160;        curix++;</div><div class="line"><a name="l05638"></a><span class="lineno"> 5638</span>&#160;        curchnk = buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_chunksize + curix;</div><div class="line"><a name="l05639"></a><span class="lineno"> 5639</span>&#160;    }</div><div class="line"><a name="l05640"></a><span class="lineno"> 5640</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (curix == 0 &amp;&amp; curchnk-&gt;mlcs_numlines &lt;= 0)</div><div class="line"><a name="l05641"></a><span class="lineno"> 5641</span>&#160;    {</div><div class="line"><a name="l05642"></a><span class="lineno"> 5642</span>&#160;        buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_usedchunks--;</div><div class="line"><a name="l05643"></a><span class="lineno"> 5643</span>&#160;        <a class="code" href="os__unix_8h.html#ae70108db942e4f3eeb701ad8787b1835">mch_memmove</a>(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_chunksize, buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_chunksize + 1,</div><div class="line"><a name="l05644"></a><span class="lineno"> 5644</span>&#160;            buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_usedchunks * <span class="keyword">sizeof</span>(chunksize_T));</div><div class="line"><a name="l05645"></a><span class="lineno"> 5645</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l05646"></a><span class="lineno"> 5646</span>&#160;    }</div><div class="line"><a name="l05647"></a><span class="lineno"> 5647</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (curix == 0 || (curchnk-&gt;mlcs_numlines &gt; 10</div><div class="line"><a name="l05648"></a><span class="lineno"> 5648</span>&#160;            &amp;&amp; (curchnk-&gt;mlcs_numlines + curchnk[-1].mlcs_numlines)</div><div class="line"><a name="l05649"></a><span class="lineno"> 5649</span>&#160;               &gt; <a class="code" href="memline_8c.html#ab87e6b87865bb131c623e02c394ab683">MLCS_MINL</a>))</div><div class="line"><a name="l05650"></a><span class="lineno"> 5650</span>&#160;    {</div><div class="line"><a name="l05651"></a><span class="lineno"> 5651</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l05652"></a><span class="lineno"> 5652</span>&#160;    }</div><div class="line"><a name="l05653"></a><span class="lineno"> 5653</span>&#160;</div><div class="line"><a name="l05654"></a><span class="lineno"> 5654</span>&#160;    <span class="comment">/* Collapse chunks */</span></div><div class="line"><a name="l05655"></a><span class="lineno"> 5655</span>&#160;    curchnk[-1].mlcs_numlines += curchnk-&gt;mlcs_numlines;</div><div class="line"><a name="l05656"></a><span class="lineno"> 5656</span>&#160;    curchnk[-1].mlcs_totalsize += curchnk-&gt;mlcs_totalsize;</div><div class="line"><a name="l05657"></a><span class="lineno"> 5657</span>&#160;    buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_usedchunks--;</div><div class="line"><a name="l05658"></a><span class="lineno"> 5658</span>&#160;    <span class="keywordflow">if</span> (curix &lt; buf-&gt;b_ml.ml_usedchunks)</div><div class="line"><a name="l05659"></a><span class="lineno"> 5659</span>&#160;    {</div><div class="line"><a name="l05660"></a><span class="lineno"> 5660</span>&#160;        <a class="code" href="os__unix_8h.html#ae70108db942e4f3eeb701ad8787b1835">mch_memmove</a>(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_chunksize + curix,</div><div class="line"><a name="l05661"></a><span class="lineno"> 5661</span>&#160;            buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_chunksize + curix + 1,</div><div class="line"><a name="l05662"></a><span class="lineno"> 5662</span>&#160;            (buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_usedchunks - curix) *</div><div class="line"><a name="l05663"></a><span class="lineno"> 5663</span>&#160;            <span class="keyword">sizeof</span>(chunksize_T));</div><div class="line"><a name="l05664"></a><span class="lineno"> 5664</span>&#160;    }</div><div class="line"><a name="l05665"></a><span class="lineno"> 5665</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l05666"></a><span class="lineno"> 5666</span>&#160;    }</div><div class="line"><a name="l05667"></a><span class="lineno"> 5667</span>&#160;    ml_upd_lastbuf = buf;</div><div class="line"><a name="l05668"></a><span class="lineno"> 5668</span>&#160;    ml_upd_lastline = line;</div><div class="line"><a name="l05669"></a><span class="lineno"> 5669</span>&#160;    ml_upd_lastcurline = curline;</div><div class="line"><a name="l05670"></a><span class="lineno"> 5670</span>&#160;    ml_upd_lastcurix = curix;</div><div class="line"><a name="l05671"></a><span class="lineno"> 5671</span>&#160;}</div><div class="line"><a name="l05672"></a><span class="lineno"> 5672</span>&#160;</div><div class="line"><a name="l05673"></a><span class="lineno"> 5673</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l05674"></a><span class="lineno"> 5674</span>&#160;<span class="comment"> * Find offset for line or line with offset.</span></div><div class="line"><a name="l05675"></a><span class="lineno"> 5675</span>&#160;<span class="comment"> * Find line with offset if &quot;lnum&quot; is 0; return remaining offset in offp</span></div><div class="line"><a name="l05676"></a><span class="lineno"> 5676</span>&#160;<span class="comment"> * Find offset of line if &quot;lnum&quot; &gt; 0</span></div><div class="line"><a name="l05677"></a><span class="lineno"> 5677</span>&#160;<span class="comment"> * return -1 if information is not available</span></div><div class="line"><a name="l05678"></a><span class="lineno"> 5678</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l05679"></a><span class="lineno"> 5679</span>&#160;    <span class="keywordtype">long</span></div><div class="line"><a name="l05680"></a><span class="lineno"><a class="line" href="memline_8c.html#ac41dda1cc86f79d5c0a94bb91a5b8a88"> 5680</a></span>&#160;<a class="code" href="memline_8c.html#ac41dda1cc86f79d5c0a94bb91a5b8a88">ml_find_line_or_offset</a>(<a class="code" href="structfile__buffer.html">buf_T</a> *buf, <a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a> lnum, <span class="keywordtype">long</span> *offp)</div><div class="line"><a name="l05681"></a><span class="lineno"> 5681</span>&#160;{</div><div class="line"><a name="l05682"></a><span class="lineno"> 5682</span>&#160;    <a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>    curline;</div><div class="line"><a name="l05683"></a><span class="lineno"> 5683</span>&#160;    <span class="keywordtype">int</span>     curix;</div><div class="line"><a name="l05684"></a><span class="lineno"> 5684</span>&#160;    <span class="keywordtype">long</span>    <a class="code" href="gui__mac_8c.html#af0e67ea85e8470c85b7e79fd86b606cd">size</a>;</div><div class="line"><a name="l05685"></a><span class="lineno"> 5685</span>&#160;    <a class="code" href="structblock__hdr.html">bhdr_T</a>  *hp;</div><div class="line"><a name="l05686"></a><span class="lineno"> 5686</span>&#160;    <a class="code" href="structdata__block.html">DATA_BL</a> *dp;</div><div class="line"><a name="l05687"></a><span class="lineno"> 5687</span>&#160;    <span class="keywordtype">int</span>     count;      <span class="comment">/* number of entries in block */</span></div><div class="line"><a name="l05688"></a><span class="lineno"> 5688</span>&#160;    <span class="keywordtype">int</span>     idx;</div><div class="line"><a name="l05689"></a><span class="lineno"> 5689</span>&#160;    <span class="keywordtype">int</span>     start_idx;</div><div class="line"><a name="l05690"></a><span class="lineno"> 5690</span>&#160;    <span class="keywordtype">int</span>     text_end;</div><div class="line"><a name="l05691"></a><span class="lineno"> 5691</span>&#160;    <span class="keywordtype">long</span>    offset;</div><div class="line"><a name="l05692"></a><span class="lineno"> 5692</span>&#160;    <span class="keywordtype">int</span>     len;</div><div class="line"><a name="l05693"></a><span class="lineno"> 5693</span>&#160;    <span class="keywordtype">int</span>     ffdos = (<a class="code" href="misc2_8c.html#a767812b118182564891e6c771b3a0da0">get_fileformat</a>(buf) == <a class="code" href="option_8h.html#aecddef423586bfbf192adca96adec2e6">EOL_DOS</a>);</div><div class="line"><a name="l05694"></a><span class="lineno"> 5694</span>&#160;    <span class="keywordtype">int</span>     extra = 0;</div><div class="line"><a name="l05695"></a><span class="lineno"> 5695</span>&#160;</div><div class="line"><a name="l05696"></a><span class="lineno"> 5696</span>&#160;    <span class="comment">/* take care of cached line first */</span></div><div class="line"><a name="l05697"></a><span class="lineno"> 5697</span>&#160;    <a class="code" href="memline_8c.html#a20a3268681f79a76b9af2f2fc7b644b6">ml_flush_line</a>(curbuf);</div><div class="line"><a name="l05698"></a><span class="lineno"> 5698</span>&#160;</div><div class="line"><a name="l05699"></a><span class="lineno"> 5699</span>&#160;    <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_usedchunks == -1</div><div class="line"><a name="l05700"></a><span class="lineno"> 5700</span>&#160;        || buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_chunksize == NULL</div><div class="line"><a name="l05701"></a><span class="lineno"> 5701</span>&#160;        || lnum &lt; 0)</div><div class="line"><a name="l05702"></a><span class="lineno"> 5702</span>&#160;    <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l05703"></a><span class="lineno"> 5703</span>&#160;</div><div class="line"><a name="l05704"></a><span class="lineno"> 5704</span>&#160;    <span class="keywordflow">if</span> (offp == NULL)</div><div class="line"><a name="l05705"></a><span class="lineno"> 5705</span>&#160;    offset = 0;</div><div class="line"><a name="l05706"></a><span class="lineno"> 5706</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l05707"></a><span class="lineno"> 5707</span>&#160;    offset = *offp;</div><div class="line"><a name="l05708"></a><span class="lineno"> 5708</span>&#160;    <span class="keywordflow">if</span> (lnum == 0 &amp;&amp; offset &lt;= 0)</div><div class="line"><a name="l05709"></a><span class="lineno"> 5709</span>&#160;    <span class="keywordflow">return</span> 1;   <span class="comment">/* Not a &quot;find offset&quot; and offset 0 _must_ be in line 1 */</span></div><div class="line"><a name="l05710"></a><span class="lineno"> 5710</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l05711"></a><span class="lineno"> 5711</span>&#160;<span class="comment">     * Find the last chunk before the one containing our line. Last chunk is</span></div><div class="line"><a name="l05712"></a><span class="lineno"> 5712</span>&#160;<span class="comment">     * special because it will never qualify</span></div><div class="line"><a name="l05713"></a><span class="lineno"> 5713</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l05714"></a><span class="lineno"> 5714</span>&#160;    curline = 1;</div><div class="line"><a name="l05715"></a><span class="lineno"> 5715</span>&#160;    curix = size = 0;</div><div class="line"><a name="l05716"></a><span class="lineno"> 5716</span>&#160;    <span class="keywordflow">while</span> (curix &lt; buf-&gt;b_ml.ml_usedchunks - 1</div><div class="line"><a name="l05717"></a><span class="lineno"> 5717</span>&#160;        &amp;&amp; ((lnum != 0</div><div class="line"><a name="l05718"></a><span class="lineno"> 5718</span>&#160;         &amp;&amp; lnum &gt;= curline + buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_chunksize[curix].mlcs_numlines)</div><div class="line"><a name="l05719"></a><span class="lineno"> 5719</span>&#160;        || (offset != 0</div><div class="line"><a name="l05720"></a><span class="lineno"> 5720</span>&#160;           &amp;&amp; offset &gt; size + buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_chunksize[curix].mlcs_totalsize</div><div class="line"><a name="l05721"></a><span class="lineno"> 5721</span>&#160;              + ffdos * buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_chunksize[curix].mlcs_numlines)))</div><div class="line"><a name="l05722"></a><span class="lineno"> 5722</span>&#160;    {</div><div class="line"><a name="l05723"></a><span class="lineno"> 5723</span>&#160;    curline += buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_chunksize[curix].mlcs_numlines;</div><div class="line"><a name="l05724"></a><span class="lineno"> 5724</span>&#160;    size += buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_chunksize[curix].mlcs_totalsize;</div><div class="line"><a name="l05725"></a><span class="lineno"> 5725</span>&#160;    <span class="keywordflow">if</span> (offset &amp;&amp; ffdos)</div><div class="line"><a name="l05726"></a><span class="lineno"> 5726</span>&#160;        size += buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.ml_chunksize[curix].mlcs_numlines;</div><div class="line"><a name="l05727"></a><span class="lineno"> 5727</span>&#160;    curix++;</div><div class="line"><a name="l05728"></a><span class="lineno"> 5728</span>&#160;    }</div><div class="line"><a name="l05729"></a><span class="lineno"> 5729</span>&#160;</div><div class="line"><a name="l05730"></a><span class="lineno"> 5730</span>&#160;    <span class="keywordflow">while</span> ((lnum != 0 &amp;&amp; curline &lt; lnum) || (offset != 0 &amp;&amp; size &lt; offset))</div><div class="line"><a name="l05731"></a><span class="lineno"> 5731</span>&#160;    {</div><div class="line"><a name="l05732"></a><span class="lineno"> 5732</span>&#160;    <span class="keywordflow">if</span> (curline &gt; buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a708091d31fa9cf7718aca80d707b1b3d">ml_line_count</a></div><div class="line"><a name="l05733"></a><span class="lineno"> 5733</span>&#160;        || (hp = <a class="code" href="memline_8c.html#ade8fe98188345bdd3c230545fc4a614f">ml_find_line</a>(buf, curline, <a class="code" href="memline_8c.html#a1de07181f87bda4348b87eb71e0ab526">ML_FIND</a>)) == NULL)</div><div class="line"><a name="l05734"></a><span class="lineno"> 5734</span>&#160;        <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l05735"></a><span class="lineno"> 5735</span>&#160;    dp = (<a class="code" href="structdata__block.html">DATA_BL</a> *)(hp-&gt;<a class="code" href="structblock__hdr.html#a7247cdc0977ab6fdc9cb6238cda67587">bh_data</a>);</div><div class="line"><a name="l05736"></a><span class="lineno"> 5736</span>&#160;    count = (long)(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a81788089e53748eb945a88d6e41647da">ml_locked_high</a>) -</div><div class="line"><a name="l05737"></a><span class="lineno"> 5737</span>&#160;        (long)(buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a2b7c6e30401df9d0e8972cb639d1b895">ml_locked_low</a>) + 1;</div><div class="line"><a name="l05738"></a><span class="lineno"> 5738</span>&#160;    start_idx = idx = curline - buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a2b7c6e30401df9d0e8972cb639d1b895">ml_locked_low</a>;</div><div class="line"><a name="l05739"></a><span class="lineno"> 5739</span>&#160;    <span class="keywordflow">if</span> (idx == 0)<span class="comment">/* first line in block, text at the end */</span></div><div class="line"><a name="l05740"></a><span class="lineno"> 5740</span>&#160;        text_end = dp-&gt;<a class="code" href="structdata__block.html#ae079e3993bfc47bd86fd6e2fc3ab44ba">db_txt_end</a>;</div><div class="line"><a name="l05741"></a><span class="lineno"> 5741</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l05742"></a><span class="lineno"> 5742</span>&#160;        text_end = ((dp-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[idx - 1]) &amp; <a class="code" href="memline_8c.html#ab65775db0f7dbf161fce05ee7fb36573">DB_INDEX_MASK</a>);</div><div class="line"><a name="l05743"></a><span class="lineno"> 5743</span>&#160;    <span class="comment">/* Compute index of last line to use in this MEMLINE */</span></div><div class="line"><a name="l05744"></a><span class="lineno"> 5744</span>&#160;    <span class="keywordflow">if</span> (lnum != 0)</div><div class="line"><a name="l05745"></a><span class="lineno"> 5745</span>&#160;    {</div><div class="line"><a name="l05746"></a><span class="lineno"> 5746</span>&#160;        <span class="keywordflow">if</span> (curline + (count - idx) &gt;= lnum)</div><div class="line"><a name="l05747"></a><span class="lineno"> 5747</span>&#160;        idx += lnum - curline - 1;</div><div class="line"><a name="l05748"></a><span class="lineno"> 5748</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l05749"></a><span class="lineno"> 5749</span>&#160;        idx = count - 1;</div><div class="line"><a name="l05750"></a><span class="lineno"> 5750</span>&#160;    }</div><div class="line"><a name="l05751"></a><span class="lineno"> 5751</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l05752"></a><span class="lineno"> 5752</span>&#160;    {</div><div class="line"><a name="l05753"></a><span class="lineno"> 5753</span>&#160;        extra = 0;</div><div class="line"><a name="l05754"></a><span class="lineno"> 5754</span>&#160;        <span class="keywordflow">while</span> (offset &gt;= size</div><div class="line"><a name="l05755"></a><span class="lineno"> 5755</span>&#160;               + text_end - (<span class="keywordtype">int</span>)((dp-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[idx]) &amp; <a class="code" href="memline_8c.html#ab65775db0f7dbf161fce05ee7fb36573">DB_INDEX_MASK</a>)</div><div class="line"><a name="l05756"></a><span class="lineno"> 5756</span>&#160;                                      + ffdos)</div><div class="line"><a name="l05757"></a><span class="lineno"> 5757</span>&#160;        {</div><div class="line"><a name="l05758"></a><span class="lineno"> 5758</span>&#160;        <span class="keywordflow">if</span> (ffdos)</div><div class="line"><a name="l05759"></a><span class="lineno"> 5759</span>&#160;            size++;</div><div class="line"><a name="l05760"></a><span class="lineno"> 5760</span>&#160;        <span class="keywordflow">if</span> (idx == count - 1)</div><div class="line"><a name="l05761"></a><span class="lineno"> 5761</span>&#160;        {</div><div class="line"><a name="l05762"></a><span class="lineno"> 5762</span>&#160;            extra = 1;</div><div class="line"><a name="l05763"></a><span class="lineno"> 5763</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l05764"></a><span class="lineno"> 5764</span>&#160;        }</div><div class="line"><a name="l05765"></a><span class="lineno"> 5765</span>&#160;        idx++;</div><div class="line"><a name="l05766"></a><span class="lineno"> 5766</span>&#160;        }</div><div class="line"><a name="l05767"></a><span class="lineno"> 5767</span>&#160;    }</div><div class="line"><a name="l05768"></a><span class="lineno"> 5768</span>&#160;<span class="preprocessor">#ifdef FEAT_TEXT_PROP</span></div><div class="line"><a name="l05769"></a><span class="lineno"> 5769</span>&#160;    <span class="keywordflow">if</span> (buf-&gt;b_has_textprop)</div><div class="line"><a name="l05770"></a><span class="lineno"> 5770</span>&#160;    {</div><div class="line"><a name="l05771"></a><span class="lineno"> 5771</span>&#160;        <span class="keywordtype">int</span> i;</div><div class="line"><a name="l05772"></a><span class="lineno"> 5772</span>&#160;</div><div class="line"><a name="l05773"></a><span class="lineno"> 5773</span>&#160;        <span class="comment">// cannot use the db_index pointer, need to get the actual text</span></div><div class="line"><a name="l05774"></a><span class="lineno"> 5774</span>&#160;        <span class="comment">// lengths.</span></div><div class="line"><a name="l05775"></a><span class="lineno"> 5775</span>&#160;        len = 0;</div><div class="line"><a name="l05776"></a><span class="lineno"> 5776</span>&#160;        <span class="keywordflow">for</span> (i = start_idx; i &lt;= idx; ++i)</div><div class="line"><a name="l05777"></a><span class="lineno"> 5777</span>&#160;        len += (<span class="keywordtype">int</span>)<a class="code" href="vim_8h.html#a916ffefe1fc74532d08102cca55d8e34">STRLEN</a>((char_u *)dp + ((dp-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[i]) &amp; <a class="code" href="memline_8c.html#ab65775db0f7dbf161fce05ee7fb36573">DB_INDEX_MASK</a>)) + 1;</div><div class="line"><a name="l05778"></a><span class="lineno"> 5778</span>&#160;    }</div><div class="line"><a name="l05779"></a><span class="lineno"> 5779</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l05780"></a><span class="lineno"> 5780</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l05781"></a><span class="lineno"> 5781</span>&#160;        len = text_end - ((dp-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[idx]) &amp; <a class="code" href="memline_8c.html#ab65775db0f7dbf161fce05ee7fb36573">DB_INDEX_MASK</a>);</div><div class="line"><a name="l05782"></a><span class="lineno"> 5782</span>&#160;    size += len;</div><div class="line"><a name="l05783"></a><span class="lineno"> 5783</span>&#160;    <span class="keywordflow">if</span> (offset != 0 &amp;&amp; size &gt;= offset)</div><div class="line"><a name="l05784"></a><span class="lineno"> 5784</span>&#160;    {</div><div class="line"><a name="l05785"></a><span class="lineno"> 5785</span>&#160;        <span class="keywordflow">if</span> (size + ffdos == offset)</div><div class="line"><a name="l05786"></a><span class="lineno"> 5786</span>&#160;        *offp = 0;</div><div class="line"><a name="l05787"></a><span class="lineno"> 5787</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (idx == start_idx)</div><div class="line"><a name="l05788"></a><span class="lineno"> 5788</span>&#160;        *offp = offset - size + len;</div><div class="line"><a name="l05789"></a><span class="lineno"> 5789</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l05790"></a><span class="lineno"> 5790</span>&#160;        *offp = offset - size + len</div><div class="line"><a name="l05791"></a><span class="lineno"> 5791</span>&#160;             - (text_end - ((dp-&gt;<a class="code" href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">db_index</a>[idx - 1]) &amp; <a class="code" href="memline_8c.html#ab65775db0f7dbf161fce05ee7fb36573">DB_INDEX_MASK</a>));</div><div class="line"><a name="l05792"></a><span class="lineno"> 5792</span>&#160;        curline += idx - start_idx + extra;</div><div class="line"><a name="l05793"></a><span class="lineno"> 5793</span>&#160;        <span class="keywordflow">if</span> (curline &gt; buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a708091d31fa9cf7718aca80d707b1b3d">ml_line_count</a>)</div><div class="line"><a name="l05794"></a><span class="lineno"> 5794</span>&#160;        <span class="keywordflow">return</span> -1;  <span class="comment">/* exactly one byte beyond the end */</span></div><div class="line"><a name="l05795"></a><span class="lineno"> 5795</span>&#160;        <span class="keywordflow">return</span> curline;</div><div class="line"><a name="l05796"></a><span class="lineno"> 5796</span>&#160;    }</div><div class="line"><a name="l05797"></a><span class="lineno"> 5797</span>&#160;    curline = buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a81788089e53748eb945a88d6e41647da">ml_locked_high</a> + 1;</div><div class="line"><a name="l05798"></a><span class="lineno"> 5798</span>&#160;    }</div><div class="line"><a name="l05799"></a><span class="lineno"> 5799</span>&#160;</div><div class="line"><a name="l05800"></a><span class="lineno"> 5800</span>&#160;    <span class="keywordflow">if</span> (lnum != 0)</div><div class="line"><a name="l05801"></a><span class="lineno"> 5801</span>&#160;    {</div><div class="line"><a name="l05802"></a><span class="lineno"> 5802</span>&#160;    <span class="comment">/* Count extra CR characters. */</span></div><div class="line"><a name="l05803"></a><span class="lineno"> 5803</span>&#160;    <span class="keywordflow">if</span> (ffdos)</div><div class="line"><a name="l05804"></a><span class="lineno"> 5804</span>&#160;        size += lnum - 1;</div><div class="line"><a name="l05805"></a><span class="lineno"> 5805</span>&#160;</div><div class="line"><a name="l05806"></a><span class="lineno"> 5806</span>&#160;    <span class="comment">/* Don&#39;t count the last line break if &#39;noeol&#39; and (&#39;bin&#39; or</span></div><div class="line"><a name="l05807"></a><span class="lineno"> 5807</span>&#160;<span class="comment">     * &#39;nofixeol&#39;). */</span></div><div class="line"><a name="l05808"></a><span class="lineno"> 5808</span>&#160;    <span class="keywordflow">if</span> ((!buf-&gt;<a class="code" href="structfile__buffer.html#a5ceacad82bc1498a6f10f027449fe9a0">b_p_fixeol</a> || buf-&gt;<a class="code" href="structfile__buffer.html#abb16d33dacca0e4480aadc94210001b2">b_p_bin</a>) &amp;&amp; !buf-&gt;<a class="code" href="structfile__buffer.html#a454ea380346ba5441df8c2631a55741b">b_p_eol</a></div><div class="line"><a name="l05809"></a><span class="lineno"> 5809</span>&#160;                       &amp;&amp; lnum &gt; buf-&gt;<a class="code" href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">b_ml</a>.<a class="code" href="structmemline.html#a708091d31fa9cf7718aca80d707b1b3d">ml_line_count</a>)</div><div class="line"><a name="l05810"></a><span class="lineno"> 5810</span>&#160;        size -= ffdos + 1;</div><div class="line"><a name="l05811"></a><span class="lineno"> 5811</span>&#160;    }</div><div class="line"><a name="l05812"></a><span class="lineno"> 5812</span>&#160;</div><div class="line"><a name="l05813"></a><span class="lineno"> 5813</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="gui__mac_8c.html#af0e67ea85e8470c85b7e79fd86b606cd">size</a>;</div><div class="line"><a name="l05814"></a><span class="lineno"> 5814</span>&#160;}</div><div class="line"><a name="l05815"></a><span class="lineno"> 5815</span>&#160;</div><div class="line"><a name="l05816"></a><span class="lineno"> 5816</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l05817"></a><span class="lineno"> 5817</span>&#160;<span class="comment"> * Goto byte in buffer with offset &#39;cnt&#39;.</span></div><div class="line"><a name="l05818"></a><span class="lineno"> 5818</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l05819"></a><span class="lineno"> 5819</span>&#160;    <span class="keywordtype">void</span></div><div class="line"><a name="l05820"></a><span class="lineno"><a class="line" href="memline_8c.html#ad55f706f79a7fbd002ea07458e1c1189"> 5820</a></span>&#160;<a class="code" href="memline_8c.html#ad55f706f79a7fbd002ea07458e1c1189">goto_byte</a>(<span class="keywordtype">long</span> cnt)</div><div class="line"><a name="l05821"></a><span class="lineno"> 5821</span>&#160;{</div><div class="line"><a name="l05822"></a><span class="lineno"> 5822</span>&#160;    <span class="keywordtype">long</span>    boff = cnt;</div><div class="line"><a name="l05823"></a><span class="lineno"> 5823</span>&#160;    <a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>    lnum;</div><div class="line"><a name="l05824"></a><span class="lineno"> 5824</span>&#160;</div><div class="line"><a name="l05825"></a><span class="lineno"> 5825</span>&#160;    <a class="code" href="memline_8c.html#a20a3268681f79a76b9af2f2fc7b644b6">ml_flush_line</a>(curbuf);  <span class="comment">/* cached line may be dirty */</span></div><div class="line"><a name="l05826"></a><span class="lineno"> 5826</span>&#160;    <a class="code" href="mark_8c.html#a70431d6be4f5bdfe83649a25858ea891">setpcmark</a>();</div><div class="line"><a name="l05827"></a><span class="lineno"> 5827</span>&#160;    <span class="keywordflow">if</span> (boff)</div><div class="line"><a name="l05828"></a><span class="lineno"> 5828</span>&#160;    --boff;</div><div class="line"><a name="l05829"></a><span class="lineno"> 5829</span>&#160;    lnum = <a class="code" href="memline_8c.html#ac41dda1cc86f79d5c0a94bb91a5b8a88">ml_find_line_or_offset</a>(curbuf, (<a class="code" href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a>)0, &amp;boff);</div><div class="line"><a name="l05830"></a><span class="lineno"> 5830</span>&#160;    <span class="keywordflow">if</span> (lnum &lt; 1)   <span class="comment">/* past the end */</span></div><div class="line"><a name="l05831"></a><span class="lineno"> 5831</span>&#160;    {</div><div class="line"><a name="l05832"></a><span class="lineno"> 5832</span>&#160;    <a class="code" href="globals_8h.html#a1440aee39ae90077fff5aeb23c8a3764">curwin</a>-&gt;<a class="code" href="structwindow___s.html#a397eb20adbcf2f8a50e1038886c1930c">w_cursor</a>.<a class="code" href="structpos___t.html#abff612ea21a47084625b593756153b3e">lnum</a> = curbuf-&gt;b_ml.ml_line_count;</div><div class="line"><a name="l05833"></a><span class="lineno"> 5833</span>&#160;    <a class="code" href="globals_8h.html#a1440aee39ae90077fff5aeb23c8a3764">curwin</a>-&gt;<a class="code" href="structwindow___s.html#a835020a5ed8c78ed5c652cdb8052e785">w_curswant</a> = <a class="code" href="vim_8h.html#aef214bee44b8ea3707359a56c8c921c6">MAXCOL</a>;</div><div class="line"><a name="l05834"></a><span class="lineno"> 5834</span>&#160;    <a class="code" href="misc2_8c.html#a93b6e3a7993e6c4273dd8ebfea0fdc14">coladvance</a>((<a class="code" href="vim_8h.html#ae79e04a416bd6ce8ffe80e241850c0d2">colnr_T</a>)<a class="code" href="vim_8h.html#aef214bee44b8ea3707359a56c8c921c6">MAXCOL</a>);</div><div class="line"><a name="l05835"></a><span class="lineno"> 5835</span>&#160;    }</div><div class="line"><a name="l05836"></a><span class="lineno"> 5836</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l05837"></a><span class="lineno"> 5837</span>&#160;    {</div><div class="line"><a name="l05838"></a><span class="lineno"> 5838</span>&#160;    <a class="code" href="globals_8h.html#a1440aee39ae90077fff5aeb23c8a3764">curwin</a>-&gt;<a class="code" href="structwindow___s.html#a397eb20adbcf2f8a50e1038886c1930c">w_cursor</a>.<a class="code" href="structpos___t.html#abff612ea21a47084625b593756153b3e">lnum</a> = lnum;</div><div class="line"><a name="l05839"></a><span class="lineno"> 5839</span>&#160;    <a class="code" href="globals_8h.html#a1440aee39ae90077fff5aeb23c8a3764">curwin</a>-&gt;<a class="code" href="structwindow___s.html#a397eb20adbcf2f8a50e1038886c1930c">w_cursor</a>.<a class="code" href="structpos___t.html#a08c5af56d347e155e2cd721d99616ab8">col</a> = (<a class="code" href="vim_8h.html#ae79e04a416bd6ce8ffe80e241850c0d2">colnr_T</a>)boff;</div><div class="line"><a name="l05840"></a><span class="lineno"> 5840</span>&#160;    <a class="code" href="globals_8h.html#a1440aee39ae90077fff5aeb23c8a3764">curwin</a>-&gt;<a class="code" href="structwindow___s.html#a397eb20adbcf2f8a50e1038886c1930c">w_cursor</a>.<a class="code" href="structpos___t.html#a2efcfdd664d0eb30552e17408eb6cd84">coladd</a> = 0;</div><div class="line"><a name="l05841"></a><span class="lineno"> 5841</span>&#160;    <a class="code" href="globals_8h.html#a1440aee39ae90077fff5aeb23c8a3764">curwin</a>-&gt;<a class="code" href="structwindow___s.html#a4ed36d0cccb196ff9ba6a7e1995e3055">w_set_curswant</a> = <a class="code" href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"><a name="l05842"></a><span class="lineno"> 5842</span>&#160;    }</div><div class="line"><a name="l05843"></a><span class="lineno"> 5843</span>&#160;    <a class="code" href="misc2_8c.html#a94e32797eb3ef299b193daf4c7974c56">check_cursor</a>();</div><div class="line"><a name="l05844"></a><span class="lineno"> 5844</span>&#160;</div><div class="line"><a name="l05845"></a><span class="lineno"> 5845</span>&#160;    <span class="comment">/* Make sure the cursor is on the first byte of a multi-byte char. */</span></div><div class="line"><a name="l05846"></a><span class="lineno"> 5846</span>&#160;    <span class="keywordflow">if</span> (has_mbyte)</div><div class="line"><a name="l05847"></a><span class="lineno"> 5847</span>&#160;    <a class="code" href="mbyte_8c.html#a074ed548c30666da6fc4868af00d2241">mb_adjust_cursor</a>();</div><div class="line"><a name="l05848"></a><span class="lineno"> 5848</span>&#160;}</div><div class="line"><a name="l05849"></a><span class="lineno"> 5849</span>&#160;<span class="preprocessor">#endif</span></div><div class="ttc" id="structmemline_html_a62222eb79ef59eddaff71f0f8cdff764"><div class="ttname"><a href="structmemline.html#a62222eb79ef59eddaff71f0f8cdff764">memline::ml_line_lnum</a></div><div class="ttdeci">linenr_T ml_line_lnum</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00721">structs.h:721</a></div></div>
<div class="ttc" id="message_8c_html_aeb2442b830699494f53059773212d850"><div class="ttname"><a href="message_8c.html#aeb2442b830699494f53059773212d850">semsg</a></div><div class="ttdeci">int semsg(const char *s,...)</div><div class="ttdef"><b>Definition:</b> <a href="message_8c_source.html#l00724">message.c:724</a></div></div>
<div class="ttc" id="vim_8h_html_a9f1019b10a1c51d588f4500cde3a6746"><div class="ttname"><a href="vim_8h.html#a9f1019b10a1c51d588f4500cde3a6746">O_EXTRA</a></div><div class="ttdeci">#define O_EXTRA</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l01561">vim.h:1561</a></div></div>
<div class="ttc" id="structtextprop___s_html_a37661218d497b414d619683e1063e09b"><div class="ttname"><a href="structtextprop___s.html#a37661218d497b414d619683e1063e09b">textprop_S::tp_flags</a></div><div class="ttdeci">int tp_flags</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00748">structs.h:748</a></div></div>
<div class="ttc" id="structpos___t_html"><div class="ttname"><a href="structpos___t.html">pos_T</a></div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00026">structs.h:26</a></div></div>
<div class="ttc" id="memfile_8c_html_a0a2aa007c9974950d936bcb9d739563a"><div class="ttname"><a href="memfile_8c.html#a0a2aa007c9974950d936bcb9d739563a">mf_sync</a></div><div class="ttdeci">int mf_sync(memfile_T *mfp, int flags)</div><div class="ttdef"><b>Definition:</b> <a href="memfile_8c_source.html#l00538">memfile.c:538</a></div></div>
<div class="ttc" id="structdata__block_html_adabe377b570a28633cdd9b9ce5e77cab"><div class="ttname"><a href="structdata__block.html#adabe377b570a28633cdd9b9ce5e77cab">data_block::db_index</a></div><div class="ttdeci">unsigned db_index[1]</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00113">memline.c:113</a></div></div>
<div class="ttc" id="memline_8c_html_aafe17e152f79b72e5e3e52013d5ba4dd"><div class="ttname"><a href="memline_8c.html#aafe17e152f79b72e5e3e52013d5ba4dd">ml_upd_block0</a></div><div class="ttdeci">static void ml_upd_block0(buf_T *buf, upd_block0_T what)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00924">memline.c:924</a></div></div>
<div class="ttc" id="memline_8c_html_aeb2a08db86a3f3c959cc50de278339edae07039e8880c427cedb331eac7444095"><div class="ttname"><a href="memline_8c.html#aeb2a08db86a3f3c959cc50de278339edae07039e8880c427cedb331eac7444095">UB_FNAME</a></div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00232">memline.c:232</a></div></div>
<div class="ttc" id="structmemline_html_a708091d31fa9cf7718aca80d707b1b3d"><div class="ttname"><a href="structmemline.html#a708091d31fa9cf7718aca80d707b1b3d">memline::ml_line_count</a></div><div class="ttdeci">linenr_T ml_line_count</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00707">structs.h:707</a></div></div>
<div class="ttc" id="dict_8c_html_aa53a3b4e6d3d544d68f44dd1ea1928c0"><div class="ttname"><a href="dict_8c.html#aa53a3b4e6d3d544d68f44dd1ea1928c0">dict_add_string_len</a></div><div class="ttdeci">int dict_add_string_len(dict_T *d, char *key, char_u *str, int len)</div><div class="ttdef"><b>Definition:</b> <a href="dict_8c_source.html#l00402">dict.c:402</a></div></div>
<div class="ttc" id="structfile__buffer_html_a44e966d8856ead5eae8184fc9fabceeb"><div class="ttname"><a href="structfile__buffer.html#a44e966d8856ead5eae8184fc9fabceeb">file_buffer::b_orig_mode</a></div><div class="ttdeci">int b_orig_mode</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l02307">structs.h:2307</a></div></div>
<div class="ttc" id="misc1_8c_html_aa43159dfdc77eb5fdba574297156b0f4"><div class="ttname"><a href="misc1_8c.html#aa43159dfdc77eb5fdba574297156b0f4">get_number</a></div><div class="ttdeci">int get_number(int colon, int *mouse_used)</div><div class="ttdef"><b>Definition:</b> <a href="misc1_8c_source.html#l01448">misc1.c:1448</a></div></div>
<div class="ttc" id="memline_8c_html_ade8fe98188345bdd3c230545fc4a614f"><div class="ttname"><a href="memline_8c.html#ade8fe98188345bdd3c230545fc4a614f">ml_find_line</a></div><div class="ttdeci">static bhdr_T * ml_find_line(buf_T *, linenr_T, int)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l04064">memline.c:4064</a></div></div>
<div class="ttc" id="memline_8c_html_a24846156f9cce98c4ab60f43e224065e"><div class="ttname"><a href="memline_8c.html#a24846156f9cce98c4ab60f43e224065e">B0_MAGIC_CHAR</a></div><div class="ttdeci">#define B0_MAGIC_CHAR</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00146">memline.c:146</a></div></div>
<div class="ttc" id="structinfo__pointer_html_a140d83e56091daa97560a9a4a82a8c1b"><div class="ttname"><a href="structinfo__pointer.html#a140d83e56091daa97560a9a4a82a8c1b">info_pointer::ip_bnum</a></div><div class="ttdeci">blocknr_T ip_bnum</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00681">structs.h:681</a></div></div>
<div class="ttc" id="memline_8c_html_a8a397be254bc1ea753c218ceb79b7812"><div class="ttname"><a href="memline_8c.html#a8a397be254bc1ea753c218ceb79b7812">attention_message</a></div><div class="ttdeci">static void attention_message(buf_T *buf, char_u *fname)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l04529">memline.c:4529</a></div></div>
<div class="ttc" id="usercmd_8c_html_a3fb7e659ba694717955e996add022e94"><div class="ttname"><a href="usercmd_8c.html#a3fb7e659ba694717955e996add022e94">shortname</a></div><div class="ttdeci">char * shortname</div><div class="ttdef"><b>Definition:</b> <a href="usercmd_8c_source.html#l00102">usercmd.c:102</a></div></div>
<div class="ttc" id="macros_8h_html_abedb28fafef6553a68ede9057216bfaa"><div class="ttname"><a href="macros_8h.html#abedb28fafef6553a68ede9057216bfaa">TOLOWER_ASC</a></div><div class="ttdeci">#define TOLOWER_ASC(c)</div><div class="ttdef"><b>Definition:</b> <a href="macros_8h_source.html#l00083">macros.h:83</a></div></div>
<div class="ttc" id="memfile_8c_html_a6e68cf5ad6fb3085488b37df8dc37058"><div class="ttname"><a href="memfile_8c.html#a6e68cf5ad6fb3085488b37df8dc37058">mf_open</a></div><div class="ttdeci">memfile_T * mf_open(char_u *fname, int flags)</div><div class="ttdef"><b>Definition:</b> <a href="memfile_8c_source.html#l00124">memfile.c:124</a></div></div>
<div class="ttc" id="evalvars_8c_html_ad24dc360910df498ab3f75c5957e55b6"><div class="ttname"><a href="evalvars_8c.html#ad24dc360910df498ab3f75c5957e55b6">set_vim_var_string</a></div><div class="ttdeci">void set_vim_var_string(int idx, char_u *val, int len)</div><div class="ttdef"><b>Definition:</b> <a href="evalvars_8c_source.html#l02041">evalvars.c:2041</a></div></div>
<div class="ttc" id="vim_8h_html_a469cffaa64ff8028edfb64ba4cd7deae"><div class="ttname"><a href="vim_8h.html#a469cffaa64ff8028edfb64ba4cd7deae">STRNCPY</a></div><div class="ttdeci">#define STRNCPY(d, s, n)</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l01591">vim.h:1591</a></div></div>
<div class="ttc" id="memline_8c_html_a47709ebb68758a4b1db1a5205761c146"><div class="ttname"><a href="memline_8c.html#a47709ebb68758a4b1db1a5205761c146">B0_SAME_DIR</a></div><div class="ttdeci">#define B0_SAME_DIR</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00205">memline.c:205</a></div></div>
<div class="ttc" id="filepath_8c_html_a3a027a38b217222ac4d9ebe8ce5c1947"><div class="ttname"><a href="filepath_8c.html#a3a027a38b217222ac4d9ebe8ce5c1947">gettail</a></div><div class="ttdeci">char_u * gettail(char_u *fname)</div><div class="ttdef"><b>Definition:</b> <a href="filepath_8c_source.html#l02399">filepath.c:2399</a></div></div>
<div class="ttc" id="memline_8c_html_a3d4acdf95d4c64556e8eda8bd2ab6bac"><div class="ttname"><a href="memline_8c.html#a3d4acdf95d4c64556e8eda8bd2ab6bac">ml_get_pos</a></div><div class="ttdeci">char_u * ml_get_pos(pos_T *pos)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l02576">memline.c:2576</a></div></div>
<div class="ttc" id="memline_8c_html_a109387062ce17fc808cae3971ce703ba"><div class="ttname"><a href="memline_8c.html#a109387062ce17fc808cae3971ce703ba">ml_get</a></div><div class="ttdeci">char_u * ml_get(linenr_T lnum)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l02567">memline.c:2567</a></div></div>
<div class="ttc" id="crypt_8c_html_a2224d31da3a71d7ae8022b582508090c"><div class="ttname"><a href="crypt_8c.html#a2224d31da3a71d7ae8022b582508090c">crypt_get_method_nr</a></div><div class="ttdeci">int crypt_get_method_nr(buf_T *buf)</div><div class="ttdef"><b>Definition:</b> <a href="crypt_8c_source.html#l00193">crypt.c:193</a></div></div>
<div class="ttc" id="vim_8h_html_a72695d31382ba5334881ad3407393642"><div class="ttname"><a href="vim_8h.html#a72695d31382ba5334881ad3407393642">NOT_VALID</a></div><div class="ttdeci">#define NOT_VALID</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l00589">vim.h:589</a></div></div>
<div class="ttc" id="structblock__hdr_html_aa3f0f7b98a68382a3ec20db1e9e65d8b"><div class="ttname"><a href="structblock__hdr.html#aa3f0f7b98a68382a3ec20db1e9e65d8b">block_hdr::bh_page_count</a></div><div class="ttdeci">int bh_page_count</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00499">structs.h:499</a></div></div>
<div class="ttc" id="memline_8c_html_aca48449cf4d92cab475956ba7760efaa"><div class="ttname"><a href="memline_8c.html#aca48449cf4d92cab475956ba7760efaa">BLOCK0_ID1_C0</a></div><div class="ttdeci">#define BLOCK0_ID1_C0</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00064">memline.c:64</a></div></div>
<div class="ttc" id="os__win32_8c_html_a288b0d3b5efd2d0257cfe8e9e4f647a1"><div class="ttname"><a href="os__win32_8c.html#a288b0d3b5efd2d0257cfe8e9e4f647a1">mch_remove</a></div><div class="ttdeci">int mch_remove(char_u *name)</div><div class="ttdef"><b>Definition:</b> <a href="os__win32_8c_source.html#l06442">os_win32.c:6442</a></div></div>
<div class="ttc" id="macros_8h_html_ac6bdfcb1fe7df56a18ffc5cf62ca1168"><div class="ttname"><a href="macros_8h.html#ac6bdfcb1fe7df56a18ffc5cf62ca1168">mch_lstat</a></div><div class="ttdeci">#define mch_lstat(n, p)</div><div class="ttdef"><b>Definition:</b> <a href="macros_8h_source.html#l00181">macros.h:181</a></div></div>
<div class="ttc" id="memline_8c_html_a2ac462e9a16bd27bb78d4e5e2cab8995"><div class="ttname"><a href="memline_8c.html#a2ac462e9a16bd27bb78d4e5e2cab8995">B0_MAGIC_LONG</a></div><div class="ttdeci">#define B0_MAGIC_LONG</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00143">memline.c:143</a></div></div>
<div class="ttc" id="os__amiga_8c_html_adef812b3e5ac260085599678ec08eafa"><div class="ttname"><a href="os__amiga_8c.html#adef812b3e5ac260085599678ec08eafa">mch_get_pid</a></div><div class="ttdeci">long mch_get_pid(void)</div><div class="ttdef"><b>Definition:</b> <a href="os__amiga_8c_source.html#l00697">os_amiga.c:697</a></div></div>
<div class="ttc" id="filepath_8c_html_af742ef578f2b4a17bce91b6ca6a8a7c6"><div class="ttname"><a href="filepath_8c.html#af742ef578f2b4a17bce91b6ca6a8a7c6">fullpathcmp</a></div><div class="ttdeci">int fullpathcmp(char_u *s1, char_u *s2, int checkname, int expandenv)</div><div class="ttdef"><b>Definition:</b> <a href="filepath_8c_source.html#l02315">filepath.c:2315</a></div></div>
<div class="ttc" id="structpos___t_html_a08c5af56d347e155e2cd721d99616ab8"><div class="ttname"><a href="structpos___t.html#a08c5af56d347e155e2cd721d99616ab8">pos_T::col</a></div><div class="ttdeci">colnr_T col</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00029">structs.h:29</a></div></div>
<div class="ttc" id="vim_8h_html_acc0703dad0b379b34be226e2402937db"><div class="ttname"><a href="vim_8h.html#acc0703dad0b379b34be226e2402937db">BF_RECOVERED</a></div><div class="ttdeci">#define BF_RECOVERED</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l00716">vim.h:716</a></div></div>
<div class="ttc" id="structdata__block_html_ac977617f5f8153eda5d902a73e0379e1"><div class="ttname"><a href="structdata__block.html#ac977617f5f8153eda5d902a73e0379e1">data_block::db_id</a></div><div class="ttdeci">short_u db_id</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00108">memline.c:108</a></div></div>
<div class="ttc" id="structmemfile_html_afad738129359e4b7fb943e3eedc2cdbd"><div class="ttname"><a href="structmemfile.html#afad738129359e4b7fb943e3eedc2cdbd">memfile::mf_used_last</a></div><div class="ttdeci">bhdr_T * mf_used_last</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00648">structs.h:648</a></div></div>
<div class="ttc" id="structblock0_html_acaaa2249e372c7710c595b07cd3288ec"><div class="ttname"><a href="structblock0.html#acaaa2249e372c7710c595b07cd3288ec">block0::b0_id</a></div><div class="ttdeci">char_u b0_id[2]</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00162">memline.c:162</a></div></div>
<div class="ttc" id="buffer_8c_html_af3a6f77e636ce62957db689adc66c680"><div class="ttname"><a href="buffer_8c.html#af3a6f77e636ce62957db689adc66c680">setfname</a></div><div class="ttdeci">int setfname(buf_T *buf, char_u *ffname_arg, char_u *sfname_arg, int message)</div><div class="ttdef"><b>Definition:</b> <a href="buffer_8c_source.html#l03144">buffer.c:3144</a></div></div>
<div class="ttc" id="memline_8c_html_a20133d6ad47e916b5e0512833896d5fe"><div class="ttname"><a href="memline_8c.html#a20133d6ad47e916b5e0512833896d5fe">ml_replace</a></div><div class="ttdeci">int ml_replace(linenr_T lnum, char_u *line, int copy)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l03371">memline.c:3371</a></div></div>
<div class="ttc" id="memline_8c_html_a19b014ee9a087900435acfa5166c2bea"><div class="ttname"><a href="memline_8c.html#a19b014ee9a087900435acfa5166c2bea">BLOCK0_ID1</a></div><div class="ttdeci">#define BLOCK0_ID1</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00063">memline.c:63</a></div></div>
<div class="ttc" id="dosinst_8h_html_a5ac083a645d964373f022d03df4849c8"><div class="ttname"><a href="dosinst_8h.html#a5ac083a645d964373f022d03df4849c8">name</a></div><div class="ttdeci">char * name</div><div class="ttdef"><b>Definition:</b> <a href="dosinst_8h_source.html#l00332">dosinst.h:332</a></div></div>
<div class="ttc" id="option_8h_html_a648216422e032905dfd91f01195ab459"><div class="ttname"><a href="option_8h.html#a648216422e032905dfd91f01195ab459">p_shm</a></div><div class="ttdeci">EXTERN char_u * p_shm</div><div class="ttdef"><b>Definition:</b> <a href="option_8h_source.html#l00864">option.h:864</a></div></div>
<div class="ttc" id="structchoice_html"><div class="ttname"><a href="structchoice.html">choice</a></div><div class="ttdef"><b>Definition:</b> <a href="dosinst_8c_source.html#l00050">dosinst.c:50</a></div></div>
<div class="ttc" id="vim_8h_html"><div class="ttname"><a href="vim_8h.html">vim.h</a></div></div>
<div class="ttc" id="memline_8c_html_a1fc0269a34abf68fee5e99b51879fa4b"><div class="ttname"><a href="memline_8c.html#a1fc0269a34abf68fee5e99b51879fa4b">ML_INSERT</a></div><div class="ttdeci">#define ML_INSERT</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00225">memline.c:225</a></div></div>
<div class="ttc" id="globals_8h_html_a0b03bc5fdd1ab38b00bf9264b8c7275b"><div class="ttname"><a href="globals_8h.html#a0b03bc5fdd1ab38b00bf9264b8c7275b">msg_scrolled</a></div><div class="ttdeci">EXTERN int msg_scrolled</div><div class="ttdef"><b>Definition:</b> <a href="globals_8h_source.html#l00192">globals.h:192</a></div></div>
<div class="ttc" id="memline_8c_html_ae8486bd6f1922d43b60969e2be927915"><div class="ttname"><a href="memline_8c.html#ae8486bd6f1922d43b60969e2be927915">ml_updatechunk</a></div><div class="ttdeci">static void ml_updatechunk(buf_T *buf, long line, long len, int updtype)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l05425">memline.c:5425</a></div></div>
<div class="ttc" id="memline_8c_html_a136a6ccfa892765672abfc5e0dff1a2d"><div class="ttname"><a href="memline_8c.html#a136a6ccfa892765672abfc5e0dff1a2d">B0_MAGIC_SHORT</a></div><div class="ttdeci">#define B0_MAGIC_SHORT</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00145">memline.c:145</a></div></div>
<div class="ttc" id="memline_8c_html_a95c3497feee28077f095256e5584c0af"><div class="ttname"><a href="memline_8c.html#a95c3497feee28077f095256e5584c0af">recov_file_names</a></div><div class="ttdeci">static int recov_file_names(char_u **, char_u *, int prepend_dot)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l02335">memline.c:2335</a></div></div>
<div class="ttc" id="structblock0_html_a619635d3effa9f2496dd6662e20b9037"><div class="ttname"><a href="structblock0.html#a619635d3effa9f2496dd6662e20b9037">block0::b0_fname</a></div><div class="ttdeci">char_u b0_fname[B0_FNAME_SIZE_ORG]</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00171">memline.c:171</a></div></div>
<div class="ttc" id="message_8c_html_a7926d7fa9a35dc0f5bac051dec01240a"><div class="ttname"><a href="message_8c.html#a7926d7fa9a35dc0f5bac051dec01240a">iemsg</a></div><div class="ttdeci">void iemsg(char *s)</div><div class="ttdef"><b>Definition:</b> <a href="message_8c_source.html#l00746">message.c:746</a></div></div>
<div class="ttc" id="memline_8c_html_aaabdfc4378cd70463534636d2d00c50d"><div class="ttname"><a href="memline_8c.html#aaabdfc4378cd70463534636d2d00c50d">add_text_props_for_append</a></div><div class="ttdeci">static void add_text_props_for_append(buf_T *buf, linenr_T lnum, char_u **line, int *len, char_u **tofree)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l02707">memline.c:2707</a></div></div>
<div class="ttc" id="misc2_8c_html_ab25a3a48241497fdc7bec2c3dbe41467"><div class="ttname"><a href="misc2_8c.html#ab25a3a48241497fdc7bec2c3dbe41467">vim_strncpy</a></div><div class="ttdeci">void vim_strncpy(char_u *to, char_u *from, size_t len)</div><div class="ttdef"><b>Definition:</b> <a href="misc2_8c_source.html#l01721">misc2.c:1721</a></div></div>
<div class="ttc" id="structpos___t_html_a2efcfdd664d0eb30552e17408eb6cd84"><div class="ttname"><a href="structpos___t.html#a2efcfdd664d0eb30552e17408eb6cd84">pos_T::coladd</a></div><div class="ttdeci">colnr_T coladd</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00030">structs.h:30</a></div></div>
<div class="ttc" id="structinfo__pointer_html_acdf584cb720506bd2f40240dc71bab50"><div class="ttname"><a href="structinfo__pointer.html#acdf584cb720506bd2f40240dc71bab50">info_pointer::ip_index</a></div><div class="ttdeci">int ip_index</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00684">structs.h:684</a></div></div>
<div class="ttc" id="memline_8c_html_a9c2c56f6c2568183afa203bc1654502e"><div class="ttname"><a href="memline_8c.html#a9c2c56f6c2568183afa203bc1654502e">get_file_in_dir</a></div><div class="ttdeci">char_u * get_file_in_dir(char_u *fname, char_u *dname)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l04480">memline.c:4480</a></div></div>
<div class="ttc" id="filepath_8c_html_acb4aef03c801e568565f34c9e10d25cf"><div class="ttname"><a href="filepath_8c.html#acb4aef03c801e568565f34c9e10d25cf">vim_ispathsep</a></div><div class="ttdeci">int vim_ispathsep(int c)</div><div class="ttdef"><b>Definition:</b> <a href="filepath_8c_source.html#l02487">filepath.c:2487</a></div></div>
<div class="ttc" id="message_8c_html_a3fb83ee5435e868683ecb3e44020f3b2"><div class="ttname"><a href="message_8c.html#a3fb83ee5435e868683ecb3e44020f3b2">vim_snprintf</a></div><div class="ttdeci">int vim_snprintf(char *str, size_t str_m, const char *fmt,...)</div><div class="ttdef"><b>Definition:</b> <a href="message_8c_source.html#l04113">message.c:4113</a></div></div>
<div class="ttc" id="structfile__buffer_html_a5ceacad82bc1498a6f10f027449fe9a0"><div class="ttname"><a href="structfile__buffer.html#a5ceacad82bc1498a6f10f027449fe9a0">file_buffer::b_p_fixeol</a></div><div class="ttdeci">int b_p_fixeol</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l02448">structs.h:2448</a></div></div>
<div class="ttc" id="vim_8h_html_a85e06d6b82dd2039305f00f975410d87"><div class="ttname"><a href="vim_8h.html#a85e06d6b82dd2039305f00f975410d87">BF_PRESERVED</a></div><div class="ttdeci">#define BF_PRESERVED</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l00729">vim.h:729</a></div></div>
<div class="ttc" id="filepath_8c_html_a3b361a1f7b0ca7d64f669e56cf543782"><div class="ttname"><a href="filepath_8c.html#a3b361a1f7b0ca7d64f669e56cf543782">expand_wildcards</a></div><div class="ttdeci">int expand_wildcards(int num_pat, char_u **pat, int *num_files, char_u ***files, int flags)</div><div class="ttdef"><b>Definition:</b> <a href="filepath_8c_source.html#l02748">filepath.c:2748</a></div></div>
<div class="ttc" id="message_8c_html_ae5991a4d11897dfaee9bfab8e5489d82"><div class="ttname"><a href="message_8c.html#ae5991a4d11897dfaee9bfab8e5489d82">emsg</a></div><div class="ttdeci">int emsg(char *s)</div><div class="ttdef"><b>Definition:</b> <a href="message_8c_source.html#l00710">message.c:710</a></div></div>
<div class="ttc" id="structblock0_html_aab3e8eda9003c121be3914c9606854b6"><div class="ttname"><a href="structblock0.html#aab3e8eda9003c121be3914c9606854b6">block0::b0_uname</a></div><div class="ttdeci">char_u b0_uname[B0_UNAME_SIZE]</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00169">memline.c:169</a></div></div>
<div class="ttc" id="vim_8h_html_a2de49dcf3b3c1e1043a2373b0d69a58aa37aec197ae0d6840760454b3ce99c9b2"><div class="ttname"><a href="vim_8h.html#a2de49dcf3b3c1e1043a2373b0d69a58aa37aec197ae0d6840760454b3ce99c9b2">EVENT_SWAPEXISTS</a></div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l01338">vim.h:1338</a></div></div>
<div class="ttc" id="memline_8c_html_abdecfc521a3e8fe9fde7d0a7f0baa4fc"><div class="ttname"><a href="memline_8c.html#abdecfc521a3e8fe9fde7d0a7f0baa4fc">ml_new_ptr</a></div><div class="ttdeci">static bhdr_T * ml_new_ptr(memfile_T *)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l04031">memline.c:4031</a></div></div>
<div class="ttc" id="gvimext_8cpp_html_af20b8d139279b360b0fdeae71f8f43bc"><div class="ttname"><a href="gvimext_8cpp.html#af20b8d139279b360b0fdeae71f8f43bc">_</a></div><div class="ttdeci">#define _(x)</div><div class="ttdef"><b>Definition:</b> <a href="gvimext_8cpp_source.html#l00148">gvimext.cpp:148</a></div></div>
<div class="ttc" id="macros_8h_html_a4e3dc19b42c157041ac2194f58111c3c"><div class="ttname"><a href="macros_8h.html#a4e3dc19b42c157041ac2194f58111c3c">mch_fstat</a></div><div class="ttdeci">#define mch_fstat(n, p)</div><div class="ttdef"><b>Definition:</b> <a href="macros_8h_source.html#l00166">macros.h:166</a></div></div>
<div class="ttc" id="structpointer__block_html_a334bce19304fd22fdf8035d010288321"><div class="ttname"><a href="structpointer__block.html#a334bce19304fd22fdf8035d010288321">pointer_block::pb_pointer</a></div><div class="ttdeci">PTR_EN pb_pointer[1]</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00095">memline.c:95</a></div></div>
<div class="ttc" id="structmemline_html_a17d957b4b662bf327749e1523ac4f5b5"><div class="ttname"><a href="structmemline.html#a17d957b4b662bf327749e1523ac4f5b5">memline::ml_stack_top</a></div><div class="ttdeci">int ml_stack_top</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00718">structs.h:718</a></div></div>
<div class="ttc" id="memline_8c_html_af8d501a6ccea291cd77605d10240eeda"><div class="ttname"><a href="memline_8c.html#af8d501a6ccea291cd77605d10240eeda">findswapname</a></div><div class="ttdeci">static char_u * findswapname(buf_T *, char_u **, char_u *)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l04622">memline.c:4622</a></div></div>
<div class="ttc" id="vim_8h_html_a816f77cc520622266f75542017a6f828"><div class="ttname"><a href="vim_8h.html#a816f77cc520622266f75542017a6f828">VIM_WARNING</a></div><div class="ttdeci">#define VIM_WARNING</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l01167">vim.h:1167</a></div></div>
<div class="ttc" id="structs_8h_html_a094e033c133f0276ed3c00f8053d0175"><div class="ttname"><a href="structs_8h.html#a094e033c133f0276ed3c00f8053d0175">ML_LOCKED_POS</a></div><div class="ttdeci">#define ML_LOCKED_POS</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00714">structs.h:714</a></div></div>
<div class="ttc" id="vim_8h_html_a42c849fb8f0be76ced2823ef6cff5174"><div class="ttname"><a href="vim_8h.html#a42c849fb8f0be76ced2823ef6cff5174">BF_DUMMY</a></div><div class="ttdeci">#define BF_DUMMY</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l00728">vim.h:728</a></div></div>
<div class="ttc" id="misc2_8c_html_acd554ee46804f666060916bf740b3c96"><div class="ttname"><a href="misc2_8c.html#acd554ee46804f666060916bf740b3c96">vim_strsave</a></div><div class="ttdeci">char_u * vim_strsave(char_u *string)</div><div class="ttdef"><b>Definition:</b> <a href="misc2_8c_source.html#l01270">misc2.c:1270</a></div></div>
<div class="ttc" id="structblock0_html_a8b0cab71ba5453122bcd862fe3d368ca"><div class="ttname"><a href="structblock0.html#a8b0cab71ba5453122bcd862fe3d368ca">block0::b0_hname</a></div><div class="ttdeci">char_u b0_hname[B0_HNAME_SIZE]</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00170">memline.c:170</a></div></div>
<div class="ttc" id="undo_8c_html_a56fe60092b6057c7cc3a38c785048841"><div class="ttname"><a href="undo_8c.html#a56fe60092b6057c7cc3a38c785048841">bufIsChanged</a></div><div class="ttdeci">int bufIsChanged(buf_T *buf)</div><div class="ttdef"><b>Definition:</b> <a href="undo_8c_source.html#l03546">undo.c:3546</a></div></div>
<div class="ttc" id="vim_8h_html_aad0d6768ce2f916f7c643be49f87a368"><div class="ttname"><a href="vim_8h.html#aad0d6768ce2f916f7c643be49f87a368">read_eintr</a></div><div class="ttdeci">#define read_eintr(fd, buf, count)</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l01730">vim.h:1730</a></div></div>
<div class="ttc" id="fileio_8c_html_a73e5befa6abbf600f3d3f1aaf1c2ee85"><div class="ttname"><a href="fileio_8c.html#a73e5befa6abbf600f3d3f1aaf1c2ee85">readfile</a></div><div class="ttdeci">int readfile(char_u *fname, char_u *sfname, linenr_T from, linenr_T lines_to_skip, linenr_T lines_to_read, exarg_T *eap, int flags)</div><div class="ttdef"><b>Definition:</b> <a href="fileio_8c_source.html#l00099">fileio.c:99</a></div></div>
<div class="ttc" id="memline_8c_html_a604565a0ff35e06e698b0b74abc87ec1"><div class="ttname"><a href="memline_8c.html#a604565a0ff35e06e698b0b74abc87ec1">ml_close_notmod</a></div><div class="ttdeci">void ml_close_notmod(void)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00885">memline.c:885</a></div></div>
<div class="ttc" id="structmemfile_html_ab0c66141886a009d8132b8e1e2a00fc6"><div class="ttname"><a href="structmemfile.html#ab0c66141886a009d8132b8e1e2a00fc6">memfile::mf_page_size</a></div><div class="ttdeci">unsigned mf_page_size</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00657">structs.h:657</a></div></div>
<div class="ttc" id="memline_8c_html_aba940da76a214a22a875eab61ec804e9"><div class="ttname"><a href="memline_8c.html#aba940da76a214a22a875eab61ec804e9">recover_names</a></div><div class="ttdeci">int recover_names(char_u *fname, int list, int nr, char_u **fname_out)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l01745">memline.c:1745</a></div></div>
<div class="ttc" id="memline_8c_html_a3d4cf908356280e457ffbd11d449b11b"><div class="ttname"><a href="memline_8c.html#a3d4cf908356280e457ffbd11d449b11b">B0_FNAME_SIZE_ORG</a></div><div class="ttdeci">#define B0_FNAME_SIZE_ORG</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00133">memline.c:133</a></div></div>
<div class="ttc" id="change_8c_html_a60e72aa7c3cf9c6df3c397c4a57191eb"><div class="ttname"><a href="change_8c.html#a60e72aa7c3cf9c6df3c397c4a57191eb">changed_internal</a></div><div class="ttdeci">void changed_internal(void)</div><div class="ttdef"><b>Definition:</b> <a href="change_8c_source.html#l00143">change.c:143</a></div></div>
<div class="ttc" id="structmemline_html_a2b7c6e30401df9d0e8972cb639d1b895"><div class="ttname"><a href="structmemline.html#a2b7c6e30401df9d0e8972cb639d1b895">memline::ml_locked_low</a></div><div class="ttdeci">linenr_T ml_locked_low</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00726">structs.h:726</a></div></div>
<div class="ttc" id="memfile_8c_html_afacf63c365230cb65206d3e98823ec29"><div class="ttname"><a href="memfile_8c.html#afacf63c365230cb65206d3e98823ec29">mf_close</a></div><div class="ttdeci">void mf_close(memfile_T *mfp, int del_file)</div><div class="ttdef"><b>Definition:</b> <a href="memfile_8c_source.html#l00239">memfile.c:239</a></div></div>
<div class="ttc" id="structfile__buffer_html_aec6a0756665954537e932c6d1b8378a8"><div class="ttname"><a href="structfile__buffer.html#aec6a0756665954537e932c6d1b8378a8">file_buffer::b_p_sn</a></div><div class="ttdeci">int b_p_sn</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l02496">structs.h:2496</a></div></div>
<div class="ttc" id="gui__mac_8c_html_af0e67ea85e8470c85b7e79fd86b606cd"><div class="ttname"><a href="gui__mac_8c.html#af0e67ea85e8470c85b7e79fd86b606cd">size</a></div><div class="ttdeci">FMFontSize size</div><div class="ttdef"><b>Definition:</b> <a href="gui__mac_8c_source.html#l00159">gui_mac.c:159</a></div></div>
<div class="ttc" id="crypt_8c_html_a5e97df05d361b7aa3a0cd069228dbc28"><div class="ttname"><a href="crypt_8c.html#a5e97df05d361b7aa3a0cd069228dbc28">crypt_free_state</a></div><div class="ttdeci">void crypt_free_state(cryptstate_T *state)</div><div class="ttdef"><b>Definition:</b> <a href="crypt_8c_source.html#l00382">crypt.c:382</a></div></div>
<div class="ttc" id="fileio_8c_html_a58a723d9fd552879f78c062190df4d1b"><div class="ttname"><a href="fileio_8c.html#a58a723d9fd552879f78c062190df4d1b">buf_store_time</a></div><div class="ttdeci">void buf_store_time(buf_T *buf, stat_T *st, char_u *fname UNUSED)</div><div class="ttdef"><b>Definition:</b> <a href="fileio_8c_source.html#l04395">fileio.c:4395</a></div></div>
<div class="ttc" id="structs_8h_html_adaffabd92745a7c8d9bf0e790cd35049"><div class="ttname"><a href="structs_8h.html#adaffabd92745a7c8d9bf0e790cd35049">CHANGEDTICK</a></div><div class="ttdeci">#define CHANGEDTICK(buf)</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l02280">structs.h:2280</a></div></div>
<div class="ttc" id="dosinst_8h_html_abb508ea8227673f419e9fe3a86c30d8e"><div class="ttname"><a href="dosinst_8h.html#abb508ea8227673f419e9fe3a86c30d8e">FAIL</a></div><div class="ttdeci">#define FAIL</div><div class="ttdef"><b>Definition:</b> <a href="dosinst_8h_source.html#l00061">dosinst.h:61</a></div></div>
<div class="ttc" id="structmemfile_html_aa0bbdc78a43847cb756129e7fa4d2abc"><div class="ttname"><a href="structmemfile.html#aa0bbdc78a43847cb756129e7fa4d2abc">memfile::mf_blocknr_max</a></div><div class="ttdeci">blocknr_T mf_blocknr_max</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00653">structs.h:653</a></div></div>
<div class="ttc" id="globals_8h_html_abc057f42fdaf5e63835a8272aefe278e"><div class="ttname"><a href="globals_8h.html#abc057f42fdaf5e63835a8272aefe278e">Version</a></div><div class="ttdeci">char * Version</div><div class="ttdef"><b>Definition:</b> <a href="version_8c_source.html#l00031">version.c:31</a></div></div>
<div class="ttc" id="structfile__buffer_html_a6102c96ffb9b9df10456769e74f91e2a"><div class="ttname"><a href="structfile__buffer.html#a6102c96ffb9b9df10456769e74f91e2a">file_buffer::b_orig_size</a></div><div class="ttdeci">off_T b_orig_size</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l02306">structs.h:2306</a></div></div>
<div class="ttc" id="structwindow___s_html_a4ed36d0cccb196ff9ba6a7e1995e3055"><div class="ttname"><a href="structwindow___s.html#a4ed36d0cccb196ff9ba6a7e1995e3055">window_S::w_set_curswant</a></div><div class="ttdeci">int w_set_curswant</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l02969">structs.h:2969</a></div></div>
<div class="ttc" id="memline_8c_html_aeb2a08db86a3f3c959cc50de278339eda657b3ee32a0fea16c976931ef3bc9e27"><div class="ttname"><a href="memline_8c.html#aeb2a08db86a3f3c959cc50de278339eda657b3ee32a0fea16c976931ef3bc9e27">UB_CRYPT</a></div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00234">memline.c:234</a></div></div>
<div class="ttc" id="structblock0_html_a9055bedd111a57a03cc1987905bb4ae0"><div class="ttname"><a href="structblock0.html#a9055bedd111a57a03cc1987905bb4ae0">block0::b0_mtime</a></div><div class="ttdeci">char_u b0_mtime[4]</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00166">memline.c:166</a></div></div>
<div class="ttc" id="dosinst_8h_html_aa93f0eb578d23995850d61f7d61c55c1"><div class="ttname"><a href="dosinst_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a></div><div class="ttdeci">#define FALSE</div><div class="ttdef"><b>Definition:</b> <a href="dosinst_8h_source.html#l00065">dosinst.h:65</a></div></div>
<div class="ttc" id="vim_8h_html_a2de49dcf3b3c1e1043a2373b0d69a58aa5f8d815faf4ecd8104d4eb0f4d7daf85"><div class="ttname"><a href="vim_8h.html#a2de49dcf3b3c1e1043a2373b0d69a58aa5f8d815faf4ecd8104d4eb0f4d7daf85">EVENT_BUFWINENTER</a></div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l01271">vim.h:1271</a></div></div>
<div class="ttc" id="vim_8h_html_a2de49dcf3b3c1e1043a2373b0d69a58aa07e541cd9061f877f65e3534a984df29"><div class="ttname"><a href="vim_8h.html#a2de49dcf3b3c1e1043a2373b0d69a58aa07e541cd9061f877f65e3534a984df29">EVENT_BUFREADPOST</a></div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l01268">vim.h:1268</a></div></div>
<div class="ttc" id="structs_8h_html_a8f04cc51224fb39997cd1bd5658c9592"><div class="ttname"><a href="structs_8h.html#a8f04cc51224fb39997cd1bd5658c9592">BH_DIRTY</a></div><div class="ttdeci">#define BH_DIRTY</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00501">structs.h:501</a></div></div>
<div class="ttc" id="structinfo__pointer_html_ac473382eb6323825263f4e65ddbb68de"><div class="ttname"><a href="structinfo__pointer.html#ac473382eb6323825263f4e65ddbb68de">info_pointer::ip_high</a></div><div class="ttdeci">linenr_T ip_high</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00683">structs.h:683</a></div></div>
<div class="ttc" id="memline_8c_html_ae7de358039e15f47f17c3e66d31a2370"><div class="ttname"><a href="memline_8c.html#ae7de358039e15f47f17c3e66d31a2370">do_swapexists</a></div><div class="ttdeci">static int do_swapexists(buf_T *buf, char_u *fname)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l04583">memline.c:4583</a></div></div>
<div class="ttc" id="message_8c_html_acf47f2acaa03395461e2b233638e69d0"><div class="ttname"><a href="message_8c.html#acf47f2acaa03395461e2b233638e69d0">internal_error</a></div><div class="ttdeci">void internal_error(char *where)</div><div class="ttdef"><b>Definition:</b> <a href="message_8c_source.html#l00784">message.c:784</a></div></div>
<div class="ttc" id="ui_8c_html_abc7b4e3a8391b6c9eb2e546a0bb69277"><div class="ttname"><a href="ui_8c.html#abc7b4e3a8391b6c9eb2e546a0bb69277">ui_char_avail</a></div><div class="ttdeci">int ui_char_avail(void)</div><div class="ttdef"><b>Definition:</b> <a href="ui_8c_source.html#l00508">ui.c:508</a></div></div>
<div class="ttc" id="vim_8h_html_a066f9420ac6e8bdb62ec8f50c8ad8d9e"><div class="ttname"><a href="vim_8h.html#a066f9420ac6e8bdb62ec8f50c8ad8d9e">MFS_ZERO</a></div><div class="ttdeci">#define MFS_ZERO</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l01061">vim.h:1061</a></div></div>
<div class="ttc" id="memfile_8c_html_a4b30ac8793ff0a0c43cc82527eb9d3c7"><div class="ttname"><a href="memfile_8c.html#a4b30ac8793ff0a0c43cc82527eb9d3c7">mf_new_page_size</a></div><div class="ttdeci">void mf_new_page_size(memfile_T *mfp, unsigned new_size)</div><div class="ttdef"><b>Definition:</b> <a href="memfile_8c_source.html#l00310">memfile.c:310</a></div></div>
<div class="ttc" id="structdata__block_html_a00084a39a3bdd9a03b9a055216aec5c5"><div class="ttname"><a href="structdata__block.html#a00084a39a3bdd9a03b9a055216aec5c5">data_block::db_line_count</a></div><div class="ttdeci">linenr_T db_line_count</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00112">memline.c:112</a></div></div>
<div class="ttc" id="memline_8c_html_a102390907b2af0b1cec3c50bf4308f81"><div class="ttname"><a href="memline_8c.html#a102390907b2af0b1cec3c50bf4308f81">ml_sync_all</a></div><div class="ttdeci">void ml_sync_all(int check_file, int check_char)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l02433">memline.c:2433</a></div></div>
<div class="ttc" id="namespacedehqx_html_aa833403a763c179f4ce8087adc050961"><div class="ttname"><a href="namespacedehqx.html#aa833403a763c179f4ce8087adc050961">dehqx.d</a></div><div class="ttdeci">d</div><div class="ttdef"><b>Definition:</b> <a href="dehqx_8py_source.html#l00026">dehqx.py:26</a></div></div>
<div class="ttc" id="structdictvar___s_html"><div class="ttname"><a href="structdictvar___s.html">dictvar_S</a></div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l01447">structs.h:1447</a></div></div>
<div class="ttc" id="memline_8c_html_a8dcf918c830f292339754bb9db126932"><div class="ttname"><a href="memline_8c.html#a8dcf918c830f292339754bb9db126932">BLOCK0_ID1_C1</a></div><div class="ttdeci">#define BLOCK0_ID1_C1</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00065">memline.c:65</a></div></div>
<div class="ttc" id="vim_8h_html_a934ce754d29a8aee92b71e970b7e2ae4"><div class="ttname"><a href="vim_8h.html#a934ce754d29a8aee92b71e970b7e2ae4">linenr_T</a></div><div class="ttdeci">long linenr_T</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l01679">vim.h:1679</a></div></div>
<div class="ttc" id="memline_8c_html_a661ea17a2f15417b31afca629fbef050"><div class="ttname"><a href="memline_8c.html#a661ea17a2f15417b31afca629fbef050">ml_lineadd</a></div><div class="ttdeci">static void ml_lineadd(buf_T *, int)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l04304">memline.c:4304</a></div></div>
<div class="ttc" id="memfile_8c_html_aef96feb7c9e3f3ba1f4901933dcc7424"><div class="ttname"><a href="memfile_8c.html#aef96feb7c9e3f3ba1f4901933dcc7424">mf_new</a></div><div class="ttdeci">bhdr_T * mf_new(memfile_T *mfp, int negative, int page_count)</div><div class="ttdef"><b>Definition:</b> <a href="memfile_8c_source.html#l00324">memfile.c:324</a></div></div>
<div class="ttc" id="misc2_8c_html_ae98dff29b2b09696996ab4ead873a667"><div class="ttname"><a href="misc2_8c.html#ae98dff29b2b09696996ab4ead873a667">vim_memset</a></div><div class="ttdeci">void * vim_memset(void *ptr, int c, size_t size)</div><div class="ttdef"><b>Definition:</b> <a href="misc2_8c_source.html#l01808">misc2.c:1808</a></div></div>
<div class="ttc" id="memline_8c_html_a6a6a68ff0366721a068693b1a8752a1c"><div class="ttname"><a href="memline_8c.html#a6a6a68ff0366721a068693b1a8752a1c">check_need_swap</a></div><div class="ttdeci">void check_need_swap(int newfile)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00825">memline.c:825</a></div></div>
<div class="ttc" id="memline_8c_html_a06f0b07737db79d2af91c2501ba32c6d"><div class="ttname"><a href="memline_8c.html#a06f0b07737db79d2af91c2501ba32c6d">ml_clearmarked</a></div><div class="ttdeci">void ml_clearmarked(void)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l03863">memline.c:3863</a></div></div>
<div class="ttc" id="option_8h_html_aebddc6c785cabe7f58b1cfa664fe2c5b"><div class="ttname"><a href="option_8h.html#aebddc6c785cabe7f58b1cfa664fe2c5b">CPO_PRESERVE</a></div><div class="ttdeci">#define CPO_PRESERVE</div><div class="ttdef"><b>Definition:</b> <a href="option_8h_source.html#l00204">option.h:204</a></div></div>
<div class="ttc" id="structfile__buffer_html_a82e1f497c5a51eff88502f03dd1cd5c3"><div class="ttname"><a href="structfile__buffer.html#a82e1f497c5a51eff88502f03dd1cd5c3">file_buffer::b_flags</a></div><div class="ttdeci">int b_flags</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l02241">structs.h:2241</a></div></div>
<div class="ttc" id="os__unix_8c_html_a64241cc23136bb6ab07b2d6b1fd826a0"><div class="ttname"><a href="os__unix_8c.html#a64241cc23136bb6ab07b2d6b1fd826a0">mch_get_uname</a></div><div class="ttdeci">int mch_get_uname(uid_t uid, char_u *s, int len)</div><div class="ttdef"><b>Definition:</b> <a href="os__unix_8c_source.html#l02366">os_unix.c:2366</a></div></div>
<div class="ttc" id="memfile_8c_html_af9d5ff9ad91a2d5150a675c9c0d77e10"><div class="ttname"><a href="memfile_8c.html#af9d5ff9ad91a2d5150a675c9c0d77e10">mf_get</a></div><div class="ttdeci">bhdr_T * mf_get(memfile_T *mfp, blocknr_T nr, int page_count)</div><div class="ttdef"><b>Definition:</b> <a href="memfile_8c_source.html#l00414">memfile.c:414</a></div></div>
<div class="ttc" id="os__amiga_8c_html_a6a38b6232ff7c7a63fb9e584947b369b"><div class="ttname"><a href="os__amiga_8c.html#a6a38b6232ff7c7a63fb9e584947b369b">mch_get_host_name</a></div><div class="ttdeci">void mch_get_host_name(char_u *s, int len)</div><div class="ttdef"><b>Definition:</b> <a href="os__amiga_8c_source.html#l00684">os_amiga.c:684</a></div></div>
<div class="ttc" id="getchar_8c_html_a08218e75f65cf78c2b75f702de094f74"><div class="ttname"><a href="getchar_8c.html#a08218e75f65cf78c2b75f702de094f74">flush_buffers</a></div><div class="ttdeci">void flush_buffers(flush_buffers_T flush_typeahead)</div><div class="ttdef"><b>Definition:</b> <a href="getchar_8c_source.html#l00412">getchar.c:412</a></div></div>
<div class="ttc" id="fileio_8c_html_a4b05aacc60d92626ca3d0ecb658e3c96"><div class="ttname"><a href="fileio_8c.html#a4b05aacc60d92626ca3d0ecb658e3c96">buf_modname</a></div><div class="ttdeci">char_u * buf_modname(int shortname, char_u *fname, char_u *ext, int prepend_dot)</div><div class="ttdef"><b>Definition:</b> <a href="fileio_8c_source.html#l03426">fileio.c:3426</a></div></div>
<div class="ttc" id="dict_8c_html_a759ca75bf61d60f49e272e193842c455"><div class="ttname"><a href="dict_8c.html#a759ca75bf61d60f49e272e193842c455">dict_add_string</a></div><div class="ttdeci">int dict_add_string(dict_T *d, char *key, char_u *str)</div><div class="ttdef"><b>Definition:</b> <a href="dict_8c_source.html#l00390">dict.c:390</a></div></div>
<div class="ttc" id="structfile__buffer_html_a26a473c691883e01ce4f747558b97a4d"><div class="ttname"><a href="structfile__buffer.html#a26a473c691883e01ce4f747558b97a4d">file_buffer::b_ffname</a></div><div class="ttdeci">char_u * b_ffname</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l02251">structs.h:2251</a></div></div>
<div class="ttc" id="structblock0_html_a543e42c027a0f62c7843b3f44a8b999c"><div class="ttname"><a href="structblock0.html#a543e42c027a0f62c7843b3f44a8b999c">block0::b0_magic_long</a></div><div class="ttdeci">long b0_magic_long</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00172">memline.c:172</a></div></div>
<div class="ttc" id="vim_8h_html_a1a8d0c2b62673b8dc085a5de49d19bd5"><div class="ttname"><a href="vim_8h.html#a1a8d0c2b62673b8dc085a5de49d19bd5">MSG_HIST</a></div><div class="ttdeci">#define MSG_HIST</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l00661">vim.h:661</a></div></div>
<div class="ttc" id="memline_8c_html_ac95d0fd4bafc7f2b52cd415aedcf0f05"><div class="ttname"><a href="memline_8c.html#ac95d0fd4bafc7f2b52cd415aedcf0f05">id1_codes</a></div><div class="ttdeci">static int id1_codes[]</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00069">memline.c:69</a></div></div>
<div class="ttc" id="memline_8c_html_ab9c47f1eaa4e6331a8a3369fc5b84a6f"><div class="ttname"><a href="memline_8c.html#ab9c47f1eaa4e6331a8a3369fc5b84a6f">get_b0_dict</a></div><div class="ttdeci">void get_b0_dict(char_u *fname, dict_T *d)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l02045">memline.c:2045</a></div></div>
<div class="ttc" id="memline_8c_html_a143a4d348c1d7c3e5ccc591f6653a984"><div class="ttname"><a href="memline_8c.html#a143a4d348c1d7c3e5ccc591f6653a984">ml_new_data</a></div><div class="ttdeci">static bhdr_T * ml_new_data(memfile_T *, int, int)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l04010">memline.c:4010</a></div></div>
<div class="ttc" id="memline_8c_html_aeb2a08db86a3f3c959cc50de278339ed"><div class="ttname"><a href="memline_8c.html#aeb2a08db86a3f3c959cc50de278339ed">upd_block0_T</a></div><div class="ttdeci">upd_block0_T</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00231">memline.c:231</a></div></div>
<div class="ttc" id="vim_8h_html_a75fb5fb9d785a71f9d82f4d008a48278"><div class="ttname"><a href="vim_8h.html#a75fb5fb9d785a71f9d82f4d008a48278">STRCMP</a></div><div class="ttdeci">#define STRCMP(d, s)</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l01592">vim.h:1592</a></div></div>
<div class="ttc" id="structmemline_html_aada7438521544eec6c73e223b2811a69"><div class="ttname"><a href="structmemline.html#aada7438521544eec6c73e223b2811a69">memline::ml_line_ptr</a></div><div class="ttdeci">char_u * ml_line_ptr</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00722">structs.h:722</a></div></div>
<div class="ttc" id="structblock0_html_a5b992d5ca8d9cc3eb941debcdea6f180"><div class="ttname"><a href="structblock0.html#a5b992d5ca8d9cc3eb941debcdea6f180">block0::b0_page_size</a></div><div class="ttdeci">char_u b0_page_size[4]</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00165">memline.c:165</a></div></div>
<div class="ttc" id="memline_8c_html_af7b21ec1ab530c05f8d8b95c576c9aaa"><div class="ttname"><a href="memline_8c.html#af7b21ec1ab530c05f8d8b95c576c9aaa">ml_firstmarked</a></div><div class="ttdeci">linenr_T ml_firstmarked(void)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l03819">memline.c:3819</a></div></div>
<div class="ttc" id="ascii_8h_html_af19d48b9f61047a668649a2f9dc317ff"><div class="ttname"><a href="ascii_8h.html#af19d48b9f61047a668649a2f9dc317ff">NUL</a></div><div class="ttdeci">#define NUL</div><div class="ttdef"><b>Definition:</b> <a href="ascii_8h_source.html#l00024">ascii.h:24</a></div></div>
<div class="ttc" id="misc2_8c_html_abdfcdf88256313698f6b7329ba22c5f3"><div class="ttname"><a href="misc2_8c.html#abdfcdf88256313698f6b7329ba22c5f3">after_pathsep</a></div><div class="ttdeci">int after_pathsep(char_u *b, char_u *p)</div><div class="ttdef"><b>Definition:</b> <a href="misc2_8c_source.html#l03232">misc2.c:3232</a></div></div>
<div class="ttc" id="filepath_8c_html_a433b6128e0e476f8bf41348e0e27f2c7"><div class="ttname"><a href="filepath_8c.html#a433b6128e0e476f8bf41348e0e27f2c7">FullName_save</a></div><div class="ttdeci">char_u * FullName_save(char_u *fname, int force)</div><div class="ttdef"><b>Definition:</b> <a href="filepath_8c_source.html#l02666">filepath.c:2666</a></div></div>
<div class="ttc" id="memline_8c_html_ab994bfde1fec8c463065bbb9a402a35d"><div class="ttname"><a href="memline_8c.html#ab994bfde1fec8c463065bbb9a402a35d">DB_MARKED</a></div><div class="ttdeci">#define DB_MARKED</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00127">memline.c:127</a></div></div>
<div class="ttc" id="globals_8h_html_ad239f2bb11982175ed2389134c8f3669"><div class="ttname"><a href="globals_8h.html#ad239f2bb11982175ed2389134c8f3669">cmdline_row</a></div><div class="ttdeci">EXTERN int cmdline_row</div><div class="ttdef"><b>Definition:</b> <a href="globals_8h_source.html#l00134">globals.h:134</a></div></div>
<div class="ttc" id="structmemfile_html"><div class="ttname"><a href="structmemfile.html">memfile</a></div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00639">structs.h:639</a></div></div>
<div class="ttc" id="memline_8c_html_a2498547c6752de3ff3cb3a9526ef8050"><div class="ttname"><a href="memline_8c.html#a2498547c6752de3ff3cb3a9526ef8050">B0_MAGIC_INT</a></div><div class="ttdeci">#define B0_MAGIC_INT</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00144">memline.c:144</a></div></div>
<div class="ttc" id="memfile_8c_html_a0d08b5a784a38d87c1338f37ffee917a"><div class="ttname"><a href="memfile_8c.html#a0d08b5a784a38d87c1338f37ffee917a">mf_set_ffname</a></div><div class="ttdeci">void mf_set_ffname(memfile_T *mfp)</div><div class="ttdef"><b>Definition:</b> <a href="memfile_8c_source.html#l01213">memfile.c:1213</a></div></div>
<div class="ttc" id="namespacetest__channel_html_a6a2152bf75d93cd14fcffc99c3e76807"><div class="ttname"><a href="namespacetest__channel.html#a6a2152bf75d93cd14fcffc99c3e76807">test_channel.ip</a></div><div class="ttdeci">ip</div><div class="ttdef"><b>Definition:</b> <a href="test__channel_8py_source.html#l00252">test_channel.py:252</a></div></div>
<div class="ttc" id="structtextprop___s_html_add824afd44cdd8e8a34e008fa91fb708"><div class="ttname"><a href="structtextprop___s.html#add824afd44cdd8e8a34e008fa91fb708">textprop_S::tp_id</a></div><div class="ttdeci">int tp_id</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00746">structs.h:746</a></div></div>
<div class="ttc" id="vim_8h_html_ae79e04a416bd6ce8ffe80e241850c0d2"><div class="ttname"><a href="vim_8h.html#ae79e04a416bd6ce8ffe80e241850c0d2">colnr_T</a></div><div class="ttdeci">int colnr_T</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l01680">vim.h:1680</a></div></div>
<div class="ttc" id="memline_8c_html_a2249fb5b4839da11dd7db4635aaae6e3"><div class="ttname"><a href="memline_8c.html#a2249fb5b4839da11dd7db4635aaae6e3">ml_crypt_prepare</a></div><div class="ttdeci">static cryptstate_T * ml_crypt_prepare(memfile_T *mfp, off_T offset, int reading)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l05370">memline.c:5370</a></div></div>
<div class="ttc" id="memline_8c_html_a8942569e896707801271476ee05853f8"><div class="ttname"><a href="memline_8c.html#a8942569e896707801271476ee05853f8">ml_get_curline</a></div><div class="ttdeci">char_u * ml_get_curline(void)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l02585">memline.c:2585</a></div></div>
<div class="ttc" id="memline_8c_html_a7bbeb7c2510db6fc4366434b1b1996cf"><div class="ttname"><a href="memline_8c.html#a7bbeb7c2510db6fc4366434b1b1996cf">ml_append_flush</a></div><div class="ttdeci">static int ml_append_flush(buf_T *buf, linenr_T lnum, char_u *line, colnr_T len, int newfile)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l03290">memline.c:3290</a></div></div>
<div class="ttc" id="crypt_8c_html_a7246e308e1dcfe42d01aae41dfcb1841"><div class="ttname"><a href="crypt_8c.html#a7246e308e1dcfe42d01aae41dfcb1841">crypt_create</a></div><div class="ttdeci">cryptstate_T * crypt_create(int method_nr, char_u *key, char_u *salt, int salt_len, char_u *seed, int seed_len)</div><div class="ttdef"><b>Definition:</b> <a href="crypt_8c_source.html#l00249">crypt.c:249</a></div></div>
<div class="ttc" id="structfile__buffer_html_a0dbc556e96a2a6afd3284b5a3bae167a"><div class="ttname"><a href="structfile__buffer.html#a0dbc556e96a2a6afd3284b5a3bae167a">file_buffer::b_p_swf</a></div><div class="ttdeci">int b_p_swf</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l02505">structs.h:2505</a></div></div>
<div class="ttc" id="memfile_8c_html_a5bfe0380a8116b9f0cc01eb761eccdb4"><div class="ttname"><a href="memfile_8c.html#a5bfe0380a8116b9f0cc01eb761eccdb4">mf_need_trans</a></div><div class="ttdeci">int mf_need_trans(memfile_T *mfp)</div><div class="ttdef"><b>Definition:</b> <a href="memfile_8c_source.html#l01237">memfile.c:1237</a></div></div>
<div class="ttc" id="misc2_8c_html_a8978cebac3b4ced66551e67c3a375842"><div class="ttname"><a href="misc2_8c.html#a8978cebac3b4ced66551e67c3a375842">vim_strchr</a></div><div class="ttdeci">char_u * vim_strchr(char_u *string, int c)</div><div class="ttdef"><b>Definition:</b> <a href="misc2_8c_source.html#l01875">misc2.c:1875</a></div></div>
<div class="ttc" id="mbyte_8c_html_a4a8f6c91eefb9c6bf448592aac44153d"><div class="ttname"><a href="mbyte_8c.html#a4a8f6c91eefb9c6bf448592aac44153d">prop</a></div><div class="ttdeci">int prop</div><div class="ttdef"><b>Definition:</b> <a href="mbyte_8c_source.html#l00219">mbyte.c:219</a></div></div>
<div class="ttc" id="vim_8h_html_a30a049fe4d0d13f9c4c5296b8b0ecc34"><div class="ttname"><a href="vim_8h.html#a30a049fe4d0d13f9c4c5296b8b0ecc34">STRNICMP</a></div><div class="ttdeci">#define STRNICMP(d, s, n)</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l01613">vim.h:1613</a></div></div>
<div class="ttc" id="structblock__hdr_html_a7247cdc0977ab6fdc9cb6238cda67587"><div class="ttname"><a href="structblock__hdr.html#a7247cdc0977ab6fdc9cb6238cda67587">block_hdr::bh_data</a></div><div class="ttdeci">char_u * bh_data</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00498">structs.h:498</a></div></div>
<div class="ttc" id="memline_8c_html_a50f229cf0f22b1940ea90f5c643a20b0"><div class="ttname"><a href="memline_8c.html#a50f229cf0f22b1940ea90f5c643a20b0">ml_append_buf</a></div><div class="ttdeci">int ml_append_buf(buf_T *buf, linenr_T lnum, char_u *line, colnr_T len, int newfile)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l03346">memline.c:3346</a></div></div>
<div class="ttc" id="fileio_8c_html_a00ff91d733dfe503a764535bd6effbd2"><div class="ttname"><a href="fileio_8c.html#a00ff91d733dfe503a764535bd6effbd2">vim_tempname</a></div><div class="ttdeci">char_u * vim_tempname(int extra_char UNUSED, int keep UNUSED)</div><div class="ttdef"><b>Definition:</b> <a href="fileio_8c_source.html#l04661">fileio.c:4661</a></div></div>
<div class="ttc" id="vim_8h_html_a54e78aad180f304a56df62e51adbeb39"><div class="ttname"><a href="vim_8h.html#a54e78aad180f304a56df62e51adbeb39">FPC_SAME</a></div><div class="ttdeci">#define FPC_SAME</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l01025">vim.h:1025</a></div></div>
<div class="ttc" id="memline_8c_html_ac41dda1cc86f79d5c0a94bb91a5b8a88"><div class="ttname"><a href="memline_8c.html#ac41dda1cc86f79d5c0a94bb91a5b8a88">ml_find_line_or_offset</a></div><div class="ttdeci">long ml_find_line_or_offset(buf_T *buf, linenr_T lnum, long *offp)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l05680">memline.c:5680</a></div></div>
<div class="ttc" id="macros_8h_html_a8e76521a98776d2e3f9b33fcb331dcee"><div class="ttname"><a href="macros_8h.html#a8e76521a98776d2e3f9b33fcb331dcee">MB_PTR_ADV</a></div><div class="ttdeci">#define MB_PTR_ADV(p)</div><div class="ttdef"><b>Definition:</b> <a href="macros_8h_source.html#l00235">macros.h:235</a></div></div>
<div class="ttc" id="structmemline_html_a77e2179043ee3367af09fe186b2fa5a8"><div class="ttname"><a href="structmemline.html#a77e2179043ee3367af09fe186b2fa5a8">memline::ml_stack</a></div><div class="ttdeci">infoptr_T * ml_stack</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00717">structs.h:717</a></div></div>
<div class="ttc" id="filepath_8c_html_a5086b658043e0a5bf23116fb75b8936e"><div class="ttname"><a href="filepath_8c.html#a5086b658043e0a5bf23116fb75b8936e">FreeWild</a></div><div class="ttdeci">void FreeWild(int count, char_u **files)</div><div class="ttdef"><b>Definition:</b> <a href="filepath_8c_source.html#l03713">filepath.c:3713</a></div></div>
<div class="ttc" id="structmemfile_html_afdcf6885ed563e5559f9d31f63c0635d"><div class="ttname"><a href="structmemfile.html#afdcf6885ed563e5559f9d31f63c0635d">memfile::mf_infile_count</a></div><div class="ttdeci">blocknr_T mf_infile_count</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00656">structs.h:656</a></div></div>
<div class="ttc" id="structblock__hdr_html_a43dfab09857d99015a29c95afa5097c8"><div class="ttname"><a href="structblock__hdr.html#a43dfab09857d99015a29c95afa5097c8">block_hdr::bh_prev</a></div><div class="ttdeci">bhdr_T * bh_prev</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00497">structs.h:497</a></div></div>
<div class="ttc" id="memline_8c_html_a20a3268681f79a76b9af2f2fc7b644b6"><div class="ttname"><a href="memline_8c.html#a20a3268681f79a76b9af2f2fc7b644b6">ml_flush_line</a></div><div class="ttdeci">static void ml_flush_line(buf_T *)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l03905">memline.c:3905</a></div></div>
<div class="ttc" id="vim_8h_html_a7250711b9595001492c8b4742920acb6"><div class="ttname"><a href="vim_8h.html#a7250711b9595001492c8b4742920acb6">MFS_ALL</a></div><div class="ttdeci">#define MFS_ALL</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l01058">vim.h:1058</a></div></div>
<div class="ttc" id="autocmd_8c_html_a0239c7fe680501d4396b532abf3bd768"><div class="ttname"><a href="autocmd_8c.html#a0239c7fe680501d4396b532abf3bd768">apply_autocmds</a></div><div class="ttdeci">int apply_autocmds(event_T event, char_u *fname, char_u *fname_io, int force, buf_T *buf)</div><div class="ttdef"><b>Definition:</b> <a href="autocmd_8c_source.html#l01600">autocmd.c:1600</a></div></div>
<div class="ttc" id="sha256_8c_html_a7e5749e8118113a34c7964e5d7634b8b"><div class="ttname"><a href="sha256_8c.html#a7e5749e8118113a34c7964e5d7634b8b">sha2_seed</a></div><div class="ttdeci">void sha2_seed(char_u *header, int header_len, char_u *salt, int salt_len)</div><div class="ttdef"><b>Definition:</b> <a href="sha256_8c_source.html#l00398">sha256.c:398</a></div></div>
<div class="ttc" id="os__unix_8h_html_a9b75f9db03a33bb3d2d613923647d0cf"><div class="ttname"><a href="os__unix_8h.html#a9b75f9db03a33bb3d2d613923647d0cf">MAXPATHL</a></div><div class="ttdeci">#define MAXPATHL</div><div class="ttdef"><b>Definition:</b> <a href="os__unix_8h_source.html#l00409">os_unix.h:409</a></div></div>
<div class="ttc" id="memline_8c_html_a02af71b1ca7aa25fc3eb3050d30ce453"><div class="ttname"><a href="memline_8c.html#a02af71b1ca7aa25fc3eb3050d30ce453">ml_setmarked</a></div><div class="ttdeci">void ml_setmarked(linenr_T lnum)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l03790">memline.c:3790</a></div></div>
<div class="ttc" id="vterm__internal_8h_html_addf5ec070e9499d36b7f2009ce736076"><div class="ttname"><a href="vterm__internal_8h.html#addf5ec070e9499d36b7f2009ce736076">UNUSED</a></div><div class="ttdeci">#define UNUSED</div><div class="ttdef"><b>Definition:</b> <a href="vterm__internal_8h_source.html#l00013">vterm_internal.h:13</a></div></div>
<div class="ttc" id="structmemfile_html_ae775b29d1b383ccb0bd8c71fc22f3771"><div class="ttname"><a href="structmemfile.html#ae775b29d1b383ccb0bd8c71fc22f3771">memfile::mf_dirty</a></div><div class="ttdeci">int mf_dirty</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00658">structs.h:658</a></div></div>
<div class="ttc" id="vim_8h_html_aa21e4fd8501798f13fdad0d16ed006f1"><div class="ttname"><a href="vim_8h.html#aa21e4fd8501798f13fdad0d16ed006f1">EW_KEEPALL</a></div><div class="ttdeci">#define EW_KEEPALL</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l00822">vim.h:822</a></div></div>
<div class="ttc" id="structs_8h_html_ad55a676a17d24163d3cdb2bf75a7fa66"><div class="ttname"><a href="structs_8h.html#ad55a676a17d24163d3cdb2bf75a7fa66">ML_LOCKED_DIRTY</a></div><div class="ttdeci">#define ML_LOCKED_DIRTY</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00713">structs.h:713</a></div></div>
<div class="ttc" id="option_8h_html_a4067a59443206ab22efad3fc618a8f4e"><div class="ttname"><a href="option_8h.html#a4067a59443206ab22efad3fc618a8f4e">SHM_ATTENTION</a></div><div class="ttdeci">#define SHM_ATTENTION</div><div class="ttdef"><b>Definition:</b> <a href="option_8h_source.html#l00248">option.h:248</a></div></div>
<div class="ttc" id="structpointer__block_html_ad9d615e7c53c2892e6d04a0d257df592"><div class="ttname"><a href="structpointer__block.html#ad9d615e7c53c2892e6d04a0d257df592">pointer_block::pb_count_max</a></div><div class="ttdeci">short_u pb_count_max</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00094">memline.c:94</a></div></div>
<div class="ttc" id="vim_8h_html_a6997207b131d14a30429a3c80cd3db59"><div class="ttname"><a href="vim_8h.html#a6997207b131d14a30429a3c80cd3db59">HL_ATTR</a></div><div class="ttdeci">#define HL_ATTR(n)</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l01747">vim.h:1747</a></div></div>
<div class="ttc" id="memline_8c_html_a8837c8c8a497ab410a9e925581f966c3"><div class="ttname"><a href="memline_8c.html#a8837c8c8a497ab410a9e925581f966c3">lowest_marked</a></div><div class="ttdeci">static linenr_T lowest_marked</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00219">memline.c:219</a></div></div>
<div class="ttc" id="memline_8c_html_a55aa586df150c1192826a1c57dd87401"><div class="ttname"><a href="memline_8c.html#a55aa586df150c1192826a1c57dd87401">DATA_ID</a></div><div class="ttdeci">#define DATA_ID</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00060">memline.c:60</a></div></div>
<div class="ttc" id="misc2_8c_html_a7bbb60cf940e6fbc12e0ecd4e124c5c0"><div class="ttname"><a href="misc2_8c.html#a7bbb60cf940e6fbc12e0ecd4e124c5c0">same_directory</a></div><div class="ttdeci">int same_directory(char_u *f1, char_u *f2)</div><div class="ttdef"><b>Definition:</b> <a href="misc2_8c_source.html#l03243">misc2.c:3243</a></div></div>
<div class="ttc" id="memfile_8c_html_abb7f268382703d32becc96f6d92fb855"><div class="ttname"><a href="memfile_8c.html#abb7f268382703d32becc96f6d92fb855">mf_put</a></div><div class="ttdeci">void mf_put(memfile_T *mfp, bhdr_T *hp, int dirty, int infile)</div><div class="ttdef"><b>Definition:</b> <a href="memfile_8c_source.html#l00472">memfile.c:472</a></div></div>
<div class="ttc" id="structtextprop___s_html_a92930deb459cef0462e9e4ce332fc579"><div class="ttname"><a href="structtextprop___s.html#a92930deb459cef0462e9e4ce332fc579">textprop_S::tp_len</a></div><div class="ttdeci">colnr_T tp_len</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00745">structs.h:745</a></div></div>
<div class="ttc" id="misc2_8c_html_abf709bd8a8505e69b7eb371517bcfebc"><div class="ttname"><a href="misc2_8c.html#abf709bd8a8505e69b7eb371517bcfebc">get_user_name</a></div><div class="ttdeci">int get_user_name(char_u *buf, int len)</div><div class="ttdef"><b>Definition:</b> <a href="misc2_8c_source.html#l03770">misc2.c:3770</a></div></div>
<div class="ttc" id="vim_8h_html_a4c810fca3e2a9adfbd66cc5f0536d8f0"><div class="ttname"><a href="vim_8h.html#a4c810fca3e2a9adfbd66cc5f0536d8f0">MFS_STOP</a></div><div class="ttdeci">#define MFS_STOP</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l01059">vim.h:1059</a></div></div>
<div class="ttc" id="structblock0_html_a821963e4a98dd9ec3d819afa9ccd660f"><div class="ttname"><a href="structblock0.html#a821963e4a98dd9ec3d819afa9ccd660f">block0::b0_magic_char</a></div><div class="ttdeci">char_u b0_magic_char</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00175">memline.c:175</a></div></div>
<div class="ttc" id="memfile_8c_html_ac224c12ac428b0a19a3b38ecd98310a3"><div class="ttname"><a href="memfile_8c.html#ac224c12ac428b0a19a3b38ecd98310a3">mf_trans_del</a></div><div class="ttdeci">blocknr_T mf_trans_del(memfile_T *mfp, blocknr_T old_nr)</div><div class="ttdef"><b>Definition:</b> <a href="memfile_8c_source.html#l01186">memfile.c:1186</a></div></div>
<div class="ttc" id="vim_8h_html_a70c2e1c93622f9cc806906ebe68fe5cf"><div class="ttname"><a href="vim_8h.html#a70c2e1c93622f9cc806906ebe68fe5cf">EW_SILENT</a></div><div class="ttdeci">#define EW_SILENT</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l00823">vim.h:823</a></div></div>
<div class="ttc" id="vim_8h_html_a09d598baef43cbaa4d3c3221e7c26b32"><div class="ttname"><a href="vim_8h.html#a09d598baef43cbaa4d3c3221e7c26b32">MIN_SWAP_PAGE_SIZE</a></div><div class="ttdeci">#define MIN_SWAP_PAGE_SIZE</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l01242">vim.h:1242</a></div></div>
<div class="ttc" id="hardcopy_8c_html_a8779304c095e1ed27c30d4b5b3f2437a"><div class="ttname"><a href="hardcopy_8c.html#a8779304c095e1ed27c30d4b5b3f2437a">page_count</a></div><div class="ttdeci">static int page_count</div><div class="ttdef"><b>Definition:</b> <a href="hardcopy_8c_source.html#l00103">hardcopy.c:103</a></div></div>
<div class="ttc" id="vim_8h_html_a4da9786c337d9d735a7428591c751035"><div class="ttname"><a href="vim_8h.html#a4da9786c337d9d735a7428591c751035">READ_NEW</a></div><div class="ttdeci">#define READ_NEW</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l00970">vim.h:970</a></div></div>
<div class="ttc" id="crypt_8c_html_a030bf2af55ba450f83a172aa68f9434c"><div class="ttname"><a href="crypt_8c.html#a030bf2af55ba450f83a172aa68f9434c">crypt_decode_inplace</a></div><div class="ttdeci">void crypt_decode_inplace(cryptstate_T *state, char_u *buf, size_t len)</div><div class="ttdef"><b>Definition:</b> <a href="crypt_8c_source.html#l00491">crypt.c:491</a></div></div>
<div class="ttc" id="fileio_8c_html_aac79f705198b1f5212fd7f7bba16b852"><div class="ttname"><a href="fileio_8c.html#aac79f705198b1f5212fd7f7bba16b852">modname</a></div><div class="ttdeci">char_u * modname(char_u *fname, char_u *ext, int prepend_dot)</div><div class="ttdef"><b>Definition:</b> <a href="fileio_8c_source.html#l03416">fileio.c:3416</a></div></div>
<div class="ttc" id="message_8c_html_ae0edfa8d1999c41726a759fd06a1ab6e"><div class="ttname"><a href="message_8c.html#ae0edfa8d1999c41726a759fd06a1ab6e">msg_putchar</a></div><div class="ttdeci">void msg_putchar(int c)</div><div class="ttdef"><b>Definition:</b> <a href="message_8c_source.html#l01360">message.c:1360</a></div></div>
<div class="ttc" id="message_8c_html_afe8652ccadf4b8716f60ad84d9fb7ea2"><div class="ttname"><a href="message_8c.html#afe8652ccadf4b8716f60ad84d9fb7ea2">msg_outtrans_attr</a></div><div class="ttdeci">int msg_outtrans_attr(char_u *str, int attr)</div><div class="ttdef"><b>Definition:</b> <a href="message_8c_source.html#l01429">message.c:1429</a></div></div>
<div class="ttc" id="memline_8c_html_ace6f748ee345944bbe21944baea19883"><div class="ttname"><a href="memline_8c.html#ace6f748ee345944bbe21944baea19883">BLOCK0_ID0</a></div><div class="ttdeci">#define BLOCK0_ID0</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00062">memline.c:62</a></div></div>
<div class="ttc" id="structs_8h_html_a67ecfd4d644d8b33ba15512b7136602a"><div class="ttname"><a href="structs_8h.html#a67ecfd4d644d8b33ba15512b7136602a">ML_EMPTY</a></div><div class="ttdeci">#define ML_EMPTY</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00711">structs.h:711</a></div></div>
<div class="ttc" id="structtextprop___s_html_a4c52970bf78ad518de599790e4e9c500"><div class="ttname"><a href="structtextprop___s.html#a4c52970bf78ad518de599790e4e9c500">textprop_S::tp_col</a></div><div class="ttdeci">colnr_T tp_col</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00744">structs.h:744</a></div></div>
<div class="ttc" id="memline_8c_html_ab299d2ddb4d4be7565b25e8a197e63bb"><div class="ttname"><a href="memline_8c.html#ab299d2ddb4d4be7565b25e8a197e63bb">B0_FF_MASK</a></div><div class="ttdeci">#define B0_FF_MASK</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00201">memline.c:201</a></div></div>
<div class="ttc" id="memline_8c_html_af02ef149bb7430fbe0cd031bbab8b3c2"><div class="ttname"><a href="memline_8c.html#af02ef149bb7430fbe0cd031bbab8b3c2">ml_open_file</a></div><div class="ttdeci">void ml_open_file(buf_T *buf)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00744">memline.c:744</a></div></div>
<div class="ttc" id="message_8c_html_ab18e462ca688b9c33d6207095681d288"><div class="ttname"><a href="message_8c.html#ab18e462ca688b9c33d6207095681d288">msg_end</a></div><div class="ttdeci">int msg_end(void)</div><div class="ttdef"><b>Definition:</b> <a href="message_8c_source.html#l03272">message.c:3272</a></div></div>
<div class="ttc" id="vim_8h_html_ab9c14f3e74c2ae526ac73d0ac7be68e2"><div class="ttname"><a href="vim_8h.html#ab9c14f3e74c2ae526ac73d0ac7be68e2">SEA_NONE</a></div><div class="ttdeci">#define SEA_NONE</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l01231">vim.h:1231</a></div></div>
<div class="ttc" id="memline_8c_html_ad55f706f79a7fbd002ea07458e1c1189"><div class="ttname"><a href="memline_8c.html#ad55f706f79a7fbd002ea07458e1c1189">goto_byte</a></div><div class="ttdeci">void goto_byte(long cnt)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l05820">memline.c:5820</a></div></div>
<div class="ttc" id="structfile__buffer_html_a454ea380346ba5441df8c2631a55741b"><div class="ttname"><a href="structfile__buffer.html#a454ea380346ba5441df8c2631a55741b">file_buffer::b_p_eol</a></div><div class="ttdeci">int b_p_eol</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l02447">structs.h:2447</a></div></div>
<div class="ttc" id="memline_8c_html_af38a893593cb2264fbd2b47e7150db1a"><div class="ttname"><a href="memline_8c.html#af38a893593cb2264fbd2b47e7150db1a">vim_localtime</a></div><div class="ttdeci">struct tm * vim_localtime(const time_t *timep, struct tm *result UNUSED)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l02102">memline.c:2102</a></div></div>
<div class="ttc" id="structpointer__entry_html_a0234165c0ca282f192e94957a87175f6"><div class="ttname"><a href="structpointer__entry.html#a0234165c0ca282f192e94957a87175f6">pointer_entry::pe_bnum</a></div><div class="ttdeci">blocknr_T pe_bnum</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00081">memline.c:81</a></div></div>
<div class="ttc" id="message_8c_html_aa4a7a34db68561f1e14a20524dbbc4c1"><div class="ttname"><a href="message_8c.html#aa4a7a34db68561f1e14a20524dbbc4c1">msg_home_replace</a></div><div class="ttdeci">void msg_home_replace(char_u *fname)</div><div class="ttdef"><b>Definition:</b> <a href="message_8c_source.html#l01392">message.c:1392</a></div></div>
<div class="ttc" id="option_8h_html_aecddef423586bfbf192adca96adec2e6"><div class="ttname"><a href="option_8h.html#aecddef423586bfbf192adca96adec2e6">EOL_DOS</a></div><div class="ttdeci">#define EOL_DOS</div><div class="ttdef"><b>Definition:</b> <a href="option_8h_source.html#l00121">option.h:121</a></div></div>
<div class="ttc" id="structinfo__pointer_html"><div class="ttname"><a href="structinfo__pointer.html">info_pointer</a></div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00679">structs.h:679</a></div></div>
<div class="ttc" id="dict_8c_html_a19be416abede1c238aca79a809ed7676"><div class="ttname"><a href="dict_8c.html#a19be416abede1c238aca79a809ed7676">dict_add_number</a></div><div class="ttdeci">int dict_add_number(dict_T *d, char *key, varnumber_T nr)</div><div class="ttdef"><b>Definition:</b> <a href="dict_8c_source.html#l00370">dict.c:370</a></div></div>
<div class="ttc" id="structpointer__block_html"><div class="ttname"><a href="structpointer__block.html">pointer_block</a></div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00090">memline.c:90</a></div></div>
<div class="ttc" id="structfile__buffer_html_af662d458d0ba84aaa073aab5d8354982"><div class="ttname"><a href="structfile__buffer.html#af662d458d0ba84aaa073aab5d8354982">file_buffer::b_p_fenc</a></div><div class="ttdeci">char_u * b_p_fenc</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l02452">structs.h:2452</a></div></div>
<div class="ttc" id="message_8c_html_a0285a0bbcc662afa0db1573dfdde64f1"><div class="ttname"><a href="message_8c.html#a0285a0bbcc662afa0db1573dfdde64f1">msg_puts_attr</a></div><div class="ttdeci">void msg_puts_attr(char *s, int attr)</div><div class="ttdef"><b>Definition:</b> <a href="message_8c_source.html#l01952">message.c:1952</a></div></div>
<div class="ttc" id="struct_gui_html_acc254db2a26171f77d6af6260a39c45d"><div class="ttname"><a href="struct_gui.html#acc254db2a26171f77d6af6260a39c45d">Gui::in_use</a></div><div class="ttdeci">int in_use</div><div class="ttdef"><b>Definition:</b> <a href="gui_8h_source.html#l00259">gui.h:259</a></div></div>
<div class="ttc" id="vim_8h_html_a4e860a79cf758ccaf39278ec2b05b6f6"><div class="ttname"><a href="vim_8h.html#a4e860a79cf758ccaf39278ec2b05b6f6">VV_SWAPNAME</a></div><div class="ttdeci">#define VV_SWAPNAME</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l01946">vim.h:1946</a></div></div>
<div class="ttc" id="memline_8c_html_ae411c532dd4d1d4af9a5dd6b91199086"><div class="ttname"><a href="memline_8c.html#ae411c532dd4d1d4af9a5dd6b91199086">ml_setname</a></div><div class="ttdeci">void ml_setname(buf_T *buf)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00622">memline.c:622</a></div></div>
<div class="ttc" id="vim_8h_html_ac86c7b16baf3bc83bef23b7e5e103ca9"><div class="ttname"><a href="vim_8h.html#ac86c7b16baf3bc83bef23b7e5e103ca9">off_T</a></div><div class="ttdeci">off_t off_T</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l00396">vim.h:396</a></div></div>
<div class="ttc" id="memline_8c_html_a28648170c5d102a305afeeecf23cc0ca"><div class="ttname"><a href="memline_8c.html#a28648170c5d102a305afeeecf23cc0ca">b0_magic_wrong</a></div><div class="ttdeci">static int b0_magic_wrong(ZERO_BL *)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l05111">memline.c:5111</a></div></div>
<div class="ttc" id="memline_8c_html_a4e1fcc872c5dc5b8ec1d1bf7ac298bbe"><div class="ttname"><a href="memline_8c.html#a4e1fcc872c5dc5b8ec1d1bf7ac298bbe">B0_FNAME_SIZE_NOCRYPT</a></div><div class="ttdeci">#define B0_FNAME_SIZE_NOCRYPT</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00134">memline.c:134</a></div></div>
<div class="ttc" id="message_8c_html_a0db479cde321ca12b8d84a53196454ad"><div class="ttname"><a href="message_8c.html#a0db479cde321ca12b8d84a53196454ad">msg_puts</a></div><div class="ttdeci">void msg_puts(char *s)</div><div class="ttdef"><b>Definition:</b> <a href="message_8c_source.html#l01910">message.c:1910</a></div></div>
<div class="ttc" id="memline_8c_html_a94941a018b7ab9e5eebc4f80e957efdb"><div class="ttname"><a href="memline_8c.html#a94941a018b7ab9e5eebc4f80e957efdb">ml_recover</a></div><div class="ttdeci">void ml_recover(int checkext)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l01090">memline.c:1090</a></div></div>
<div class="ttc" id="memline_8c_html_a797a630fa8ec06231624fccc08eb9243"><div class="ttname"><a href="memline_8c.html#a797a630fa8ec06231624fccc08eb9243">ml_get_cursor</a></div><div class="ttdeci">char_u * ml_get_cursor(void)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l02594">memline.c:2594</a></div></div>
<div class="ttc" id="structmemfile_html_a70c16d084045ec45dbe251430e7a81a5"><div class="ttname"><a href="structmemfile.html#a70c16d084045ec45dbe251430e7a81a5">memfile::mf_fd</a></div><div class="ttdeci">int mf_fd</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00643">structs.h:643</a></div></div>
<div class="ttc" id="structfile__buffer_html"><div class="ttname"><a href="structfile__buffer.html">file_buffer</a></div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l02231">structs.h:2231</a></div></div>
<div class="ttc" id="memline_8c_html_aa48861b8abab2c6a9d9c002781df1cfd"><div class="ttname"><a href="memline_8c.html#aa48861b8abab2c6a9d9c002781df1cfd">ML_SIMPLE</a></div><div class="ttdeci">#define ML_SIMPLE(x)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00228">memline.c:228</a></div></div>
<div class="ttc" id="main_8c_html_ac1f9aa0153be96581e7f01eddf1c32e0"><div class="ttname"><a href="main_8c.html#ac1f9aa0153be96581e7f01eddf1c32e0">getout</a></div><div class="ttdeci">void getout(int exitval)</div><div class="ttdef"><b>Definition:</b> <a href="main_8c_source.html#l01549">main.c:1549</a></div></div>
<div class="ttc" id="memline_8c_html_a6456f3ec13f95cc144e0904cf6845bdb"><div class="ttname"><a href="memline_8c.html#a6456f3ec13f95cc144e0904cf6845bdb">ml_preserve</a></div><div class="ttdeci">void ml_preserve(buf_T *buf, int message)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l02483">memline.c:2483</a></div></div>
<div class="ttc" id="autocmd_8c_html_a5e63d49ba2cbcbf49dd45ec521733ad7"><div class="ttname"><a href="autocmd_8c.html#a5e63d49ba2cbcbf49dd45ec521733ad7">has_autocmd</a></div><div class="ttdeci">int has_autocmd(event_T event, char_u *sfname, buf_T *buf)</div><div class="ttdef"><b>Definition:</b> <a href="autocmd_8c_source.html#l02378">autocmd.c:2378</a></div></div>
<div class="ttc" id="gui_8c_html_a46ef8b173034527e996282a23f148dd9"><div class="ttname"><a href="gui_8c.html#a46ef8b173034527e996282a23f148dd9">gui_start</a></div><div class="ttdeci">void gui_start(char_u *arg UNUSED)</div><div class="ttdef"><b>Definition:</b> <a href="gui_8c_source.html#l00071">gui.c:71</a></div></div>
<div class="ttc" id="hangulin_8c_html_a362077c979b0bb65159c603270e40f70"><div class="ttname"><a href="hangulin_8c.html#a362077c979b0bb65159c603270e40f70">f</a></div><div class="ttdeci">static int f</div><div class="ttdef"><b>Definition:</b> <a href="hangulin_8c_source.html#l00032">hangulin.c:32</a></div></div>
<div class="ttc" id="structinfo__pointer_html_a4a99e7d504486b928d73e306227af4a4"><div class="ttname"><a href="structinfo__pointer.html#a4a99e7d504486b928d73e306227af4a4">info_pointer::ip_low</a></div><div class="ttdeci">linenr_T ip_low</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00682">structs.h:682</a></div></div>
<div class="ttc" id="vim_8h_html_a0fc829eaf562a22fd32c5a90c5a942f8aeb83a62b63c4f728519e7c95da168080"><div class="ttname"><a href="vim_8h.html#a0fc829eaf562a22fd32c5a90c5a942f8aeb83a62b63c4f728519e7c95da168080">FLUSH_TYPEAHEAD</a></div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l02115">vim.h:2115</a></div></div>
<div class="ttc" id="memline_8c_html_ab65775db0f7dbf161fce05ee7fb36573"><div class="ttname"><a href="memline_8c.html#ab65775db0f7dbf161fce05ee7fb36573">DB_INDEX_MASK</a></div><div class="ttdeci">#define DB_INDEX_MASK</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00128">memline.c:128</a></div></div>
<div class="ttc" id="os__unix_8h_html_ae70108db942e4f3eeb701ad8787b1835"><div class="ttname"><a href="os__unix_8h.html#ae70108db942e4f3eeb701ad8787b1835">mch_memmove</a></div><div class="ttdeci">#define mch_memmove(to, from, len)</div><div class="ttdef"><b>Definition:</b> <a href="os__unix_8h_source.html#l00434">os_unix.h:434</a></div></div>
<div class="ttc" id="message_8c_html_a9475d91e06c3a6d7d370ef54c0589f71"><div class="ttname"><a href="message_8c.html#a9475d91e06c3a6d7d370ef54c0589f71">smsg</a></div><div class="ttdeci">int smsg(const char *s,...)</div><div class="ttdef"><b>Definition:</b> <a href="message_8c_source.html#l00357">message.c:357</a></div></div>
<div class="ttc" id="misc2_8c_html_ad0b64e14955781629a3908e328f82665"><div class="ttname"><a href="misc2_8c.html#ad0b64e14955781629a3908e328f82665">alloc</a></div><div class="ttdeci">void * alloc(size_t size)</div><div class="ttdef"><b>Definition:</b> <a href="misc2_8c_source.html#l00825">misc2.c:825</a></div></div>
<div class="ttc" id="structblock0_html_a5f6ec025350776e0dbe8d0ab54daadc3"><div class="ttname"><a href="structblock0.html#a5f6ec025350776e0dbe8d0ab54daadc3">block0::b0_version</a></div><div class="ttdeci">char_u b0_version[10]</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00164">memline.c:164</a></div></div>
<div class="ttc" id="misc1_8c_html_aa192be148db96758033a23beacbd8ffe"><div class="ttname"><a href="misc1_8c.html#aa192be148db96758033a23beacbd8ffe">expand_env</a></div><div class="ttdeci">void expand_env(char_u *src, char_u *dst, int dstlen)</div><div class="ttdef"><b>Definition:</b> <a href="misc1_8c_source.html#l01846">misc1.c:1846</a></div></div>
<div class="ttc" id="misc2_8c_html_a4bcab42fe15a545fd147a9c3d03e4354"><div class="ttname"><a href="misc2_8c.html#a4bcab42fe15a545fd147a9c3d03e4354">vim_memsave</a></div><div class="ttdeci">char_u * vim_memsave(char_u *p, size_t len)</div><div class="ttdef"><b>Definition:</b> <a href="misc2_8c_source.html#l01307">misc2.c:1307</a></div></div>
<div class="ttc" id="option_8h_html_a441e114eba9a56d517bbe74d233ec3f9"><div class="ttname"><a href="option_8h.html#a441e114eba9a56d517bbe74d233ec3f9">p_cpo</a></div><div class="ttdeci">EXTERN char_u * p_cpo</div><div class="ttdef"><b>Definition:</b> <a href="option_8h_source.html#l00482">option.h:482</a></div></div>
<div class="ttc" id="mark_8c_html_a70431d6be4f5bdfe83649a25858ea891"><div class="ttname"><a href="mark_8c.html#a70431d6be4f5bdfe83649a25858ea891">setpcmark</a></div><div class="ttdeci">void setpcmark(void)</div><div class="ttdef"><b>Definition:</b> <a href="mark_8c_source.html#l00137">mark.c:137</a></div></div>
<div class="ttc" id="misc2_8c_html_a93b6e3a7993e6c4273dd8ebfea0fdc14"><div class="ttname"><a href="misc2_8c.html#a93b6e3a7993e6c4273dd8ebfea0fdc14">coladvance</a></div><div class="ttdeci">int coladvance(colnr_T wcol)</div><div class="ttdef"><b>Definition:</b> <a href="misc2_8c_source.html#l00094">misc2.c:94</a></div></div>
<div class="ttc" id="globals_8h_html_a337deb9cd3b0e40e369a0618282ed5a7"><div class="ttname"><a href="globals_8h.html#a337deb9cd3b0e40e369a0618282ed5a7">NameBuff</a></div><div class="ttdeci">EXTERN char_u * NameBuff</div><div class="ttdef"><b>Definition:</b> <a href="globals_8h_source.html#l01048">globals.h:1048</a></div></div>
<div class="ttc" id="textprop_8c_html_a2ff749473010c82045a3dde52a9206bc"><div class="ttname"><a href="textprop_8c.html#a2ff749473010c82045a3dde52a9206bc">get_text_props</a></div><div class="ttdeci">int get_text_props(buf_T *buf, linenr_T lnum, char_u **props, int will_change)</div><div class="ttdef"><b>Definition:</b> <a href="textprop_8c_source.html#l00359">textprop.c:359</a></div></div>
<div class="ttc" id="macros_8h_html_af9221f9667cc05a05b4646b2aa31e233"><div class="ttname"><a href="macros_8h.html#af9221f9667cc05a05b4646b2aa31e233">mch_stat</a></div><div class="ttdeci">#define mch_stat(n, p)</div><div class="ttdef"><b>Definition:</b> <a href="macros_8h_source.html#l00173">macros.h:173</a></div></div>
<div class="ttc" id="memfile_8c_html_a6f855db0909de20a82fcd3ed904cfe37"><div class="ttname"><a href="memfile_8c.html#a6f855db0909de20a82fcd3ed904cfe37">mf_open_file</a></div><div class="ttdeci">int mf_open_file(memfile_T *mfp, char_u *fname)</div><div class="ttdef"><b>Definition:</b> <a href="memfile_8c_source.html#l00224">memfile.c:224</a></div></div>
<div class="ttc" id="option_8c_html_a94ae863d1c8638bea649c9a093c2be06"><div class="ttname"><a href="option_8c.html#a94ae863d1c8638bea649c9a093c2be06">set_option_value</a></div><div class="ttdeci">char * set_option_value(char_u *name, long number, char_u *string, int opt_flags)</div><div class="ttdef"><b>Definition:</b> <a href="option_8c_source.html#l04321">option.c:4321</a></div></div>
<div class="ttc" id="spell_8c_html_a7ed01e093616f319cf06098f7796c35b"><div class="ttname"><a href="spell_8c.html#a7ed01e093616f319cf06098f7796c35b">spell_delete_wordlist</a></div><div class="ttdeci">void spell_delete_wordlist(void)</div><div class="ttdef"><b>Definition:</b> <a href="spell_8c_source.html#l02404">spell.c:2404</a></div></div>
<div class="ttc" id="memline_8c_html_a6dd3bce99cbc1af9f7cfd6c843c5b44d"><div class="ttname"><a href="memline_8c.html#a6dd3bce99cbc1af9f7cfd6c843c5b44d">ml_append</a></div><div class="ttdeci">int ml_append(linenr_T lnum, char_u *line, colnr_T len, int newfile)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l03328">memline.c:3328</a></div></div>
<div class="ttc" id="memline_8c_html_af1fa068c71604df99341775f25824fdd"><div class="ttname"><a href="memline_8c.html#af1fa068c71604df99341775f25824fdd">ml_set_b0_crypt</a></div><div class="ttdeci">static void ml_set_b0_crypt(buf_T *buf, ZERO_BL *b0p)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00442">memline.c:442</a></div></div>
<div class="ttc" id="structpointer__entry_html_a652fe117ed91b4ab3d84361e8aa751de"><div class="ttname"><a href="structpointer__entry.html#a652fe117ed91b4ab3d84361e8aa751de">pointer_entry::pe_line_count</a></div><div class="ttdeci">linenr_T pe_line_count</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00082">memline.c:82</a></div></div>
<div class="ttc" id="misc2_8c_html_a32cb7ab620bf087189a26e93f219d5e7"><div class="ttname"><a href="misc2_8c.html#a32cb7ab620bf087189a26e93f219d5e7">set_fileformat</a></div><div class="ttdeci">void set_fileformat(int t, int opt_flags)</div><div class="ttdef"><b>Definition:</b> <a href="misc2_8c_source.html#l03063">misc2.c:3063</a></div></div>
<div class="ttc" id="structdata__block_html_a6cd7e5186f74ae199fe547bc905b2815"><div class="ttname"><a href="structdata__block.html#a6cd7e5186f74ae199fe547bc905b2815">data_block::db_free</a></div><div class="ttdeci">unsigned db_free</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00109">memline.c:109</a></div></div>
<div class="ttc" id="structpos___t_html_abff612ea21a47084625b593756153b3e"><div class="ttname"><a href="structpos___t.html#abff612ea21a47084625b593756153b3e">pos_T::lnum</a></div><div class="ttdeci">linenr_T lnum</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00028">structs.h:28</a></div></div>
<div class="ttc" id="structmemline_html_a30f30ddb7264f667a92556f0568981e0"><div class="ttname"><a href="structmemline.html#a30f30ddb7264f667a92556f0568981e0">memline::ml_flags</a></div><div class="ttdeci">int ml_flags</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00715">structs.h:715</a></div></div>
<div class="ttc" id="memfile_8c_html_a6383b438b81a79c3c4e3a8c57c6babbb"><div class="ttname"><a href="memfile_8c.html#a6383b438b81a79c3c4e3a8c57c6babbb">mf_close_file</a></div><div class="ttdeci">void mf_close_file(buf_T *buf, int getlines)</div><div class="ttdef"><b>Definition:</b> <a href="memfile_8c_source.html#l00272">memfile.c:272</a></div></div>
<div class="ttc" id="memline_8c_html_acc61471b08b25bb0399df73b144176c5"><div class="ttname"><a href="memline_8c.html#acc61471b08b25bb0399df73b144176c5">BLOCK0_ID1_C2</a></div><div class="ttdeci">#define BLOCK0_ID1_C2</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00066">memline.c:66</a></div></div>
<div class="ttc" id="misc2_8c_html_a767812b118182564891e6c771b3a0da0"><div class="ttname"><a href="misc2_8c.html#a767812b118182564891e6c771b3a0da0">get_fileformat</a></div><div class="ttdeci">int get_fileformat(buf_T *buf)</div><div class="ttdef"><b>Definition:</b> <a href="misc2_8c_source.html#l03019">misc2.c:3019</a></div></div>
<div class="ttc" id="structs_8h_html_a5c7e944c137636434555c8a7f0cfcd77"><div class="ttname"><a href="structs_8h.html#a5c7e944c137636434555c8a7f0cfcd77">textprop_T</a></div><div class="ttdeci">struct textprop_S textprop_T</div></div>
<div class="ttc" id="globals_8h_html_a690495c80458a3a89c4bdcea2ec4258c"><div class="ttname"><a href="globals_8h.html#a690495c80458a3a89c4bdcea2ec4258c">IObuff</a></div><div class="ttdeci">EXTERN char_u * IObuff</div><div class="ttdef"><b>Definition:</b> <a href="globals_8h_source.html#l01046">globals.h:1046</a></div></div>
<div class="ttc" id="dosinst_8h_html_aba51915c87d64af47fb1cc59348961c9"><div class="ttname"><a href="dosinst_8h.html#aba51915c87d64af47fb1cc59348961c9">OK</a></div><div class="ttdeci">#define OK</div><div class="ttdef"><b>Definition:</b> <a href="dosinst_8h_source.html#l00062">dosinst.h:62</a></div></div>
<div class="ttc" id="structfile__buffer_html_aee73f43424bc86e09983b73d139589f3"><div class="ttname"><a href="structfile__buffer.html#aee73f43424bc86e09983b73d139589f3">file_buffer::b_ml</a></div><div class="ttdeci">memline_T b_ml</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l02233">structs.h:2233</a></div></div>
<div class="ttc" id="structmemline_html_a97f953057f1eaa0360502866f1e54964"><div class="ttname"><a href="structmemline.html#a97f953057f1eaa0360502866f1e54964">memline::ml_locked_lineadd</a></div><div class="ttdeci">int ml_locked_lineadd</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00728">structs.h:728</a></div></div>
<div class="ttc" id="crypt_8c_html_aa2bf8415cdc130f597de3e938d0a585d"><div class="ttname"><a href="crypt_8c.html#aa2bf8415cdc130f597de3e938d0a585d">crypt_set_cm_option</a></div><div class="ttdeci">void crypt_set_cm_option(buf_T *buf, int method_nr)</div><div class="ttdef"><b>Definition:</b> <a href="crypt_8c_source.html#l00224">crypt.c:224</a></div></div>
<div class="ttc" id="memline_8c_html_a23d0125357ec4465a50f841f634c9214"><div class="ttname"><a href="memline_8c.html#a23d0125357ec4465a50f841f634c9214">PTR_ID</a></div><div class="ttdeci">#define PTR_ID</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00061">memline.c:61</a></div></div>
<div class="ttc" id="vim_8h_html_aa0c7b8582b88ec89a7b4a058f63d68ac"><div class="ttname"><a href="vim_8h.html#aa0c7b8582b88ec89a7b4a058f63d68ac">SEA_RECOVER</a></div><div class="ttdeci">#define SEA_RECOVER</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l01234">vim.h:1234</a></div></div>
<div class="ttc" id="vim_8h_html_a5f1ef744c34be69aec1531f1fe604a9b"><div class="ttname"><a href="vim_8h.html#a5f1ef744c34be69aec1531f1fe604a9b">STRNCMP</a></div><div class="ttdeci">#define STRNCMP(d, s, n)</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l01593">vim.h:1593</a></div></div>
<div class="ttc" id="namespacetest__channel__pipe_html_a026d4aa94ac7d2d0cecce075c3648c14"><div class="ttname"><a href="namespacetest__channel__pipe.html#a026d4aa94ac7d2d0cecce075c3648c14">test_channel_pipe.end</a></div><div class="ttdeci">end</div><div class="ttdef"><b>Definition:</b> <a href="test__channel__pipe_8py_source.html#l00018">test_channel_pipe.py:18</a></div></div>
<div class="ttc" id="structs_8h_html_a075028952f49cbfea4c573330b75139a"><div class="ttname"><a href="structs_8h.html#a075028952f49cbfea4c573330b75139a">B_SPELL</a></div><div class="ttdeci">#define B_SPELL(buf)</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l02066">structs.h:2066</a></div></div>
<div class="ttc" id="structs_8h_html_a8fac7ceea6e156c2915cdcf7e228a9f8"><div class="ttname"><a href="structs_8h.html#a8fac7ceea6e156c2915cdcf7e228a9f8">ML_LINE_DIRTY</a></div><div class="ttdeci">#define ML_LINE_DIRTY</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00712">structs.h:712</a></div></div>
<div class="ttc" id="filepath_8c_html_a8de478b7b0307fbc7b4aab47648ecb0c"><div class="ttname"><a href="filepath_8c.html#a8de478b7b0307fbc7b4aab47648ecb0c">concat_fnames</a></div><div class="ttdeci">char_u * concat_fnames(char_u *fname1, char_u *fname2, int sep)</div><div class="ttdef"><b>Definition:</b> <a href="filepath_8c_source.html#l02635">filepath.c:2635</a></div></div>
<div class="ttc" id="memline_8c_html_a623f9a9406aa91cbaca6461d1ccc6804"><div class="ttname"><a href="memline_8c.html#a623f9a9406aa91cbaca6461d1ccc6804">add_b0_fenc</a></div><div class="ttdeci">static void add_b0_fenc(ZERO_BL *b0p, buf_T *buf)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l01056">memline.c:1056</a></div></div>
<div class="ttc" id="fileio_8c_html_a0bc0ace50d9cb272c0ed6810a74b2d0d"><div class="ttname"><a href="fileio_8c.html#a0bc0ace50d9cb272c0ed6810a74b2d0d">vim_rename</a></div><div class="ttdeci">int vim_rename(char_u *from, char_u *to)</div><div class="ttdef"><b>Definition:</b> <a href="fileio_8c_source.html#l03619">fileio.c:3619</a></div></div>
<div class="ttc" id="structmemline_html_aa4c2830f305306d4f5f163b4522d0ba6"><div class="ttname"><a href="structmemline.html#aa4c2830f305306d4f5f163b4522d0ba6">memline::ml_locked</a></div><div class="ttdeci">bhdr_T * ml_locked</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00725">structs.h:725</a></div></div>
<div class="ttc" id="memline_8c_html_a89ca94197abc00b6c372ff0a72b4a091"><div class="ttname"><a href="memline_8c.html#a89ca94197abc00b6c372ff0a72b4a091">ML_FLUSH</a></div><div class="ttdeci">#define ML_FLUSH</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00227">memline.c:227</a></div></div>
<div class="ttc" id="memline_8c_html_aab71d171eeeefa498adf1f5f725cd010"><div class="ttname"><a href="memline_8c.html#aab71d171eeeefa498adf1f5f725cd010">B0_HNAME_SIZE</a></div><div class="ttdeci">#define B0_HNAME_SIZE</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00137">memline.c:137</a></div></div>
<div class="ttc" id="structmemline_html_a81788089e53748eb945a88d6e41647da"><div class="ttname"><a href="structmemline.html#a81788089e53748eb945a88d6e41647da">memline::ml_locked_high</a></div><div class="ttdeci">linenr_T ml_locked_high</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00727">structs.h:727</a></div></div>
<div class="ttc" id="message_8c_html_a701ffeff793261a605a4090e7c085a2d"><div class="ttname"><a href="message_8c.html#a701ffeff793261a605a4090e7c085a2d">msg_start</a></div><div class="ttdeci">void msg_start(void)</div><div class="ttdef"><b>Definition:</b> <a href="message_8c_source.html#l01303">message.c:1303</a></div></div>
<div class="ttc" id="option_8h_html_a8668e2dd511003c9ad5a9032c1a17c3e"><div class="ttname"><a href="option_8h.html#a8668e2dd511003c9ad5a9032c1a17c3e">p_dir</a></div><div class="ttdeci">EXTERN char_u * p_dir</div><div class="ttdef"><b>Definition:</b> <a href="option_8h_source.html#l00511">option.h:511</a></div></div>
<div class="ttc" id="structmemline_html_add4fba4ecd680fbf53ab842c85ccde21"><div class="ttname"><a href="structmemline.html#add4fba4ecd680fbf53ab842c85ccde21">memline::ml_stack_size</a></div><div class="ttdeci">int ml_stack_size</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00719">structs.h:719</a></div></div>
<div class="ttc" id="memline_8c_html_a231a2b743bdebbc1d61725a392830eff"><div class="ttname"><a href="memline_8c.html#a231a2b743bdebbc1d61725a392830eff">long_to_char</a></div><div class="ttdeci">static void long_to_char(long, char_u *)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l05224">memline.c:5224</a></div></div>
<div class="ttc" id="os__mac_8h_html_a283d38eb9b5da9a7092ee0954d4e5a14"><div class="ttname"><a href="os__mac_8h.html#a283d38eb9b5da9a7092ee0954d4e5a14">mch_getenv</a></div><div class="ttdeci">#define mch_getenv(x)</div><div class="ttdef"><b>Definition:</b> <a href="os__mac_8h_source.html#l00244">os_mac.h:244</a></div></div>
<div class="ttc" id="structwindow___s_html_a835020a5ed8c78ed5c652cdb8052e785"><div class="ttname"><a href="structwindow___s.html#a835020a5ed8c78ed5c652cdb8052e785">window_S::w_curswant</a></div><div class="ttdeci">colnr_T w_curswant</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l02965">structs.h:2965</a></div></div>
<div class="ttc" id="filepath_8c_html_a52fbff29815a2232d884304f4dce5fef"><div class="ttname"><a href="filepath_8c.html#a52fbff29815a2232d884304f4dce5fef">vim_FullName</a></div><div class="ttdeci">int vim_FullName(char_u *fname, char_u *buf, int len, int force)</div><div class="ttdef"><b>Definition:</b> <a href="filepath_8c_source.html#l03811">filepath.c:3811</a></div></div>
<div class="ttc" id="memline_8c_html_a03d439d0a90af7064a71e4103b0a5b9f"><div class="ttname"><a href="memline_8c.html#a03d439d0a90af7064a71e4103b0a5b9f">ml_close_all</a></div><div class="ttdeci">void ml_close_all(int del_file)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00865">memline.c:865</a></div></div>
<div class="ttc" id="memline_8c_html_a945648d1f1ffc6e2ef410316ecdec777"><div class="ttname"><a href="memline_8c.html#a945648d1f1ffc6e2ef410316ecdec777">ml_open_files</a></div><div class="ttdeci">void ml_open_files(void)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00729">memline.c:729</a></div></div>
<div class="ttc" id="os__win32_8c_html_af1ef6cc4b2e3b02554529c108268ff5d"><div class="ttname"><a href="os__win32_8c.html#af1ef6cc4b2e3b02554529c108268ff5d">mch_fopen</a></div><div class="ttdeci">FILE * mch_fopen(const char *name, const char *mode)</div><div class="ttdef"><b>Definition:</b> <a href="os__win32_8c_source.html#l06733">os_win32.c:6733</a></div></div>
<div class="ttc" id="misc2_8c_html_a4b4777924352aae7456002f6d9438ffd"><div class="ttname"><a href="misc2_8c.html#a4b4777924352aae7456002f6d9438ffd">vim_free</a></div><div class="ttdeci">void vim_free(void *x)</div><div class="ttdef"><b>Definition:</b> <a href="misc2_8c_source.html#l01795">misc2.c:1795</a></div></div>
<div class="ttc" id="macros_8h_html_a06cefeb085cb44bd960567445ae3766a"><div class="ttname"><a href="macros_8h.html#a06cefeb085cb44bd960567445ae3766a">mch_open_rw</a></div><div class="ttdeci">#define mch_open_rw(n, f)</div><div class="ttdef"><b>Definition:</b> <a href="macros_8h_source.html#l00200">macros.h:200</a></div></div>
<div class="ttc" id="structpointer__block_html_ac2698ad2c9c4096299106a53ffbd667f"><div class="ttname"><a href="structpointer__block.html#ac2698ad2c9c4096299106a53ffbd667f">pointer_block::pb_id</a></div><div class="ttdeci">short_u pb_id</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00092">memline.c:92</a></div></div>
<div class="ttc" id="misc2_8c_html_a2c53531dd0451dcef1ae39403b49ee67"><div class="ttname"><a href="misc2_8c.html#a2c53531dd0451dcef1ae39403b49ee67">copy_option_part</a></div><div class="ttdeci">int copy_option_part(char_u **option, char_u *buf, int maxlen, char *sep_chars)</div><div class="ttdef"><b>Definition:</b> <a href="misc2_8c_source.html#l01754">misc2.c:1754</a></div></div>
<div class="ttc" id="memfile_8c_html_a69265c5b601f69e279b2bad593613e18"><div class="ttname"><a href="memfile_8c.html#a69265c5b601f69e279b2bad593613e18">mf_free</a></div><div class="ttdeci">void mf_free(memfile_T *mfp, bhdr_T *hp)</div><div class="ttdef"><b>Definition:</b> <a href="memfile_8c_source.html#l00499">memfile.c:499</a></div></div>
<div class="ttc" id="memline_8c_html_a996b07c0a0e4f04f7b205f4c3ba2a797"><div class="ttname"><a href="memline_8c.html#a996b07c0a0e4f04f7b205f4c3ba2a797">char_to_long</a></div><div class="ttdeci">static long char_to_long(char_u *)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l05236">memline.c:5236</a></div></div>
<div class="ttc" id="memline_8c_html_a33bdc994ac7c8cda7d0df1a3369ab965"><div class="ttname"><a href="memline_8c.html#a33bdc994ac7c8cda7d0df1a3369ab965">INDEX_SIZE</a></div><div class="ttdeci">#define INDEX_SIZE</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00130">memline.c:130</a></div></div>
<div class="ttc" id="misc2_8c_html_a871ddb65e41d8bed1c38754d59737a5b"><div class="ttname"><a href="misc2_8c.html#a871ddb65e41d8bed1c38754d59737a5b">vim_strnsave</a></div><div class="ttdeci">char_u * vim_strnsave(char_u *string, int len)</div><div class="ttdef"><b>Definition:</b> <a href="misc2_8c_source.html#l01289">misc2.c:1289</a></div></div>
<div class="ttc" id="structfile__buffer_html_acbc008d53044334116941e49fe076450"><div class="ttname"><a href="structfile__buffer.html#acbc008d53044334116941e49fe076450">file_buffer::b_mtime_read</a></div><div class="ttdeci">long b_mtime_read</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l02305">structs.h:2305</a></div></div>
<div class="ttc" id="memline_8c_html_ab34eb7413d943026a67ef3580359d115"><div class="ttname"><a href="memline_8c.html#ab34eb7413d943026a67ef3580359d115">ml_replace_len</a></div><div class="ttdeci">int ml_replace_len(linenr_T lnum, char_u *line_arg, colnr_T len_arg, int has_props, int copy)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l03387">memline.c:3387</a></div></div>
<div class="ttc" id="vim_8h_html_a916ffefe1fc74532d08102cca55d8e34"><div class="ttname"><a href="vim_8h.html#a916ffefe1fc74532d08102cca55d8e34">STRLEN</a></div><div class="ttdeci">#define STRLEN(s)</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l01589">vim.h:1589</a></div></div>
<div class="ttc" id="memline_8c_html_a7ad45b164548ce5af4a97bbc5c249410"><div class="ttname"><a href="memline_8c.html#a7ad45b164548ce5af4a97bbc5c249410">B0_HAS_FENC</a></div><div class="ttdeci">#define B0_HAS_FENC</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00209">memline.c:209</a></div></div>
<div class="ttc" id="namespacemodule_html_a2bbb1992c2d099148f717cbd67c51561"><div class="ttname"><a href="namespacemodule.html#a2bbb1992c2d099148f717cbd67c51561">module.dir</a></div><div class="ttdeci">string dir</div><div class="ttdef"><b>Definition:</b> <a href="python2_2module_8py_source.html#l00002">module.py:2</a></div></div>
<div class="ttc" id="crypt_8c_html_a48a8e10523a0d4037893a3013af26eee"><div class="ttname"><a href="crypt_8c.html#a48a8e10523a0d4037893a3013af26eee">crypt_method_nr_from_name</a></div><div class="ttdeci">int crypt_method_nr_from_name(char_u *name)</div><div class="ttdef"><b>Definition:</b> <a href="crypt_8c_source.html#l00144">crypt.c:144</a></div></div>
<div class="ttc" id="memline_8c_html_a194d4d2869af81a9b1007ec53994e435"><div class="ttname"><a href="memline_8c.html#a194d4d2869af81a9b1007ec53994e435">ml_decrypt_data</a></div><div class="ttdeci">void ml_decrypt_data(memfile_T *mfp, char_u *data, off_T offset, unsigned size)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l05333">memline.c:5333</a></div></div>
<div class="ttc" id="structs_8h_html_a012394c4a7db63f99f6f0cdacab79527"><div class="ttname"><a href="structs_8h.html#a012394c4a7db63f99f6f0cdacab79527">blocknr_T</a></div><div class="ttdeci">long blocknr_T</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00445">structs.h:445</a></div></div>
<div class="ttc" id="optionstr_8c_html_aeb9d6480a68bfee6052f8e8afc8eda94"><div class="ttname"><a href="optionstr_8c.html#aeb9d6480a68bfee6052f8e8afc8eda94">free_string_option</a></div><div class="ttdeci">void free_string_option(char_u *p)</div><div class="ttdef"><b>Definition:</b> <a href="optionstr_8c_source.html#l00304">optionstr.c:304</a></div></div>
<div class="ttc" id="vim_8h_html_aa7847d468c459f481f1bfc3b82526b20"><div class="ttname"><a href="vim_8h.html#aa7847d468c459f481f1bfc3b82526b20">ALLOC_ONE</a></div><div class="ttdeci">#define ALLOC_ONE(type)</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l01577">vim.h:1577</a></div></div>
<div class="ttc" id="vim_8h_html_a6a0317d31611db43900c317059656a22"><div class="ttname"><a href="vim_8h.html#a6a0317d31611db43900c317059656a22">EW_NOTENV</a></div><div class="ttdeci">#define EW_NOTENV</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l00837">vim.h:837</a></div></div>
<div class="ttc" id="memline_8c_html_a5efa31d210327048f60b8b00586e2a8c"><div class="ttname"><a href="memline_8c.html#a5efa31d210327048f60b8b00586e2a8c">ml_get_buf</a></div><div class="ttdeci">char_u * ml_get_buf(buf_T *buf, linenr_T lnum, int will_change)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l02607">memline.c:2607</a></div></div>
<div class="ttc" id="vim_8h_html_a6af93ccdb5accc84d8a7f92255b90367"><div class="ttname"><a href="vim_8h.html#a6af93ccdb5accc84d8a7f92255b90367">NOTDONE</a></div><div class="ttdeci">#define NOTDONE</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l00713">vim.h:713</a></div></div>
<div class="ttc" id="memline_8c_html_a4ecf812828065a7ac0dccbe3e4661de9"><div class="ttname"><a href="memline_8c.html#a4ecf812828065a7ac0dccbe3e4661de9">B0_FNAME_SIZE_CRYPT</a></div><div class="ttdeci">#define B0_FNAME_SIZE_CRYPT</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00135">memline.c:135</a></div></div>
<div class="ttc" id="memline_8c_html_a6767d25cbd7796ae962252124f65a557"><div class="ttname"><a href="memline_8c.html#a6767d25cbd7796ae962252124f65a557">swapfile_unchanged</a></div><div class="ttdeci">static time_t swapfile_unchanged(char_u *fname)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l02288">memline.c:2288</a></div></div>
<div class="ttc" id="os__unix_8c_html_a5ff2a30d1d4cb47d29819f18f843804a"><div class="ttname"><a href="os__unix_8c.html#a5ff2a30d1d4cb47d29819f18f843804a">mch_process_running</a></div><div class="ttdeci">int mch_process_running(long pid)</div><div class="ttdef"><b>Definition:</b> <a href="os__unix_8c_source.html#l02428">os_unix.c:2428</a></div></div>
<div class="ttc" id="memline_8c_html_abed76281f9b8f3fe0572784ba8aaa040"><div class="ttname"><a href="memline_8c.html#abed76281f9b8f3fe0572784ba8aaa040">ml_append_int</a></div><div class="ttdeci">static int ml_append_int(buf_T *buf, linenr_T lnum, char_u *line_arg, colnr_T len_arg, int newfile, int mark)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l02766">memline.c:2766</a></div></div>
<div class="ttc" id="structblock0_html_a677366d05c5a282aa489272ca0fa0b1d"><div class="ttname"><a href="structblock0.html#a677366d05c5a282aa489272ca0fa0b1d">block0::b0_magic_short</a></div><div class="ttdeci">short b0_magic_short</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00174">memline.c:174</a></div></div>
<div class="ttc" id="message_8c_html_a2c7987897b6324574dba24fdfa9cc940"><div class="ttname"><a href="message_8c.html#a2c7987897b6324574dba24fdfa9cc940">do_dialog</a></div><div class="ttdeci">int do_dialog(int type UNUSED, char_u *title UNUSED, char_u *message, char_u *buttons, int dfltbutton, char_u *textfield UNUSED, int ex_cmd)</div><div class="ttdef"><b>Definition:</b> <a href="message_8c_source.html#l03558">message.c:3558</a></div></div>
<div class="ttc" id="misc2_8c_html_a94e32797eb3ef299b193daf4c7974c56"><div class="ttname"><a href="misc2_8c.html#a94e32797eb3ef299b193daf4c7974c56">check_cursor</a></div><div class="ttdeci">void check_cursor(void)</div><div class="ttdef"><b>Definition:</b> <a href="misc2_8c_source.html#l00613">misc2.c:613</a></div></div>
<div class="ttc" id="structdata__block_html_ae079e3993bfc47bd86fd6e2fc3ab44ba"><div class="ttname"><a href="structdata__block.html#ae079e3993bfc47bd86fd6e2fc3ab44ba">data_block::db_txt_end</a></div><div class="ttdeci">unsigned db_txt_end</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00111">memline.c:111</a></div></div>
<div class="ttc" id="memline_8c_html_a7c54be0e5b07e1fe53155d1174a746e8"><div class="ttname"><a href="memline_8c.html#a7c54be0e5b07e1fe53155d1174a746e8">ml_check_b0_id</a></div><div class="ttdeci">static int ml_check_b0_id(ZERO_BL *b0p)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00908">memline.c:908</a></div></div>
<div class="ttc" id="message_8c_html_a273e1e1a7e5b9b70db0a55edb73e303d"><div class="ttname"><a href="message_8c.html#a273e1e1a7e5b9b70db0a55edb73e303d">msg_outtrans</a></div><div class="ttdeci">int msg_outtrans(char_u *str)</div><div class="ttdef"><b>Definition:</b> <a href="message_8c_source.html#l01423">message.c:1423</a></div></div>
<div class="ttc" id="memline_8c_html_adcf872c959d4e670fd729383dec62a81"><div class="ttname"><a href="memline_8c.html#adcf872c959d4e670fd729383dec62a81">ml_open</a></div><div class="ttdeci">int ml_open(buf_T *buf)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00273">memline.c:273</a></div></div>
<div class="ttc" id="memline_8c_html_a56fd6f4544b4cd78e033dc86549c4d42"><div class="ttname"><a href="memline_8c.html#a56fd6f4544b4cd78e033dc86549c4d42">MLCS_MAXL</a></div><div class="ttdeci">#define MLCS_MAXL</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l05414">memline.c:5414</a></div></div>
<div class="ttc" id="option_8h_html_ab9d1347f05d6fab96b4ebba410df10f6"><div class="ttname"><a href="option_8h.html#ab9d1347f05d6fab96b4ebba410df10f6">p_uc</a></div><div class="ttdeci">EXTERN long p_uc</div><div class="ttdef"><b>Definition:</b> <a href="option_8h_source.html#l01000">option.h:1000</a></div></div>
<div class="ttc" id="misc1_8c_html_a8703516dc56663f759f265915d1acc2d"><div class="ttname"><a href="misc1_8c.html#a8703516dc56663f759f265915d1acc2d">line_breakcheck</a></div><div class="ttdeci">void line_breakcheck(void)</div><div class="ttdef"><b>Definition:</b> <a href="misc1_8c_source.html#l02727">misc1.c:2727</a></div></div>
<div class="ttc" id="structfile__buffer_html_aff82f135569f4a0edd666fe08d0ca970"><div class="ttname"><a href="structfile__buffer.html#aff82f135569f4a0edd666fe08d0ca970">file_buffer::b_mtime</a></div><div class="ttdeci">long b_mtime</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l02304">structs.h:2304</a></div></div>
<div class="ttc" id="vim_8h_html_af67ce53b835b6cd1005e9a7a0ffcfc60af020795535ec4b31fb1605eb8f457bbd"><div class="ttname"><a href="vim_8h.html#af67ce53b835b6cd1005e9a7a0ffcfc60af020795535ec4b31fb1605eb8f457bbd">HLF_E</a></div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l01378">vim.h:1378</a></div></div>
<div class="ttc" id="memline_8c_html_ac1a4fef0800b7b4b84340a09cbaf7d1b"><div class="ttname"><a href="memline_8c.html#ac1a4fef0800b7b4b84340a09cbaf7d1b">ml_line_alloced</a></div><div class="ttdeci">int ml_line_alloced(void)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l02700">memline.c:2700</a></div></div>
<div class="ttc" id="vim_8h_html_aa97249d6f36568a65ef1b11aa3db1aa2"><div class="ttname"><a href="vim_8h.html#aa97249d6f36568a65ef1b11aa3db1aa2">EW_FILE</a></div><div class="ttdeci">#define EW_FILE</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l00819">vim.h:819</a></div></div>
<div class="ttc" id="crypt_8c_html_a46d56559b44b02d2e5746b424b3220c2"><div class="ttname"><a href="crypt_8c.html#a46d56559b44b02d2e5746b424b3220c2">crypt_get_key</a></div><div class="ttdeci">char_u * crypt_get_key(int store, int twice)</div><div class="ttdef"><b>Definition:</b> <a href="crypt_8c_source.html#l00543">crypt.c:543</a></div></div>
<div class="ttc" id="vim_8h_html_ac3285f1441f208573c7f11b460ef2a79"><div class="ttname"><a href="vim_8h.html#ac3285f1441f208573c7f11b460ef2a79">SEA_QUIT</a></div><div class="ttdeci">#define SEA_QUIT</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l01233">vim.h:1233</a></div></div>
<div class="ttc" id="message_8c_html_a9495c4f4da600498d1482fb292c4c97b"><div class="ttname"><a href="message_8c.html#a9495c4f4da600498d1482fb292c4c97b">msg_outnum</a></div><div class="ttdeci">void msg_outnum(long n)</div><div class="ttdef"><b>Definition:</b> <a href="message_8c_source.html#l01383">message.c:1383</a></div></div>
<div class="ttc" id="structpointer__entry_html"><div class="ttname"><a href="structpointer__entry.html">pointer_entry</a></div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00079">memline.c:79</a></div></div>
<div class="ttc" id="structfile__buffer_html_abb16d33dacca0e4480aadc94210001b2"><div class="ttname"><a href="structfile__buffer.html#abb16d33dacca0e4480aadc94210001b2">file_buffer::b_p_bin</a></div><div class="ttdeci">int b_p_bin</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l02414">structs.h:2414</a></div></div>
<div class="ttc" id="memline_8c_html_aecc37d45b88243de16ab309ec9a82f90"><div class="ttname"><a href="memline_8c.html#aecc37d45b88243de16ab309ec9a82f90">ml_encrypt_data</a></div><div class="ttdeci">char_u * ml_encrypt_data(memfile_T *mfp, char_u *data, off_T offset, unsigned size)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l05288">memline.c:5288</a></div></div>
<div class="ttc" id="vim_8h_html_af188d12f92536bcde1def3ec5c00e020"><div class="ttname"><a href="vim_8h.html#af188d12f92536bcde1def3ec5c00e020">short_u</a></div><div class="ttdeci">unsigned short short_u</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l00327">vim.h:327</a></div></div>
<div class="ttc" id="structdata__block_html"><div class="ttname"><a href="structdata__block.html">data_block</a></div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00106">memline.c:106</a></div></div>
<div class="ttc" id="harness_8c_html_a3dca7dbebd89d0468bf40da6281614c8"><div class="ttname"><a href="harness_8c.html#a3dca7dbebd89d0468bf40da6281614c8">state</a></div><div class="ttdeci">static VTermState * state</div><div class="ttdef"><b>Definition:</b> <a href="harness_8c_source.html#l00063">harness.c:63</a></div></div>
<div class="ttc" id="memline_8c_html_ad89ac1988c4af53392f905876e770508"><div class="ttname"><a href="memline_8c.html#ad89ac1988c4af53392f905876e770508">set_b0_dir_flag</a></div><div class="ttdeci">static void set_b0_dir_flag(ZERO_BL *b0p, buf_T *buf)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l01044">memline.c:1044</a></div></div>
<div class="ttc" id="change_8c_html_aab9ddb1537af1a660acc9e409537938f"><div class="ttname"><a href="change_8c.html#aab9ddb1537af1a660acc9e409537938f">unchanged</a></div><div class="ttdeci">void unchanged(buf_T *buf, int ff, int always_inc_changedtick)</div><div class="ttdef"><b>Definition:</b> <a href="change_8c_source.html#l00843">change.c:843</a></div></div>
<div class="ttc" id="structblock0_html"><div class="ttname"><a href="structblock0.html">block0</a></div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00160">memline.c:160</a></div></div>
<div class="ttc" id="structfile__buffer_html_a18b9a8836718e7f4f791c80a6d28bd9b"><div class="ttname"><a href="structfile__buffer.html#a18b9a8836718e7f4f791c80a6d28bd9b">file_buffer::b_may_swap</a></div><div class="ttdeci">int b_may_swap</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l02632">structs.h:2632</a></div></div>
<div class="ttc" id="vim_8h_html_ae8a70272e3860382f6585ba9c49c1c0d"><div class="ttname"><a href="vim_8h.html#ae8a70272e3860382f6585ba9c49c1c0d">VV_SWAPCHOICE</a></div><div class="ttdeci">#define VV_SWAPCHOICE</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l01947">vim.h:1947</a></div></div>
<div class="ttc" id="structfile__buffer_html_aa4b0a02270ec71cb25dbcb319d5e97b9"><div class="ttname"><a href="structfile__buffer.html#aa4b0a02270ec71cb25dbcb319d5e97b9">file_buffer::b_changed</a></div><div class="ttdeci">int b_changed</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l02275">structs.h:2275</a></div></div>
<div class="ttc" id="winclip_8c_html_a559cf9d839c9be3c74d618cb6bf35c6c"><div class="ttname"><a href="winclip_8c.html#a559cf9d839c9be3c74d618cb6bf35c6c">acp_to_enc</a></div><div class="ttdeci">void acp_to_enc(char_u *str, int str_size, char_u **out, int *outlen)</div><div class="ttdef"><b>Definition:</b> <a href="winclip_8c_source.html#l00736">winclip.c:736</a></div></div>
<div class="ttc" id="globals_8h_html_a1440aee39ae90077fff5aeb23c8a3764"><div class="ttname"><a href="globals_8h.html#a1440aee39ae90077fff5aeb23c8a3764">curwin</a></div><div class="ttdeci">EXTERN win_T * curwin</div><div class="ttdef"><b>Definition:</b> <a href="globals_8h_source.html#l00640">globals.h:640</a></div></div>
<div class="ttc" id="memline_8c_html_ae92d6ba5b936547467fd45f1b6534778"><div class="ttname"><a href="memline_8c.html#ae92d6ba5b936547467fd45f1b6534778">ML_DELETE</a></div><div class="ttdeci">#define ML_DELETE</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00224">memline.c:224</a></div></div>
<div class="ttc" id="memline_8c_html_a1de07181f87bda4348b87eb71e0ab526"><div class="ttname"><a href="memline_8c.html#a1de07181f87bda4348b87eb71e0ab526">ML_FIND</a></div><div class="ttdeci">#define ML_FIND</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00226">memline.c:226</a></div></div>
<div class="ttc" id="memline_8c_html_a1c4075db28b41512824b19edc9e4e6c9"><div class="ttname"><a href="memline_8c.html#a1c4075db28b41512824b19edc9e4e6c9">adjust_text_props_for_delete</a></div><div class="ttdeci">static void adjust_text_props_for_delete(buf_T *buf, linenr_T lnum, char_u *del_props, int del_props_len, int above)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l03482">memline.c:3482</a></div></div>
<div class="ttc" id="vim_8h_html_a3206c537c639e0f26013f6cf909bd0e0"><div class="ttname"><a href="vim_8h.html#a3206c537c639e0f26013f6cf909bd0e0">stat_T</a></div><div class="ttdeci">struct stat stat_T</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l02088">vim.h:2088</a></div></div>
<div class="ttc" id="drawscreen_8c_html_a6cfdbac5c3017ed3f6f8c70035ea3e5d"><div class="ttname"><a href="drawscreen_8c.html#a6cfdbac5c3017ed3f6f8c70035ea3e5d">redraw_all_later</a></div><div class="ttdeci">void redraw_all_later(int type)</div><div class="ttdef"><b>Definition:</b> <a href="drawscreen_8c_source.html#l02955">drawscreen.c:2955</a></div></div>
<div class="ttc" id="structmemfile_html_acf87c004bb17883fecc56966daa0a7f3"><div class="ttname"><a href="structmemfile.html#acf87c004bb17883fecc56966daa0a7f3">memfile::mf_fname</a></div><div class="ttdeci">char_u * mf_fname</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00641">structs.h:641</a></div></div>
<div class="ttc" id="memline_8c_html_a0caed9f008450f4f072f64fa9023aa0a"><div class="ttname"><a href="memline_8c.html#a0caed9f008450f4f072f64fa9023aa0a">STACK_INCR</a></div><div class="ttdeci">#define STACK_INCR</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00211">memline.c:211</a></div></div>
<div class="ttc" id="term_8c_html_a696dc856975fd30035140f53329ba0ef"><div class="ttname"><a href="term_8c.html#a696dc856975fd30035140f53329ba0ef">out_flush</a></div><div class="ttdeci">void out_flush(void)</div><div class="ttdef"><b>Definition:</b> <a href="term_8c_source.html#l02466">term.c:2466</a></div></div>
<div class="ttc" id="dosinst_8h_html_aa8cecfc5c5c054d2875c03e77b7be15d"><div class="ttname"><a href="dosinst_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a></div><div class="ttdeci">#define TRUE</div><div class="ttdef"><b>Definition:</b> <a href="dosinst_8h_source.html#l00068">dosinst.h:68</a></div></div>
<div class="ttc" id="memline_8c_html_a72b0c5228c2ef9c96288ce4397f1b7a3"><div class="ttname"><a href="memline_8c.html#a72b0c5228c2ef9c96288ce4397f1b7a3">ml_set_mfp_crypt</a></div><div class="ttdeci">static void ml_set_mfp_crypt(buf_T *buf)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00424">memline.c:424</a></div></div>
<div class="ttc" id="change_8c_html_a4cc8db1b395d092bd0a984f7abd5f1d1"><div class="ttname"><a href="change_8c.html#a4cc8db1b395d092bd0a984f7abd5f1d1">may_invoke_listeners</a></div><div class="ttdeci">void may_invoke_listeners(buf_T *buf, linenr_T lnum, linenr_T lnume, int added)</div><div class="ttdef"><b>Definition:</b> <a href="change_8c_source.html#l00330">change.c:330</a></div></div>
<div class="ttc" id="struct_gui_html_a59ca384de082a710160aec5058e41001"><div class="ttname"><a href="struct_gui.html#a59ca384de082a710160aec5058e41001">Gui::starting</a></div><div class="ttdeci">int starting</div><div class="ttdef"><b>Definition:</b> <a href="gui_8h_source.html#l00260">gui.h:260</a></div></div>
<div class="ttc" id="structtextprop___s_html"><div class="ttname"><a href="structtextprop___s.html">textprop_S</a></div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00742">structs.h:742</a></div></div>
<div class="ttc" id="structblock__hdr_html"><div class="ttname"><a href="structblock__hdr.html">block_hdr</a></div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00491">structs.h:491</a></div></div>
<div class="ttc" id="structpointer__block_html_ad3682038298e7850fb980815132f17f9"><div class="ttname"><a href="structpointer__block.html#ad3682038298e7850fb980815132f17f9">pointer_block::pb_count</a></div><div class="ttdeci">short_u pb_count</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00093">memline.c:93</a></div></div>
<div class="ttc" id="vim_8h_html_ad31a3a5ea9363a1d0fd66864cfed4f8e"><div class="ttname"><a href="vim_8h.html#ad31a3a5ea9363a1d0fd66864cfed4f8e">MAXLNUM</a></div><div class="ttdeci">#define MAXLNUM</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l01697">vim.h:1697</a></div></div>
<div class="ttc" id="misc1_8c_html_ad2a2e6c114780c3071efd24f16c7f7d8"><div class="ttname"><a href="misc1_8c.html#ad2a2e6c114780c3071efd24f16c7f7d8">SEEK_END</a></div><div class="ttdeci">#define SEEK_END</div><div class="ttdef"><b>Definition:</b> <a href="misc1_8c_source.html#l02757">misc1.c:2757</a></div></div>
<div class="ttc" id="vim_8h_html_ada443375305fc60b73f44a59a2bf3f3b"><div class="ttname"><a href="vim_8h.html#ada443375305fc60b73f44a59a2bf3f3b">STRCAT</a></div><div class="ttdeci">#define STRCAT(d, s)</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l01626">vim.h:1626</a></div></div>
<div class="ttc" id="structblock0_html_af1c4459e8e835bc33daa0b6d4a4d57d1"><div class="ttname"><a href="structblock0.html#af1c4459e8e835bc33daa0b6d4a4d57d1">block0::b0_magic_int</a></div><div class="ttdeci">int b0_magic_int</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00173">memline.c:173</a></div></div>
<div class="ttc" id="memline_8c_html_a5e7aeced6dc3b0cf2af0f92ff3b3a875"><div class="ttname"><a href="memline_8c.html#a5e7aeced6dc3b0cf2af0f92ff3b3a875">ml_delete_int</a></div><div class="ttdeci">static int ml_delete_int(buf_T *, linenr_T, int)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l03599">memline.c:3599</a></div></div>
<div class="ttc" id="memline_8c_html_a4c3f0432d972be512c1ff55974987c8c"><div class="ttname"><a href="memline_8c.html#a4c3f0432d972be512c1ff55974987c8c">CHECK</a></div><div class="ttdeci">#define CHECK(c, s)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00012">memline.c:12</a></div></div>
<div class="ttc" id="vim_8h_html_aef214bee44b8ea3707359a56c8c921c6"><div class="ttname"><a href="vim_8h.html#aef214bee44b8ea3707359a56c8c921c6">MAXCOL</a></div><div class="ttdeci">#define MAXCOL</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l01696">vim.h:1696</a></div></div>
<div class="ttc" id="memline_8c_html_a677f4728e1de4885d0d4fb8cb5774849"><div class="ttname"><a href="memline_8c.html#a677f4728e1de4885d0d4fb8cb5774849">get_ctime</a></div><div class="ttdeci">char * get_ctime(time_t thetime, int add_newline)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l02133">memline.c:2133</a></div></div>
<div class="ttc" id="memline_8c_html_acf7020b3158145c4a34278f766dbb08e"><div class="ttname"><a href="memline_8c.html#acf7020b3158145c4a34278f766dbb08e">makeswapname</a></div><div class="ttdeci">char_u * makeswapname(char_u *fname, char_u *ffname UNUSED, buf_T *buf, char_u *dir_name)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l04413">memline.c:4413</a></div></div>
<div class="ttc" id="structmemfile_html_acf36a779315f1dea7b015e5a3c5e9785"><div class="ttname"><a href="structmemfile.html#acf36a779315f1dea7b015e5a3c5e9785">memfile::mf_ffname</a></div><div class="ttdeci">char_u * mf_ffname</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00642">structs.h:642</a></div></div>
<div class="ttc" id="structdata__block_html_a3937f5841b2fed9a042872981b06a7b8"><div class="ttname"><a href="structdata__block.html#a3937f5841b2fed9a042872981b06a7b8">data_block::db_txt_start</a></div><div class="ttdeci">unsigned db_txt_start</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00110">memline.c:110</a></div></div>
<div class="ttc" id="memfile_8c_html_ac165bbbf9ce06b4a7bb612d280de6c3a"><div class="ttname"><a href="memfile_8c.html#ac165bbbf9ce06b4a7bb612d280de6c3a">mf_fullname</a></div><div class="ttdeci">void mf_fullname(memfile_T *mfp)</div><div class="ttdef"><b>Definition:</b> <a href="memfile_8c_source.html#l01223">memfile.c:1223</a></div></div>
<div class="ttc" id="message_8c_html_a85d7463b25301d19e26b68b46f2a5ff9"><div class="ttname"><a href="message_8c.html#a85d7463b25301d19e26b68b46f2a5ff9">verb_msg</a></div><div class="ttdeci">int verb_msg(char *s)</div><div class="ttdef"><b>Definition:</b> <a href="message_8c_source.html#l00110">message.c:110</a></div></div>
<div class="ttc" id="structs_8h_html_ad2df9991ef69c281e2c46a0b9473dc06"><div class="ttname"><a href="structs_8h.html#ad2df9991ef69c281e2c46a0b9473dc06">TP_FLAG_CONT_PREV</a></div><div class="ttdeci">#define TP_FLAG_CONT_PREV</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00752">structs.h:752</a></div></div>
<div class="ttc" id="globals_8h_html_a376f82c59d5c5bf72c5bc753f7554128"><div class="ttname"><a href="globals_8h.html#a376f82c59d5c5bf72c5bc753f7554128">msg_row</a></div><div class="ttdeci">EXTERN int msg_row</div><div class="ttdef"><b>Definition:</b> <a href="globals_8h_source.html#l00191">globals.h:191</a></div></div>
<div class="ttc" id="os__amiga_8c_html_a3ba7ec8a49f3d6aaaa6e426d6fdeabc6"><div class="ttname"><a href="os__amiga_8c.html#a3ba7ec8a49f3d6aaaa6e426d6fdeabc6">mch_isFullName</a></div><div class="ttdeci">int mch_isFullName(char_u *fname)</div><div class="ttdef"><b>Definition:</b> <a href="os__amiga_8c_source.html#l00774">os_amiga.c:774</a></div></div>
<div class="ttc" id="vim_8h_html_aa9cea5fcb1483307770f365fb24aa08d"><div class="ttname"><a href="vim_8h.html#aa9cea5fcb1483307770f365fb24aa08d">STRCPY</a></div><div class="ttdeci">#define STRCPY(d, s)</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l01590">vim.h:1590</a></div></div>
<div class="ttc" id="vim_8h_html_af0d84616173bb5946784c0a50b4b01b3"><div class="ttname"><a href="vim_8h.html#af0d84616173bb5946784c0a50b4b01b3">OPT_LOCAL</a></div><div class="ttdeci">#define OPT_LOCAL</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l01216">vim.h:1216</a></div></div>
<div class="ttc" id="memline_8c_html_a463912a75dba711ec41090526dcd8fe6"><div class="ttname"><a href="memline_8c.html#a463912a75dba711ec41090526dcd8fe6">ml_setflags</a></div><div class="ttdeci">void ml_setflags(buf_T *buf)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l05258">memline.c:5258</a></div></div>
<div class="ttc" id="structmemline_html_ae775dd7dfa8b3dcaa01a9b3fa030371a"><div class="ttname"><a href="structmemline.html#ae775dd7dfa8b3dcaa01a9b3fa030371a">memline::ml_line_len</a></div><div class="ttdeci">colnr_T ml_line_len</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00723">structs.h:723</a></div></div>
<div class="ttc" id="os__amiga_8c_html_a7e689f4e37bb4db880dae0d37452f7de"><div class="ttname"><a href="os__amiga_8c.html#a7e689f4e37bb4db880dae0d37452f7de">mch_getperm</a></div><div class="ttdeci">long mch_getperm(char_u *name)</div><div class="ttdef"><b>Definition:</b> <a href="os__amiga_8c_source.html#l00803">os_amiga.c:803</a></div></div>
<div class="ttc" id="vim_8h_html_a8041520d32390bb51c3e955506efd206"><div class="ttname"><a href="vim_8h.html#a8041520d32390bb51c3e955506efd206">BF_NO_SEA</a></div><div class="ttdeci">#define BF_NO_SEA</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l00731">vim.h:731</a></div></div>
<div class="ttc" id="memline_8c_html_a67d0b82009004217400bc8708acf4c06"><div class="ttname"><a href="memline_8c.html#a67d0b82009004217400bc8708acf4c06">B0_UNAME_SIZE</a></div><div class="ttdeci">#define B0_UNAME_SIZE</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00136">memline.c:136</a></div></div>
<div class="ttc" id="structtextprop___s_html_a01dfe881b1438f9c53dcdd63e76f3fbd"><div class="ttname"><a href="structtextprop___s.html#a01dfe881b1438f9c53dcdd63e76f3fbd">textprop_S::tp_type</a></div><div class="ttdeci">int tp_type</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00747">structs.h:747</a></div></div>
<div class="ttc" id="macros_8h_html_a74420d7769a3c31521652566a1cdb094"><div class="ttname"><a href="macros_8h.html#a74420d7769a3c31521652566a1cdb094">VIM_CLEAR</a></div><div class="ttdeci">#define VIM_CLEAR(p)</div><div class="ttdef"><b>Definition:</b> <a href="macros_8h_source.html#l00332">macros.h:332</a></div></div>
<div class="ttc" id="memline_8c_html_aef48b3fc0252f461c7bce9fb717fc542"><div class="ttname"><a href="memline_8c.html#aef48b3fc0252f461c7bce9fb717fc542">B0_DIRTY</a></div><div class="ttdeci">#define B0_DIRTY</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00184">memline.c:184</a></div></div>
<div class="ttc" id="buffer_8c_html_ae729d3d218b6375165add7d4917b7a4f"><div class="ttname"><a href="buffer_8c.html#ae729d3d218b6375165add7d4917b7a4f">buf_spname</a></div><div class="ttdeci">char_u * buf_spname(buf_T *buf)</div><div class="ttdef"><b>Definition:</b> <a href="buffer_8c_source.html#l05409">buffer.c:5409</a></div></div>
<div class="ttc" id="structblock0_html_a3930b3adc922aba997caf28ad8d8e6a4"><div class="ttname"><a href="structblock0.html#a3930b3adc922aba997caf28ad8d8e6a4">block0::b0_ino</a></div><div class="ttdeci">char_u b0_ino[4]</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00167">memline.c:167</a></div></div>
<div class="ttc" id="drawscreen_8c_html_a8430c433761f5a1693d346d2abf1e6bb"><div class="ttname"><a href="drawscreen_8c.html#a8430c433761f5a1693d346d2abf1e6bb">redraw_curbuf_later</a></div><div class="ttdeci">void redraw_curbuf_later(int type)</div><div class="ttdef"><b>Definition:</b> <a href="drawscreen_8c_source.html#l02970">drawscreen.c:2970</a></div></div>
<div class="ttc" id="vim_8h_html_a22743f1c6b7f2b83c4a99f8ac1a5d454"><div class="ttname"><a href="vim_8h.html#a22743f1c6b7f2b83c4a99f8ac1a5d454">ALLOC_MULT</a></div><div class="ttdeci">#define ALLOC_MULT(type, count)</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l01578">vim.h:1578</a></div></div>
<div class="ttc" id="memline_8c_html_acc7926ea1ef47502c4c44de231e2dbfc"><div class="ttname"><a href="memline_8c.html#acc7926ea1ef47502c4c44de231e2dbfc">ml_delete</a></div><div class="ttdeci">int ml_delete(linenr_T lnum, int message)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l03583">memline.c:3583</a></div></div>
<div class="ttc" id="message_8c_html_a35f801e23d16b0e6a4d1cc61691ec03f"><div class="ttname"><a href="message_8c.html#a35f801e23d16b0e6a4d1cc61691ec03f">siemsg</a></div><div class="ttdeci">void siemsg(const char *s,...)</div><div class="ttdef"><b>Definition:</b> <a href="message_8c_source.html#l00763">message.c:763</a></div></div>
<div class="ttc" id="memline_8c_html_aa6909d6a13a3189fdb549bea27afc662"><div class="ttname"><a href="memline_8c.html#aa6909d6a13a3189fdb549bea27afc662">ml_add_stack</a></div><div class="ttdeci">static int ml_add_stack(buf_T *)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l04266">memline.c:4266</a></div></div>
<div class="ttc" id="vim_8h_html_a161e00310e38bdf5ad08c3f7b0130069"><div class="ttname"><a href="vim_8h.html#a161e00310e38bdf5ad08c3f7b0130069">vim_realloc</a></div><div class="ttdeci">#define vim_realloc(ptr, size)</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l02226">vim.h:2226</a></div></div>
<div class="ttc" id="vim_8h_html_a8933f1a0d85c4c550c808c2333e74085"><div class="ttname"><a href="vim_8h.html#a8933f1a0d85c4c550c808c2333e74085">vim_lseek</a></div><div class="ttdeci">#define vim_lseek</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l00403">vim.h:403</a></div></div>
<div class="ttc" id="memline_8c_html_a3d99e7af7190b24b26e4eaa5f6096b94"><div class="ttname"><a href="memline_8c.html#a3d99e7af7190b24b26e4eaa5f6096b94">ml_set_crypt_key</a></div><div class="ttdeci">void ml_set_crypt_key(buf_T *buf, char_u *old_key, char_u *old_cm)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00469">memline.c:469</a></div></div>
<div class="ttc" id="filepath_8c_html_ab7f12f206c15cee62718c8ca7fa40695"><div class="ttname"><a href="filepath_8c.html#ab7f12f206c15cee62718c8ca7fa40695">home_replace</a></div><div class="ttdeci">void home_replace(buf_T *buf, char_u *src, char_u *dst, int dstlen, int one)</div><div class="ttdef"><b>Definition:</b> <a href="filepath_8c_source.html#l02162">filepath.c:2162</a></div></div>
<div class="ttc" id="memfile_8c_html_aabb7739af88ce85526b63f333e10bed6"><div class="ttname"><a href="memfile_8c.html#aabb7739af88ce85526b63f333e10bed6">mf_set_dirty</a></div><div class="ttdeci">void mf_set_dirty(memfile_T *mfp)</div><div class="ttdef"><b>Definition:</b> <a href="memfile_8c_source.html#l00684">memfile.c:684</a></div></div>
<div class="ttc" id="memline_8c_html_aad2a8c25b4deee1b1fec00478af75568"><div class="ttname"><a href="memline_8c.html#aad2a8c25b4deee1b1fec00478af75568">swapfile_info</a></div><div class="ttdeci">static time_t swapfile_info(char_u *)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l02176">memline.c:2176</a></div></div>
<div class="ttc" id="macros_8h_html_a91d2733ae4d7b126d9d545ff5315b50e"><div class="ttname"><a href="macros_8h.html#a91d2733ae4d7b126d9d545ff5315b50e">ASCII_ISALPHA</a></div><div class="ttdeci">#define ASCII_ISALPHA(c)</div><div class="ttdef"><b>Definition:</b> <a href="macros_8h_source.html#l00110">macros.h:110</a></div></div>
<div class="ttc" id="structs_8h_html_a1728259701820b8a8745485b2537217d"><div class="ttname"><a href="structs_8h.html#a1728259701820b8a8745485b2537217d">TP_FLAG_CONT_NEXT</a></div><div class="ttdeci">#define TP_FLAG_CONT_NEXT</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00751">structs.h:751</a></div></div>
<div class="ttc" id="memline_8c_html_ab87e6b87865bb131c623e02c394ab683"><div class="ttname"><a href="memline_8c.html#ab87e6b87865bb131c623e02c394ab683">MLCS_MINL</a></div><div class="ttdeci">#define MLCS_MINL</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l05415">memline.c:5415</a></div></div>
<div class="ttc" id="globals_8h_html_ab2dfc04411a40f8bcaf0f45b0d16f482"><div class="ttname"><a href="globals_8h.html#ab2dfc04411a40f8bcaf0f45b0d16f482">FOR_ALL_BUFFERS</a></div><div class="ttdeci">#define FOR_ALL_BUFFERS(buf)</div><div class="ttdef"><b>Definition:</b> <a href="globals_8h_source.html#l00677">globals.h:677</a></div></div>
<div class="ttc" id="memline_8c_html_a9f6bf1b47e0e5c17ed49833bfffe8527"><div class="ttname"><a href="memline_8c.html#a9f6bf1b47e0e5c17ed49833bfffe8527">ml_timestamp</a></div><div class="ttdeci">void ml_timestamp(buf_T *buf)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00899">memline.c:899</a></div></div>
<div class="ttc" id="structcmdmod_html"><div class="ttname"><a href="structcmdmod.html">cmdmod</a></div><div class="ttdef"><b>Definition:</b> <a href="ex__docmd_8c_source.html#l03215">ex_docmd.c:3215</a></div></div>
<div class="ttc" id="evalvars_8c_html_a5c7a8c84b65dc8166f8bb9c1db583d54"><div class="ttname"><a href="evalvars_8c.html#a5c7a8c84b65dc8166f8bb9c1db583d54">get_vim_var_str</a></div><div class="ttdeci">char_u * get_vim_var_str(int idx)</div><div class="ttdef"><b>Definition:</b> <a href="evalvars_8c_source.html#l01954">evalvars.c:1954</a></div></div>
<div class="ttc" id="memline_8c_html_abe58d9866bc8d9d29c219f731bb85ceb"><div class="ttname"><a href="memline_8c.html#abe58d9866bc8d9d29c219f731bb85ceb">ml_close</a></div><div class="ttdeci">void ml_close(buf_T *buf, int del_file)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00840">memline.c:840</a></div></div>
<div class="ttc" id="buffer_8c_html_a078f5780434ad5529f1ff13d4b14dc20"><div class="ttname"><a href="buffer_8c.html#a078f5780434ad5529f1ff13d4b14dc20">fix_fname</a></div><div class="ttdeci">char_u * fix_fname(char_u *fname)</div><div class="ttdef"><b>Definition:</b> <a href="buffer_8c_source.html#l04832">buffer.c:4832</a></div></div>
<div class="ttc" id="memline_8c_html_aeb2a08db86a3f3c959cc50de278339eda3e3c35facf7ed67537393dd40196c797"><div class="ttname"><a href="memline_8c.html#aeb2a08db86a3f3c959cc50de278339eda3e3c35facf7ed67537393dd40196c797">UB_SAME_DIR</a></div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00233">memline.c:233</a></div></div>
<div class="ttc" id="buffer_8c_html_a1fcbd564641925e50627240e85a1d80a"><div class="ttname"><a href="buffer_8c.html#a1fcbd564641925e50627240e85a1d80a">open_buffer</a></div><div class="ttdeci">int open_buffer(int read_stdin, exarg_T *eap, int flags)</div><div class="ttdef"><b>Definition:</b> <a href="buffer_8c_source.html#l00160">buffer.c:160</a></div></div>
<div class="ttc" id="message_8c_html_a6a5cfaa40c91127e2434c14cddb955b6"><div class="ttname"><a href="message_8c.html#a6a5cfaa40c91127e2434c14cddb955b6">msg</a></div><div class="ttdeci">int msg(char *s)</div><div class="ttdef"><b>Definition:</b> <a href="message_8c_source.html#l00101">message.c:101</a></div></div>
<div class="ttc" id="structfile__buffer_html_a7ffb8516d12b390e45fc3af4d670d020"><div class="ttname"><a href="structfile__buffer.html#a7ffb8516d12b390e45fc3af4d670d020">file_buffer::b_p_ro</a></div><div class="ttdeci">int b_p_ro</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l02494">structs.h:2494</a></div></div>
<div class="ttc" id="structblock0_html_ab702799b723f108b57a8b73f83e70346"><div class="ttname"><a href="structblock0.html#ab702799b723f108b57a8b73f83e70346">block0::b0_pid</a></div><div class="ttdeci">char_u b0_pid[4]</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00168">memline.c:168</a></div></div>
<div class="ttc" id="mbyte_8c_html_a074ed548c30666da6fc4868af00d2241"><div class="ttname"><a href="mbyte_8c.html#a074ed548c30666da6fc4868af00d2241">mb_adjust_cursor</a></div><div class="ttdeci">void mb_adjust_cursor(void)</div><div class="ttdef"><b>Definition:</b> <a href="mbyte_8c_source.html#l04104">mbyte.c:4104</a></div></div>
<div class="ttc" id="structfile__buffer_html_abc07833d399f70595fd5e62404b876ad"><div class="ttname"><a href="structfile__buffer.html#abc07833d399f70595fd5e62404b876ad">file_buffer::b_shortname</a></div><div class="ttdeci">int b_shortname</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l02648">structs.h:2648</a></div></div>
<div class="ttc" id="structs_8h_html_a7cf2da642c785ee805f57988d6dd4267"><div class="ttname"><a href="structs_8h.html#a7cf2da642c785ee805f57988d6dd4267">MF_SEED_LEN</a></div><div class="ttdeci">#define MF_SEED_LEN</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00637">structs.h:637</a></div></div>
<div class="ttc" id="option_8h_html_abb5561ad122dac5df6b719a1243b3445"><div class="ttname"><a href="option_8h.html#abb5561ad122dac5df6b719a1243b3445">p_verbose</a></div><div class="ttdeci">EXTERN long p_verbose</div><div class="ttdef"><b>Definition:</b> <a href="option_8h_source.html#l01022">option.h:1022</a></div></div>
<div class="ttc" id="memline_8c_html_a49999be01380f41cc0d0f1f1406fb277"><div class="ttname"><a href="memline_8c.html#a49999be01380f41cc0d0f1f1406fb277">HEADER_SIZE</a></div><div class="ttdeci">#define HEADER_SIZE</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00131">memline.c:131</a></div></div>
<div class="ttc" id="os__win32_8c_html_a86a6c2e2a013622ad468bcdbc07bbfd6"><div class="ttname"><a href="os__win32_8c.html#a86a6c2e2a013622ad468bcdbc07bbfd6">mch_open</a></div><div class="ttdeci">int mch_open(const char *name, int flags, int mode)</div><div class="ttdef"><b>Definition:</b> <a href="os__win32_8c_source.html#l06715">os_win32.c:6715</a></div></div>
<div class="ttc" id="memline_8c_html_af8faa362a3c30969254dac9539895774"><div class="ttname"><a href="memline_8c.html#af8faa362a3c30969254dac9539895774">set_b0_fname</a></div><div class="ttdeci">static void set_b0_fname(ZERO_BL *, buf_T *buf)</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00967">memline.c:967</a></div></div>
<div class="ttc" id="crypt_8c_html_ab273525722dbaa361c3808437676c1cb"><div class="ttname"><a href="crypt_8c.html#ab273525722dbaa361c3808437676c1cb">crypt_encode</a></div><div class="ttdeci">void crypt_encode(cryptstate_T *state, char_u *from, size_t len, char_u *to)</div><div class="ttdef"><b>Definition:</b> <a href="crypt_8c_source.html#l00451">crypt.c:451</a></div></div>
<div class="ttc" id="structfile__buffer_html_a34a7c5a6d702c7ce0181584242976f3e"><div class="ttname"><a href="structfile__buffer.html#a34a7c5a6d702c7ce0181584242976f3e">file_buffer::b_fname</a></div><div class="ttdeci">char_u * b_fname</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l02254">structs.h:2254</a></div></div>
<div class="ttc" id="gui_8c_html_a6a991660e919b41ce2f02f6792ce75dc"><div class="ttname"><a href="gui_8c.html#a6a991660e919b41ce2f02f6792ce75dc">gui</a></div><div class="ttdeci">gui_T gui</div><div class="ttdef"><b>Definition:</b> <a href="gui_8c_source.html#l00014">gui.c:14</a></div></div>
<div class="ttc" id="structwindow___s_html_a397eb20adbcf2f8a50e1038886c1930c"><div class="ttname"><a href="structwindow___s.html#a397eb20adbcf2f8a50e1038886c1930c">window_S::w_cursor</a></div><div class="ttdeci">pos_T w_cursor</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l02963">structs.h:2963</a></div></div>
<div class="ttc" id="vim_8h_html_a74e72b20fdc634f1981f0e0b503368e9"><div class="ttname"><a href="vim_8h.html#a74e72b20fdc634f1981f0e0b503368e9">fnamecmp</a></div><div class="ttdeci">#define fnamecmp(x, y)</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l01715">vim.h:1715</a></div></div>
<div class="ttc" id="structpointer__entry_html_aa5194eaf0768453f33b9d2ff66508040"><div class="ttname"><a href="structpointer__entry.html#aa5194eaf0768453f33b9d2ff66508040">pointer_entry::pe_page_count</a></div><div class="ttdeci">int pe_page_count</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00084">memline.c:84</a></div></div>
<div class="ttc" id="structpointer__entry_html_a4ed8c85821e6c5ac44c2a77160d4b26d"><div class="ttname"><a href="structpointer__entry.html#a4ed8c85821e6c5ac44c2a77160d4b26d">pointer_entry::pe_old_lnum</a></div><div class="ttdeci">linenr_T pe_old_lnum</div><div class="ttdef"><b>Definition:</b> <a href="memline_8c_source.html#l00083">memline.c:83</a></div></div>
<div class="ttc" id="message_8c_html_a1adc86bbd012d6e33d3fddf074a31491"><div class="ttname"><a href="message_8c.html#a1adc86bbd012d6e33d3fddf074a31491">set_keep_msg</a></div><div class="ttdeci">void set_keep_msg(char_u *s, int attr)</div><div class="ttdef"><b>Definition:</b> <a href="message_8c_source.html#l01274">message.c:1274</a></div></div>
<div class="ttc" id="structblock__hdr_html_a6b3dc819ce42874b30868feb20432954"><div class="ttname"><a href="structblock__hdr.html#a6b3dc819ce42874b30868feb20432954">block_hdr::bh_flags</a></div><div class="ttdeci">char bh_flags</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00503">structs.h:503</a></div></div>
<div class="ttc" id="structmemline_html_a9adb5a08b3c01be69c98360a14937227"><div class="ttname"><a href="structmemline.html#a9adb5a08b3c01be69c98360a14937227">memline::ml_mfp</a></div><div class="ttdeci">memfile_T * ml_mfp</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l00709">structs.h:709</a></div></div>
<div class="ttc" id="vim_8h_html_a4038c1cfed080291f89dccd5e10129bf"><div class="ttname"><a href="vim_8h.html#a4038c1cfed080291f89dccd5e10129bf">MFS_FLUSH</a></div><div class="ttdeci">#define MFS_FLUSH</div><div class="ttdef"><b>Definition:</b> <a href="vim_8h_source.html#l01060">vim.h:1060</a></div></div>
<div class="ttc" id="structfile__buffer_html_a0be7352b0a40127537e76ea4a8449c13"><div class="ttname"><a href="structfile__buffer.html#a0be7352b0a40127537e76ea4a8449c13">file_buffer::b_help</a></div><div class="ttdeci">int b_help</div><div class="ttdef"><b>Definition:</b> <a href="structs_8h_source.html#l02640">structs.h:2640</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
